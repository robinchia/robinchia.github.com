
<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>WordPress  | It so life</title>
<meta name="author" content="RobinChia">

<meta name="description" content="WordPress &lt; 3.6.1 PHP å¯¹è±¡æ³¨å…¥æ¼æ´2013/09/13 11:36  | äº”é“å£æ€æ°”  

From:WordPress &lt; 3.6.1 PHP Object Injection">


<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<meta property="og:title" content="WordPress "/>
<meta property="og:site_name" content="It so life"/>

<!--[if IE]><style>.testIE.IE{display:inline;}</style><![endif]-->
<!--[if lte IE 7]><link rel="stylesheet" href="/css/ie7.css" type="text/css"><![endif]-->
<!--[if (lt IE 9)&(gt IE 7)]><style>.testIE.IE8{display:inline;}</style><![endif]-->
<!--[if gt IE 8]><style>.testIE.IE9{display:inline;}</style><![endif]-->

<link href="/favicon.png" rel="icon">
<link rel="alternate" href="/atom.xml" title="It so life Feed" type="application/atom+xml">

<link rel="stylesheet" href="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/font-awesome/4.0.3/css/font-awesome.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/prettify/r298/prettify.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" type="text/css">
<link rel="stylesheet" href="/css/style.css" type="text/css">
<!--[if lt IE 9]>
   <style>article,aside,dialog,footer,header,section,footer,nav,figure,menu{display:block}</style>
   <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
   <script src="http://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
<link href="http://cdn.staticfile.org/respond.js/1.4.2/respond-proxy.html" id="respond-proxy" rel="respond-proxy" />
<link href="/js/respond.proxy.gif" id="respond-redirect" rel="respond-redirect" />
<script src="/js/respond.proxy.js"></script>
   <script src="http://cdn.bootcss.com/selectivizr/1.0.2/selectivizr-min.js"></script>
<![endif]-->
<script type="text/javascript">
function loadjs(c,d){var a=document.createElement("script");a.async=!0;a.type="text/javascript";a.src=c;a.charset=d||"gbk";(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(a)};
var _protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
var _js2load = [];
</script>

</head>
<body>
      <header id="header" class="container"><nav id="main-nav" class="navbar navbar-default navbar-fixed-top " role="navigation">
  <div class="container">
    <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/">It so life</a>
    </div>
    <div  class="collapse navbar-collapse">
      <ul  class="nav navbar-nav">
  
        <li><a href="/" title="Home">Home</a></li>      
        <li><a href="/about/" title="About">About</a></li>      
        <li><a href="/archives/" title="Archives">Archives</a></li>      
      <li class='dropdown'>
        <a class='dropdown-toggle' data-toggle='dropdown' href='#'>website<b class='caret'></b></a>
        <ul class='dropdown-menu pure-menu-selected'>
    
          <li><a href="//groups.google.com/forum/#!forum/pongba" title="TopLanguage">TopLanguage</a></li>    
          <li><a href="//itpub.net/" title="ITPub">ITPub</a></li>    
          <li><a href="//blog.jobbole.com/" title="Bole">Bole</a></li>    
          <li><a href="//nosql-database.org/" title="nosql">nosql</a></li>    
          <li><a href="//gitimmersion.googol.im/" title="Git">Git</a></li>    
        </ul>
      </li>
    
      </ul>
      <ul class="nav navbar-nav navbar-right">
      
        <li><a href="/atom.xml">RSS</a></li>
      
      
        <li><a href="https://twitter.com/robinchia">twitter</a></li>
      
      
      
      
        <li><a href="https://github.com/robinchia">github</a></li>
      
      </ul>
    </div>
  </div>
</nav>
<div class="clearfix"></div>
</header>
  <div id='content' class="container">
     <div class="page-header-wrapper">
      <!--[if lt IE 9]><div class="alert alert-warning alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>æç¤º:</strong>æ‚¨çš„æµè§ˆå™¨ç‰ˆæœ¬å¤ªä½äº†,å»ºè®®å‡çº§åˆ° <strong><a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" title="IE9">IE9</a></strong> ä»¥ä¸Š,æœ¬ç«™ä½¿ç”¨<a href="https://www.google.com/intl/zh-CN/chrome/">Chromeæµè§ˆå™¨</a>å¯ä»¥è·å¾—æœ€å¥½çš„æ˜¾ç¤ºæ•ˆæœ.</div><![endif]-->
      <div class="page-header"><h1 align="center"><big>It so life</big> </h1>
        <h5 align="center"><big>love as life</big></h5>
      </div>
     </div>
     <div class="row">
       <div id="main-col" class="alignleft col-sx-12 col-sm-8 col-md-9 col-lg-9">
      <section id='header_widget'></section>
          <div id="wrapper"><article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title">WordPress </h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:38.000Z"> <a href="/2014/02/02/2014-02-02-å®‰å…¨-PHP-WordPress--WordPress-361PHPå¯¹è±¡æ³¨å…¥æ¼æ´-WooYunçŸ¥è¯†åº“/">feb. 2 2014</a></time></span>      
    </header>
    
    <section id='before_content_widget'></section>
    <div class="entry">
      
        <h2 id="-wordpress-3-6-1-php-http-drops-wooyun-org-papers-596-"><a href="http://drops.wooyun.org/papers/596" target="_blank">WordPress &lt; 3.6.1 PHP å¯¹è±¡æ³¨å…¥æ¼æ´</a></h2>
<p>2013/09/13 11:36  | <a href="http://drops.wooyun.org/author/äº”é“å£æ€æ°”" title="ç”± äº”é“å£æ€æ°” å‘å¸ƒ" target="_blank">äº”é“å£æ€æ°”</a>  </p>
<p>From:<a href="http://vagosec.org/2013/09/wordpress-php-object-injection/" target="_blank">WordPress &lt; 3.6.1 PHP Object Injection</a></p>
<h2 id="0x00-">0x00 èƒŒæ™¯</h2>
<p>å½“æˆ‘è¯»åˆ°ä¸€ç¯‡å…³äºJoomlaçš„â€œPHPå¯¹è±¡æ³¨å°„â€çš„æ¼æ´blogåï¼Œæˆ‘æŒ–æ·±äº†ä¸€ç‚¹å°±å‘ç°Stefan Esserå¤§ç¥åœ¨2010å¹´é»‘å¸½å¤§ä¼šçš„æ–‡ç« ï¼š</p>
<p><a href="http://media.blackhat.com/bh-us-10/presentations/Esser/BlackHat-USA-2010-Esser-Utilizing-Code-Reuse-Or-Return-Oriented-Programming-In-PHP-Application-Exploits-slides.pdf" target="_blank"><a href="http://media.blackhat.com/bh-us-10/presentations/Esser/BlackHat-USA-2010-Esser-Utilizing-Code-Reuse-Or-Return-Oriented-Programming-In-PHP-Application-Exploits-slides.pdf">http://media.blackhat.com/bh-us-10/presentations/Esser/BlackHat-USA-2010-Esser-Utilizing-Code-Reuse-Or-Return-Oriented-Programming-In-PHP-Application-Exploits-slides.pdf</a></a></p>
<p>è¿™ç¯‡æ–‡ç« æåˆ°äº†PHPä¸­çš„unserializeå‡½æ•°å½“æ“ä½œç”¨æˆ·ç”Ÿæˆçš„æ•°æ®çš„æ—¶å€™ä¼šäº§ç”Ÿå®‰å…¨æ¼æ´ã€‚</p>
<p>æ‰€ä»¥å‘¢ï¼ŒåŸºæœ¬æ¥è¯´ï¼Œunserializeå‡½æ•°æ‹¿åˆ°è¡¨ç°ä¸ºåºåˆ—åŒ–çš„æ•°æ®ï¼Œç„¶åå°±è§£åºåˆ—åŒ–å®ƒï¼ˆunserializeå˜›ï¼Œå½“ç„¶å°±å¹²è¿™ä¸ªå•Š~ï¼‰ä¸ºphpçš„å€¼ã€‚è¿™ä¸ªå€¼å®ƒå¯ä»¥æ˜¯resourceä¹‹å¤–çš„ä»»ä½•ç±»å‹ï¼Œå¯ä¸ºï¼ˆinteger, double, string, array, boolean, object, NULLï¼‰ï¼Œå½“è¿™ä¸ªå‡½æ•°æ“ä½œä¸€ä¸ªç”¨æˆ·ç”Ÿæˆçš„å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œåœ¨ä½ç‰ˆæœ¬çš„PHPä¸­å¯èƒ½ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²çš„æ¼æ´ï¼Œå½“ç„¶è¿™ä¹Ÿä¸æ˜¯è¿™ç¯‡blogè¦å…³æ³¨çš„é—®é¢˜ã€‚å¦‚æœä½ å¯¹è¿™ä¸ªé—®é¢˜æ„Ÿå…´è¶£ï¼Œä½ å¯ä»¥å†å»çœ‹çœ‹æˆ‘ä¸Šé¢è¯´çš„å¤§ç¥çš„æ–‡ç« ã€‚</p>
<p>å¦å¤–ä¸€ç§æ”»å‡»æ–¹å¼å‘ç”Ÿåœ¨å½“æ”»å‡»è€…çš„è¾“å…¥è¢«unserializeå‡½æ•°æ“ä½œçš„æ—¶å€™ï¼Œè¿™ç§å°±æ˜¯æˆ‘è¯´åˆ°çš„â€œPHPå¯¹è±¡æ³¨å…¥â€ã€‚åœ¨è¿™ç§æ–¹å¼ä¸­ï¼Œå¯¹è±¡ç±»å‹çš„è¢«unserializeçš„è¯ï¼Œå…è®¸æ”»å‡»è€…è®¾ç½®ä»–é€‰æ‹©å¯¹è±¡çš„å±æ€§ã€‚å½“è¿™äº›å¯¹è±¡ä¸­çš„æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šå‡ºç°ä¸€äº›æ•ˆæœï¼ˆä¾‹å¦‚ï¼šåˆ é™¤ä¸€äº›æ–‡ä»¶ï¼‰ï¼Œå½“æ”»å‡»è€…å¯ä»¥å»é€‰æ‹©å¯¹è±¡é‡Œçš„ä¸€äº›å±æ€§çš„æ—¶å€™ï¼Œä»–å°±èƒ½å¤Ÿåˆ é™¤ä¸€ä¸ªä»–æ‰€æäº¤çš„æ–‡ä»¶ã€‚</p>
<p>è®©æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­å§ï¼Œæƒ³è±¡ä»¥ä¸‹çš„ä»£ç ä¸­çš„classæ˜¯ç”¨æˆ·è‡ªå·±ç”Ÿæˆçš„å†…å®¹è¢«unserializeæ—¶è½½å…¥çš„ï¼š</p>
<p>ï¼ˆps:è€å¤–è´´å‡ºçš„ä»£ç è¯­æ³•æœ‰é—®é¢˜ï¼Œæ”¹äº†ä¸€ä¸‹æµ‹è¯•æˆåŠŸâ€¦â€¦ï¼‰
&lt;?php</p>
<p>class</p>
<p>Foo {</p>
<p>private</p>
<p>$bar</p>
<p>;</p>
<p>public</p>
<p>$file</p>
<p>;</p>
<p>public</p>
<p>function</p>
<p>__construct(</p>
<p>$fileName</p>
<p>) {</p>
<p>$this</p>
<p>-&gt;bar =</p>
<p>&#39;foobar&#39;</p>
<p>;</p>
<p>$this</p>
<p>-&gt;file =</p>
<p>$fileName</p>
<p>;</p>
<p>}</p>
<p>// ä¸€äº›å…¶ä»–çš„ä»£ç â€¦â€¦</p>
<p>public</p>
<p>function</p>
<p>__toString() {</p>
<p>return</p>
<p>file_get_contents</p>
<p>(</p>
<p>$this</p>
<p>-&gt;file);</p>
<p>}</p>
<p>}
?&gt;</p>
<p>å¦‚æœå—å®³çš„ç¼ºé™·ä»£ç åŒæ—¶è¿˜å­˜åœ¨ä»¥ä¸‹çš„ä»£ç ï¼š</p>
<p>1echo</p>
<p>unserialize(</p>
<p>$_GET</p>
<p>[</p>
<p>&#39;in&#39;</p>
<p>]);</p>
<p>è¿™æ”»å‡»è€…å°±å¯ä»¥è¯»å–ä»»æ„æ–‡ä»¶ï¼Œæ”»å‡»è€…å¯ä»¥å¦‚ä¸‹å»æ„é€ å®ƒçš„å¯¹è±¡ã€‚</p>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
&lt;?php</p>
<p>class</p>
<p>Foo {</p>
<p>public</p>
<p>$file</p>
<p>;</p>
<p>}
$foo</p>
<p>=</p>
<p>new</p>
<p>Foo();</p>
<p>$foo</p>
<p>-&gt;file =</p>
<p>&#39;/etc/passwd&#39;</p>
<p>;
echo</p>
<p>serialize(</p>
<p>$foo</p>
<p>);</p>
<p>?&gt;</p>
<p>ä¸Šé¢è¿™æ®µä»£ç çš„ç»“æœæ˜¯ï¼šO:3:&quot;Foo&quot;:1:{s:4:&quot;file&quot;;s:11:&quot;/etc/passwd&quot;;} ï¼Œæ”»å‡»è€…ç°åœ¨è¦åšçš„äº‹æƒ…å°±äº‹é€šè¿‡æäº¤getè¯·æ±‚åˆ°å­˜åœ¨æ¼æ´çš„é¡µé¢è§¦å‘ä»–çš„æ”»å‡»ä»£ç ã€‚è¿™ä¸ªé¡µé¢ä¼šåå‡º/etc/passwdçš„å†…å®¹æ¥ã€‚èƒ½è¯»åˆ°è¿™äº›æ–‡ä»¶çš„å†…å®¹æ€ä¹ˆçœ‹éƒ½ä¸æ˜¯ä¸€ä¸ªå¥½äº‹æƒ…ï¼Œä½ å°±æƒ³è±¡ä¸€ä¸‹ï¼Œä¸‡ä¸€ç¼ºé™·ä»£ç ä¸­çš„å‡½æ•°ä¸æ˜¯file_get_contentsè€Œæ˜¯evalå‘¢ï¼Ÿ</p>
<p>æˆ‘ç›¸ä¿¡ä¸Šé¢è¿™éƒ¨åˆ†å·²ç»èƒ½è®©äººæ˜ç™½å…è®¸ç”¨æˆ·è¾“å…¥è¿›å…¥unserializeè¿™ä¸ªå‡½æ•°å±å®³æœ‰å¤šå¤§äº†ã€‚å°±è¿PHPæ‰‹å†Œé‡Œä¹Ÿè¯´äº†ä¸è¦æŠŠç”¨æˆ·ç”Ÿæˆçš„å†…å®¹äº¤ç»™unserializeå‡½æ•°ã€‚</p>
<h3 id="-">è­¦å‘Šï¼š</h3>
<p>ä¸è¦æŠŠä¸å¯ä¿¡çš„ç”¨æˆ·è¾“å…¥äº¤ç»™unserializeï¼Œä½¿ç”¨è¯¥å‡½æ•°è§£åºåˆ—åŒ–å†…å®¹èƒ½å¯¼è‡´è®¿é—®ä¸”è‡ªåŠ¨è½½å…¥å¯¹è±¡ï¼Œæ¶æ„ç”¨æˆ·å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œä»å®‰å…¨çš„è§’åº¦ï¼Œå¦‚æœä½ æƒ³è®©ç”¨æˆ·å¯ä»¥æ ‡å‡†çš„ä¼ é€’æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨json ï¼ˆjson_encode json_decodeï¼‰ã€‚</p>
<p>å¥½ï¼Œè®©æˆ‘ä»¬ç»§ç»­è¯´è¿™äº›é—®é¢˜æ€ä¹ˆå½±å“åˆ°Wordpressã€‚</p>
<h2 id="0x01-wordpress-">0x01 wordpressçš„å®‰å…¨é—®é¢˜</h2>
<p>Stefan Esser&#39;sçš„é»‘å¸½æ¼”è®²ä¸­ï¼Œä»–æåˆ°Wordpressæ˜¯ä¸€æ¬¾ä½¿ç”¨äº†serializeå’Œunserializeå‡½æ•°çš„çŸ¥ååº”ç”¨ã€‚åœ¨ä»–çš„å¹»ç¯ç‰‡ä¸­ï¼Œunserializeç”¨æ¥æ¥æ”¶æ¥è‡ªWordpressç«™ç‚¹ä¸Šçš„æ•°æ®ã€‚æ‰€ä»¥æ”»å‡»è€…å¯ä»¥åœ¨å—å®³ç«™ç‚¹ä¸Šå‘èµ·ä¸€æ¬¡ä¸­é—´äººæ”»å‡»ã€‚ä»–å¯ä»¥ä¿®æ”¹æ¥è‡ªWordpressç«™ç‚¹çš„è¿”å›æ•°æ®ï¼ŒæŠŠä»–çš„ä»£ç åŠ è¿›å»ã€‚æœ‰è¶£çš„æ˜¯å°±åœ¨æˆ‘ç¼–å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼ŒWordpressæœ€æ–°çš„ç‰ˆæœ¬ä¹ŸåŒ…å«è¿™ä¸ªé—®é¢˜ï¼ˆè·ç¦»é‚£æ¼”è®²ä¼¼ä¹è¿‡å»ä¸‰å¹´äº†ï¼‰ï¼Œæƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæœ‰é»‘å®¢å¯ä»¥åŠ«æŒWordPress.orgçš„DNSä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…å§ã€‚</p>
<p>ç„¶è€Œï¼Œè¿™ä¹Ÿä¸æ˜¯Wordpressä½¿ç”¨è¿™ä¸ªunserializeçš„å”¯ä¸€åœ°æ–¹ï¼Œå®ƒè¿˜ç”¨äºç”¨äºåœ¨æ•°æ®åº“ä¸­æ•°æ®ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œç”¨æˆ·çš„metadataå°±è¢«åºåˆ—åŒ–åå­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œmetadataçš„å–å›æ–¹å¼åœ¨wp-includes/meta.phpçš„272è¡Œçš„get_metadata()ï¼Œæˆ‘åœ¨è¿™é‡Œå¼•ç”¨ä¸€ä¸‹è¯¥å‡½æ•°çš„éƒ¨åˆ†ä»£ç ï¼ˆ292-297è¡Œï¼‰</p>
<p>if</p>
<p>( isset(</p>
<p>$meta_cache</p>
<p>[</p>
<p>$meta_key</p>
<p>]) ) {</p>
<p>if</p>
<p>(</p>
<p>$single</p>
<p>)</p>
<p>return</p>
<p>maybe_unserialize(</p>
<p>$meta_cache</p>
<p>[</p>
<p>$meta_key</p>
<p>][0] );</p>
<p>else</p>
<p>return</p>
<p>array_map</p>
<p>(</p>
<p>&#39;maybe_unserialize&#39;</p>
<p>,</p>
<p>$meta_cache</p>
<p>[</p>
<p>$meta_key</p>
<p>]);</p>
<p>}</p>
<p>åŸºæœ¬ä¸Šï¼Œè¿™ä¸ªå‡½æ•°æ‰€å¹²çš„äº‹æƒ…å°±æ˜¯å–å›æ•°æ®åº“é‡Œçš„metadataï¼ˆå®ƒæ¥è‡ªæ¯ç¯‡æ–‡ç« æˆ–ç”¨æˆ·è¾“å…¥ï¼‰ï¼Œæ•°æ®åœ¨æ•°æ®åº“ä¸­çš„wp_postmetaå’Œwp_usermetaè¡¨ä¸­ï¼Œæœ‰äº›æ•°æ®æ˜¯è¢«åºåˆ—åŒ–çš„è€Œæœ‰äº›æ²¡æœ‰è¢«åºåˆ—åŒ–ï¼Œæ‰€ä»¥maybe_unserialize()å‡½æ•°æ›¿ä»£äº†unserialize()åœ¨è¿™é‡Œæ“ä½œï¼Œè¿™ä¸ªå‡½æ•°åœ¨wp-includes/functions.phpçš„230åˆ°234è¡Œä¹‹é—´è¢«å®šä¹‰ã€‚</p>
<p>1</p>
<p>2
3</p>
<p>4
5function</p>
<p>maybe_unserialize(</p>
<p>$original</p>
<p>) {</p>
<p>if</p>
<p>( is_serialized(</p>
<p>$original</p>
<p>) )</p>
<p>//åºåˆ—åŒ–çš„æ•°æ®æ‰ä¼šèµ°åˆ°è¿™é‡Œé¢</p>
<p>return</p>
<p>@unserialize(</p>
<p>$original</p>
<p>);</p>
<p>return</p>
<p>$original</p>
<p>;
}</p>
<p>æ‰€ä»¥ï¼Œè¿™ä¸ªå‡½æ•°å¹²çš„äº‹æƒ…æ˜¯æ£€æŸ¥ç»™äºˆå®ƒçš„å€¼æ˜¯ä¸æ˜¯ä¸€ä¸ªåºåˆ—åŒ–çš„æ•°æ®ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±è§£åºåˆ—åŒ–ã€‚è¿™é‡Œç”¨æ¥åˆ¤æ–­æ˜¯å¦æ˜¯åºåˆ—åŒ–æ‰€ä½¿ç”¨çš„å‡½æ•°æ˜¯is_serialized()ï¼Œå®ƒçš„å®šä¹‰åœ¨åŒæ–‡ä»¶çš„247åˆ°276è¡Œä¹‹é—´ã€‚</p>
<p>function</p>
<p>is_serialized(</p>
<p>$data</p>
<p>) {</p>
<p>// å¦‚æœè¿å­—ç¬¦ä¸²éƒ½ä¸æ˜¯ï¼Œé‚£å°±ä¸æ˜¯åºåˆ—åŒ–çš„æ•°æ®äº†</p>
<p>if</p>
<p>( !</p>
<p>is_string</p>
<p>(</p>
<p>$data</p>
<p>) )</p>
<p>return</p>
<p>false;</p>
<p>$data</p>
<p>= trim(</p>
<p>$data</p>
<p>);</p>
<p>if</p>
<p>(</p>
<p>&#39;N;&#39;</p>
<p>==</p>
<p>$data</p>
<p>)</p>
<p>return</p>
<p>true;</p>
<p>$length</p>
<p>=</p>
<p>strlen</p>
<p>(</p>
<p>$data</p>
<p>);</p>
<p>if</p>
<p>(</p>
<p>$length</p>
<p>&lt; 4 )</p>
<p>return</p>
<p>false;</p>
<p>if</p>
<p>(</p>
<p>&#39;:&#39;</p>
<p>!==</p>
<p>$data</p>
<p>[1] )</p>
<p>return</p>
<p>false;</p>
<p>$lastc</p>
<p>=</p>
<p>$data</p>
<p>[</p>
<p>$length</p>
<p>-1];</p>
<p>if</p>
<p>(</p>
<p>&#39;;&#39;</p>
<p>!==</p>
<p>$lastc</p>
<p>&amp;&amp;</p>
<p>&#39;}&#39;</p>
<p>!==</p>
<p>$lastc</p>
<p>)</p>
<p>return</p>
<p>false;</p>
<p>$token</p>
<p>=</p>
<p>$data</p>
<p>[0];</p>
<p>switch</p>
<p>(</p>
<p>$token</p>
<p>) {</p>
<p>case</p>
<p>&#39;s&#39;</p>
<p>:</p>
<p>if</p>
<p>(</p>
<p>&#39;&quot;&#39;</p>
<p>!==</p>
<p>$data</p>
<p>[</p>
<p>$length</p>
<p>-2] )</p>
<p>return</p>
<p>false;</p>
<p>case</p>
<p>&#39;a&#39;</p>
<p>:</p>
<p>case</p>
<p>&#39;O&#39;</p>
<p>:</p>
<p>return</p>
<p>(bool) preg_match(</p>
<p>&quot;/^{$token}:[0-9]+:/s&quot;</p>
<p>,</p>
<p>$data</p>
<p>);</p>
<p>case</p>
<p>&#39;b&#39;</p>
<p>:</p>
<p>case</p>
<p>&#39;i&#39;</p>
<p>:</p>
<p>case</p>
<p>&#39;d&#39;</p>
<p>:</p>
<p>return</p>
<p>(bool) preg_match(</p>
<p>&quot;/^{$token}:[0-9.E-]+;\$/&quot;</p>
<p>,</p>
<p>$data</p>
<p>);</p>
<p>}</p>
<p>return</p>
<p>false;</p>
<p>}</p>
<p>WordPressæ£€æŸ¥ä¸€ä¸ªå€¼æ˜¯å¦æ˜¯åºåˆ—åŒ–çš„å­—ç¬¦ä¸²ä¸ºä»€ä¹ˆé‚£ä¹ˆé‡è¦çš„åŸå› é©¬ä¸Šè¦å˜å¾—æ¸…æ™°äº†ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸€ä¸ªæ”»å‡»è€…å¦‚ä½•æŠŠä»–çš„å†…å®¹æœ€ç»ˆåŠ å…¥åˆ°metadataè¡¨ä¸­çš„ã€‚æ¯ä¸ªç”¨æˆ·çš„å§“åï¼Œé›…è™IMéƒ½å­˜å‚¨åœ¨wp_usermetaè¡¨é‡Œã€‚æ‰€ä»¥æˆ‘ä»¬æŠŠè‡ªå·±çš„æ¶æ„ä»£ç åŠ åœ¨é‚£æˆ‘ä»¬å°±å¯ä»¥ææ‚æ‰WordPressï¼Œå¯¹ä¸å¯¹ï¼Ÿä½ å¯ä»¥è¯•è¯•åœ¨ä½ è¯¥å†™åå­—çš„åœ°æ–¹å†™ä¸ªi:1è¯•è¯•ï¼Œå¦‚æœè¿™ä¸ªæ²¡æœ‰è¢«è§£åºåˆ—åŒ–é‚£è¿™é‡Œåªä¼šè¿”å›ä¸€ä¸ªæˆ‘ä»¬è¾“å…¥çš„i:1ã€‚</p>
<p>éº»ç—¹çš„ï¼Œçœ‹æ¥è¦å‘å‡ ä¸ªå¤§æ‹›æ‰å¯ä»¥ææ‚WordPresså•Šã€‚è®©æˆ‘ä»¬æŒ–å¾—å†æ·±ä¸€ç‚¹ï¼Œçœ‹çœ‹ä¸ºä»€ä¹ˆè¿™ä¸ªä¸œè¥¿å°±æ²¡æœ‰ç»™è§£åºåˆ—åŒ–ã€‚åœ¨ wp-includes/meta.php ä¸­ï¼Œè¿™ä¸ªupdate_metadata() å‡½æ•°å®šä¹‰åœ¨101-164è¡Œï¼Œè¿™é‡Œæœ‰è¿™ä¸ªå‡½æ•°çš„éƒ¨åˆ†ä»£ç ã€‚</p>
<p>// â€¦</p>
<p>$meta_value</p>
<p>= wp_unslash(</p>
<p>$meta_value</p>
<p>);</p>
<p>$meta_value</p>
<p>= sanitize_meta(</p>
<p>$meta_key</p>
<p>,</p>
<p>$meta_value</p>
<p>,</p>
<p>$meta_type</p>
<p>);</p>
<p>// â€¦</p>
<p>$meta_value</p>
<p>= maybe_serialize(</p>
<p>$meta_value</p>
<p>);</p>
<p>$data</p>
<p>= compact(</p>
<p>&#39;meta_value&#39;</p>
<p>);</p>
<p>// â€¦</p>
<p>$wpdb</p>
<p>-&gt;update(</p>
<p>$table</p>
<p>,</p>
<p>$data</p>
<p>,</p>
<p>$where</p>
<p>);</p>
<p>// â€¦</p>
<p>è¿™é‡Œmaybe_serializeå‡½æ•°å¯èƒ½èƒ½è§£é‡Šä¸ºä»€ä¹ˆæˆ‘ä»¬åˆšæ‰çš„æ“ä½œæ²¡æˆåŠŸï¼Œæˆ‘ä»¬å†è·Ÿè¿›å»çœ‹çœ‹è¿™ä¸ªå‡½æ•°ï¼Œå®ƒå®šä¹‰åœ¨wp-includes/functions.phpçš„314-324è¡Œã€‚</p>
<p>function</p>
<p>maybe_serialize(</p>
<p>$data</p>
<p>) {</p>
<p>if</p>
<p>(</p>
<p>is_array</p>
<p>(</p>
<p>$data</p>
<p>) ||</p>
<p>is_object</p>
<p>(</p>
<p>$data</p>
<p>) )</p>
<p>return</p>
<p>serialize(</p>
<p>$data</p>
<p>);</p>
<p>// äºŒæ¬¡åºåˆ—åŒ–æ˜¯ä¸ºäº†å‘ä¸‹æ”¯æŒ</p>
<p>// è¯¦è§ <a href="http://core.trac.wordpress.org/ticket/12930" target="_blank">http://core.trac.wordpress.org/ticket/12930</a></p>
<p>if</p>
<p>( is_serialized(</p>
<p>$data</p>
<p>) )</p>
<p>return</p>
<p>serialize(</p>
<p>$data</p>
<p>);</p>
<p>return</p>
<p>$data</p>
<p>;</p>
<p>}</p>
<p>æ‰€ä»¥å½“æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªåºåˆ—åŒ–çš„å€¼çš„è¯ï¼Œå®ƒå°±ä¼šå†åºåˆ—åŒ–ä¸€ä¸‹ï¼Œè¿™å°±æ˜¯ç°åœ¨å‘ç”Ÿçš„æƒ…å†µï¼Œä½ çœ‹ï¼Œæ•°æ®åº“é‡Œçš„ä¸œè¥¿ä¸æ˜¯i:1;è€Œæ˜¯s:4:&quot;i:1;&quot;;ï¼Œå½“è§£åºåˆ—åŒ–çš„æ—¶å€™å®ƒå°±æ˜¾ç¤ºä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œé‚£ç°åœ¨è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>ä½ æ‡‚çš„ï¼Œè¿™å¸–å­çš„å†…å®¹ä¹Ÿå­˜åœ¨æ•°æ®åº“é‡Œï¼Œä¸Šé¢è¿™å°±è¯´æ˜äº†ä¸ºä»€ä¹ˆæˆ‘ä»¬å¤±è´¥äº†ã€‚å¦‚æœæˆ‘ä»¬ç°åœ¨æƒ³å¾€æ•°æ®åº“æ’ä¸€ä¸ªåºåˆ—åŒ–åçš„ä¸œè¥¿ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨æˆ‘ä»¬æ’å…¥æ•°æ®çš„æ—¶å€™è®©is_serialized()è¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªfalseï¼Œè€Œå½“æˆ‘ä»¬å†ä»æ•°æ®é‡Œå–å®ƒçš„æ—¶å€™ï¼Œå®ƒå°±åº”è¯¥è¿”å›ä¸ªtrueäº†ã€‚</p>
<p>ä½ æ‡‚çš„ï¼ŒMysqlæ•°æ®åº“ï¼Œè¡¨å’Œå­—æ®µéƒ½æœ‰ä»–ä»¬è‡ªå·±çš„charsetå’Œcollation(å­—ç¬¦é›†å’Œå®šåºï¼‰ã€‚WordPresså‘¢ï¼Œé»˜è®¤çš„å­—ç¬¦é›†æ˜¯UTF-8ã€‚ä»è¿™ä¸ªåå­—å°±çœ‹çš„å‡ºæ¥ï¼Œè¿™ä¸ªå­—ç¬¦é›†å®ƒä¸æ”¯æŒå…¨éƒ¨çš„Unicodeå­—ç¬¦ï¼Œä½ è¦æ˜¯å¯¹è¿™ä¸ªæ„Ÿå…´è¶£ï¼Œä½ å¯ä»¥çœ‹çœ‹Mathias Bynensçš„è¿™ç¯‡æ–‡ç« ï¼š<a href="http://mathiasbynens.be/notes/mysql-utf8mb4ï¼Œè¿™æ–‡ç« æ•™äº†æˆ‘UTF-8çš„è¡¨å‚¨å­˜ä¸äº†Unicodeç¼–ç åŒºé—´æ˜¯U+010000åˆ°U+10FFFFçš„å­—ç¬¦ã€‚æ‰€ä»¥å½“æˆ‘ä»¬åœ¨è¿™ä¸ªæƒ…å†µä¸‹å°è¯•ä¿å­˜è¿™äº›å­—ç¬¦å‘¢ï¼Ÿæ˜¾è€Œæ˜“è§ï¼ŒåŒ…æ‹¬è¿™ä¸ªå­—ç¬¦å’Œè¿™ä¸ªå­—ç¬¦ä¹‹åçš„å†…å®¹éƒ½ä¼šè¢«å¿½ç•¥æ‰ã€‚æ‰€ä»¥åœ¨æˆ‘ä»¬å°è¯•æ’å…¥" target="_blank">http://mathiasbynens.be/notes/mysql-utf8mb4ï¼Œè¿™æ–‡ç« æ•™äº†æˆ‘UTF-8çš„è¡¨å‚¨å­˜ä¸äº†Unicodeç¼–ç åŒºé—´æ˜¯U+010000åˆ°U+10FFFFçš„å­—ç¬¦ã€‚æ‰€ä»¥å½“æˆ‘ä»¬åœ¨è¿™ä¸ªæƒ…å†µä¸‹å°è¯•ä¿å­˜è¿™äº›å­—ç¬¦å‘¢ï¼Ÿæ˜¾è€Œæ˜“è§ï¼ŒåŒ…æ‹¬è¿™ä¸ªå­—ç¬¦å’Œè¿™ä¸ªå­—ç¬¦ä¹‹åçš„å†…å®¹éƒ½ä¼šè¢«å¿½ç•¥æ‰ã€‚æ‰€ä»¥åœ¨æˆ‘ä»¬å°è¯•æ’å…¥</a></p>
<p>fooğŒ†bar
çš„æ—¶å€™ï¼ŒMysqlä¼šå¿½ç•¥</p>
<p>ğŒ†bar
è€Œä¿å­˜ä¸ºfooã€‚</p>
<p>è¿™ä¸ªè¿·é¢˜çš„æœ€åä¸€éƒ¨åˆ†å°±æ˜¯æˆ‘ä»¬éœ€è¦æ’å…¥ä¸€ä¸ªç”¨ä»¥ä¸€ä¼šå„¿è§£åºåˆ—åŒ–çš„å†…å®¹ï¼Œä¸ºäº†æµ‹è¯•è¿™ä¸ªï¼Œä½ å¯ä»¥æ’å…¥</p>
<p>1:iğŒ†
ä¸ºä½ çš„åå­—ã€‚æ­£å¦‚æ‰€è§åˆ°çš„ï¼Œç»“æœæ˜¯1ï¼Œæ„å‘³ç€ä½ çš„è¾“å…¥è¢«è§£åºåˆ—åŒ–äº†ï¼Œå¦‚æœä½ è¿˜ä¸ç›¸ä¿¡æˆ‘ï¼Œä½ è¯•ç€è¾“å…¥ä¸€ä¸ªç©ºæ•°ç»„çš„åºåˆ—åŒ–å¹¶ä¸”ä»¥è¯¥å­—ç¬¦ç»“å°¾ï¼š</p>
<p>a:0:{}ğŒ†
ã€‚è¿™ä¸ªç»“æœæ˜¯Arrayã€‚</p>
<p>è®©æˆ‘ä»¬ç»§ç»­</p>
<p>maybe_serialized(&#39;i:1;ğŒ†&#39;)
æ’å…¥äº†æ•°æ®åº“ã€‚WordPressä¸è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå·²åºåˆ—åŒ–çš„æ•°æ®ï¼Œå› ä¸ºå®ƒä¸æ˜¯;æˆ–è€…}ç»“å°¾çš„ã€‚å®ƒä¼šè¿”å›</p>
<p>i:1;ğŒ†
ï¼Œå½“æ’å…¥æ•°æ®åº“çš„æ—¶å€™ï¼Œå®ƒçš„å€¼æ˜¯i:1ï¼Œå½“å®ƒä»æ•°æ®åº“å–å›çš„æ—¶å€™ï¼Œå®ƒæœ‰äº†;æœ€ä¸ºæœ€åä¸€ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥å®ƒå¯ä»¥è§£åºåˆ—åŒ–æˆåŠŸã€‚ç¢‰å ¡äº†ã€‚æ¼æ´ã€‚</p>
<h2 id="0x02-wordpress-">0x02 WordPress åˆ©ç”¨</h2>
<p>ç°åœ¨æˆ‘ä»¬å±•ç¤ºäº†WordPresså­˜åœ¨PHPå¯¹è±¡æ³¨å…¥æ¼æ´ã€‚è®©æˆ‘ä»¬å°è¯•åˆ©ç”¨å®ƒã€‚æ‰€ä»¥ä¸ºäº†åˆ©ç”¨è¯¥æ¼æ´ï¼ˆé€šè¿‡æ³¨å…¥å¯¹è±¡çš„æ–¹æ³•ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªç¬¦åˆä»¥ä¸‹æ¡ä»¶çš„classï¼š</p>
<p>1ï¼Œå†…æœ‰â€œæœ‰ç”¨â€çš„æ–¹æ³•å¯è¢«è°ƒç”¨ã€‚
2ï¼Œå­˜åœ¨è¯¥å¯¹è±¡çš„ç±»å·²ç»è¢«åŒ…å«äº†ã€‚</p>
<p>å½“ä¸€ä¸ªå¯¹è±¡è¢«è§£åºåˆ—åŒ–çš„æ—¶å€™ï¼Œ__wakeupå‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œè¿™è¢«ç§°ä½œPHPçš„é­”æœ¯æ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ç¡®å®šä¼šè¢«è°ƒç”¨çš„æ–¹æ³•ï¼Œå®é™…ä¸Šè¿™äº›å‡½æ•°ä¼šæ›´å¤šå†™äº›ï¼Œæˆ‘å†™äº†ä¸€ä¸ªä»¥ä¸‹çš„classæ¥è·å–è¢«è°ƒç”¨çš„classåˆ°/tmp/fumc.logã€‚
&lt;?php</p>
<p>class</p>
<p>Foo {</p>
<p>public</p>
<p>static</p>
<p>function</p>
<p>logFuncCall(</p>
<p>$funcName</p>
<p>) {</p>
<p>$fh</p>
<p>=</p>
<p>fopen</p>
<p>(</p>
<p>&#39;/tmp/func.log&#39;</p>
<p>,</p>
<p>&#39;a&#39;</p>
<p>);</p>
<p>fwrite(</p>
<p>$fh</p>
<p>,</p>
<p>$funcName</p>
<p>.</p>
<p>&quot;\n&quot;</p>
<p>);</p>
<p>fclose(</p>
<p>$fh</p>
<p>);</p>
<p>}</p>
<p>public</p>
<p>function</p>
<p>__construct() { Foo::logFuncCall(</p>
<p>&#39;__construct(&#39;</p>
<p>.json_encode(func_get_args()).</p>
<p>&#39;)&#39;</p>
<p>);}</p>
<p>public</p>
<p>function</p>
<p>__destruct() { Foo::logFuncCall(</p>
<p>&#39;__destruct()&#39;</p>
<p>);}</p>
<p>public</p>
<p>function</p>
<p>__get(</p>
<p>$name</p>
<p>) { Foo::logFuncCall(</p>
<p>&quot;__get($name)&quot;</p>
<p>);</p>
<p>return</p>
<p>&quot;Foo&quot;</p>
<p>;}</p>
<p>public</p>
<p>function</p>
<p>__set(</p>
<p>$name</p>
<p>,</p>
<p>$value</p>
<p>) { Foo::logFuncCall(</p>
<p>&quot;__set($name, value)&quot;</p>
<p>);}</p>
<p>public</p>
<p>function</p>
<p>__isset(</p>
<p>$name</p>
<p>) { Foo::logFuncCall(</p>
<p>&quot;__isset($name)&quot;</p>
<p>);</p>
<p>return</p>
<p>true;}</p>
<p>public</p>
<p>function</p>
<p>__unset(</p>
<p>$name</p>
<p>) { Foo::logFuncCall(</p>
<p>&quot;__unset($name)&quot;</p>
<p>);}</p>
<p>public</p>
<p>function</p>
<p>__sleep() { Foo::logFuncCall(</p>
<p>&quot;__sleep()&quot;</p>
<p>);</p>
<p>return</p>
<p>array</p>
<p>();}</p>
<p>public</p>
<p>function</p>
<p>__wakeup() { Foo::logFuncCall(</p>
<p>&quot;__wakeup()&quot;</p>
<p>);}</p>
<p>public</p>
<p>function</p>
<p>__toString() { Foo::logFuncCall(</p>
<p>&quot;__toString()&quot;</p>
<p>);</p>
<p>return</p>
<p>&quot;Foo&quot;</p>
<p>;}</p>
<p>public</p>
<p>function</p>
<p>__invoke(</p>
<p>$a</p>
<p>) { Foo::logFuncCall(</p>
<p>&quot;__invoke(&quot;</p>
<p>. json_encode(func_get_args()).</p>
<p>&quot;)&quot;</p>
<p>);}</p>
<p>public</p>
<p>function</p>
<p>__call(</p>
<p>$a</p>
<p>,</p>
<p>$b</p>
<p>) { Foo::logFuncCall(</p>
<p>&quot;__call(&quot;</p>
<p>. json_encode(func_get_args()).</p>
<p>&quot;)&quot;</p>
<p>);}</p>
<p>public</p>
<p>static</p>
<p>function</p>
<p>__callStatic(</p>
<p>$a</p>
<p>,</p>
<p>$b</p>
<p>) { Foo::logFuncCall(</p>
<p>&quot;__callStatic(&quot;</p>
<p>. json_encode(func_get_args()).</p>
<p>&quot;)&quot;</p>
<p>);}</p>
<p>public</p>
<p>static</p>
<p>function</p>
<p>__set_state(</p>
<p>$a</p>
<p>) { Foo::logFuncCall(</p>
<p>&quot;__set_state(&quot;</p>
<p>. json_encode(func_get_args()).</p>
<p>&quot;)&quot;</p>
<p>);</p>
<p>return</p>
<p>null;}</p>
<p>public</p>
<p>function</p>
<p>__clone() { Foo::logFuncCall(</p>
<p>&quot;__clone()&quot;</p>
<p>);}</p>
<p>}
?&gt;</p>
<p>ä¸ºäº†åˆ—å‡ºè¿™äº›è¢«è°ƒç”¨çš„å‡½æ•°ï¼Œé¦–å…ˆè¦ç¡®è®¤è¿™ä¸ªå‡½æ•°åœ¨è§£åºåˆ—åŒ–å‘ç”Ÿçš„æ—¶å€™æ˜¯è¢«å¼•å…¥è¢«åŒ…å«è¿‡çš„ï¼ˆphpä¸­çš„include requireç­‰ï¼‰ã€‚ä½ å¯ä»¥æŠŠrequire_once(&#39;foo.php&#39;)åŠ åˆ°functions.phpçš„é¡¶ç«¯ã€‚æ¥ä¸‹æ¥ï¼ŒæŠŠåå­—æ”¹ä¸ºO:3:&quot;Foo&quot;:0:{}ğŒ†æ¥å°è¯•åˆ©ç”¨è¿™ä¸ªPHPå¯¹è±¡æ³¨å…¥æ¼æ´ï¼Œå½“åˆ·æ–°é¡µé¢åï¼Œä½ å›çœ‹åˆ°ä½ çš„åå­—å˜æˆäº†Fooï¼Œè¿™ä¹Ÿå°±æ˜¯æ„å‘³ç€è¿™æ˜¯ä¸Šé¢é‚£classä¸­__toString()å‡½æ•°çš„è¿”å›ï¼Œç„¶åè®©æˆ‘ä»¬çœ‹çœ‹éƒ½æœ‰å“ªäº›å‡½æ•°è¢«è°ƒç”¨äº†ã€‚</p>
<p>$ sort -u /tmp/func.log <strong>destruct() </strong>toString() __wakeup()</p>
<p>ç»™å‡ºäº†æˆ‘ä»¬ä¸‰ä¸ªå‡½æ•°ï¼š<strong>wakeup(), </strong>destruct() å’Œ __toString()</p>
<p>å¾ˆä¸å¹¸çš„æ˜¯æˆ‘ä¸èƒ½å†WordPressä¸­æ‰¾åˆ°ä¸€ä¸ªè½½å…¥äº†å¹¶ä¸”è§£åºåˆ—åŒ–æ—¶èƒ½è¢«åˆ©ç”¨é€ æˆå½±å“çš„ç±»ã€‚æ‰€ä»¥ä¸æ˜¯ä¸€ä¸ªWordPressçš„å®‰å…¨é—®é¢˜ï¼Œè€Œæ˜¯ä¸€ä¸ªå¯èƒ½åˆ©ç”¨çš„åœ°æ–¹ã€‚</p>
<p>æ‰€ä»¥æ˜¯ä¸æ˜¯WordPressæ˜¯æœ‰å®‰å…¨éšæ‚£çš„ï¼Œä½†æ˜¯æ— æ³•è¢«åˆ©ç”¨ï¼Ÿä¸ä¸€å®šï¼Œå¦‚æœä½ ç†Ÿæ‚‰WordPressï¼Œä½ å¯èƒ½ä¼šè§‰å¯Ÿåˆ°å¯èƒ½æœ‰ä¸€å †æ’ä»¶å­˜åœ¨æ¼æ´ã€‚è¿™äº›æ’ä»¶æœ‰ä»–ä»¬è‡ªå·±çš„ç±»å¹¶ä¸”å¯èƒ½æš´éœ²å‡ºå¯è¢«åˆ©ç”¨çš„å®‰å…¨æ¼æ´ã€‚æˆ‘æƒ³åˆ°è¿™ä¸ªåï¼Œå·²ç»å‘ç°äº†ä¸€æ¬¾è‘—åçš„æ’ä»¶å­˜åœ¨æ¼æ´å¹¶ä¸”å¯ä»¥å¯¼è‡´è¿œç¨‹ä»»æ„ä»£ç æ‰§è¡Œã€‚</p>
<p>ç”±äºé“å¾·è€ƒè™‘ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä¸ä¼šå‘å¸ƒPoCçš„ï¼Œæœ‰å¤ªå¤šå­˜åœ¨å®‰å…¨æ¼æ´çš„WordPressäº†ã€‚</p>
<h2 id="0x03-wordpress">0x03 ä¿®å¤WordPress</h2>
<p>è¿™ä¸ªä¿®å¤æ–¹å¼æ˜¯ä¿®æ”¹is_serializedå‡½æ•°ï¼Œæˆ‘ç®€å•çš„è¯´è¯´ï¼š
function</p>
<p>is_serialized(</p>
<p>$data</p>
<p>,</p>
<p>$strict</p>
<p>= true ) {</p>
<p>// å¦‚æœä¸æ˜¯å­—ç¬¦ä¸²å°±ä¸ä¼šæ˜¯åºåˆ—åŒ–åçš„æ•°æ®</p>
<p>if</p>
<p>( !</p>
<p>is_string</p>
<p>(</p>
<p>$data</p>
<p>) )</p>
<p>return</p>
<p>false;</p>
<p>if</p>
<p>(</p>
<p>&#39;:&#39;</p>
<p>!==</p>
<p>$data</p>
<p>[1] )</p>
<p>return</p>
<p>false;</p>
<p>if</p>
<p>(</p>
<p>$strict</p>
<p>) {</p>
<p>$lastc</p>
<p>=</p>
<p>$data</p>
<p>[</p>
<p>$length</p>
<ul>
<li>1 ];</li>
</ul>
<p>if</p>
<p>(</p>
<p>&#39;;&#39;</p>
<p>!==</p>
<p>$lastc</p>
<p>&amp;&amp;</p>
<p>&#39;}&#39;</p>
<p>!==</p>
<p>$lastc</p>
<p>)</p>
<p>return</p>
<p>false;</p>
<p>}</p>
<p>else</p>
<p>{</p>
<p>//ç¡®è®¤å­˜åœ¨;æˆ–}ä½†ä¸æ˜¯åœ¨ç¬¬ä¸€ä¸ªå­—ç¬¦</p>
<p>if</p>
<p>(</p>
<p>strpos</p>
<p>(</p>
<p>$data</p>
<p>,</p>
<p>&#39;;&#39;</p>
<p>) &lt; 3 &amp;&amp;</p>
<p>strpos</p>
<p>(</p>
<p>$data</p>
<p>,</p>
<p>&#39;}&#39;</p>
<p>) &lt; 4 )</p>
<p>return</p>
<p>false;</p>
<p>}</p>
<p>$token</p>
<p>=</p>
<p>$data</p>
<p>[0];</p>
<p>switch</p>
<p>(</p>
<p>$token</p>
<p>) {</p>
<p>case</p>
<p>&#39;s&#39;</p>
<p>:</p>
<p>if</p>
<p>(</p>
<p>$strict</p>
<p>) {</p>
<p>if</p>
<p>(</p>
<p>&#39;&quot;&#39;</p>
<p>!==</p>
<p>$data</p>
<p>[</p>
<p>$length</p>
<ul>
<li>2 ] )</li>
</ul>
<p>return</p>
<p>false;</p>
<p>}</p>
<p>elseif</p>
<p>( false ===</p>
<p>strpos</p>
<p>(</p>
<p>$data</p>
<p>,</p>
<p>&#39;&quot;&#39;</p>
<p>) ) {</p>
<p>return</p>
<p>false;</p>
<p>}</p>
<p>case</p>
<p>&#39;a&#39;</p>
<p>:</p>
<p>case</p>
<p>&#39;O&#39;</p>
<p>:</p>
<p>return</p>
<p>(bool) preg_match(</p>
<p>&quot;/^{$token}:[0-9]+:/s&quot;</p>
<p>,</p>
<p>$data</p>
<p>);</p>
<p>case</p>
<p>&#39;b&#39;</p>
<p>:</p>
<p>case</p>
<p>&#39;i&#39;</p>
<p>:</p>
<p>case</p>
<p>&#39;d&#39;</p>
<p>:</p>
<p>$end</p>
<p>=</p>
<p>$strict</p>
<p>?</p>
<p>&#39;$&#39;</p>
<p>:</p>
<p>&#39;&#39;</p>
<p>;</p>
<p>return</p>
<p>(bool) preg_match(</p>
<p>&quot;/^{$token}:[0-9.E-]+;$end/&quot;</p>
<p>,</p>
<p>$data</p>
<p>);</p>
<p>}</p>
<p>return</p>
<p>false;</p>
<p>}</p>
<p>è¿™ä¸»è¦çš„åŒºåˆ«æ˜¯å½“$strictå‚æ•°è®¾ç½®ä¸ºfalseçš„æ—¶å€™ï¼Œä¼šæœ‰ä¸€äº›å¼ºåˆ¶æ“ä½œå¯¼è‡´ä¸€ä¸ªå­—ç¬¦ä¸²è¢«æ ‡è®°ä¸ºå·²åºåˆ—åŒ–ã€‚ä¸¾ä¾‹è¯´æ˜ï¼Œæœ€åä¸€ä¸ªå­—ç¬¦ä¸éœ€è¦å¿…é¡»æ˜¯;æˆ–è€…{ï¼ˆè¯‘è€…æ³¨ï¼šä½œè€…æ­¤å¤„åº”è¯¥ç¬”è¯¯äº†ï¼Œåº”è¯¥æ˜¯;æˆ–è€…}),ä¿®å¤äº†æˆ‘æ‰€æäº¤çš„æ¼æ´ã€‚ç°åœ¨å¤§å®¶æœ‰æ²¡æœ‰ç›¸ä¼¼çš„å†…å®¹å¯ä»¥æ‹¿å‡ºæ¥åšä¸ªè®¨è®ºçš„ï¼Ÿ</p>
<p>WordPressä¾æ—§ä½¿ç”¨ç€ä¸å®‰å…¨çš„unserialize()è€Œéå®‰å…¨çš„json_decodeã€‚å®ƒçš„å®‰å…¨æ€§å…¨åœ¨åˆ¤æ–­è§„åˆ™æˆ–è€…Mysqlçš„è§„åˆ™å®ç°ä¸Šã€‚æˆ‘åœ¨ä¸Šé¢æ­éœ²çš„æ¼æ´å®é™…ä¸Šæ˜¯ä½¿ç”¨Mysqlçš„è§„åˆ™å»æ‰æˆ‘è·Ÿåœ¨ç‰¹æ®Šç¬¦å·åçš„æ‰€æœ‰å­—ç¬¦ã€‚</p>
<p>æœ‰ä¸€ä¸ªå¾ˆç®€æ´çš„ä¿®å¤æ–¹æ¡ˆï¼Œä¿®æ”¹ä¸€ä¸‹æ•°æ®åº“ç¼–ç ä¸è¢«æˆªæ–­å°±å¥½ï¼š
ALTER TABLE wp_commentmeta CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci; ALTER TABLE wp_postmeta CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci; ALTER TABLE wp_usermeta CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</p>

      
    </div>
    <section id='after_content_widget'><div class="widget" id="widget_after_content_wumiiRelatedItems>">
<script type="text/javascript" id="wumiiRelatedItems"></script>
</div><div class="widget" id="widget_after_content_post_footer_info>">
<div class="panel panel-success">
    <div class="panel-heading" align="center">å¸Œæœ›æœ¬ç«™å†…å®¹å¯¹æ‚¨æœ‰ç‚¹ç”¨å¤„,æœ‰ä»€ä¹ˆç–‘é—®æˆ–å»ºè®®è¯·åœ¨åé¢ç•™è¨€è¯„è®º</div>
    <div align="center" class="panel-body">è½¬è½½è¯·æ³¨æ˜ä½œè€…(<a href="http://itsolife.com/about/">RobinChia</a>)å’Œå‡ºå¤„ <a href="http://itsolife.com">It so life</a> ï¼Œè¯·å‹¿ç”¨äºä»»ä½•å•†ä¸šç”¨é€”</div>
    <div class="panel-body">æœ¬æ–‡é“¾æ¥: <a href="/2014/02/02/2014-02-02-å®‰å…¨-PHP-WordPress--WordPress-361PHPå¯¹è±¡æ³¨å…¥æ¼æ´-WooYunçŸ¥è¯†åº“/">WordPress </a></div>
</div>
</div></section>
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/å®‰å…¨/">å®‰å…¨</a></li></span><span class="breadcrumb"><li><a href="/categories/å®‰å…¨/">å®‰å…¨</a></li><li><a href="/categories/å®‰å…¨/PHP-WordPress/">PHP-WordPress</a></li></span></span> | <span class="tags">Tagged <a href="/tags/PHP-WordPress/" class="label label-primary">PHP-WordPress</a><a href="/tags/å®‰å…¨/" class="label label-success">å®‰å…¨</a></span> | <span class="time">recent updated:<time title="2014-03-29 22:51:25"datetime="2014-03-29 22:51:25"> mar. 29 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-å®‰å…¨-PHP-WordPress--WordPress-361PHPå¯¹è±¡æ³¨å…¥æ¼æ´-WooYunçŸ¥è¯†åº“/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-å®‰å…¨-PHP-WordPress--WordPress-361PHPå¯¹è±¡æ³¨å…¥æ¼æ´-WooYunçŸ¥è¯†åº“" data-count-type="comments">æš‚æ— è¯„è®º</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>


    <section id='after_post_widget'><div class="widget" id="widget_after_post_post_pageNav>">
<ul class="pager">
  
  <li class="previous"><a href="/2014/02/02/2014-02-02-å®‰å…¨-PHP-WordPress--è·‘wordpressç”¨æˆ·å¯†ç è„šæœ¬/" title="è·‘wordpressç”¨æˆ·å¯†ç è„šæœ¬">&larr; è·‘wordpressç”¨æˆ·å¯†ç è„šæœ¬</a></li>
  
  
  <li class="next"><a href="/2014/02/02/2014-02-02-å®‰å…¨-strutsJava--æ›´æ–°Struts2å†çˆ†è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆS2-016ï¼‰-FreebuFCOM/" title="[æ›´æ–°]Struts2å†çˆ†è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆS2">[æ›´æ–°]Struts2å†çˆ†è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆS2 &rarr;</a></li>
  
</ul></div><div class="widget" id="widget_after_post_related_posts>">
<ul class="list-group"><li class="list-group-item"><a href="/2014/02/02/2014-02-02-å®‰å…¨-X--è¿™ä¸ªä¸–ç•Œæ˜¯ä¸€ç‚¹æ‡’éƒ½å·ä¸äº†çš„ï¼_Vexs_ç™¾åº¦ç©ºé—´/">è¿™ä¸ªä¸–ç•Œæ˜¯ä¸€ç‚¹æ‡’éƒ½å·ä¸äº†çš„ï¼_Vexs_ç™¾åº¦ç©ºé—´</a></li><li class="list-group-item"><a href="/2014/02/02/2014-02-02-å®‰å…¨-æ— çº¿--æµ…ææ— çº¿ç½‘ç»œæ•°æ®çª¥æ¢æŠ€æœ¯-FreebuFCOM/">æµ…ææ— çº¿ç½‘ç»œæ•°æ®çª¥æ¢æŠ€æœ¯</a></li><li class="list-group-item"><a href="/2014/02/02/2014-02-02-å®‰å…¨--ç ´è§£GoogleGmailçš„httpsæ–°æ€è·¯/">ç ´è§£Google Gmailçš„httpsæ–°æ€è·¯</a></li><li class="list-group-item"><a href="/2014/02/02/2014-02-02-å®‰å…¨--æŠ€æœ¯è§£æä¸€ä»½ArchmakeCOMçš„æ¸—é€æµ‹è¯•æŠ¥å‘Š-FreebuFCOM/">[æŠ€æœ¯è§£æ]ä¸€ä»½Archmake.COMçš„æ¸—é€æµ‹è¯•æŠ¥å‘Š</a></li><li class="list-group-item"><a href="/2014/02/02/2014-02-02-å®‰å…¨-X--æ”»å‡»Googleçš„Jarlsbergï¼Œå­¦ä¹ å®‰å…¨æ¼æ´çŸ¥è¯†/">æ”»å‡»Googleçš„Jarlsbergï¼Œå­¦ä¹ å®‰å…¨æ¼æ´çŸ¥è¯†</a></li><li class="list-group-item"><a href="/2014/02/02/2014-02-02-å®‰å…¨-PHP-WordPress--è·‘wordpressç”¨æˆ·å¯†ç è„šæœ¬/">è·‘wordpressç”¨æˆ·å¯†ç è„šæœ¬</a></li><li class="list-group-item"><a href="/2014/02/02/2014-02-02-å®‰å…¨--ä»è°·æ­Œå®•æœºäº‹ä»¶è®¤è¯†äº’è”ç½‘å·¥ä½œåŸç†-CSDNNET/">ä»è°·æ­Œå®•æœºäº‹ä»¶è®¤è¯†äº’è”ç½‘å·¥ä½œåŸç†</a></li><li class="list-group-item"><a href="/2014/02/02/2014-02-02-å®‰å…¨--ä¸€æ¬¡æœåŠ¡å™¨è¢«å…¥ä¾µåçš„åˆ†æ/">ä¸€æ¬¡æœåŠ¡å™¨è¢«å…¥ä¾µåçš„åˆ†æ</a></li></ul></div></section>    
	<div id="comments"><!-- Duoshuo Comment BEGIN -->

<div class="ds-thread"  data-thread-key="2014-02-02-å®‰å…¨-PHP-WordPress--WordPress-361PHPå¯¹è±¡æ³¨å…¥æ¼æ´-WooYunçŸ¥è¯†åº“"  data-url="http://itsolife.com/2014/02/02/2014-02-02-å®‰å…¨-PHP-WordPress--WordPress-361PHPå¯¹è±¡æ³¨å…¥æ¼æ´-WooYunçŸ¥è¯†åº“/" data-title="WordPress "></div>

		

<!-- Duoshuo Comment END -->

</div></div><!--wapper-->
       </div><!-- ID main-col END -->
       <aside id="sidebar" class="alignright col-sx-6 col-sm-4 col-md-3 col-lg-3">
<div id="widget_search" class="widget panel panel-primary">
    <form action="//google.com/search" method="get" accept-charset="utf-8">
  <div class="input-group">
    <input class="form-control" id="searchbox" type="search" name="q" results="0" placeholder="search">
    <span class="input-group-btn">
      <button class="btn btn-default" type="submit">Go!</button>
    </span>
    <input type="hidden" name="q" value="site:itsolife.com">
  </div>
</form>
</div>

<div id="widget_category" class="widget panel panel-primary">
  <div class="panel-heading">category</div>  <div data-src='category' class='ajax_widgets'>æ­£åœ¨åŠ è½½...</div>
</div>

<div id="widget_recent_posts" class="widget panel panel-primary">
  <div class="panel-heading">recent posts</div>  <div data-src='recent_posts' class='ajax_widgets'>æ­£åœ¨åŠ è½½...</div></div>

<div id="widget_tagcloud" class="widget panel panel-primary">
  <div class="panel-heading">tagcloud</div>  <div data-src='tagcloud' class='ajax_widgets'>æ­£åœ¨åŠ è½½...</div></div>

<div id="widget_latest_update_posts" class="widget panel panel-primary">
  <div class="panel-heading">æœ€è¿‘æ›´æ–°</div>  <div data-src='latest_update_posts' class='ajax_widgets'>æ­£åœ¨åŠ è½½...</div></div>

<div id="widget_recent_comments" class="widget panel panel-primary">
  <div class="panel-heading">recent comments</div>  

<div class="list-group-item ds-recent-comments" data-num-items="6" data-show-avatars="1" data-show-time="1" data-show-title="1" data-show-admin="1" data-excerpt-length="50"></div>



</div>

</aside>
       <div class="clearfix"></div>
     </div><!-- row END -->
  </div>
  <footer id="footer" class="container">
  <div class="panel panel-info">
  <section id='footer_widget'></section>  <div class="panel-footer">
  <div id="site-info">
    <span class='author'>
  
  &copy; 2014 RobinChia
  
    &nbsp;&nbsp;</span>
  
  <span id='analytics-51la'></span><span id='analytics-google'>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-48559895-1']);
  _gaq.push(['_trackPageview']);
  _js2load.push({src:('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'});
</script></span><span id='analytics-cnzz'>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_5774006'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s17.cnzz.com/stat.php%3Fid%3D5774006%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</span><span id='analytics-baidu'>
<script>
var _hmt = _hmt || [];
_js2load.push({src:"//hm.baidu.com/hm.js?1442f50724afc42380b51f097c43082c"});
</script>
</span>  </div>
  <div id="copyright">Site powered by <a href='http://zespia.tw/hexo/'><strong>hexo</strong></a>  update time: <em>2014-03-29 22:51:25</em></span></div>
</div>
<div class="clearfix"></div>


  </div>
  </footer>
  
        <script src="http://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>        
        <script src="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>        
                
        <script src="http://cdn.bootcss.com/prettify/r298/prettify.min.js"></script>    <script type="text/javascript">
   var lang=["bsh", "c", "cc", "cpp", "cs", "csh", "cyc", "cv", "htm", "html",
    "java", "js", "m", "mxml", "perl", "pl", "pm", "py", "rb", "sh",
    "xhtml", "xml", "xsl"];
   var pretty_base='';
   $('script').each(function(){
	var c = $(this).attr('src');
	if (!c)
	    return;
	if (c.match(/(\/)?prettify(\.min)?\.js/i))
	{
	    var index = c.lastIndexOf('/');
	    if (index != -1)
		pretty_base = c.substr(0,index + 1);
	    return false;
	}
   })
   $('pre code').each(function(){
	var c = $(this).attr('class')
	if (!c)
	    return;
	c = c.match(/\s?(lang\-\w+)/i);
	if (c && lang.indexOf(c[1]) == -1)
	{
	    lang.push(c[1]);
	    $.getScript(pretty_base + c[1] + '.min.js');
	}
   })

    $(window).load(function(){
       $("pre").addClass("prettyprint");
       prettyPrint();
    })
</script>    
            <script type="text/javascript">
var duoshuoQuery = {short_name:"robinchia"};
_js2load.push({src:'http://static.duoshuo.com/embed.js',charset:'UTF-8'});
</script>
    
            <!--wumii_relatedItems-->

<script type="text/javascript">
    var wumiiPermaLink = "http://itsolife.com/2014/02/02/2014-02-02-å®‰å…¨-PHP-WordPress--WordPress-361PHPå¯¹è±¡æ³¨å…¥æ¼æ´-WooYunçŸ¥è¯†åº“/";
    var wumiiTitle = "WordPress ";
    var wumiiTags = "PHP-WordPress,å®‰å…¨";
    var wumiiCategories = ["å®‰å…¨","å®‰å…¨","PHP-WordPress"];
    var wumiiSitePrefix = "http://itsolife.com";
    var wumiiParams = "&num=5&mode=3&pf=JAVASCRIPT";
    _js2load.push({src:'http://widget.wumii.cn/ext/relatedItemsWidget'});
</script>
<a href="http://www.wumii.com/widget/relatedItems" style="border:0;">
<img src="http://static.wumii.cn/images/pixel.png" alt="æ— è§…å…³è”æ¨èï¼Œå¿«é€Ÿæå‡æµé‡" style="border:0;padding:0;margin:0;" />
</a>
    
        <script src="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>    <script type="text/javascript">
(function($){
  $('.entry').each(function(i){
    $(this).find('img').each(function(){
      var alt = this.alt;

      if (alt){
        $(this).before('<span class="caption">' + alt + '</span>');
      }

      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="fancybox' + i + '" />');
    });
  });

  $('.fancybox').fancybox();
})(jQuery);
</script>    
        <script src="http://cdn.bootcss.com/mathjax/2.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>
    
<script type="text/javascript">
$('.ajax_widgets').each(function(){var src=$(this).attr('data-src');if(src)$(this).load('/widgets/'+src+'.html');});
$.each(_js2load,function(index,obj){loadjs(obj.src,obj.charset)});
</script>

<div id="scroll2top">
<img src="/scroll2top/arrow.png"/>
</div>
<script src="/scroll2top/scroll2top.min.js"></script>
<div id="winterland">
  <canvas></canvas>
</div>
<script src="/js/winterland.min.js"></script>

  </body>
</html>
