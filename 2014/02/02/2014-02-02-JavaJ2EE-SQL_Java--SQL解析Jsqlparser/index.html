
<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>SQL解析(Jsqlparser) | It so life</title>
<meta name="author" content="RobinChia">

<meta name="description" content="SQL解析(Jsqlparser)前段时间主要研究了一下SQL语句的解析，主要的几个开源产品试用了一下。本文大概总结一下个人体会。
首先是ZQL，ZQL有个比较突出的优点是使用起来比较简单，基本上属于拿上手就可以用的。但支持的功能有限，selectItem可以是简单的表达式，但不支持查询作为一个selectItem，对于其他的子查询同样也不支持。">


<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<meta property="og:title" content="SQL解析(Jsqlparser)"/>
<meta property="og:site_name" content="It so life"/>

<!--[if IE]><style>.testIE.IE{display:inline;}</style><![endif]-->
<!--[if lte IE 7]><link rel="stylesheet" href="/css/ie7.css" type="text/css"><![endif]-->
<!--[if (lt IE 9)&(gt IE 7)]><style>.testIE.IE8{display:inline;}</style><![endif]-->
<!--[if gt IE 8]><style>.testIE.IE9{display:inline;}</style><![endif]-->

<link href="/favicon.png" rel="icon">
<link rel="alternate" href="/atom.xml" title="It so life Feed" type="application/atom+xml">

<link rel="stylesheet" href="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/font-awesome/4.0.3/css/font-awesome.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/prettify/r298/prettify.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" type="text/css">
<link rel="stylesheet" href="/css/style.css" type="text/css">
<!--[if lt IE 9]>
   <style>article,aside,dialog,footer,header,section,footer,nav,figure,menu{display:block}</style>
   <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
   <script src="http://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
<link href="http://cdn.staticfile.org/respond.js/1.4.2/respond-proxy.html" id="respond-proxy" rel="respond-proxy" />
<link href="/js/respond.proxy.gif" id="respond-redirect" rel="respond-redirect" />
<script src="/js/respond.proxy.js"></script>
   <script src="http://cdn.bootcss.com/selectivizr/1.0.2/selectivizr-min.js"></script>
<![endif]-->
<script type="text/javascript">
function loadjs(c,d){var a=document.createElement("script");a.async=!0;a.type="text/javascript";a.src=c;a.charset=d||"gbk";(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(a)};
var _protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
var _js2load = [];
</script>

</head>
<body>
      <header id="header" class="container"><nav id="main-nav" class="navbar navbar-default navbar-fixed-top " role="navigation">
  <div class="container">
    <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/">It so life</a>
    </div>
    <div  class="collapse navbar-collapse">
      <ul  class="nav navbar-nav">
  
        <li><a href="/" title="Home">Home</a></li>      
        <li><a href="/about/" title="About">About</a></li>      
        <li><a href="/archives/" title="Archives">Archives</a></li>      
      <li class='dropdown'>
        <a class='dropdown-toggle' data-toggle='dropdown' href='#'>website<b class='caret'></b></a>
        <ul class='dropdown-menu pure-menu-selected'>
    
          <li><a href="//groups.google.com/forum/#!forum/pongba" title="TopLanguage">TopLanguage</a></li>    
          <li><a href="//itpub.net/" title="ITPub">ITPub</a></li>    
          <li><a href="//blog.jobbole.com/" title="Bole">Bole</a></li>    
          <li><a href="//nosql-database.org/" title="nosql">nosql</a></li>    
          <li><a href="//gitimmersion.googol.im/" title="Git">Git</a></li>    
        </ul>
      </li>
    
      </ul>
      <ul class="nav navbar-nav navbar-right">
      
        <li><a href="/atom.xml">RSS</a></li>
      
      
        <li><a href="https://twitter.com/robinchia">twitter</a></li>
      
      
      
      
        <li><a href="https://github.com/robinchia">github</a></li>
      
      </ul>
    </div>
  </div>
</nav>
<div class="clearfix"></div>
</header>
  <div id='content' class="container">
     <div class="page-header-wrapper">
      <!--[if lt IE 9]><div class="alert alert-warning alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>提示:</strong>您的浏览器版本太低了,建议升级到 <strong><a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" title="IE9">IE9</a></strong> 以上,本站使用<a href="https://www.google.com/intl/zh-CN/chrome/">Chrome浏览器</a>可以获得最好的显示效果.</div><![endif]-->
      <div class="page-header"><h1 align="center"><big>It so life</big> </h1>
        <h5 align="center"><big>love as life</big></h5>
      </div>
     </div>
     <div class="row">
       <div id="main-col" class="alignleft col-sx-12 col-sm-8 col-md-9 col-lg-9">
      <section id='header_widget'></section>
          <div id="wrapper"><article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title">SQL解析(Jsqlparser)</h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:41.000Z"> <a href="/2014/02/02/2014-02-02-JavaJ2EE-SQL_Java--SQL解析Jsqlparser/">feb. 2 2014</a></time></span>      
    </header>
    
    <section id='before_content_widget'></section>
    <div class="entry">
      
        <h1 id="sql-jsqlparser-">SQL解析(Jsqlparser)</h1>
<p>前段时间主要研究了一下SQL语句的解析，主要的几个开源产品试用了一下。本文大概总结一下个人体会。
首先是ZQL，ZQL有个比较突出的优点是使用起来比较简单，基本上属于拿上手就可以用的。但支持的功能有限，selectItem可以是简单的表达式，但不支持查询作为一个selectItem，对于其他的子查询同样也不支持。
最终我选择使用了Jsqlparser，主要原因有两点：
1）功能强大，基本上能够覆盖所有的SQL语法（没有研究是不是包含了数据库特殊的关键字，如LIMIT ），包含UNION,GROUP BY,HAVING,ORDER BY,JOIN,SUB JOIN,SUB SELECT,FUNCTION等。支持SQL深层嵌套。
2）本身设计不错，使用起来感觉很灵活。Jsqlparser对于SQL的遍历采用了VISITOR模式可以很方便的遍历SQL语句。
下面主要介绍一下Jsqlparser在我的项目中的应用情况。
背景：通过SQL语句的解析，从而增强SQL语句增加特定的查询过滤条件（如：状态过滤、权限过滤等）
1）解析SQL
2）根据SQL中涉及的表增强SQL
3）重新生成ORACLE数据库的SQL
Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>CCJSqlParserManager parserManager = new CCJSqlParserManager();  </li>
<li>try {  </li>
<li>Select select = (Select) parserManager.parse(new StringReader(sql)); //解析SQL语句  </li>
<li>SelectBody body = select.getSelectBody();   </li>
<li>VisitContext vc = new VisitContext(filterContext, params);  </li>
<li>vc.setTableFilterFactory(tableFilterFactory);//表的字段过滤  </li>
<li>body.accept(new SelectVisitorImpl(vc)); //访问SQL并根据SQL中涉及的表来增强SQL  </li>
<li>ExpressionDeParser expressionDeParser = new ExpressionDeParser();  </li>
<li>StringBuffer stringBuffer = new StringBuffer();  </li>
<li>SelectDeParser deParser = new OracleSelectDeParser(expressionDeParser, stringBuffer); //针对ORACLE的SQL生成  </li>
<li>expressionDeParser.setSelectVisitor(deParser);  </li>
<li>expressionDeParser.setBuffer(stringBuffer);  </li>
<li></li>
<li>body.accept(deParser);  </li>
<li>return new FilterResult(deParser.getBuffer().toString(), vc.getResultSqlParams());  </li>
<li>} catch (JSQLParserException e) {  </li>
<li>throw new FilterException(e);  </li>
<li><p>}  </p>
<pre><code> CCJSqlParserManager parserManager = new CCJSqlParserManager();

 try {
     Select select = (Select) parserManager.parse(new StringReader(sql)); //解析SQL语句

     SelectBody body = select.getSelectBody();
     VisitContext vc = new VisitContext(filterContext, params);

     vc.setTableFilterFactory(tableFilterFactory);//表的字段过滤
     body.accept(new SelectVisitorImpl(vc)); //访问SQL并根据SQL中涉及的表来增强SQL

     ExpressionDeParser expressionDeParser = new ExpressionDeParser();
     StringBuffer stringBuffer = new StringBuffer();

     SelectDeParser deParser = new OracleSelectDeParser(expressionDeParser, stringBuffer); //针对ORACLE的SQL生成
     expressionDeParser.setSelectVisitor(deParser);

     expressionDeParser.setBuffer(stringBuffer);
</code></pre></li>
</ol>
<pre><code>        body.accept(deParser);
        return new FilterResult(deParser.getBuffer().toString(), vc.getResultSqlParams());

    } catch (JSQLParserException e) {
        throw new FilterException(e);

    }
</code></pre><p>接下去是各个VISITOR，用来访问解析后的SQL
Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>public class SelectVisitorImpl extends AbstractVisitor implements SelectVisitor {  </li>
<li></li>
<li>public SelectVisitorImpl(VisitContext ctx) {  </li>
<li>super(ctx);  </li>
<li>}  </li>
<li></li>
<li>@SuppressWarnings(&quot;unchecked&quot;)  </li>
<li>public void visit(PlainSelect ps) {  </li>
<li>//SELECT ITEM访问  </li>
<li>List<SelectItem> selectItems = ps.getSelectItems();  </li>
<li>for (SelectItem item : selectItems) {  </li>
<li>item.accept(new SelectItemVisitorImpl(this.getContext()));  </li>
<li>}  </li>
<li></li>
<li>//FROM访问  </li>
<li>FromItem from = ps.getFromItem();  </li>
<li>FromItemVisitorImpl fv = new FromItemVisitorImpl(context);  </li>
<li>from.accept(fv);  </li>
<li></li>
<li>//查询条件访问  </li>
<li>if (ps.getWhere() != null) {  </li>
<li>ps.getWhere().accept(new ExpressionVisitorImpl(this.getContext()));  </li>
<li>}  </li>
<li></li>
<li>//过滤增强的条件  </li>
<li>if (fv.getEnhancedCondition() != null) {  </li>
<li>if (ps.getWhere() != null) {  </li>
<li>Expression expr = new Parenthesis(ps.getWhere());  </li>
<li>AndExpression and = new AndExpression(fv.getEnhancedCondition(), expr);  </li>
<li>ps.setWhere(and);  </li>
<li>} else {  </li>
<li>ps.setWhere(fv.getEnhancedCondition());  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>//JOIN表的访问  </li>
<li>List<Join> joins = ps.getJoins();  </li>
<li>if (CollectionUtil.isNotEmpty(joins)) {  </li>
<li>for (Join join : joins) {  </li>
<li>FromItemVisitorImpl tempfv = new FromItemVisitorImpl(context);  </li>
<li>join.getRightItem().accept(tempfv);  </li>
<li>if (join.getOnExpression() != null) {  </li>
<li>join.getOnExpression().accept(new ExpressionVisitorImpl(this.getContext()));  </li>
<li>if (tempfv.getEnhancedCondition() != null) {  </li>
<li>Expression expr = new Parenthesis(join.getOnExpression());  </li>
<li>AndExpression and = new AndExpression(tempfv.getEnhancedCondition(), expr);  </li>
<li>join.setOnExpression(and);  </li>
<li>}  </li>
<li>}  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>//ORDER BY 访问  </li>
<li>List<OrderByElement> elements = ps.getOrderByElements();  </li>
<li>if (CollectionUtil.isNotEmpty(elements)) {  </li>
<li>for (OrderByElement e : elements) {  </li>
<li>e.getExpression().accept(new ExpressionVisitorImpl(this.getContext()));  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>//GROUP BY的HAVING访问  </li>
<li>if (ps.getHaving() != null) {  </li>
<li>ps.getHaving().accept(new ExpressionVisitorImpl(this.getContext()));  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>@SuppressWarnings(&quot;unchecked&quot;)  </li>
<li>public void visit(Union un) {  </li>
<li>List<PlainSelect> selects = un.getPlainSelects();  </li>
<li>for (PlainSelect select : selects) {  </li>
<li>select.accept(new SelectVisitorImpl(this.getContext()));  </li>
<li>}  </li>
<li>List<OrderByElement> elements = un.getOrderByElements();  </li>
<li>if (CollectionUtil.isNotEmpty(elements)) {  </li>
<li>for (OrderByElement e : elements) {  </li>
<li>e.getExpression().accept(new ExpressionVisitorImpl(this.getContext()));  </li>
<li>}  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>}  </li>
</ol>
<p>public class SelectVisitorImpl extends AbstractVisitor implements SelectVisitor {</p>
<pre><code>public SelectVisitorImpl(VisitContext ctx) {

    super(ctx);
}


@SuppressWarnings(&quot;unchecked&quot;)

public void visit(PlainSelect ps) {
    //SELECT ITEM访问

    List&lt;SelectItem&gt; selectItems = ps.getSelectItems();
    for (SelectItem item : selectItems) {

        item.accept(new SelectItemVisitorImpl(this.getContext()));
    }


    //FROM访问

    FromItem from = ps.getFromItem();
    FromItemVisitorImpl fv = new FromItemVisitorImpl(context);

    from.accept(fv);


    //查询条件访问
    if (ps.getWhere() != null) {

        ps.getWhere().accept(new ExpressionVisitorImpl(this.getContext()));
    }


    //过滤增强的条件

    if (fv.getEnhancedCondition() != null) {
        if (ps.getWhere() != null) {

            Expression expr = new Parenthesis(ps.getWhere());
            AndExpression and = new AndExpression(fv.getEnhancedCondition(), expr);

            ps.setWhere(and);
        } else {

            ps.setWhere(fv.getEnhancedCondition());
        }

    }


    //JOIN表的访问
    List&lt;Join&gt; joins = ps.getJoins();

    if (CollectionUtil.isNotEmpty(joins)) {
        for (Join join : joins) {

            FromItemVisitorImpl tempfv = new FromItemVisitorImpl(context);
            join.getRightItem().accept(tempfv);

            if (join.getOnExpression() != null) {
                join.getOnExpression().accept(new ExpressionVisitorImpl(this.getContext()));

                if (tempfv.getEnhancedCondition() != null) {
                    Expression expr = new Parenthesis(join.getOnExpression());

                    AndExpression and = new AndExpression(tempfv.getEnhancedCondition(), expr);
                    join.setOnExpression(and);

                }
            }

        }
    }


    //ORDER BY 访问

    List&lt;OrderByElement&gt; elements = ps.getOrderByElements();
    if (CollectionUtil.isNotEmpty(elements)) {

        for (OrderByElement e : elements) {
            e.getExpression().accept(new ExpressionVisitorImpl(this.getContext()));

        }
    }


    //GROUP BY的HAVING访问

    if (ps.getHaving() != null) {
        ps.getHaving().accept(new ExpressionVisitorImpl(this.getContext()));

    }
}


@SuppressWarnings(&quot;unchecked&quot;)

public void visit(Union un) {
    List&lt;PlainSelect&gt; selects = un.getPlainSelects();

    for (PlainSelect select : selects) {
        select.accept(new SelectVisitorImpl(this.getContext()));

    }
    List&lt;OrderByElement&gt; elements = un.getOrderByElements();

    if (CollectionUtil.isNotEmpty(elements)) {
        for (OrderByElement e : elements) {

            e.getExpression().accept(new ExpressionVisitorImpl(this.getContext()));
        }

    }
}
</code></pre><p>}
Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>public class SelectItemVisitorImpl extends AbstractVisitor implements SelectItemVisitor {  </li>
<li></li>
<li>public SelectItemVisitorImpl(VisitContext ctx) {  </li>
<li>super(ctx);  </li>
<li>}  </li>
<li></li>
<li>public void visit(AllColumns ac) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(AllTableColumns atc) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(SelectExpressionItem sei) {  </li>
<li>sei.getExpression().accept(new ExpressionVisitorImpl(this.getContext()));  </li>
<li>}  </li>
<li></li>
<li>}  </li>
</ol>
<p>public class SelectItemVisitorImpl extends AbstractVisitor implements SelectItemVisitor {</p>
<pre><code>public SelectItemVisitorImpl(VisitContext ctx) {

    super(ctx);
}


public void visit(AllColumns ac) {

}


public void visit(AllTableColumns atc) {
}


public void visit(SelectExpressionItem sei) {

    sei.getExpression().accept(new ExpressionVisitorImpl(this.getContext()));
}
</code></pre><p>}
Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>public class ItemsListVisitorImpl extends AbstractVisitor implements ItemsListVisitor {  </li>
<li></li>
<li>public ItemsListVisitorImpl(VisitContext ctx) {  </li>
<li>super(ctx);  </li>
<li>}  </li>
<li></li>
<li>public void visit(SubSelect ss) {  </li>
<li>ss.getSelectBody().accept(new SelectVisitorImpl(context));  </li>
<li>}  </li>
<li></li>
<li>@SuppressWarnings(&quot;unchecked&quot;)  </li>
<li>public void visit(ExpressionList el) {  </li>
<li>List<Expression> list = el.getExpressions();  </li>
<li>if (CollectionUtil.isNotEmpty(list)) {  </li>
<li>for (Expression expr : list) {  </li>
<li>expr.accept(new ExpressionVisitorImpl(context));  </li>
<li>}  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>}  </li>
</ol>
<p>public class ItemsListVisitorImpl extends AbstractVisitor implements ItemsListVisitor {</p>
<pre><code>public ItemsListVisitorImpl(VisitContext ctx) {

    super(ctx);
}


public void visit(SubSelect ss) {

    ss.getSelectBody().accept(new SelectVisitorImpl(context));
}


@SuppressWarnings(&quot;unchecked&quot;)

public void visit(ExpressionList el) {
    List&lt;Expression&gt; list = el.getExpressions();

    if (CollectionUtil.isNotEmpty(list)) {
        for (Expression expr : list) {

            expr.accept(new ExpressionVisitorImpl(context));
        }

    }
}
</code></pre><p>}
如果FROM的内容是table的话，则根据table的增强配置对SQL增强
Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>public class FromItemVisitorImpl extends AbstractVisitor implements FromItemVisitor {  </li>
<li>private String varPattern = &quot;@\{\s/<em>?(\w+)\s/</em>?\}&quot;;  </li>
<li>private Expression enhancedCondition;  </li>
<li></li>
<li>public FromItemVisitorImpl(VisitContext ctx) {  </li>
<li>super(ctx);  </li>
<li>}  </li>
<li></li>
<li>public void visit(Table table) {  </li>
<li>Set<FieldFilter> filters = context.getTableFilterFactory().getTableFilter(table.getName());  </li>
<li>if (filters == null) {  </li>
<li>filters = Collections.emptySet();  </li>
<li>}  </li>
<li>for (FieldFilter ff : filters) {  </li>
<li>Column c = new Column(new Table(null, table.getAlias()), ff.getFieldName());  </li>
<li>JdbcParameter param = new JdbcParameter();  </li>
<li>Object fieldValue = getRawValue(ff.getFieldValue(), this.context.getFilterContext());  </li>
<li>Expression[] exps;  </li>
<li>if (&quot;between&quot;.equalsIgnoreCase(ff.getOperator()) || &quot;not between&quot;.equalsIgnoreCase(ff.getOperator())) {  </li>
<li>Object[] objs = (Object[]) fieldValue;  </li>
<li>this.getContext().getResultSqlParams().add(objs[0]);  </li>
<li>this.getContext().getResultSqlParams().add(objs[1]);  </li>
<li>exps = new Expression[] { c, param, param };  </li>
<li>} else if (&quot;is null&quot;.equalsIgnoreCase(ff.getOperator()) || &quot;is not null&quot;.equalsIgnoreCase(ff.getOperator())) {  </li>
<li>exps = new Expression[] { c };  </li>
<li>} else {  </li>
<li>this.getContext().getResultSqlParams().add(fieldValue);  </li>
<li>exps = new Expression[] { c, param };  </li>
<li>}  </li>
<li>Expression operator = this.getOperator(ff.getOperator(), exps);  </li>
<li>if (this.enhancedCondition != null) {  </li>
<li>enhancedCondition = new AndExpression(enhancedCondition, operator);  </li>
<li>} else {  </li>
<li>enhancedCondition = operator;  </li>
<li>}  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>public void visit(SubSelect ss) {  </li>
<li>ss.getSelectBody().accept(new SelectVisitorImpl(this.getContext()));  </li>
<li>}  </li>
<li></li>
<li>public void visit(SubJoin sj) {  </li>
<li>Join join = sj.getJoin();  </li>
<li>join.getRightItem().accept(new FromItemVisitorImpl(this.getContext()));  </li>
<li>join.getOnExpression().accept(new ExpressionVisitorImpl(this.getContext()));  </li>
<li>}  </li>
<li></li>
<li>private Expression getOperator(String op, Expression[] exp) {  </li>
<li>if (&quot;=&quot;.equals(op)) {  </li>
<li>EqualsTo eq = new EqualsTo();  </li>
<li>eq.setLeftExpression(exp[0]);  </li>
<li>eq.setRightExpression(exp[1]);  </li>
<li>return eq;  </li>
<li>} else if (&quot;&gt;&quot;.equals(op)) {  </li>
<li>GreaterThan gt = new GreaterThan();  </li>
<li>gt.setLeftExpression(exp[0]);  </li>
<li>gt.setRightExpression(exp[1]);  </li>
<li>return gt;  </li>
<li>} else if (&quot;&gt;=&quot;.equals(op)) {  </li>
<li>GreaterThanEquals geq = new GreaterThanEquals();  </li>
<li>geq.setLeftExpression(exp[0]);  </li>
<li>geq.setRightExpression(exp[1]);  </li>
<li>return geq;  </li>
<li>} else if (&quot;&lt;&quot;.equals(op)) {  </li>
<li>MinorThan mt = new MinorThan();  </li>
<li>mt.setLeftExpression(exp[0]);  </li>
<li>mt.setRightExpression(exp[1]);  </li>
<li>return mt;  </li>
<li>} else if (&quot;&lt;=&quot;.equals(op)) {  </li>
<li>MinorThanEquals leq = new MinorThanEquals();  </li>
<li>leq.setLeftExpression(exp[0]);  </li>
<li>leq.setRightExpression(exp[1]);  </li>
<li>return leq;  </li>
<li>} else if (&quot;&lt;&gt;&quot;.equals(op)) {  </li>
<li>NotEqualsTo neq = new NotEqualsTo();  </li>
<li>neq.setLeftExpression(exp[0]);  </li>
<li>neq.setRightExpression(exp[1]);  </li>
<li>return neq;  </li>
<li>} else if (&quot;is null&quot;.equalsIgnoreCase(op)) {  </li>
<li>IsNullExpression isNull = new IsNullExpression();  </li>
<li>isNull.setNot(false);  </li>
<li>isNull.setLeftExpression(exp[0]);  </li>
<li>return isNull;  </li>
<li>} else if (&quot;is not null&quot;.equalsIgnoreCase(op)) {  </li>
<li>IsNullExpression isNull = new IsNullExpression();  </li>
<li>isNull.setNot(true);  </li>
<li>isNull.setLeftExpression(exp[0]);  </li>
<li>return isNull;  </li>
<li>} else if (&quot;like&quot;.equalsIgnoreCase(op)) {  </li>
<li>LikeExpression like = new LikeExpression();  </li>
<li>like.setNot(false);  </li>
<li>like.setLeftExpression(exp[0]);  </li>
<li>like.setRightExpression(exp[1]);  </li>
<li>return like;  </li>
<li>} else if (&quot;not like&quot;.equalsIgnoreCase(op)) {  </li>
<li>LikeExpression nlike = new LikeExpression();  </li>
<li>nlike.setNot(true);  </li>
<li>nlike.setLeftExpression(exp[0]);  </li>
<li>nlike.setRightExpression(exp[1]);  </li>
<li>return nlike;  </li>
<li>} else if (&quot;between&quot;.equalsIgnoreCase(op)) {  </li>
<li>Between bt = new Between();  </li>
<li>bt.setNot(false);  </li>
<li>bt.setLeftExpression(exp[0]);  </li>
<li>bt.setBetweenExpressionStart(exp[1]);  </li>
<li>bt.setBetweenExpressionEnd(exp[2]);  </li>
<li>return bt;  </li>
<li>} else if (&quot;not between&quot;.equalsIgnoreCase(op)) {  </li>
<li>Between bt = new Between();  </li>
<li>bt.setNot(true);  </li>
<li>bt.setLeftExpression(exp[0]);  </li>
<li>bt.setBetweenExpressionStart(exp[1]);  </li>
<li>bt.setBetweenExpressionEnd(exp[2]);  </li>
<li>return bt;  </li>
<li>}  </li>
<li>throw new FilterException(&quot;Unknown operator:&quot; + op);  </li>
<li>}  </li>
<li></li>
<li>protected Object getRawValue(Object value, Map<String, Object> context) {  </li>
<li>if (context == null) {  </li>
<li>return value;  </li>
<li>}  </li>
<li>if (value instanceof String) {  </li>
<li>String v = (String) value;  </li>
<li>Pattern pattern = Pattern.compile(varPattern);  </li>
<li>Matcher matcher = pattern.matcher(v);  </li>
<li>if (matcher.find()) {  </li>
<li>return context.get(matcher.group(1));  </li>
<li>}  </li>
<li>}  </li>
<li>return value;  </li>
<li>}  </li>
<li></li>
<li>public Expression getEnhancedCondition() {  </li>
<li>return enhancedCondition;  </li>
<li>}  </li>
<li></li>
<li>}  </li>
</ol>
<p>public class FromItemVisitorImpl extends AbstractVisitor implements FromItemVisitor {</p>
<pre><code>private String varPattern = &quot;@\\{\\s/*?(\\w+)\\s/*?\\}&quot;;
private Expression enhancedCondition;


public FromItemVisitorImpl(VisitContext ctx) {

    super(ctx);
}


public void visit(Table table) {

    Set&lt;FieldFilter&gt; filters = context.getTableFilterFactory().getTableFilter(table.getName());
    if (filters == null) {

        filters = Collections.emptySet();
    }

    for (FieldFilter ff : filters) {
        Column c = new Column(new Table(null, table.getAlias()), ff.getFieldName());

        JdbcParameter param = new JdbcParameter();
        Object fieldValue = getRawValue(ff.getFieldValue(), this.context.getFilterContext());

        Expression[] exps;
        if (&quot;between&quot;.equalsIgnoreCase(ff.getOperator()) || &quot;not between&quot;.equalsIgnoreCase(ff.getOperator())) {

            Object[] objs = (Object[]) fieldValue;
            this.getContext().getResultSqlParams().add(objs[0]);

            this.getContext().getResultSqlParams().add(objs[1]);
            exps = new Expression[] { c, param, param };

        } else if (&quot;is null&quot;.equalsIgnoreCase(ff.getOperator()) || &quot;is not null&quot;.equalsIgnoreCase(ff.getOperator())) {
            exps = new Expression[] { c };

        } else {
            this.getContext().getResultSqlParams().add(fieldValue);

            exps = new Expression[] { c, param };
        }

        Expression operator = this.getOperator(ff.getOperator(), exps);
        if (this.enhancedCondition != null) {

            enhancedCondition = new AndExpression(enhancedCondition, operator);
        } else {

            enhancedCondition = operator;
        }

    }
}


public void visit(SubSelect ss) {

    ss.getSelectBody().accept(new SelectVisitorImpl(this.getContext()));
}


public void visit(SubJoin sj) {

    Join join = sj.getJoin();
    join.getRightItem().accept(new FromItemVisitorImpl(this.getContext()));

    join.getOnExpression().accept(new ExpressionVisitorImpl(this.getContext()));
}


private Expression getOperator(String op, Expression[] exp) {

    if (&quot;=&quot;.equals(op)) {
        EqualsTo eq = new EqualsTo();

        eq.setLeftExpression(exp[0]);
        eq.setRightExpression(exp[1]);

        return eq;
    } else if (&quot;&gt;&quot;.equals(op)) {

        GreaterThan gt = new GreaterThan();
        gt.setLeftExpression(exp[0]);

        gt.setRightExpression(exp[1]);
        return gt;

    } else if (&quot;&gt;=&quot;.equals(op)) {
        GreaterThanEquals geq = new GreaterThanEquals();

        geq.setLeftExpression(exp[0]);
        geq.setRightExpression(exp[1]);

        return geq;
    } else if (&quot;&lt;&quot;.equals(op)) {

        MinorThan mt = new MinorThan();
        mt.setLeftExpression(exp[0]);

        mt.setRightExpression(exp[1]);
        return mt;

    } else if (&quot;&lt;=&quot;.equals(op)) {
        MinorThanEquals leq = new MinorThanEquals();

        leq.setLeftExpression(exp[0]);
        leq.setRightExpression(exp[1]);

        return leq;
    } else if (&quot;&lt;&gt;&quot;.equals(op)) {

        NotEqualsTo neq = new NotEqualsTo();
        neq.setLeftExpression(exp[0]);

        neq.setRightExpression(exp[1]);
        return neq;

    } else if (&quot;is null&quot;.equalsIgnoreCase(op)) {
        IsNullExpression isNull = new IsNullExpression();

        isNull.setNot(false);
        isNull.setLeftExpression(exp[0]);

        return isNull;
    } else if (&quot;is not null&quot;.equalsIgnoreCase(op)) {

        IsNullExpression isNull = new IsNullExpression();
        isNull.setNot(true);

        isNull.setLeftExpression(exp[0]);
        return isNull;

    } else if (&quot;like&quot;.equalsIgnoreCase(op)) {
        LikeExpression like = new LikeExpression();

        like.setNot(false);
        like.setLeftExpression(exp[0]);

        like.setRightExpression(exp[1]);
        return like;

    } else if (&quot;not like&quot;.equalsIgnoreCase(op)) {
        LikeExpression nlike = new LikeExpression();

        nlike.setNot(true);
        nlike.setLeftExpression(exp[0]);

        nlike.setRightExpression(exp[1]);
        return nlike;

    } else if (&quot;between&quot;.equalsIgnoreCase(op)) {
        Between bt = new Between();

        bt.setNot(false);
        bt.setLeftExpression(exp[0]);

        bt.setBetweenExpressionStart(exp[1]);
        bt.setBetweenExpressionEnd(exp[2]);

        return bt;
    } else if (&quot;not between&quot;.equalsIgnoreCase(op)) {

        Between bt = new Between();
        bt.setNot(true);

        bt.setLeftExpression(exp[0]);
        bt.setBetweenExpressionStart(exp[1]);

        bt.setBetweenExpressionEnd(exp[2]);
        return bt;

    }
    throw new FilterException(&quot;Unknown operator:&quot; + op);

}


protected Object getRawValue(Object value, Map&lt;String, Object&gt; context) {
    if (context == null) {

        return value;
    }

    if (value instanceof String) {
        String v = (String) value;

        Pattern pattern = Pattern.compile(varPattern);
        Matcher matcher = pattern.matcher(v);

        if (matcher.find()) {
            return context.get(matcher.group(1));

        }
    }

    return value;
}


public Expression getEnhancedCondition() {

    return enhancedCondition;
}
</code></pre><p>}
1）对JDBC parameter做了处理，如果参数为NULL则自动忽略该parameter，忽略后需要处理and or between 等情况
   如：where name=? and age=? ，假如name对应的参数为null，则条件改为where 1=1 and age=?，如果是or的话则改为 where 1=0 or age=?
Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>public class ExpressionVisitorImpl extends AbstractVisitor implements ExpressionVisitor {  </li>
<li></li>
<li>public ExpressionVisitorImpl(VisitContext ctx) {  </li>
<li>super(ctx);  </li>
<li>}  </li>
<li></li>
<li>public void visit(NullValue nv) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(Function f) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(InverseExpression ie) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(JdbcParameter jp) {  </li>
<li>this.getContext().getResultSqlParams().add(context.removeFirstParam());  </li>
<li>}  </li>
<li></li>
<li>public void visit(DoubleValue dv) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(LongValue lv) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(DateValue dv) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(TimeValue tv) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(TimestampValue tv) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(Parenthesis parenthesis) {  </li>
<li>ExpressionVisitorImpl ev = new ExpressionVisitorImpl(context);  </li>
<li>parenthesis.getExpression().accept(ev);  </li>
<li>if (ev.isNotValid()) {  </li>
<li>parenthesis.setExpression(this.createTrueEquals());  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>public void visit(StringValue s) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(Addition a) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(Division d) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(Multiplication m) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(Subtraction s) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(AndExpression and) {  </li>
<li>ExpressionVisitorImpl left = new ExpressionVisitorImpl(this.getContext());  </li>
<li>and.getLeftExpression().accept(left);  </li>
<li>if (left.isNotValid()) {  </li>
<li>and.setLeftExpression(this.createTrueEquals());  </li>
<li>}  </li>
<li>ExpressionVisitorImpl right = new ExpressionVisitorImpl(this.getContext());  </li>
<li>and.getRightExpression().accept(right);  </li>
<li>if (right.isNotValid()) {  </li>
<li>and.setRightExpression(this.createTrueEquals());  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>public void visit(OrExpression or) {  </li>
<li>ExpressionVisitorImpl left = new ExpressionVisitorImpl(this.getContext());  </li>
<li>or.getLeftExpression().accept(left);  </li>
<li>if (left.isNotValid()) {  </li>
<li>or.setLeftExpression(this.createFalseEquals());  </li>
<li>}  </li>
<li>ExpressionVisitorImpl right = new ExpressionVisitorImpl(this.getContext());  </li>
<li>or.getRightExpression().accept(right);  </li>
<li>if (right.isNotValid()) {  </li>
<li>or.setRightExpression(this.createFalseEquals());  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>public void visit(Between btw) {  </li>
<li>Expression start = btw.getBetweenExpressionStart();  </li>
<li>Expression end = btw.getBetweenExpressionEnd();  </li>
<li>if (start instanceof JdbcParameter &amp;&amp; end instanceof JdbcParameter) {  </li>
<li>Object o1 = this.context.getFirstParam();  </li>
<li>Object o2 = this.context.getParam(1);  </li>
<li>if (o1 == null || o2 == null) {  </li>
<li>this.context.removeFirstParam();  </li>
<li>this.context.removeFirstParam();  </li>
<li>this.setValid(false);  </li>
<li>return;  </li>
<li>}  </li>
<li>} else if (start instanceof JdbcParameter || end instanceof JdbcParameter) {  </li>
<li>Object o1 = this.context.getFirstParam();  </li>
<li>if (o1 == null) {  </li>
<li>this.context.removeFirstParam();  </li>
<li>this.setValid(false);  </li>
<li>return;  </li>
<li>}  </li>
<li>}  </li>
<li>btw.getLeftExpression().accept(new ExpressionVisitorImpl(context));  </li>
<li>btw.getBetweenExpressionStart().accept(new ExpressionVisitorImpl(context));  </li>
<li>btw.getBetweenExpressionEnd().accept(new ExpressionVisitorImpl(context));  </li>
<li>}  </li>
<li></li>
<li>public void visit(EqualsTo eq) {  </li>
<li>if (eq.getRightExpression() instanceof JdbcParameter) {  </li>
<li>Object o = this.context.getFirstParam();  </li>
<li>if (o == null) {  </li>
<li>this.setValid(false);  </li>
<li>this.getContext().removeFirstParam();  </li>
<li>return;  </li>
<li>}  </li>
<li>}  </li>
<li>eq.getLeftExpression().accept(new ExpressionVisitorImpl(this.getContext()));  </li>
<li>eq.getRightExpression().accept(new ExpressionVisitorImpl(this.getContext()));  </li>
<li>}  </li>
<li></li>
<li>public void visit(GreaterThan gt) {  </li>
<li>if (gt.getRightExpression() instanceof JdbcParameter) {  </li>
<li>Object o = this.context.getFirstParam();  </li>
<li>if (o == null) {  </li>
<li>this.setValid(false);  </li>
<li>this.getContext().removeFirstParam();  </li>
<li>}  </li>
<li>}  </li>
<li>gt.getLeftExpression().accept(new ExpressionVisitorImpl(this.getContext()));  </li>
<li>gt.getRightExpression().accept(new ExpressionVisitorImpl(this.getContext()));  </li>
<li>}  </li>
<li></li>
<li>public void visit(GreaterThanEquals gte) {  </li>
<li>if (gte.getRightExpression() instanceof JdbcParameter) {  </li>
<li>Object o = this.context.getFirstParam();  </li>
<li>if (o == null) {  </li>
<li>this.setValid(false);  </li>
<li>this.getContext().removeFirstParam();  </li>
<li>}  </li>
<li>}  </li>
<li>gte.getLeftExpression().accept(new ExpressionVisitorImpl(this.getContext()));  </li>
<li>gte.getRightExpression().accept(new ExpressionVisitorImpl(this.getContext()));  </li>
<li>}  </li>
<li></li>
<li>public void visit(InExpression in) {  </li>
<li>ItemsList list = in.getItemsList();  </li>
<li>list.accept(new ItemsListVisitorImpl(context));  </li>
<li>}  </li>
<li></li>
<li>public void visit(IsNullExpression ine) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(LikeExpression le) {  </li>
<li>if (le.getRightExpression() instanceof JdbcParameter) {  </li>
<li>Object o = this.context.getFirstParam();  </li>
<li>if (o == null) {  </li>
<li>this.setValid(false);  </li>
<li>this.getContext().removeFirstParam();  </li>
<li>}  </li>
<li>}  </li>
<li>le.getLeftExpression().accept(new ExpressionVisitorImpl(this.getContext()));  </li>
<li>le.getRightExpression().accept(new ExpressionVisitorImpl(this.getContext()));  </li>
<li>}  </li>
<li></li>
<li>public void visit(MinorThan mt) {  </li>
<li>if (mt.getRightExpression() instanceof JdbcParameter) {  </li>
<li>Object o = this.context.getFirstParam();  </li>
<li>if (o == null) {  </li>
<li>this.setValid(false);  </li>
<li>this.getContext().removeFirstParam();  </li>
<li>}  </li>
<li>}  </li>
<li>mt.getLeftExpression().accept(new ExpressionVisitorImpl(this.getContext()));  </li>
<li>mt.getRightExpression().accept(new ExpressionVisitorImpl(this.getContext()));  </li>
<li>}  </li>
<li></li>
<li>public void visit(MinorThanEquals mte) {  </li>
<li>if (mte.getRightExpression() instanceof JdbcParameter) {  </li>
<li>Object o = this.context.getFirstParam();  </li>
<li>if (o == null) {  </li>
<li>this.setValid(false);  </li>
<li>this.getContext().removeFirstParam();  </li>
<li>}  </li>
<li>}  </li>
<li>mte.getLeftExpression().accept(new ExpressionVisitorImpl(this.getContext()));  </li>
<li>mte.getRightExpression().accept(new ExpressionVisitorImpl(this.getContext()));  </li>
<li>}  </li>
<li></li>
<li>public void visit(NotEqualsTo neq) {  </li>
<li>if (neq.getRightExpression() instanceof JdbcParameter) {  </li>
<li>Object o = this.context.getFirstParam();  </li>
<li>if (o == null) {  </li>
<li>this.setValid(false);  </li>
<li>this.getContext().removeFirstParam();  </li>
<li>return;  </li>
<li>}  </li>
<li>}  </li>
<li>neq.getLeftExpression().accept(new ExpressionVisitorImpl(this.getContext()));  </li>
<li>neq.getRightExpression().accept(new ExpressionVisitorImpl(this.getContext()));  </li>
<li>}  </li>
<li></li>
<li>public void visit(Column c) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(SubSelect ss) {  </li>
<li>ss.getSelectBody().accept(new SelectVisitorImpl(context));  </li>
<li>}  </li>
<li></li>
<li>public void visit(CaseExpression ce) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(WhenClause wc) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(ExistsExpression ee) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(AllComparisonExpression ace) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(AnyComparisonExpression ace) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(Concat c) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(Matches m) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(BitwiseAnd ba) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(BitwiseOr bo) {  </li>
<li>}  </li>
<li></li>
<li>public void visit(BitwiseXor bx) {  </li>
<li>}  </li>
<li></li>
<li>private EqualsTo createTrueEquals() {  </li>
<li>EqualsTo eq = new EqualsTo();  </li>
<li>eq.setLeftExpression(new LongValue(&quot;1&quot;));  </li>
<li>eq.setRightExpression(new LongValue(&quot;1&quot;));  </li>
<li>return eq;  </li>
<li>}  </li>
<li></li>
<li>private EqualsTo createFalseEquals() {  </li>
<li>EqualsTo eq = new EqualsTo();  </li>
<li>eq.setLeftExpression(new LongValue(&quot;1&quot;));  </li>
<li>eq.setRightExpression(new LongValue(&quot;0&quot;));  </li>
<li>return eq;  </li>
<li>}  </li>
<li></li>
<li>}  </li>
</ol>
<p>public class ExpressionVisitorImpl extends AbstractVisitor implements ExpressionVisitor {</p>
<pre><code>public ExpressionVisitorImpl(VisitContext ctx) {

    super(ctx);
}


public void visit(NullValue nv) {

}


public void visit(Function f) {
}


public void visit(InverseExpression ie) {

}


public void visit(JdbcParameter jp) {
    this.getContext().getResultSqlParams().add(context.removeFirstParam());

}


public void visit(DoubleValue dv) {
}


public void visit(LongValue lv) {

}


public void visit(DateValue dv) {
}


public void visit(TimeValue tv) {

}


public void visit(TimestampValue tv) {
}


public void visit(Parenthesis parenthesis) {

    ExpressionVisitorImpl ev = new ExpressionVisitorImpl(context);
    parenthesis.getExpression().accept(ev);

    if (ev.isNotValid()) {
        parenthesis.setExpression(this.createTrueEquals());

    }
}


public void visit(StringValue s) {

}


public void visit(Addition a) {
}


public void visit(Division d) {

}


public void visit(Multiplication m) {
}


public void visit(Subtraction s) {

}


public void visit(AndExpression and) {
    ExpressionVisitorImpl left = new ExpressionVisitorImpl(this.getContext());

    and.getLeftExpression().accept(left);
    if (left.isNotValid()) {

        and.setLeftExpression(this.createTrueEquals());
    }

    ExpressionVisitorImpl right = new ExpressionVisitorImpl(this.getContext());
    and.getRightExpression().accept(right);

    if (right.isNotValid()) {
        and.setRightExpression(this.createTrueEquals());

    }
}


public void visit(OrExpression or) {

    ExpressionVisitorImpl left = new ExpressionVisitorImpl(this.getContext());
    or.getLeftExpression().accept(left);

    if (left.isNotValid()) {
        or.setLeftExpression(this.createFalseEquals());

    }
    ExpressionVisitorImpl right = new ExpressionVisitorImpl(this.getContext());

    or.getRightExpression().accept(right);
    if (right.isNotValid()) {

        or.setRightExpression(this.createFalseEquals());
    }

}


public void visit(Between btw) {
    Expression start = btw.getBetweenExpressionStart();

    Expression end = btw.getBetweenExpressionEnd();
    if (start instanceof JdbcParameter &amp;&amp; end instanceof JdbcParameter) {

        Object o1 = this.context.getFirstParam();
        Object o2 = this.context.getParam(1);

        if (o1 == null || o2 == null) {
            this.context.removeFirstParam();

            this.context.removeFirstParam();
            this.setValid(false);

            return;
        }

    } else if (start instanceof JdbcParameter || end instanceof JdbcParameter) {
        Object o1 = this.context.getFirstParam();

        if (o1 == null) {
            this.context.removeFirstParam();

            this.setValid(false);
            return;

        }
    }

    btw.getLeftExpression().accept(new ExpressionVisitorImpl(context));
    btw.getBetweenExpressionStart().accept(new ExpressionVisitorImpl(context));

    btw.getBetweenExpressionEnd().accept(new ExpressionVisitorImpl(context));
}


public void visit(EqualsTo eq) {

    if (eq.getRightExpression() instanceof JdbcParameter) {
        Object o = this.context.getFirstParam();

        if (o == null) {
            this.setValid(false);

            this.getContext().removeFirstParam();
            return;

        }
    }

    eq.getLeftExpression().accept(new ExpressionVisitorImpl(this.getContext()));
    eq.getRightExpression().accept(new ExpressionVisitorImpl(this.getContext()));

}


public void visit(GreaterThan gt) {
    if (gt.getRightExpression() instanceof JdbcParameter) {

        Object o = this.context.getFirstParam();
        if (o == null) {

            this.setValid(false);
            this.getContext().removeFirstParam();

        }
    }

    gt.getLeftExpression().accept(new ExpressionVisitorImpl(this.getContext()));
    gt.getRightExpression().accept(new ExpressionVisitorImpl(this.getContext()));

}


public void visit(GreaterThanEquals gte) {
    if (gte.getRightExpression() instanceof JdbcParameter) {

        Object o = this.context.getFirstParam();
        if (o == null) {

            this.setValid(false);
            this.getContext().removeFirstParam();

        }
    }

    gte.getLeftExpression().accept(new ExpressionVisitorImpl(this.getContext()));
    gte.getRightExpression().accept(new ExpressionVisitorImpl(this.getContext()));

}


public void visit(InExpression in) {
    ItemsList list = in.getItemsList();

    list.accept(new ItemsListVisitorImpl(context));
}


public void visit(IsNullExpression ine) {

}


public void visit(LikeExpression le) {
    if (le.getRightExpression() instanceof JdbcParameter) {

        Object o = this.context.getFirstParam();
        if (o == null) {

            this.setValid(false);
            this.getContext().removeFirstParam();

        }
    }

    le.getLeftExpression().accept(new ExpressionVisitorImpl(this.getContext()));
    le.getRightExpression().accept(new ExpressionVisitorImpl(this.getContext()));

}


public void visit(MinorThan mt) {
    if (mt.getRightExpression() instanceof JdbcParameter) {

        Object o = this.context.getFirstParam();
        if (o == null) {

            this.setValid(false);
            this.getContext().removeFirstParam();

        }
    }

    mt.getLeftExpression().accept(new ExpressionVisitorImpl(this.getContext()));
    mt.getRightExpression().accept(new ExpressionVisitorImpl(this.getContext()));

}


public void visit(MinorThanEquals mte) {
    if (mte.getRightExpression() instanceof JdbcParameter) {

        Object o = this.context.getFirstParam();
        if (o == null) {

            this.setValid(false);
            this.getContext().removeFirstParam();

        }
    }

    mte.getLeftExpression().accept(new ExpressionVisitorImpl(this.getContext()));
    mte.getRightExpression().accept(new ExpressionVisitorImpl(this.getContext()));

}


public void visit(NotEqualsTo neq) {
    if (neq.getRightExpression() instanceof JdbcParameter) {

        Object o = this.context.getFirstParam();
        if (o == null) {

            this.setValid(false);
            this.getContext().removeFirstParam();

            return;
        }

    }
    neq.getLeftExpression().accept(new ExpressionVisitorImpl(this.getContext()));

    neq.getRightExpression().accept(new ExpressionVisitorImpl(this.getContext()));
}


public void visit(Column c) {

}


public void visit(SubSelect ss) {
    ss.getSelectBody().accept(new SelectVisitorImpl(context));

}


public void visit(CaseExpression ce) {
}


public void visit(WhenClause wc) {

}


public void visit(ExistsExpression ee) {
}


public void visit(AllComparisonExpression ace) {

}


public void visit(AnyComparisonExpression ace) {
}


public void visit(Concat c) {

}


public void visit(Matches m) {
}


public void visit(BitwiseAnd ba) {

}


public void visit(BitwiseOr bo) {
}


public void visit(BitwiseXor bx) {

}


private EqualsTo createTrueEquals() {
    EqualsTo eq = new EqualsTo();

    eq.setLeftExpression(new LongValue(&quot;1&quot;));
    eq.setRightExpression(new LongValue(&quot;1&quot;));

    return eq;
}


private EqualsTo createFalseEquals() {

    EqualsTo eq = new EqualsTo();
    eq.setLeftExpression(new LongValue(&quot;1&quot;));

    eq.setRightExpression(new LongValue(&quot;0&quot;));
    return eq;

}
</code></pre><p>}
增强后SQL语句的重新生成，根据ORACLE的语法重写了几个生成的方法
Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>public class OracleSelectDeParser extends SelectDeParser {  </li>
<li></li>
<li>public OracleSelectDeParser(ExpressionDeParser expressionDeParser, StringBuffer sb) {  </li>
<li>super(expressionDeParser, sb);  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 重写父类方法，去掉父类方法中table前的as </li>
<li>/*/  </li>
<li>public void visit(Table tableName) {  </li>
<li>buffer.append(tableName.getWholeTableName());  </li>
<li>String alias = tableName.getAlias();  </li>
<li>if (alias != null &amp;&amp; StringUtil.isNotEmpty(alias)) {  </li>
<li>buffer.append(&quot; &quot;);  </li>
<li>buffer.append(alias);  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 重写父类方法，在JOIN之前增加空格 </li>
<li>/*/  </li>
<li>@SuppressWarnings(&quot;unchecked&quot;)  </li>
<li>public void deparseJoin(Join join) {  </li>
<li>if (join.isSimple()) {  </li>
<li>buffer.append(&quot;, &quot;);  </li>
<li>} else {  </li>
<li>buffer.append(&quot; &quot;);  </li>
<li>if (join.isRight()) {  </li>
<li>buffer.append(&quot;RIGHT &quot;);  </li>
<li>} else if (join.isNatural()) {  </li>
<li>buffer.append(&quot;NATURAL &quot;);  </li>
<li>} else if (join.isFull()) {  </li>
<li>buffer.append(&quot;FULL &quot;);  </li>
<li>} else if (join.isLeft()) {  </li>
<li>buffer.append(&quot;LEFT &quot;);  </li>
<li>}  </li>
<li>if (join.isOuter()) {  </li>
<li>buffer.append(&quot;OUTER &quot;);  </li>
<li>} else if (join.isInner()) {  </li>
<li>buffer.append(&quot;INNER &quot;);  </li>
<li>}  </li>
<li>buffer.append(&quot;JOIN &quot;);  </li>
<li>}  </li>
<li></li>
<li>FromItem fromItem = join.getRightItem();  </li>
<li>fromItem.accept(this);  </li>
<li>if (join.getOnExpression() != null) {  </li>
<li>buffer.append(&quot; ON &quot;);  </li>
<li>join.getOnExpression().accept(expressionVisitor);  </li>
<li>}  </li>
<li>if (join.getUsingColumns() != null) {  </li>
<li>buffer.append(&quot; USING ( &quot;);  </li>
<li>for (Iterator<Column> iterator = join.getUsingColumns().iterator(); iterator.hasNext();) {  </li>
<li>Column column = iterator.next();  </li>
<li>buffer.append(column.getWholeColumnName());  </li>
<li>if (iterator.hasNext()) {  </li>
<li>buffer.append(&quot; ,&quot;);  </li>
<li>}  </li>
<li>}  </li>
<li>buffer.append(&quot;)&quot;);  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>}  </li>
</ol>
<p>public class OracleSelectDeParser extends SelectDeParser {</p>
<pre><code>public OracleSelectDeParser(ExpressionDeParser expressionDeParser, StringBuffer sb) {

    super(expressionDeParser, sb);
}


//*/*

 /* 重写父类方法，去掉父类方法中table前的as
 /*/

public void visit(Table tableName) {
    buffer.append(tableName.getWholeTableName());

    String alias = tableName.getAlias();
    if (alias != null &amp;&amp; StringUtil.isNotEmpty(alias)) {

        buffer.append(&quot; &quot;);
        buffer.append(alias);

    }
}


//*/*

 /* 重写父类方法，在JOIN之前增加空格
 /*/

@SuppressWarnings(&quot;unchecked&quot;)
public void deparseJoin(Join join) {

    if (join.isSimple()) {
        buffer.append(&quot;, &quot;);

    } else {
        buffer.append(&quot; &quot;);

        if (join.isRight()) {
            buffer.append(&quot;RIGHT &quot;);

        } else if (join.isNatural()) {
            buffer.append(&quot;NATURAL &quot;);

        } else if (join.isFull()) {
            buffer.append(&quot;FULL &quot;);

        } else if (join.isLeft()) {
            buffer.append(&quot;LEFT &quot;);

        }
        if (join.isOuter()) {

            buffer.append(&quot;OUTER &quot;);
        } else if (join.isInner()) {

            buffer.append(&quot;INNER &quot;);
        }

        buffer.append(&quot;JOIN &quot;);
    }


    FromItem fromItem = join.getRightItem();

    fromItem.accept(this);
    if (join.getOnExpression() != null) {

        buffer.append(&quot; ON &quot;);
        join.getOnExpression().accept(expressionVisitor);

    }
    if (join.getUsingColumns() != null) {

        buffer.append(&quot; USING ( &quot;);
        for (Iterator&lt;Column&gt; iterator = join.getUsingColumns().iterator(); iterator.hasNext();) {

            Column column = iterator.next();
            buffer.append(column.getWholeColumnName());

            if (iterator.hasNext()) {
                buffer.append(&quot; ,&quot;);

            }
        }

        buffer.append(&quot;)&quot;);
    }

}
</code></pre><p>}</p>

      
    </div>
    <section id='after_content_widget'><div class="widget" id="widget_after_content_wumiiRelatedItems>">
<script type="text/javascript" id="wumiiRelatedItems"></script>
</div><div class="widget" id="widget_after_content_post_footer_info>">
<div class="panel panel-success">
    <div class="panel-heading" align="center">希望本站内容对您有点用处,有什么疑问或建议请在后面留言评论</div>
    <div align="center" class="panel-body">转载请注明作者(<a href="http://itsolife.com/about/">RobinChia</a>)和出处 <a href="http://itsolife.com">It so life</a> ，请勿用于任何商业用途</div>
    <div class="panel-body">本文链接: <a href="/2014/02/02/2014-02-02-JavaJ2EE-SQL_Java--SQL解析Jsqlparser/">SQL解析(Jsqlparser)</a></div>
</div>
</div></section>
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li></span><span class="breadcrumb"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li><li><a href="/categories/Java&J2EE/SQL_Java/">SQL_Java</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Java&J2EE/" class="label label-primary">Java&J2EE</a><a href="/tags/SQL_Java/" class="label label-success">SQL_Java</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:41"datetime="2014-03-07 09:54:41"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-SQL_Java--SQL解析Jsqlparser/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JavaJ2EE-SQL_Java--SQL解析Jsqlparser" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>


    <section id='after_post_widget'><div class="widget" id="widget_after_post_post_pageNav>">
<ul class="pager">
  
  <li class="previous"><a href="/2014/02/02/2014-02-02-JavaJ2EE-Java_多线程-并发--深入浅出JavaConcurrency28-线程池/" title="深入浅出 Java Concurrency (28)">&larr; 深入浅出 Java Concurrency (28)</a></li>
  
  
  <li class="next"><a href="/2014/02/02/2014-02-02-JavaJ2EE-SQL_Java--IntroductiontoStructuredQueryLanguageZQL/" title="Introduction to Structured Query Language(ZQL)">Introduction to Structured Query Language(ZQL) &rarr;</a></li>
  
</ul></div><div class="widget" id="widget_after_post_related_posts>">
<ul class="list-group"><li class="list-group-item"><a href="/2014/02/02/2014-02-02-JavaJ2EE-Java_多线程-并发--聊聊并发（六）——ConcurrentLinkedQueue的实现原理分析/">聊聊并发（六）——ConcurrentLinkedQueue的实现原理分析</a></li><li class="list-group-item"><a href="/2014/02/02/2014-02-02-JavaJ2EE-算法数组优化-算法--栈/">栈</a></li><li class="list-group-item"><a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--perftools查看堆外内存并解决hbase内存溢出/">perftools查看堆外内存并解决hbase内存溢出</a></li><li class="list-group-item"><a href="/2014/02/02/2014-02-02-JavaJ2EE-Java_总结类--我的重构哪里不规范？讨论第2页/">我的重构哪里不规范？讨论第2页</a></li><li class="list-group-item"><a href="/2014/02/02/2014-02-02-JavaJ2EE-java-com-wmi-监控--使用J-Interop在Java中调用WMI/">使用 J</a></li><li class="list-group-item"><a href="/2014/02/02/2014-02-02-JavaJ2EE-算法数组优化-算法--一致性hash算法-consistenthashing/">一致性hash算法 </a></li><li class="list-group-item"><a href="/2014/02/02/2014-02-02-JavaJ2EE-IO--说说IO（二）-IO模型/">说说IO（二）</a></li><li class="list-group-item"><a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--GC悲观策略之ParallelGC篇/">GC悲观策略之Parallel GC篇</a></li></ul></div></section>    
	<div id="comments"><!-- Duoshuo Comment BEGIN -->

<div class="ds-thread"  data-thread-key="2014-02-02-JavaJ2EE-SQL_Java--SQL解析Jsqlparser"  data-url="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-SQL_Java--SQL解析Jsqlparser/" data-title="SQL解析(Jsqlparser)"></div>

		

<!-- Duoshuo Comment END -->

</div></div><!--wapper-->
       </div><!-- ID main-col END -->
       <aside id="sidebar" class="alignright col-sx-6 col-sm-4 col-md-3 col-lg-3">
<div id="widget_search" class="widget panel panel-primary">
    <form action="//google.com/search" method="get" accept-charset="utf-8">
  <div class="input-group">
    <input class="form-control" id="searchbox" type="search" name="q" results="0" placeholder="search">
    <span class="input-group-btn">
      <button class="btn btn-default" type="submit">Go!</button>
    </span>
    <input type="hidden" name="q" value="site:itsolife.com">
  </div>
</form>
</div>

<div id="widget_category" class="widget panel panel-primary">
  <div class="panel-heading">category</div>  <div data-src='category' class='ajax_widgets'>正在加载...</div>
</div>

<div id="widget_recent_posts" class="widget panel panel-primary">
  <div class="panel-heading">recent posts</div>  <div data-src='recent_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_tagcloud" class="widget panel panel-primary">
  <div class="panel-heading">tagcloud</div>  <div data-src='tagcloud' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_latest_update_posts" class="widget panel panel-primary">
  <div class="panel-heading">最近更新</div>  <div data-src='latest_update_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_recent_comments" class="widget panel panel-primary">
  <div class="panel-heading">recent comments</div>  

<div class="list-group-item ds-recent-comments" data-num-items="6" data-show-avatars="1" data-show-time="1" data-show-title="1" data-show-admin="1" data-excerpt-length="50"></div>



</div>

</aside>
       <div class="clearfix"></div>
     </div><!-- row END -->
  </div>
  <footer id="footer" class="container">
  <div class="panel panel-info">
  <section id='footer_widget'></section>  <div class="panel-footer">
  <div id="site-info">
    <span class='author'>
  
  &copy; 2014 RobinChia
  
    &nbsp;&nbsp;</span>
  
  <span id='analytics-51la'></span><span id='analytics-google'>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-48559895-1']);
  _gaq.push(['_trackPageview']);
  _js2load.push({src:('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'});
</script></span><span id='analytics-cnzz'>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_5774006'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s17.cnzz.com/stat.php%3Fid%3D5774006%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</span><span id='analytics-baidu'>
<script>
var _hmt = _hmt || [];
_js2load.push({src:"//hm.baidu.com/hm.js?1442f50724afc42380b51f097c43082c"});
</script>
</span>  </div>
  <div id="copyright">Blog powered by <a href='http://zespia.tw/hexo/'><strong>hexo</strong></a> Theme <strong><a href='https://github.com/chenall/hexo-theme-chenall'>chenall</a></strong>(Some change in it)<span class="pull-right"> 更新时间: <em>2014-03-07 09:54:41</em></span></div>
</div>
<div class="clearfix"></div>


  </div>
  </footer>
  
        <script src="http://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>        
        <script src="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>        
                
        <script src="http://cdn.bootcss.com/prettify/r298/prettify.min.js"></script>    <script type="text/javascript">
   var lang=["bsh", "c", "cc", "cpp", "cs", "csh", "cyc", "cv", "htm", "html",
    "java", "js", "m", "mxml", "perl", "pl", "pm", "py", "rb", "sh",
    "xhtml", "xml", "xsl"];
   var pretty_base='';
   $('script').each(function(){
	var c = $(this).attr('src');
	if (!c)
	    return;
	if (c.match(/(\/)?prettify(\.min)?\.js/i))
	{
	    var index = c.lastIndexOf('/');
	    if (index != -1)
		pretty_base = c.substr(0,index + 1);
	    return false;
	}
   })
   $('pre code').each(function(){
	var c = $(this).attr('class')
	if (!c)
	    return;
	c = c.match(/\s?(lang\-\w+)/i);
	if (c && lang.indexOf(c[1]) == -1)
	{
	    lang.push(c[1]);
	    $.getScript(pretty_base + c[1] + '.min.js');
	}
   })

    $(window).load(function(){
       $("pre").addClass("prettyprint");
       prettyPrint();
    })
</script>    
            <script type="text/javascript">
var duoshuoQuery = {short_name:"robinchia"};
_js2load.push({src:'http://static.duoshuo.com/embed.js',charset:'UTF-8'});
</script>
    
            <!--wumii_relatedItems-->

<script type="text/javascript">
    var wumiiPermaLink = "http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-SQL_Java--SQL解析Jsqlparser/";
    var wumiiTitle = "SQL解析(Jsqlparser)";
    var wumiiTags = "Java&J2EE,SQL_Java";
    var wumiiCategories = ["Java&J2EE","Java&J2EE","SQL_Java"];
    var wumiiSitePrefix = "http://itsolife.com";
    var wumiiParams = "&num=5&mode=3&pf=JAVASCRIPT";
    _js2load.push({src:'http://widget.wumii.cn/ext/relatedItemsWidget'});
</script>
<a href="http://www.wumii.com/widget/relatedItems" style="border:0;">
<img src="http://static.wumii.cn/images/pixel.png" alt="无觅关联推荐，快速提升流量" style="border:0;padding:0;margin:0;" />
</a>
    
        <script src="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>    <script type="text/javascript">
(function($){
  $('.entry').each(function(i){
    $(this).find('img').each(function(){
      var alt = this.alt;

      if (alt){
        $(this).before('<span class="caption">' + alt + '</span>');
      }

      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="fancybox' + i + '" />');
    });
  });

  $('.fancybox').fancybox();
})(jQuery);
</script>    
        <script src="http://cdn.bootcss.com/mathjax/2.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>
    
<script type="text/javascript">
$('.ajax_widgets').each(function(){var src=$(this).attr('data-src');if(src)$(this).load('/widgets/'+src+'.html');});
$.each(_js2load,function(index,obj){loadjs(obj.src,obj.charset)});
</script>

<div id="scroll2top">
<img src="/scroll2top/arrow.png"/>
</div>
<script src="/scroll2top/scroll2top.min.js"></script>
<div id="winterland">
  <canvas></canvas>
</div>
<script src="/js/winterland.min.js"></script>

  </body>
</html>
