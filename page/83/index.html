
<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>The 83 Page | It so life</title>
<meta name="author" content="RobinChia">

<meta name="description" content="It so life">


<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta property="og:site_name" content="It so life"/>

<!--[if IE]><style>.testIE.IE{display:inline;}</style><![endif]-->
<!--[if lte IE 7]><link rel="stylesheet" href="/css/ie7.css" type="text/css"><![endif]-->
<!--[if (lt IE 9)&(gt IE 7)]><style>.testIE.IE8{display:inline;}</style><![endif]-->
<!--[if gt IE 8]><style>.testIE.IE9{display:inline;}</style><![endif]-->

<link href="/favicon.png" rel="icon">
<link rel="alternate" href="/atom.xml" title="It so life Feed" type="application/atom+xml">

<link rel="stylesheet" href="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/font-awesome/4.0.3/css/font-awesome.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/prettify/r298/prettify.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" type="text/css">
<link rel="stylesheet" href="/css/style.css" type="text/css">
<!--[if lt IE 9]>
   <style>article,aside,dialog,footer,header,section,footer,nav,figure,menu{display:block}</style>
   <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
   <script src="http://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
<link href="http://cdn.staticfile.org/respond.js/1.4.2/respond-proxy.html" id="respond-proxy" rel="respond-proxy" />
<link href="/js/respond.proxy.gif" id="respond-redirect" rel="respond-redirect" />
<script src="/js/respond.proxy.js"></script>
   <script src="http://cdn.bootcss.com/selectivizr/1.0.2/selectivizr-min.js"></script>
<![endif]-->
<script type="text/javascript">
function loadjs(c,d){var a=document.createElement("script");a.async=!0;a.type="text/javascript";a.src=c;a.charset=d||"gbk";(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(a)};
var _protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
var _js2load = [];
</script>

</head>
<body>
      <header id="header" class="container"><nav id="main-nav" class="navbar navbar-default navbar-fixed-top " role="navigation">
  <div class="container">
    <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/">It so life</a>
    </div>
    <div  class="collapse navbar-collapse">
      <ul  class="nav navbar-nav">
  
        <li><a href="/" title="Home">Home</a></li>      
        <li><a href="/about/" title="About">About</a></li>      
        <li><a href="/archives/" title="Archives">Archives</a></li>      
      <li class='dropdown'>
        <a class='dropdown-toggle' data-toggle='dropdown' href='#'>website<b class='caret'></b></a>
        <ul class='dropdown-menu pure-menu-selected'>
    
          <li><a href="//groups.google.com/forum/#!forum/pongba" title="TopLanguage">TopLanguage</a></li>    
          <li><a href="//itpub.net/" title="ITPub">ITPub</a></li>    
          <li><a href="//blog.jobbole.com/" title="Bole">Bole</a></li>    
          <li><a href="//nosql-database.org/" title="nosql">nosql</a></li>    
          <li><a href="//gitimmersion.googol.im/" title="Git">Git</a></li>    
        </ul>
      </li>
    
      </ul>
      <ul class="nav navbar-nav navbar-right">
      
        <li><a href="/atom.xml">RSS</a></li>
      
      
        <li><a href="https://twitter.com/robinchia">twitter</a></li>
      
      
      
      
        <li><a href="https://github.com/robinchia">github</a></li>
      
      </ul>
    </div>
  </div>
</nav>
<div class="clearfix"></div>
</header>
  <div id='content' class="container">
     <div class="page-header-wrapper">
      <!--[if lt IE 9]><div class="alert alert-warning alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>提示:</strong>您的浏览器版本太低了,建议升级到 <strong><a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" title="IE9">IE9</a></strong> 以上,本站使用<a href="https://www.google.com/intl/zh-CN/chrome/">Chrome浏览器</a>可以获得最好的显示效果.</div><![endif]-->
      <div class="page-header"><h1 align="center"><big>It so life</big> </h1>
        <h5 align="center"><big>love as life</big></h5>
      </div>
     </div>
     <div class="row">
       <div id="main-col" class="alignleft col-sx-12 col-sm-8 col-md-9 col-lg-9">
      <section id='header_widget'></section>
          <div id="wrapper"><article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-缓存-ehcache--Ehcache详细解读-四火的BLOG-ITeye技术网站/">Ehcache详细解读 </a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:39.000Z"> <a href="/2014/02/02/2014-02-02-缓存-ehcache--Ehcache详细解读-四火的BLOG-ITeye技术网站/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="ehcache-blog-iteye-">Ehcache详细解读 - 四火的BLOG - ITeye技术网站</h1>
<p><a href="http://www.iteye.com/" target="_blank">首页</a> <a href="http://www.iteye.com/news" target="_blank">资讯</a> <a href="http://www.iteye.com/magazines" target="_blank">精华</a> <a href="http://www.iteye.com/forums" target="_blank">论坛</a> <a href="http://www.iteye.com/ask" target="_blank">问答</a> <a href="http://www.iteye.com/blogs" target="_blank">博客</a> <a href="http://www.iteye.com/blogs/subjects" target="_blank">专栏</a> <a href="http://www.iteye.com/groups" target="_blank">群组</a> <a href="http://raychase.iteye.com/blog/1545906#" target="_blank">更多 ▼</a></p>
<p><a href="http://www.iteye.com/job" target="_blank">招聘</a> <a href="http://www.iteye.com/search" target="_blank">搜索</a></p>
<p><a href="http://raychase.iteye.com/login" title="登录" target="_blank">您还未登录 !</a> <a href="http://raychase.iteye.com/login" target="_blank">登录</a> <a href="http://raychase.iteye.com/signup" target="_blank">注册</a></p>
<h1 id="-blog-http-raychase-iteye-com-"><a href="http://raychase.iteye.com/" target="_blank">四火的BLOG</a></h1>
<ul>
<li><a href="http://raychase.iteye.com/" target="_blank"><strong>博客</strong></a></li>
<li><a href="http://raychase.iteye.com/weibo" target="_blank">微博</a></li>
<li><a href="http://raychase.iteye.com/album" target="_blank">相册</a></li>
<li><a href="http://raychase.iteye.com/link" target="_blank">收藏</a></li>
<li><a href="http://raychase.iteye.com/blog/guest_book" target="_blank">留言</a></li>
<li><a href="http://raychase.iteye.com/blog/profile" target="_blank">关于我</a></li>
</ul>
<h3 id="-ehcache-"><a href="">Ehcache详细解读</a> **</h3>
<p><strong>博客分类：</strong></p>
<ul>
<li><a href="http://raychase.iteye.com/category/178243" target="_blank">Framework</a></li>
<li><a href="http://raychase.iteye.com/category/185968" target="_blank">Performance</a>
<a href="http://www.iteye.com/blogs/tag/%E7%BC%93%E5%AD%98" target="_blank">缓存</a><a href="http://www.iteye.com/blogs/tag/Ehcache" target="_blank">Ehcache</a></li>
</ul>
<p><a href="http://ehcache.org/" target="_blank">Ehcache</a> 是现在最流行的纯Java开源缓存框架，配置简单、结构清晰、功能强大，最初知道它，是从Hibernate的缓存开始的。网上中文的EhCache材料以简单介绍和配置方法居多，如果你有这方面的问题，请自行google；对于API，官网上介绍已经非常清楚，请参见官网；但是很少见到特性说明和对实现原理的分析，因此在这篇文章里面，我会详细介绍和分析EhCache的特性，加上一些自己的理解和思考，希望对缓存感兴趣的朋友有所收获。</p>
<p><strong>一、特性一览</strong>，来自官网，简单翻译一下：</p>
<p>1、快速轻量
过去几年，诸多测试表明Ehcache是最快的Java缓存之一。
Ehcache的线程机制是为大型高并发系统设计的。
大量性能测试用例保证Ehcache在不同版本间性能表现得一致性。
很多用户都不知道他们正在用Ehcache，因为不需要什么特别的配置。
API易于使用，这就很容易部署上线和运行。
很小的jar包，Ehcache 2.2.3才668kb。
最小的依赖：唯一的依赖就是SLF4J了。
2、伸缩性
缓存在内存和磁盘存储可以伸缩到数G，Ehcache为大数据存储做过优化。
大内存的情况下，所有进程可以支持数百G的吞吐。
为高并发和大型多CPU服务器做优化。
线程安全和性能总是一对矛盾，Ehcache的线程机制设计采用了Doug Lea的想法来获得较高的性能。
单台虚拟机上支持多缓存管理器。
通过Terracotta服务器矩阵，可以伸缩到数百个节点。
3、灵活性
Ehcache 1.2具备对象API接口和可序列化API接口。
不能序列化的对象可以使用除磁盘存储外Ehcache的所有功能。
除了元素的返回方法以外，API都是统一的。只有这两个方法不一致：getObjectValue和getKeyValue。这就使得缓存对象、序列化对象来获取新的特性这个过程很简单。
支持基于Cache和基于Element的过期策略，每个Cache的存活时间都是可以设置和控制的。
提供了LRU、LFU和FIFO缓存淘汰算法，Ehcache 1.2引入了最少使用和先进先出缓存淘汰算法，构成了完整的缓存淘汰算法。
提供内存和磁盘存储，Ehcache和大多数缓存解决方案一样，提供高性能的内存和磁盘存储。
动态、运行时缓存配置，存活时间、空闲时间、内存和磁盘存放缓存的最大数目都是可以在运行时修改的。
4、标准支持
Ehcache提供了对JSR107 JCACHE API最完整的实现。因为JCACHE在发布以前，Ehcache的实现（如net.sf.jsr107cache）已经发布了。
实现JCACHE API有利于到未来其他缓存解决方案的可移植性。
Ehcache的维护者Greg Luck，正是JSR107的专家委员会委员。
5、可扩展性
监听器可以插件化。Ehcache 1.2提供了CacheManagerEventListener和CacheEventListener接口，实现可以插件化，并且可以在ehcache.xml里配置。
节点发现，冗余器和监听器都可以插件化。
分布式缓存，从Ehcache 1.2开始引入，包含了一些权衡的选项。Ehcache的团队相信没有什么是万能的配置。
实现者可以使用内建的机制或者完全自己实现，因为有完整的插件开发指南。
缓存的可扩展性可以插件化。创建你自己的缓存扩展，它可以持有一个缓存的引用，并且绑定在缓存的生命周期内。
缓存加载器可以插件化。创建你自己的缓存加载器，可以使用一些异步方法来加载数据到缓存里面。
缓存异常处理器可以插件化。创建一个异常处理器，在异常发生的时候，可以执行某些特定操作。
6、应用持久化
在VM重启后，持久化到磁盘的存储可以复原数据。
Ehcache是第一个引入缓存数据持久化存储的开源Java缓存框架。缓存的数据可以在机器重启后从磁盘上重新获得。
根据需要将缓存刷到磁盘。将缓存条目刷到磁盘的操作可以通过cache.flush()方法来执行，这大大方便了Ehcache的使用。
7、监听器
缓存管理器监听器。允许注册实现了CacheManagerEventListener接口的监听器：
notifyCacheAdded()
notifyCacheRemoved()
缓存事件监听器。允许注册实现了CacheEventListener接口的监听器，它提供了许多对缓存事件发生后的处理机制：
notifyElementRemoved/Put/Updated/Expired
8、开启JMX
Ehcache的JMX功能是默认开启的，你可以监控和管理如下的MBean：
CacheManager、Cache、CacheConfiguration、CacheStatistics
9、分布式缓存
从Ehcache 1.2开始，支持高性能的分布式缓存，兼具灵活性和扩展性。
分布式缓存的选项包括：
通过Terracotta的缓存集群：设定和使用Terracotta模式的Ehcache缓存。缓存发现是自动完成的，并且有很多选项可以用来调试缓存行为和性能。
使用RMI、JGroups或者JMS来冗余缓存数据：节点可以通过多播或发现者手动配置。状态更新可以通过RMI连接来异步或者同步完成。
Custom：一个综合的插件机制，支持发现和复制的能力。
可用的缓存复制选项。支持的通过RMI、JGroups或JMS进行的异步或同步的缓存复制。
可靠的分发：使用TCP的内建分发机制。
节点发现：节点可以手动配置或者使用多播自动发现，并且可以自动添加和移除节点。对于多播阻塞的情况下，手动配置可以很好地控制。
分布式缓存可以任意时间加入或者离开集群。缓存可以配置在初始化的时候执行引导程序员。
BootstrapCacheLoaderFactory抽象工厂，实现了BootstrapCacheLoader接口（RMI实现）。
缓存服务端。Ehcache提供了一个Cache Server，一个war包，为绝大多数web容器或者是独立的服务器提供支持。
缓存服务端有两组API：面向资源的RESTful，还有就是SOAP。客户端没有实现语言的限制。
RESTful缓存服务器：Ehcached的实现严格遵循RESTful面向资源的架构风格。
SOAP缓存服务端：Ehcache RESTFul Web Services API暴露了单例的CacheManager，他能在ehcache.xml或者IoC容器里面配置。
标准服务端包含了内嵌的Glassfish web容器。它被打成了war包，可以任意部署到支持Servlet 2.5的web容器内。Glassfish V2/3、Tomcat 6和Jetty 6都已经经过了测试。
10、搜索
标准分布式搜索使用了流式查询接口的方式，请参阅文档。
11、Java EE和应用缓存
为普通缓存场景和模式提供高质量的实现。
阻塞缓存：它的机制避免了复制进程并发操作的问题。
SelfPopulatingCache在缓存一些开销昂贵操作时显得特别有用，它是一种针对读优化的缓存。它不需要调用者知道缓存元素怎样被返回，也支持在不阻塞读的情况下刷新缓存条目。
CachingFilter：一个抽象、可扩展的cache filter。
SimplePageCachingFilter：用于缓存基于request URI和Query String的页面。它可以根据HTTP request header的值来选择采用或者不采用gzip压缩方式将页面发到浏览器端。你可以用它来缓存整个Servlet页面，无论你采用的是JSP、velocity，或者其他的页面渲染技术。
SimplePageFragmentCachingFilter：缓存页面片段，基于request URI和Query String。在JSP中使用jsp:include标签包含。
已经使用Orion和Tomcat测试过，兼容Servlet 2.3、Servlet 2.4规范。
Cacheable命令：这是一种老的命令行模式，支持异步行为、容错。
兼容Hibernate，兼容Google App Engine。
基于JTA的事务支持，支持事务资源管理，二阶段提交和回滚，以及本地事务。
12、开源协议
Apache 2.0 license</p>
<p><strong>二、Ehcache的加载模块列表</strong>，他们都是独立的库，每个都为Ehcache添加新的功能，可以<a href="http://ehcache.org/downloads/catalog" target="_blank">在此下载</a> ：</p>
<ul>
<li>ehcache-core：API，标准缓存引擎，RMI复制和Hibernate支持</li>
<li>ehcache：分布式Ehcache，包括Ehcache的核心和Terracotta的库</li>
<li>ehcache-monitor：企业级监控和管理</li>
<li>ehcache-web：为Java Servlet Container提供缓存、gzip压缩支持的filters</li>
<li>ehcache-jcache：JSR107 JCACHE的实现</li>
<li>ehcache-jgroupsreplication：使用JGroup的复制</li>
<li>ehcache-jmsreplication：使用JMS的复制</li>
<li>ehcache-openjpa：OpenJPA插件</li>
<li>ehcache-server：war内部署或者单独部署的RESTful cache server</li>
<li>ehcache-unlockedreadsview：允许Terracotta cache的无锁读</li>
<li>ehcache-debugger：记录RMI分布式调用事件</li>
<li>Ehcache for Ruby：Jruby and Rails支持</li>
</ul>
<p>Ehcache的结构设计概览：</p>
<p><img src="&quot;点击查看原始大小图片&quot;" alt=""></p>
<p><strong>三、核心定义</strong>：</p>
<p>cache manager：缓存管理器，以前是只允许单例的，不过现在也可以多实例了</p>
<p>cache：缓存管理器内可以放置若干cache，存放数据的实质，所有cache都实现了Ehcache接口</p>
<p>element：单条缓存数据的组成单位</p>
<p>system of record（SOR）：可以取到真实数据的组件，可以是真正的业务逻辑、外部接口调用、存放真实数据的数据库等等，缓存就是从SOR中读取或者写入到SOR中去的。</p>
<p>代码示例：
Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>CacheManager manager = CacheManager.newInstance(&quot;src/config/ehcache.xml&quot;);  </li>
<li>manager.addCache(&quot;testCache&quot;);  </li>
<li>Cache test = singletonManager.getCache(&quot;testCache&quot;);  </li>
<li>test.put(new Element(&quot;key1&quot;, &quot;value1&quot;));  </li>
<li>manager.shutdown();<br>CacheManager manager = CacheManager.newInstance(&quot;src/config/ehcache.xml&quot;); manager.addCache(&quot;testCache&quot;); Cache test = singletonManager.getCache(&quot;testCache&quot;); test.put(new Element(&quot;key1&quot;, &quot;value1&quot;)); manager.shutdown();</li>
</ol>
<p>当然，也支持这种类似DSL的配置方式，配置都是可以在运行时动态修改的：</p>
<p>Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>Cache testCache = new Cache(  </li>
<li>new CacheConfiguration(&quot;testCache&quot;, maxElements)  </li>
<li>.memoryStoreEvictionPolicy(MemoryStoreEvictionPolicy.LFU)  </li>
<li>.overflowToDisk(true)  </li>
<li>.eternal(false)  </li>
<li>.timeToLiveSeconds(60)  </li>
<li>.timeToIdleSeconds(30)  </li>
<li>.diskPersistent(false)  </li>
<li>.diskExpiryThreadIntervalSeconds(0));<br>Cache testCache = new Cache( new CacheConfiguration(&quot;testCache&quot;, maxElements) .memoryStoreEvictionPolicy(MemoryStoreEvictionPolicy.LFU) .overflowToDisk(true) .eternal(false) .timeToLiveSeconds(60) .timeToIdleSeconds(30) .diskPersistent(false) .diskExpiryThreadIntervalSeconds(0));</li>
</ol>
<p>事务的例子：</p>
<p>Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>Ehcache cache = cacheManager.getEhcache(&quot;xaCache&quot;);  </li>
<li>transactionManager.begin();  </li>
<li>try {  </li>
<li>Element e = cache.get(key);  </li>
<li>Object result = complexService.doStuff(element.getValue());  </li>
<li>cache.put(new Element(key, result));  </li>
<li>complexService.doMoreStuff(result);  </li>
<li>transactionManager.commit();  </li>
<li>} catch (Exception e) {  </li>
<li>transactionManager.rollback();  </li>
<li>}<br>Ehcache cache = cacheManager.getEhcache(&quot;xaCache&quot;); transactionManager.begin(); try { Element e = cache.get(key); Object result = complexService.doStuff(element.getValue()); cache.put(new Element(key, result)); complexService.doMoreStuff(result); transactionManager.commit(); } catch (Exception e) { transactionManager.rollback(); }</li>
</ol>
<p><strong>四、一致性模型</strong>：</p>
<p>说到一致性，数据库的一致性是怎样的？不妨先来回顾一下数据库的几个隔离级别：</p>
<p>未提交读（Read Uncommitted）：在读数据时不会检查或使用任何锁。因此，在这种隔离级别中可能读取到没有提交的数据。会出现脏读、不可重复读、幻象读。
已提交读（Read Committed）：只读取提交的数据并等待其他事务释放排他锁。读数据的共享锁在读操作完成后立即释放。已提交读是数据库的默认隔离级别。会出现不可重复读、幻象读。
可重复读（Repeatable Read）：像已提交读级别那样读数据，但会保持共享锁直到事务结束。会出现幻象读。
可序列化（Serializable）：工作方式类似于可重复读。但它不仅会锁定受影响的数据，还会锁定这个范围，这就阻止了新数据插入查询所涉及的范围。</p>
<p>基于以上，再来对比思考下面的一致性模型：</p>
<p>1、强一致性模型：系统中的某个数据被成功更新(事务成功返回)后，后续任何对该数据的读取操作都得到更新后的值。这是传统关系数据库提供的一致性模型，也是关系数据库深受人们喜爱的原因之一。强一致性模型下的性能消耗通常是最大的。</p>
<p>2、弱一致性模型：系统中的某个数据被更新后，后续对该数据的读取操作得到的不一定是更新后的值，这种情况下通常有个“不一致性时间窗口”存在：即数据更新完成后在经过这个时间窗口，后续读取操作就能够得到更新后的值。</p>
<p>3、最终一致性模型：属于弱一致性的一种，即某个数据被更新后，如果该数据后续没有被再次更新，那么最终所有的读取操作都会返回更新后的值。</p>
<p>最终一致性模型包含如下几个必要属性，都比较好理解：</p>
<ul>
<li>读写一致：某线程A，更新某条数据以后，后续的访问全部都能取得更新后的数据。</li>
<li>会话内一致：它本质上和上面那一条是一致的，某用户更改了数据，只要会话还存在，后续他取得的所有数据都必须是更改后的数据。</li>
<li>单调读一致：如果一个进程可以看到当前的值，那么后续的访问不能返回之前的值。</li>
<li>单调写一致：对同一进程内的写行为必须是保序的，否则，写完毕的结果就是不可预期的了。</li>
</ul>
<p>4、Bulk Load：这种模型是基于批量加载数据到缓存里面的场景而优化的，没有引入锁和常规的淘汰算法这些降低性能的东西，它和最终一致性模型很像，但是有批量、高速写和弱一致性保证的机制。</p>
<p>这样几个API也会影响到一致性的结果：</p>
<p>1、显式锁（<a href="http://terracotta.org/documentation/enterprise-ehcache/api-guide#31478" target="_blank">Explicit Locking</a> ）：如果我们本身就配置为强一致性，那么自然所有的缓存操作都具备事务性质。而如果我们配置成最终一致性时，再在外部使用显式锁API，也可以达到事务的效果。当然这样的锁可以控制得更细粒度，但是依然可能存在竞争和线程阻塞。</p>
<p>2、无锁可读取视图（UnlockedReadsView）：一个允许脏读的decorator，它只能用在强一致性的配置下，它通过申请一个特殊的写锁来比完全的强一致性配置提升性能。</p>
<p>举例如下，xml配置为强一致性模型：
Xml代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>&lt;cache name=&quot;myCache&quot;  </li>
<li>maxElementsInMemory=&quot;500&quot;  </li>
<li>eternal=&quot;false&quot;  </li>
<li>overflowToDisk=&quot;false&quot;  </li>
<li><terracotta clustered="true" consistency="strong" />  </li>
<li></cache>  <cache name="myCache" maxElementsInMemory="500" eternal="false" overflowToDisk="false" <terracotta clustered="true" consistency="strong" /> </cache>

</li>
</ol>
<p>但是使用UnlockedReadsView：</p>
<p>Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>Cache cache = cacheManager.getEhcache(&quot;myCache&quot;);  </li>
<li>UnlockedReadsView unlockedReadsView = new UnlockedReadsView(cache, &quot;myUnlockedCache&quot;);<br>Cache cache = cacheManager.getEhcache(&quot;myCache&quot;); UnlockedReadsView unlockedReadsView = new UnlockedReadsView(cache, &quot;myUnlockedCache&quot;);</li>
</ol>
<p>3、原子方法（Atomic methods）：方法执行是原子化的，即CAS操作（Compare and Swap）。CAS最终也实现了强一致性的效果，但不同的是，它是采用乐观锁而不是悲观锁来实现的。在乐观锁机制下，更新的操作可能不成功，因为在这过程中可能会有其他线程对同一条数据进行变更，那么在失败后需要重新执行更新操作。现代的CPU都支持CAS原语了。
Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>cache.putIfAbsent(Element element);  </li>
<li>cache.replace(Element oldOne, Element newOne);  </li>
<li>cache.remove(Element);<br>cache.putIfAbsent(Element element); cache.replace(Element oldOne, Element newOne); cache.remove(Element);</li>
</ol>
<p><strong>五、缓存拓扑类型</strong>：</p>
<p>1、独立缓存（Standalone Ehcache）：这样的缓存应用节点都是独立的，互相不通信。</p>
<p>2、分布式缓存（Distributed Ehcache）：数据存储在Terracotta的服务器阵列（Terracotta Server Array，TSA）中，但是最近使用的数据，可以存储在各个应用节点中。</p>
<p>逻辑视角：</p>
<p><img src="" alt="">
L1缓存就在各个应用节点上，而L2缓存则放在Cache Server阵列中。</p>
<p>组网视角：
<img src="" alt=""></p>
<p>模型存储视角：</p>
<p><img src="" alt="">
L1级缓存是没有持久化存储的。另外，从缓存数据量上看，server端远大于应用节点。</p>
<p>3、复制式缓存（Replicated Ehcache）：缓存数据时同时存放在多个应用节点的，数据复制和失效的事件以同步或者异步的形式在各个集群节点间传播。上述事件到来时，会阻塞写线程的操作。在这种模式下，只有弱一致性模型。</p>
<p>它有如下几种事件传播机制：RMI、JGroups、JMS和Cache Server。</p>
<p>RMI模式下，所有节点全部对等：</p>
<p><img src="" alt=""></p>
<p>JGroup模式：可以配置单播或者多播，协议栈和配置都非常灵活。</p>
<p>Xml代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>&lt;cacheManagerPeerProviderFactory  </li>
<li>class=&quot;net.sf.ehcache.distribution.jgroups.JGroupsCacheManagerPeerProviderFactory&quot;  </li>
<li>properties=&quot;connect=UDP(mcast_addr=231.12.21.132;mcast_port=45566;):PING:  </li>
<li>MERGE2:FD_SOCK:VERIFY_SUSPECT:pbcast.NAKACK:UNICAST:pbcast.STABLE:FRAG:pbcast.GMS&quot;  </li>
<li>propertySeparator=&quot;::&quot;  </li>
<li>/&gt;  <cacheManagerPeerProviderFactory class="net.sf.ehcache.distribution.jgroups.JGroupsCacheManagerPeerProviderFactory" properties="connect=UDP(mcast_addr=231.12.21.132;mcast_port=45566;):PING: MERGE2:FD_SOCK:VERIFY_SUSPECT:pbcast.NAKACK:UNICAST:pbcast.STABLE:FRAG:pbcast.GMS" propertySeparator="::" />





</li>
</ol>
<p>JMS模式：这种模式的核心就是一个消息队列，每个应用节点都订阅预先定义好的主题，同时，节点有元素更新时，也会发布更新元素到主题中去。JMS规范实现者上，Open MQ和Active MQ这两个，Ehcache的兼容性都已经测试过。</p>
<p><img src="" alt=""></p>
<p>Cache Server模式：这种模式下存在主从节点，通信可以通过RESTful的API或者SOAP。</p>
<p><img src="" alt=""></p>
<p>无论上面哪个模式，更新事件又可以分为updateViaCopy或updateViaInvalidate，后者只是发送一个过期消息，效率要高得多。</p>
<p>复制式缓存容易出现数据不一致的问题，如果这成为一个问题，可以考虑使用数据同步分发的机制。</p>
<p>即便不采用分布式缓存和复制式缓存，依然会出现一些不好的行为，比如：</p>
<p>缓存漂移（Cache Drift）：每个应用节点只管理自己的缓存，在更新某个节点的时候，不会影响到其他的节点，这样数据之间可能就不同步了。这在web会话数据缓存中情况尤甚。</p>
<p>数据库瓶颈（Database Bottlenecks ）：对于单实例的应用来说，缓存可以保护数据库的读风暴；但是，在集群的环境下，每一个应用节点都要定期保持数据最新，节点越多，要维持这样的情况对数据库的开销也越大。</p>
<p><strong>六、存储方式</strong>：</p>
<p>1、堆内存储：速度快，但是容量有限。</p>
<p>2、堆外（OffHeapStore）存储：被称为BigMemory，只在企业版本的Ehcache中提供，原理是利用nio的DirectByteBuffers实现，比存储到磁盘上快，而且完全不受GC的影响，可以保证响应时间的稳定性；但是direct buffer的在分配上的开销要比heap buffer大，而且要求必须以字节数组方式存储，因此对象必须在存储过程中进行序列化，读取则进行反序列化操作，它的速度大约比堆内存储慢一个数量级。</p>
<p>（注：direct buffer不受GC影响，但是direct buffer归属的的JAVA对象是在堆上且能够被GC回收的，一旦它被回收，JVM将释放direct buffer的堆外空间。）</p>
<p>3、磁盘存储。</p>
<p><strong>七、缓存使用模式</strong>：</p>
<p>cache-aside：直接操作。先询问cache某条缓存数据是否存在，存在的话直接从cache中返回数据，绕过SOR；如果不存在，从SOR中取得数据，然后再放入cache中。</p>
<p>Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>public V readSomeData(K key)   </li>
<li>{  </li>
<li>Element element;  </li>
<li>if ((element = cache.get(key)) != null) {  </li>
<li>return element.getValue();  </li>
<li>}  </li>
<li>if (value = readDataFromDataStore(key)) != null) {  </li>
<li>cache.put(new Element(key, value));  </li>
<li>}   </li>
<li>return value;  </li>
<li>}<br>public V readSomeData(K key) { Element element; if ((element = cache.get(key)) != null) { return element.getValue(); } if (value = readDataFromDataStore(key)) != null) { cache.put(new Element(key, value)); } return value; }</li>
</ol>
<p>cache-as-sor：结合了read-through、write-through或write-behind操作，通过给SOR增加了一层代理，对外部应用访问来说，它不用区别数据是从缓存中还是从SOR中取得的。</p>
<p>read-through。</p>
<p>write-through。</p>
<p>write-behind（write-back）：既将写的过程变为异步的，又进一步延迟写入数据的过程。</p>
<p>Copy Cache的两个模式：CopyOnRead和CopyOnWrite。</p>
<p>CopyOnRead指的是在读缓存数据的请求到达时，如果发现数据已经过期，需要重新从源处获取，发起的copy element的操作（pull）；</p>
<p>CopyOnWrite则是发生在真实数据写入缓存时，发起的更新其他节点的copy element的操作（push）。</p>
<p>前者适合在不允许多个线程访问同一个element的时候使用，后者则允许你自由控制缓存更新通知的时机。</p>
<p>更多push和pull的变化和不同，也可<a href="http://raychase.iteye.com/blog/1337015" target="_blank">参见这里</a>。</p>
<p><strong>八、多种配置方式</strong>：</p>
<p>包括配置文件、声明式配置、编程式配置，甚至通过指定构造器的参数来完成配置，配置设计的原则包括：</p>
<p>所有配置要放到一起</p>
<p>缓存的配置可以很容易在开发阶段、运行时修改</p>
<p>错误的配置能够在程序启动时发现，在运行时修改出错则需要抛出运行时异常</p>
<p>提供默认配置，几乎所有的配置都是可选的，都有默认值</p>
<p><strong>九、自动资源控制</strong>（Automatic Resource Control，ARC）：</p>
<p>它是提供了一种智能途径来控制缓存，调优性能。特性包括：</p>
<p>内存内缓存对象大小的控制，避免OOM出现</p>
<p>池化（cache manager级别）的缓存大小获取，避免单独计算缓存大小的消耗</p>
<p>灵活的独立基于层的大小计算能力，下图中可以看到，不同层的大小都是可以单独控制的</p>
<p>可以统计字节大小、缓存条目数和百分比</p>
<p>优化高命中数据的获取，以提升性能，参见下面对缓存数据在不同层之间的流转的介绍</p>
<p><img src="" alt=""></p>
<p>缓存数据的流转包括了这样几种行为：</p>
<p>Flush：缓存条目向低层次移动。</p>
<p>Fault：从低层拷贝一个对象到高层。在获取缓存的过程中，某一层发现自己的该缓存条目已经失效，就触发了Fault行为。</p>
<p>Eviction：把缓存条目除去。</p>
<p>Expiration：失效状态。</p>
<p>Pinning：强制缓存条目保持在某一层。</p>
<p>下面的图反映了数据在各个层之间的流转，也反映了数据的生命周期：</p>
<p><img src="" alt=""></p>
<p><strong>十、监控功能</strong>：</p>
<p>监控的拓扑：</p>
<p><img src="" alt="">
每个应用节点部署一个监控探针，通过TCP协议与监控服务器联系，最终将数据提供给富文本客户端或者监控操作服务器。</p>
<p><strong>十一、广域网复制</strong>：</p>
<p>缓存数据复制方面，Ehcache允许两个地理位置各异的节点在广域网下维持数据一致性，同时它提供了这样几种方案（注：下面的示例都只绘制了两个节点的情形，实际可以推广到N个节点）：</p>
<p>第一种方案：Terracotta Active/Mirror Replication。</p>
<p><img src="" alt="">
这种方案下，服务端包含一个活跃节点，一个备份节点；各个应用节点全部靠该活跃节点提供读写服务。这种方式最简单，管理容易；但是，需要寄希望于理想的网络状况，服务器之间和客户端到服务器之间都存在走WAN的情况，这样的方案其实最不稳定。</p>
<p>第二种方案：Transactional Cache Manager Replication。</p>
<p><img src="" alt="">
这种方案下，数据读取不需要经过WAN，写入数据时写入两份，分别由两个cache manager处理，一份在本地Server，一份到其他Server去。这种方案下读的吞吐量较高而且延迟较低；但是需要引入一个XA事务管理器，两个cache manager写两份数据导致写开销较大，而且过WAN的写延迟依然可能导致系统响应的瓶颈。</p>
<p>第三种方案：Messaging based (AMQ) replication。</p>
<p><img src="&quot;点击查看原始大小图片&quot;" alt="">
这种方案下，引入了批量处理和队列，用以减缓WAN的瓶颈出现，同时，把处理读请求和复制逻辑从Server Array物理上就剥离开，避免了WAN情况恶化对节点读取业务的影响。这种方案要较高的吞吐量和较低的延迟，读/复制的分离保证了可以提供完备的消息分发保证、冲突处理等特性；但是它较为复杂，而且还需要一个消息总线。</p>
<p>有一些Ehcache特性应用较少或者比较边缘化，没有提到，例如对于JMX的支持；还有一些则是有类似的特性和介绍了，例如对于WEB的支持，请参见我<a href="http://raychase.iteye.com/blog/1533153" target="_blank">这篇关于OSCache的解读</a>，其中的“web支持”一节有详细的原理分析。</p>
<p>最后，关于Ehcache的性能比对，下面这张图来自Ehcache的创始人<a href="http://gregluck.com/blog/archives/2007/05/comparing-memcached-and-ehcache-performance/" target="_blank">Greg Luck的blog</a>：</p>
<p><img src="" alt=""> </p>
<p>put/get上Ehcache要500-1000倍快过Memcached。原因何在？他自己分析道：“In-process caching and asynchronous replication are a clear performance winner”。有关它详细的内容还是请参阅他的blog吧。</p>
<p><strong>文章系本人原创，转载请注明出处和作者</strong></p>
<ul>
<li><a href=""><img src="&quot;点击查看原始大小图片&quot;" alt=""></a></li>
<li><p>大小: 45.2 KB</p>
</li>
<li><p><a href=""><img src="&quot;点击查看原始大小图片&quot;" alt=""></a></p>
</li>
<li><p>大小: 64 KB</p>
</li>
<li><p><a href=""><img src="&quot;点击查看原始大小图片&quot;" alt=""></a></p>
</li>
<li><p>大小: 42.4 KB</p>
</li>
<li><p><a href=""><img src="&quot;点击查看原始大小图片&quot;" alt=""></a></p>
</li>
<li><p>大小: 46.1 KB</p>
</li>
<li><p><a href=""><img src="&quot;点击查看原始大小图片&quot;" alt=""></a></p>
</li>
<li><p>大小: 22.4 KB</p>
</li>
<li><p><a href=""><img src="&quot;点击查看原始大小图片&quot;" alt=""></a></p>
</li>
<li><p>大小: 65.2 KB</p>
</li>
<li><p><a href=""><img src="&quot;点击查看原始大小图片&quot;" alt=""></a></p>
</li>
<li><p>大小: 85.1 KB</p>
</li>
<li><p><a href=""><img src="&quot;点击查看原始大小图片&quot;" alt=""></a></p>
</li>
<li><p>大小: 28.4 KB</p>
</li>
<li><p><a href=""><img src="&quot;点击查看原始大小图片&quot;" alt=""></a></p>
</li>
<li><p>大小: 34.7 KB</p>
</li>
<li><p><a href=""><img src="&quot;点击查看原始大小图片&quot;" alt=""></a></p>
</li>
<li><p>大小: 52.6 KB</p>
</li>
<li><p><a href=""><img src="&quot;点击查看原始大小图片&quot;" alt=""></a></p>
</li>
<li><p>大小: 90.1 KB</p>
</li>
<li><p><a href=""><img src="&quot;点击查看原始大小图片&quot;" alt=""></a></p>
</li>
<li><p>大小: 94.3 KB</p>
</li>
<li><p><a href=""><img src="&quot;点击查看原始大小图片&quot;" alt=""></a></p>
</li>
<li><p>大小: 132.2 KB</p>
</li>
<li><p><a href=""><img src="&quot;点击查看原始大小图片&quot;" alt=""></a></p>
</li>
<li><p>大小: 20.4 KB</p>
</li>
<li><p><a href="http://raychase.iteye.com/blog/1545906#" target="_blank">查看图片附件</a></p>
</li>
</ul>
<p><strong>5</strong>
顶</p>
<p><strong>2</strong>
踩</p>
<p>分享到： <a href="&quot;分享到新浪微博&quot;"><img src="" alt=""></a> <a href="&quot;分享到腾讯微博&quot;"><img src="" alt=""></a>
<a href="http://raychase.iteye.com/blog/1549570" title="设计一套缓存框架需要关注的要素" target="_blank">设计一套缓存框架需要关注的要素</a> | <a href="http://raychase.iteye.com/blog/1541627" title="“你不适合做程序员”" target="_blank">“你不适合做程序员”</a></p>
<ul>
<li>2012-05-31 17:44</li>
<li>浏览 1752</li>
<li><a href="http://raychase.iteye.com/blog/1545906#comments" target="_blank">评论(1)</a></li>
<li>分类:<a href="http://www.iteye.com/blogs/category/internet" target="_blank">互联网</a></li>
<li><a href="http://www.iteye.com/wiki/blog/1545906" target="_blank">相关推荐</a><h3 id="-">评论</h3>
</li>
</ul>
<p><a href=""></a></p>
<p>1 楼 <a href="http://mowengaobo.iteye.com/" title="mowengaobo" target="_blank">mowengaobo</a> 2012-07-10  </p>
<p>写得真不错，不过对 Greg Luck最后那张图表示怀疑。</p>
<h3 id="-">发表评论</h3>
<p><a href="http://raychase.iteye.com/login" target="_blank"><img src="" alt=""></a><a href="http://raychase.iteye.com/login" target="_blank">您还没有登录,请您登录后再发表评论</a></p>
<p><a href="http://raychase.iteye.com/" target="_blank"><img src="&quot;RayChase的博客: 四火的BLOG&quot;" alt="RayChase的博客"></a></p>
<p>RayChase</p>
<ul>
<li>浏览: 113254 次</li>
<li>性别: <img src="&quot;男&quot;" alt="Icon_minigender_1"></li>
<li>来自: 北京</li>
<li><img src="" alt=""><h3 id="-http-raychase-iteye-com-blog-user_visits-">最近访客 <a href="http://raychase.iteye.com/blog/user_visits" target="_blank">更多访客&gt;&gt;</a></h3>
</li>
</ul>
<p><a href="http://fudewei1.iteye.com/" target="_blank"><img src="&quot;fudewei1的博客: &quot;" alt="fudewei1的博客"></a></p>
<p><a href="http://fudewei1.iteye.com/" title="fudewei1" target="_blank">fudewei1</a></p>
<p><a href="http://hi00o.iteye.com/" target="_blank"><img src="&quot;hi00o的博客: &quot;" alt="hi00o的博客"></a></p>
<p><a href="http://hi00o.iteye.com/" title="hi00o" target="_blank">hi00o</a>
<a href="http://macrochen.iteye.com/" target="_blank"><img src="&quot;macrochen的博客: 疯狂的菠菜&quot;" alt="macrochen的博客"></a></p>
<p><a href="http://macrochen.iteye.com/" title="macrochen" target="_blank">macrochen</a></p>
<p><a href="http://dylinshi126.iteye.com/" target="_blank"><img src="&quot;dylinshi126的博客: &quot;" alt="dylinshi126的博客"></a></p>
<p><a href="http://dylinshi126.iteye.com/" title="dylinshi126" target="_blank">dylinshi126</a></p>
<h3 id="-">博客专栏</h3>
<p><a href="http://www.iteye.com/blogs/subjects/Core-J2EE-Pattern" target="_blank"><img src="" alt="1489d3fc-d068-34f7-9f25-23a663e958b1"></a> <a href="http://www.iteye.com/blogs/subjects/Core-J2EE-Pattern" title="J2EE 核心模式" target="_blank">J2EE 核心模式</a>
浏览量：16253 <a href="http://www.iteye.com/blogs/subjects/JS-Refactory" target="_blank"><img src="" alt="C976ce7b-2227-36df-bb1a-47f0139cc7ac"></a> <a href="http://www.iteye.com/blogs/subjects/JS-Refactory" title="JavaScript重构" target="_blank">JavaScript重构</a>
浏览量：12707</p>
<h3 id="-">文章分类</h3>
<ul>
<li><a href="http://raychase.iteye.com/" target="_blank">全部博客 (150)</a></li>
<li><a href="http://raychase.iteye.com/category/178240" target="_blank">Web UI (9)</a></li>
<li><a href="http://raychase.iteye.com/category/178244" target="_blank">Dynamic Language (7)</a></li>
<li><a href="http://raychase.iteye.com/category/178243" target="_blank">Framework (5)</a></li>
<li><a href="http://raychase.iteye.com/category/178249" target="_blank">Note &amp; Try (10)</a></li>
<li><a href="http://raychase.iteye.com/category/178250" target="_blank">JavaScript (27)</a></li>
<li><a href="http://raychase.iteye.com/category/178257" target="_blank">Ant/Gant/Maven (2)</a></li>
<li><a href="http://raychase.iteye.com/category/178262" target="_blank">Database (4)</a></li>
<li><a href="http://raychase.iteye.com/category/178263" target="_blank">Software Engineering (8)</a></li>
<li><a href="http://raychase.iteye.com/category/200349" target="_blank">Career (19)</a></li>
<li><a href="http://raychase.iteye.com/category/217121" target="_blank">Team Management (3)</a></li>
<li><a href="http://raychase.iteye.com/category/185968" target="_blank">Performance (9)</a></li>
<li><a href="http://raychase.iteye.com/category/199601" target="_blank">Algorithm (6)</a></li>
<li><a href="http://raychase.iteye.com/category/202095" target="_blank">News &amp; Commets (15)</a></li>
<li><a href="http://raychase.iteye.com/category/178259" target="_blank">System Design (14)</a></li>
<li><a href="http://raychase.iteye.com/category/217118" target="_blank">OO Design (8)</a></li>
<li><a href="http://raychase.iteye.com/category/217120" target="_blank">API Design (3)</a></li>
<li><a href="http://raychase.iteye.com/category/217119" target="_blank">Programming Paradigms (4)</a></li>
<li><a href="http://raychase.iteye.com/category/217122" target="_blank">Asynchronous Programming (4)</a></li>
<li><a href="http://raychase.iteye.com/category/217124" target="_blank">Architecture (4)</a></li>
</ul>
<h3 id="-">社区版块</h3>
<ul>
<li><a href="http://raychase.iteye.com/blog/news" target="_blank">我的资讯</a> (0)</li>
<li><a href="http://raychase.iteye.com/blog/post" target="_blank">我的论坛</a> (9)</li>
<li><p><a href="http://raychase.iteye.com/blog/answered_problems" target="_blank">我的问答</a> (1)</p>
<h3 id="-">存档分类</h3>
</li>
<li><p><a href="http://raychase.iteye.com/blog/monthblog/2012-10" target="_blank">2012-10</a> (4)</p>
</li>
<li><a href="http://raychase.iteye.com/blog/monthblog/2012-09" target="_blank">2012-09</a> (7)</li>
<li><a href="http://raychase.iteye.com/blog/monthblog/2012-08" target="_blank">2012-08</a> (3)</li>
<li><a href="http://raychase.iteye.com/blog/monthblog_more" target="_blank">更多存档...</a></li>
</ul>
<h3 id="-">评论排行榜</h3>
<ul>
<li><a href="http://raychase.iteye.com/blog/1450079" title="谈谈对程序员的培养" target="_blank">谈谈对程序员的培养</a></li>
<li><a href="http://raychase.iteye.com/blog/1340843" title="写在职业生涯的路口" target="_blank">写在职业生涯的路口</a></li>
<li><a href="http://raychase.iteye.com/blog/1325097" title="一些平安夜里的IT人" target="_blank">一些平安夜里的IT人</a></li>
<li><a href="http://raychase.iteye.com/blog/1486868" title="那些糟糕的面试和那些屎问题" target="_blank">那些糟糕的面试和那些屎问题</a></li>
<li><p><a href="http://raychase.iteye.com/blog/1689006" title="你真的精通Java吗？" target="_blank">你真的精通Java吗？</a></p>
<h3 id="-">最新评论</h3>
</li>
<li><p><a href="http://datadatawarehouse.iteye.com/" title="datawarehouse" target="_blank">datawarehouse</a>： wf_chn 写道没看到怎么个抢法 同意，不知道在说什么。
<a href="http://raychase.iteye.com/blog/1691863#bc2284161" target="_blank">如何在局域网内抢带宽</a></p>
</li>
<li><a href="http://ajavaloser.iteye.com/" title="wf_chn" target="_blank">wf_chn</a>： 没看到怎么个抢法
<a href="http://raychase.iteye.com/blog/1691863#bc2284147" target="_blank">如何在局域网内抢带宽</a></li>
<li><a href="http://muyishuihan.iteye.com/" title="muyishuihan" target="_blank">muyishuihan</a>： 尼玛，碉堡
<a href="http://raychase.iteye.com/blog/1689168#bc2284132" target="_blank">一些中文编程语言</a></li>
<li><a href="http://javaroom.iteye.com/" title="javaroom" target="_blank">javaroom</a>： 没别的意思，讨论嘛，各抒己见，对LZ的观点，我还是赞同的，奈何 ...
<a href="http://raychase.iteye.com/blog/1689006#bc2283982" target="_blank">你真的精通Java吗？</a></li>
<li><a href="http://anyasir.iteye.com/" title="anyasir" target="_blank">anyasir</a>： 不知道怎么说我就是从不写精通的大学主修java编程工作也三年多 ...
<a href="http://raychase.iteye.com/blog/1689006#bc2283974" target="_blank">你真的精通Java吗？</a>
声明：ITeye文章版权属于作者，受法律保护。没有作者书面许可不得转载。若作者同意转载，必须以超链接形式标明文章原始出处和作者。
© 2003-2012 ITeye.com. All rights reserved. [ 京ICP证110151号 京公网安备110105010620 ]
<img src="" alt=""></li>
</ul>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/缓存/">缓存</a></li></span><span class="breadcrumb"><li><a href="/categories/缓存/">缓存</a></li><li><a href="/categories/缓存/ehcache/">ehcache</a></li></span></span> | <span class="tags">Tagged <a href="/tags/ehcache/" class="label label-primary">ehcache</a><a href="/tags/缓存/" class="label label-success">缓存</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:39"datetime="2014-03-07 09:54:39"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-缓存-ehcache--Ehcache详细解读-四火的BLOG-ITeye技术网站/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-缓存-ehcache--Ehcache详细解读-四火的BLOG-ITeye技术网站" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-缓存-ehcache--EhCache小结--ITeye技术网站/">EhCache小结 </a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:39.000Z"> <a href="/2014/02/02/2014-02-02-缓存-ehcache--EhCache小结--ITeye技术网站/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="ehcache-iteye-">EhCache小结 - - ITeye技术网站</h1>
<p><a href="http://www.iteye.com/" target="_blank">首页</a> <a href="http://www.iteye.com/news" target="_blank">资讯</a> <a href="http://www.iteye.com/magazines" target="_blank">精华</a> <a href="http://www.iteye.com/forums" target="_blank">论坛</a> <a href="http://www.iteye.com/ask" target="_blank">问答</a> <a href="http://www.iteye.com/blogs" target="_blank">博客</a> <a href="http://www.iteye.com/blogs/subjects" target="_blank">专栏</a> <a href="http://www.iteye.com/groups" target="_blank">群组</a> <a href="http://nanguocoffee.iteye.com/blog/356324#" target="_blank">更多 ▼</a></p>
<p><a href="http://www.iteye.com/job" target="_blank">招聘</a> <a href="http://www.iteye.com/search" target="_blank">搜索</a></p>
<p><a href="http://nanguocoffee.iteye.com/login" title="登录" target="_blank">您还未登录 !</a> <a href="http://nanguocoffee.iteye.com/login" target="_blank">登录</a> <a href="http://nanguocoffee.iteye.com/signup" target="_blank">注册</a></p>
<h1 id="-nanguocoffee-http-nanguocoffee-iteye-com-"><a href="http://nanguocoffee.iteye.com/" target="_blank">nanguocoffee</a></h1>
<ul>
<li><a href="http://nanguocoffee.iteye.com/" target="_blank"><strong>博客</strong></a></li>
<li><a href="http://nanguocoffee.iteye.com/weibo" target="_blank">微博</a></li>
<li><a href="http://nanguocoffee.iteye.com/album" target="_blank">相册</a></li>
<li><a href="http://nanguocoffee.iteye.com/link" target="_blank">收藏</a></li>
<li><a href="http://nanguocoffee.iteye.com/blog/guest_book" target="_blank">留言</a></li>
<li><a href="http://nanguocoffee.iteye.com/blog/profile" target="_blank">关于我</a></li>
</ul>
<h3 id="-ehcache-"><a href="">EhCache小结</a> **</h3>
<p><strong>博客分类：</strong></p>
<ul>
<li><a href="http://nanguocoffee.iteye.com/category/60003" target="_blank">缓存</a>
<a href="http://www.iteye.com/blogs/tag/Cache" target="_blank">Cache</a><a href="http://www.iteye.com/blogs/tag/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84" target="_blank">数据结构</a><a href="http://www.iteye.com/blogs/tag/%E7%AE%97%E6%B3%95" target="_blank">算法</a><a href="http://www.iteye.com/blogs/tag/%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86" target="_blank">配置管理</a><a href="http://www.iteye.com/blogs/tag/Hibernate" target="_blank">Hibernate</a> </li>
</ul>
<p>一：接口和类的作用：
Elemenet：
key
value
lastAccessTime
hitCount
等描述cache中元素的信息。
Store: 实际上存放Element的对象，Cache针对对象的操作一般都委托Store对象。</p>
<ul>
<li>MemoryStore： 继承该类来实现自定义MemoryStore。该类存放数据时，先使用Map存放数据，然后再判断是否超出容量。
put()
doPut() // 用来清理元素
-LruMemoryStore.java  使用 LinkedHashMap的子类，doput（）为空，因为该map的实现中的removeEldestEntry方法清理了超出容量的元素。
-LfuMemoryStore.java  使用HashMap
-FifoMemoryStore.java 使用LinkedHashMap  这里用队列应该更快吧？？源码中还需要遍历map。
-DiskStore：
其实diskStore也是用一个hashmap来存放数据，只有显式的调用flush（）方法的时候才判断是否要将元素写入文件中。
CacheManager 来管理 Cache ；
Cache用来操作Element，Cache是抽象出来的逻辑概念，其 内部使用Store来处理Element
Element就是数据描述缓存对象的基本信息。
Store是保管缓存对象的仓库，这个仓库分Memory和Disk两种。
EHCache中的EventListener是针对分布式的，普通的应用可以不用考虑。
二：一些功能细节：
1：超出设定的元素容量的解决方法
MemoryStore：
When an element is added to a cache and it goes beyond its maximum memory size,
an existing element is either deleted, if overflowToDisk is false, or evaluated for spooling to disk,
if overflowToDisk is true. In the latter case, a check for expiry is carried out. If it is expired it is deleted; if not it is spooled.
判断元素是否过期，MemoryStore有3种策略可选，LRU，LFU，FIFO，默认为LRU。
DiskStore：
使用LFU，DiskStore使用一个守护线程，DiskStore.SpoolAndExpiryThread内部类来定时检查diskStore中的元素，
定时刷新到文件中，如果遇到过期的元素则移除。
2：元素存活时间到期
MemoryStore：
在get（）和超出容量的时候才判断是否过期
DiskStore：
只有在flush的时候才判断是否过期，如果过期则移除。
也就是说，这两种方式，不论在文件或者内存中，都会依然存在过期的元素，
这些元算可能永远存在，但不影响我们的操作，因为我们get（）或者超出容量的时候都会判断是否过期并清除。
三：初始化
CacheManager cacheManager = new CacheManager();
调用protected void init(Configuration configuration, String configurationFileName, URL configurationURL,   InputStream configurationInputStream) 方法进行初始化。
1：解析配置信息：
1.1 查找ehcache.xml文件，如果找不到则使用默认的ehcache-failsafe.xml，返回一个URL对象。
1.2 调用ConfigurationFactory.parseConfiguration(input) 方法来进行解析。返回Configuration对象。
Configuration的数据结构：
  private DiskStoreConfiguration diskStoreConfiguration;
  private CacheConfiguration defaultCacheConfiguration;
  private List<FactoryConfiguration> cacheManagerPeerProviderFactoryConfiguration = new ArrayList<FactoryConfiguration>();
  private List<FactoryConfiguration> cacheManagerPeerListenerFactoryConfiguration = new ArrayList<FactoryConfiguration>();
  private FactoryConfiguration cacheManagerEventListenerFactoryConfiguration;
  private final Map cacheConfigurations = new HashMap();
  private String configurationSource;
该数据结构是针对xml定义来的，其中最复杂也最常用的算是CacheConfiguration，其内部结构也很简单。
cacheConfigurations存放多个CacheConfiguration。
2：根据Configuration进行CacheManager，Cache，Store等数据结构的初始化。
总结：
EHCache是一款比较简单的开源缓存产品，但也存在一些不足之处：
比如：
1：CacheManager和Cache这个具体类耦合，当然也提供了针对EHCache接口的方法，如果使用自定义的Cache的话容易混淆方法。
2：针对不同的Cache类，我们希望指定不同的MemoryStore实现、DiskStore实现，EHCache只提供了通过程序来达到这一功能，
没有提供通过配置文件来提供(类似于Hibernate配置文件中CacheProvider，JDBC  dialect 等)。
3：有些算法实现得不算好，比如FifoMemoryStore.java中的清理元素算法选择的数据结构不够快速。
分享到： <a href="&quot;分享到新浪微博&quot;"><img src="" alt=""></a> <a href="&quot;分享到腾讯微博&quot;"><img src="" alt=""></a></li>
</ul>
<p><a href="http://nanguocoffee.iteye.com/blog/467199" title="JForum源码学习研究1-起步" target="_blank">JForum源码学习研究1-起步</a> | <a href="http://nanguocoffee.iteye.com/blog/356322" title="EhCache入门" target="_blank">EhCache入门</a></p>
<ul>
<li>2009-03-27 18:34</li>
<li>浏览 1010</li>
<li><a href="http://nanguocoffee.iteye.com/blog/356324#comments" target="_blank">评论(0)</a></li>
<li><a href="http://www.iteye.com/wiki/blog/356324" target="_blank">相关推荐</a></li>
</ul>
<h3 id="-">评论</h3>
<p><a href=""></a></p>
<h3 id="-">发表评论</h3>
<p><a href="http://nanguocoffee.iteye.com/login" target="_blank"><img src="" alt=""></a><a href="http://nanguocoffee.iteye.com/login" target="_blank">您还没有登录,请您登录后再发表评论</a></p>
<p><a href="http://nanguocoffee.iteye.com/" target="_blank"><img src="&quot;NanguoCoffee的博客: &quot;" alt="NanguoCoffee的博客"></a></p>
<p>NanguoCoffee</p>
<ul>
<li>浏览: 10206 次</li>
<li>性别: <img src="&quot;男&quot;" alt="Icon_minigender_1"></li>
<li>来自: 北京</li>
<li><img src="" alt=""><h3 id="-http-nanguocoffee-iteye-com-blog-user_visits-">最近访客 <a href="http://nanguocoffee.iteye.com/blog/user_visits" target="_blank">更多访客&gt;&gt;</a></h3>
</li>
</ul>
<p><a href="http://bingki.iteye.com/" target="_blank"><img src="&quot;bingki的博客: 我的IT生活...&quot;" alt="bingki的博客"></a></p>
<p><a href="http://bingki.iteye.com/" title="bingki" target="_blank">bingki</a></p>
<p><a href="http://turandot.iteye.com/" target="_blank"><img src="&quot;Turandot的博客: &quot;" alt="Turandot的博客"></a></p>
<p><a href="http://turandot.iteye.com/" title="Turandot" target="_blank">Turandot</a>
<a href="http://dylinshi126.iteye.com/" target="_blank"><img src="&quot;dylinshi126的博客: &quot;" alt="dylinshi126的博客"></a></p>
<p><a href="http://dylinshi126.iteye.com/" title="dylinshi126" target="_blank">dylinshi126</a></p>
<p><a href="http://luwies.iteye.com/" target="_blank"><img src="&quot;luwies的博客: &quot;" alt="luwies的博客"></a></p>
<p><a href="http://luwies.iteye.com/" title="luwies" target="_blank">luwies</a></p>
<h3 id="-">文章分类</h3>
<ul>
<li><a href="http://nanguocoffee.iteye.com/" target="_blank">全部博客 (23)</a></li>
<li><a href="http://nanguocoffee.iteye.com/category/60003" target="_blank">缓存 (2)</a></li>
<li><a href="http://nanguocoffee.iteye.com/category/79080" target="_blank">JForum (3)</a></li>
<li><a href="http://nanguocoffee.iteye.com/category/121602" target="_blank">Java IO (3)</a></li>
<li><a href="http://nanguocoffee.iteye.com/category/121603" target="_blank">其他 (7)</a></li>
<li><a href="http://nanguocoffee.iteye.com/category/121996" target="_blank">Java 多线程 (1)</a></li>
<li><a href="http://nanguocoffee.iteye.com/category/132461" target="_blank">性能优化 (1)</a></li>
<li><a href="http://nanguocoffee.iteye.com/category/132820" target="_blank">Oracle (1)</a></li>
<li><p><a href="http://nanguocoffee.iteye.com/category/137742" target="_blank">编码相关 (6)</a></p>
<h3 id="-">社区版块</h3>
</li>
<li><p><a href="http://nanguocoffee.iteye.com/blog/news" target="_blank">我的资讯</a> (0)</p>
</li>
<li><a href="http://nanguocoffee.iteye.com/blog/post" target="_blank">我的论坛</a> (118)</li>
<li><a href="http://nanguocoffee.iteye.com/blog/answered_problems" target="_blank">我的问答</a> (18)</li>
</ul>
<h3 id="-">存档分类</h3>
<ul>
<li><a href="http://nanguocoffee.iteye.com/blog/monthblog/2011-02" target="_blank">2011-02</a> (1)</li>
<li><a href="http://nanguocoffee.iteye.com/blog/monthblog/2011-01" target="_blank">2011-01</a> (1)</li>
<li><a href="http://nanguocoffee.iteye.com/blog/monthblog/2010-12" target="_blank">2010-12</a> (6)</li>
<li><p><a href="http://nanguocoffee.iteye.com/blog/monthblog_more" target="_blank">更多存档...</a></p>
<h3 id="-">最新评论</h3>
</li>
<li><p><a href="http://nanguocoffee.iteye.com/" title="NanguoCoffee" target="_blank">NanguoCoffee</a>： javantsky 写道楼主为什么要自己实现分离锁呢？ jav ...
<a href="http://nanguocoffee.iteye.com/blog/907824#bc1905975" target="_blank">知道为啥HashMap里面的数组size必须是2的次幂？</a></p>
</li>
<li><a href="http://javantsky.iteye.com/" title="javantsky" target="_blank">javantsky</a>： 楼主为什么要自己实现分离锁呢？java.util.concur ...
<a href="http://nanguocoffee.iteye.com/blog/907824#bc1905933" target="_blank">知道为啥HashMap里面的数组size必须是2的次幂？</a></li>
<li><a href="http://obullxl.iteye.com/" title="obullxl" target="_blank">obullxl</a>： LZ分析有道理，最后的&amp;操作，（LOCK_NUM - ...
<a href="http://nanguocoffee.iteye.com/blog/907824#bc1905828" target="_blank">知道为啥HashMap里面的数组size必须是2的次幂？</a></li>
<li><a href="http://nanguocoffee.iteye.com/" title="NanguoCoffee" target="_blank">NanguoCoffee</a>： sniffer123 写道LZ你自己的写法有问题啊。。跟HAS ...
<a href="http://nanguocoffee.iteye.com/blog/907824#bc1905087" target="_blank">知道为啥HashMap里面的数组size必须是2的次幂？</a></li>
<li><a href="http://sniffer123.iteye.com/" title="sniffer123" target="_blank">sniffer123</a>： LZ你自己的写法有问题啊。。跟HASH是不是 2的幂一点关系也 ...
<a href="http://nanguocoffee.iteye.com/blog/907824#bc1905063" target="_blank">知道为啥HashMap里面的数组size必须是2的次幂？</a>
声明：ITeye文章版权属于作者，受法律保护。没有作者书面许可不得转载。若作者同意转载，必须以超链接形式标明文章原始出处和作者。
© 2003-2012 ITeye.com. All rights reserved. [ 京ICP证110151号 京公网安备110105010620 ]
<img src="" alt=""></li>
</ul>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/缓存/">缓存</a></li></span><span class="breadcrumb"><li><a href="/categories/缓存/">缓存</a></li><li><a href="/categories/缓存/ehcache/">ehcache</a></li></span></span> | <span class="tags">Tagged <a href="/tags/ehcache/" class="label label-primary">ehcache</a><a href="/tags/缓存/" class="label label-success">缓存</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:39"datetime="2014-03-07 09:54:39"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-缓存-ehcache--EhCache小结--ITeye技术网站/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-缓存-ehcache--EhCache小结--ITeye技术网站" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-缓存-ehcache--EHCache的使用教程-黑神领主的博客-dev26com/">EHCache的使用教程</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:39.000Z"> <a href="/2014/02/02/2014-02-02-缓存-ehcache--EHCache的使用教程-黑神领主的博客-dev26com/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="ehcache-dev26-com">EHCache的使用教程-黑神领主的博客-dev26.com</h1>
<h3 id="-">分享到</h3>
<ul>
<li><a href="http://www.dev26.com/blog/article/352/1#" target="_blank">QQ空间</a></li>
<li><a href="http://www.dev26.com/blog/article/352/1#" target="_blank">新浪微博</a></li>
<li><a href="http://www.dev26.com/blog/article/352/1#" target="_blank">百度搜藏</a></li>
<li><a href="http://www.dev26.com/blog/article/352/1#" target="_blank">人人网</a></li>
<li><a href="http://www.dev26.com/blog/article/352/1#" target="_blank">腾讯微博</a></li>
<li><a href="http://www.dev26.com/blog/article/352/1#" target="_blank">开心网</a></li>
<li><a href="http://www.dev26.com/blog/article/352/1#" target="_blank">腾讯朋友</a></li>
<li><a href="http://www.dev26.com/blog/article/352/1#" target="_blank">更多...</a></li>
</ul>
<p><a href="http://www.dev26.com/blog/article/352/1#" target="_blank">百度分享</a></p>
<p><a href="http://www.dev26.com/blog/article/352/1#" target="_blank">首页</a>|<a href="http://www.dev26.com/blog/article/352/1#" target="_blank">文章</a>|<a href="http://www.dev26.com/blog/article/352/1#" target="_blank">博客</a>|<a href="http://www.dev26.com/blog/article/352/1#" target="_blank">开源</a></p>
<h1 id="www-dev26-com">www.dev26.com</h1>
<h2 id="-web-">黑神领主的Web开发站博客</h2>
<p>在 文章 博客 开源 论坛 中检索</p>
<h3 id="-">个人资料</h3>
<p><a href="http://www.dev26.com/blog/start/undead" target="_blank"><img src="" alt="黑神领主"></a></p>
<p>这家伙很懒，什么都没有留下……</p>
<p>等级: <img src="&quot;等级：20&quot;" alt="20"></p>
<p>加入时间:2011-12-05 22:36</p>
<p><a href="http://www.dev26.com/blog/article/352/1#inline1" target="_blank">发送消息</a></p>
<h3 id="-">操作中心</h3>
<ul>
<li><a href="&quot;我的博客&quot;">我的博客</a></li>
<li><a href="http://www.dev26.com/bbs/topic/focus/1" title="我关注的话题" target="_blank">我关注的话题</a></li>
<li>新闻投递</li>
<li><a href="http://www.dev26.com/manage/home/start" target="_blank">管理</a></li>
<li><a href="http://www.dev26.com/manage/blog/edit" target="_blank">发表文章</a></li>
<li><p><a href="">安全退出</a></p>
<h3 id="-">操作中心</h3>
</li>
<li><p><a href="http://www.dev26.com/login" target="_blank">登录</a></p>
</li>
<li><a href="http://www.dev26.com/runtime/register" target="_blank">注册</a></li>
</ul>
<h3 id="-http-www-dev26-com-blog-start-undead-http-www-dev26-com-rss-blog-username-undead-"><a href="http://www.dev26.com/blog/start/undead" target="_blank">所有文章</a> <a href="http://www.dev26.com/rss/blog?username=undead" target="_blank"><img src="&quot;订阅&quot;" alt=""></a></h3>
<ul>
<li><a href="http://www.dev26.com/blog/category/32" target="_blank">JDK基础</a></li>
<li><a href="http://www.dev26.com/blog/category/33" target="_blank">html5</a></li>
<li><a href="http://www.dev26.com/blog/category/35" target="_blank">javascript</a></li>
<li><a href="http://www.dev26.com/blog/category/5" target="_blank">我的JavaEE</a></li>
<li><a href="http://www.dev26.com/blog/category/6" target="_blank">我的博客</a></li>
<li><p><a href="http://www.dev26.com/blog/category/34" target="_blank">数据结构</a></p>
<h3 id="-">最新发表&gt;&gt;</h3>
</li>
<li><p><a href="http://www.dev26.com/blog/article/622/1" title="javascript中使用mvc" target="_blank">javascript中使用mvc</a></p>
</li>
<li><a href="http://www.dev26.com/blog/article/621/1" title="java实现二级域名" target="_blank">java实现二级域名</a></li>
<li><a href="http://www.dev26.com/blog/article/620/1" title="java Annotation注解知识" target="_blank">java Annotation注解知识</a></li>
<li><a href="http://www.dev26.com/blog/article/618/1" title="inner join,left join,right join,full join 的区别说明" target="_blank">inner join,left join,right join,full join 的区别说明</a></li>
<li><a href="http://www.dev26.com/blog/article/617/1" title="REST的概念是什么" target="_blank">REST的概念是什么</a></li>
</ul>
<h3 id="-">最新评论&gt;&gt;</h3>
<p><a href="http://www.dev26.com/blog/article.htm?articleId=558&amp;tmp=1#comments">你好，能不能把示例代码和xml发给我，我研究下自定义类，我这里用起来有点问题。谢谢
jiangdk85@126.com</a></p>
<p><a href="http://www.dev26.com/blog/article.htm?articleId=113&amp;tmp=1#comments" target="_blank">上面的代码找不到ResourceDetailsBuilder这个类</a>
<a href="http://www.dev26.com/blog/article.htm?articleId=113&amp;tmp=1#comments" target="_blank">上面已经是源码了哟，只是没有JAR包而已，你下载一下吧</a></p>
<p><a href="http://www.dev26.com/blog/article.htm?articleId=113&amp;tmp=1#comments" target="_blank">大大共享下源码可以么？</a>
<a href="http://www.dev26.com/blog/article.htm?articleId=113&amp;tmp=1#comments" target="_blank">是内存中的权限缓存，这样设置的权限可以即时生效</a>
-</p>
<h3 id="ehcache-">EHCache的使用教程</h3>
<p>发表于2012-06-08 19:19 | 阅读 218 | 1人对此综合评价 <img src="&quot;5分&quot;" alt="5分"></p>
<p>开发高并发量，高性能的网站应用系统时，缓存Cache起到了非常重要的作用。本文主要介绍EHCache的使用，以及使用EHCache的实践经验。
笔者使用过多种基于Java的开源Cache组件，其中包括OSCache、JBossCache、EHCache。OSCache功能强大，使用灵活，可用于对象缓存、Filter缓存以及在JSP中直接使用cache标签。笔者在最近的使用过程中发现，在并发量较高时，OSCache会出现线程阻塞和数据错误，通过分析源代码发现是其内部实现的缺陷。JBossCache最大的优点是支持基于对象属性的集群同步，不过JBossCache的配置使用都较复杂，在并发量较高的情况下，对象属性数据在集群中同步也会加大系统的开销。以上两种Cache本文仅作简单介绍，不做深入探讨。
EHCache是来自sourceforge（<a href="http://ehcache.sourceforge.net/" target="_blank"><a href="http://ehcache.sourceforge.net/">http://ehcache.sourceforge.net/</a></a>）的开源项目，也是纯Java实现的简单、快速的Cache组件。EHCache支持内存和磁盘的缓存，支持LRU、LFU和FIFO多种淘汰算法，支持分布式的Cache，可以作为Hibernate的缓存插件。同时它也能提供基于Filter的Cache，该Filter可以缓存响应的内容并采用Gzip压缩提高响应速度。</p>
<p> EHCache API的基本用法
首先介绍CacheManager类。它主要负责读取配置文件，默认读取CLASSPATH下的ehcache.xml，根据配置文件创建并管理Cache对象。
1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12
13</p>
<p>14
15</p>
<p>16
// 使用默认配置文件创建CacheManager</p>
<p>CacheManager manager = CacheManager.create();
// 通过manager可以生成指定名称的Cache对象</p>
<p>Cache cache = cache = manager.getCache(</p>
<p>&quot;demoCache&quot;</p>
<p>);
// 使用manager移除指定名称的Cache对象</p>
<p>manager.removeCache(</p>
<p>&quot;demoCache&quot;</p>
<p>);
可以通过调用manager.removalAll()来移除所有的Cache。通过调用manager的shutdown()方法可以关闭CacheManager。</p>
<p>有了Cache对象之后就可以进行一些基本的Cache操作，例如：
//往cache中添加元素</p>
<p>Element element =</p>
<p>new</p>
<p>Element(</p>
<p>&quot;key&quot;</p>
<p>,</p>
<p>&quot;value&quot;</p>
<p>);
cache.put(element);</p>
<p>//从cache中取回元素
Element element = cache.get(</p>
<p>&quot;key&quot;</p>
<p>);</p>
<p>element.getValue();
//从Cache中移除一个元素</p>
<p>cache.remove(</p>
<p>&quot;key&quot;</p>
<p>);</p>
<p>可以直接使用上面的API进行数据对象的缓存，这里需要注意的是对于缓存的对象都是必须可序列化的。在下面的篇幅中笔者还会介绍EHCache和Spring、Hibernate的整合使用。</p>
<p> 配置文件
配置文件ehcache.xml中命名为demoCache的缓存配置：
1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7&lt;</p>
<p>cache</p>
<p>name</p>
<p>=</p>
<p>&quot;demoCache&quot;</p>
<p>maxElementsInMemory</p>
<p>=</p>
<p>&quot;10000&quot;
eternal</p>
<p>=</p>
<p>&quot;false&quot;</p>
<p>overflowToDisk</p>
<p>=</p>
<p>&quot;true&quot;
timeToIdleSeconds</p>
<p>=</p>
<p>&quot;300&quot;</p>
<p>timeToLiveSeconds</p>
<p>=</p>
<p>&quot;600&quot;
memoryStoreEvictionPolicy</p>
<p>=</p>
<p>&quot;LFU&quot;</p>
<p>/&gt;</p>
<p>各配置参数的含义：
maxElementsInMemory：缓存中允许创建的最大对象数
eternal：缓存中对象是否为永久的，如果是，超时设置将被忽略，对象从不过期。
timeToIdleSeconds：缓存数据的钝化时间，也就是在一个元素消亡之前，两次访问时间的最大时间间隔值，这只能在元素不是永久驻留时有效，如果该值是 0 就意味着元素可以停顿无穷长的时间。
timeToLiveSeconds：缓存数据的生存时间，也就是一个元素从构建到消亡的最大时间间隔值，这只能在元素不是永久驻留时有效，如果该值是0就意味着元素可以停顿无穷长的时间。
overflowToDisk：内存不足时，是否启用磁盘缓存。
memoryStoreEvictionPolicy：缓存满了之后的淘汰算法。LRU和FIFO算法这里就不做介绍。LFU算法直接淘汰使用比较少的对象，在内存保留的都是一些经常访问的对象。对于大部分网站项目，该算法比较适用。
如果应用需要配置多个不同命名并采用不同参数的Cache，可以相应修改配置文件，增加需要的Cache配置即可。</p>
<p> 利用Spring APO整合EHCache
首先，在CLASSPATH下面放置ehcache.xml配置文件。在Spring的配置文件中先添加如下cacheManager配置：
1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10</p>
<bean id=

"cacheManager"

class=

"org.springframework.cache.ehcache.EhCacheManagerFactoryBean"

>
</bean>

<p>配置demoCache：</p>
<bean id=

"demoCache"

class=

"org.springframework.cache.ehcache.EhCacheFactoryBean"

>

<property name=

"cacheManager"

ref=

"cacheManager"

/>
<property name=

"cacheName"

>

<value>demoCache</value>
</property>

</bean>

<p>接下来，写一个实现org.aopalliance.intercept.MethodInterceptor接口的拦截器类。有了拦截器就可以有选择性的配置想要缓存的 bean 方法。如果被调用的方法配置为可缓存，拦截器将为该方法生成 cache key 并检查该方法返回的结果是否已缓存。如果已缓存，就返回缓存的结果，否则再次执行被拦截的方法，并缓存结果供下次调用。具体代码如下：</p>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12
13</p>
<p>14
15</p>
<p>16
17</p>
<p>18
19</p>
<p>20
21</p>
<p>22
23</p>
<p>24
25</p>
<p>26
27</p>
<p>28
29</p>
<p>30
31</p>
<p>32
33</p>
<p>34
35</p>
<p>36
37</p>
<p>38
39</p>
<p>40
41</p>
<p>42
43</p>
<p>44
public</p>
<p>class</p>
<p>MethodCacheInterceptor</p>
<p>implements</p>
<p>MethodInterceptor,</p>
<p>InitializingBean {
private</p>
<p>Cache cache;</p>
<p>public</p>
<p>void</p>
<p>setCache(Cache cache) {</p>
<p>this</p>
<p>.cache = cache;
}</p>
<p>public</p>
<p>void</p>
<p>afterPropertiesSet()</p>
<p>throws</p>
<p>Exception {</p>
<p>Assert.notNull(cache,
&quot;A cache is required. Use setCache(Cache) to provide one.&quot;</p>
<p>);</p>
<p>}</p>
<p>public</p>
<p>Object invoke(MethodInvocation invocation)</p>
<p>throws</p>
<p>Throwable {
String targetName = invocation.getThis().getClass().getName();</p>
<p>String methodName = invocation.getMethod().getName();
Object[] arguments = invocation.getArguments();</p>
<p>Object result;
String cacheKey = getCacheKey(targetName, methodName, arguments);</p>
<p>Element element =</p>
<p>null</p>
<p>;
synchronized</p>
<p>(</p>
<p>this</p>
<p>){</p>
<p>element = cache.get(cacheKey);
if</p>
<p>(element ==</p>
<p>null</p>
<p>) {</p>
<p>//调用实际的方法
result = invocation.proceed();</p>
<p>element =</p>
<p>new</p>
<p>Element(cacheKey, (Serializable) result);
cache.put(element);</p>
<p>}
}</p>
<p>return</p>
<p>element.getValue();
}</p>
<p>private</p>
<p>String getCacheKey(String targetName, String methodName,</p>
<p>Object[] arguments) {
StringBuffer sb =</p>
<p>new</p>
<p>StringBuffer();</p>
<p>sb.append(targetName).append(</p>
<p>&quot;.&quot;</p>
<p>).append(methodName);
if</p>
<p>((arguments !=</p>
<p>null</p>
<p>) &amp;&amp; (arguments.length !=</p>
<p>0</p>
<p>)) {</p>
<p>for</p>
<p>(</p>
<p>int</p>
<p>i =</p>
<p>0</p>
<p>; i &lt; arguments.length; i++) {
sb.append(</p>
<p>&quot;.&quot;</p>
<p>).append(arguments[i]);</p>
<p>}
}</p>
<p>return</p>
<p>sb.toString();
}</p>
<p>}</p>
<p>synchronized (this)这段代码实现了同步功能。为什么一定要同步？Cache对象本身的get和put操作是同步的。如果我们缓存的数据来自数据库查询，在没有这段同步代码时，当key不存在或者key对应的对象已经过期时，在多线程并发访问的情况下，许多线程都会重新执行该方法，由于对数据库进行重新查询代价是比较昂贵的，而在瞬间大量的并发查询，会对数据库服务器造成非常大的压力。所以这里的同步代码是很重要的。</p>
<p>接下来，继续完成拦截器和Bean的配置：
1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12
13</p>
<p>14
15&lt;</p>
<p>bean</p>
<p>id</p>
<p>=</p>
<p>&quot;methodCacheInterceptor&quot;</p>
<p>class</p>
<p>=</p>
<p>&quot;com.xiebing.utils.interceptor.MethodCacheInterceptor&quot;</p>
<p>&gt;</p>
<p>&lt;</p>
<p>property</p>
<p>name</p>
<p>=</p>
<p>&quot;cache&quot;</p>
<p>&gt;
&lt;</p>
<p>ref</p>
<p>local</p>
<p>=</p>
<p>&quot;demoCache&quot;</p>
<p>/&gt;</p>
<p>&lt;/</p>
<p>property</p>
<p>&gt;
&lt;/</p>
<p>bean</p>
<p>&gt;</p>
<p>&lt;</p>
<p>bean</p>
<p>id</p>
<p>=</p>
<p>&quot;methodCachePointCut&quot;</p>
<p>class</p>
<p>=</p>
<p>&quot;org.springframework.aop.support.RegexpMethodPointcutAdvisor&quot;</p>
<p>&gt;
&lt;</p>
<p>property</p>
<p>name</p>
<p>=</p>
<p>&quot;advice&quot;</p>
<p>&gt;</p>
<p>&lt;</p>
<p>ref</p>
<p>local</p>
<p>=</p>
<p>&quot;methodCacheInterceptor&quot;</p>
<p>/&gt;
&lt;/</p>
<p>property</p>
<p>&gt;</p>
<p>&lt;</p>
<p>property</p>
<p>name</p>
<p>=</p>
<p>&quot;patterns&quot;</p>
<p>&gt;
&lt;</p>
<p>list</p>
<p>&gt;</p>
<p>&lt;</p>
<p>value</p>
<blockquote>
<p>./*myMethod&lt;/</p>
</blockquote>
<p>value</p>
<p>&gt;
&lt;/</p>
<p>list</p>
<p>&gt;</p>
<p>&lt;/</p>
<p>property</p>
<p>&gt;
&lt;/</p>
<p>bean</p>
<p>&gt;</p>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12
13&lt;</p>
<p>bean</p>
<p>id</p>
<p>=</p>
<p>&quot;myServiceBean&quot;</p>
<p>class</p>
<p>=</p>
<p>&quot;com.xiebing.ehcache.spring.MyServiceBean&quot;</p>
<p>&gt;
&lt;/</p>
<p>bean</p>
<p>&gt;</p>
<p>&lt;</p>
<p>bean</p>
<p>id</p>
<p>=</p>
<p>&quot;myService&quot;</p>
<p>class</p>
<p>=</p>
<p>&quot;org.springframework.aop.framework.ProxyFactoryBean&quot;</p>
<p>&gt;
&lt;</p>
<p>property</p>
<p>name</p>
<p>=</p>
<p>&quot;target&quot;</p>
<p>&gt;</p>
<p>&lt;</p>
<p>ref</p>
<p>local</p>
<p>=</p>
<p>&quot;myServiceBean&quot;</p>
<p>/&gt;
&lt;/</p>
<p>property</p>
<p>&gt;</p>
<p>&lt;</p>
<p>property</p>
<p>name</p>
<p>=</p>
<p>&quot;interceptorNames&quot;</p>
<p>&gt;
&lt;</p>
<p>list</p>
<p>&gt;</p>
<p>&lt;</p>
<p>value</p>
<blockquote>
<p>methodCachePointCut&lt;/</p>
</blockquote>
<p>value</p>
<p>&gt;
&lt;/</p>
<p>list</p>
<p>&gt;</p>
<p>&lt;/</p>
<p>property</p>
<p>&gt;
&lt;/</p>
<p>bean</p>
<p>&gt;</p>
<p>其中myServiceBean是实现了业务逻辑的Bean，里面的方法myMethod()的返回结果需要被缓存。这样每次对myServiceBean的myMethod()方法进行调用,都会首先从缓存中查找,其次才会查询数据库。使用AOP的方式极大地提高了系统的灵活性，通过修改配置文件就可以实现对方法结果的缓存，所有的对Cache的操作都封装在了拦截器的实现中。</p>
<p> CachingFilter功能
使用Spring的AOP进行整合，可以灵活的对方法的的返回结果对象进行缓存。CachingFilter功能可以对HTTP响应的内容进行缓存。这种方式缓存数据的粒度比较粗，例如缓存整张页面。它的优点是使用简单、效率高，缺点是不够灵活，可重用程度不高。
EHCache使用SimplePageCachingFilter类实现Filter缓存。该类继承自CachingFilter，有默认产生cache key的calculateKey()方法，该方法使用HTTP请求的URI和查询条件来组成key。也可以自己实现一个Filter，同样继承CachingFilter类,然后覆写calculateKey()方法，生成自定义的key。
在笔者参与的项目中很多页面都使用AJAX，为保证JS请求的数据不被浏览器缓存，每次请求都会带有一个随机数参数i。如果使用SimplePageCachingFilter，那么每次生成的key都不一样，缓存就没有意义了。这种情况下，我们就会覆写calculateKey()方法。</p>
<p>要使用SimplePageCachingFilter，首先在配置文件ehcache.xml中，增加下面的配置：
1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12
&lt;</p>
<p>cache</p>
<p>name</p>
<p>=</p>
<p>&quot;SimplePageCachingFilter&quot;</p>
<p>maxElementsInMemory</p>
<p>=</p>
<p>&quot;10000&quot;</p>
<p>eternal</p>
<p>=</p>
<p>&quot;false&quot;</p>
<p>overflowToDisk</p>
<p>=</p>
<p>&quot;false&quot;</p>
<p>timeToIdleSeconds</p>
<p>=</p>
<p>&quot;300&quot;</p>
<p>timeToLiveSeconds</p>
<p>=</p>
<p>&quot;600&quot;
memoryStoreEvictionPolicy</p>
<p>=</p>
<p>&quot;LFU&quot;</p>
<p>/&gt;</p>
<p>其中name属性必须为SimplePageCachingFilter，修改web.xml文件，增加一个Filter的配置：
&lt;</p>
<p>filter</p>
<p>&gt;</p>
<p>&lt;</p>
<p>filter-name</p>
<blockquote>
<p>SimplePageCachingFilter&lt;/</p>
</blockquote>
<p>filter-name</p>
<p>&gt;
&lt;</p>
<p>filter-class</p>
<blockquote>
<p>net.sf.ehcache.constructs.web.filter.SimplePageCachingFilter&lt;/</p>
</blockquote>
<p>filter-class</p>
<p>&gt;</p>
<p>&lt;/</p>
<p>filter</p>
<p>&gt;
&lt;</p>
<p>filter-mapping</p>
<p>&gt;</p>
<p>&lt;</p>
<p>filter-name</p>
<blockquote>
<p>SimplePageCachingFilter&lt;/</p>
</blockquote>
<p>filter-name</p>
<p>&gt;
&lt;</p>
<p>url-pattern</p>
<blockquote>
<p>/test.jsp&lt;/</p>
</blockquote>
<p>url-pattern</p>
<p>&gt;</p>
<p>&lt;/</p>
<p>filter-mapping</p>
<p>&gt;</p>
<p>下面我们写一个简单的test.jsp文件进行测试，缓存后的页面每次刷新，在600秒内显示的时间都不会发生变化的。代码如下：</p>
<p>1</p>
<p>2
3&lt;%</p>
<p>out.println(</p>
<p>new</p>
<p>Date());
%&gt;</p>
<p>CachingFilter输出的数据会根据浏览器发送的Accept-Encoding头信息进行Gzip压缩。经过笔者测试，Gzip压缩后的数据量是原来的1/4，速度是原来的4-5倍，所以缓存加上压缩，效果非常明显。
在使用Gzip压缩时，需注意两个问题：</p>
<ol>
<li>Filter在进行Gzip压缩时，采用系统默认编码，对于使用GBK编码的中文网页来说，需要将操作系统的语言设置为：zh_CN.GBK，否则会出现乱码的问题。</li>
<li>默认情况下CachingFilter会根据浏览器发送的请求头部所包含的Accept-Encoding参数值来判断是否进行Gzip压缩。虽然IE6/7浏览器是支持Gzip压缩的，但是在发送请求的时候却不带该参数。为了对IE6/7也能进行Gzip压缩，可以通过继承CachingFilter，实现自己的Filter，然后在具体的实现中覆写方法acceptsGzipEncoding。</li>
</ol>
<p>具体实现参考：
1</p>
<p>2
3</p>
<p>4
5protected</p>
<p>boolean</p>
<p>acceptsGzipEncoding(HttpServletRequest request) {</p>
<p>final</p>
<p>boolean</p>
<p>ie6 = headerContains(request,</p>
<p>&quot;User-Agent&quot;</p>
<p>,</p>
<p>&quot;MSIE 6.0&quot;</p>
<p>);
final</p>
<p>boolean</p>
<p>ie7 = headerContains(request,</p>
<p>&quot;User-Agent&quot;</p>
<p>,</p>
<p>&quot;MSIE 7.0&quot;</p>
<p>);</p>
<p>return</p>
<p>acceptsEncoding(request,</p>
<p>&quot;gzip&quot;</p>
<p>) || ie6 || ie7;
}</p>
<p>EHCache在Hibernate中的使用
EHCache可以作为Hibernate的二级缓存使用。在hibernate.cfg.xml中需增加如下设置：</p>
<p>1</p>
<p>2
3&lt;</p>
<p>prop</p>
<p>key</p>
<p>=</p>
<p>&quot;hibernate.cache.provider_class&quot;</p>
<p>&gt;</p>
<p>org.hibernate.cache.EhCacheProvider
&lt;/</p>
<p>prop</p>
<p>&gt;</p>
<p>然后在Hibernate映射文件的每个需要Cache的Domain中，加入类似如下格式信息：</p>
<p><cache usage="read-write|nonstrict-read-write|read-only" />
比如：</p>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9&lt;</p>
<p>cache</p>
<p>usage</p>
<p>=</p>
<p>&quot;read-write&quot;</p>
<p>/&gt;</p>
<p>最后在配置文件ehcache.xml中增加一段cache的配置，其中name为该domain的类名。
&lt;</p>
<p>cache</p>
<p>name</p>
<p>=</p>
<p>&quot;domain.class.name&quot;</p>
<p>maxElementsInMemory</p>
<p>=</p>
<p>&quot;10000&quot;
eternal</p>
<p>=</p>
<p>&quot;false&quot;</p>
<p>timeToIdleSeconds</p>
<p>=</p>
<p>&quot;300&quot;
timeToLiveSeconds</p>
<p>=</p>
<p>&quot;600&quot;</p>
<p>overflowToDisk</p>
<p>=</p>
<p>&quot;false&quot;
/&gt;</p>
<p>EHCache的监控
对于Cache的使用，除了功能，在实际的系统运营过程中，我们会比较关注每个Cache对象占用的内存大小和Cache的命中率。有了这些数据，我们就可以对Cache的配置参数和系统的配置参数进行优化，使系统的性能达到最优。EHCache提供了方便的API供我们调用以获取监控数据，其中主要的方法有：</p>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
//得到缓存中的对象数</p>
<p>cache.getSize();
//得到缓存对象占用内存的大小</p>
<p>cache.getMemoryStoreSize();
//得到缓存读取的命中次数</p>
<p>cache.getStatistics().getCacheHits()
//得到缓存读取的错失次数</p>
<p>cache.getStatistics().getCacheMisses()</p>
<p>分布式缓存
EHCache从1.2版本开始支持分布式缓存。分布式缓存主要解决集群环境中不同的服务器间的数据的同步问题。具体的配置如下：</p>
<p>在配置文件ehcache.xml中加入
1</p>
<p>2
3</p>
<p>4
5&lt;</p>
<p>cacheManagerPeerProviderFactory</p>
<p>class</p>
<p>=</p>
<p>&quot;net.sf.ehcache.distribution.RMICacheManagerPeerProviderFactory&quot;
properties</p>
<p>=</p>
<p>&quot;peerDiscovery=automatic, multicastGroupAddress=230.0.0.1, multicastGroupPort=4446&quot;</p>
<p>/&gt;</p>
<p>&lt;</p>
<p>cacheManagerPeerListenerFactory
class</p>
<p>=</p>
<p>&quot;net.sf.ehcache.distribution.RMICacheManagerPeerListenerFactory&quot;</p>
<p>/&gt;</p>
<p>另外，需要在每个cache属性中加入</p>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
&lt;</p>
<p>cacheEventListenerFactory</p>
<p>class</p>
<p>=</p>
<p>&quot;net.sf.ehcache.distribution.RMICacheReplicatorFactory&quot;</p>
<p>/&gt;</p>
<p>例如：
&lt;</p>
<p>cache</p>
<p>name</p>
<p>=</p>
<p>&quot;demoCache&quot;</p>
<p>maxElementsInMemory</p>
<p>=</p>
<p>&quot;10000&quot;
eternal</p>
<p>=</p>
<p>&quot;true&quot;</p>
<p>overflowToDisk</p>
<p>=</p>
<p>&quot;true&quot;</p>
<p>&gt;
&lt;</p>
<p>cacheEventListenerFactory</p>
<p>class</p>
<p>=</p>
<p>&quot;net.sf.ehcache.distribution.RMICacheReplicatorFactory&quot;</p>
<p>/&gt;</p>
<p>&lt;/</p>
<p>cache</p>
<p>&gt;</p>
<p>总结
EHCache是一个非常优秀的基于Java的Cache实现。它简单、易用，而且功能齐全，并且非常容易与Spring、Hibernate等流行的开源框架进行整合。通过使用EHCache可以减少网站项目中数据库服务器的访问压力，提高网站的访问速度，改善用户的体验。</p>
<p>原文:<a href="http://blog.sina.com.cn/s/blog_46d5caa40100ka9z.html" target="_blank">http://blog.sina.com.cn/s/blog_46d5caa40100ka9z.html</a>
<a href="http://www.dev26.com/blog/article/352/1#" title="分享到QQ空间" target="_blank"></a> <a href="http://www.dev26.com/blog/article/352/1#" title="分享到新浪微博"></a> <a href="http://www.dev26.com/blog/article/352/1#" title="分享到腾讯微博" target="_blank"></a> <a href="http://www.dev26.com/blog/article/352/1#" title="分享到人人网"></a> 更多 <a href="http://www.dev26.com/blog/article/352/1#" title="累计分享0次" target="_blank">0</a></p>
<p>-
评分
请<a href="http://www.dev26.com/login" target="_blank">登录</a>后再对此文章评分</p>
<p><a href=""></a>列出所有评论</p>
<p><strong>没有可显示的项目</strong></p>
<p>发表您的评论</p>
<p>您尚未登录，无法发表评论   <img src="&quot;登录&quot;" alt="dev26登录">为什么要登录后才能发表评论？ 我们发现许多网站的大多数恶意评论（人身攻击，广告等）都是以匿名形式发布的，这样难以使一个技术社区形成一个和谐的讨论氛围。我们鼓励网友提出中肯的评论，留下您的身份也使得作者更容易与您交流。  您当前的登录名为<em>**</em> 评论：</p>
<p><a href="">加入收藏</a>- <a href="&quot;设为首页&quot;">设为首页</a>- <a href="http://www.dev26.com/runtime/privacy.html" target="_blank">隐私保护</a>- <a href="http://www.dev26.com/runtime/contact.html" target="_blank">联系我们</a>- <a href="http://www.dev26.com/runtime/help.html" target="_blank">获得帮助</a></p>
<p>Web开发站——为Web开发增添活力 <a href="http://tongji.baidu.com/hm-web/welcome/ico?s=ac500a971f22019aa0e7403308701c33" target="_blank"><img src="" alt=""></a></p>
<p>版权所有 © 2011-2012 备案号:京ICP备12003253号-1</p>
<h3 id="-">发送消息</h3>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/缓存/">缓存</a></li></span><span class="breadcrumb"><li><a href="/categories/缓存/">缓存</a></li><li><a href="/categories/缓存/ehcache/">ehcache</a></li></span></span> | <span class="tags">Tagged <a href="/tags/ehcache/" class="label label-primary">ehcache</a><a href="/tags/缓存/" class="label label-success">缓存</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:39"datetime="2014-03-07 09:54:39"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-缓存-ehcache--EHCache的使用教程-黑神领主的博客-dev26com/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-缓存-ehcache--EHCache的使用教程-黑神领主的博客-dev26com" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-缓存-ehcache--EHCache分布式缓存集群环境配置-七郎-博客园/">EHCache分布式缓存集群环境配置 </a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:39.000Z"> <a href="/2014/02/02/2014-02-02-缓存-ehcache--EHCache分布式缓存集群环境配置-七郎-博客园/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="ehcache-">EHCache分布式缓存集群环境配置 - 七郎 - 博客园</h1>
<p><a href=""></a></p>
<p><a href="http://www.cnblogs.com/yangy608/" target="_blank"><img src="" alt="返回主页"></a></p>
<h1 id="-s-blog-http-www-cnblogs-com-yangy608-"><a href="http://www.cnblogs.com/yangy608/" target="_blank">七郎&#39;s Blog</a></h1>
<h2 id="-">草木竹石皆可為劒。至人之用人若鏡，不將不迎，應而不藏，故能勝物而不傷。</h2>
<ul>
<li><a href="http://www.cnblogs.com/" target="_blank">博客园</a></li>
<li><a href="http://www.cnblogs.com/yangy608/" target="_blank">首页</a></li>
<li><a href="http://news.cnblogs.com/" target="_blank">新闻</a></li>
<li><a href="http://www.cnblogs.com/yangy608/admin/EditPosts.aspx?opt=1" target="_blank">新随笔</a></li>
<li><a href="http://space.cnblogs.com/msg/send/%e4%b8%83%e9%83%8e" target="_blank">联系</a></li>
<li><a href="http://www.cnblogs.com/yangy608/admin/EditPosts.aspx" target="_blank">管理</a></li>
<li><a href="http://www.cnblogs.com/yangy608/rss" target="_blank">订阅</a><a href="http://www.cnblogs.com/yangy608/rss" target="_blank"><img src="" alt="订阅"></a>
随笔- 144 文章- 1 评论- 1 </li>
</ul>
<h1 id="-ehcache-http-www-cnblogs-com-yangy608-archive-2011-10-07-2200669-html-"><a href="http://www.cnblogs.com/yangy608/archive/2011/10/07/2200669.html" target="_blank">EHCache分布式缓存集群环境配置</a></h1>
<p>ehcache提供三种网络连接策略来实现集群，rmi,jgroup还有jms。同时ehcache可以可以实现多播的方式实现集群,也可以手动指定集群主机序列实现集群。</p>
<p>Ehcache支持的分布式缓存支持有三种RMI，JGroups，JMS，这里介绍下MRI和JGrpups两种方式，Ehcache使用版本为1.5.0，关于ehcache的其他信息请参考<a href="http://ehcache.sourceforge.net/EhcacheUserGuide.html" target="_blank"><a href="http://ehcache.sourceforge.net/EhcacheUserGuide.html">http://ehcache.sourceforge.net/EhcacheUserGuide.html</a></a>，</p>
<p>关于jgroups的信息请参考<a href="http://www.jgroups.org/manual/html_single/index.html。" target="_blank">http://www.jgroups.org/manual/html_single/index.html。</a></p>
<p>环境为两台机器 server1 ip：192.168.2.154，server2 ip：192.168.2.23</p>
<h3 id="1-rmi-">1. RMI方式：</h3>
<p>rmi的方式配置要点（下面均是server1上的配置，server2上的只需要把ip兑换即可）</p>
<p><strong>a. 配置PeerProvider：</strong></p>
<p>Xml代码</p>
<cacheManagerPeerProviderFactory class="net.sf.ehcache.distribution.RMICacheManagerPeerProviderFactory"

properties="peerDiscovery=manual,rmiUrls=//192.168.2.23:40001/userCache|//192.168.2.23:40001/resourceCache" /> 

<p>配置中通过手动方式同步sever2中的userCache和resourceCache。</p>
<p><strong>b. 配置CacheManagerPeerListener：</strong></p>
<p>Xml代码</p>
<cacheManagerPeerListenerFactory class="net.sf.ehcache.distribution.RMICacheManagerPeerListenerFactory"

properties="hostName=192.168.2.154, port=40001,socketTimeoutMillis=2000" /> 

<p>配置中server1监听本机40001端口。</p>
<p><strong>c. 在每一个cache中添加cacheEventListener，例子如下：</strong></p>
<p>Xml代码</p>
<cache name="userCache" maxElementsInMemory="10000" eternal="true" overflowToDisk="true" timeToIdleSeconds="0" timeToLiveSeconds="0"diskPersistent="false" diskExpiryThreadIntervalSeconds="120">

<cacheEventListenerFactory class="net.sf.ehcache.distribution.RMICacheReplicatorFactory" properties="replicateAsynchronously=true, replicatePuts=true, replicateUpdates=true,replicateUpdatesViaCopy= false, replicateRemovals= true " />

</cache>

<p><strong>属性解释：</strong></p>
<p>必须属性：</p>
<pre><code>    name:设置缓存的名称，用于标志缓存,惟一

    maxElementsInMemory:在内存中最大的对象数量

    maxElementsOnDisk：在DiskStore中的最大对象数量，如为0，则没有限制

    eternal：设置元素是否永久的，如果为永久，则timeout忽略

    overflowToDisk：是否当memory中的数量达到限制后，保存到Disk
</code></pre><p>可选的属性：</p>
<pre><code>    timeToIdleSeconds：设置元素过期前的空闲时间

    timeToLiveSeconds：设置元素过期前的活动时间

    diskPersistent：是否disk store在虚拟机启动时持久化。默认为false
</code></pre><p>   diskExpiryThreadIntervalSeconds:运行disk终结线程的时间，默认为120秒</p>
<pre><code>    memoryStoreEvictionPolicy：策略关于Eviction
</code></pre><p>缓存子元素：</p>
<pre><code>cacheEventListenerFactory：注册相应的的缓存监听类，用于处理缓存事件，如put,remove,update,和expire

bootstrapCacheLoaderFactory:指定相应的BootstrapCacheLoader，用于在初始化缓存，以及自动设置。
</code></pre><p>参考另外一篇学习笔记<a href="http://wozailongyou.javaeye.com/blog/230252" title="http://wozailongyou.javaeye.com/blog/230252" target="_blank"><a href="http://wozailongyou.javaeye.com/blog/230252">http://wozailongyou.javaeye.com/blog/230252</a></a>，也有集群的说明</p>
<h3 id="2-jgroups-">2. JGroups方式：</h3>
<p>ehcache 1.5.0之后版本支持的一种方式，配置起来比较简单，要点：</p>
<p><strong>a. 配置PeerProvider，使用tcp的方式，例子如下：</strong></p>
<p>Xml代码</p>
<cacheManagerPeerProviderFactory class="net.sf.ehcache.distribution.jgroups.JGroupsCacheManagerPeerProviderFactory"

properties="connect=TCP(start_port=7800):

TCPPING(initial_hosts=192.168.2.154[7800],192.168.2.23[7800];port_range=10;timeout=3000;

num_initial_members=3;up_thread=true;down_thread=true):

VERIFY_SUSPECT(timeout=1500;down_thread=false;up_thread=false):

pbcast.NAKACK(down_thread=true;up_thread=true;gc_lag=100;retransmit_timeout=3000):

pbcast.GMS(join_timeout=5000;join_retry_timeout=2000;shun=false;

print_local_addr=false;down_thread=true;up_thread=true)"

propertySeparator="::" />

<hr>
<p><strong>b.为每个cache添加cacheEventListener：</strong></p>
<p>Xml代码</p>
<cache name="userCache" maxElementsInMemory="10000" eternal="true"

overflowToDisk="true" timeToIdleSeconds="0" timeToLiveSeconds="0"

diskPersistent="false" diskExpiryThreadIntervalSeconds="120">

<cacheEventListenerFactory class="net.sf.ehcache.distribution.jgroups.JGroupsCacheReplicatorFactory"

properties="replicateAsynchronously=true, replicatePuts=true,

replicateUpdates=true, replicateUpdatesViaCopy=false, replicateRemovals=true"/>

</cache>

<p>JGroup方式配置的两个server上的配置文件一样，若有多个server，在initial_hosts中将server ip加上即可。</p>
<p>一个完整的ehcache.xml文件：</p>
<p>Xml代码
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</p>
<ehcache xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"

xsi:noNamespaceSchemaLocation="http://ehcache.sf.net/ehcache.xsd">

<diskStore path="java.io.tmpdir" />



<cacheManagerPeerProviderFactory class="net.sf.ehcache.distribution.jgroups.JGroupsCacheManagerPeerProviderFactory"

properties="connect=TCP(start_port=7800):

TCPPING(initial_hosts=192.168.2.154[7800],192.168.2.23[7800];port_range=10;timeout=3000;

num_initial_members=3;up_thread=true;down_thread=true):

VERIFY_SUSPECT(timeout=1500;down_thread=false;up_thread=false):

pbcast.NAKACK(down_thread=true;up_thread=true;gc_lag=100;retransmit_timeout=3000):

pbcast.GMS(join_timeout=5000;join_retry_timeout=2000;shun=false;

print_local_addr=false;down_thread=true;up_thread=true)"

propertySeparator="::" />



<defaultCache maxElementsInMemory="10000" eternal="true"

overflowToDisk="true" timeToIdleSeconds="0" timeToLiveSeconds="0"

diskPersistent="false" diskExpiryThreadIntervalSeconds="120">

<cacheEventListenerFactory class="net.sf.ehcache.distribution.jgroups.JGroupsCacheReplicatorFactory"

properties="replicateAsynchronously=true, replicatePuts=true,

replicateUpdates=true, replicateUpdatesViaCopy=false, replicateRemovals=true"/>

</defaultCache>



<cache name="velcroCache" maxElementsInMemory="10000" eternal="true"

overflowToDisk="true" timeToIdleSeconds="0" timeToLiveSeconds="0"

diskPersistent="false" diskExpiryThreadIntervalSeconds="120">

<cacheEventListenerFactory class="net.sf.ehcache.distribution.jgroups.JGroupsCacheReplicatorFactory"

properties="replicateAsynchronously=true, replicatePuts=true,

replicateUpdates=true, replicateUpdatesViaCopy=false, replicateRemovals=true"/>

</cache>

<cache name="userCache" maxElementsInMemory="10000" eternal="true"

overflowToDisk="true" timeToIdleSeconds="0" timeToLiveSeconds="0"

diskPersistent="false" diskExpiryThreadIntervalSeconds="120">

<cacheEventListenerFactory class="net.sf.ehcache.distribution.jgroups.JGroupsCacheReplicatorFactory"

properties="replicateAsynchronously=true, replicatePuts=true,

replicateUpdates=true, replicateUpdatesViaCopy=false, replicateRemovals=true"/>

</cache>

<cache name="resourceCache" maxElementsInMemory="10000"

eternal="true" overflowToDisk="true" timeToIdleSeconds="0"

timeToLiveSeconds="0" diskPersistent="false"

diskExpiryThreadIntervalSeconds="120">

<cacheEventListenerFactory class="net.sf.ehcache.distribution.jgroups.JGroupsCacheReplicatorFactory"

properties="replicateAsynchronously=true, replicatePuts=true,

replicateUpdates=true, replicateUpdatesViaCopy=false, replicateRemovals=true"/>

</cache>

</ehcache>

<p>posted @ 2011-10-07 17:30 <a href="http://www.cnblogs.com/yangy608/" target="_blank">七郎</a> 阅读(1963) 评论(0) <a href="http://www.cnblogs.com/yangy608/admin/EditPosts.aspx?postid=2200669" target="_blank">编辑</a> <a href="http://www.cnblogs.com/yangy608/archive/2011/10/07/2200669.html#" target="_blank">收藏</a>
<img src="" alt=""></p>
<p><a href="http://www.cnblogs.com/yangy608/archive/2011/10/07/2200669.html#" target="_blank">刷新页面</a><a href="http://www.cnblogs.com/yangy608/archive/2011/10/07/2200669.html#top" target="_blank">返回顶部</a></p>
<p>（评论功能已被博主禁用）
<a href="http://q.cnblogs.com/" target="_blank">程序员问答社区，解决您的技术难题</a></p>
<p><a href="http://www.cnblogs.com/" title="程序员的网上家园" target="_blank">博客园首页</a><a href="http://q.cnblogs.com/" title="程序员问答社区" target="_blank">博问</a><a href="http://news.cnblogs.com/" title="IT新闻" target="_blank">新闻</a><a href="http://home.cnblogs.com/ing/" target="_blank">闪存</a><a href="http://job.cnblogs.com/" target="_blank">程序员招聘</a><a href="http://kb.cnblogs.com/" target="_blank">知识库</a></p>
<h3 id="-">公告</h3>
<p>Copyright ©2012 七郎</p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/缓存/">缓存</a></li></span><span class="breadcrumb"><li><a href="/categories/缓存/">缓存</a></li><li><a href="/categories/缓存/ehcache/">ehcache</a></li></span></span> | <span class="tags">Tagged <a href="/tags/ehcache/" class="label label-primary">ehcache</a><a href="/tags/缓存/" class="label label-success">缓存</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:39"datetime="2014-03-07 09:54:39"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-缓存-ehcache--EHCache分布式缓存集群环境配置-七郎-博客园/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-缓存-ehcache--EHCache分布式缓存集群环境配置-七郎-博客园" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-缓存-ehcache--EHCache-单落撒旦的日志-网易博客/">EHCache </a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:39.000Z"> <a href="/2014/02/02/2014-02-02-缓存-ehcache--EHCache-单落撒旦的日志-网易博客/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="ehcache-">EHCache - 单落撒旦的日志 - 网易博客</h1>
<p><a href="http://www.360doc.com/help.html" target="_blank">帮助</a>|<a href="http://www.360doc.com/advice.html" target="_blank">留言交流</a>|  <a href="http://www.360doc.com/login.aspx?reurl=http://www.360doc.com/content/10/1207/16/3880760_75861362.shtml" target="_blank">登录</a></p>
<p><img src="" alt=""></p>
<p><a href="http://www.360doc.com/index.html" target="_blank">首 页</a> <a href="http://www.360doc.com/readroom.html" target="_blank">阅览室</a> <a href="http://www.360doc.com/weekstar.html" target="_blank">馆友</a> <a href="http://www.360doc.com/my360doc.aspx" target="_blank">我的图书馆</a>
<img src="" alt=""></p>
<p><a href=""><img src="" alt=""></a>
来自：<a href="http://www.360doc.com/userhome/3880760" target="_blank">软件123</a> &gt; <a href="http://www.360doc.com/userhome.aspx?userid=3880760&amp;cid=3" target="_blank">Hibernate</a></p>
<p>配色： <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> 字号：大中小 EHCache - 单落撒旦的日志 - 网易博客 2010-12-07 | 阅：257  转：1  |  <a href="http://www.360doc.com/content/10/1207/16/3880760_75861362.shtml#" target="_blank">分享</a> </p>
<p><img src="" alt=""></p>
<ul>
<li><a href="&quot;分享到QQ空间&quot;"><img src="" alt="分享到QQ空间">腾讯空间</a></li>
<li><a href="&quot;分享到人人&quot;"><img src="" alt="">人人网</a></li>
<li><a href="&quot;分享到开心&quot;"><img src="" alt="">开心网</a></li>
<li><a href=""><img src="" alt="分享到新浪微博">新浪微博</a></li>
<li><a href=""><img src="" alt="分享到腾讯微博">腾讯微博</a></li>
<li><a href="&quot;分享到搜狐微博&quot;"><img src="" alt="分享到搜狐微博">搜狐空间</a></li>
<li><img src="" alt="">推荐给朋友</li>
<li><img src="" alt="">举报
<a href="http://www.360doc.com/register.aspx?refer=57&amp;reurl=resaveArt.aspx?articleid=" target="_blank"><img src="" alt=""></a>
 <a href="http://yxp.163.com/h/action/photoplay.html?sss=frombkerz1116"></a>  </li>
</ul>
<p><a href="http://blog.163.com/zhang-_-jie/blog/static/16178437820105811397991/" target="_blank">Cache技术―OSCache</a></p>
<h3 id="ehcache">EHCache</h3>
<p><a href="http://blog.163.com/zhang-_-jie/blog/#m=0&amp;t=1&amp;c=fks_084067086083080064080080082095085080080068092082085068092" title="缓存技术" target="_blank">缓存技术</a> 2010-06-08 14:07:18 阅读170 评论0   字号：大<strong>中</strong>小 <a href="">订阅</a>
一、简介</p>
<p>非常简单，而且易用。</p>
<p>ehcache 是一个非常轻量级的缓存实现，而且从1.2 之后就支持了集群，而且是hibernate 默认的缓存provider 。EhCache 是一个纯Java的进程内缓存框架，具有快速、精干等特点，是Hibernate中默认的CacheProvider。</p>
<p>Ehcache可以直接使用。也可以和Hibernate对象/关系框架结合使用。还可以做Servlet缓存。</p>
<p>Cache 存储方式 ：内存或磁盘。</p>
<pre><code>   官方网站：[http://ehcache.sourceforge.net/](http://ehcache.sourceforge.net/)
</code></pre><p>主要特性</p>
<ol>
<li>快速.</li>
<li>简单.</li>
<li>多种缓存策略</li>
<li>缓存数据有两级：内存和磁盘，因此无需担心容量问题</li>
<li>缓存数据会在虚拟机重启的过程中写入磁盘</li>
<li>可以通过RMI、可插入API等方式进行分布式缓存</li>
<li>具有缓存和缓存管理器的侦听接口</li>
<li>支持多缓存管理器实例，以及一个实例的多个缓存区域</li>
<li>提供Hibernate的缓存实现</li>
<li>等等</li>
</ol>
<p>二、快速上手</p>
<p>1、  项目类库中添加ehcache.jar；</p>
<p>2、  在类路径下编写ehcache.xml配置文件。</p>
<p>三、配置文件参数详解</p>
<p>ehcache.xml是ehcache的配置文件，并且存放在应用的classpath中。下面是对该XML文件中的一些元素及其属性的相关说明： </p>
<p><diskStore>元素：指定一个文件目录，当EHCache把数据写到硬盘上时，将把数据写到这个文件目录下。 下面的参数这样解释：   </p>
<pre><code>     user.home – 用户主目录   

     user.dir      – 用户当前工作目录   

     java.io.tmpdir – 默认临时文件路径
</code></pre><p><defaultCache>元素：设定缓存的默认数据过期策略。 </p>
<cache>元素：设定具体的命名缓存的数据过期策略。



<cache>元素的属性 

name：缓存名称。通常为缓存对象的类名（非严格标准）。 

maxElementsInMemory：设置基于内存的缓存可存放对象的最大数目。 

maxElementsOnDisk：设置基于硬盘的缓存可存放对象的最大数目。<br>
eternal：如果为true，表示对象永远不会过期，此时会忽略timeToIdleSeconds和timeToLiveSeconds属性，默认为false; 

timeToIdleSeconds： 设定允许对象处于空闲状态的最长时间，以秒为单位。当对象自从最近一次被访问后，如果处于空闲状态的时间超过了timeToIdleSeconds属性值，这个对象就会过期。当对象过期，EHCache将把它从缓存中清空。只有当eternal属性为false，该属性才有效。如果该属性值为0，则表示对象可以无限期地处于空闲状态。 

timeToLiveSeconds：设定对象允许存在于缓存中的最长时间，以秒为单位。当对象自从被存放到缓存中后，如果处于缓存中的时间超过了 timeToLiveSeconds属性值，这个对象就会过期。当对象过期，EHCache将把它从缓存中清除。只有当eternal属性为false，该属性才有效。如果该属性值为0，则表示对象可以无限期地存在于缓存中。timeToLiveSeconds必须大于timeToIdleSeconds属性，才有意义。 

overflowToDisk：如果为true,表示当基于内存的缓存中的对象数目达到了maxElementsInMemory界限后，会把益出的对象写到基于硬盘的缓存中。注意：如果缓存的对象要写入到硬盘中的话，则该对象必须实现了Serializable接口才行。

memoryStoreEvictionPolicy：缓存对象清除策略。有三种：

1 FIFO ，first in first out ，这个是大家最熟的，先进先出，不多讲了

2 LFU ， Less Frequently Used ，就是上面例子中使用的策略，直白一点就是讲一直以来最少被使用的。如上面所讲，缓存的元素有一个hit 属性，hit 值最小的将会被清出缓存。

2 LRU ，Least Recently Used ，最近最少使用的，缓存的元素有一个时间戳，当缓存容量满了，而又需要腾出地方来缓存新的元素的时候，那么现有缓存元素中时间戳离当前时间最远的元素将被清出缓存。

四、单独使用EHCache

1.创建CacheManager （net.sf.ehcache.CacheManager）

（1）使用默认配置文件创建

CacheManager manager = CacheManager.create();

（2）使用指定配置文件创建

CacheManager manager = CacheManager.create(&quot;src/config/ehcache.xml&quot;);

（3）从classpath找寻配置文件并创建

URL url = getClass().getResource(&quot;/anothername.xml&quot;);

CacheManager manager = CacheManager.create(url);

（4）通过输入流创建

InputStream fis = new FileInputStream(new File(&quot;src/config/ehcache.xml&quot;).getAbsolutePath());

try { manager = CacheManager.create(fis); } finally { fis.close(); }



2.创建Caches （net.sf.ehcache.Cache）

（1）取得配置文件中预先 定义的sampleCache1设置,生成一个Cache

Cache cache = manager.getCache(&quot;sampleCache1&quot;);



（2）设置一个名为test 的新cache,test属性为默认

CacheManager manager = CacheManager.create();

manager.addCache(&quot;test&quot;);



（3）设置一个名为test 的新cache,并定义其属性

CacheManager manager = CacheManager.create();

Cache cache = new Cache(&quot;test&quot;, 1, true, false, 5, 2);

manager.addCache(cache);



（4）删除cache

CacheManager singletonManager = CacheManager.create();

singletonManager.removeCache(&quot;sampleCache1&quot;);<br>


3.使用Caches

（1）往cache中加入元素

Element element = new Element(&quot;key1&quot;, &quot;value1&quot;);

cache.put(new Element(element);



（2）从cache中取得元素

Element element = cache.get(&quot;key1&quot;);



（3）从cache中删除元素

Cache cache = manager.getCache(&quot;sampleCache1&quot;);

Element element = new Element(&quot;key1&quot;, &quot;value1&quot;);

cache.remove(&quot;key1&quot;);<br>


3.卸载CacheManager ,关闭Cache

 manager.shutdown();

下附代码。





五、在 Hibernate 中运用EHCache

1、hibernate.cfg.xml中需设置如下：

3系列版本加入
<property name=” hibernate.cache.provider_class”>
org.hibernate.cache.EhCacheProvider
</property>  EhCacheProvider类位于hibernate3.jar

2.1版本加入

net.sf.ehcache.hibernate.Provider

2.1以下版本加入

net.sf.hibernate.cache.EhCache



2、在Hibernate3.x中的etc目录下有ehcache.xml的示范文件，将其复制应用程序的src目录下（编译时会把ehcache.xml复制到WEB-INF/classess目录下），对其中的相关值进行更改以和自己的程序相适合。



3、持久化类的映射文件进行配置

       <cache usage="read-write"/>

在<set>标记中设置了<cache usage="read-write"/>，但Hibernate仅把和Group相关的Student的主键id加入到缓存中，如果希望把整个Student的散装属性都加入到二级缓存中，还需要在Student.hbm.xml文件的<class>标记中加入<cache>子标记，如下所示：

<cache usage="read-write" /> <!--cache标记需跟在class标记后-->



注：SSH中hibernate配置的cache信息

<prop key="hibernate.cache.provider_class">org.hibernate.cache.EhCacheProvider</prop>

六、在页面中使用EHCache缓存

       简单的来说，如果一个应用中80% 的时间内都在访问20% 的数据，那么，这时候就应该使用缓存了。

       在80/20 原则生效的地方，我们都应该考虑是否可以使用缓存。但即使是这样，缓存也有不同的用法，举个例子，一个网站的首页估计是被访问的次数最多的，我们可以考虑给首页做一个页面缓存。页面访问最频繁的，做缓存。不同的页面的缓存策略有可能有天壤之别。

       毫无疑问，几乎所有的网站的首页都是访问率最高的，而首页上的数据来源又是非常广泛的，大多数来自不同的对象，而且有可能来自不同的db ，所以给首页做缓存是一个不错的主意，那么主页的缓存策略是什么样子的呢，我认为应该是某个固定时间之内不变的，比如说2 分钟更新一次。或者根据不同的网页功能采取合理的策略。



在使用ehcache 的页面缓存之前，我们必须要了解ehcache 的2个概念：

（1）timeToIdleSeconds ，多长时间不访问该缓存，那么ehcache 就会清除该缓存。

（2）timeToLiveSeconds ，缓存的存活时间，从开始创建的时间算起。



1、配置ehcache.xml文件

2、在web.xml配置文件中配置过滤器信息

好了，缓存整个页面看上去是非常的简单，甚至都不需要写一行代码，只需要几行配置就行了，够简单吧，虽然看上去简单，但是事实上内部实现却不简单哦，有兴趣的话，大家可以看看SimplePageCachingFilter 继承体系的源代码。



缓存首页（整个页面）示例：

&lt; filter &gt;

        &lt; filter-name &gt; indexCacheFilter </filter-name >

        &lt; filter-class &gt;

            net.sf.ehcache.constructs.web.filter.SimplePageCachingFilter

        </filter-class >

</filter ><br>
&lt; filter-mapping &gt;

        &lt; filter-name &gt; indexCacheFilter </filter-name >

        &lt; url-pattern &gt; /<em>index.action </url-pattern >

</filter-mapping >



缓存首页的部分内容时，需要使用SimplePageFragmentCachingFilter 这个filter 。如：<br>
&lt; filter &gt;

        &lt; filter-name &gt; indexCacheFilter </filter-name >

        &lt; filter-class &gt;

            net.sf.ehcache.constructs.web.filter.SimplePageFragmentCachingFilter

        </filter-class >

</filter ><br>
&lt; filter-mapping &gt;

        &lt; filter-name &gt; indexCacheFilter </filter-name >

        &lt; url-pattern &gt; /</em>/index_right.jsp </url-pattern >

</filter-mapping ><br>
这个jsp 需要被jsp:include 到其他页面，这样就做到的局部页面的缓存。这一点貌似没有oscache 的tag 好用。



七、在Spring框架中使用EHCache缓存



       就是使用Spring提供的springmodules和EHCache来简化程序的开发，通过配置文件来完成提供缓存。参考springmodules的文档。



1、配置ehcache.xml文件

2、创建Spring EHCache的配置xml文件

配置文件代码示例（调试通过）：

&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

<beans xmlns="http://www.springframework.org/schema/beans"

    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"

    xmlns:aop="http://www.springframework.org/schema/aop"

    xmlns:tx="http://www.springframework.org/schema/tx"

    xmlns:ehcache="http://www.springmodules.org/schema/ehcache"

    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd  

    http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd  

    http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.5.xsd   

    http://www.springmodules.org/schema/ehcache http://www.springmodules.org/schema/cache/springmodules-ehcache.xsd">



    <bean id="EhCacheFacade"

       class="org.springmodules.cache.provider.ehcache.EhCacheFacade">

       <property name="failQuietlyEnabled" value="true" />

       <property name="cacheManager">

           <bean

              class="org.springframework.cache.ehcache.EhCacheManagerFactoryBean">

              <property name="configLocation"

                  value="classpath:ehcache.xml">

              </property>

           </bean>

       </property>

    </bean>



    <bean id="cachingInterceptor"

       class="org.springmodules.cache.interceptor.caching.MethodMapCachingInterceptor">

       <property name="cacheProviderFacade" ref="EhCacheFacade" />

       <property name="cachingModels">

           <props>

              <prop key="com....test.Manager.get/*">

                  cacheName=dictCache

              </prop>

           </props>

       </property>

    </bean>



    <bean id="flushingInterceptor"

       class="org.springmodules.cache.interceptor.flush.MethodMapFlushingInterceptor">

       <property name="cacheProviderFacade" ref="EhCacheFacade" />

       <property name="flushingModels">

           <props>

              <prop key="com....test.Manager.update/*">

                  cacheNames=dictCache

              </prop>

           </props>

       </property>

    </bean>



    <bean

       class="org.springframework.aop.framework.autoproxy.BeanNameAutoProxyCreator">

       <property name="beanNames">

           <value>/*anager</value>

       </property>

       <property name="interceptorNames">

           <list>

              <value>flushingInterceptor</value>

              <value>cachingInterceptor</value>

           </list>

       </property>

    </bean>

    <bean id="manager" class="com...test.Manager"></bean>

</beans>

 <cache name="dictCache"

    maxElementsInMemory="50"

    eternal="false"

    timeToIdleSeconds="60"

    timeToLiveSeconds="60"

    overflowToDisk="false"

    memoryStoreEvictionPolicy="LFU">

    </cache>



<p>也可以使用注解的形式进行标注缓存方法，不过要修改配置文件，详见springmodules的文档，这里就不提供了。</p>
<p>缓存说明：</p>
<p>1、方法不含有参数</p>
<pre><code>时间到期缓存失效；调用flush，缓存失效。
</code></pre><p>2、方法中含有参数</p>
<pre><code>参数不同则每次都缓存,若缓存中存在相同对象，则调用缓存。

当调用flush，该id对应的缓存都失效。

当缓存时间到期，该id对应的缓存都失效。
</code></pre><p>建议：对没有关联的缓存对象采取不同的id配置。所以ehcache会有好多的cache-id配置信息。</p>
<pre><code>       &lt;props&gt;

          &lt;prop key=&quot;com....test.Manager.get/*&quot;&gt;

              cacheName=dictCache

          &lt;/prop&gt;

          ………                     

          &lt;prop key=&quot;com....test.Manager2.get/*&quot;&gt;

              cacheName=dictCache2

          &lt;/prop&gt;

       &lt;/props&gt;



       &lt;props&gt;

          &lt;prop key=&quot;com....test.Manager.update/*&quot;&gt;

              cacheNames=dictCache

          &lt;/prop&gt;

          ………

          &lt;prop key=&quot;com....test.Manager2.update/*&quot;&gt;

              cacheNames=dictCache2

          &lt;/prop&gt;

       &lt;/props&gt;
</code></pre><p>  上一篇：<a href="http://www.360doc.com/content/10/1206/20/3880760_75614432.shtml" target="_blank">基于按annotation的hibernate主键生成策略 - 白首穷经通秘义...</a></p>
<p>下一篇：<a href="http://www.360doc.com/content/10/1207/16/3880760_75862016.shtml" target="_blank">Cache技术―OSCache - 单落撒旦的日志 - 网易博客</a> <a href=""><img src="" alt=""></a></p>
<p>献花(0)</p>
<p>+1 分享到：<a href="&quot;分享到QQ空间&quot;"><img src="" alt="分享到QQ空间"></a><a href="&quot;分享到人人&quot;"><img src="" alt=""></a><a href="&quot;分享到开心&quot;"><img src="" alt=""></a><a href=""><img src="" alt="分享到新浪微博"></a><a href=""><img src="" alt="分享到腾讯微博"></a><a href="&quot;分享到搜狐微博&quot;"><img src="" alt="分享到搜狐微博"></a><a href=""><img src="" alt=""></a></p>
<ul>
<li><img src="" alt="">推荐给朋友</li>
<li><img src="" alt="">举报  (本文系<a href="http://www.360doc.com/userhome/3880760" target="_blank">软件123</a>首藏  <a href="http://blog.163.com/zhang-_-jie/blog/static/1617843782010582718212/" target="_blank">源文网址</a>)</li>
</ul>
<p>类似文章</p>
<ul>
<li><a href="http://www.360doc.com/content/11/0811/15/7270363_139632250.shtml" target="_blank">Ehcache</a></li>
<li><a href="http://www.360doc.com/content/07/0828/15/5136_700268.shtml" target="_blank">配置Spring+hibernate使用ehcache作为se...</a></li>
<li><a href="http://www.360doc.com/content/06/0927/12/6272_218072.shtml" target="_blank">Hibernate ehcache二级缓存技术</a></li>
<li><a href="http://www.360doc.com/content/10/1011/11/2560742_60066155.shtml" target="_blank">EhCache使用详细介绍（转）</a></li>
<li><a href="http://www.360doc.com/content/11/0402/17/6069386_106731794.shtml" target="_blank">二级 ehcache</a></li>
<li><a href="http://www.360doc.com/content/11/1216/17/6088543_172744745.shtml" target="_blank">Hibernate一级缓存和二级缓存</a></li>
<li><a href="http://www.360doc.com/content/10/1128/16/1689336_73159043.shtml" target="_blank">【有声读物】单田芳评书 - 浅草细浪的日...</a></li>
<li><a href="http://www.360doc.com/content/09/0803/16/189491_4643744.shtml" target="_blank">低血压 - 只要有你的日志 - 网易博客</a></li>
<li><a href="http://www.360doc.com/content/10/0207/18/289502_15377865.shtml" target="_blank">网易博客教程一 - 闲人SGM的日志 - 网易...</a>
<a href="http://www.360doc.com/relevant/75861362_more.shtml" target="_blank">更多</a></li>
</ul>
<p>0</p>
<p><img src="" alt="正在加载推荐文章"></p>
<p>您可能会喜欢</p>
<p>[<img src="" alt=""></p>
<p>老师开博客 天天开&quot;网上家长会&quot;
](<a href="http://www.360doc.com/content/07/0508/10/26144_488073.shtml" target="_blank">http://www.360doc.com/content/07/0508/10/26144_488073.shtml</a> &quot;老师开博客 天天开&quot;网上家长会&quot;&quot;) [<img src="" alt=""></p>
<p>博客冲击波（1）----商业周刊精华文章
](<a href="http://www.360doc.com/content/08/0706/10/8596_1402791.shtml" target="_blank">http://www.360doc.com/content/08/0706/10/8596_1402791.shtml</a> &quot;博客冲击波（1）----商业周刊精华文章&quot;) [<img src="" alt=""></p>
<p>红杏妹的博客 l
](<a href="http://www.360doc.com/content/12/0307/16/5060984_192513101.shtml" target="_blank">http://www.360doc.com/content/12/0307/16/5060984_192513101.shtml</a> &quot;红杏妹的博客 l&quot;) [<img src="" alt=""></p>
<p>Ehcache
](<a href="http://www.360doc.com/content/11/0811/15/7270363_139632250.shtml" target="_blank">http://www.360doc.com/content/11/0811/15/7270363_139632250.shtml</a> &quot;Ehcache&quot;) [<img src="" alt=""></p>
<p>教你怎样制作博客首页 - 敏儿的日志 - 网易博客
](<a href="http://www.360doc.com/content/10/0317/13/826574_19113845.shtml" target="_blank">http://www.360doc.com/content/10/0317/13/826574_19113845.shtml</a> &quot;教你怎样制作博客首页 - 敏儿的日志 - 网易博客&quot;)</p>
<p><a href="http://www.wumii.com/widget/relatedItems" title="无觅相关文章插件" target="_blank">无觅</a>
<a href=""></a></p>
<p><img src="" alt=""></p>
<p>发表评论：</p>
<p>您好，请 <a href="">登录</a> 或者 <a href="http://www.360doc.com/register.aspx?refer=53&amp;reurl=showweb/0/0/75861362.aspx" target="_blank">注册</a> 后再进行评论
使用合作网站登录：<img src="" alt="">新浪微博<img src="" alt="">QQ<img src="" alt="">人人
<img src="" alt="">
  <a href="http://www.360doc.com/userhome/3880760" target="_blank"><img src="" alt=""></a></p>
<p><a href="http://www.360doc.com/userhome/3880760" target="_blank">孙中熙——路</a></p>
<p>馆藏：<a href="http://www.360doc.com/userhome.aspx?userid=3880760&amp;app=1" target="_blank">157</a>
关注我：<a href="http://www.360doc.com/userhome.aspx?userid=3880760&amp;app=2" target="_blank">1</a></p>
<p><a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a></p>
<p>最新文章</p>
<ul>
<li><a href="http://www.360doc.com/content/12/0912/20/3880760_235775281.shtml" target="_blank">JS计算字符串所占字节数</a></li>
<li><a href="http://www.360doc.com/content/12/0624/09/3880760_220086498.shtml" target="_blank">List的功能方法</a></li>
<li><a href="http://www.360doc.com/content/12/0225/15/3880760_189532854.shtml" target="_blank">maven dependency:sources</a></li>
<li><a href="http://www.360doc.com/content/12/0219/15/3880760_187825046.shtml" target="_blank">IBatis</a></li>
<li><a href="http://www.360doc.com/content/12/0218/13/3880760_187576669.shtml" target="_blank">myeclipse 8.5-9.0 安装 svn 方...</a></li>
<li><a href="http://www.360doc.com/content/12/0218/11/3880760_187551055.shtml" target="_blank">深入理解Java序列化中的SerialV...</a></li>
<li><a href="http://www.360doc.com/content/12/0218/11/3880760_187550886.shtml" target="_blank">关于spring中 几个 java.lang.C...</a></li>
<li><a href="http://www.360doc.com/content/12/0216/20/3880760_187173708.shtml" target="_blank">Derby 轻量级数据库</a></li>
<li><a href="http://www.360doc.com/content/12/0216/20/3880760_187173508.shtml" target="_blank">Template method pattern 模板...</a></li>
<li><a href="http://www.360doc.com/content/12/0216/20/3880760_187173416.shtml" target="_blank">工厂方法模式(Factory method)...</a></li>
<li><a href="http://www.360doc.com/content/12/0216/20/3880760_187173300.shtml" target="_blank">DAO层的分析（一）</a></li>
<li><a href="http://www.360doc.com/content/12/0216/20/3880760_187173130.shtml" target="_blank">提高数据库并发性能概要</a>
<a href="http://www.360doc.com/userhome/3880760" target="_blank">更多&gt;&gt;</a>
-</li>
</ul>
<p>热门文章</p>
<ul>
<li><a href="http://www.360doc.com/content/12/0428/23/0_207401601.shtml" target="_blank">99天毛笔书法速成练习</a></li>
<li><a href="http://www.360doc.com/content/11/0111/14/0_85740115.shtml" target="_blank">素饺子 做法集锦</a></li>
<li><a href="http://www.360doc.com/content/11/0609/10/0_122630336.shtml" target="_blank">趣图：我就喜欢你最丑的样子</a></li>
<li><a href="http://www.360doc.com/content/12/0222/16/0_188656716.shtml" target="_blank">巧做爽口腌黄瓜（图）</a></li>
<li><a href="http://www.360doc.com/content/12/0305/14/0_191838346.shtml" target="_blank">一个人的私奔</a></li>
<li><a href="http://www.360doc.com/content/10/0719/06/0_39976494.shtml" target="_blank">老中医的长寿秘诀——长寿粥</a></li>
<li><a href="http://www.360doc.com/content/11/0813/18/0_140148370.shtml" target="_blank">海论英语《从零开始学口语》（4...</a></li>
<li><a href="http://www.360doc.com/content/11/1205/23/0_169982196.shtml" target="_blank">尿路结石的秘方</a></li>
<li><a href="http://www.360doc.com/content/10/0713/13/0_38709357.shtml" target="_blank">能不能不要装可爱(图片)</a></li>
<li><a href="http://www.360doc.com/content/12/0511/08/0_210233282.shtml" target="_blank">好吃的茄饼蒸肉</a></li>
<li><a href="http://www.360doc.com/content/10/0811/21/0_45363446.shtml" target="_blank">庄子的快活 穿越时空之舞</a></li>
<li><a href="http://www.360doc.com/content/11/0613/15/0_126649064.shtml" target="_blank">健康教育处方大全</a>
<a href="http://www.360doc.com/readroom.html" target="_blank">更多&gt;&gt;</a></li>
</ul>
<p><a href="">关闭</a></p>
<p><a href="http://www.360doc.com/mobilapp.htm" target="_blank"><img src="" alt=""></a></p>
<p><a href="http://www.360doc.com/content/10/1207/16/3880760_75861362.shtml#"></a></p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/缓存/">缓存</a></li></span><span class="breadcrumb"><li><a href="/categories/缓存/">缓存</a></li><li><a href="/categories/缓存/ehcache/">ehcache</a></li></span></span> | <span class="tags">Tagged <a href="/tags/ehcache/" class="label label-primary">ehcache</a><a href="/tags/缓存/" class="label label-success">缓存</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:39"datetime="2014-03-07 09:54:39"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-缓存-ehcache--EHCache-单落撒旦的日志-网易博客/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-缓存-ehcache--EHCache-单落撒旦的日志-网易博客" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>





<ul id="pagination" class="pagination pagination-lg">
  <li><a class="extend prev" href="/page/82/">&laquo;</a></li><li><a class="page-number" href="/">1</a></li><li><a class="page-number" href="/page/2/">2</a></li><li><span class="space">&hellip;</span></li><li><a class="page-number" href="/page/80/">80</a></li><li><a class="page-number" href="/page/81/">81</a></li><li><a class="page-number" href="/page/82/">82</a></li><li class="active"><li><span class="page-number current">83</span></li><li><a class="page-number" href="/page/84/">84</a></li><li><a class="page-number" href="/page/85/">85</a></li><li><a class="page-number" href="/page/86/">86</a></li><li><span class="space">&hellip;</span></li></li><li><a class="page-number" href="/page/163/">163</a></li><li><a class="page-number" href="/page/164/">164</a></li><li><a class="extend next" href="/page/84/">&raquo;</a></li>
  <div class="clearfix"></div>
</ul></div><!--wapper-->
       </div><!-- ID main-col END -->
       <aside id="sidebar" class="alignright col-sx-6 col-sm-4 col-md-3 col-lg-3">
<div id="widget_search" class="widget panel panel-primary">
    <form action="//google.com/search" method="get" accept-charset="utf-8">
  <div class="input-group">
    <input class="form-control" id="searchbox" type="search" name="q" results="0" placeholder="search">
    <span class="input-group-btn">
      <button class="btn btn-default" type="submit">Go!</button>
    </span>
    <input type="hidden" name="q" value="site:itsolife.com">
  </div>
</form>
</div>

<div id="widget_category" class="widget panel panel-primary">
  <div class="panel-heading">category</div>  <div data-src='category' class='ajax_widgets'>正在加载...</div>
</div>

<div id="widget_recent_posts" class="widget panel panel-primary">
  <div class="panel-heading">recent posts</div>  <div data-src='recent_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_tagcloud" class="widget panel panel-primary">
  <div class="panel-heading">tagcloud</div>  <div data-src='tagcloud' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_latest_update_posts" class="widget panel panel-primary">
  <div class="panel-heading">最近更新</div>  <div data-src='latest_update_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_recent_comments" class="widget panel panel-primary">
  <div class="panel-heading">recent comments</div>  

<div class="list-group-item ds-recent-comments" data-num-items="6" data-show-avatars="1" data-show-time="1" data-show-title="1" data-show-admin="1" data-excerpt-length="50"></div>



</div>

</aside>
       <div class="clearfix"></div>
     </div><!-- row END -->
  </div>
  <footer id="footer" class="container">
  <div class="panel panel-info">
  <section id='footer_widget'></section>  <div class="panel-footer">
  <div id="site-info">
    <span class='author'>
  
  &copy; 2014 RobinChia
  
    &nbsp;&nbsp;</span>
  
  <span id='analytics-51la'></span><span id='analytics-google'>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-48559895-1']);
  _gaq.push(['_trackPageview']);
  _js2load.push({src:('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'});
</script></span><span id='analytics-cnzz'>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_5774006'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s17.cnzz.com/stat.php%3Fid%3D5774006%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</span><span id='analytics-baidu'>
<script>
var _hmt = _hmt || [];
_js2load.push({src:"//hm.baidu.com/hm.js?1442f50724afc42380b51f097c43082c"});
</script>
</span>  </div>
  <div id="copyright">Site powered by <a href='http://zespia.tw/hexo/'><strong>hexo</strong></a>  update time: <em>2014-03-29 22:06:56</em></span></div>
</div>
<div class="clearfix"></div>


  </div>
  </footer>
  
        <script src="http://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>        
        <script src="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>        
                
        <script src="http://cdn.bootcss.com/prettify/r298/prettify.min.js"></script>    <script type="text/javascript">
   var lang=["bsh", "c", "cc", "cpp", "cs", "csh", "cyc", "cv", "htm", "html",
    "java", "js", "m", "mxml", "perl", "pl", "pm", "py", "rb", "sh",
    "xhtml", "xml", "xsl"];
   var pretty_base='';
   $('script').each(function(){
	var c = $(this).attr('src');
	if (!c)
	    return;
	if (c.match(/(\/)?prettify(\.min)?\.js/i))
	{
	    var index = c.lastIndexOf('/');
	    if (index != -1)
		pretty_base = c.substr(0,index + 1);
	    return false;
	}
   })
   $('pre code').each(function(){
	var c = $(this).attr('class')
	if (!c)
	    return;
	c = c.match(/\s?(lang\-\w+)/i);
	if (c && lang.indexOf(c[1]) == -1)
	{
	    lang.push(c[1]);
	    $.getScript(pretty_base + c[1] + '.min.js');
	}
   })

    $(window).load(function(){
       $("pre").addClass("prettyprint");
       prettyPrint();
    })
</script>    
            <script type="text/javascript">
var duoshuoQuery = {short_name:"robinchia"};
_js2load.push({src:'http://static.duoshuo.com/embed.js',charset:'UTF-8'});
</script>
    
            <!--wumii_relatedItems-->
    
        <script src="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>    <script type="text/javascript">
(function($){
  $('.entry').each(function(i){
    $(this).find('img').each(function(){
      var alt = this.alt;

      if (alt){
        $(this).before('<span class="caption">' + alt + '</span>');
      }

      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="fancybox' + i + '" />');
    });
  });

  $('.fancybox').fancybox();
})(jQuery);
</script>    
        <script src="http://cdn.bootcss.com/mathjax/2.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>
    
<script type="text/javascript">
$('.ajax_widgets').each(function(){var src=$(this).attr('data-src');if(src)$(this).load('/widgets/'+src+'.html');});
$.each(_js2load,function(index,obj){loadjs(obj.src,obj.charset)});
</script>

<div id="scroll2top">
<img src="/scroll2top/arrow.png"/>
</div>
<script src="/scroll2top/scroll2top.min.js"></script>
<div id="winterland">
  <canvas></canvas>
</div>
<script src="/js/winterland.min.js"></script>

  </body>
</html>
