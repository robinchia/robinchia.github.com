
<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>The 54 Page | It so life</title>
<meta name="author" content="RobinChia">

<meta name="description" content="It so life">


<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta property="og:site_name" content="It so life"/>

<!--[if IE]><style>.testIE.IE{display:inline;}</style><![endif]-->
<!--[if lte IE 7]><link rel="stylesheet" href="/css/ie7.css" type="text/css"><![endif]-->
<!--[if (lt IE 9)&(gt IE 7)]><style>.testIE.IE8{display:inline;}</style><![endif]-->
<!--[if gt IE 8]><style>.testIE.IE9{display:inline;}</style><![endif]-->

<link href="/favicon.png" rel="icon">
<link rel="alternate" href="/atom.xml" title="It so life Feed" type="application/atom+xml">

<link rel="stylesheet" href="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/font-awesome/4.0.3/css/font-awesome.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/prettify/r298/prettify.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" type="text/css">
<link rel="stylesheet" href="/css/style.css" type="text/css">
<!--[if lt IE 9]>
   <style>article,aside,dialog,footer,header,section,footer,nav,figure,menu{display:block}</style>
   <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
   <script src="http://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
<link href="http://cdn.staticfile.org/respond.js/1.4.2/respond-proxy.html" id="respond-proxy" rel="respond-proxy" />
<link href="/js/respond.proxy.gif" id="respond-redirect" rel="respond-redirect" />
<script src="/js/respond.proxy.js"></script>
   <script src="http://cdn.bootcss.com/selectivizr/1.0.2/selectivizr-min.js"></script>
<![endif]-->
<script type="text/javascript">
function loadjs(c,d){var a=document.createElement("script");a.async=!0;a.type="text/javascript";a.src=c;a.charset=d||"gbk";(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(a)};
var _protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
var _js2load = [];
</script>

</head>
<body>
      <header id="header" class="container"><nav id="main-nav" class="navbar navbar-default navbar-fixed-top " role="navigation">
  <div class="container">
    <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/">It so life</a>
    </div>
    <div  class="collapse navbar-collapse">
      <ul  class="nav navbar-nav">
  
        <li><a href="/" title="Home">Home</a></li>      
        <li><a href="/about/" title="About">About</a></li>      
        <li><a href="/archives/" title="Archives">Archives</a></li>      
      <li class='dropdown'>
        <a class='dropdown-toggle' data-toggle='dropdown' href='#'>website<b class='caret'></b></a>
        <ul class='dropdown-menu pure-menu-selected'>
    
          <li><a href="//groups.google.com/forum/#!forum/pongba" title="TopLanguage">TopLanguage</a></li>    
          <li><a href="//itpub.net/" title="ITPub">ITPub</a></li>    
          <li><a href="//blog.jobbole.com/" title="Bole">Bole</a></li>    
          <li><a href="//nosql-database.org/" title="nosql">nosql</a></li>    
          <li><a href="//gitimmersion.googol.im/" title="Git">Git</a></li>    
        </ul>
      </li>
    
      </ul>
      <ul class="nav navbar-nav navbar-right">
      
        <li><a href="/atom.xml">RSS</a></li>
      
      
        <li><a href="https://twitter.com/robinchia">twitter</a></li>
      
      
      
      
        <li><a href="https://github.com/robinchia">github</a></li>
      
      </ul>
    </div>
  </div>
</nav>
<div class="clearfix"></div>
</header>
  <div id='content' class="container">
     <div class="page-header-wrapper">
      <!--[if lt IE 9]><div class="alert alert-warning alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>提示:</strong>您的浏览器版本太低了,建议升级到 <strong><a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" title="IE9">IE9</a></strong> 以上,本站使用<a href="https://www.google.com/intl/zh-CN/chrome/">Chrome浏览器</a>可以获得最好的显示效果.</div><![endif]-->
      <div class="page-header"><h1 align="center"><big>It so life</big> </h1>
        <h5 align="center"><big>love as life</big></h5>
      </div>
     </div>
     <div class="row">
       <div id="main-col" class="alignleft col-sx-12 col-sm-8 col-md-9 col-lg-9">
      <section id='header_widget'></section>
          <div id="wrapper"><article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--GC悲观策略之ParallelGC篇/">GC悲观策略之Parallel GC篇</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:41.000Z"> <a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--GC悲观策略之ParallelGC篇/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="gc-parallel-gc-">GC悲观策略之Parallel GC篇</h1>
<h1 id="-bluedavy-blog-https-blog-bluedavy-com-"><a href="https://blog.bluedavy.com/" target="_blank">BlueDavy之技术blog</a></h1>
<p>{互联网，OSGi，Java, High Scalability, High Performance,HA}</p>
<ul>
<li><a href="https://blog.bluedavy.com/" target="_blank">Home</a></li>
<li><a href="https://blog.bluedavy.com/?page_id=2" target="_blank">About</a></li>
<li><a href="https://blog.bluedavy.com/?page_id=81" target="_blank">Photos</a></li>
</ul>
<h2 id="-gc-parallel-gc-https-blog-bluedavy-com-p-166-gc-parallel-gc-"><a href="https://blog.bluedavy.com/?p=166" title="GC悲观策略之Parallel GC篇" target="_blank">GC悲观策略之Parallel GC篇</a></h2>
<p>Nov 07</p>
<p><a href="http://bluedavy.com/" title="Visit bluedavy’s website" target="_blank">bluedavy</a><a href="https://blog.bluedavy.com/?cat=13" title="View all posts in jvm" target="_blank">jvm</a> <a href="https://blog.bluedavy.com/?tag=gc" target="_blank">gc</a>, <a href="https://blog.bluedavy.com/?tag=jvm" target="_blank">jvm</a>, <a href="https://blog.bluedavy.com/?tag=pessimism-policy" target="_blank">pessimism policy</a>, <a href="https://blog.bluedavy.com/?tag=%e6%82%b2%e8%a7%82%e7%ad%96%e7%95%a5" target="_blank">悲观策略</a> <a href="&quot;Comment on GC悲观策略之Parallel GC篇&quot;">12 Comments</a>
先来看段代码：
<a href="">?</a>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12
13</p>
<p>14
import</p>
<p>java.util./*;</p>
<p>public</p>
<p>class</p>
<p>SummaryCase{</p>
<p>public</p>
<p>static</p>
<p>void</p>
<p>main(String[] args)</p>
<p>throws</p>
<p>Exception{</p>
<p>List<Object> caches=</p>
<p>new</p>
<p>ArrayList<Object>();</p>
<p>for</p>
<p>(</p>
<p>int</p>
<p>i=</p>
<p>0</p>
<p>;i&lt;</p>
<p>7</p>
<p>;i++){</p>
<p>caches.add(</p>
<p>new</p>
<p>byte</p>
<p>[</p>
<p>1024</p>
<p>/*</p>
<p>1024</p>
<p>/*</p>
<p>3</p>
<p>]);</p>
<p>}</p>
<p>caches.clear();</p>
<p>for</p>
<p>(</p>
<p>int</p>
<p>i=</p>
<p>0</p>
<p>;i&lt;</p>
<p>2</p>
<p>;i++){</p>
<p>caches.add(</p>
<p>new</p>
<p>byte</p>
<p>[</p>
<p>1024</p>
<p>/*</p>
<p>1024</p>
<p>/*</p>
<p>3</p>
<p>]);</p>
<p>}</p>
<p>Thread.sleep(</p>
<p>10000</p>
<p>);</p>
<p>}</p>
<p>}</p>
<p>当用-Xms30m -Xmx30m -Xmn10m -XX:+UseParallelGC执行上面的代码时会执行几次Minor GC和几次Full GC呢？
按照eden空间不足时触发minor gc的规则，上面代码执行后的GC应为：M、M、M、M，但实际上上面代码执行后GC则为：M、M、M、F、F。
这里的原因就在于Parallel Scavenge GC时的悲观策略，当在eden上分配内存失败时且对象的大小尚不需要直接在old上分配时，会触发YGC，代码片段如下：</p>
<p><a href="">?</a>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12
13</p>
<p>14
15</p>
<p>16
17</p>
<p>18
19</p>
<p>20
21</p>
<p>22
23</p>
<p>24
25</p>
<p>26
27</p>
<p>28
29</p>
<p>30
31</p>
<p>32
33</p>
<p>34
35</p>
<p>36
37void</p>
<p>PSScavenge::invoke(){</p>
<p>...
bool</p>
<p>scavenge_was_done = PSScavenge::invoke_no_policy();</p>
<p>PSGCAdaptivePolicyCounters/* counters = heap-&gt;gc_policy_counters();
if</p>
<p>(UsePerfData)</p>
<p>counters-&gt;update_full_follows_scavenge(0);
if</p>
<p>(!scavenge_was_done ||</p>
<p>policy-&gt;should_full_GC(heap-&gt;old_gen()-&gt;free_in_bytes())) {
if</p>
<p>(UsePerfData)</p>
<p>counters-&gt;update_full_follows_scavenge(full_follows_scavenge);&lt;</p>
<p>GCCauseSetter gccs(heap, GCCause::_adaptive_size_policy);
if</p>
<p>(UseParallelOldGC) {</p>
<p>PSParallelCompact::invoke_no_policy(</p>
<p>false</p>
<p>);
}</p>
<p>else</p>
<p>{</p>
<p>PSMarkSweep::invoke_no_policy(</p>
<p>false</p>
<p>);
}</p>
<p>}
...</p>
<p>}
PSScavenge::invoke_no_policy{</p>
<p>...
if</p>
<p>(!should_attempt_scavenge()) {</p>
<p>return</p>
<p>false</p>
<p>;
}</p>
<p>...
}</p>
<p>bool</p>
<p>PSScavenge::should_attempt_scavenge() {
...</p>
<p>PSAdaptiveSizePolicy/* policy = heap-&gt;size_policy();</p>
<p>size_t</p>
<p>avg_promoted = (</p>
<p>size_t</p>
<p>) policy-&gt;padded_average_promoted_in_bytes();
size_t</p>
<p>promotion_estimate = MIN2(avg_promoted, young_gen-&gt;used_in_bytes());</p>
<p>bool</p>
<p>result = promotion_estimate &lt; old_gen-&gt;free_in_bytes();
...</p>
<p>return</p>
<p>result;
}</p>
<p>在上面should_attempt_scavenge代码片段中，可以看到会比较之前YGC晋升到Old中的平均大小与当前新生代中已被使用的字节数大小，取更小的值与旧生代目前剩余空间大小对比，如更大，则返回false，就终止了YGC的执行了，当返回false时，PSScavenge::invoke就将触发Full GC了。
在PSScavenge:invoke中还有一个条件为：policy-&gt;should_full_GC(heap-&gt;old_gen()-&gt;free_in_bytes()，来看看这段代码片段：</p>
<p><a href="">?</a>1</p>
<p>2
3</p>
<p>4
5bool</p>
<p>PSAdaptiveSizePolicy::should_full_GC(</p>
<p>size_t</p>
<p>old_free_in_bytes) {</p>
<p>bool</p>
<p>result = padded_average_promoted_in_bytes() &gt; (</p>
<p>float</p>
<p>) old_free_in_bytes;
...</p>
<p>return</p>
<p>result;
}</p>
<p>可看到，这段代码检查的也是之前YGC时晋升到old的平均大小是否大于了旧生代的剩余空间，如大于，则触发full gc。
总结上面分析的策略，可以看到采用Parallel GC的情况下，当YGC触发时，会有两个检查：
1、在YGC执行前，min(目前新生代已使用的大小,之前平均晋升到old的大小中的较小值) &gt; 旧生代剩余空间大小 ? 不执行YGC，直接执行Full GC : 执行YGC；
2、在YGC执行后，平均晋升到old的大小 &gt; 旧生代剩余空间大小 ? 触发Full GC ： 什么都不做。</p>
<p>按照这样的说明，再来看看上面代码的执行过程中eden和old大小的变化状况：
代码 eden old YGC FGC
第一次循环 3 0 0 0
第二次循环 6 0 0 0
第三次循环 3 6 1 0
第四次循环 6 6 1 0
第五次循环 3 12 2 0
第六次循环 6 12 2 0
第七次循环 3 18 3 1
第八次循环 6 18 3 1
第九次循环 3 3 3 2
在第7次循环时，YGC后旧生代剩余空间为2m，而之前平均晋级到old的对象大小为6m，因此在YGC后会触发一次FGC。
而第9次循环时，在YGC执行前，此时新生代已使用的大小为6m，之前晋级到old的平均大小为6m，这两者去最小值为6m，这个值已大于old的剩余空间，因此就不执行YGC，直接执行FGC了。</p>
<p>Sun JDK之所以要有悲观策略，我猜想理由是程序最终是会以一个较为稳态的状况执行的，此时每次YGC后晋升到old的对象大小应该是差不多的，在YGC时做好检查，避免等YGC后晋升到Old的对象导致old空间不足，因此还不如干脆就直接执行FGC，正因为悲观策略的存在，大家有些时候可能会看到old空间没满但full gc执行的状况。
埋个伏笔，大家将上面的执行参数换为-XX:+UseSerialGC执行看看，会发生什么呢？ <img src="" alt=":)"></p>
<p><a href="https://blog.bluedavy.com/?p=114" target="_blank">JavaOne美国之行–硅谷公司交流篇</a> <a href="https://blog.bluedavy.com/?p=170" target="_blank">GC悲观策略之Serial GC篇</a></p>
<h3 id="12-comments-add-yours-">12 Comments <em>(<a href="">+add yours?</a>)</em></h3>
<ol>
<li><img src="" alt=""> xan
<strong>Nov 08, 2010</strong> @ 11:58:44
代码布局不怎么给力啊 <img src="" alt=":)"></li>
<li><img src="https://secure.gravatar.com/avatar/5267242305332fe1affd9c4788191e1d?s=48&amp;d=&lt;path_to_url&gt;&amp;r=G" alt=""> <a href="http://bluedavy.com/" target="_blank">bluedavy</a>
<strong>Nov 08, 2010</strong> @ 12:23:52
确实不给力，我折腾下。</li>
<li><img src="https://secure.gravatar.com/avatar/3ed95d835a4c573899a9be257428c69f?s=48&amp;d=&lt;path_to_url&gt;&amp;r=G" alt=""> <a href="http://twitter.com/imbeneo" target="_blank">imbeneo</a>
<strong>Nov 08, 2010</strong> @ 13:12:45
我忘记了clean，结果总是OOM。</li>
<li><img src="https://secure.gravatar.com/avatar/03ec79001b70a7dc41d51c1db4db4baa?s=48&amp;d=&lt;path_to_url&gt;&amp;r=G" alt=""> oliver
<strong>Apr 26, 2011</strong> @ 11:34:35
我的疑问是为什么第一次full gc时old里面使用空间没有被回收掉，第二次full gc时old里面才回收？</li>
<li><img src="https://secure.gravatar.com/avatar/5267242305332fe1affd9c4788191e1d?s=48&amp;d=&lt;path_to_url&gt;&amp;r=G" alt=""> <a href="http://bluedavy.com/" target="_blank">bluedavy</a>
<strong>Apr 26, 2011</strong> @ 13:32:18
因为caches.clear是后来才调的…</li>
<li><img src="https://secure.gravatar.com/avatar/3cc9849504cb6c7c78b5533df02043ac?s=48&amp;d=&lt;path_to_url&gt;&amp;r=G" alt=""> <a href="http://www.dosmile.net/" target="_blank">yinhex</a>
<strong>Jul 09, 2011</strong> @ 22:38:20
这里我有个问题啊：我看你的分布式基础看到你能举例出很多大网站的设计。不知道你是从哪里可以看到这些信息的呢？可以细数一下你经常上去获取信息国外网站吗？</li>
<li><img src="https://secure.gravatar.com/avatar/5267242305332fe1affd9c4788191e1d?s=48&amp;d=&lt;path_to_url&gt;&amp;r=G" alt=""> <a href="http://bluedavy.com/" target="_blank">bluedavy</a>
<strong>Jul 11, 2011</strong> @ 10:01:48
@yinhex
一般来说，例如highscalability.com，还有各种国外的技术大会，各家著名公司的engineer的blog，都会有这些信息，:)</li>
<li><img src="https://secure.gravatar.com/avatar/f2ec9eb448e778dc947957c779fdd735?s=48&amp;d=&lt;path_to_url&gt;&amp;r=G" alt=""> Gary
<strong>Sep 29, 2011</strong> @ 11:09:58
-XX:+UseSerialGC gc.log发现是MMMMF,符合预期啊</li>
<li><img src="https://secure.gravatar.com/avatar/e9ef6892fbac714e6678cd30f4a212f4?s=48&amp;d=&lt;path_to_url&gt;&amp;r=G" alt=""> yangxuesong
<strong>Nov 29, 2011</strong> @ 17:31:49
一次full gc的执行流程是怎么用的呢？</li>
<li><img src="https://secure.gravatar.com/avatar/5267242305332fe1affd9c4788191e1d?s=48&amp;d=&lt;path_to_url&gt;&amp;r=G" alt=""> <a href="http://bluedavy.com/" target="_blank">bluedavy</a>
<strong>Dec 03, 2011</strong> @ 11:10:22
@yangxuesong
这个…要看是什么垃圾收集器…<h3 id="leave-a-reply">Leave a Reply</h3>
</li>
</ol>
<p><a href="">Cancel</a></p>
<p>Name (required)</p>
<p>Mail (required)</p>
<p>Website</p>
<p><img src="&quot;CAPTCHA Image&quot;" alt="CAPTCHA Image"></p>
<p><a href="&quot;Refresh Image&quot;"><img src="" alt="Refresh Image"></a></p>
<p>CAPTCHA Code /*</p>
<p><style type='text/css'>/#submit {display:none;}</style><br /> <input name="submit" type="submit" id="submit-alt" tabindex="6" value="Submit Comment" /></p>
<p>July 2013 M T W T F S S <a href="https://blog.bluedavy.com/?m=201303" title="View posts for March 2013" target="_blank">« Mar</a>     1234567 891011121314 15161718192021 22232425262728 293031  </p>
<h3 id="categories">Categories</h3>
<ul>
<li><a href="https://blog.bluedavy.com/?cat=63" title="View all posts filed under Java" target="_blank">Java</a> (10)</li>
<li><a href="https://blog.bluedavy.com/?cat=13" title="View all posts filed under jvm" target="_blank">jvm</a> (19)</li>
<li><a href="https://blog.bluedavy.com/?cat=56" title="View all posts filed under NoSQL" target="_blank">NoSQL</a> (7)</li>
<li><a href="https://blog.bluedavy.com/?cat=4" title="View all posts filed under SOA" target="_blank">SOA</a> (1)</li>
<li><a href="https://blog.bluedavy.com/?cat=11" title="关于《分布式Java应用：基础与实践》书部分章节的公开、书内容的纠错以及补充完善。" target="_blank">书:分布式Java应用</a> (5)</li>
<li><a href="https://blog.bluedavy.com/?cat=6" title="View all posts filed under 互联网" target="_blank">互联网</a> (5)</li>
<li><a href="https://blog.bluedavy.com/?cat=46" title="View all posts filed under 产品总结" target="_blank">产品总结</a> (1)</li>
<li><a href="https://blog.bluedavy.com/?cat=18" title="View all posts filed under 优化案例" target="_blank">优化案例</a> (1)</li>
<li><a href="https://blog.bluedavy.com/?cat=12" title="View all posts filed under 圆桌交流" target="_blank">圆桌交流</a> (2)</li>
<li><a href="https://blog.bluedavy.com/?cat=8" title="View all posts filed under 容量规划" target="_blank">容量规划</a> (2)</li>
<li><a href="https://blog.bluedavy.com/?cat=97" title="View all posts filed under 迁户口" target="_blank">迁户口</a> (1)</li>
<li><a href="https://blog.bluedavy.com/?cat=52" title="View all posts filed under 高可用" target="_blank">高可用</a> (1)</li>
<li><a href="https://blog.bluedavy.com/?cat=3" title="View all posts filed under 高并发" target="_blank">高并发</a> (3)</li>
<li><p><a href="https://blog.bluedavy.com/?cat=1" title="关于性能优化方面的一些东西。" target="_blank">高性能</a> (2)</p>
<h3 id="recent-comments">Recent Comments</h3>
</li>
<li><p><a href="http://code1.riaos.com/?p=5030138" target="_blank">JVM调优 | code1（code1.riaos.com）</a> on <a href="https://blog.bluedavy.com/?p=70&amp;cpage=1#comment-16520" target="_blank">说说MaxTenuringThreshold这个参数</a></p>
</li>
<li><a href="http://architecture1.riaos.com/?p=3063358" target="_blank">JVM调优 | architecture（riaos.com）</a> on <a href="https://blog.bluedavy.com/?p=70&amp;cpage=1#comment-16519" target="_blank">说说MaxTenuringThreshold这个参数</a></li>
<li><a href="http://bluedavy.com/" target="_blank">bluedavy</a> on <a href="https://blog.bluedavy.com/?p=409&amp;cpage=1#comment-16462" target="_blank">一个Java应用频繁抛异常导致cpu us诡异现象的案例</a></li>
<li>xiaobo on <a href="https://blog.bluedavy.com/?p=409&amp;cpage=1#comment-16460" target="_blank">一个Java应用频繁抛异常导致cpu us诡异现象的案例</a></li>
<li><a href="http://bluedavy.com/" target="_blank">bluedavy</a> on <a href="https://blog.bluedavy.com/?p=409&amp;cpage=1#comment-16459" target="_blank">一个Java应用频繁抛异常导致cpu us诡异现象的案例</a></li>
</ul>
<h3 id="tags">Tags</h3>
<p><a href="https://blog.bluedavy.com/?tag=btrace" title="2 topics" target="_blank">btrace</a> <a href="https://blog.bluedavy.com/?tag=c1" title="1 topic" target="_blank">c1</a> <a href="https://blog.bluedavy.com/?tag=c2" title="1 topic" target="_blank">c2</a> <a href="https://blog.bluedavy.com/?tag=deflater" title="1 topic" target="_blank">Deflater</a> <a href="https://blog.bluedavy.com/?tag=facebook" title="2 topics" target="_blank">facebook</a> <a href="https://blog.bluedavy.com/?tag=gc" title="4 topics" target="_blank">gc</a> <a href="https://blog.bluedavy.com/?tag=gc-tuning" title="2 topics" target="_blank">gc tuning</a> <a href="https://blog.bluedavy.com/?tag=grizzly" title="2 topics" target="_blank">Grizzly</a> <a href="https://blog.bluedavy.com/?tag=hbase" title="6 topics" target="_blank">HBase</a> <a href="https://blog.bluedavy.com/?tag=hotspot" title="1 topic" target="_blank">hotspot</a> <a href="https://blog.bluedavy.com/?tag=inflater" title="1 topic" target="_blank">Inflater</a> <a href="https://blog.bluedavy.com/?tag=interpreter" title="1 topic" target="_blank">interpreter</a> <a href="https://blog.bluedavy.com/?tag=javac" title="1 topic" target="_blank">javac</a> <a href="https://blog.bluedavy.com/?tag=java-code-generation" title="1 topic" target="_blank">java code generation</a> <a href="https://blog.bluedavy.com/?tag=javaone" title="4 topics" target="_blank">JavaOne</a> <a href="https://blog.bluedavy.com/?tag=javaone-general-technical-session" title="1 topic" target="_blank">javaone general technical session</a> <a href="https://blog.bluedavy.com/?tag=java%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c" title="1 topic" target="_blank">java代码执行</a> <a href="https://blog.bluedavy.com/?tag=java-%e5%b9%b6%e5%8f%91" title="1 topic" target="_blank">Java 并发</a> <a href="https://blog.bluedavy.com/?tag=jit" title="1 topic" target="_blank">jit</a> <a href="https://blog.bluedavy.com/?tag=jvm" title="12 topics" target="_blank">jvm</a> <a href="https://blog.bluedavy.com/?tag=memory-management" title="1 topic" target="_blank">memory management</a> <a href="https://blog.bluedavy.com/?tag=native-memory-leak" title="1 topic" target="_blank">Native Memory Leak</a> <a href="https://blog.bluedavy.com/?tag=nosql" title="2 topics" target="_blank">NoSQL</a> <a href="https://blog.bluedavy.com/?tag=oom" title="1 topic" target="_blank">oom</a> <a href="https://blog.bluedavy.com/?tag=oracle-keynote" title="1 topic" target="_blank">oracle keynote</a> <a href="https://blog.bluedavy.com/?tag=pessimism-policy" title="1 topic" target="_blank">pessimism policy</a> <a href="https://blog.bluedavy.com/?tag=references" title="1 topic" target="_blank">references</a> <a href="https://blog.bluedavy.com/?tag=rpc" title="2 topics" target="_blank">RPC</a> <a href="https://blog.bluedavy.com/?tag=serial-gc" title="1 topic" target="_blank">serial gc</a> <a href="https://blog.bluedavy.com/?tag=soa" title="2 topics" target="_blank">SOA</a> <a href="https://blog.bluedavy.com/?tag=sun-jdk" title="1 topic" target="_blank">sun jdk</a> <a href="https://blog.bluedavy.com/?tag=sun-jdk-oom" title="1 topic" target="_blank">sun jdk oom</a> <a href="https://blog.bluedavy.com/?tag=web%e5%ae%b9%e9%87%8f%e8%a7%84%e5%88%92%e7%9a%84%e8%89%ba%e6%9c%af" title="1 topic" target="_blank">Web容量规划的艺术</a> <a href="https://blog.bluedavy.com/?tag=yuanzhuo" title="1 topic" target="_blank">yuanzhuo</a> <a href="https://blog.bluedavy.com/?tag=%e4%b9%a6" title="1 topic" target="_blank">书:分布式Java应用</a> <a href="https://blog.bluedavy.com/?tag=%e4%b9%a6%e8%af%84" title="1 topic" target="_blank">书评</a> <a href="https://blog.bluedavy.com/?tag=%e4%ba%92%e8%81%94%e7%bd%91%e6%8a%80%e6%9c%af" title="1 topic" target="_blank">互联网技术</a> <a href="https://blog.bluedavy.com/?tag=%e4%ba%a4%e6%b5%81" title="1 topic" target="_blank">交流</a> <a href="https://blog.bluedavy.com/?tag=%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86" title="1 topic" target="_blank">内存管理</a> <a href="https://blog.bluedavy.com/?tag=%e5%88%86%e5%b8%83%e5%bc%8fjava%e5%ba%94%e7%94%a8" title="2 topics" target="_blank">分布式Java应用</a> <a href="https://blog.bluedavy.com/?tag=%e5%9c%86%e6%a1%8c%e4%ba%a4%e6%b5%81" title="1 topic" target="_blank">圆桌交流</a> <a href="https://blog.bluedavy.com/?tag=%e5%ae%b9%e9%87%8f%e8%a7%84%e5%88%92" title="2 topics" target="_blank">容量规划</a> <a href="https://blog.bluedavy.com/?tag=%e6%82%b2%e8%a7%82%e7%ad%96%e7%95%a5" title="3 topics" target="_blank">悲观策略</a> <a href="https://blog.bluedavy.com/?tag=%e6%9c%8d%e5%8a%a1%e6%a1%86%e6%9e%b6" title="1 topic" target="_blank">服务框架</a> <a href="https://blog.bluedavy.com/?tag=%e7%a1%85%e8%b0%b7%e5%85%ac%e5%8f%b8" title="1 topic" target="_blank">硅谷公司</a></p>
<h3 id="-">订阅</h3>
<h3 id="-">推荐书籍</h3>
<h3 id="my-book">My Book</h3>
<p><a href="http://book.douban.com/subject/4848587/" title="分布式Java应用：基础与实践" target="_blank"><img src="" alt=""></a> <a href="http://book.douban.com/subject/3843896/" title="OSGi原理与最佳实践" target="_blank"><img src="" alt=""></a>
© <a href="https://blog.bluedavy.com/" target="_blank">BlueDavy之技术blog</a> 2013</p>
<p><a href="http://icondock.com/" target="_blank">Icons</a> &amp; <a href="http://www.ndesign-studio.com/wp-themes" target="_blank">Wordpress Theme</a> by <a href="http://www.ndesign-studio.com/" target="_blank">N.Design</a></p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li></span><span class="breadcrumb"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li><li><a href="/categories/Java&J2EE/JVM/">JVM</a></li></span></span> | <span class="tags">Tagged <a href="/tags/JVM/" class="label label-primary">JVM</a><a href="/tags/Java&J2EE/" class="label label-success">Java&J2EE</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:42"datetime="2014-03-07 09:54:42"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-JVM--GC悲观策略之ParallelGC篇/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JavaJ2EE-JVM--GC悲观策略之ParallelGC篇" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--BTrace使用简介/">BTrace使用简介</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:41.000Z"> <a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--BTrace使用简介/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="btrace-">BTrace使用简介</h1>
<h1 id="-bluedavy-blog-https-blog-bluedavy-com-"><a href="https://blog.bluedavy.com/" target="_blank">BlueDavy之技术blog</a></h1>
<p>{互联网，OSGi，Java, High Scalability, High Performance,HA}</p>
<ul>
<li><a href="https://blog.bluedavy.com/" target="_blank">Home</a></li>
<li><a href="https://blog.bluedavy.com/?page_id=2" target="_blank">About</a></li>
<li><a href="https://blog.bluedavy.com/?page_id=81" target="_blank">Photos</a></li>
</ul>
<h2 id="-btrace-https-blog-bluedavy-com-p-185-btrace-"><a href="https://blog.bluedavy.com/?p=185" title="BTrace使用简介" target="_blank">BTrace使用简介</a></h2>
<p>Nov 11</p>
<p><a href="http://bluedavy.com/" title="Visit bluedavy’s website" target="_blank">bluedavy</a><a href="https://blog.bluedavy.com/?cat=13" title="View all posts in jvm" target="_blank">jvm</a> <a href="https://blog.bluedavy.com/?tag=btrace" target="_blank">btrace</a> <a href="&quot;Comment on BTrace使用简介&quot;">13 Comments</a>
很多时候在online的应用出现问题时，很多时候我们需要知道更多的程序的运行细节，但又不可能在开发的时候就把程序中所有的运行细节都打印到日志上，通常这个时候能采取的就是修改代码，重新部署，然后再观察，但这种方法对于online应用来说不是很好，另外一方面如果碰到不好改的代码，例如引用的其他的外部的包什么的，就很麻烦了，BTrace就是一个可以在不改代码、不重启应用的情况下，动态的查看程序运行细节的工具，其官方网站在此：<a href="http://kenai.com/projects/btrace/" target="_blank"><a href="http://kenai.com/projects/btrace/">http://kenai.com/projects/btrace/</a></a>，在这篇blog中，就来看看如何用BTrace来动态的监测方法的一些运行细节状况。
BTrace通过动态的挂接用java写的代码到运行时上来获取到一些运行细节，例如典型的使用btrace的方法为：
btrace -cp [btrace的jar所在的路径，默认为btrace/build下] [pid] [需要运行的java代码]
例如一段这样的代码：
<a href="">?</a>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12
13</p>
<p>14
15</p>
<p>16
17</p>
<p>18
19</p>
<p>20
21</p>
<p>22
23</p>
<p>24
25</p>
<p>26
import</p>
<p>java.util.Random;</p>
<p>public</p>
<p>class</p>
<p>Case1{</p>
<p>public</p>
<p>static</p>
<p>void</p>
<p>main(String[] args)</p>
<p>throws</p>
<p>Exception{</p>
<p>Random random=</p>
<p>new</p>
<p>Random();</p>
<p>CaseObject object=</p>
<p>new</p>
<p>CaseObject();</p>
<p>boolean</p>
<p>result=</p>
<p>true</p>
<p>;</p>
<p>while</p>
<p>(result){</p>
<p>result=object.execute(random.nextInt(</p>
<p>1000</p>
<p>));</p>
<p>Thread.sleep(</p>
<p>1000</p>
<p>);</p>
<p>}</p>
<p>}</p>
<p>}
public</p>
<p>class</p>
<p>CaseObject{</p>
<p>private</p>
<p>static</p>
<p>int</p>
<p>sleepTotalTime=</p>
<p>0</p>
<p>;  </p>
<p>public</p>
<p>boolean</p>
<p>execute(</p>
<p>int</p>
<p>sleepTime)</p>
<p>throws</p>
<p>Exception{</p>
<p>System.out.println(</p>
<p>&quot;sleep: &quot;</p>
<p>+sleepTime);</p>
<p>sleepTotalTime+=sleepTime;</p>
<p>Thread.sleep(sleepTime);</p>
<p>return</p>
<p>true</p>
<p>;</p>
<p>}</p>
<p>}</p>
<p>如在程序运行的情况下，想知道调用CaseObject的execute方法的以下几种情况，在BTrace中可以这么做：
1、调用此方法时传入的是什么参数，返回的是什么值，当时sleepTotalTime是多少？
BTrace脚本如下：</p>
<p><a href="">?</a>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12
13</p>
<p>14
15</p>
<p>16</p>
<p>import</p>
<p>static</p>
<p>com.sun.btrace.BTraceUtils./*;</p>
<p>import</p>
<p>com.sun.btrace.annotations./*;</p>
<p>@BTrace</p>
<p>public</p>
<p>class</p>
<p>TraceMethodArgsAndReturn{</p>
<p>@OnMethod</p>
<p>(</p>
<p>clazz=</p>
<p>&quot;CaseObject&quot;</p>
<p>,</p>
<p>method=</p>
<p>&quot;execute&quot;</p>
<p>,</p>
<p>location=</p>
<p>@Location</p>
<p>(Kind.RETURN)</p>
<p>)</p>
<p>public</p>
<p>static</p>
<p>void</p>
<p>traceExecute(</p>
<p>@Self</p>
<p>CaseObject instance,</p>
<p>int</p>
<p>sleepTime,</p>
<p>@Return</p>
<p>boolean</p>
<p>result){</p>
<p>println(</p>
<p>&quot;call CaseObject.execute&quot;</p>
<p>);</p>
<p>println(strcat(</p>
<p>&quot;sleepTime is:&quot;</p>
<p>,str(sleepTime)));</p>
<p>println(strcat(</p>
<p>&quot;sleepTotalTime is:&quot;</p>
<p>,str(get(field(</p>
<p>&quot;CaseObject&quot;</p>
<p>,</p>
<p>&quot;sleepTotalTime&quot;</p>
<p>),instance))));</p>
<p>println(strcat(</p>
<p>&quot;return value is:&quot;</p>
<p>,str(result)));</p>
<p>}</p>
<p>}</p>
<p>然后直接执行btrace -cp btrace/build [pid] TraceMethodArgsAndReturn.java就可以了。
当程序中调用到caseobject的execute方法时，就会在btrace的console中输出相应的信息。
2、execute方法执行耗时是多久？
BTrace脚本如下：</p>
<p><a href="">?</a>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12
13</p>
<p>14
15</p>
<p>16
17</p>
<p>18
19</p>
<p>20
21</p>
<p>22
23</p>
<p>24</p>
<p>import</p>
<p>static</p>
<p>com.sun.btrace.BTraceUtils./*;</p>
<p>import</p>
<p>com.sun.btrace.annotations./*;</p>
<p>@BTrace</p>
<p>public</p>
<p>class</p>
<p>TraceMethodExecuteTime{</p>
<p>@TLS</p>
<p>static</p>
<p>long</p>
<p>beginTime;</p>
<p>@OnMethod</p>
<p>(</p>
<p>clazz=</p>
<p>&quot;CaseObject&quot;</p>
<p>,</p>
<p>method=</p>
<p>&quot;execute&quot;</p>
<p>)</p>
<p>public</p>
<p>static</p>
<p>void</p>
<p>traceExecuteBegin(){</p>
<p>beginTime=timeMillis();</p>
<p>}</p>
<p>@OnMethod</p>
<p>(</p>
<p>clazz=</p>
<p>&quot;CaseObject&quot;</p>
<p>,</p>
<p>method=</p>
<p>&quot;execute&quot;</p>
<p>,</p>
<p>location=</p>
<p>@Location</p>
<p>(Kind.RETURN)</p>
<p>)</p>
<p>public</p>
<p>static</p>
<p>void</p>
<p>traceExecute(</p>
<p>int</p>
<p>sleepTime,</p>
<p>@Return</p>
<p>boolean</p>
<p>result){</p>
<p>println(strcat(strcat(</p>
<p>&quot;CaseObject.execute time is:&quot;</p>
<p>,str(timeMillis()-beginTime)),</p>
<p>&quot;ms&quot;</p>
<p>));</p>
<p>}</p>
<p>}</p>
<p>3、谁调用了execute方法？
BTrace脚本如下：</p>
<p><a href="">?</a>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12
13     </p>
<p>import</p>
<p>static</p>
<p>com.sun.btrace.BTraceUtils./*;</p>
<p>import</p>
<p>com.sun.btrace.annotations./*;</p>
<p>@BTrace</p>
<p>public</p>
<p>class</p>
<p>TraceMethodCallee{</p>
<p>@OnMethod</p>
<p>(</p>
<p>clazz=</p>
<p>&quot;CaseObject&quot;</p>
<p>,</p>
<p>method=</p>
<p>&quot;execute&quot;</p>
<p>)</p>
<p>public</p>
<p>static</p>
<p>void</p>
<p>traceExecute(){</p>
<p>println(</p>
<p>&quot;who call CaseObject.execute :&quot;</p>
<p>);</p>
<p>jstack();</p>
<p>}
}</p>
<p>4、有没有人调用CaseObject中的哪一行代码？
BTrace脚本如下：</p>
<p><a href="">?</a>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12</p>
<p>import</p>
<p>static</p>
<p>com.sun.btrace.BTraceUtils./*;</p>
<p>import</p>
<p>com.sun.btrace.annotations./*;</p>
<p>@BTrace</p>
<p>public</p>
<p>class</p>
<p>TraceMethodLine{</p>
<p>@OnMethod</p>
<p>(</p>
<p>clazz=</p>
<p>&quot;CaseObject&quot;</p>
<p>,</p>
<p>location=</p>
<p>@Location</p>
<p>(value=Kind.LINE,line=</p>
<p>5</p>
<p>)</p>
<p>)</p>
<p>public</p>
<p>static</p>
<p>void</p>
<p>traceExecute(</p>
<p>@ProbeClassName</p>
<p>String pcn,</p>
<p>@ProbeMethodName</p>
<p>String pmn,</p>
<p>int</p>
<p>line){</p>
<p>println(strcat(strcat(strcat(</p>
<p>&quot;call &quot;</p>
<p>,pcn),</p>
<p>&quot;.&quot;</p>
<p>),pmn));</p>
<p>}</p>
<p>}</p>
<p>从上面可看出，在有了BTrace后，要动态的跟踪代码的运行细节还是非常爽的，更多的细节的操作请大家查看BTrace的<a href="http://kenai.com/projects/btrace/pages/UserGuide" target="_blank">User Guide</a>。</p>
<p><a href="https://blog.bluedavy.com/?p=170" target="_blank">GC悲观策略之Serial GC篇</a> <a href="https://blog.bluedavy.com/?p=187" target="_blank">学习JVM的References</a></p>
<h3 id="13-comments-add-yours-">13 Comments <em>(<a href="">+add yours?</a>)</em></h3>
<ol>
<li><img src="" alt=""> <a href="http://www.helishi.net/" target="_blank">ikbear</a>
<strong>Nov 11, 2010</strong> @ 17:41:12
收藏了。</li>
<li><img src="https://secure.gravatar.com/avatar/4a2de3195dfd282b2f0ea420dc7a6a7a?s=48&amp;d=&lt;path_to_url&gt;&amp;r=G" alt=""> pandonix
<strong>Nov 11, 2010</strong> @ 20:58:54
关于方法的执行时间和返回值，有个问题请教，如果调用量非常大的方法，有没有类似染色日志这样的功能：只需要打印参数符合某种条件的调用情况？</li>
<li><img src="https://secure.gravatar.com/avatar/5267242305332fe1affd9c4788191e1d?s=48&amp;d=&lt;path_to_url&gt;&amp;r=G" alt=""> <a href="http://bluedavy.com/" target="_blank">bluedavy</a>
<strong>Nov 12, 2010</strong> @ 11:42:06
<img src="" alt=":)"> ，这个自己可以在脚本里判断下…</li>
<li><img src="https://secure.gravatar.com/avatar/bd17360b1eb0b26b89a19de9cebed4f9?s=48&amp;d=&lt;path_to_url&gt;&amp;r=G" alt=""> vitty
<strong>Nov 14, 2010</strong> @ 14:09:22
不知道这个对被监测程序的性能影响有多大？不过真的很爽呢。</li>
<li><img src="https://secure.gravatar.com/avatar/5267242305332fe1affd9c4788191e1d?s=48&amp;d=&lt;path_to_url&gt;&amp;r=G" alt=""> <a href="http://bluedavy.com/" target="_blank">bluedavy</a>
<strong>Nov 14, 2010</strong> @ 19:53:38
据使用来看，影响很小。</li>
<li><img src="https://secure.gravatar.com/avatar/baad2156c4a21abc487fb92bbd53a174?s=48&amp;d=&lt;path_to_url&gt;&amp;r=G" alt=""> bobo
<strong>Nov 16, 2010</strong> @ 10:16:58
学习,哈哈</li>
<li><img src="https://secure.gravatar.com/avatar/5ef11dda80e7ce522810093bd8a791eb?s=48&amp;d=&lt;path_to_url&gt;&amp;r=G" alt=""> xuanyuanzhiyuan
<strong>Dec 21, 2010</strong> @ 15:37:22
学习了 ：）</li>
<li><img src="https://secure.gravatar.com/avatar/4a2de3195dfd282b2f0ea420dc7a6a7a?s=48&amp;d=&lt;path_to_url&gt;&amp;r=G" alt=""> pandonix
<strong>Dec 27, 2010</strong> @ 23:07:55
运行第一个例子：TraceMethodArgsAndReturn.java报错：
TraceMethodArgsAndReturn.java:10: 找不到符号
符号： 类 CaseObject
位置： 类 TraceMethodArgsAndReturn
把@Self CaseObject instance修改成为@Self Object self，并且去掉println(strcat(“sleepTotalTime is:”,str(get(field(“CaseObject”,”sleepTotalTime”),instance))));
就可以了，但是楼主希望获取sleepTotalTime的需求就满足不鸟了。还不太明白@Self的含义，再看看纠结的文档吧</li>
<li><img src="https://secure.gravatar.com/avatar/4a2de3195dfd282b2f0ea420dc7a6a7a?s=48&amp;d=&lt;path_to_url&gt;&amp;r=G" alt=""> pandonix
<strong>Dec 27, 2010</strong> @ 23:44:37
找到原因了，是CaseObject不在classthpath中，如果用到了@Self CaseObject ，编译TraceMethodArgsAndReturn.java时会去找CaseObject类。
简单的将CaseObject.java放到跟TraceMethodArgsAndReturn.java同一目录即可</li>
<li><img src="https://secure.gravatar.com/avatar/6a8f8285a42a76f5e47159c9f09a7c4f?s=48&amp;d=&lt;path_to_url&gt;&amp;r=G" alt=""> 光夏
<strong>Jan 23, 2011</strong> @ 11:34:36
使用TLS得注意递归调用的情况吧</li>
<li><img src="" alt=""> victorcai
<strong>Jul 19, 2011</strong> @ 15:03:18
请问各位大侠btrace能否在windows xp上使用,是否需要设置环境变量,我在windows xp上每次使用都失败<h3 id="leave-a-reply">Leave a Reply</h3>
</li>
</ol>
<p><a href="">Cancel</a></p>
<p>Name (required)</p>
<p>Mail (required)</p>
<p>Website</p>
<p><img src="https://blog.bluedavy.com/wp-content/plugins/si-captcha-for-wordpress/captcha/securimage_show.php?si_form_id=com&amp;prefix=2KNUhEvWsRaEKSqu" alt="CAPTCHA Image" title="CAPTCHA Image"></p>
<p><a href="&quot;Refresh Image&quot;"><img src="" alt="Refresh Image"></a></p>
<p>CAPTCHA Code /*</p>
<p><style type='text/css'>/#submit {display:none;}</style><br /> <input name="submit" type="submit" id="submit-alt" tabindex="6" value="Submit Comment" /></p>
<p>July 2013 M T W T F S S <a href="https://blog.bluedavy.com/?m=201303" title="View posts for March 2013" target="_blank">« Mar</a>     1234567 891011121314 15161718192021 22232425262728 293031  </p>
<h3 id="categories">Categories</h3>
<ul>
<li><a href="https://blog.bluedavy.com/?cat=63" title="View all posts filed under Java" target="_blank">Java</a> (10)</li>
<li><a href="https://blog.bluedavy.com/?cat=13" title="View all posts filed under jvm" target="_blank">jvm</a> (19)</li>
<li><a href="https://blog.bluedavy.com/?cat=56" title="View all posts filed under NoSQL" target="_blank">NoSQL</a> (7)</li>
<li><a href="https://blog.bluedavy.com/?cat=4" title="View all posts filed under SOA" target="_blank">SOA</a> (1)</li>
<li><a href="https://blog.bluedavy.com/?cat=11" title="关于《分布式Java应用：基础与实践》书部分章节的公开、书内容的纠错以及补充完善。" target="_blank">书:分布式Java应用</a> (5)</li>
<li><a href="https://blog.bluedavy.com/?cat=6" title="View all posts filed under 互联网" target="_blank">互联网</a> (5)</li>
<li><a href="https://blog.bluedavy.com/?cat=46" title="View all posts filed under 产品总结" target="_blank">产品总结</a> (1)</li>
<li><a href="https://blog.bluedavy.com/?cat=18" title="View all posts filed under 优化案例" target="_blank">优化案例</a> (1)</li>
<li><a href="https://blog.bluedavy.com/?cat=12" title="View all posts filed under 圆桌交流" target="_blank">圆桌交流</a> (2)</li>
<li><a href="https://blog.bluedavy.com/?cat=8" title="View all posts filed under 容量规划" target="_blank">容量规划</a> (2)</li>
<li><a href="https://blog.bluedavy.com/?cat=97" title="View all posts filed under 迁户口" target="_blank">迁户口</a> (1)</li>
<li><a href="https://blog.bluedavy.com/?cat=52" title="View all posts filed under 高可用" target="_blank">高可用</a> (1)</li>
<li><a href="https://blog.bluedavy.com/?cat=3" title="View all posts filed under 高并发" target="_blank">高并发</a> (3)</li>
<li><p><a href="https://blog.bluedavy.com/?cat=1" title="关于性能优化方面的一些东西。" target="_blank">高性能</a> (2)</p>
<h3 id="recent-comments">Recent Comments</h3>
</li>
<li><p><a href="http://code1.riaos.com/?p=5030138" target="_blank">JVM调优 | code1（code1.riaos.com）</a> on <a href="https://blog.bluedavy.com/?p=70&amp;cpage=1#comment-16520" target="_blank">说说MaxTenuringThreshold这个参数</a></p>
</li>
<li><a href="http://architecture1.riaos.com/?p=3063358" target="_blank">JVM调优 | architecture（riaos.com）</a> on <a href="https://blog.bluedavy.com/?p=70&amp;cpage=1#comment-16519" target="_blank">说说MaxTenuringThreshold这个参数</a></li>
<li><a href="http://bluedavy.com/" target="_blank">bluedavy</a> on <a href="https://blog.bluedavy.com/?p=409&amp;cpage=1#comment-16462" target="_blank">一个Java应用频繁抛异常导致cpu us诡异现象的案例</a></li>
<li>xiaobo on <a href="https://blog.bluedavy.com/?p=409&amp;cpage=1#comment-16460" target="_blank">一个Java应用频繁抛异常导致cpu us诡异现象的案例</a></li>
<li><a href="http://bluedavy.com/" target="_blank">bluedavy</a> on <a href="https://blog.bluedavy.com/?p=409&amp;cpage=1#comment-16459" target="_blank">一个Java应用频繁抛异常导致cpu us诡异现象的案例</a></li>
</ul>
<h3 id="tags">Tags</h3>
<p><a href="https://blog.bluedavy.com/?tag=btrace" title="2 topics" target="_blank">btrace</a> <a href="https://blog.bluedavy.com/?tag=c1" title="1 topic" target="_blank">c1</a> <a href="https://blog.bluedavy.com/?tag=c2" title="1 topic" target="_blank">c2</a> <a href="https://blog.bluedavy.com/?tag=deflater" title="1 topic" target="_blank">Deflater</a> <a href="https://blog.bluedavy.com/?tag=facebook" title="2 topics" target="_blank">facebook</a> <a href="https://blog.bluedavy.com/?tag=gc" title="4 topics" target="_blank">gc</a> <a href="https://blog.bluedavy.com/?tag=gc-tuning" title="2 topics" target="_blank">gc tuning</a> <a href="https://blog.bluedavy.com/?tag=grizzly" title="2 topics" target="_blank">Grizzly</a> <a href="https://blog.bluedavy.com/?tag=hbase" title="6 topics" target="_blank">HBase</a> <a href="https://blog.bluedavy.com/?tag=hotspot" title="1 topic" target="_blank">hotspot</a> <a href="https://blog.bluedavy.com/?tag=inflater" title="1 topic" target="_blank">Inflater</a> <a href="https://blog.bluedavy.com/?tag=interpreter" title="1 topic" target="_blank">interpreter</a> <a href="https://blog.bluedavy.com/?tag=javac" title="1 topic" target="_blank">javac</a> <a href="https://blog.bluedavy.com/?tag=java-code-generation" title="1 topic" target="_blank">java code generation</a> <a href="https://blog.bluedavy.com/?tag=javaone" title="4 topics" target="_blank">JavaOne</a> <a href="https://blog.bluedavy.com/?tag=javaone-general-technical-session" title="1 topic" target="_blank">javaone general technical session</a> <a href="https://blog.bluedavy.com/?tag=java%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c" title="1 topic" target="_blank">java代码执行</a> <a href="https://blog.bluedavy.com/?tag=java-%e5%b9%b6%e5%8f%91" title="1 topic" target="_blank">Java 并发</a> <a href="https://blog.bluedavy.com/?tag=jit" title="1 topic" target="_blank">jit</a> <a href="https://blog.bluedavy.com/?tag=jvm" title="12 topics" target="_blank">jvm</a> <a href="https://blog.bluedavy.com/?tag=memory-management" title="1 topic" target="_blank">memory management</a> <a href="https://blog.bluedavy.com/?tag=native-memory-leak" title="1 topic" target="_blank">Native Memory Leak</a> <a href="https://blog.bluedavy.com/?tag=nosql" title="2 topics" target="_blank">NoSQL</a> <a href="https://blog.bluedavy.com/?tag=oom" title="1 topic" target="_blank">oom</a> <a href="https://blog.bluedavy.com/?tag=oracle-keynote" title="1 topic" target="_blank">oracle keynote</a> <a href="https://blog.bluedavy.com/?tag=pessimism-policy" title="1 topic" target="_blank">pessimism policy</a> <a href="https://blog.bluedavy.com/?tag=references" title="1 topic" target="_blank">references</a> <a href="https://blog.bluedavy.com/?tag=rpc" title="2 topics" target="_blank">RPC</a> <a href="https://blog.bluedavy.com/?tag=serial-gc" title="1 topic" target="_blank">serial gc</a> <a href="https://blog.bluedavy.com/?tag=soa" title="2 topics" target="_blank">SOA</a> <a href="https://blog.bluedavy.com/?tag=sun-jdk" title="1 topic" target="_blank">sun jdk</a> <a href="https://blog.bluedavy.com/?tag=sun-jdk-oom" title="1 topic" target="_blank">sun jdk oom</a> <a href="https://blog.bluedavy.com/?tag=web%e5%ae%b9%e9%87%8f%e8%a7%84%e5%88%92%e7%9a%84%e8%89%ba%e6%9c%af" title="1 topic" target="_blank">Web容量规划的艺术</a> <a href="https://blog.bluedavy.com/?tag=yuanzhuo" title="1 topic" target="_blank">yuanzhuo</a> <a href="https://blog.bluedavy.com/?tag=%e4%b9%a6" title="1 topic" target="_blank">书:分布式Java应用</a> <a href="https://blog.bluedavy.com/?tag=%e4%b9%a6%e8%af%84" title="1 topic" target="_blank">书评</a> <a href="https://blog.bluedavy.com/?tag=%e4%ba%92%e8%81%94%e7%bd%91%e6%8a%80%e6%9c%af" title="1 topic" target="_blank">互联网技术</a> <a href="https://blog.bluedavy.com/?tag=%e4%ba%a4%e6%b5%81" title="1 topic" target="_blank">交流</a> <a href="https://blog.bluedavy.com/?tag=%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86" title="1 topic" target="_blank">内存管理</a> <a href="https://blog.bluedavy.com/?tag=%e5%88%86%e5%b8%83%e5%bc%8fjava%e5%ba%94%e7%94%a8" title="2 topics" target="_blank">分布式Java应用</a> <a href="https://blog.bluedavy.com/?tag=%e5%9c%86%e6%a1%8c%e4%ba%a4%e6%b5%81" title="1 topic" target="_blank">圆桌交流</a> <a href="https://blog.bluedavy.com/?tag=%e5%ae%b9%e9%87%8f%e8%a7%84%e5%88%92" title="2 topics" target="_blank">容量规划</a> <a href="https://blog.bluedavy.com/?tag=%e6%82%b2%e8%a7%82%e7%ad%96%e7%95%a5" title="3 topics" target="_blank">悲观策略</a> <a href="https://blog.bluedavy.com/?tag=%e6%9c%8d%e5%8a%a1%e6%a1%86%e6%9e%b6" title="1 topic" target="_blank">服务框架</a> <a href="https://blog.bluedavy.com/?tag=%e7%a1%85%e8%b0%b7%e5%85%ac%e5%8f%b8" title="1 topic" target="_blank">硅谷公司</a></p>
<h3 id="-">订阅</h3>
<h3 id="-">推荐书籍</h3>
<h3 id="my-book">My Book</h3>
<p><a href="http://book.douban.com/subject/4848587/" title="分布式Java应用：基础与实践" target="_blank"><img src="" alt=""></a> <a href="http://book.douban.com/subject/3843896/" title="OSGi原理与最佳实践" target="_blank"><img src="" alt=""></a>
© <a href="https://blog.bluedavy.com/" target="_blank">BlueDavy之技术blog</a> 2013</p>
<p><a href="http://icondock.com/" target="_blank">Icons</a> &amp; <a href="http://www.ndesign-studio.com/wp-themes" target="_blank">Wordpress Theme</a> by <a href="http://www.ndesign-studio.com/" target="_blank">N.Design</a></p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li></span><span class="breadcrumb"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li><li><a href="/categories/Java&J2EE/JVM/">JVM</a></li></span></span> | <span class="tags">Tagged <a href="/tags/JVM/" class="label label-primary">JVM</a><a href="/tags/Java&J2EE/" class="label label-success">Java&J2EE</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:41"datetime="2014-03-07 09:54:41"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-JVM--BTrace使用简介/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JavaJ2EE-JVM--BTrace使用简介" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JavaJ2EE-Java_多线程-并发--聊聊并发（一）——深入分析Volatile的实现原理2/">聊聊并发（一）——深入分析Volatile的实现原理 (2)</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:41.000Z"> <a href="/2014/02/02/2014-02-02-JavaJ2EE-Java_多线程-并发--聊聊并发（一）——深入分析Volatile的实现原理2/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="-volatile-2-">聊聊并发（一）——深入分析Volatile的实现原理 (2)</h1>
<h3 id="-">分享到</h3>
<ul>
<li><a href="">一键分享</a></li>
<li><a href="">QQ空间</a></li>
<li><a href="">新浪微博</a></li>
<li><a href="">百度搜藏</a></li>
<li><a href="">人人网</a></li>
<li><a href="">腾讯微博</a></li>
<li><a href="">百度相册</a></li>
<li><a href="">开心网</a></li>
<li><a href="">腾讯朋友</a></li>
<li><a href="">百度贴吧</a></li>
<li><a href="">豆瓣网</a></li>
<li><a href="">搜狐微博</a></li>
<li><a href="">百度新首页</a></li>
<li><a href="">QQ好友</a></li>
<li><a href="">和讯微博</a></li>
<li><a href="">更多...</a></li>
</ul>
<p><a href="">百度分享</a></p>
<ul>
<li><a href="http://www.infoq.com/cn/aboutus" title="关于我们" target="_blank">关于我们</a></li>
<li><p><a href="http://www.infoq.com/cn/contribute" title="让大家在InfoQ上听见你的声音" target="_blank">让大家在InfoQ上听见你的声音</a></p>
</li>
<li><p>欢迎关注我们的：</p>
</li>
<li><a href="http://e.weibo.com/infoqchina" target="_blank"><img src="" alt=""></a></li>
<li><a href="http://www.infoq.com/cn/news/2013/02/infoq-wechat" target="_blank"><img src="" alt=""></a></li>
<li><a href="http://www.infoq.com/cn/rss/rss.action?token=J6EBu2hcpyEuMs9msdo8GyNCZTcWG7pm" target="_blank"><img src="" alt=""></a></li>
</ul>
<h1 id="-volatile-">聊聊并发（一）——深入分析Volatile的实现原理</h1>
<p>作者 <a href="http://www.infoq.com/cn/author/%E6%96%B9%E8%85%BE%E9%A3%9E" target="_blank">方腾飞</a> 发布于 二月 21, 2012 <em>|</em> <a href="">27 评论</a></p>
<ul>
<li><a href="&quot;分享到新浪微博&quot;">新浪微博</a> <a href="&quot;分享到腾讯微博&quot;">腾讯微博</a> <a href="&quot;分享到豆瓣网&quot;">豆瓣网</a> <a href="&quot;分享到Twitter&quot;">Twitter</a> <a href="&quot;分享到Facebook&quot;">Facebook</a> <a href="&quot;分享到linkedin&quot;">linkedin</a> <a href="&quot;分享到邮件分享&quot;">邮件分享</a> 更多 <a href="&quot;累计分享21次&quot;">21</a></li>
<li><a href="">稍后阅读</a></li>
<li><a href="http://www.infoq.com/cn/showbookmarks.action" target="_blank">我的阅读清单</a><h2 id="-"><strong>引言</strong></h2>
</li>
</ul>
<p>在多线程并发编程中synchronized和Volatile都扮演着重要的角色，Volatile是<strong>轻量级的synchronized</strong>，它在多处理器开发中保证了共享变量的“可见性”。可见性的意思是当一个线程修改一个共享变量时，另外一个线程能读到这个修改的值。</p>
<p>它在某些情况下比synchronized的开销更小，本文将深入分析在硬件层面上Inter处理器是如何实现Volatile的，通过深入分析能帮助我们正确的使用Volatile变量。</p>
<h2 id="-"><strong>术语定义</strong></h2>
<p>术语</p>
<p>英文单词</p>
<p>描述 共享变量</p>
<p>在多个线程之间能够被共享的变量被称为共享变量。共享变量包括所有的实例变量，静态变量和数组元素。他们都被存放在堆内存中，Volatile只作用于共享变量。 内存屏障</p>
<p>Memory Barriers</p>
<p>是一组处理器指令，用于实现对内存操作的顺序限制。 缓冲行</p>
<p>Cache line</p>
<p>缓存中可以分配的最小存储单位。处理器填写缓存线时会加载整个缓存线，需要使用多个主内存读周期。 原子操作</p>
<p>Atomic operations</p>
<p>不可中断的一个或一系列操作。 缓存行填充</p>
<p>cache line fill</p>
<p>当处理器识别到从内存中读取操作数是可缓存的，处理器读取整个缓存行到适当的缓存（L1，L2，L3的或所有） 缓存命中</p>
<p>cache hit</p>
<p>如果进行高速缓存行填充操作的内存位置仍然是下次处理器访问的地址时，处理器从缓存中读取操作数，而不是从内存。 写命中</p>
<p>write hit</p>
<p>当处理器将操作数写回到一个内存缓存的区域时，它首先会检查这个缓存的内存地址是否在缓存行中，如果存在一个有效的缓存行，则处理器将这个操作数写回到缓存，而不是写回到内存，这个操作被称为写命中。 写缺失</p>
<p>write misses the cache</p>
<p>一个有效的缓存行被写入到不存在的内存区域。</p>
<h2 id="-volatile-"><strong>Volatile的官方定义</strong></h2>
<p>Java语言规范第三版中对volatile的定义如下： java编程语言允许线程访问共享变量，为了确保共享变量能被准确和一致的更新，线程应该确保通过排他锁单独获得这个变量。Java语言提供了volatile，在某些情况下比锁更加方便。如果一个字段被声明成volatile，java线程内存模型确保所有线程看到这个变量的值是一致的。</p>
<h2 id="-volatile-"><strong>为什么要使用Volatile</strong></h2>
<p>Volatile变量修饰符如果使用<strong>恰当</strong>的话，它比synchronized的<strong>使用和执行成本会更低</strong>，因为它不会引起线程上下文的切换和调度。</p>
<h2 id="-volatile-"><strong>Volatile的实现原理</strong></h2>
<p>那么Volatile是如何来保证可见性的呢？在x86处理器下通过工具获取JIT编译器生成的汇编指令来看看对Volatile进行写操作CPU会做什么事情。
Java代码：</p>
<p>instance = new Singleton();//instance是volatile变量 汇编代码：</p>
<p>0x01a3de1d: movb $0x0,0x1104800(%esi);</p>
<p>0x01a3de24: <strong>lock</strong> addl $0x0,(%esp);</p>
<p>有volatile变量修饰的共享变量进行写操作的时候会多第二行汇编代码，通过查IA-32架构软件开发者手册可知，lock前缀的指令在多核处理器下会引发了两件事情。</p>
<ul>
<li>将当前处理器缓存行的数据会写回到系统内存。</li>
<li>这个写回内存的操作会引起在其他CPU里缓存了该内存地址的数据无效。</li>
</ul>
<p>处理器为了提高处理速度，不直接和内存进行通讯，而是先将系统内存的数据读到内部缓存（L1,L2或其他）后再进行操作，但操作完之后不知道何时会写到内存，如果对声明了Volatile变量进行写操作，JVM就会向处理器发送一条Lock前缀的指令，将这个变量所在缓存行的数据写回到系统内存。但是就算写回到内存，如果其他处理器缓存的值还是旧的，再执行计算操作就会有问题，所以在多处理器下，为了保证各个处理器的缓存是一致的，就会实现缓存一致性协议，每个处理器通过嗅探在总线上传播的数据来检查自己缓存的值是不是过期了，当处理器发现自己缓存行对应的内存地址被修改，就会将当前处理器的缓存行设置成无效状态，当处理器要对这个数据进行修改操作的时候，会强制重新从系统内存里把数据读到处理器缓存里。</p>
<p>这两件事情在IA-32软件开发者架构手册的第三册的多处理器管理章节（第八章）中有详细阐述。</p>
<p><strong>Lock前缀指令会引起处理器缓存回写到内存</strong>。Lock前缀指令导致在执行指令期间，声言处理器的 LOCK/# 信号。在多处理器环境中，LOCK/# 信号确保在声言该信号期间，处理器可以独占使用任何共享内存。（因为它会锁住总线，导致其他CPU不能访问总线，不能访问总线就意味着不能访问系统内存），但是在最近的处理器里，LOCK＃信号一般不锁总线，而是锁缓存，毕竟锁总线开销比较大。在8.1.4章节有详细说明锁定操作对处理器缓存的影响，对于Intel486和Pentium处理器，在锁操作时，总是在总线上声言LOCK/#信号。但在P6和最近的处理器中，如果访问的内存区域已经缓存在处理器内部，则不会声言LOCK/#信号。相反地，它会锁定这块内存区域的缓存并回写到内存，并使用缓存一致性机制来确保修改的原子性，此操作被称为“缓存锁定”，<strong>缓存一致性机制会阻止同时修改被两个以上处理器缓存的内存区域数据</strong>。</p>
<p><strong>一个处理器的缓存回写到内存会导致其他处理器的缓存无效</strong>。IA-32处理器和Intel 64处理器使用MESI（修改，独占，共享，无效）控制协议去维护内部缓存和其他处理器缓存的一致性。在多核处理器系统中进行操作的时候，IA-32 和Intel 64处理器能嗅探其他处理器访问系统内存和它们的内部缓存。它们使用嗅探技术保证它的内部缓存，系统内存和其他处理器的缓存的数据在总线上保持一致。例如在Pentium和P6 family处理器中，如果通过嗅探一个处理器来检测其他处理器打算写内存地址，而这个地址当前处理共享状态，那么正在嗅探的处理器将无效它的缓存行，在下次访问相同内存地址时，强制执行缓存行填充。</p>
<h2 id="-volatile-"><strong>Volatile的使用优化</strong></h2>
<p>著名的Java并发编程大师Doug lea在JDK7的并发包里新增一个队列集合类LinkedTransferQueue，他在使用Volatile变量时，用一种追加字节的方式来优化队列出队和入队的性能。</p>
<p>追加字节能优化性能？这种方式看起来很神奇，但如果深入理解处理器架构就能理解其中的奥秘。让我们先来看看LinkedTransferQueue这个类，它使用一个内部类类型来定义队列的头队列（Head）和尾节点（tail），而这个内部类PaddedAtomicReference相对于父类AtomicReference只做了一件事情，就将共享变量追加到64字节。我们可以来计算下，一个对象的引用占4个字节，它追加了15个变量共占60个字节，再加上父类的Value变量，一共64个字节。
//<em>/</em> head of the queue /<em>/ private transient final PaddedAtomicReference &lt; QNode &gt; head; //</em>/<em> tail of the queue /</em>/ private transient final PaddedAtomicReference &lt; QNode &gt; tail; static final class PaddedAtomicReference &lt; T &gt; extends AtomicReference &lt; T &gt; { // enough padding for 64bytes with 4byte refs Object p0, p1, p2, p3, p4, p5, p6, p7, p8, p9, pa, pb, pc, pd, pe; PaddedAtomicReference(T r) { super(r); } } public class AtomicReference &lt; V &gt; implements java.io.Serializable { private volatile V value; //省略其他代码 ｝</p>
<p><strong>为什么追加64字节能够提高并发编程的效率呢</strong>？ 因为对于英特尔酷睿i7，酷睿， Atom和NetBurst， Core Solo和Pentium M处理器的L1，L2或L3缓存的高速缓存行是64个字节宽，不支持部分填充缓存行，这意味着如果队列的头节点和尾节点都不足64字节的话，处理器会将它们都读到同一个高速缓存行中，在多处理器下每个处理器都会缓存同样的头尾节点，当一个处理器试图修改头接点时会将整个缓存行锁定，那么在缓存一致性机制的作用下，会导致其他处理器不能访问自己高速缓存中的尾节点，而队列的入队和出队操作是需要不停修改头接点和尾节点，所以在多处理器的情况下将会严重影响到队列的入队和出队效率。Doug lea使用追加到64字节的方式来填满高速缓冲区的缓存行，避免头接点和尾节点加载到同一个缓存行，使得头尾节点在修改时不会互相锁定。</p>
<p>那么是不是在使用Volatile变量时都应该追加到64字节呢？不是的。在两种场景下不应该使用这种方式。第一：<strong>缓存行非64字节宽的处理器</strong>，如P6系列和奔腾处理器，它们的L1和L2高速缓存行是32个字节宽。第二：<strong>共享变量不会被频繁的写</strong>。因为使用追加字节的方式需要处理器读取更多的字节到高速缓冲区，这本身就会带来一定的性能消耗，共享变量如果不被频繁写的话，锁的几率也非常小，就没必要通过追加字节的方式来避免相互锁定。</p>
<h2 id="-"><strong>参考资料</strong></h2>
<ul>
<li><a href="http://www.infoq.com/cn/articles/zzm-java-hsdis-jvm" target="_blank">JVM执行篇：使用HSDIS插件分析JVM代码执行细节</a></li>
<li><a href="http://www.infoq.com/cn/articles/memory_barriers_jvm_concurrency" target="_blank">内存屏障和并发</a></li>
<li><a href="http://www.intel.com/products/processor/manuals/" target="_blank">Intel 64和IA-32架构软件开发人员手册</a></li>
</ul>
<h2 id="-">关于作者</h2>
<p>方腾飞，阿里巴巴资深软件开发工程师，致力于高性能网络编程，目前在公司从事询盘管理和长连接服务器OpenComet的开发工作。博客地址：<a href="http://ifeve.com/" target="_blank"><a href="http://ifeve.com">http://ifeve.com</a></a></p>
<p>感谢<a href="http://www.infoq.com/cn/bycategory.action?authorName=郑柯" target="_blank">郑柯</a>对本文的审校。</p>
<p>给InfoQ中文站投稿或者参与内容翻译工作，请邮件至<a href="mailto:editors@cn.infoq.com">editors@cn.infoq.com</a>。也欢迎大家通过新浪微博（<a href="http://www.weibo.com/infoqchina" target="_blank">@InfoQ</a>）或者腾讯微博（<a href="http://t.qq.com/infoqchina" target="_blank">@InfoQ</a>）关注我们，并与我们的编辑和其他读者朋友交流。</p>
<ul>
<li><a href="">Sections</a></li>
<li><a href="http://www.infoq.com/cn/development" target="_blank"><strong>语言 &amp; 开发</strong></a></li>
<li><a href="">Topics</a></li>
<li><a href="http://www.infoq.com/cn/Multi-threading" target="_blank">多线程</a></li>
<li><a href="http://www.infoq.com/cn/concurrency" target="_blank">并发</a></li>
<li><a href="http://www.infoq.com/cn/java" target="_blank">Java</a></li>
</ul>
<p>相关内容</p>
<h3 id="-concurrentlinkedqueue-http-www-infoq-com-cn-articles-concurrentlinkedqueue-utm_source-infoq-utm_medium-related_content_link-utm_campaign-relatedcontent_articles_clk-"><a href="http://www.infoq.com/cn/articles/ConcurrentLinkedQueue?utm_source=infoq&amp;utm_medium=related_content_link&amp;utm_campaign=relatedContent_articles_clk" target="_blank">聊聊并发（六）——ConcurrentLinkedQueue的实现原理分析</a></h3>
<h3 id="-http-www-infoq-com-cn-articles-atomic-operation-utm_source-infoq-utm_medium-related_content_link-utm_campaign-relatedcontent_articles_clk-"><a href="http://www.infoq.com/cn/articles/atomic-operation?utm_source=infoq&amp;utm_medium=related_content_link&amp;utm_campaign=relatedContent_articles_clk" target="_blank">聊聊并发（五）——原子操作的实现原理</a></h3>
<h3 id="-concurrenthashmap-http-www-infoq-com-cn-articles-concurrenthashmap-utm_source-infoq-utm_medium-related_content_link-utm_campaign-relatedcontent_articles_clk-"><a href="http://www.infoq.com/cn/articles/ConcurrentHashMap?utm_source=infoq&amp;utm_medium=related_content_link&amp;utm_campaign=relatedContent_articles_clk" target="_blank">聊聊并发（四）——深入分析ConcurrentHashMap</a></h3>
<h3 id="-java-http-www-infoq-com-cn-articles-java-threadpool-utm_source-infoq-utm_medium-related_content_link-utm_campaign-relatedcontent_articles_clk-"><a href="http://www.infoq.com/cn/articles/java-threadPool?utm_source=infoq&amp;utm_medium=related_content_link&amp;utm_campaign=relatedContent_articles_clk" target="_blank">聊聊并发（三）——JAVA线程池的分析和使用</a></h3>
<h3 id="-java-http-www-infoq-com-cn-articles-java-memory-model-7-utm_source-infoq-utm_medium-related_content_link-utm_campaign-relatedcontent_articles_clk-"><a href="http://www.infoq.com/cn/articles/java-memory-model-7?utm_source=infoq&amp;utm_medium=related_content_link&amp;utm_campaign=relatedContent_articles_clk" target="_blank">深入理解Java内存模型（七）——总结</a></h3>
<h3 id="-java-http-www-infoq-com-cn-articles-java-memory-model-7-utm_source-infoq-utm_medium-related_content_link-utm_campaign-relatedcontent_articles_clk-"><a href="http://www.infoq.com/cn/articles/java-memory-model-7?utm_source=infoq&amp;utm_medium=related_content_link&amp;utm_campaign=relatedContent_articles_clk" target="_blank">深入理解Java内存模型（七）——总结</a></h3>
<h3 id="-java-final-http-www-infoq-com-cn-articles-java-memory-model-6-utm_source-infoq-utm_medium-related_content_link-utm_campaign-relatedcontent_articles_clk-"><a href="http://www.infoq.com/cn/articles/java-memory-model-6?utm_source=infoq&amp;utm_medium=related_content_link&amp;utm_campaign=relatedContent_articles_clk" target="_blank">深入理解Java内存模型（六）——final</a></h3>
<h3 id="-java-http-www-infoq-com-cn-articles-java-memory-model-5-utm_source-infoq-utm_medium-related_content_link-utm_campaign-relatedcontent_articles_clk-"><a href="http://www.infoq.com/cn/articles/java-memory-model-5?utm_source=infoq&amp;utm_medium=related_content_link&amp;utm_campaign=relatedContent_articles_clk" target="_blank">深入理解Java内存模型（五）——锁</a></h3>
<h3 id="-concurrentlinkedqueue-http-www-infoq-com-cn-articles-concurrentlinkedqueue-utm_source-infoq-utm_medium-related_content_link-utm_campaign-relatedcontent_articles_clk-"><a href="http://www.infoq.com/cn/articles/ConcurrentLinkedQueue?utm_source=infoq&amp;utm_medium=related_content_link&amp;utm_campaign=relatedContent_articles_clk" target="_blank">聊聊并发（六）——ConcurrentLinkedQueue的实现原理分析</a></h3>
<h3 id="-http-www-infoq-com-cn-articles-atomic-operation-utm_source-infoq-utm_medium-related_content_link-utm_campaign-relatedcontent_articles_clk-"><a href="http://www.infoq.com/cn/articles/atomic-operation?utm_source=infoq&amp;utm_medium=related_content_link&amp;utm_campaign=relatedContent_articles_clk" target="_blank">聊聊并发（五）——原子操作的实现原理</a></h3>
<h2 id="-">您好，陌生人！</h2>
<p>您需要 <a href="http://www.infoq.com/reginit.action" target="_blank">注册一个InfoQ账号</a> 或者 <a href="">登录</a> 才能进行评论。在您完成注册后还需要进行一些设置。</p>
<h2 id="-infoq-">获得来自InfoQ的更多体验。<a href=""></a></h2>
<p>允许的HTML标签: a,b,br,blockquote,i,li,pre,u,ul,p</p>
<p>当有人回复此评论时请E-mail通知我</p>
<p>社区评论 <a href="">Watch Thread</a></p>
<p><a href=""><strong>fantastic</strong> by chuanmin zuo Posted 22/02/2012 01:19</a>
<a href=""><strong>Re: fantastic</strong> by chuanmin zuo Posted 22/02/2012 01:21</a></p>
<p><a href=""><strong>Re: fantastic</strong> by 方 腾飞 Posted 22/02/2012 01:55</a>
<a href=""><strong>I have a question to ask you</strong> by chuanmin zuo Posted 22/02/2012 07:23</a></p>
<p><a href=""><strong>Re: I have a question to ask you</strong> by chuanmin zuo Posted 22/02/2012 07:24</a>
<a href=""><strong>疑问</strong> by Wang Frank Posted 24/02/2012 01:12</a></p>
<p><a href=""><strong>Re: 疑问</strong> by 方 腾飞 Posted 26/02/2012 10:35</a>
<a href=""><strong>Re: 两个不同的线程看到某个成员变量的值是不相同的，怎么写个例子</strong> by zhang qinghua Posted 08/05/2013 11:43</a></p>
<p><a href=""><strong>Re: 疑问</strong> by 史 墨轩 Posted 19/12/2012 10:06</a>
<a href=""><strong>Re: 疑问</strong> by 方 腾飞 Posted 27/12/2012 01:07</a></p>
<p><a href=""><strong>Re: 疑问</strong> by 方 腾飞 Posted 31/12/2012 10:33</a>
<a href=""><strong>so wonderful</strong> by hu depin Posted 24/02/2012 02:56</a></p>
<p><a href=""><strong>Re: so wonderful</strong> by 方 腾飞 Posted 26/02/2012 10:41</a>
<a href=""><strong>汇编代码的角度去考虑</strong> by Liu Xia Posted 28/02/2012 00:09</a></p>
<p><a href=""><strong>如何在实际的项目中应用</strong> by www www Posted 28/02/2012 09:18</a>
<a href=""><strong>Re: 如何在实际的项目中应用</strong> by 方 腾飞 Posted 28/02/2012 07:08</a></p>
<p><a href=""><strong>为什么volatile 变量不能保证写操作的原子性</strong> by Haixia Chen Posted 11/08/2012 10:09</a>
<a href=""><strong>Re: 为什么volatile 变量不能保证写操作的原子性</strong> by Haixia Chen Posted 11/08/2012 11:01</a></p>
<p><a href=""><strong>Re: 为什么volatile 变量不能保证写操作的原子性</strong> by 方 腾飞 Posted 02/09/2012 07:36</a>
<a href=""><strong>好啊</strong> by s zh Posted 31/12/2012 05:08</a></p>
<p><a href=""><strong>疑问</strong> by zhao chiva Posted 17/02/2013 03:34</a>
<a href=""><strong>改字</strong> by 吴 杰峰 Posted 07/03/2013 08:07</a></p>
<p><a href=""><strong>一个有效的缓存行被写入到不存在的内存区域</strong> by 高 海军 Posted 02/04/2013 10:19</a>
<a href=""><strong>java中对象或者数组用volatile修饰有什么用?</strong> by sc lv Posted 03/04/2013 03:00</a></p>
<p><a href=""><strong>请教一个悖论问题</strong> by sun shanghai Posted 26/04/2013 10:43</a>
<a href=""><strong>Re: 请教一个悖论问题</strong> by zhang qinghua Posted 08/05/2013 11:44</a></p>
<p><a href=""><strong>文章导出</strong> by tony zarric Posted 12/05/2013 11:05</a>
<a href=""></a></p>
<p><strong>fantastic</strong> 22/02/2012 01:19 by chuanmin zuo</p>
<p>Thanks for your sharing,I think it&#39;s pretty wonderful technical article.
It&#39;s very useful for java developers to understand volatile.
But I also want to know the performance difference between volatile and synchronized,don&#39;t misunderstand,I mean precise,or to prove performance difference with some data.If you can add this,that&#39;s perfect,coz we pay close attention to that.Maybe that is the key point of your article.
thanks again.</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a></li>
</ul>
<p><a href=""></a></p>
<p><strong>Re: fantastic</strong> 22/02/2012 01:21 by chuanmin zuo</p>
<p>Sorry,Maybe that is the key point of your article.--&gt;Maybe that is not the key point of your article</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a>
<a href=""></a></li>
</ul>
<p><strong>Re: fantastic</strong> 22/02/2012 01:55 by 方 腾飞</p>
<p>Thank you for your attention! i will add it to another article.</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a></li>
</ul>
<p><a href=""></a></p>
<p><strong>I have a question to ask you</strong> 22/02/2012 07:23 by chuanmin zuo</p>
<p>After reading your article,I made a test like this:
I downloaded java language specification,and test a example from 8.3.1.4 volatile field in this document.
But I found even if a field(i and j in that example) is declared volatile,the value of j is still greater than that for i.Actually I know why,coz volatile just ensure other thread can see the latest value ,not ensure synchronization.But that document(I mean java langguage specification) tells me:&quot;Therefore,the shared value for j is never greater than that of j&quot;,I can not understand,Have you tested that example.
I look forward to your reply.</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a>
<a href=""></a></li>
</ul>
<p><strong>Re: I have a question to ask you</strong> 22/02/2012 07:24 by chuanmin zuo</p>
<p>&quot;Therefore,the shared value for j is never greater than that of i&quot;,sorry,my mistake.</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a></li>
</ul>
<p><a href=""></a></p>
<p><strong>疑问</strong> 24/02/2012 01:12 by Wang Frank</p>
<p>当处理器将操作数写回到一个内存缓存的区域时，它首先会检查这个缓存的内存地址是否在缓存行中，如果不存在一个有效的缓存行，则处理器将这个操作数写回到缓存，而不是写回到内存，这个操作被称为写命中。
“如果不存在一个有效的缓存行” 这里是否应该是“如果存在一个有效的缓存行”？</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a>
<a href=""></a></li>
</ul>
<p><strong>so wonderful</strong> 24/02/2012 02:56 by hu depin</p>
<p>受益匪浅，感谢分享</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a></li>
</ul>
<p><a href=""></a></p>
<p><strong>Re: 疑问</strong> 26/02/2012 10:35 by 方 腾飞</p>
<p>是的，感谢纠正。</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a>
<a href=""></a></li>
</ul>
<p><strong>Re: so wonderful</strong> 26/02/2012 10:41 by 方 腾飞</p>
<p>谢谢关注。</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a></li>
</ul>
<p><a href=""></a></p>
<p><strong>汇编代码的角度去考虑</strong> 28/02/2012 00:09 by Liu Xia</p>
<p>Java 语言实际上是有自己的内存模型的。这种内存模型实际上就是希望隐藏各种不同的处理器对于缓存一致性的处理。volatile 在 Java 的内存模型还真是没有太关注，在 CLR 的内存模型上是 volatile 的读具有 load acuqire 语义（这和一般的读不同），从而防止了一定程度上的代码调整，而保证在 load 完成后的一致性。
但是从汇编上那就复杂了，例如 IA-32 或者 Intel 64 架构的处理器上使用了 lock 或者，但是在 IA-64 的处理器上就需要一个 load acquire 的 inter-lock 操作（IA-64 上的这种操作指令还挺丰富）。</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a>
<a href=""></a></li>
</ul>
<p><strong>如何在实际的项目中应用</strong> 28/02/2012 09:18 by www www</p>
<p>在单位的电脑上跑了一下 确实快很多。也确实证明了他的可用性。但问题是我们如何在实际的项目中应用这个东西。 或者说如何在现行的项目中确定false sharing产生的瓶颈，然后用这种方法来提高性能？</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a></li>
</ul>
<p><a href=""></a></p>
<p><strong>Re: 如何在实际的项目中应用</strong> 28/02/2012 07:08 by 方 腾飞</p>
<p>文中有提到，应用场景是首先要确认该共享变量是否会被频繁的写？比如队列的入队和出队，需要不停的修改头节点和尾节点，所以这里建议使用Padding的方式进行优化，当然即使是频繁的写也不一定会成为性能的瓶颈。</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a>
<a href=""></a></li>
</ul>
<p><strong>为什么volatile 变量不能保证写操作的原子性</strong> 11/08/2012 10:09 by Haixia Chen</p>
<p>大师，文章中提到volatile变量的写操作，处理器写完会更新到内存，其他处理器缓存会失效，既然这样，为什么多线程i++，100次的时候，最后i的值可能&lt;100呢，i++的分析见：<a href="http://wk.baidu.com/view/bc890df5f61fb7360b4c654b&amp;?pcf=2" target="_blank">wk.baidu.com/view/bc890df5f61fb7360b4c654b&amp;...</a>
Pad输入不容易，盼大师解惑</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a></li>
</ul>
<p><a href=""></a></p>
<p><strong>Re: 为什么volatile 变量不能保证写操作的原子性</strong> 11/08/2012 11:01 by Haixia Chen</p>
<p>明白了，那篇文章已经讲的很清楚了</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a>
<a href=""></a></li>
</ul>
<p><strong>Re: 为什么volatile 变量不能保证写操作的原子性</strong> 02/09/2012 07:36 by 方 腾飞</p>
<p>：）</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a></li>
</ul>
<p><a href=""></a></p>
<p><strong>Re: 疑问</strong> 19/12/2012 10:06 by 史 墨轩</p>
<p>我刚看到的时候也有这个疑问，看了回复果然是翻译问题，希望作者做一下修改吧</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a>
<a href=""></a></li>
</ul>
<p><strong>Re: 疑问</strong> 27/12/2012 01:07 by 方 腾飞</p>
<p>好的</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a></li>
</ul>
<p><a href=""></a></p>
<p><strong>Re: 疑问</strong> 31/12/2012 10:33 by 方 腾飞</p>
<p>已经修改！</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a>
<a href=""></a></li>
</ul>
<p><strong>好啊</strong> 31/12/2012 05:08 by s zh</p>
<p>感谢你的分享</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a></li>
</ul>
<p><a href=""></a></p>
<p><strong>疑问</strong> 17/02/2013 03:34 by zhao chiva</p>
<p>JKD7里面LinkedTransferQueue的实现跟你说的不一样，head跟tail的内部实现类是Node.也不是采用移位实现的。
//<em>/</em> head of the queue; null until first enqueue /<em>/
transient volatile Node head;
//</em>/<em> tail of the queue; null until first append /</em>/
private transient volatile Node tail;</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a>
<a href=""></a></li>
</ul>
<p><strong>改字</strong> 07/03/2013 08:07 by 吴 杰峰</p>
<p>例如在Pentium和P6 family处理器中，如果通过嗅探一个处理器来检测其他处理器打算写内存地址，而这个地址当前处理共享状态 &quot;而这个地址当前处理共享状态&quot;：应该是“而这个地址当前处于共享状态”</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a></li>
</ul>
<p><a href=""></a></p>
<p><strong>一个有效的缓存行被写入到不存在的内存区域</strong> 02/04/2013 10:19 by 高 海军</p>
<p>write misses the cache 表示&quot;一个有效的缓存行被写入到不存在的内存区域。&quot; 这段话是是不是有点问题? 应该是写缓存未命中巴? 可以再解释一下吗?</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a>
<a href=""></a></li>
</ul>
<p><strong>java中对象或者数组用volatile修饰有什么用?</strong> 03/04/2013 03:00 by sc lv</p>
<p>上文说到共享变量包括所有的实例变量，静态变量和数组元素，有看到其它资料说对于数组，volatile修饰的只是数组的引用，例如，java.io.BufferedInputStream类中protected volatile byte buf[]; 数组buf用volatile修饰；
java.io.FilterInputStream类中protected volatile InputStream in; in用volatile修饰。
jdk中这样修饰有什么好处呢？这两个地方如果不用volatile修饰会有什么影响？</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a></li>
</ul>
<p><a href=""></a></p>
<p><strong>请教一个悖论问题</strong> 26/04/2013 10:43 by sun shanghai</p>
<p>import java.lang./<em>;
//</em>/<em>
/</em> 我觉得如果不加volatile修饰符，则第1个线程是永远不会停止的，
/<em> 但是实际上线程2把flag设置为true后，线程1就停止了
/</em> 这个是什么原因呢？不明白。
/*/
public class Counter {
//
private static Boolean flag = new Boolean(false);
// private volatile static Boolean flag = new Boolean(false);
public static void main(String[] args) {
// 线程1
new Thread() {
int i = 0;
public void run() {
while (!flag.booleanValue()) {
System.out.println(i++);
}
}
}.start();
// 线程2
new Thread() {
public void run() {
try {
Thread.sleep(1000);
flag = new Boolean(true);
} catch (InterruptedException e) {
e.printStackTrace();
}
}
}.start();
}
}</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a>
<a href=""></a></li>
</ul>
<p><strong>Re: 两个不同的线程看到某个成员变量的值是不相同的，怎么写个例子</strong> 08/05/2013 11:43 by zhang qinghua</p>
<p>private int i = 0;
//a线程调用
public void foo1(){
try {
while (true) {
Thread.sleep(10);
i++;
}
} catch (InterruptedException e) {
//not to do;
}
}
//b线程调用
public void foo2(){
try {
while(true){
Thread.sleep(1000);
System.out.println(&quot;第二个：&quot;+i);
}
} catch (InterruptedException e) {
//not to do;
}
}
为什么foo2打印的i的值会随着foo1修改的值变化。。。。。。
请见凉，自从看了这篇文章，感觉以前写的代码都有线程缓存共享变量的问题，但实际没有出现过 两个不同的线程看到某个成员变量的值是不相同的。
请lz,给个例子，
两个不同的线程（通过线程缓存共享变量）看到某个成员变量的值是不相同的，怎么写个例子？
请楼主回答一下。</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a></li>
</ul>
<p><a href=""></a></p>
<p><strong>Re: 请教一个悖论问题</strong> 08/05/2013 11:44 by zhang qinghua</p>
<p>你的困惑解决没，我的困惑和你一样。望回答一下，在你的楼下。</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a>
<a href=""></a></li>
</ul>
<p><strong>文章导出</strong> 12/05/2013 11:05 by tony zarric</p>
<p>页面内容能提供导出功能，如：
聊聊并发（一）——深入分析Volatile的实现原理 能导出 保存为pdf或word文件</p>
<ul>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a></li>
</ul>
<p><a href="">关闭</a></p>
<h3 id="-by"><em>**</em>by</h3>
<p>发布于</p>
<ul>
<li><a href="">查看</a></li>
<li><a href="">回复</a></li>
<li><a href="">回到顶部</a>
<a href="">关闭</a> 主题  您的回复 <a href="">引用原消息</a></li>
</ul>
<p>允许的HTML标签: a,b,br,blockquote,i,li,pre,u,ul,p
当有人回复此评论时请E-mail通知我</p>
<p><a href="">关闭</a> 主题  您的回复</p>
<p>允许的HTML标签: a,b,br,blockquote,i,li,pre,u,ul,p
当有人回复此评论时请E-mail通知我
<a href="">关闭</a></p>
<ul>
<li>热点内容</li>
<li><a href="">本周</a></li>
<li><a href="">本月</a></li>
<li><a href="">近6个月</a><h3 id="-32-http-www-infoq-com-cn-news-2012-08-32-most-important-algorithms-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2012/08/32-most-important-algorithms?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">计算机科学中最重要的32个算法</a></h3>
</li>
</ul>
<h3 id="-thoughtworks-2013-5-http-www-infoq-com-cn-articles-thoughtworks-technology-radar-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/articles/thoughtWorks-technology-radar?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">ThoughtWorks技术雷达（2013年5月）</a></h3>
<h3 id="-1-5-http-www-infoq-com-cn-articles-iqiyi-cloud-push-practices-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/articles/iqiyi-cloud-push-practices?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">让1.5亿移动端用户第一时间获取消息</a></h3>
<h3 id="-thoughtworks-ceo-http-www-infoq-com-cn-news-2013-06-tw-guoxiao-on-talents-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2013/06/tw-guoxiao-on-talents?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">ThoughtWorks全球CEO郭晓谈软件人才的招聘与培养</a></h3>
<h3 id="-http-www-infoq-com-cn-news-2013-06-10-sins-for-scalability-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2013/06/10-sins-for-scalability?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">影响可扩展性的十宗罪</a></h3>
<h3 id="-6-http-www-infoq-com-cn-minibooks-architect-jun-10-2013-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/minibooks/architect-jun-10-2013?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">架构师（6月刊）</a></h3>
<h3 id="-http-www-infoq-com-cn-articles-function-switch-realize-better-continuous-implementations-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/articles/function-switch-realize-better-continuous-implementations?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">使用功能开关更好地实现持续部署</a></h3>
<h3 id="-eclipse-github-http-www-infoq-com-cn-news-2013-06-eclipse-github-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2013/06/eclipse-github?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">Eclipse迁移到GitHub</a></h3>
<h3 id="-newegg-com-http-www-infoq-com-cn-presentations-newegg-big-data-practice-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/presentations/newegg-big-data-practice?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">Newegg.com大数据实践</a></h3>
<h3 id="-http-www-infoq-com-cn-minibooks-software-sys-architect-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/minibooks/software-sys-architect?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">软件系统架构：使用视点和视角与利益相关者合作</a></h3>
<h3 id="-32-http-www-infoq-com-cn-news-2012-08-32-most-important-algorithms-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2012/08/32-most-important-algorithms?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">计算机科学中最重要的32个算法</a></h3>
<h3 id="-6-http-www-infoq-com-cn-minibooks-architect-jun-10-2013-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/minibooks/architect-jun-10-2013?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">架构师（6月刊）</a></h3>
<h3 id="-rest-http-www-infoq-com-cn-news-2013-06-rest-drawbacks-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2013/06/rest-drawbacks?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">REST的缺点是什么？</a></h3>
<h3 id="-google-web-ui-polymer-http-www-infoq-com-cn-news-2013-06-webcomponents-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2013/06/webcomponents?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">Google 发布新一代Web UI库Polymer</a></h3>
<h3 id="-http-www-infoq-com-cn-news-2013-06-dianping-xinnet-hacked-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2013/06/dianping-xinnet-hacked?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">大众点评网域名劫持事件概述</a></h3>
<h3 id="-node-js-grunt-js-http-www-infoq-com-cn-articles-gruntjs-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/articles/GruntJs?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">基于Node.js的自动化构建工具Grunt.js</a></h3>
<h3 id="-node-js-node-js-http-www-infoq-com-cn-articles-what-is-nodejs-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/articles/what-is-nodejs?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">深入浅出Node.js（一）：什么是Node.js</a></h3>
<h3 id="-http-www-infoq-com-cn-minibooks-i-m-wrights-hard-code-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/minibooks/i-m-wrights-hard-code?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">代码之殇·第二版</a></h3>
<h3 id="-http-www-infoq-com-cn-minibooks-software-sys-architect-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/minibooks/software-sys-architect?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">软件系统架构：使用视点和视角与利益相关者合作</a></h3>
<h3 id="-18-java-http-www-infoq-com-cn-news-2013-06-zhuhong-on-java-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2013/06/zhuhong-on-java?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">大家谈18岁的Java——朱鸿：开过跑车后再去开大巴车总是有点不爽的</a></h3>
<h3 id="-32-http-www-infoq-com-cn-news-2012-08-32-most-important-algorithms-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2012/08/32-most-important-algorithms?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">计算机科学中最重要的32个算法</a></h3>
<h3 id="-java-http-www-infoq-com-cn-articles-java-memory-model-1-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/articles/java-memory-model-1?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">深入理解Java内存模型（一）——基础</a></h3>
<h3 id="-node-js-node-js-http-www-infoq-com-cn-articles-what-is-nodejs-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/articles/what-is-nodejs?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">深入浅出Node.js（一）：什么是Node.js</a></h3>
<h3 id="-node-js-node-js-npm-http-www-infoq-com-cn-articles-nodejs-npm-install-config-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/articles/nodejs-npm-install-config?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">深入浅出Node.js（二）：Node.js&amp;NPM的安装与配置</a></h3>
<h3 id="-3-http-www-infoq-com-cn-minibooks-architect-mar-10-2013-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/minibooks/architect-mar-10-2013?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">架构师（3月刊）</a></h3>
<h3 id="-1-http-www-infoq-com-cn-minibooks-architect-jan-10-2013-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/minibooks/architect-jan-10-2013?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">架构师（1月刊）</a></h3>
<h3 id="-4-http-www-infoq-com-cn-minibooks-architect-apr-10-2013-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/minibooks/architect-apr-10-2013?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">架构师（4月刊）</a></h3>
<h3 id="-java-http-www-infoq-com-cn-articles-java-threadpool-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/articles/java-threadPool?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">聊聊并发（三）——JAVA线程池的分析和使用</a></h3>
<h3 id="-2-http-www-infoq-com-cn-minibooks-architect-feb-10-2013-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/minibooks/architect-feb-10-2013?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">架构师（2月刊）</a></h3>
<h3 id="-12306-github-http-www-infoq-com-cn-news-2013-01-12306-plugin-ddos-github-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2013/01/12306-plugin-ddos-github?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">12306订票助手插件拖垮GitHub事件原因始末</a></h3>
<h3 id="-32-http-www-infoq-com-cn-news-2012-08-32-most-important-algorithms-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2012/08/32-most-important-algorithms?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">计算机科学中最重要的32个算法</a></h3>
<h3 id="-thoughtworks-2013-5-http-www-infoq-com-cn-articles-thoughtworks-technology-radar-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/articles/thoughtWorks-technology-radar?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">ThoughtWorks技术雷达（2013年5月）</a></h3>
<h3 id="-1-5-http-www-infoq-com-cn-articles-iqiyi-cloud-push-practices-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/articles/iqiyi-cloud-push-practices?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">让1.5亿移动端用户第一时间获取消息</a></h3>
<h3 id="-thoughtworks-ceo-http-www-infoq-com-cn-news-2013-06-tw-guoxiao-on-talents-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2013/06/tw-guoxiao-on-talents?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">ThoughtWorks全球CEO郭晓谈软件人才的招聘与培养</a></h3>
<h3 id="-http-www-infoq-com-cn-news-2013-06-10-sins-for-scalability-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2013/06/10-sins-for-scalability?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">影响可扩展性的十宗罪</a></h3>
<h3 id="-6-http-www-infoq-com-cn-minibooks-architect-jun-10-2013-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/minibooks/architect-jun-10-2013?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">架构师（6月刊）</a></h3>
<h3 id="-http-www-infoq-com-cn-articles-function-switch-realize-better-continuous-implementations-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/articles/function-switch-realize-better-continuous-implementations?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">使用功能开关更好地实现持续部署</a></h3>
<h3 id="-eclipse-github-http-www-infoq-com-cn-news-2013-06-eclipse-github-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2013/06/eclipse-github?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">Eclipse迁移到GitHub</a></h3>
<h3 id="-newegg-com-http-www-infoq-com-cn-presentations-newegg-big-data-practice-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/presentations/newegg-big-data-practice?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">Newegg.com大数据实践</a></h3>
<h3 id="-http-www-infoq-com-cn-minibooks-software-sys-architect-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/minibooks/software-sys-architect?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">软件系统架构：使用视点和视角与利益相关者合作</a></h3>
<h3 id="-32-http-www-infoq-com-cn-news-2012-08-32-most-important-algorithms-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2012/08/32-most-important-algorithms?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">计算机科学中最重要的32个算法</a></h3>
<h3 id="-6-http-www-infoq-com-cn-minibooks-architect-jun-10-2013-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/minibooks/architect-jun-10-2013?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">架构师（6月刊）</a></h3>
<h3 id="-rest-http-www-infoq-com-cn-news-2013-06-rest-drawbacks-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2013/06/rest-drawbacks?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">REST的缺点是什么？</a></h3>
<h3 id="-google-web-ui-polymer-http-www-infoq-com-cn-news-2013-06-webcomponents-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2013/06/webcomponents?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">Google 发布新一代Web UI库Polymer</a></h3>
<h3 id="-http-www-infoq-com-cn-news-2013-06-dianping-xinnet-hacked-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2013/06/dianping-xinnet-hacked?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">大众点评网域名劫持事件概述</a></h3>
<h3 id="-node-js-grunt-js-http-www-infoq-com-cn-articles-gruntjs-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/articles/GruntJs?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">基于Node.js的自动化构建工具Grunt.js</a></h3>
<h3 id="-node-js-node-js-http-www-infoq-com-cn-articles-what-is-nodejs-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/articles/what-is-nodejs?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">深入浅出Node.js（一）：什么是Node.js</a></h3>
<h3 id="-http-www-infoq-com-cn-minibooks-i-m-wrights-hard-code-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/minibooks/i-m-wrights-hard-code?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">代码之殇·第二版</a></h3>
<h3 id="-http-www-infoq-com-cn-minibooks-software-sys-architect-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/minibooks/software-sys-architect?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">软件系统架构：使用视点和视角与利益相关者合作</a></h3>
<h3 id="-18-java-http-www-infoq-com-cn-news-2013-06-zhuhong-on-java-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2013/06/zhuhong-on-java?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">大家谈18岁的Java——朱鸿：开过跑车后再去开大巴车总是有点不爽的</a></h3>
<h3 id="-32-http-www-infoq-com-cn-news-2012-08-32-most-important-algorithms-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2012/08/32-most-important-algorithms?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">计算机科学中最重要的32个算法</a></h3>
<h3 id="-java-http-www-infoq-com-cn-articles-java-memory-model-1-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/articles/java-memory-model-1?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">深入理解Java内存模型（一）——基础</a></h3>
<h3 id="-node-js-node-js-http-www-infoq-com-cn-articles-what-is-nodejs-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/articles/what-is-nodejs?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">深入浅出Node.js（一）：什么是Node.js</a></h3>
<h3 id="-node-js-node-js-npm-http-www-infoq-com-cn-articles-nodejs-npm-install-config-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/articles/nodejs-npm-install-config?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">深入浅出Node.js（二）：Node.js&amp;NPM的安装与配置</a></h3>
<h3 id="-3-http-www-infoq-com-cn-minibooks-architect-mar-10-2013-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/minibooks/architect-mar-10-2013?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">架构师（3月刊）</a></h3>
<h3 id="-1-http-www-infoq-com-cn-minibooks-architect-jan-10-2013-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/minibooks/architect-jan-10-2013?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">架构师（1月刊）</a></h3>
<h3 id="-4-http-www-infoq-com-cn-minibooks-architect-apr-10-2013-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/minibooks/architect-apr-10-2013?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">架构师（4月刊）</a></h3>
<h3 id="-java-http-www-infoq-com-cn-articles-java-threadpool-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/articles/java-threadPool?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">聊聊并发（三）——JAVA线程池的分析和使用</a></h3>
<h3 id="-2-http-www-infoq-com-cn-minibooks-architect-feb-10-2013-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/minibooks/architect-feb-10-2013?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">架构师（2月刊）</a></h3>
<h3 id="-12306-github-http-www-infoq-com-cn-news-2013-01-12306-plugin-ddos-github-utm_source-infoq-utm_medium-popular_links_homepage-"><a href="http://www.infoq.com/cn/news/2013/01/12306-plugin-ddos-github?utm_source=infoq&amp;utm_medium=popular_links_homepage" target="_blank">12306订票助手插件拖垮GitHub事件原因始末</a></h3>
<h2 id="-">深度内容</h2>
<ul>
<li><a href="">全部</a></li>
<li><a href="">文章</a></li>
<li><a href="">演讲</a></li>
<li><a href="">访谈</a></li>
<li><a href="">迷你书</a></li>
</ul>
<h2 id="-juergen-fesslmeier-javascript-http-www-infoq-com-cn-interviews-end-to-end-javascript-juergen-fesslmeier-javascript-"><a href="http://www.infoq.com/cn/interviews/end-to-end-javascript" title="Juergen Fesslmeier谈端到端的JavaScript开发" target="_blank">Juergen Fesslmeier谈端到端的JavaScript开发</a></h2>
<p><a href="http://www.infoq.com/cn/author/Juergen-Fesslmeier" title="Juergen Fesslmeier" target="_blank">Juergen Fesslmeier</a> 七月 02, 2013</p>
<p><a href="http://www.infoq.com/cn/interviews/end-to-end-javascript" title="Juergen Fesslmeier谈端到端的JavaScript开发" target="_blank"><img src="" alt=""></a></p>
<h2 id="-http-www-infoq-com-cn-articles-design-pattern-automation-"><a href="http://www.infoq.com/cn/articles/Design-Pattern-Automation" title="设计模式自动化" target="_blank">设计模式自动化</a></h2>
<p><a href="http://www.infoq.com/cn/author/Gael-Fraiteur-and-Yan-Cui" title="Gael Fraiteur and Yan Cui" target="_blank">Gael Fraiteur and Yan Cui</a> 七月 01, 2013</p>
<p><a href="http://www.infoq.com/cn/articles/Design-Pattern-Automation" title="设计模式自动化" target="_blank"><img src="" alt=""></a></p>
<h2 id="-http-www-infoq-com-cn-articles-designing-a-world-at-your-fingertips-mobile-user-interfaces-"><a href="http://www.infoq.com/cn/articles/designing-a-world-at-your-fingertips-mobile-user-interfaces" title="设计指尖上的世界：移动用户界面一瞥" target="_blank">设计指尖上的世界：移动用户界面一瞥</a></h2>
<p><a href="http://www.infoq.com/cn/author/Forrest-Shull" title="Forrest Shull" target="_blank">Forrest Shull</a> 六月 28, 2013</p>
<p><a href="http://www.infoq.com/cn/articles/designing-a-world-at-your-fingertips-mobile-user-interfaces" title="设计指尖上的世界：移动用户界面一瞥" target="_blank"><img src="" alt=""></a></p>
<h2 id="-alm-http-www-infoq-com-cn-articles-integrated-alm-alm-"><a href="http://www.infoq.com/cn/articles/Integrated-ALM" title="成功的根本—集成的ALM工具" target="_blank">成功的根本—集成的ALM工具</a></h2>
<p><a href="http://www.infoq.com/cn/author/Dave-West" title="Dave West" target="_blank">Dave West</a> 六月 28, 2013</p>
<p><a href="http://www.infoq.com/cn/articles/Integrated-ALM" title="成功的根本—集成的ALM工具" target="_blank"><img src="" alt=""></a></p>
<h2 id="-http-www-infoq-com-cn-articles-atdd-by-example-book-"><a href="http://www.infoq.com/cn/articles/atdd-by-example-book" title="书评：验收测试驱动开发实践指南" target="_blank">书评：验收测试驱动开发实践指南</a></h2>
<p><a href="http://www.infoq.com/cn/author/Manuel-Pais" title="Manuel Pais" target="_blank">Manuel Pais</a> 六月 26, 2013</p>
<p><a href="http://www.infoq.com/cn/articles/atdd-by-example-book" title="书评：验收测试驱动开发实践指南" target="_blank"><img src="" alt=""></a></p>
<h2 id="-web-http-www-infoq-com-cn-presentations-across-device-web-web-"><a href="http://www.infoq.com/cn/presentations/across-device-web" title="跨终端的web" target="_blank">跨终端的web</a></h2>
<p><a href="http://www.infoq.com/cn/author/%E8%88%92%E6%96%87%E4%BA%AE" title="舒文亮" target="_blank">舒文亮</a> 六月 26, 2013</p>
<p><a href="http://www.infoq.com/cn/presentations/across-device-web" title="跨终端的web" target="_blank"><img src="" alt=""></a></p>
<ul>
<li><a href="">更早的 &gt;</a></li>
</ul>
<p>语言 &amp; 开发</p>
<p><a href="http://www.infoq.com/cn/interviews/end-to-end-javascript" title="Juergen Fesslmeier谈端到端的JavaScript开发" target="_blank">Juergen Fesslmeier谈端到端的JavaScript开发</a></p>
<p><a href="http://www.infoq.com/cn/news/2013/07/mobilecloud-tfs" title="MobileCloud for TFS支持测试Windows Phone,Android,iOS及BlackBerry应用" target="_blank">MobileCloud for TFS支持测试Windows Phone,Android,iOS及BlackBerry应用</a></p>
<p><a href="http://www.infoq.com/cn/news/2013/07/baidu-salon39-summary" title="百度技术沙龙第39期回顾：前端快速开发实践（含资料下载）" target="_blank">百度技术沙龙第39期回顾：前端快速开发实践（含资料下载）</a></p>
<p>架构 &amp; 设计</p>
<p><a href="http://www.infoq.com/cn/news/2013/07/Native-Performance" title="内存与本机代码的性能" target="_blank">内存与本机代码的性能</a></p>
<p><a href="http://www.infoq.com/cn/articles/Design-Pattern-Automation" title="设计模式自动化" target="_blank">设计模式自动化</a></p>
<p><a href="http://www.infoq.com/cn/news/2013/07/WinRT-Devices" title="连接设备编程" target="_blank">连接设备编程</a>
过程 &amp; 实践</p>
<p><a href="http://www.infoq.com/cn/articles/Integrated-ALM" title="成功的根本—集成的ALM工具" target="_blank">成功的根本—集成的ALM工具</a></p>
<p><a href="http://www.infoq.com/cn/news/2013/06/tw-guoxiao-on-talents" title="ThoughtWorks全球CEO郭晓谈软件人才的招聘与培养" target="_blank">ThoughtWorks全球CEO郭晓谈软件人才的招聘与培养</a></p>
<p><a href="http://www.infoq.com/cn/articles/atdd-by-example-book" title="书评：验收测试驱动开发实践指南" target="_blank">书评：验收测试驱动开发实践指南</a></p>
<p>运维 &amp; 基础架构</p>
<p><a href="http://www.infoq.com/cn/news/2013/06/devops-in-traditional-enterprise" title="在传统企业中引入DevOps" target="_blank">在传统企业中引入DevOps</a></p>
<p><a href="http://www.infoq.com/cn/news/2013/06/dod-ams-day1-s-is-for-security" title="安全性——“DevOpS”中的S" target="_blank">安全性——“DevOpS”中的S</a></p>
<p><a href="http://www.infoq.com/cn/articles/atdd-by-example-book" title="书评：验收测试驱动开发实践指南" target="_blank">书评：验收测试驱动开发实践指南</a>
企业架构</p>
<p><a href="http://www.infoq.com/cn/articles/designing-a-world-at-your-fingertips-mobile-user-interfaces" title="设计指尖上的世界：移动用户界面一瞥" target="_blank">设计指尖上的世界：移动用户界面一瞥</a></p>
<p><a href="http://www.infoq.com/cn/news/2013/06/stratos-2" title="Stratos 2.0已发布，支持所有运行时环境和30个IaaS" target="_blank">Stratos 2.0已发布，支持所有运行时环境和30个IaaS</a></p>
<p><a href="http://www.infoq.com/cn/articles/iqiyi-cloud-push-practices" title="让1.5亿移动端用户第一时间获取消息" target="_blank">让1.5亿移动端用户第一时间获取消息</a></p>
<p>语言 &amp; 开发</p>
<p><a href="http://www.infoq.com/cn/interviews/end-to-end-javascript" title="Juergen Fesslmeier谈端到端的JavaScript开发" target="_blank">Juergen Fesslmeier谈端到端的JavaScript开发</a></p>
<p><a href="http://www.infoq.com/cn/news/2013/07/mobilecloud-tfs" title="MobileCloud for TFS支持测试Windows Phone,Android,iOS及BlackBerry应用" target="_blank">MobileCloud for TFS支持测试Windows Phone,Android,iOS及BlackBerry应用</a></p>
<p><a href="http://www.infoq.com/cn/news/2013/07/baidu-salon39-summary" title="百度技术沙龙第39期回顾：前端快速开发实践（含资料下载）" target="_blank">百度技术沙龙第39期回顾：前端快速开发实践（含资料下载）</a>
架构 &amp; 设计</p>
<p><a href="http://www.infoq.com/cn/news/2013/07/Native-Performance" title="内存与本机代码的性能" target="_blank">内存与本机代码的性能</a></p>
<p><a href="http://www.infoq.com/cn/articles/Design-Pattern-Automation" title="设计模式自动化" target="_blank">设计模式自动化</a></p>
<p><a href="http://www.infoq.com/cn/news/2013/07/WinRT-Devices" title="连接设备编程" target="_blank">连接设备编程</a></p>
<p>过程 &amp; 实践</p>
<p><a href="http://www.infoq.com/cn/articles/Integrated-ALM" title="成功的根本—集成的ALM工具" target="_blank">成功的根本—集成的ALM工具</a></p>
<p><a href="http://www.infoq.com/cn/news/2013/06/tw-guoxiao-on-talents" title="ThoughtWorks全球CEO郭晓谈软件人才的招聘与培养" target="_blank">ThoughtWorks全球CEO郭晓谈软件人才的招聘与培养</a></p>
<p><a href="http://www.infoq.com/cn/articles/atdd-by-example-book" title="书评：验收测试驱动开发实践指南" target="_blank">书评：验收测试驱动开发实践指南</a>
运维 &amp; 基础架构</p>
<p><a href="http://www.infoq.com/cn/news/2013/06/devops-in-traditional-enterprise" title="在传统企业中引入DevOps" target="_blank">在传统企业中引入DevOps</a></p>
<p><a href="http://www.infoq.com/cn/news/2013/06/dod-ams-day1-s-is-for-security" title="安全性——“DevOpS”中的S" target="_blank">安全性——“DevOpS”中的S</a></p>
<p><a href="http://www.infoq.com/cn/articles/atdd-by-example-book" title="书评：验收测试驱动开发实践指南" target="_blank">书评：验收测试驱动开发实践指南</a></p>
<p>企业架构</p>
<p><a href="http://www.infoq.com/cn/articles/designing-a-world-at-your-fingertips-mobile-user-interfaces" title="设计指尖上的世界：移动用户界面一瞥" target="_blank">设计指尖上的世界：移动用户界面一瞥</a></p>
<p><a href="http://www.infoq.com/cn/news/2013/06/stratos-2" title="Stratos 2.0已发布，支持所有运行时环境和30个IaaS" target="_blank">Stratos 2.0已发布，支持所有运行时环境和30个IaaS</a></p>
<p><a href="http://www.infoq.com/cn/articles/iqiyi-cloud-push-practices" title="让1.5亿移动端用户第一时间获取消息" target="_blank">让1.5亿移动端用户第一时间获取消息</a>
<a href="">Close</a> E-mail  密码</p>
<p><a href="http://www.infoq.com/cn/social/googleLogin.action?fl=login" title="使用Google账号登录" target="_blank">使用Google账号登录</a> <a href="http://www.infoq.com/cn/social/liveLogin.action?fl=login" title="使用Microsoft账号登录" target="_blank">使用Microsoft账号登录</a>
<a href="">忘记密码？</a>
 InfoQ账号使用的E-mail 发送邮件</p>
<p><a href="">重新登录</a>
重新发送激活信息 重新发送</p>
<p><a href="">重新登录</a>
<a href="http://www.infoq.com/cn/reginit.action" target="_blank">没有用户名？</a></p>
<p><a href="http://www.infoq.com/cn/reginit.action" target="_blank">点击注册</a>
<img src="&quot;定义(粉红" alt="">&quot;)<img src="&quot;假设(蓝色" alt="">&quot;)<img src="&quot;分析(黄色" alt="">&quot;)<img src="&quot;结论(橘红" alt="">&quot;)<img src="&quot;优势(绿色" alt="">&quot;)<img src="&quot;缺陷(紫色" alt="">&quot;)<img src="&quot;注意(红色" alt="">&quot;)<img src="&quot;清除背景色&quot;" alt=""><img src="&quot;书签&quot;" alt=""><img src="&quot;设为目录项&quot;" alt=""><img src="&quot;在Google中搜索&quot;" alt=""><img src="&quot;查找解释&quot;" alt=""><img src="&quot;标注&quot;" alt=""><img src="&quot;链接到所选文件夹/标签/样式/文件&quot;" alt=""><img src="&quot;Wiz助手&quot;" alt=""><img src="&quot;稍后阅读(tag" alt="">&quot;)</p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li></span><span class="breadcrumb"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li><li><a href="/categories/Java&J2EE/Java_多线程/">Java_多线程</a></li><li><a href="/categories/Java&J2EE/Java_多线程/并发/">并发</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Java&J2EE/" class="label label-primary">Java&J2EE</a><a href="/tags/Java_多线程/" class="label label-success">Java_多线程</a><a href="/tags/并发/" class="label label-info">并发</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:41"datetime="2014-03-07 09:54:41"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-Java_多线程-并发--聊聊并发（一）——深入分析Volatile的实现原理2/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JavaJ2EE-Java_多线程-并发--聊聊并发（一）——深入分析Volatile的实现原理2" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JavaJ2EE-java-com-jacob--jacob合并几个word文件到一个word文件/">jacob合并几个word文件到一个word文件</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:41.000Z"> <a href="/2014/02/02/2014-02-02-JavaJ2EE-java-com-jacob--jacob合并几个word文件到一个word文件/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="jacob-word-word-">jacob合并几个word文件到一个word文件</h1>
<pre><code> 因项目需要将几个word文件合并到一个word文件，后面附项目运用的jar包jacob-1.9
</code></pre><p>jacob运用中，需要将附件内的jacob.dll放到windows/system32下</p>
<pre><code> 直接上代码：
</code></pre><p>Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>public static void main(String[] args) {  </li>
<li>List list  = new ArrayList();  </li>
<li>String file1= &quot;D:\file1.doc&quot;;  </li>
<li>String file2= &quot;D:\file2.doc&quot;;  </li>
<li>String file3= &quot;D:\file3.doc&quot;;  </li>
<li>list.add(file1);  </li>
<li>list.add(file2);  </li>
<li>list.add(file3);  </li>
<li>uniteDoc(list,&quot;d:\file.doc&quot;);  </li>
<li>}  </li>
<li>public static void uniteDoc(List fileList, String savepaths) {  </li>
<li>if (fileList.size() == 0 || fileList == null) {  </li>
<li>return;  </li>
<li>}  </li>
<li>//打开word  </li>
<li>ActiveXComponent app = new ActiveXComponent(&quot;Word.Application&quot;);//启动word  </li>
<li>try {  </li>
<li>// 设置word不可见  </li>
<li>app.setProperty(&quot;Visible&quot;, new Variant(false));  </li>
<li>//获得documents对象  </li>
<li>Object docs = app.getProperty(&quot;Documents&quot;).toDispatch();  </li>
<li>//打开第一个文件  </li>
<li>Object doc = Dispatch  </li>
<li>.invoke(  </li>
<li>(Dispatch) docs,  </li>
<li>&quot;Open&quot;,  </li>
<li>Dispatch.Method,  </li>
<li>new Object[] { (String) fileList.get(0),  </li>
<li>new Variant(false), new Variant(true) },  </li>
<li>new int[3]).toDispatch();  </li>
<li>//追加文件  </li>
<li>for (int i = 1; i &lt; fileList.size(); i++) {  </li>
<li>Dispatch.invoke(app.getProperty(&quot;Selection&quot;).toDispatch(),  </li>
<li>&quot;insertFile&quot;, Dispatch.Method, new Object[] {  </li>
<li>(String) fileList.get(i), &quot;&quot;,  </li>
<li>new Variant(false), new Variant(false),  </li>
<li>new Variant(false) }, new int[3]);  </li>
<li>}  </li>
<li>//保存新的word文件  </li>
<li>Dispatch.invoke((Dispatch) doc, &quot;SaveAs&quot;, Dispatch.Method,  </li>
<li>new Object[] { savepaths, new Variant(1) }, new int[3]);  </li>
<li>Variant f = new Variant(false);  </li>
<li>Dispatch.call((Dispatch) doc, &quot;Close&quot;, f);  </li>
<li>} catch (Exception e) {  </li>
<li>throw new RuntimeException(&quot;合并word文件出错.原因:&quot; + e);  </li>
<li>} finally {  </li>
<li>app.invoke(&quot;Quit&quot;, new Variant[] {});  </li>
<li>}  </li>
<li>}  </li>
</ol>
<p>public static void main(String[] args) {</p>
<pre><code>        List list  = new ArrayList();
        String file1= &quot;D:\\file1.doc&quot;;

        String file2= &quot;D:\\file2.doc&quot;;
        String file3= &quot;D:\\file3.doc&quot;;

        list.add(file1);
        list.add(file2);

        list.add(file3);
        uniteDoc(list,&quot;d:\\file.doc&quot;);

}
public static void uniteDoc(List fileList, String savepaths) {

    if (fileList.size() == 0 || fileList == null) {
        return;

    }
    //打开word

    ActiveXComponent app = new ActiveXComponent(&quot;Word.Application&quot;);//启动word
    try {

        // 设置word不可见
        app.setProperty(&quot;Visible&quot;, new Variant(false));

        //获得documents对象
        Object docs = app.getProperty(&quot;Documents&quot;).toDispatch();

        //打开第一个文件
        Object doc = Dispatch

            .invoke(
                    (Dispatch) docs,

                    &quot;Open&quot;,
                    Dispatch.Method,

                    new Object[] { (String) fileList.get(0),
                            new Variant(false), new Variant(true) },

                    new int[3]).toDispatch();
        //追加文件

        for (int i = 1; i &lt; fileList.size(); i++) {
            Dispatch.invoke(app.getProperty(&quot;Selection&quot;).toDispatch(),

                &quot;insertFile&quot;, Dispatch.Method, new Object[] {
                        (String) fileList.get(i), &quot;&quot;,

                        new Variant(false), new Variant(false),
                        new Variant(false) }, new int[3]);

        }
        //保存新的word文件

        Dispatch.invoke((Dispatch) doc, &quot;SaveAs&quot;, Dispatch.Method,
            new Object[] { savepaths, new Variant(1) }, new int[3]);

        Variant f = new Variant(false);
        Dispatch.call((Dispatch) doc, &quot;Close&quot;, f);

    } catch (Exception e) {
        throw new RuntimeException(&quot;合并word文件出错.原因:&quot; + e);

    } finally {
        app.invoke(&quot;Quit&quot;, new Variant[] {});

    }
}
</code></pre>
      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li></span><span class="breadcrumb"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li><li><a href="/categories/Java&J2EE/java-com/">java-com</a></li><li><a href="/categories/Java&J2EE/java-com/jacob/">jacob</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Java&J2EE/" class="label label-primary">Java&J2EE</a><a href="/tags/jacob/" class="label label-success">jacob</a><a href="/tags/java-com/" class="label label-info">java-com</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:41"datetime="2014-03-07 09:54:41"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-java-com-jacob--jacob合并几个word文件到一个word文件/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JavaJ2EE-java-com-jacob--jacob合并几个word文件到一个word文件" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JavaJ2EE-java-com-jacob--java操作word文档jacob-poi/">java操作word文档(jacob</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:41.000Z"> <a href="/2014/02/02/2014-02-02-JavaJ2EE-java-com-jacob--java操作word文档jacob-poi/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="java-word-jacob-poi-">java操作word文档(jacob,poi)</h1>
<p>项目需要，用户从系统里面下载word文档，该文档进行了填写限制和加密，用户只能在固定位置填写内容。现要求系统验证上传的附件是否从系统上下载下来的。</p>
<p>思路：系统上面的文档都加入一个固定书签，用户上传文档的时候，检验文档里是否包含这个书签。</p>
<p>采用jacob操作word文档</p>
<p>JACOB（java -com bridge）是一个 JAVA到微软的COM接口的桥梁。使用JACOB允许任何JVM访问COM对象，从而使JAVA应用程序能够调用COM对象。</p>
<p>下载地址：<a href="http://sourceforge.net/projects/jacob-project/" target="_blank"><a href="http://sourceforge.net/projects/jacob-project/">http://sourceforge.net/projects/jacob-project/</a></a></p>
<p>其中jacob-1.16.1-x64.dll 是用于64位机器上的，jacob-1.16.1-x86.dll用于32位的。</p>
<p>该dll放于 C:\Windows\system32 目录下。jacob.jar放于应用lib底下</p>
<p>测试代码
Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>ActiveXComponent    word = null;  </li>
<li>try {  </li>
<li>word = new ActiveXComponent(&quot;Word.Application&quot;);  </li>
<li>System.out.println(&quot;jacob当前版本：&quot;+word.getBuildVersion());  </li>
<li>}catch(Exception e ){  </li>
<li>e.printStackTrace();  </li>
<li>}  </li>
</ol>
<p>ActiveXComponent    word = null;</p>
<p>try {
        word = new ActiveXComponent(&quot;Word.Application&quot;);</p>
<pre><code>    System.out.println(&quot;jacob当前版本：&quot;+word.getBuildVersion());
</code></pre><p>}catch(Exception e ){</p>
<pre><code>     e.printStackTrace();
</code></pre><p>}</p>
<p>下面再贴出网上常见的代码+自己整理的几个方法（模糊查询书签等）</p>
<p>注意插入书签+书签值的方法，要先插入书签值再选中书签值，之后插入书签。这样根据书签名才能取得书签值。否则根据网络上很多方法，都取不到书签值或者取到空。因为书签值可以是一个点也可以是一大段内容。
Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>import java.io.File;  </li>
<li>import java.util.HashMap;  </li>
<li>import java.util.Map;  </li>
<li></li>
<li>import com.gdcn.bpaf.common.helper.StringHelper;  </li>
<li>import com.jacob.activeX.ActiveXComponent;  </li>
<li>import com.jacob.com.ComThread;  </li>
<li>import com.jacob.com.Dispatch;  </li>
<li>import com.jacob.com.Variant;  </li>
<li>//<em>/</em> </li>
<li>/<em>  /</em> </li>
<li>/* <p>Description: {jacob操作word类}    </p> </li>
<li>/* </li>
<li>/* <p>Copyright: Copyright (c) 2011</p> </li>
<li>/*  </li>
<li>/* <p>CreateDate: 2012-6-28</p> </li>
<li>/* </li>
<li>/* @author Beny </li>
<li>/* @version 1.0 </li>
<li>/*/  </li>
<li></li>
<li>public class JacobHelper {  </li>
<li>// word文档  </li>
<li>private Dispatch doc;  </li>
<li></li>
<li>// word运行程序对象  </li>
<li>private ActiveXComponent word;  </li>
<li></li>
<li>// 所有word文档集合  </li>
<li>private Dispatch documents;  </li>
<li></li>
<li>// 选定的范围或插入点  </li>
<li>private Dispatch selection;  </li>
<li></li>
<li>private boolean saveOnExit = true;  </li>
<li></li>
<li>public JacobHelper(boolean visible) throws Exception {  </li>
<li>ComThread.InitSTA();//线程启动  </li>
<li>if (word == null) {  </li>
<li>word = new ActiveXComponent(&quot;Word.Application&quot;);  </li>
<li>word.setProperty(&quot;Visible&quot;, new Variant(visible)); // 不可见打开word  </li>
<li>word.setProperty(&quot;AutomationSecurity&quot;, new Variant(3)); // 禁用宏  </li>
<li>}  </li>
<li>if (documents == null)  </li>
<li>documents = word.getProperty(&quot;Documents&quot;).toDispatch();  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 设置退出时参数 </li>
<li>/*  </li>
<li>/* @param saveOnExit </li>
<li>/*            boolean true-退出时保存文件，false-退出时不保存文件 </li>
<li>/*/  </li>
<li>public void setSaveOnExit(boolean saveOnExit) {  </li>
<li>this.saveOnExit = saveOnExit;  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 创建一个新的word文档 </li>
<li>/*  </li>
<li>/*/  </li>
<li>public void createNewDocument() {  </li>
<li>doc = Dispatch.call(documents, &quot;Add&quot;).toDispatch();  </li>
<li>selection = Dispatch.get(word, &quot;Selection&quot;).toDispatch();  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 打开一个已存在的文档 </li>
<li>/*  </li>
<li>/* @param docPath </li>
<li>/*/  </li>
<li>public void openDocument(String docPath) {  </li>
<li>//      closeDocument();  </li>
<li>doc = Dispatch.call(documents, &quot;Open&quot;, docPath).toDispatch();  </li>
<li>selection = Dispatch.get(word, &quot;Selection&quot;).toDispatch();  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 只读方式打开一个加密的文档 </li>
<li>/*  </li>
<li>/* @param docPath-文件全名 </li>
<li>/* @param pwd-密码 </li>
<li>/*/  </li>
<li>public void openDocumentOnlyRead(String docPath, String pwd)  </li>
<li>throws Exception {  </li>
<li>//      closeDocument();  </li>
<li>doc = Dispatch.callN(  </li>
<li>documents,  </li>
<li>&quot;Open&quot;,  </li>
<li>new Object[] { docPath, new Variant(false), new Variant(true),  </li>
<li>new Variant(true), pwd, &quot;&quot;, new Variant(false) })  </li>
<li>.toDispatch();  </li>
<li>selection = Dispatch.get(word, &quot;Selection&quot;).toDispatch();  </li>
<li>}  </li>
<li>//<em>/</em> </li>
<li>/* 打开一个加密的文档 </li>
<li>/* @param docPath </li>
<li>/* @param pwd </li>
<li>/* @throws Exception </li>
<li>/*/  </li>
<li>public void openDocument(String docPath, String pwd) throws Exception {  </li>
<li>//      closeDocument();  </li>
<li>doc = Dispatch.callN(  </li>
<li>documents,  </li>
<li>&quot;Open&quot;,  </li>
<li>new Object[] { docPath, new Variant(false), new Variant(false),  </li>
<li>new Variant(true), pwd }).toDispatch();  </li>
<li>selection = Dispatch.get(word, &quot;Selection&quot;).toDispatch();  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 从选定内容或插入点开始查找文本 </li>
<li>/*  </li>
<li>/* @param toFindText </li>
<li>/*            要查找的文本 </li>
<li>/* @return boolean true-查找到并选中该文本，false-未查找到文本 </li>
<li>/*/  </li>
<li>@SuppressWarnings(&quot;static-access&quot;)  </li>
<li>public boolean find(String toFindText) {  </li>
<li>if (toFindText == null || toFindText.equals(&quot;&quot;))  </li>
<li>return false;  </li>
<li>// 从selection所在位置开始查询  </li>
<li>Dispatch find = word.call(selection, &quot;Find&quot;).toDispatch();  </li>
<li>// 设置要查找的内容  </li>
<li>Dispatch.put(find, &quot;Text&quot;, toFindText);  </li>
<li>// 向前查找  </li>
<li>Dispatch.put(find, &quot;Forward&quot;, &quot;True&quot;);  </li>
<li>// 设置格式  </li>
<li>Dispatch.put(find, &quot;Format&quot;, &quot;True&quot;);  </li>
<li>// 大小写匹配  </li>
<li>Dispatch.put(find, &quot;MatchCase&quot;, &quot;True&quot;);  </li>
<li>// 全字匹配  </li>
<li>Dispatch.put(find, &quot;MatchWholeWord&quot;, &quot;false&quot;);  </li>
<li>// 查找并选中  </li>
<li>return Dispatch.call(find, &quot;Execute&quot;).getBoolean();  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 把选定选定内容设定为替换文本 </li>
<li>/*  </li>
<li>/* @param toFindText </li>
<li>/*            查找字符串 </li>
<li>/* @param newText </li>
<li>/*            要替换的内容 </li>
<li>/* @return </li>
<li>/*/  </li>
<li>public boolean replaceText(String toFindText, String newText) {  </li>
<li>if (!find(toFindText))  </li>
<li>return false;  </li>
<li>Dispatch.put(selection, &quot;Text&quot;, newText);  </li>
<li>return true;  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 全局替换文本 </li>
<li>/*  </li>
<li>/* @param toFindText </li>
<li>/*            查找字符串 </li>
<li>/* @param newText </li>
<li>/*            要替换的内容 </li>
<li>/*/  </li>
<li>public void replaceAllText(String toFindText, String newText) {  </li>
<li>while (find(toFindText)) {  </li>
<li>Dispatch.put(selection, &quot;Text&quot;, newText);  </li>
<li>Dispatch.call(selection, &quot;MoveRight&quot;);  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 在当前插入点插入字符串 </li>
<li>/*  </li>
<li>/* @param newText </li>
<li>/*            要插入的新字符串 </li>
<li>/*/  </li>
<li>public void insertText(String newText) {  </li>
<li>Dispatch.put(selection, &quot;Text&quot;, newText);  </li>
<li>}  </li>
<li></li>
<li></li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 设置当前选定内容的字体 </li>
<li>/*  </li>
<li>/* @param boldSize </li>
<li>/* @param italicSize </li>
<li>/* @param underLineSize </li>
<li>/*            下划线 </li>
<li>/* @param colorSize </li>
<li>/*            字体颜色 </li>
<li>/* @param size </li>
<li>/*            字体大小 </li>
<li>/* @param name </li>
<li>/*            字体名称 </li>
<li>/* @param hidden </li>
<li>/*            是否隐藏 </li>
<li>/*/  </li>
<li>public void setFont(boolean bold, boolean italic, boolean underLine,  </li>
<li>String colorSize, String size, String name,boolean hidden) {  </li>
<li>Dispatch font = Dispatch.get(selection, &quot;Font&quot;).toDispatch();  </li>
<li>Dispatch.put(font, &quot;Name&quot;, new Variant(name));  </li>
<li>Dispatch.put(font, &quot;Bold&quot;, new Variant(bold));  </li>
<li>Dispatch.put(font, &quot;Italic&quot;, new Variant(italic));  </li>
<li>Dispatch.put(font, &quot;Underline&quot;, new Variant(underLine));  </li>
<li>Dispatch.put(font, &quot;Color&quot;, colorSize);  </li>
<li>Dispatch.put(font, &quot;Size&quot;, size);  </li>
<li>Dispatch.put(font, &quot;Hidden&quot;, hidden);  </li>
<li>}  </li>
<li></li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 文件保存或另存为 </li>
<li>/*  </li>
<li>/* @param savePath </li>
<li>/*            保存或另存为路径 </li>
<li>/*/  </li>
<li>public void save(String savePath) {  </li>
<li>Dispatch.call(Dispatch.call(word, &quot;WordBasic&quot;).getDispatch(),  </li>
<li>&quot;FileSaveAs&quot;, savePath);  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 文件保存为html格式 </li>
<li>/*  </li>
<li>/* @param savePath </li>
<li>/* @param htmlPath </li>
<li>/*/  </li>
<li>public void saveAsHtml(String htmlPath) {  </li>
<li>Dispatch.invoke(doc, &quot;SaveAs&quot;, Dispatch.Method, new Object[] {  </li>
<li>htmlPath, new Variant(8) }, new int[1]);  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 关闭文档 </li>
<li>/*  </li>
<li>/* @param val </li>
<li>/*            0不保存修改 -1 保存修改 -2 提示是否保存修改 </li>
<li>/*/  </li>
<li>public void closeDocument(int val) {  </li>
<li>Dispatch.call(doc, &quot;Close&quot;, new Variant(val));//注 是documents而不是doc  </li>
<li>documents = null;  </li>
<li>doc = null;  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 关闭当前word文档 </li>
<li>/*  </li>
<li>/*/  </li>
<li>public void closeDocument() {  </li>
<li>if (documents != null) {  </li>
<li>Dispatch.call(documents, &quot;Save&quot;);  </li>
<li>Dispatch.call(documents, &quot;Close&quot;, new Variant(saveOnExit));  </li>
<li>documents = null;  </li>
<li>doc = null;  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>public void closeDocumentWithoutSave() {  </li>
<li>if (documents != null) {  </li>
<li>Dispatch.call(documents, &quot;Close&quot;, new Variant(false));  </li>
<li>documents = null;  </li>
<li>doc = null;  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 保存并关闭全部应用 </li>
<li>/*  </li>
<li>/*/  </li>
<li>public void close() {  </li>
<li>closeDocument(-1);  </li>
<li>if (word != null) {  </li>
<li>//          Dispatch.call(word, &quot;Quit&quot;);  </li>
<li>word.invoke(&quot;Quit&quot;, new Variant[] {});  </li>
<li>word = null;  </li>
<li>}  </li>
<li>selection = null;  </li>
<li>documents = null;  </li>
<li>ComThread.Release();//释放com线程。根据jacob的帮助文档，com的线程回收不由java的垃圾回收器处理  </li>
<li></li>
<li>}  </li>
<li>//<em>/</em> </li>
<li>/* 打印当前word文档 </li>
<li>/*  </li>
<li>/*/  </li>
<li>public void printFile() {  </li>
<li>if (doc != null) {  </li>
<li>Dispatch.call(doc, &quot;PrintOut&quot;);  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 保护当前档,如果不存在, 使用expression.Protect(Type, NoReset, Password) </li>
<li>/*  </li>
<li>/* @param pwd </li>
<li>/* @param type </li>
<li>/*            WdProtectionType 常量之一(int 类型，只读)： </li>
<li>/*            1-wdAllowOnlyComments  仅批注 </li>
<li>/*            2-wdAllowOnlyFormFields 仅填写窗体 </li>
<li>/*            0-wdAllowOnlyRevisions 仅修订 </li>
<li>/*            -1-wdNoProtection 无保护,  </li>
<li>/*            3-wdAllowOnlyReading 只读 </li>
<li>/*  </li>
<li>/*/  </li>
<li>public void protectedWord(String pwd,String type) {  </li>
<li>String protectionType = Dispatch.get(doc, &quot;ProtectionType&quot;).toString();  </li>
<li>if (protectionType.equals(&quot;-1&quot;)) {  </li>
<li>Dispatch.call(doc, &quot;Protect&quot;, Integer.parseInt(type), new Variant(true),pwd);  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 解除文档保护,如果存在 </li>
<li>/*  </li>
<li>/* @param pwd </li>
<li>/*            WdProtectionType 常量之一(int 类型，只读)： </li>
<li>/*            1-wdAllowOnlyComments  仅批注 </li>
<li>/*            2-wdAllowOnlyFormFields 仅填写窗体 </li>
<li>/*            0-wdAllowOnlyRevisions 仅修订 </li>
<li>/*            -1-wdNoProtection 无保护,  </li>
<li>/*            3-wdAllowOnlyReading 只读 </li>
<li>/*  </li>
<li>/*/  </li>
<li>public void unProtectedWord(String pwd) {  </li>
<li>String protectionType = Dispatch.get(doc, &quot;ProtectionType&quot;).toString();  </li>
<li>if (!protectionType.equals(&quot;0&quot;)&amp;&amp;!protectionType.equals(&quot;-1&quot;)) {  </li>
<li>Dispatch.call(doc, &quot;Unprotect&quot;, pwd);  </li>
<li>}  </li>
<li>}  </li>
<li>//<em>/</em> </li>
<li>/* 返回文档的保护类型 </li>
<li>/* @return </li>
<li>/*/  </li>
<li>public String getProtectedType(){  </li>
<li>return Dispatch.get(doc, &quot;ProtectionType&quot;).toString();  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 设置word文档安全级别 </li>
<li>/*  </li>
<li>/* @param value </li>
<li>/*            1-msoAutomationSecurityByUI 使用“安全”对话框指定的安全设置。 </li>
<li>/*            2-msoAutomationSecurityForceDisable </li>
<li>/*            在程序打开的所有文件中禁用所有宏，而不显示任何安全提醒。 3-msoAutomationSecurityLow </li>
<li>/*            启用所有宏，这是启动应用程序时的默认值。 </li>
<li>/*/  </li>
<li>public void setAutomationSecurity(int value) {  </li>
<li>word.setProperty(&quot;AutomationSecurity&quot;, new Variant(value));  </li>
<li>}  </li>
<li></li>
<li></li>
<li></li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 在word中插入标签 labelName是标签名，labelValue是标签值 </li>
<li>/* @param labelName </li>
<li>/* @param labelValue </li>
<li>/*/  </li>
<li>public  void insertLabelValue(String labelName,String labelValue) {  </li>
<li></li>
<li>Dispatch bookMarks = Dispatch.call(doc, &quot;Bookmarks&quot;).toDispatch();  </li>
<li>boolean isExist = Dispatch.call(bookMarks, &quot;Exists&quot;, labelName).getBoolean();  </li>
<li>if (isExist == true) {  </li>
<li>Dispatch rangeItem1 = Dispatch.call(bookMarks, &quot;Item&quot;, labelName).toDispatch();  </li>
<li>Dispatch range1 = Dispatch.call(rangeItem1, &quot;Range&quot;).toDispatch();  </li>
<li>String bookMark1Value = Dispatch.get(range1, &quot;Text&quot;).toString();  </li>
<li>System.out.println(&quot;书签内容：&quot;+bookMark1Value);  </li>
<li>} else {  </li>
<li>System.out.println(&quot;当前书签不存在,重新建立!&quot;);  </li>
<li>//TODO 先插入文字，再查找选中文字，再插入标签  </li>
<li>this.insertText(labelValue);  </li>
<li>//          this.find(labelValue);//查找文字，并选中  </li>
<li>this.setFont(true, true,true,&quot;102,92,38&quot;, &quot;20&quot;, &quot;&quot;,true);  </li>
<li>Dispatch.call(bookMarks, &quot;Add&quot;, labelName, selection);  </li>
<li>Dispatch.call(bookMarks, &quot;Hidden&quot;, labelName);  </li>
<li>}  </li>
<li>}  </li>
<li>//<em>/</em> </li>
<li>/* 在word中插入标签 labelName是标签名 </li>
<li>/* @param labelName </li>
<li>/*/  </li>
<li>public  void insertLabel(String labelName) {  </li>
<li></li>
<li>Dispatch bookMarks = Dispatch.call(doc, &quot;Bookmarks&quot;).toDispatch();  </li>
<li>boolean isExist = Dispatch.call(bookMarks, &quot;Exists&quot;, labelName).getBoolean();  </li>
<li>if (isExist == true) {  </li>
<li>System.out.println(&quot;书签已存在&quot;);  </li>
<li>} else {  </li>
<li>System.out.println(&quot;建立书签：&quot;+labelName);  </li>
<li>Dispatch.call(bookMarks, &quot;Add&quot;, labelName, selection);  </li>
<li>}  </li>
<li>}     </li>
<li>//<em>/</em> </li>
<li>/* 查找书签 </li>
<li>/* @param labelName </li>
<li>/* @return </li>
<li>/*/  </li>
<li>public boolean findLabel(String labelName) {  </li>
<li>Dispatch bookMarks = Dispatch.call(doc, &quot;Bookmarks&quot;).toDispatch();  </li>
<li>boolean isExist = Dispatch.call(bookMarks, &quot;Exists&quot;, labelName).getBoolean();  </li>
<li>if (isExist == true) {  </li>
<li>return true;  </li>
<li>} else {  </li>
<li>System.out.println(&quot;当前书签不存在!&quot;);  </li>
<li>return false;  </li>
<li>}  </li>
<li>}  </li>
<li>//<em>/</em> </li>
<li>/* 模糊查找书签,并返回准确的书签名称 </li>
<li>/* @param labelName </li>
<li>/* @return </li>
<li>/*/  </li>
<li>public String findLabelLike(String labelName) {  </li>
<li>Dispatch bookMarks = Dispatch.call(doc, &quot;Bookmarks&quot;).toDispatch();  </li>
<li>int count = Dispatch.get(bookMarks, &quot;Count&quot;).getInt(); // 书签数  </li>
<li>Dispatch rangeItem = null;  </li>
<li>String lname = &quot;&quot;;  </li>
<li>for(int i=1;i&lt;=count;i++){  </li>
<li>rangeItem = Dispatch.call(bookMarks, &quot;Item&quot;, new Variant(i)).toDispatch();  </li>
<li>lname = Dispatch.call(rangeItem, &quot;Name&quot;).toString();//书签名称  </li>
<li>if(lname.startsWith(labelName)){//前面匹配  </li>
<li>//             return lname.replaceFirst(labelName, &quot;&quot;);//返回后面值  </li>
<li>return lname;  </li>
<li>}  </li>
<li>}  </li>
<li>return &quot;&quot;;  </li>
<li>}  </li>
<li>//<em>/</em> </li>
<li>/* 模糊删除书签 </li>
<li>/* @param labelName </li>
<li>/*/  </li>
<li>public void deleteLableLike(String labelName){  </li>
<li>Dispatch bookMarks = Dispatch.call(doc, &quot;Bookmarks&quot;).toDispatch();  </li>
<li>int count = Dispatch.get(bookMarks, &quot;Count&quot;).getInt(); // 书签数  </li>
<li>Dispatch rangeItem = null;  </li>
<li>String lname = &quot;&quot;;  </li>
<li>for(int i=1;i&lt;=count;i++){  </li>
<li>rangeItem = Dispatch.call(bookMarks, &quot;Item&quot;, new Variant(i)).toDispatch();  </li>
<li>lname = Dispatch.call(rangeItem, &quot;Name&quot;).toString();//书签名称  </li>
<li>if(lname.startsWith(labelName)){//前面匹配  </li>
<li>Dispatch.call(rangeItem, &quot;Delete&quot;);  </li>
<li>count--;//书签已被删除，书签数目和当前书签都要相应减1，否则会报错:集合找不到  </li>
<li>i--;  </li>
<li>}  </li>
<li>}  </li>
<li>}  </li>
<li>//<em>/</em> </li>
<li>/* 获取书签内容 </li>
<li>/* @param labelName </li>
<li>/* @return </li>
<li>/*/  </li>
<li>public String getLableValue(String labelName){  </li>
<li>if(this.findLabel(labelName)){  </li>
<li>Dispatch bookMarks = Dispatch.call(doc, &quot;Bookmarks&quot;).toDispatch();  </li>
<li>Dispatch rangeItem1 = Dispatch.call(bookMarks, &quot;Item&quot;, labelName).toDispatch();  </li>
<li>Dispatch range1 = Dispatch.call(rangeItem1, &quot;Range&quot;).toDispatch();  </li>
<li>Dispatch font = Dispatch.get(range1, &quot;Font&quot;).toDispatch();  </li>
<li>Dispatch.put(font, &quot;Hidden&quot;, new Variant(false)); //显示书签内容  </li>
<li>String bookMark1Value = Dispatch.get(range1, &quot;Text&quot;).toString();  </li>
<li>System.out.println(&quot;书签内容：&quot;+bookMark1Value);  </li>
<li>//            font = Dispatch.get(range1, &quot;Font&quot;).toDispatch();  </li>
<li>//              Dispatch.put(font, &quot;Hidden&quot;, new Variant(true)); //隐藏书签内容  </li>
<li>return bookMark1Value;  </li>
<li>}  </li>
<li>return &quot;&quot;;  </li>
<li>}  </li>
<li></li>
<li></li>
<li>public static void main(String[] args) throws Exception {  </li>
<li></li>
<li>}     </li>
<li></li>
<li>}  </li>
</ol>
<p>import java.io.File;</p>
<p>import java.util.HashMap;
import java.util.Map;</p>
<p>import com.gdcn.bpaf.common.helper.StringHelper;</p>
<p>import com.jacob.activeX.ActiveXComponent;
import com.jacob.com.ComThread;</p>
<p>import com.jacob.com.Dispatch;
import com.jacob.com.Variant;</p>
<p>//<em>/</em>
 /<em>  /</em></p>
<p> /<em> <p>Description: {jacob操作word类}    </p>
/</em></p>
<p>/<em> <p>Copyright: Copyright (c) 2011</p>
/</em></p>
<p>/<em> <p>CreateDate: 2012-6-28</p>
/</em></p>
<p>/<em> @author Beny
/</em> @version 1.0</p>
<p>/*/</p>
<p>public class JacobHelper {
    // word文档</p>
<pre><code>private Dispatch doc;


// word运行程序对象
private ActiveXComponent word;


// 所有word文档集合

private Dispatch documents;


// 选定的范围或插入点
private Dispatch selection;


private boolean saveOnExit = true;


public JacobHelper(boolean visible) throws Exception {

    ComThread.InitSTA();//线程启动
    if (word == null) {

        word = new ActiveXComponent(&quot;Word.Application&quot;);
        word.setProperty(&quot;Visible&quot;, new Variant(visible)); // 不可见打开word

        word.setProperty(&quot;AutomationSecurity&quot;, new Variant(3)); // 禁用宏
    }

    if (documents == null)
        documents = word.getProperty(&quot;Documents&quot;).toDispatch();

}


//*/*
 /* 设置退出时参数

 /*
 /* @param saveOnExit

 /*            boolean true-退出时保存文件，false-退出时不保存文件
 /*/

public void setSaveOnExit(boolean saveOnExit) {
    this.saveOnExit = saveOnExit;

}


//*/*
 /* 创建一个新的word文档

 /*
 /*/

public void createNewDocument() {
    doc = Dispatch.call(documents, &quot;Add&quot;).toDispatch();

    selection = Dispatch.get(word, &quot;Selection&quot;).toDispatch();
}


//*/*

 /* 打开一个已存在的文档
 /*

 /* @param docPath
 /*/

public void openDocument(String docPath) {
</code></pre><p>//        closeDocument();</p>
<pre><code>    doc = Dispatch.call(documents, &quot;Open&quot;, docPath).toDispatch();
    selection = Dispatch.get(word, &quot;Selection&quot;).toDispatch();

}


//*/*
 /* 只读方式打开一个加密的文档

 /*
 /* @param docPath-文件全名

 /* @param pwd-密码
 /*/

public void openDocumentOnlyRead(String docPath, String pwd)
        throws Exception {
</code></pre><p>//        closeDocument();
        doc = Dispatch.callN(</p>
<pre><code>            documents,
            &quot;Open&quot;,

            new Object[] { docPath, new Variant(false), new Variant(true),
                    new Variant(true), pwd, &quot;&quot;, new Variant(false) })

            .toDispatch();
    selection = Dispatch.get(word, &quot;Selection&quot;).toDispatch();

}
//*/*

 /* 打开一个加密的文档
 /* @param docPath

 /* @param pwd
 /* @throws Exception

 /*/
public void openDocument(String docPath, String pwd) throws Exception {
</code></pre><p>//        closeDocument();
        doc = Dispatch.callN(</p>
<pre><code>            documents,
            &quot;Open&quot;,

            new Object[] { docPath, new Variant(false), new Variant(false),
                    new Variant(true), pwd }).toDispatch();

    selection = Dispatch.get(word, &quot;Selection&quot;).toDispatch();
}


//*/*

 /* 从选定内容或插入点开始查找文本
 /*

 /* @param toFindText
 /*            要查找的文本

 /* @return boolean true-查找到并选中该文本，false-未查找到文本
 /*/

@SuppressWarnings(&quot;static-access&quot;)
public boolean find(String toFindText) {

    if (toFindText == null || toFindText.equals(&quot;&quot;))
        return false;

    // 从selection所在位置开始查询
    Dispatch find = word.call(selection, &quot;Find&quot;).toDispatch();

    // 设置要查找的内容
    Dispatch.put(find, &quot;Text&quot;, toFindText);

    // 向前查找
    Dispatch.put(find, &quot;Forward&quot;, &quot;True&quot;);

    // 设置格式
    Dispatch.put(find, &quot;Format&quot;, &quot;True&quot;);

    // 大小写匹配
    Dispatch.put(find, &quot;MatchCase&quot;, &quot;True&quot;);

    // 全字匹配
    Dispatch.put(find, &quot;MatchWholeWord&quot;, &quot;false&quot;);

    // 查找并选中
    return Dispatch.call(find, &quot;Execute&quot;).getBoolean();

}


//*/*
 /* 把选定选定内容设定为替换文本

 /*
 /* @param toFindText

 /*            查找字符串
 /* @param newText

 /*            要替换的内容
 /* @return

 /*/
public boolean replaceText(String toFindText, String newText) {

    if (!find(toFindText))
        return false;

    Dispatch.put(selection, &quot;Text&quot;, newText);
    return true;

}


//*/*
 /* 全局替换文本

 /*
 /* @param toFindText

 /*            查找字符串
 /* @param newText

 /*            要替换的内容
 /*/

public void replaceAllText(String toFindText, String newText) {
    while (find(toFindText)) {

        Dispatch.put(selection, &quot;Text&quot;, newText);
        Dispatch.call(selection, &quot;MoveRight&quot;);

    }
}


//*/*

 /* 在当前插入点插入字符串
 /*

 /* @param newText
 /*            要插入的新字符串

 /*/
public void insertText(String newText) {

    Dispatch.put(selection, &quot;Text&quot;, newText);
}





//*/*

 /* 设置当前选定内容的字体
 /*

 /* @param boldSize
 /* @param italicSize

 /* @param underLineSize
 /*            下划线

 /* @param colorSize
 /*            字体颜色

 /* @param size
 /*            字体大小

 /* @param name
 /*            字体名称

 /* @param hidden
 /*            是否隐藏

 /*/
public void setFont(boolean bold, boolean italic, boolean underLine,

        String colorSize, String size, String name,boolean hidden) {
    Dispatch font = Dispatch.get(selection, &quot;Font&quot;).toDispatch();

    Dispatch.put(font, &quot;Name&quot;, new Variant(name));
    Dispatch.put(font, &quot;Bold&quot;, new Variant(bold));

    Dispatch.put(font, &quot;Italic&quot;, new Variant(italic));
    Dispatch.put(font, &quot;Underline&quot;, new Variant(underLine));

    Dispatch.put(font, &quot;Color&quot;, colorSize);
    Dispatch.put(font, &quot;Size&quot;, size);

    Dispatch.put(font, &quot;Hidden&quot;, hidden);
}




//*/*
 /* 文件保存或另存为

 /*
 /* @param savePath

 /*            保存或另存为路径
 /*/

public void save(String savePath) {
    Dispatch.call(Dispatch.call(word, &quot;WordBasic&quot;).getDispatch(),

            &quot;FileSaveAs&quot;, savePath);
}


//*/*

 /* 文件保存为html格式
 /*

 /* @param savePath
 /* @param htmlPath

 /*/
public void saveAsHtml(String htmlPath) {

    Dispatch.invoke(doc, &quot;SaveAs&quot;, Dispatch.Method, new Object[] {
            htmlPath, new Variant(8) }, new int[1]);

}


//*/*
 /* 关闭文档

 /*
 /* @param val

 /*            0不保存修改 -1 保存修改 -2 提示是否保存修改
 /*/

public void closeDocument(int val) {
    Dispatch.call(doc, &quot;Close&quot;, new Variant(val));//注 是documents而不是doc

    documents = null;
    doc = null;

}


//*/*
 /* 关闭当前word文档

 /*
 /*/

public void closeDocument() {
    if (documents != null) {

        Dispatch.call(documents, &quot;Save&quot;);
        Dispatch.call(documents, &quot;Close&quot;, new Variant(saveOnExit));

        documents = null;
        doc = null;

    }
}


public void closeDocumentWithoutSave() {

    if (documents != null) {
        Dispatch.call(documents, &quot;Close&quot;, new Variant(false));

        documents = null;
        doc = null;

    }
}


//*/*

 /* 保存并关闭全部应用
 /*

 /*/
public void close() {

    closeDocument(-1);
    if (word != null) {
</code></pre><p>//            Dispatch.call(word, &quot;Quit&quot;);
            word.invoke(&quot;Quit&quot;, new Variant[] {});</p>
<pre><code>        word = null;
    }

    selection = null;
    documents = null;

    ComThread.Release();//释放com线程。根据jacob的帮助文档，com的线程回收不由java的垃圾回收器处理


}
//*/*

 /* 打印当前word文档
 /*

 /*/
public void printFile() {

    if (doc != null) {
        Dispatch.call(doc, &quot;PrintOut&quot;);

    }
}


//*/*

 /* 保护当前档,如果不存在, 使用expression.Protect(Type, NoReset, Password)
 /*

 /* @param pwd
 /* @param type

 /*            WdProtectionType 常量之一(int 类型，只读)：
 /*            1-wdAllowOnlyComments  仅批注

 /*            2-wdAllowOnlyFormFields 仅填写窗体
 /*            0-wdAllowOnlyRevisions 仅修订

 /*            -1-wdNoProtection 无保护,
 /*            3-wdAllowOnlyReading 只读

 /*
 /*/

public void protectedWord(String pwd,String type) {
    String protectionType = Dispatch.get(doc, &quot;ProtectionType&quot;).toString();

    if (protectionType.equals(&quot;-1&quot;)) {
        Dispatch.call(doc, &quot;Protect&quot;, Integer.parseInt(type), new Variant(true),pwd);

    }
}


//*/*

 /* 解除文档保护,如果存在
 /*

 /* @param pwd
 /*            WdProtectionType 常量之一(int 类型，只读)：

 /*            1-wdAllowOnlyComments  仅批注
 /*            2-wdAllowOnlyFormFields 仅填写窗体

 /*            0-wdAllowOnlyRevisions 仅修订
 /*            -1-wdNoProtection 无保护,

 /*            3-wdAllowOnlyReading 只读
 /*

 /*/
public void unProtectedWord(String pwd) {

    String protectionType = Dispatch.get(doc, &quot;ProtectionType&quot;).toString();
    if (!protectionType.equals(&quot;0&quot;)&amp;&amp;!protectionType.equals(&quot;-1&quot;)) {

        Dispatch.call(doc, &quot;Unprotect&quot;, pwd);
    }

}
//*/*

 /* 返回文档的保护类型
 /* @return

 /*/
public String getProtectedType(){

    return Dispatch.get(doc, &quot;ProtectionType&quot;).toString();
}


//*/*

 /* 设置word文档安全级别
 /*

 /* @param value
 /*            1-msoAutomationSecurityByUI 使用“安全”对话框指定的安全设置。

 /*            2-msoAutomationSecurityForceDisable
 /*            在程序打开的所有文件中禁用所有宏，而不显示任何安全提醒。 3-msoAutomationSecurityLow

 /*            启用所有宏，这是启动应用程序时的默认值。
 /*/

public void setAutomationSecurity(int value) {
    word.setProperty(&quot;AutomationSecurity&quot;, new Variant(value));

}






//*/*

 /* 在word中插入标签 labelName是标签名，labelValue是标签值
 /* @param labelName

 /* @param labelValue
 /*/

public  void insertLabelValue(String labelName,String labelValue) {


   Dispatch bookMarks = Dispatch.call(doc, &quot;Bookmarks&quot;).toDispatch();
   boolean isExist = Dispatch.call(bookMarks, &quot;Exists&quot;, labelName).getBoolean();

    if (isExist == true) {
        Dispatch rangeItem1 = Dispatch.call(bookMarks, &quot;Item&quot;, labelName).toDispatch();

        Dispatch range1 = Dispatch.call(rangeItem1, &quot;Range&quot;).toDispatch();
        String bookMark1Value = Dispatch.get(range1, &quot;Text&quot;).toString();

          System.out.println(&quot;书签内容：&quot;+bookMark1Value);
    } else {

        System.out.println(&quot;当前书签不存在,重新建立!&quot;);
        //TODO 先插入文字，再查找选中文字，再插入标签

        this.insertText(labelValue);
</code></pre><p>//            this.find(labelValue);//查找文字，并选中</p>
<pre><code>        this.setFont(true, true,true,&quot;102,92,38&quot;, &quot;20&quot;, &quot;&quot;,true);
         Dispatch.call(bookMarks, &quot;Add&quot;, labelName, selection);

         Dispatch.call(bookMarks, &quot;Hidden&quot;, labelName);
    }

}
//*/*

 /* 在word中插入标签 labelName是标签名
 /* @param labelName

 /*/
public  void insertLabel(String labelName) {


   Dispatch bookMarks = Dispatch.call(doc, &quot;Bookmarks&quot;).toDispatch();

   boolean isExist = Dispatch.call(bookMarks, &quot;Exists&quot;, labelName).getBoolean();
    if (isExist == true) {

          System.out.println(&quot;书签已存在&quot;);
    } else {

        System.out.println(&quot;建立书签：&quot;+labelName);
         Dispatch.call(bookMarks, &quot;Add&quot;, labelName, selection);

    }
}   

//*/*
 /* 查找书签

 /* @param labelName
 /* @return

 /*/
public boolean findLabel(String labelName) {

   Dispatch bookMarks = Dispatch.call(doc, &quot;Bookmarks&quot;).toDispatch();
   boolean isExist = Dispatch.call(bookMarks, &quot;Exists&quot;, labelName).getBoolean();

   if (isExist == true) {
          return true;

    } else {
        System.out.println(&quot;当前书签不存在!&quot;);

        return false;
    }

}
//*/*

 /* 模糊查找书签,并返回准确的书签名称
 /* @param labelName

 /* @return
 /*/

public String findLabelLike(String labelName) {
   Dispatch bookMarks = Dispatch.call(doc, &quot;Bookmarks&quot;).toDispatch();

   int count = Dispatch.get(bookMarks, &quot;Count&quot;).getInt(); // 书签数
   Dispatch rangeItem = null;

   String lname = &quot;&quot;;
   for(int i=1;i&lt;=count;i++){

       rangeItem = Dispatch.call(bookMarks, &quot;Item&quot;, new Variant(i)).toDispatch();
       lname = Dispatch.call(rangeItem, &quot;Name&quot;).toString();//书签名称

       if(lname.startsWith(labelName)){//前面匹配
</code></pre><p>//               return lname.replaceFirst(labelName, &quot;&quot;);//返回后面值</p>
<pre><code>           return lname;
       }

   }
   return &quot;&quot;;

}
//*/*

 /* 模糊删除书签
 /* @param labelName

 /*/
public void deleteLableLike(String labelName){

    Dispatch bookMarks = Dispatch.call(doc, &quot;Bookmarks&quot;).toDispatch();
   int count = Dispatch.get(bookMarks, &quot;Count&quot;).getInt(); // 书签数

   Dispatch rangeItem = null;
   String lname = &quot;&quot;;

   for(int i=1;i&lt;=count;i++){
       rangeItem = Dispatch.call(bookMarks, &quot;Item&quot;, new Variant(i)).toDispatch();

       lname = Dispatch.call(rangeItem, &quot;Name&quot;).toString();//书签名称
       if(lname.startsWith(labelName)){//前面匹配

           Dispatch.call(rangeItem, &quot;Delete&quot;);
           count--;//书签已被删除，书签数目和当前书签都要相应减1，否则会报错:集合找不到

           i--;
       }

   }
}

//*/*
 /* 获取书签内容

 /* @param labelName
 /* @return

 /*/
public String getLableValue(String labelName){

    if(this.findLabel(labelName)){
        Dispatch bookMarks = Dispatch.call(doc, &quot;Bookmarks&quot;).toDispatch();

        Dispatch rangeItem1 = Dispatch.call(bookMarks, &quot;Item&quot;, labelName).toDispatch();
        Dispatch range1 = Dispatch.call(rangeItem1, &quot;Range&quot;).toDispatch();

        Dispatch font = Dispatch.get(range1, &quot;Font&quot;).toDispatch();
        Dispatch.put(font, &quot;Hidden&quot;, new Variant(false)); //显示书签内容

        String bookMark1Value = Dispatch.get(range1, &quot;Text&quot;).toString();
          System.out.println(&quot;书签内容：&quot;+bookMark1Value);
</code></pre><p>//            font = Dispatch.get(range1, &quot;Font&quot;).toDispatch();
//              Dispatch.put(font, &quot;Hidden&quot;, new Variant(true)); //隐藏书签内容</p>
<pre><code>          return bookMark1Value;
    }

    return &quot;&quot;;
}




public static void main(String[] args) throws Exception {


}   
</code></pre><p>}</p>
<p> 采用jacob方式操作文档，经常会出现卡机的现象，所以最后采用poi方式来操作书签。若单纯的操作书签用poi方式还是比较简单的，但要操作表格、文档格式之类的还是用jacob功能比较强大。
Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>InputStream input = null;  </li>
<li>File docFile = new File( fileName );  </li>
<li>HWPFDocument document = null;  </li>
<li>try{  </li>
<li>input = new FileInputStream(docFile);//加载 doc 文档  </li>
<li>document = new HWPFDocument(input);//文件流方式创建hwpf  </li>
<li>Bookmarks bookmarks =  document.getBookmarks();//文档书签  </li>
<li>for(int i=0,length=bookmarks.getBookmarksCount();i&lt;length;i++){  </li>
<li>bookmarkName = bookmarks.getBookmark(i).getName();  </li>
<li>//.....  </li>
<li>}  </li>
<li></li>
<li>}catch( Exception e){  </li>
<li></li>
<li>}finally{  </li>
<li>if( null != input )  </li>
<li>input.close();  </li>
<li>}  </li>
</ol>
<p>InputStream input = null;</p>
<p>File docFile = new File( fileName );
HWPFDocument document = null;</p>
<p>try{
    input = new FileInputStream(docFile);//加载 doc 文档</p>
<pre><code>document = new HWPFDocument(input);//文件流方式创建hwpf
Bookmarks bookmarks =  document.getBookmarks();//文档书签

for(int i=0,length=bookmarks.getBookmarksCount();i&lt;length;i++){
    bookmarkName = bookmarks.getBookmark(i).getName();

    //.....
}
</code></pre><p>}catch( Exception e){</p>
<p>}finally{</p>
<pre><code>if( null != input )
        input.close();
</code></pre><p>}</p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li></span><span class="breadcrumb"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li><li><a href="/categories/Java&J2EE/java-com/">java-com</a></li><li><a href="/categories/Java&J2EE/java-com/jacob/">jacob</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Java&J2EE/" class="label label-primary">Java&J2EE</a><a href="/tags/jacob/" class="label label-success">jacob</a><a href="/tags/java-com/" class="label label-info">java-com</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:41"datetime="2014-03-07 09:54:41"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-java-com-jacob--java操作word文档jacob-poi/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JavaJ2EE-java-com-jacob--java操作word文档jacob-poi" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>





<ul id="pagination" class="pagination pagination-lg">
  <li><a class="extend prev" href="/page/53/">&laquo;</a></li><li><a class="page-number" href="/">1</a></li><li><a class="page-number" href="/page/2/">2</a></li><li><span class="space">&hellip;</span></li><li><a class="page-number" href="/page/51/">51</a></li><li><a class="page-number" href="/page/52/">52</a></li><li><a class="page-number" href="/page/53/">53</a></li><li class="active"><li><span class="page-number current">54</span></li><li><a class="page-number" href="/page/55/">55</a></li><li><a class="page-number" href="/page/56/">56</a></li><li><a class="page-number" href="/page/57/">57</a></li><li><span class="space">&hellip;</span></li></li><li><a class="page-number" href="/page/164/">164</a></li><li><a class="page-number" href="/page/165/">165</a></li><li><a class="extend next" href="/page/55/">&raquo;</a></li>
  <div class="clearfix"></div>
</ul></div><!--wapper-->
       </div><!-- ID main-col END -->
       <aside id="sidebar" class="alignright col-sx-6 col-sm-4 col-md-3 col-lg-3">
<div id="widget_search" class="widget panel panel-primary">
    <form action="//google.com/search" method="get" accept-charset="utf-8">
  <div class="input-group">
    <input class="form-control" id="searchbox" type="search" name="q" results="0" placeholder="search">
    <span class="input-group-btn">
      <button class="btn btn-default" type="submit">Go!</button>
    </span>
    <input type="hidden" name="q" value="site:itsolife.com">
  </div>
</form>
</div>

<div id="widget_category" class="widget panel panel-primary">
  <div class="panel-heading">category</div>  <div data-src='category' class='ajax_widgets'>正在加载...</div>
</div>

<div id="widget_recent_posts" class="widget panel panel-primary">
  <div class="panel-heading">recent posts</div>  <div data-src='recent_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_tagcloud" class="widget panel panel-primary">
  <div class="panel-heading">tagcloud</div>  <div data-src='tagcloud' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_latest_update_posts" class="widget panel panel-primary">
  <div class="panel-heading">最近更新</div>  <div data-src='latest_update_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_recent_comments" class="widget panel panel-primary">
  <div class="panel-heading">recent comments</div>  

<div class="list-group-item ds-recent-comments" data-num-items="6" data-show-avatars="1" data-show-time="1" data-show-title="1" data-show-admin="1" data-excerpt-length="50"></div>



</div>

</aside>
       <div class="clearfix"></div>
     </div><!-- row END -->
  </div>
  <footer id="footer" class="container">
  <div class="panel panel-info">
  <section id='footer_widget'></section>  <div class="panel-footer">
  <div id="site-info">
    <span class='author'>
  
  &copy; 2014 RobinChia
  
    &nbsp;&nbsp;</span>
  
  <span id='analytics-51la'></span><span id='analytics-google'>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-48559895-1']);
  _gaq.push(['_trackPageview']);
  _js2load.push({src:('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'});
</script></span><span id='analytics-cnzz'>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_5774006'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s17.cnzz.com/stat.php%3Fid%3D5774006%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</span><span id='analytics-baidu'>
<script>
var _hmt = _hmt || [];
_js2load.push({src:"//hm.baidu.com/hm.js?1442f50724afc42380b51f097c43082c"});
</script>
</span>  </div>
  <div id="copyright">Blog powered by <a href='http://zespia.tw/hexo/'><strong>hexo</strong></a> Theme <strong><a href='https://github.com/chenall/hexo-theme-chenall'>chenall</a></strong>(Some change in it)<span class="pull-right"> 更新时间: <em>2014-03-15 16:43:39</em></span></div>
</div>
<div class="clearfix"></div>


  </div>
  </footer>
  
        <script src="http://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>        
        <script src="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>        
                
        <script src="http://cdn.bootcss.com/prettify/r298/prettify.min.js"></script>    <script type="text/javascript">
   var lang=["bsh", "c", "cc", "cpp", "cs", "csh", "cyc", "cv", "htm", "html",
    "java", "js", "m", "mxml", "perl", "pl", "pm", "py", "rb", "sh",
    "xhtml", "xml", "xsl"];
   var pretty_base='';
   $('script').each(function(){
	var c = $(this).attr('src');
	if (!c)
	    return;
	if (c.match(/(\/)?prettify(\.min)?\.js/i))
	{
	    var index = c.lastIndexOf('/');
	    if (index != -1)
		pretty_base = c.substr(0,index + 1);
	    return false;
	}
   })
   $('pre code').each(function(){
	var c = $(this).attr('class')
	if (!c)
	    return;
	c = c.match(/\s?(lang\-\w+)/i);
	if (c && lang.indexOf(c[1]) == -1)
	{
	    lang.push(c[1]);
	    $.getScript(pretty_base + c[1] + '.min.js');
	}
   })

    $(window).load(function(){
       $("pre").addClass("prettyprint");
       prettyPrint();
    })
</script>    
            <script type="text/javascript">
var duoshuoQuery = {short_name:"robinchia"};
_js2load.push({src:'http://static.duoshuo.com/embed.js',charset:'UTF-8'});
</script>
    
            <!--wumii_relatedItems-->
    
        <script src="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>    <script type="text/javascript">
(function($){
  $('.entry').each(function(i){
    $(this).find('img').each(function(){
      var alt = this.alt;

      if (alt){
        $(this).before('<span class="caption">' + alt + '</span>');
      }

      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="fancybox' + i + '" />');
    });
  });

  $('.fancybox').fancybox();
})(jQuery);
</script>    
        <script src="http://cdn.bootcss.com/mathjax/2.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>
    
<script type="text/javascript">
$('.ajax_widgets').each(function(){var src=$(this).attr('data-src');if(src)$(this).load('/widgets/'+src+'.html');});
$.each(_js2load,function(index,obj){loadjs(obj.src,obj.charset)});
</script>

<div id="scroll2top">
<img src="/scroll2top/arrow.png"/>
</div>
<script src="/scroll2top/scroll2top.min.js"></script>
<div id="winterland">
  <canvas></canvas>
</div>
<script src="/js/winterland.min.js"></script>

  </body>
</html>
