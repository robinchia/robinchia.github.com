
<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>The 59 Page | It so life</title>
<meta name="author" content="RobinChia">

<meta name="description" content="It so life">


<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta property="og:site_name" content="It so life"/>

<!--[if IE]><style>.testIE.IE{display:inline;}</style><![endif]-->
<!--[if lte IE 7]><link rel="stylesheet" href="/css/ie7.css" type="text/css"><![endif]-->
<!--[if (lt IE 9)&(gt IE 7)]><style>.testIE.IE8{display:inline;}</style><![endif]-->
<!--[if gt IE 8]><style>.testIE.IE9{display:inline;}</style><![endif]-->

<link href="/favicon.png" rel="icon">
<link rel="alternate" href="/atom.xml" title="It so life Feed" type="application/atom+xml">

<link rel="stylesheet" href="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/font-awesome/4.0.3/css/font-awesome.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/prettify/r298/prettify.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" type="text/css">
<link rel="stylesheet" href="/css/style.css" type="text/css">
<!--[if lt IE 9]>
   <style>article,aside,dialog,footer,header,section,footer,nav,figure,menu{display:block}</style>
   <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
   <script src="http://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
<link href="http://cdn.staticfile.org/respond.js/1.4.2/respond-proxy.html" id="respond-proxy" rel="respond-proxy" />
<link href="/js/respond.proxy.gif" id="respond-redirect" rel="respond-redirect" />
<script src="/js/respond.proxy.js"></script>
   <script src="http://cdn.bootcss.com/selectivizr/1.0.2/selectivizr-min.js"></script>
<![endif]-->
<script type="text/javascript">
function loadjs(c,d){var a=document.createElement("script");a.async=!0;a.type="text/javascript";a.src=c;a.charset=d||"gbk";(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(a)};
var _protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
var _js2load = [];
</script>

</head>
<body>
      <header id="header" class="container"><nav id="main-nav" class="navbar navbar-default navbar-fixed-top " role="navigation">
  <div class="container">
    <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/">It so life</a>
    </div>
    <div  class="collapse navbar-collapse">
      <ul  class="nav navbar-nav">
  
        <li><a href="/" title="Home">Home</a></li>      
        <li><a href="/about/" title="About">About</a></li>      
        <li><a href="/archives/" title="Archives">Archives</a></li>      
      <li class='dropdown'>
        <a class='dropdown-toggle' data-toggle='dropdown' href='#'>website<b class='caret'></b></a>
        <ul class='dropdown-menu pure-menu-selected'>
    
          <li><a href="//groups.google.com/forum/#!forum/pongba" title="TopLanguage">TopLanguage</a></li>    
          <li><a href="//itpub.net/" title="ITPub">ITPub</a></li>    
          <li><a href="//blog.jobbole.com/" title="Bole">Bole</a></li>    
          <li><a href="//nosql-database.org/" title="nosql">nosql</a></li>    
          <li><a href="//gitimmersion.googol.im/" title="Git">Git</a></li>    
        </ul>
      </li>
    
      </ul>
      <ul class="nav navbar-nav navbar-right">
      
        <li><a href="/atom.xml">RSS</a></li>
      
      
        <li><a href="https://twitter.com/robinchia">twitter</a></li>
      
      
      
      
        <li><a href="https://github.com/robinchia">github</a></li>
      
      </ul>
    </div>
  </div>
</nav>
<div class="clearfix"></div>
</header>
  <div id='content' class="container">
     <div class="page-header-wrapper">
      <!--[if lt IE 9]><div class="alert alert-warning alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>提示:</strong>您的浏览器版本太低了,建议升级到 <strong><a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" title="IE9">IE9</a></strong> 以上,本站使用<a href="https://www.google.com/intl/zh-CN/chrome/">Chrome浏览器</a>可以获得最好的显示效果.</div><![endif]-->
      <div class="page-header"><h1 align="center"><big>It so life</big> </h1>
        <h5 align="center"><big>love as life</big></h5>
      </div>
     </div>
     <div class="row">
       <div id="main-col" class="alignleft col-sx-12 col-sm-8 col-md-9 col-lg-9">
      <section id='header_widget'></section>
          <div id="wrapper"><article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JavaJ2EE-java-com-wmi-监控--使用J-Interop在Java中调用WMI/">使用 J</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:41.000Z"> <a href="/2014/02/02/2014-02-02-JavaJ2EE-java-com-wmi-监控--使用J-Interop在Java中调用WMI/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="-j-interop-java-wmi">使用 J-Interop 在 Java 中调用WMI</h1>
<p><a href="http://simpleframework.net/space.html" target="_blank">我的空间</a> <img src="" alt="">|<a href="http://simpleframework.net/invite.html" target="_blank">邀请</a> |<a href="">登录</a>|<a href="http://simpleframework.net/regist.html" target="_blank">注册</a> <a href="http://simpleframework.net/" target="_blank"> </a>  简单就是最好的，java web 开发，simple 让你化繁为简 !</p>
<p><a href="http://simpleframework.net/index.html" target="_blank">首页</a><a href=""></a><a href="http://simpleframework.net/news.html">新闻资讯</a><a href=""></a><a href="http://simpleframework.net/blog.html">博客</a><a href=""></a><a href="http://simpleframework.net/bbs.html">论坛</a><a href=""></a><a href="http://simpleframework.net/market.html">Simple市场</a><a href=""></a><a href="http://simpleframework.net/doc/d2.html">全面介绍</a><a href=""></a><a href="http://demo.simpleframework.net/simple3">simple3演示</a><a href=""></a><a href="http://simple4.simpleframework.net/simple4">simple4演示</a><a href=""></a><a href="http://simpleframework.net/home.html">My Portal</a></p>
<p><img src="" alt=""><a href="http://simpleframework.net/news/v/27953.html" target="_blank">SimpleFramework开发者必读</a></p>
<p><a href="http://simpleframework.net/space/176.html" target="_blank"><img src="" alt=""></a></p>
<p><a href="http://simpleframework.net/blog/176.html" target="_blank">赵老师的博客</a></p>
<ul>
<li><a href="http://simpleframework.net/blog.html" target="_blank">全部</a></li>
<li><a href="http://simpleframework.net/blog.html?t=recommended" target="_blank">推荐</a></li>
<li><a href="http://simpleframework.net/$resource/default/login/jsp/location.jsp" target="_blank">关注</a></li>
<li><a href="http://simpleframework.net/$resource/default/login/jsp/location.jsp" target="_blank">我的博客</a></li>
</ul>
<p><a href="">关注</a> (<a href="">1</a>)</p>
<p><a href="http://simpleframework.net/blog.html" target="_blank">博客</a>»<a href="http://simpleframework.net/blog/176.html" target="_blank">赵老师</a>»显示全文</p>
<p>使用 J-Interop 在 Java 中调用WMI
5评/3355阅</p>
<p>发表于: 2011-06-16 07:12</p>
<p><strong>有关**</strong>WMI<strong>**的小知识</strong></p>
<p><a href="http://msdn.microsoft.com/en-us/library/aa394582(VS.85" target="_blank"><strong>Windows**</strong>管理规范（<strong><strong>WMI</strong></strong>）**</a>.aspx)是微软对来自<a href="http://en.wikipedia.org/wiki/Distributed_Management_Task_Force" title="Distributed Management Task Force" target="_blank">分布式管理任务组</a>（<strong>DMTF</strong>）的<a href="http://en.wikipedia.org/wiki/Web-Based_Enterprise_Management" title="Web-Based Enterprise Management" target="_blank">基于Web的企业管理</a>（WBEM）和<a href="http://en.wikipedia.org/wiki/Common_Information_Model_(computing" target="_blank">通用信息模型</a> &quot;Common Information Model (computing)&quot;)（CIM）标准的实现。WMI用于访问Windows系统、应用、网络、设备等组件，并管理它们。连接到一台机器通过<strong>DCOM</strong>进行管理。因此，有关<strong>DCOM</strong>的小知识将有助于本文的理解。你可以到MSDN了解有关WMI的更多细节。</p>
<h3 id="-j-interop-"><strong>J-Interop</strong></h3>
<p>市场上有一些在使用 JAVA 调用 WMI 的好库，包括 <a href="http://www.j-interop.org/index.html" target="_blank">J-Interop</a>、<a href="http://sourceforge.net/projects/jacob-project/" target="_blank">JACOB-Project</a> 和 <a href="http://j-integra.intrinsyc.com/products/com/" target="_blank">J-Integra</a>。其中，我更喜欢J-Interop，因为它是完全免费和开源的API。它提供了没有任何依赖的纯DCOM桥，完全用Java编写的没有任何JNI代码。</p>
<h3 id="-wmi-windows-"><strong>使用**</strong>WMI<strong><strong>管理</strong></strong>Windows<strong>**服务</strong></h3>
<p>现在，来看一个使用JAVA调用WMI的例子。这个例子利用J-Interop的API使用Win32_Service类解释WMI操作，将启动和停止在这个例子中的窗口服务。</p>
<h3 id="-1-wbem-"><strong>步骤**</strong>1<strong><strong>：连接到</strong></strong>WBEM<strong>**服务</strong></h3>
<p>下面的代码示例显示了使用J-Interop如何初始化DCOM会话，并连接到远程DCOM服务使。它使用SWbemLocator对象连接到<strong>SWbemServices</strong>，<strong>SWbemServices</strong>对象提供对本地或远程计算机WMI的访问，它调用“ConnectServer”方法连接到<strong>SWbemServices**</strong>。在本例中，<em>提供管理员级别的用户连接到远程计算机。**</em>
JISessiondcomSession=JISession.createSession(domainName,userName,password); dcomSession.useSessionSecurity(false);   JIComServercomServer=newJIComServer(valueOf(&quot;WbemScripting.SWbemLocator&quot;),hostIP,dcomSession); IJIDispatchwbemLocator=(IJIDispatch)narrowObject(comServer.createInstance().queryInterface(IID)); //parameterstoconnecttoWbemScripting.SWbemLocator Object[]params=newObject[]{                           newJIString(hostIP),//strServer                           newJIString(win32_namespace),//strNamespace                           JIVariant.OPTIONAL_PARAM(),//strUser                           JIVariant.OPTIONAL_PARAM(),//strPassword                           JIVariant.OPTIONAL_PARAM(),//strLocale                           JIVariant.OPTIONAL_PARAM(),//strAuthority                           newInteger(0),//iSecurityFlags                           JIVariant.OPTIONAL_PARAM()//objwbemNamedValueSet                           };   JIVariantresults[]=wbemLocator.callMethodA(&quot;ConnectServer&quot;,params); IJIDispatchwbemServices=(IJIDispatch)narrowObject(results[0].getObjectAsComObject());</p>
<p>（<strong>domainName</strong>=远程计算机域名，<strong>hostIP</strong>=远程计算机IP地址,<strong>用户名</strong>=管理员级别的用户，<strong>密码</strong>=密码）</p>
<h3 id="-2-win32_service-"><strong>第**</strong>2<strong><strong>步：获取</strong></strong>Win32_Service<strong>**实例</strong></h3>
<p>一旦你获得对<strong>SWbemServices</strong>对象的引用，就可以调用这个类的任何方法。其中<strong>WbemServices.InstancesOf**</strong>方法获得任何<strong><strong>Win32</strong></strong>类的实例。**</p>
<p>也可以使用WMI查询语言(WQL)达到同样的目的，如下所示：
finalintRETURN_IMMEDIATE=0x10; finalintFORWARD_ONLY=0x20; Object[]params=newObject[]{ newJIString(&quot;SELECT/*FROMWin32_Service&quot;), JIVariant.OPTIONAL_PARAM(), newJIVariant(newInteger(RETURN_IMMEDIATE+FORWARD_ONLY)) }; JIVariant[]servicesSet=wbemServices.callMethodA(&quot;ExecQuery&quot;,params); IJIDispatchwbemObjectSet=(IJIDispatch)narrowObject(servicesSet[0].getObjectAsComObject());</p>
<h3 id="-"><strong>第三步：执行方法</strong></h3>
<p>现在，已得到<strong>Win32_Service</strong>类的实例，可采用下述代码来调用同一类的方法，因为，它返回多个服务实例，要列举它们以便获取IJIDispatcher服务。
JIVariant newEnumvariant = wbemObjectSet.get(&quot;_NewEnum&quot;); IJIComObject enumComObject = newEnumvariant.getObjectAsComObject(); IJIEnumVariant enumVariant = (IJIEnumVariant) narrowObject(enumComObject.queryInterface(IJIEnumVariant.IID));   Object[] elements = enumVariant.next(1); JIArray aJIArray = (JIArray) elements[0];   JIVariant[] array = (JIVariant[]) aJIArray.getArrayInstance(); for (JIVariant variant : array) {     IJIDispatch wbemObjectDispatch = (IJIDispatch) narrowObject(variant.getObjectAsComObject());       JIVariant returnStatus = wbemObjectDispatch.callMethodA(&quot;StopService&quot;);       System.out.println(returnStatus.getObjectAsInt()); }</p>
<p>现在，下面的代码显示了一个使用WMI启动和停止Windows服务的完整Java类。</p>
<p>packagecom.wmi.windows;   importstaticorg.jinterop.dcom.core.JIProgId.valueOf; importstaticorg.jinterop.dcom.impls.JIObjectFactory.narrowObject; importstaticorg.jinterop.dcom.impls.automation.IJIDispatch.IID; importjava.util.logging.Level; importorg.jinterop.dcom.common.JIException; importorg.jinterop.dcom.common.JIRuntimeException; importorg.jinterop.dcom.common.JISystem; importorg.jinterop.dcom.core.IJIComObject; importorg.jinterop.dcom.core.JIArray; importorg.jinterop.dcom.core.JIComServer; importorg.jinterop.dcom.core.JISession; importorg.jinterop.dcom.core.JIString; importorg.jinterop.dcom.core.JIVariant; importorg.jinterop.dcom.impls.automation.IJIDispatch; importorg.jinterop.dcom.impls.automation.IJIEnumVariant;   publicclassServiceManager{            privatestaticStringdomainName=&quot;&quot;;          privatestaticStringuserName=&quot;administrator&quot;;          privatestaticStringpassword=&quot;&quot;;          privatestaticStringhostIP=&quot;127.0.0.1&quot;;          privatestaticfinalStringwin32<em>namespace=&quot;ROOT\CIMV2&quot;;            privatestaticfinalintSTOP_SERVICE=0;          privatestaticfinalintSTART_SERVICE=1;            privateJISessiondcomSession=null;          //<em>/</em>          /<em>          /</em>@paramargs          /<em>/          publicstaticvoidmain(String[]args){                  ServiceManagermanager=newServiceManager();                   manager.stopService(domainName,hostIP,userName,password,&quot;MySql&quot;);//stopsaservicenamedMySql          }          //</em>/<em>          /</em>Startsagivenserviceifitsstopped.          /<em>          /</em>@paramdomainName          /<em>@paramhostname          /</em>@paramusername          /<em>@parampassword          /</em>@paramserviceName          /<em>/    publicvoidstartService(StringdomainName,Stringhostname,Stringusername,Stringpassword,StringserviceName){                  execute(domainName,hostname,username,password,serviceName,START_SERVICE);          }          //</em>/<em>          /</em>Stopsagivenserviceifitsrunning.          /<em>          /</em>@paramdomainName          /<em>@paramhostname          /</em>@paramusername          /<em>@parampassword          /</em>@paramserviceName          /<em>/     publicvoidstopService(StringdomainName,Stringhostname,Stringusername,Stringpassword,StringserviceName){                  execute(domainName,hostname,username,password,serviceName,STOP_SERVICE);          }          //</em>/<em>          /</em>Starts/Stopsagivenserviceofremotemachineashostname.          /<em>          /</em>@paramdomainName          /<em>@paramhostname          /</em>@paramusername          /<em>@parampassword          /</em>@paramserviceName          /<em>@paramaction          /</em>/ publicvoidexecute(StringdomainName,Stringhostname,Stringusername,Stringpassword,StringserviceName,intaction){                    try{                           IJIDispatchwbemServices=createCOMServer();                             finalintRETURN_IMMEDIATE=0x10;                           finalintFORWARD_ONLY=0x20;                           Object[]params=newObject[]{                                             newJIString(&quot;SELECT/*FROMWin32_ServiceWHEREName=&#39;&quot;+serviceName+&quot;&#39;&quot;),                                             JIVariant.OPTIONAL_PARAM(),                                             newJIVariant(newInteger(RETURN_IMMEDIATE+FORWARD_ONLY))                           };                           JIVariant[]servicesSet=wbemServices.callMethodA(&quot;ExecQuery&quot;,params);                           IJIDispatchwbemObjectSet=(IJIDispatch)narrowObject(servicesSet[0].getObjectAsComObject());                             JIVariantnewEnumvariant=wbemObjectSet.get(&quot;_NewEnum&quot;);                           IJIComObjectenumComObject=newEnumvariant.getObjectAsComObject();                    IJIEnumVariantenumVariant=(IJIEnumVariant)narrowObject(enumComObject.queryInterface(IJIEnumVariant.IID));                             Object[]elements=enumVariant.next(1);                           JIArrayaJIArray=(JIArray)elements[0];                             JIVariant[]array=(JIVariant[])aJIArray.getArrayInstance();                           for(JIVariantvariant:array){                                    IJIDispatchwbemObjectDispatch=(IJIDispatch)narrowObject(variant.getObjectAsComObject());                                      //Printobjectastext.                                    JIVariant[]v=wbemObjectDispatch.callMethodA(&quot;GetObjectText</em>&quot;,newObject[]{1});                                    System.out.println(v[0].getObjectAsString().getString());                                      //StartorStoptheservice                                    StringmethodToInvoke=(action==START_SERVICE)?&quot;StartService&quot;:&quot;StopService&quot;;                                    JIVariantreturnStatus=wbemObjectDispatch.callMethodA(methodToInvoke);                           System.out.println(&quot;Returnstatus:&quot;+returnStatus.getObjectAsInt());//ifreturncode=0success.Seemsdnformoredetailsaboutthemethod.                           }                  }catch(Exceptione){                           e.printStackTrace();                  }finally{                           if(dcomSession!=null){                                    try{                                             JISession.destroySession(dcomSession);                                    }catch(Exceptionex){                                             ex.printStackTrace();                                    }                           }                  }          }          //<em>/</em>          /<em>InitializeDCOMsessionandconnecttoSWBEMserviceongivenhostmachine.          /</em>@return          /*/          privateIJIDispatchcreateCOMServer(){                  JIComServercomServer;                  try{                           JISystem.getLogger().setLevel(Level.WARNING);                           JISystem.setAutoRegisteration(true);                           dcomSession=JISession.createSession(domainName,userName,password);                           dcomSession.useSessionSecurity(false);                           comServer=newJIComServer(valueOf(&quot;WbemScripting.SWbemLocator&quot;),hostIP,dcomSession);                             IJIDispatchwbemLocator=(IJIDispatch)narrowObject(comServer.createInstance().queryInterface(IID));                           //parameterstoconnecttoWbemScripting.SWbemLocator                           Object[]params=newObject[]{                                             newJIString(hostIP),//strServer                                             newJIString(win32_namespace),//strNamespace                                             JIVariant.OPTIONAL_PARAM(),//strUser                                             JIVariant.OPTIONAL_PARAM(),//strPassword                                             JIVariant.OPTIONAL_PARAM(),//strLocale                                             JIVariant.OPTIONAL_PARAM(),//strAuthority                                             newInteger(0),//iSecurityFlags                                             JIVariant.OPTIONAL_PARAM()//objwbemNamedValueSet                           };                           JIVariantresults[]=wbemLocator.callMethodA(&quot;ConnectServer&quot;,params);                           IJIDispatchwbemServices=(IJIDispatch)narrowObject(results[0].getObjectAsComObject());                           returnwbemServices;                  }catch(JIExceptionjie){                           System.out.println(jie.getMessage());                           jie.printStackTrace();                  }catch(JIRuntimeExceptionjire){                           jire.printStackTrace();                  }catch(Exceptione){                           e.printStackTrace();                  }finally{                           if(dcomSession!=null){                                    try{                                             JISession.destroySession(dcomSession);                                    }catch(JIExceptione){                                             e.printStackTrace();                                    }                           }                  }                  returnnull;          } }</p>
<p>【原文】<a href="http://nikunjp.wordpress.com/" target="_blank"><a href="http://nikunjp.wordpress.com/">http://nikunjp.wordpress.com/</a></a>
评论 (共 5 条评论)</p>
<p>匿名 (219.142.23.106), 475天前</p>
<p>j-interop 远程收集WIN7 的eventlog日志怎么不行啊，求助赵老师
<a href="">回复</a>|<a href="">支持</a>|<a href="">反对</a>
匿名 (219.142.23.106), 475天前</p>
<p>是啊，win7怎么不行呢。。
<a href="">回复</a>|<a href="">支持</a>|<a href="">反对</a></p>
<p>匿名 (59.40.119.215), 497天前</p>
<p>xp的开始Remote Register 服务就可以了。 win7还在研究中
<a href="">回复</a>|<a href="">支持</a>|<a href="">反对</a>
匿名 (219.133.0.1), 501天前</p>
<p>win7平台为什么会用不了呢？ 我也测试过了，xp的机器可以成功运行。
有些xp的也不行，我觉得可能是有什么配置项没有配置而导致。
<a href="">回复</a>|<a href="">支持</a>|<a href="">反对</a></p>
<p>匿名 (111.4.219.247), 722天前</p>
<p>我测试报错：The system cannot find the file specified. win7平台。
<a href="">回复</a>|<a href="">支持</a>|<a href="">反对</a> (共5, 显示全部)/</p>
<p><a href="">表情</a> 发表评论</p>
<p><img src="" alt=""></p>
<p><a href="">看不清楚，再换一张</a> <a href="">高级模式</a></p>
<p>相关主题</p>
<p><a href="http://simpleframework.net/blog/v/32903.html" target="_blank">JAVA问题定位技术</a> 2/3333</p>
<p><a href="http://simpleframework.net/space/26397.html" target="_blank">sword</a>, 799天前</p>
<p><a href="http://simpleframework.net/blog/v/18467.html" target="_blank">Java序列化和克隆</a> 0/1568</p>
<p><a href="http://simpleframework.net/space/534.html" target="_blank">书生</a>, 870天前
<a href="http://simpleframework.net/blog/v/46888.html" target="_blank">Java EE6中的装饰器，高级用法</a> 0/1163</p>
<p><a href="http://simpleframework.net/space/176.html" target="_blank">赵老师</a>, 733天前</p>
<p><a href="http://simpleframework.net/blog/v/16596.html" target="_blank">通过 Java 编程处理 XML 服务定义</a> 1/1691</p>
<p><a href="http://simpleframework.net/space/534.html" target="_blank">书生</a>, 877天前
<a href="http://simpleframework.net/blog/v/34389.html" target="_blank">解析Java软件开发中的五种认识误区</a> 0/1178</p>
<p><a href="http://simpleframework.net/space/534.html" target="_blank">书生</a>, 792天前</p>
<p><a href="http://simpleframework.net/blog/v/23210.html" target="_blank">Java内省和反射机制三步曲之(2)反射</a> 0/1409</p>
<p><a href="http://simpleframework.net/space/534.html" target="_blank">书生</a>, 854天前</p>
<p>一周点击排行
<a href="http://simpleframework.net/guestbook.html" target="_blank">留言</a>|<a href="http://simpleframework.net/contact.html" target="_blank">联系我们</a>|<a href="http://simpleframework.net/copyright.html" target="_blank">版权声明</a>|<a href="http://simpleframework.net/about.html" target="_blank">关于</a></p>
<p>simpleframework.net Copyright ©2011 版权所有</p>
<p>Powered by SimpleFramework [ 0.156 s ]</p>
<p>*</p>
<ul>
<li>数据装载中...
*</li>
</ul>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li></span><span class="breadcrumb"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li><li><a href="/categories/Java&J2EE/java-com/">java-com</a></li><li><a href="/categories/Java&J2EE/java-com/wmi-监控/">wmi-监控</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Java&J2EE/" class="label label-primary">Java&J2EE</a><a href="/tags/java-com/" class="label label-success">java-com</a><a href="/tags/wmi-监控/" class="label label-info">wmi-监控</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:41"datetime="2014-03-07 09:54:41"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-java-com-wmi-监控--使用J-Interop在Java中调用WMI/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JavaJ2EE-java-com-wmi-监控--使用J-Interop在Java中调用WMI" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JavaJ2EE-SQL_Java--Java中，获得ResultSet的总行数与总列数/">Java中，获得ResultSet的总行数与总列数</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:41.000Z"> <a href="/2014/02/02/2014-02-02-JavaJ2EE-SQL_Java--Java中，获得ResultSet的总行数与总列数/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="java-resultset-">Java中，获得ResultSet的总行数与总列数</h1>
<h2 id="java-resultset-">Java中，获得ResultSet的总行数与总列数</h2>
<p>在Java中，获得ResultSet的总行数的方法有以下几种。</p>
<p><strong>第一种：利用ResultSet的getRow方法来获得ResultSet的总行数</strong></p>
<p>Statement stmt = con.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,ResultSet.CONCUR_UPDATABLE);
ResultSet rset = stmt.executeQuery(&quot;select /* from yourTableName&quot;);
rset.last();
int rowCount = rset.getRow(); //获得ResultSet的总行数</p>
<p><strong>第二种：利用循环ResultSet的元素来获得ResultSet的总行数</strong></p>
<p>ResultSet rset = stmt.executeQuery(&quot;select /* from yourTableName&quot;);
int rowCount = 0;
while(rset.next()) {
rowCount++;
}</p>
<p>rowCount就是ResultSet的总行数。</p>
<p><strong>第三种：利用sql语句中的count函数获得ResultSet的总行数</strong></p>
<p>ResultSet rset = stmt.executeQuery(&quot;select count(/*) totalCount from yourTableName&quot;);
int rowCount = 0;
if(rset.next()) {
rowCount=rset .getInt(&quot;totalCount &quot;);
}</p>
<p>rowCount就是ResultSet的总行数。</p>
<ul>
<li>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/*</li>
<li>Java中获得ResultSet的总列数是非常简单事情，因为Java中ResultSet提供了ResultSetMetaData工具类,ResultSetMetaData 是ResultSet的元数据的集合说明。</li>
</ul>
<p>java获得ResultSet总列数的代码如下：</p>
<p>Statement stmt = con.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,ResultSet.CONCUR_UPDATABLE);
ResultSet rset = stmt.executeQuery(&quot;select /* from yourtable&quot;);
ResultSetMetaData rsmd = rset.getMetaData() ;
int columnCount = rsmd.getColumnCount();</p>
<p>columnCount 就是ResultSet的总列数。</p>
<hr>
<p>例子：
Statement stmt = conn.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,  ResultSet.CONCUR_READ_ONLY);   ResultSet rs = stmt.executeQuery(sql);   rs.last();   int length = rs.getRow();</p>
<p>如上，length的值，就是行数了。如果在获取了行数后，还需要继续使用当前数据集rs，则需要rs.beforeFirst();一次，将游标回到初始位置。
ResultSet.TYPE_SCROLL_INSENSITIVE 结果集的游标可以上下移动，当数据库变化时，当前结果集不变。
ResultSet.CONCUR_READ_ONLY 不能用结果集更新数据库中的表。</p>
<p>此外，给出Statement创建时的其他说明：
通用格式为：Statement stmt=con.createStatement(int type，int concurrency);我们在访问数据库的时候，在读取返回结果的时候，可能要前后移动指针，比如我们先计算有多少条信息，这是我们就需要把指针移到最后来计算，然后再把指针移到最前面，逐条读取，有时我们只需要逐条读取就可以了。还有就是有只我们只需要读取数据，为了不破坏数据，我们可采用只读模式，有时我们需要望数据库里添加记录，这是我们就要采用可更新数据库的模式。
下面是所有参数的说明：
参数 int type
ResultSet.TYPE_FORWORD_ONLY 结果集的游标只能向下滚动。
ResultSet.TYPE_SCROLL_INSENSITIVE 结果集的游标可以上下移动，当数据库变化时，当前结果集不变。
ResultSet.TYPE_SCROLL_SENSITIVE 返回可滚动的结果集，当数据库变化时，当前结果集同步改变。</p>
<p>参数 int concurrency</p>
<p>ResultSet.CONCUR_READ_ONLY 不能用结果集更新数据库中的表。
ResultSet.CONCUR_UPDATETABLE 能用结果集更新数据库中的表。</p>
<p>此外，当我们使用ResultSet re=stmt.executeQuery(SQL语句）查询后，我们可以使用下列方法获得信息：</p>
<p>public boolean previous() 将游标向上移动，该方法返回boolean型数据，当移到结果集第一行之前时，返回false。
public void beforeFirst 将游标移动到结果集的初始位置，即在第一行之前。
public void afterLast() 将游标移到结果集最后一行之后。
public void first() 将游标移到结果集的第一行。
public void last() 将游标移到结果集的最后一行。
public boolean isAfterLast() 判断游标是否在最后一行之后。
public boolean isBeforeFirst() 判断游标是否在第一行之前。
public boolean ifFirst() 判断游标是否指向结果集的第一行。
public boolean isLast() 判断游标是否指向结果集的最后一行。
public int getRow() 得到当前游标所指向行的行号，行号从1开始，如果结果集没有行，返回0。
public boolean absolute(int row) 将游标移到参数row指定的行号。如果row取负值，就是倒数的行数，absolute(-1)表示移到最后一行，absolute(-2)表示移到倒数第2行。当移动到第一行前面或最后一行的后面时，该方法返回false。</p>
<p>ResultSetMetaData rsmd = this.rs.getMetaData();
this.columnCount = rsmd.getColumnCount();</p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li></span><span class="breadcrumb"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li><li><a href="/categories/Java&J2EE/SQL_Java/">SQL_Java</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Java&J2EE/" class="label label-primary">Java&J2EE</a><a href="/tags/SQL_Java/" class="label label-success">SQL_Java</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:41"datetime="2014-03-07 09:54:41"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-SQL_Java--Java中，获得ResultSet的总行数与总列数/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JavaJ2EE-SQL_Java--Java中，获得ResultSet的总行数与总列数" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JavaJ2EE-SQL_Java--IntroductiontoStructuredQueryLanguageZQL/">Introduction to Structured Query Language(ZQL)</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:41.000Z"> <a href="/2014/02/02/2014-02-02-JavaJ2EE-SQL_Java--IntroductiontoStructuredQueryLanguageZQL/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="introduction-to-structured-query-language-zql-">Introduction to Structured Query Language(ZQL)</h1>
<h1 id="introduction-to-structured-query-language">Introduction to Structured Query Language</h1>
<p><strong>Version 3.31</strong></p>
<p>This page is a tutorial of the Structured Query Language(also known as <strong>SQL</strong>) and is a pioneering effort on the World Wide Web, as this is the first comprehensive SQL tutorial available on the Internet. SQL allows users to access data in relational database management systems, such as Oracle, Sybase, Informix, Microsoft SQL Server, Access, and others, by allowing users to describe the data the user wishes to see. SQL also allows users to define the data in a database, and manipulate that data. This page will describe how to use SQL, and give examples. The SQL used in this document is &quot;ANSI&quot;, or standard SQL, and no SQL features of specific database management systems will be discussed until the &quot;Nonstandard SQL&quot; section. It is recommended that you print this page, so that you can easily refer back to previous examples.
<strong>Table of Contents</strong></p>
<p><a href="http://zql.sourceforge.net/sqltut.html#Basics%20of%20the%20SELECT%20Statement">Basics of the SELECT Statement
</a><a href="http://zql.sourceforge.net/sqltut.html#Conditional%20Selection">Conditional Selection
</a><a href="http://zql.sourceforge.net/sqltut.html#Relational%20Operators">Relational Operators
</a><a href="http://zql.sourceforge.net/sqltut.html#Compound%20Conditions">Compound Conditions
</a><a href="http://zql.sourceforge.net/sqltut.html#IN%20&amp;%20BETWEEN">IN &amp; BETWEEN
</a><a href="http://zql.sourceforge.net/sqltut.html#Using%20LIKE" target="_blank">Using LIKE</a></p>
<p><a href="http://zql.sourceforge.net/sqltut.html#Joins">Joins
</a><a href="http://zql.sourceforge.net/sqltut.html#Keys">Keys
</a><a href="http://zql.sourceforge.net/sqltut.html#Performing%20a%20Join">Performing a Join
</a><a href="http://zql.sourceforge.net/sqltut.html#Eliminating%20Duplicates">Eliminating Duplicates
</a><a href="http://zql.sourceforge.net/sqltut.html#Aliases%20&amp;%20In/Subqueries" target="_blank">Aliases &amp; In/Subqueries</a></p>
<p><a href="http://zql.sourceforge.net/sqltut.html#Aggregate%20Functions" target="_blank">Aggregate Functions</a>
<a href="http://zql.sourceforge.net/sqltut.html#Views" target="_blank">Views</a>
<a href="http://zql.sourceforge.net/sqltut.html#Creating%20New%20Tables" target="_blank">Creating New Tables</a>
<a href="http://zql.sourceforge.net/sqltut.html#Altering%20Tables" target="_blank">Altering Tables</a>
<a href="http://zql.sourceforge.net/sqltut.html#Adding%20Data" target="_blank">Adding Data</a>
<a href="http://zql.sourceforge.net/sqltut.html#Deleting%20Data" target="_blank">Deleting Data</a>
<a href="http://zql.sourceforge.net/sqltut.html#Updating%20Data" target="_blank">Updating Data</a></p>
<p><a href="http://zql.sourceforge.net/sqltut.html#Indexes" target="_blank">Indexes</a>
<a href="http://zql.sourceforge.net/sqltut.html#GROUP%20BY%20&amp;%20HAVING" target="_blank">GROUP BY &amp; HAVING</a>
<a href="http://zql.sourceforge.net/sqltut.html#More%20Subqueries">More Subqueries
</a><a href="http://zql.sourceforge.net/sqltut.html#EXISTS%20&amp;%20ALL" target="_blank">EXISTS &amp; ALL</a>
<a href="http://zql.sourceforge.net/sqltut.html#UNION%20&amp;%20Outer%20Joins" target="_blank">UNION &amp; Outer Joins</a>
<a href="http://zql.sourceforge.net/sqltut.html#Embedded%20SQL" target="_blank">Embedded SQL</a>
<a href="http://zql.sourceforge.net/sqltut.html#Common%20SQL%20Questions" target="_blank">Common SQL Questions</a>
<a href="http://zql.sourceforge.net/sqltut.html#Nonstandard%20SQL" target="_blank">Nonstandard SQL</a>
<a href="http://zql.sourceforge.net/sqltut.html#Syntax%20Summary" target="_blank">Syntax Summary</a>
<a href="http://zql.sourceforge.net/sqltut.html#Important%20Links" target="_blank">Important Links</a></p>
<p><a href=""></a><strong>Basics of the SELECT Statement</strong></p>
<p>In a relational database, data is stored in tables. An example table would relate Social Security Number, Name, and Address:
<strong>EmployeeAddressTable</strong> <strong>SSN</strong> <strong>FirstName</strong> <strong>LastName</strong> <strong>Address</strong> <strong>City</strong> <strong>State</strong> 512687458 Joe Smith 83 First Street Howard Ohio 758420012 Mary Scott 842 Vine Ave. Losantiville Ohio 102254896 Sam Jones 33 Elm St. Paris New York 876512563 Sarah Ackerman 440 U.S. 110 Upton Michigan</p>
<p>Now, let&#39;s say you want to see the address of each employee. Use the SELECT statement, like so:</p>
<p>SELECT FirstName, LastName, Address, City, State
FROM EmployeeAddressTable;</p>
<p>The following is the results of your query of the database:
<strong>First Name</strong> <strong>Last Name</strong> <strong>Address</strong> <strong>City</strong> <strong>State</strong> Joe Smith 83 First Street Howard Ohio Mary Scott 842 Vine Ave. Losantiville Ohio Sam Jones 33 Elm St. Paris New York Sarah Ackerman 440 U.S. 110 Upton Michigan</p>
<p>To explain what you just did, you asked for the all of data in the EmployeeAddressTable, and specifically, you asked for the columns called FirstName, LastName, Address, City, and State. Note that column names and table names do not have spaces...they must be typed as one word; and that the statement ends with a semicolon (;). The general form for a SELECT statement, retrieving all of the rows in the table is:</p>
<p>SELECT ColumnName, ColumnName, ...
FROM TableName;</p>
<p>To get all columns of a table without typing all column names, use:</p>
<p>SELECT /* FROM TableName;</p>
<p>Each database management system (DBMS) and database software has different methods for logging in to the database and entering SQL commands; see the local computer &quot;guru&quot; to help you get onto the system, so that you can use SQL.
<a href=""></a><strong>Conditional Selection</strong></p>
<p>To further discuss the SELECT statement, let&#39;s look at a new example table (for hypothetical purposes only):
<strong>EmployeeStatisticsTable</strong> <strong>EmployeeIDNo</strong> <strong>Salary</strong> <strong>Benefits</strong> <strong>Position</strong> 010 75000 15000 Manager 105 65000 15000 Manager 152 60000 15000 Manager 215 60000 12500 Manager 244 50000 12000 Staff 300 45000 10000 Staff 335 40000 10000 Staff 400 32000 7500 Entry-Level 441 28000 7500 Entry-Level</p>
<h3 id="-relational-operators"><a href=""></a>Relational Operators</h3>
<p>There are six Relational Operators in SQL, and after introducing them, we&#39;ll see how they&#39;re used:
= Equal &lt;&gt; or != (see manual) Not Equal &lt; Less Than &gt; Greater Than &lt;= Less Than or Equal To &gt;= Greater Than or Equal To</p>
<p>The WHEREclause is used to specify that only certain rows of the table are displayed, based on the criteria described in that WHERE clause. It is most easily understood by looking at a couple of examples.</p>
<p>If you wanted to see the EMPLOYEEIDNO&#39;s of those making at or over $50,000, use the following:</p>
<p>SELECT EMPLOYEEIDNO
FROM EMPLOYEESTATISTICSTABLE
WHERE SALARY &gt;= 50000;</p>
<p>Notice that the &gt;= (greater than or equal to) sign is used, as we wanted to see those who made greater than $50,000, or equal to $50,000, listed together. This displays:</p>
<h2 id="employeeidno">EMPLOYEEIDNO</h2>
<p>010
105
152
215
244</p>
<p>The WHERE description, SALARY &gt;= 50000, is known as a condition. The same can be done for text columns:</p>
<p>SELECT EMPLOYEEIDNO
FROM EMPLOYEESTATISTICSTABLE
WHERE POSITION = &#39;Manager&#39;;</p>
<p>This displays the ID Numbers of all Managers. Generally, with text columns, stick to equal to or not equal to, and make sure that any text that appears in the statement is surrounded by single quotes (&#39;).</p>
<p><a href=""></a>More Complex Conditions: Compound Conditions</p>
<p>The AND operator joins two or more conditions, and displays a row only if that row&#39;s data satisfies <strong>ALL</strong> conditions listed (i.e. all conditions hold true). For example, to display all staff making over $40,000, use:</p>
<p>SELECT EMPLOYEEIDNO
FROM EMPLOYEESTATISTICSTABLE
WHERE SALARY &gt; 40000 AND POSITION = &#39;Staff&#39;;</p>
<p>The OR operator joins two or more conditions, but returns a row if <strong>ANY</strong> of the conditions listed hold true. To see all those who make less than $40,000 or have less than $10,000 in benefits, listed together, use the following query:</p>
<p>SELECT EMPLOYEEIDNO
FROM EMPLOYEESTATISTICSTABLE
WHERE SALARY &lt; 40000 OR BENEFITS &lt; 10000;</p>
<p>AND &amp; OR can be combined, for example:</p>
<p>SELECT EMPLOYEEIDNO
FROM EMPLOYEESTATISTICSTABLE
WHERE POSITION = &#39;Manager&#39; AND SALARY &gt; 60000 OR BENEFITS &gt; 12000;</p>
<p>First, SQL finds the rows where the salary is greater than $60,000 and the position column is equal to Manager, then taking this new list of rows, SQL then sees if any of these rows satisfies the previous AND condition or the condition that the Benefits column is greater then $12,000. Subsequently, SQL only displays this second new list of rows, keeping in mind that anyone with Benefits over $12,000 will be included as the OR operator includes a row if either resulting condition is True. Also note that the AND operation is done first.</p>
<p>To generalize this process, SQL performs the AND operation(s) to determine the rows where the AND operation(s) hold true (remember: all of the conditions are true), then these results are used to compare with the OR conditions, and only display those remaining rows where the conditions joined by the OR operator hold true.</p>
<p>To perform OR&#39;s before AND&#39;s, like if you wanted to see a list of employees making a large salary (&gt;$50,000) or have a large benefit package (&gt;$10,000), and that happen to be a manager, use parentheses:</p>
<p>SELECT EMPLOYEEIDNO
FROM EMPLOYEESTATISTICSTABLE
WHERE POSITION = &#39;Manager&#39; AND (SALARY &gt; 50000 OR BENEFIT &gt; 10000);</p>
<p><a href=""></a><strong>IN &amp; BETWEEN</strong></p>
<p>An easier method of using compound conditions uses IN or BETWEEN. For example, if you wanted to list all managers and staff:</p>
<p>SELECT EMPLOYEEIDNO
FROM EMPLOYEESTATISTICSTABLE
WHERE POSITION IN (&#39;Manager&#39;, &#39;Staff&#39;);</p>
<p>or to list those making greater than or equal to $30,000, but less than or equal to $50,000, use:</p>
<p>SELECT EMPLOYEEIDNO
FROM EMPLOYEESTATISTICSTABLE
WHERE SALARY BETWEEN 30000 AND 50000;</p>
<p>To list everyone not in this range, try:</p>
<p>SELECT EMPLOYEEIDNO
FROM EMPLOYEESTATISTICSTABLE
WHERE SALARY NOT BETWEEN 30000 AND 50000;</p>
<p>Similarly, NOT IN lists all rows excluded from the IN list.</p>
<p><a href=""></a><strong>UsingLIKE</strong></p>
<p>Look at the EmployeeStatisticsTable, and say you wanted to see all people whose last names started with &quot;L&quot;; try:</p>
<p>SELECT EMPLOYEEIDNO
FROM EMPLOYEEADDRESSTABLE
WHERE LASTNAME LIKE &#39;L%&#39;;</p>
<p>The percent sign (%) is used to represent any possible character (number, letter, or punctuation) or set of characters that might appear after the &quot;L&quot;. To find those people with LastName&#39;s ending in &quot;L&quot;, use &#39;%L&#39;, or if you wanted the &quot;L&quot; in the middle of the word, try &#39;%L%&#39;. The &#39;%&#39; can be used for any characters, in that relative position to the given characters. NOT LIKE displays rows not fitting the given description. Other possiblities of using LIKE, or any of these discussed conditionals, are available, though it depends on what DBMS you are using; as usual, consult a manual or your system manager or administrator for the available features on your system, or just to make sure that what you are trying to do is available and allowed. This disclaimer holds for the features of SQL that will be discussed below. This section is just to give you an idea of the possibilities of queries that can be written in SQL.
<a href=""></a><strong>Joins</strong></p>
<p>In this section, we will only discuss inner joins, and equijoins, as in general, they are the most useful. For more information, try the SQL links at the bottom of the page.</p>
<p>Good database design suggests that each table lists data only about a single entity, and detailed information can be obtained in a relational database, by using additional tables, and by using a join.</p>
<p>First, take a look at these example tables:
<strong>AntiqueOwners</strong>
 <strong>OwnerID</strong> <strong>OwnerLastName</strong> <strong>OwnerFirstName</strong> 01 Jones Bill 02 Smith Bob 15 Lawson Patricia 21 Akins Jane 50 Fowler Sam</p>
<p><strong>Orders</strong>
 <strong>OwnerID</strong> <strong>ItemDesired</strong> 02 Table 02 Desk 21 Chair 15 Mirror</p>
<p><strong>Antiques</strong>
 <strong>SellerID</strong> <strong>BuyerID</strong> <strong>Item</strong> 01 50 Bed 02 15 Table 15 02 Chair 21 50 Mirror 50 01 Desk 01 21 Cabinet 02 21 Coffee Table 15 50 Chair 01 15 Jewelry Box 02 21 Pottery 21 02 Bookcase 50 01 Plant Stand</p>
<p><a href=""></a><strong>Keys</strong></p>
<p>First, let&#39;s discuss the concept of keys. A primary key is a column or set of columns that uniquely identifies the rest of the data in any given row. For example, in the AntiqueOwners table, the OwnerID column uniquely identifies that row. This means two things: no two rows can have the same OwnerID, and, even if two owners have the same first and last names, the OwnerID column ensures that the two owners will not be confused with each other, because the unique OwnerID column will be used throughout the database to track the owners, rather than the names.</p>
<p>Aforeign key is a column in a table where that column is a primary key of another table, which means that any data in a foreign key column must have corresponding data in the other table where that column is the primary key. In DBMS-speak, this correspondence is known as referential integrity. For example, in the Antiques table, both the BuyerID and SellerID are foreign keys to the primary key of the AntiqueOwners table (OwnerID; for purposes of argument, one has to be an Antique Owner before one can buy or sell any items), as, in both tables, the ID rows are used to identify the owners or buyers and sellers, and that the OwnerID is the primary key of the AntiqueOwners table. In other words, all of this &quot;ID&quot; data is used to refer to the owners, buyers, or sellers of antiques, themselves, without having to use the actual names.</p>
<p><a href=""></a><strong>Performing a Join</strong></p>
<p>The purpose of these keys is so that data can be related across tables, without having to repeat data in every table--this is the power of relational databases. For example, you can find the names of those who bought a chair without having to list the full name of the buyer in the Antiques table...you can get the name by relating those who bought a chair with the names in the AntiqueOwners table through the use of the OwnerID, which relates the data in the two tables. To find the names of those who bought a chair, use the following query:</p>
<p>SELECT OWNERLASTNAME, OWNERFIRSTNAME
FROM ANTIQUEOWNERS, ANTIQUES
WHERE BUYERID = OWNERID AND ITEM = &#39;Chair&#39;;</p>
<p>Note the following about this query...notice that both tables involved in the relation are listed in the FROM clause of the statement. In the WHERE clause, first notice that the ITEM = &#39;Chair&#39; part restricts the listing to those who have bought (and in this example, thereby owns) a chair. Secondly, notice how the ID columns are related from one table to the next by use of the BUYERID = OWNERID clause. Only where ID&#39;s match across tables and the item purchased is a chair (because of the AND), will the names from the AntiqueOwners table be listed. Because the joining condition used an equal sign, this join is called an equijoin. The result of this query is two names: Smith, Bob &amp; Fowler, Sam.</p>
<p>Dot notation refers to prefixing the table names to column names, to avoid ambiguity, as such:</p>
<p>SELECT ANTIQUEOWNERS.OWNERLASTNAME, ANTIQUEOWNERS.OWNERFIRSTNAME
FROM ANTIQUEOWNERS, ANTIQUES
WHERE ANTIQUES.BUYERID = ANTIQUEOWNERS.OWNERID AND ANTIQUES.ITEM = &#39;Chair&#39;;</p>
<p>As the column names are different in each table, however, this wasn&#39;t necessary.</p>
<p><a href=""></a><strong>DISTINCT and Eliminating Duplicates</strong></p>
<p>Let&#39;s say that you want to list the ID and names of <strong>only</strong> those people who have sold an antique. Obviously, you want a list where each seller is only listed once--you don&#39;t want to know how many antiques a person sold, just the fact that this person sold one (for counts, see the Aggregate Function section below). This means that you will need to tell SQL to eliminate duplicate sales rows, and just list each person only once. To do this, use the DISTINCT keyword.</p>
<p>First, we will need an equijoin to the AntiqueOwners table to get the detail data of the person&#39;s LastName and FirstName. However, keep in mind that since the SellerID column in the Antiques table is a foreign key to the AntiqueOwners table, a seller will only be listed if there is a row in the AntiqueOwners table listing the ID and names. We also want to eliminate multiple occurences of the SellerID in our listing, so we use DISTINCT<strong>on the column where the repeats may occur.</strong></p>
<p>To throw in one more twist, we will also want the list alphabetized by LastName, then by FirstName (on a LastName tie), then by OwnerID (on a LastName and FirstName tie). Thus, we will use the ORDER BY clause:</p>
<p>SELECT DISTINCT SELLERID, OWNERLASTNAME, OWNERFIRSTNAME
FROM ANTIQUES, ANTIQUEOWNERS
WHERE SELLERID = OWNERID
ORDER BY OWNERLASTNAME, OWNERFIRSTNAME, OWNERID;</p>
<p>In this example, since everyone has sold an item, we will get a listing of all of the owners, in alphabetical order by last name. For future reference (and in case anyone asks), this type of join is considered to be in the category of inner joins.</p>
<p><a href=""></a><strong>Aliases &amp; In/Subqueries</strong></p>
<p>In this section, we will talk about Aliases, In and the use of subqueries, and how these can be used in a 3-table example. First, look at this query which prints the last name of those owners who have placed an order and what the order is, only listing those orders which can be filled (that is, there is a buyer who owns that ordered item):</p>
<p>SELECT OWN.OWNERLASTNAME Last Name, ORD.ITEMDESIRED Item Ordered
FROM ORDERS ORD, ANTIQUEOWNERS OWN
WHERE ORD.OWNERID = OWN.OWNERID
AND ORD.ITEMDESIRED IN</p>
<p>(SELECT ITEM
FROM ANTIQUES);</p>
<p>This gives:</p>
<p>Last Name Item Ordered</p>
<hr>
<p>Smith     Table
Smith     Desk
Akins     Chair
Lawson    Mirror</p>
<p>There are several things to note about this query:</p>
<ol>
<li>First, the &quot;Last Name&quot; and &quot;Item Ordered&quot; in the Select lines gives the headers on the report.</li>
<li>The OWN &amp; ORD are aliases; these are new names for the two tables listed in the FROM clause that are used as prefixes for all dot notations of column names in the query (see above). This eliminates ambiguity, especially in the equijoin WHERE clause where both tables have the column named OwnerID, and the dot notation tells SQL that we are talking about two different OwnerID&#39;s from the two different tables.</li>
<li>Note that the Orders table is listed first in the FROM clause; this makes sure listing is done off of that table, and the AntiqueOwners table is only used for the detail information (Last Name).</li>
<li>Most importantly, the AND in the WHERE clause forces the In Subquery to be invoked (&quot;= ANY&quot; or &quot;= SOME&quot; are two equivalent uses of IN). What this does is, the subquery is performed, returning all of the Items owned from the Antiques table, as there is no WHERE clause. Then, for a row from the Orders table to be listed, the ItemDesired must be in that returned list of Items owned from the Antiques table, thus listing an item only if the order can be filled from another owner. You can think of it this way: the subquery returns a set of Items from which each ItemDesired in the Orders table is compared; the In condition is true only if the ItemDesired is in that returned set from the Antiques table.</li>
<li>Also notice, that in this case, that there happened to be an antique available for each one desired...obviously, that won&#39;t always be the case. In addition, notice that when the IN, &quot;= ANY&quot;, or &quot;= SOME&quot; is used, that these keywords refer to any possible row matches, not column matches...that is, you cannot put multiple columns in the subquery Select clause, in an attempt to match the column in the outer Where clause to one of multiple possible column values in the subquery; only one column can be listed in the subquery, and the possible match comes from multiple row values in that one column, not vice-versa.</li>
</ol>
<p>Whew! That&#39;s enough on the topic of complex SELECT queries for now. Now on to other SQL statements.
<strong>Miscellaneous SQL Statements</strong></p>
<p><a href=""></a><strong>Aggregate Functions</strong></p>
<p>I will discuss five important aggregate functions: SUM, AVG, MAX, MIN, and COUNT. They are called aggregate functions because they summarize the results of a query, rather than listing all of the rows.</p>
<ul>
<li>SUM () gives the total of all the rows, satisfying any conditions, of the given column, where the given column is numeric.</li>
<li>AVG () gives the average of the given column.</li>
<li>MAX () gives the largest figure in the given column.</li>
<li>MIN () gives the smallest figure in the given column.</li>
<li>COUNT(/*) gives the number of rows satisfying the conditions.</li>
</ul>
<p>Looking at the tables at the top of the document, let&#39;s look at three examples:</p>
<p>SELECT SUM(SALARY), AVG(SALARY)
FROM EMPLOYEESTATISTICSTABLE;</p>
<p>This query shows the total of all salaries in the table, and the average salary of all of the entries in the table.</p>
<p>SELECT MIN(BENEFITS)
FROM EMPLOYEESTATISTICSTABLE
WHERE POSITION = &#39;Manager&#39;;</p>
<p>This query gives the smallest figure of the Benefits column, of the employees who are Managers, which is 12500.</p>
<p>SELECT COUNT(/*)
FROM EMPLOYEESTATISTICSTABLE
WHERE POSITION = &#39;Staff&#39;;</p>
<p>This query tells you how many employees have Staff status (3).</p>
<p><a href=""></a><strong>Views</strong></p>
<p>In SQL, you might (check your DBA) have access to create views for yourself. What a view does is to allow you to assign the results of a query to a new, personal table, that you can use in other queries, where this new table is given the view name in your FROM clause. When you access a view, the query that is defined in your view creation statement is performed (generally), and the results of that query look just like another table in the query that you wrote invoking the view. For example, to create a view:</p>
<p>CREATE VIEW ANTVIEW AS SELECT ITEMDESIRED FROM ORDERS;</p>
<p>Now, write a query using this view as a table, where the table is just a listing of all Items Desired from the Orders table:</p>
<p>SELECT SELLERID
FROM ANTIQUES, ANTVIEW
WHERE ITEMDESIRED = ITEM;</p>
<p>This query shows all SellerID&#39;s from the Antiques table where the Item in that table happens to appear in the Antview view, which is just all of the Items Desired in the Orders table. The listing is generated by going through the Antique Items one-by-one until there&#39;s a match with the Antview view. Views can be used to restrict database access, as well as, in this case, simplify a complex query.</p>
<p><a href=""></a><strong>Creating New Tables</strong></p>
<p>All tables within a database must be created at some point in time...let&#39;s see how we would create the Orders table:</p>
<p>CREATE TABLE ORDERS
(OWNERID INTEGER NOT NULL,
ITEMDESIRED CHAR(40) NOT NULL);</p>
<p>This statement gives the table name and tells the DBMS about each column in the table. <strong>Please note</strong> that this statement uses generic data types, and that the data types might be different, depending on what DBMS you are using. As usual, check local listings. Some common generic data types are:</p>
<ul>
<li>Char(x) - A column of characters, where x is a number designating the maximum number of characters allowed (maximum length) in the column.</li>
<li>Integer - A column of whole numbers, positive or negative.</li>
<li>Decimal(x, y) - A column of decimal numbers, where x is the maximum length in digits of the decimal numbers in this column, and y is the maximum number of digits allowed after the decimal point. The maximum (4,2) number would be 99.99.</li>
<li>Date - A date column in a DBMS-specific format.</li>
<li>Logical - A column that can hold only two values: TRUE or FALSE.</li>
</ul>
<p>One other note, the NOT NULL means that the column must have a value in each row. If NULL was used, that column may be left empty in a given row.</p>
<p><a href=""></a><strong>Altering Tables</strong></p>
<p>Let&#39;s add a column to the Antiques table to allow the entry of the price of a given Item:</p>
<p>ALTER TABLE ANTIQUES ADD (PRICE DECIMAL(8,2) NULL);</p>
<p>The data for this new column can be updated or inserted as shown later.</p>
<p><a href=""></a><strong>Adding Data</strong></p>
<p>To insert rows into a table, do the following:</p>
<p>INSERT INTO ANTIQUES VALUES (21, 01, &#39;Ottoman&#39;, 200.00);</p>
<p>This inserts the data into the table, as a new row, column-by-column, in the pre-defined order. Instead, let&#39;s change the order and leave Price blank:</p>
<p>INSERT INTO ANTIQUES (BUYERID, SELLERID, ITEM)
VALUES (01, 21, &#39;Ottoman&#39;);</p>
<p><a href=""></a><strong>Deleting Data</strong></p>
<p>Let&#39;s delete this new row back out of the database:</p>
<p>DELETE FROM ANTIQUES
WHERE ITEM = &#39;Ottoman&#39;;</p>
<p>But if there is another row that contains &#39;Ottoman&#39;, that row will be deleted also. Let&#39;s delete all rows (one, in this case) that contain the specific data we added before:</p>
<p>DELETE FROM ANTIQUES
WHERE ITEM = &#39;Ottoman&#39; AND BUYERID = 01 AND SELLERID = 21;</p>
<p><a href=""></a><strong>Updating Data</strong></p>
<p>Let&#39;s update a Price into a row that doesn&#39;t have a price listed yet:</p>
<p>UPDATE ANTIQUES SET PRICE = 500.00 WHERE ITEM = &#39;Chair&#39;;</p>
<p>This sets all Chair&#39;s Prices to 500.00. As shown above, more WHERE conditionals, using AND, must be used to limit the updating to more specific rows. Also, additional columns may be set by separating equal statements with commas.</p>
<p><strong>Miscellaneous Topics</strong></p>
<p><a href=""></a><strong>Indexes</strong></p>
<p>Indexes allow a DBMS to access data quicker (please note: this feature is nonstandard/not available on all systems). The system creates this internal data structure (the index) which causes selection of rows, when the selection is based on indexed columns, to occur faster. This index tells the DBMS where a certain row is in the table given an indexed-column value, much like a book index tells you what page a given word appears. Let&#39;s create an index for the OwnerID in the AntiqueOwners column:</p>
<p>CREATE INDEX OID_IDX ON ANTIQUEOWNERS (OWNERID);</p>
<p>Now on the names:</p>
<p>CREATE INDEX NAME_IDX ON ANTIQUEOWNERS (OWNERLASTNAME, OWNERFIRSTNAME);</p>
<p>To get rid of an index, drop it:</p>
<p>DROP INDEX OID_IDX;</p>
<p>By the way, you can also &quot;drop&quot; a table, as well (careful!--that means that your table is deleted). In the second example, the index is kept on the two columns, aggregated together--strange behavior might occur in this situation...check the manual before performing such an operation.</p>
<p>Some DBMS&#39;s do not enforce primary keys; in other words, the uniqueness of a column is not enforced automatically. What that means is, if, for example, I tried to insert another row into the AntiqueOwners table with an OwnerID of 02, some systems will allow me to do that, even though, we do not, as that column is supposed to be unique to that table (every row value is supposed to be different). One way to get around that is to create a unique index on the column that we want to be a primary key, to force the system to enforce prohibition of duplicates:</p>
<p>CREATE UNIQUE INDEX OID_IDX ON ANTIQUEOWNERS (OWNERID);</p>
<p><a href=""></a><strong>GROUP BY &amp; HAVING</strong></p>
<p>One special use of GROUP BY is to associate an aggregate function (especially COUNT; counting the number of rows in each group) with groups of rows. First, assume that the Antiques table has the Price column, and each row has a value for that column. We want to see the price of the most expensive item bought by each owner. We have to tell SQL to group each owner&#39;s purchases, and tell us the maximum purchase price:</p>
<p>SELECT BUYERID, MAX(PRICE)
FROM ANTIQUES
GROUP BY BUYERID;</p>
<p>Now, say we only want to see the maximum purchase price if the purchase is over $1000, so we use the HAVING clause:</p>
<p>SELECT BUYERID, MAX(PRICE)
FROM ANTIQUES
GROUP BY BUYERID
HAVING PRICE &gt; 1000;</p>
<p><a href=""></a><strong>More Subqueries</strong></p>
<p>Another common usage of subqueries involves the use of operators to allow a Where condition to include the Select output of a subquery. First, list the buyers who purchased an expensive item (the Price of the item is $100 greater than the average price of all items purchased):</p>
<p>SELECT OWNERID
FROM ANTIQUES
WHERE PRICE &gt;</p>
<p>(SELECT AVG(PRICE) + 100
FROM ANTIQUES);</p>
<p>The subquery calculates the average Price, plus $100, and using that figure, an OwnerID is printed for every item costing over that figure. One could use DISTINCT OWNERID, to eliminate duplicates.</p>
<p>List the Last Names of those in the AntiqueOwners table, ONLY if they have bought an item:</p>
<p>SELECT OWNERLASTNAME
FROM ANTIQUEOWNERS
WHERE OWNERID =</p>
<p>(SELECT DISTINCT BUYERID
FROM ANTIQUES);</p>
<p>The subquery returns a list of buyers, and the Last Name is printed for an Antique Owner if and only if the Owner&#39;s ID appears in the subquery list (sometimes called a candidate list).</p>
<p>For an Update example, we know that the gentleman who bought the bookcase has the wrong First Name in the database...it should be John:</p>
<p>UPDATE ANTIQUEOWNERS
SET OWNERFIRSTNAME = &#39;John&#39;
WHERE OWNERID =</p>
<p>(SELECT BUYERID
FROM ANTIQUES
WHERE ITEM = &#39;Bookcase&#39;);</p>
<p>First, the subquery finds the BuyerID for the person(s) who bought the Bookcase, then the outer query updates his First Name.</p>
<p><strong>Remember this rule about subqueries:</strong> when you have a subquery as part of a WHERE condition, the Select clause in the subquery must have columns that match in number and type to those in the Where clause of the outer query. In other words, if you have &quot;WHERE ColumnName = (SELECT...);&quot;, the Select must have only one column in it, to match the ColumnName in the outer Where clause, and they must match in type (both being integers, both being character strings, etc.).</p>
<p><a href=""></a><strong>EXISTS &amp; ALL</strong></p>
<p>EXISTS uses a subquery as a condition, where the condition is True if the subquery returns any rows, and False if the subquery does not return any rows; this is a nonintuitive feature with few unique uses. However, if a prospective customer wanted to see the list of Owners only if the shop dealt in Chairs, try:</p>
<p>SELECT OWNERFIRSTNAME, OWNERLASTNAME
FROM ANTIQUEOWNERS
WHERE EXISTS</p>
<p>(SELECT /*
FROM ANTIQUES
WHERE ITEM = &#39;Chair&#39;);</p>
<p>If there are any Chairs in the Antiques column, the subquery would return a row or rows, making the EXISTS clause true, causing SQL to list the Antique Owners. If there had been no Chairs, no rows would have been returned by the outside query.</p>
<p>ALL is another unusual feature, as ALL queries can usually be done with different, and possibly simpler methods; let&#39;s take a look at an example query:</p>
<p>SELECT BUYERID, ITEM
FROM ANTIQUES
WHERE PRICE &gt;= ALL</p>
<p>(SELECT PRICE
FROM ANTIQUES);</p>
<p>This will return the largest priced item (or more than one item if there is a tie), and its buyer. The subquery returns a list of all Prices in the Antiques table, and the outer query goes through each row of the Antiques table, and if its Price is greater than or equal to every (or ALL) Prices in the list, it is listed, giving the highest priced Item. The reason &quot;&gt;=&quot; must be used is that the highest priced item will be equal to the highest price on the list, because this Item is in the Price list.</p>
<p><a href=""></a><strong>UNION &amp; Outer Joins</strong></p>
<p>There are occasions where you might want to see the results of multiple queries together, combining their output; use UNION. To merge the output of the following two queries, displaying the ID&#39;s of all Buyers, plus all those who have an Order placed:</p>
<p>SELECT BUYERID
FROM ANTIQUEOWNERS
UNION
SELECT OWNERID
FROM ORDERS;</p>
<p>Notice that SQL requires that the Select list (of columns) must match, column-by-column, in data type. In this case BuyerID and OwnerID are of the same data type (integer). Also notice that SQL does automatic duplicate elimination when using UNION (as if they were two &quot;sets&quot;); in single queries, you have to use DISTINCT.</p>
<p>The outer join is used when a join query is &quot;united&quot; with the rows not included in the join, and are especially useful if constant text &quot;flags&quot; are included. First, look at the query:</p>
<p>SELECT OWNERID, &#39;is in both Orders &amp; Antiques&#39;
FROM ORDERS, ANTIQUES
WHERE OWNERID = BUYERID
UNION
SELECT BUYERID, &#39;is in Antiques only&#39;
FROM ANTIQUES
WHERE BUYERID NOT IN</p>
<p>(SELECT OWNERID
FROM ORDERS);</p>
<p>The first query does a join to list any owners who are in both tables, and putting a tag line after the ID repeating the quote. The UNION merges this list with the next list. The second list is generated by first listing those ID&#39;s not in the Orders table, thus generating a list of ID&#39;s excluded from the join query. Then, each row in the Antiques table is scanned, and if the BuyerID is not in this exclusion list, it is listed with its quoted tag. There might be an easier way to make this list, but it&#39;s difficult to generate the informational quoted strings of text.</p>
<p>This concept is useful in situations where a primary key is related to a foreign key, but the foreign key value for some primary keys is NULL. For example, in one table, the primary key is a salesperson, and in another table is customers, with their salesperson listed in the same row. However, if a salesperson has no customers, that person&#39;s name won&#39;t appear in the customer table. The outer join is used if the listing of <strong>all</strong> salespersons is to be printed, listed with their customers, whether the salesperson has a customer or not--that is, no customer is printed (a logical NULL value) if the salesperson has no customers, but is in the salespersons table. Otherwise, the salesperson will be listed with each customer.</p>
<p>ENOUGH QUERIES!!! you say?...now on to something completely different...</p>
<p><a href=""></a><strong>Embedded SQL--an ugly example (do not write a program like this...for purposes of argument ONLY)</strong></p>
<p>//<em> -To get right to it, here is an example program that uses Embedded
    SQL. Embedded SQL allows programmers to connect to a database and
    include SQL code right in the program, so that their programs can
    use, manipulate, and process data from a database.
   -This example C Program (using Embedded SQL) will print a report.
   -This program will have to be precompiled for the SQL statements,
    before regular compilation.
   -The EXEC SQL parts are the same (standard), but the surrounding C
    code will need to be changed, including the host variable
    declarations, if you are using a different language.
   -Embedded SQL changes from system to system, so, once again, check
    local documentation, especially variable declarations and logging
    in procedures, in which network, DBMS, and operating system
    considerations are crucial. /</em>/</p>
<p>//<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/
//<em> THIS PROGRAM IS NOT COMPILABLE OR EXECUTABLE /</em>/
//<em> IT IS FOR EXAMPLE PURPOSES ONLY              /</em>/
//<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/</p>
<p>/#include <stdio.h></p>
<p>//<em> This section declares the host variables; these will be the
   variables your program uses, but also the variable SQL will put
   values in or take values out. /</em>/
EXEC SQL BEGIN DECLARE SECTION;
  int BuyerID;
  char FirstName[100], LastName[100], Item[100];
EXEC SQL END DECLARE SECTION;</p>
<p>//<em> This includes the SQLCA variable, so that some error checking can be done. /</em>/
EXEC SQL INCLUDE SQLCA;</p>
<p>main() {</p>
<p>//<em> This is a possible way to log into the database /</em>/
EXEC SQL CONNECT UserID/Password;</p>
<p>//<em> This code either says that you are connected or checks if an error
   code was generated, meaning log in was incorrect or not possible. /</em>/   if(sqlca.sqlcode) {
    printf(Printer, &quot;Error connecting to database server.\n&quot;);
    exit();
  }
  printf(&quot;Connected to database server.\n&quot;);</p>
<p>//<em> This declares a &quot;Cursor&quot;. This is used when a query returns more
   than one row, and an operation is to be performed on each row
   resulting from the query. With each row established by this query,
   I&#39;m going to use it in the report. Later, &quot;Fetch&quot; will be used to
   pick off each row, one at a time, but for the query to actually
   be executed, the &quot;Open&quot; statement is used. The &quot;Declare&quot; just
   establishes the query. /</em>/
EXEC SQL DECLARE ItemCursor CURSOR FOR
  SELECT ITEM, BUYERID
  FROM ANTIQUES
  ORDER BY ITEM;
EXEC SQL OPEN ItemCursor;</p>
<p>//<em> +-- You may wish to put a similar error checking block here --+ /</em>/</p>
<p>//<em> Fetch puts the values of the &quot;next&quot; row of the query in the host
   variables, respectively. However, a &quot;priming fetch&quot; (programming
   technique) must first be done. When the cursor is out of data, a
   sqlcode will be generated allowing us to leave the loop. Notice
   that, for simplicity&#39;s sake, the loop will leave on any sqlcode,
   even if it is an error code. Otherwise, specific code checking must
   be performed. /</em>/
EXEC SQL FETCH ItemCursor INTO :Item, :BuyerID;
  while(!sqlca.sqlcode) {</p>
<p>//<em> With each row, we will also do a couple of things. First, bump the
   price up by $5 (dealer&#39;s fee) and get the buyer&#39;s name to put in
   the report. To do this, I&#39;ll use an Update and a Select, before
   printing the line on the screen. The update assumes however, that
   a given buyer has only bought one of any given item, or else the
   price will be increased too many times. Otherwise, a &quot;RowID&quot; logic
   would have to be used (see documentation). Also notice the colon    before host variable names when used inside of SQL statements. /</em>/</p>
<p>EXEC SQL UPDATE ANTIQUES
  SET PRICE = PRICE + 5
  WHERE ITEM = :Item AND BUYERID = :BuyerID;</p>
<p>EXEC SQL SELECT OWNERFIRSTNAME, OWNERLASTNAME
  INTO :FirstName, :LastName
  FROM ANTIQUEOWNERS
  WHERE BUYERID = :BuyerID;</p>
<pre><code>printf(&quot;%25s %25s %25s&quot;, FirstName, LastName, Item);
</code></pre><p>//<em> Ugly report--for example purposes only! Get the next row. /</em>/
EXEC SQL FETCH ItemCursor INTO :Item, :BuyerID;
  }</p>
<p>//<em> Close the cursor, commit the changes (see below), and exit the
   program. /</em>/
EXEC SQL CLOSE DataCursor;
EXEC SQL COMMIT RELEASE;
  exit();
}</p>
<p><a href=""></a><strong>Common SQL Questions--Advanced Topics (see FAQ link for several more)</strong></p>
<ol>
<li>Why can&#39;t I just ask for the first three rows in a table? --Because in relational databases, rows are inserted in no particular order, that is, the system inserts them in an arbitrary order; so, you can only request rows using valid SQL features, like ORDER BY, etc.</li>
<li>What is this DDL and DML I hear about? --DDL (Data Definition Language) refers to (in SQL) the Create Table statement...DML (Data Manipulation Language) refers to the Select, Update, Insert, and Delete statements.</li>
<li>Aren&#39;t database tables just files? --Well, DBMS&#39;s store data in files declared by system managers before new tables are created (on large systems), but the system stores the data in a special format, and may spread data from one table over several files. In the database world, a set of files created for a database is called a tablespace. In general, on small systems, everything about a database (definitions and all table data) is kept in one file.</li>
<li>(Related question) Aren&#39;t database tables just like spreadsheets? --No, for two reasons. First, spreadsheets can have data in a cell, but a cell is more than just a row-column-intersection. Depending on your spreadsheet software, a cell might also contain formulas and formatting, which database tables cannot have (currently). Secondly, spreadsheet cells are often dependent on the data in other cells. In databases, &quot;cells&quot; are independent, except that columns are logically related (hopefully; together a row of columns describe an entity), and, other than primary key and foreign key constraints, each row in a table in independent from one another.</li>
<li>How do I import a text file of data into a database? --Well, you can&#39;t do it directly...you must use a utility, such as Oracle&#39;s SQL/*Loader, or write a program to load the data into the database. A program to do this would simply go through each record of a text file, break it up into columns, and do an Insert into the database.</li>
<li>What is a schema? --A schema is a logical set of tables, such as the Antiques database above...usually, it is thought of as simply &quot;the database&quot;, but a database can hold more than one schema. For example, a star schema is a set of tables where one large, central table holds all of the important information, and is linked, via foreign keys, to dimension tables which hold detail information, and can be used in a join to create detailed reports.</li>
<li>What are some general tips you would give to make my SQL queries and databases better and faster (optimized)?</li>
</ol>
<ul>
<li>You should try, if you can, to avoid expressions in Selects, such as SELECT ColumnA + ColumnB, etc. The query optimizer of the database, the portion of the DBMS that determines the best way to get the required data out of the database itself, handles expressions in such a way that would normally require more time to retrieve the data than if columns were normally selected, and the expression itself handled programmatically.</li>
<li>Minimize the number of columns included in a Group By clause.</li>
<li>If you are using a join, try to have the columns joined on (from both tables) indexed.</li>
<li>When in doubt, index.</li>
<li><p>Unless doing multiple counts or a complex query, use COUNT(/*) (the number of rows generated by the query) rather than COUNT(Column_Name).</p>
</li>
<li><p>What is normalization? --Normalization is a technique of database design that suggests that certain criteria be used when constructing a table layout (deciding what columns each table will have, and creating the key structure), where the idea is to eliminate redundancy of non-key data across tables. Normalization is usually referred to in terms of forms, and I will introduce only the first three, even though it is somewhat common to use other, more advanced forms (fourth, fifth, Boyce-Codd; see documentation).
First Normal Form refers to moving data into separate tables where the data in each table is of a similar type, and by giving each table a primary key.
Putting data in Second Normal Form involves taking out data off to other tables that is only dependent of a part of the key. For example, if I had left the names of the Antique Owners in the items table, that would not be in second normal form because that data would be redundant; the name would be repeated for each item owned, so the names were placed in their own table. The names themselves don&#39;t have anything to do with the items, only the identities of the buyers and sellers.
Third Normal Form involves getting rid of anything in the tables that doesn&#39;t depend solely on the primary key. Only include information that is dependent on the key, and move off data to other tables that are independent of the primary key, and create a primary keys for the new tables.
There is some redundancy to each form, and if data is in 3NF(shorthand for 3rd normal form), it is already in 1NFand 2NF. In terms of data design then, arrange data so that any non-primary key columns are dependent only on the whole primary key. If you take a look at the sample database, you will see that the way then to navigate through the database is through joins using common key columns.
Two other important points in database design are using good, consistent, logical, full-word names for the tables and columns, and the use of full words in the database itself. On the last point, my database is lacking, as I use numeric codes for identification. It is usually best, if possible, to come up with keys that are, by themselves, self-explanatory; for example, a better key would be the first four letters of the last name and first initial of the owner, like JONEB for Bill Jones (or for tiebreaking purposes, add numbers to the end to differentiate two or more people with similar names, so you could try JONEB1, JONEB2, etc.).</p>
</li>
<li>What is the difference between a single-row query and a multiple-row query and why is it important to know the difference? --First, to cover the obvious, a single-row query is a query that returns one row as its result, and a multiple-row query is a query that returns more than one row as its result. Whether a query returns one row or more than one row is entirely dependent on the design (or schema) of the tables of the database. As query-writer, you must be aware of the schema, be sure to include enough conditions, and structure your SQL statement properly, so that you will get the desired result (either one row or multiple rows). For example, if you wanted to be sure that a query of the AntiqueOwners table returned only one row, consider an equal condition of the primary key-column, OwnerID.
Three reasons immediately come to mind as to why this is important. First, getting multiple rows when you were expecting only one, or vice-versa, may mean that the query is erroneous, that the database is incomplete, or simply, you learned something new about your data. Second, if you are using an update or delete statement, you had better be sure that the statement that you write performs the operation on the desired row (or rows)...or else, you might be deleting or updating more rows than you intend. Third, any queries written in Embedded SQL must be carefully thought out as to the number of rows returned. If you write a single-row query, only one SQL statement may need to be performed to complete the programming logic required. If your query, on the other hand, returns multiple rows, you will have to use the Fetch statement, and quite probably, some sort of looping structure in your program will be required to iterate processing on each returned row of the query.</li>
<li>What are relationships? --Another design question...the term &quot;relationships&quot; (often termed &quot;relation&quot;) usually refers to the relationships among primary and foreign keys between tables. This concept is important because when the tables of a relational database are designed, these relationships must be defined because they determine which columns are or are not primary or foreign keys. You may have heard of an <strong>Entity-Relationship Diagram</strong>, which is a graphical view of tables in a database schema, with lines connecting related columns across tables. See the sample diagram at the end of this section or some of the sites below in regard to this topic, as there are many different ways of drawing E-R diagrams. But first, let&#39;s look at each kind of relationship...
A One-to-one relationship means that you have a primary key column that is related to a foreign key column, and that for every primary key value, there is <strong>one</strong> foreign key value. For example, in the first example, the EmployeeAddressTable, we add an EmployeeIDNo column. Then, the EmployeeAddressTable is related to the EmployeeStatisticsTable (second example table) by means of that EmployeeIDNo. Specifically, each employee in the EmployeeAddressTable <strong>has</strong> statistics (one row of data) in the EmployeeStatisticsTable. Even though this is a contrived example, this is a &quot;1-1&quot; relationship. Also notice the &quot;has&quot; in bold...when expressing a relationship, it is important to describe the relationship with a verb.
The other two kinds of relationships may or may not use logical primary key and foreign key constraints...it is strictly a call of the designer. The first of these is the one-to-many relationship (&quot;1-M&quot;). This means that for every column value in one table, there is <strong>one or more</strong> related values in another table. Key constraints may be added to the design, or possibly just the use of some sort of identifier column may be used to establish the relationship. An example would be that for every OwnerID in the AntiqueOwners table, there are one or more (zero is permissible too) Items <strong>bought</strong> in the Antiques table (verb: buy).
Finally, the many-to-many relationship (&quot;M-M&quot;) does not involve keys generally, and usually involves idenifying columns. The unusual occurence of a &quot;M-M&quot; means that one column in one table is related to another column in another table, and for every value of one of these two columns, there are one or more related values in the corresponding column in the other table (and vice-versa), or more a common possibility, two tables have a 1-M relationship to each other (two relationships, one 1-M going each way). A [bad] example of the more common situation would be if you had a job assignment database, where one table held one row for each employee and a job assignment, and another table held one row for each job with one of the assigned employees. Here, you would have multiple rows for each employee in the first table, one for each job assignment, and multiple rows for each job in the second table, one for each employee assigned to the project. These tables have a M-M: each employee in the first table <strong>has</strong> many job assignments from the second table, and each job <strong>has</strong> many employees assigned to it from the first table. This is the tip of the iceberg on this topic...see the links below for more information and see the diagram below for a simplified example of an E-R diagram.
<img src="http://zql.sourceforge.net/erdiagram.gif" alt="Sample Simplified Entity-Relationship Diagram"></li>
<li>What are some important nonstandard SQL features (extremely common question)? --Well, see the next section...</li>
</ul>
<p><a href=""></a><strong>Nonstandard SQL...&quot;check local listings&quot;</strong></p>
<ul>
<li>INTERSECT and MINUS are like the UNION statement, except that INTERSECT produces rows that appear in both queries, and MINUS produces rows that result from the first query, but not the second.</li>
<li>Report Generation Features: the COMPUTE clause is placed at the end of a query to place the result of an aggregate function at the end of a listing, like COMPUTE SUM (PRICE); Another option is to use break logic: define a break to divide the query results into groups based on a column, like BREAK ON BUYERID. Then, to produce a result after the listing of a group, use COMPUTE SUM OF PRICE ON BUYERID. If, for example, you used all three of these clauses (BREAK first, COMPUTE on break second, COMPUTE overall sum third), you would get a report that grouped items by their BuyerID, listing the sum of Prices after each group of a BuyerID&#39;s items, then, after all groups are listed, the sum of all Prices is listed, all with SQL-generated headers and lines.</li>
<li>In addition to the above listed aggregate functions, some DBMS&#39;s allow more functions to be used in Select lists, except that these functions (some character functions allow multiple-row results) are to be used with an individual value (not groups), on single-row queries.The functions are to be used only on appropriate data types, also. Here are some <strong>Mathematical Functions</strong>:
<strong>ABS(X)</strong> Absolute value-converts negative numbers to positive, or leaves positive numbers alone <strong>CEIL(X)</strong> X is a decimal value that will be rounded up. <strong>FLOOR(X)</strong> X is a decimal value that will be rounded down. <strong>GREATEST(X,Y)</strong> Returns the largest of the two values. <strong>LEAST(X,Y)</strong> Returns the smallest of the two values. <strong>MOD(X,Y)</strong> Returns the remainder of X / Y. <strong>POWER(X,Y)</strong> Returns X to the power of Y. <strong>ROUND(X,Y)</strong> Rounds X to Y decimal places. If Y is omitted, X is rounded to the nearest integer. <strong>SIGN(X)</strong> Returns a minus if X &lt; 0, else a plus. <strong>SQRT(X)</strong> Returns the square root of X. <strong>Character Functions</strong>
<strong>LEFT(<string>,X)</strong> Returns the leftmost X characters of the string. <strong>RIGHT(<string>,X)</strong> Returns the rightmost X characters of the string. <strong>UPPER(<string>)</strong> Converts the string to all uppercase letters. <strong>LOWER(<string>)</strong> Converts the string to all lowercase letters. <strong>INITCAP(<string>)</strong> Converts the string to initial caps. <strong>LENGTH(<string>)</strong> Returns the number of characters in the string. <strong><string>||<string></strong> Combines the two strings of text into one, concatenated string, where the first string is immediately followed by the second. <strong>LPAD(<string>,X,&#39;/*&#39;)</strong> Pads the string on the left with the /<em> (or whatever character is inside the quotes), to make the string X characters long. **RPAD(<string>,X,&#39;/</em>&#39;)<strong> Pads the string on the right with the /* (or whatever character is inside the quotes), to make the string X characters long. </strong>SUBSTR(<string>,X,Y)<strong> Extracts Y letters from the string beginning at position X. </strong>NVL(<column>,<value>)** The Null value function will substitute <value> for any NULLs for in the <column>. If the current value of <column> is not NULL, NVL has no effect.</li>
</ul>
<p><a href=""></a><strong>Syntax Summary--For Advanced Users Only</strong></p>
<p>Here are the general forms of the statements discussed in this tutorial, plus some extra important ones (explanations given). <strong>REMEMBER</strong> that all of these statements may or may not be available on your system, so check documentation regarding availability:</p>
<p><strong>ALTER TABLE</strong><TABLE NAME> ADD|DROP|MODIFY (COLUMN SPECIFICATION[S]...see Create Table); --allows you to add or delete a column or columns from a table, or change the specification (data type, etc.) on an existing column; this statement is also used to change the physical specifications of a table (how a table is stored, etc.), but these definitions are DBMS-specific, so read the documentation. Also, these physical specifications are used with the Create Table statement, when a table is first created. In addition, only one option can be performed per Alter Table statement--either add, drop, <strong>OR</strong>modify in a single statement.</p>
<p><strong>COMMIT</strong>; --makes changes made to some database systems permanent (since the last COMMIT; known as a transaction)</p>
<p><strong>CREATE [UNIQUE] INDEX</strong> <INDEX NAME>
ON <TABLE NAME> (<COLUMN LIST>); --UNIQUE is optional; within brackets.</p>
<p><strong>CREATE TABLE</strong> <TABLE NAME>
(<COLUMN NAME> <DATA TYPE> [(<SIZE>)] <COLUMN CONSTRAINT>,
...other columns); (also valid with ALTER TABLE)
--where SIZE is only used on certain data types (see above), and constraints include the following possibilities (automatically enforced by the DBMS; failure causes an error to be generated):</p>
<ol>
<li>NULL or NOT NULL (see above)</li>
<li>UNIQUE enforces that no two rows will have the same value for this column</li>
<li>PRIMARY KEY tells the database that this column is the primary key column (only used if the key is a one column key, otherwise a PRIMARY KEY (column, column, ...) statement appears after the last column definition.</li>
<li>CHECK allows a condition to be checked for when data in that column is updated or inserted; for example, CHECK (PRICE &gt; 0) causes the system to check that the Price column is greater than zero before accepting the value...sometimes implemented as the CONSTRAINT statement.</li>
<li>DEFAULT inserts the default value into the database if a row is inserted without that column&#39;s data being inserted; for example, BENEFITS INTEGER DEFAULT = 10000</li>
<li>FOREIGN KEY works the same as Primary Key, but is followed by: REFERENCES <TABLE NAME> (<COLUMN NAME>), which refers to the referential primary key.</li>
</ol>
<p><strong>CREATE VIEW</strong> <TABLE NAME> AS <QUERY>;</p>
<p><strong>DELETE</strong> FROM <TABLE NAME> WHERE <CONDITION>;</p>
<p><strong>INSERT</strong> INTO <TABLE NAME> [(<COLUMN LIST>)]
VALUES (<VALUE LIST>);</p>
<p><strong>ROLLBACK</strong>; --Takes back any changes to the database that you have made, back to the last time you gave a Commit command...beware! Some software uses automatic committing on systems that use the transaction features, so the Rollback command may not work.</p>
<p><strong>SELECT</strong> [DISTINCT|ALL] <LIST OF COLUMNS, FUNCTIONS, CONSTANTS, ETC.>
FROM <LIST OF TABLES OR VIEWS>
[WHERE <CONDITION(S)>]
[GROUP BY <GROUPING COLUMN(S)>]
[HAVING <CONDITION>]
[ORDER BY <ORDERING COLUMN(S)> [ASC|DESC]]; --where ASC|DESC allows the ordering to be done in ASCending or DESCending order</p>
<p><strong>UPDATE</strong> <TABLE NAME>
SET <COLUMN NAME> = <VALUE>
[WHERE <CONDITION>]; --if the Where clause is left out, all rows will be updated according to the Set statement</p>
<p><a href=""></a><strong>Important Links</strong></p>
<p>Computing &amp; SQL/DB Links: <a href="http://home.netscape.com/" target="_blank">Netscape</a> -- <a href="http://www.oracle.com/" target="_blank">Oracle</a> -- <a href="http://www.sybase.com/" target="_blank">Sybase</a> -- <a href="http://www.informix.com/" target="_blank">Informix</a> --<a href="http://www.microsoft.com/">Microsoft
</a><a href="http://www.contrib.andrew.cmu.edu/~shadow/sql.html" target="_blank">SQL Reference Page</a> -- <a href="http://www.inquiry.com/techtips/thesqlpro/" target="_blank">Ask the SQL Pro</a> -- <a href="http://www.inquiry.com/techtips/thesqlpro/usefulsites.html">SQL Pro&#39;s Relational DB Useful Sites
</a><a href="http://infoweb.magi.com/~steve/develop.html" target="_blank">Programmer&#39;s Source</a> -- <a href="http://info.itu.ch/special/wwwfiles/comp_db.html" target="_blank">DBMS Sites</a> -- <a href="http://www.inquiry.com/" target="_blank">inquiry.com</a> -- <a href="http://www.compapp.dcu.ie/databases/f017.html" target="_blank">DB Ingredients</a>
<a href="http://www.stars.com/Tutorial/CGI/" target="_blank">Web Authoring</a> -- <a href="http://wfn-shop.princeton.edu/cgi-bin/foldoc" target="_blank">Computing Dictionary</a> -- <a href="http://www-ccs.cs.umass.edu/db.html" target="_blank">DBMS Lab/Links</a> -- <a href="http://epoch.cs.berkeley.edu:8000/sequoia/dba/montage/FAQ/SQL_TOC.html" target="_blank">SQL FAQ</a> -- <a href="http://chaos.mur.csu.edu.au/itc125/cgi/sqldb.html" target="_blank">SQL Databases</a>
<a href="http://www.it.rit.edu/~wjs/IT/199602/icsa720/icsa720postings.html" target="_blank">RIT Database Design Page</a> -- <a href="http://www.pcslink.com/~ej/dbweb.html" target="_blank">Database Jump Site</a> -- <a href="http://www.eng.uc.edu/~jtilley/tutorial.html" target="_blank">Programming Tutorials on the Web</a>
<a href="http://www.ndev.com/ndc2/support/resources.htp" target="_blank">Development Resources</a> -- <a href="http://ashok.pair.com/sql.htm" target="_blank">Query List</a> -- <a href="http://jazz.external.hp.com/training/sqltables/main.html" target="_blank">IMAGE SQL</a></p>
<p>Miscellaneous: <a href="http://www.cnn.com/" target="_blank">CNN</a> -- <a href="http://www.usatoday.com/" target="_blank">USA Today</a> -- <a href="http://www.pathfinder.com/" target="_blank">Pathfinder</a> -- <a href="http://www.zdnet.com/" target="_blank">ZDNet</a> -- <a href="http://metroscope.com/" target="_blank">Metroscope</a> -- <a href="http://www.cnet.com/" target="_blank">CNet</a>
<a href="http://www.eit.com/web/netservices.html" target="_blank">Internet Resource List</a> -- <a href="http://netcast.noaa.gov/cgi-bin/page?pg=netcast" target="_blank">Netcast Weather</a> -- <a href="http://www.techweb.com/" target="_blank">TechWeb</a> -- <a href="http://www.looksmart.com/" target="_blank">LookSmart</a></p>
<p>Search Engines: <a href="http://www.yahoo.com/" target="_blank">Yahoo</a> -- <a href="http://www.altavista.digital.com/" target="_blank">Alta Vista</a> -- <a href="http://www.excite.com/" target="_blank">Excite</a> -- <a href="http://webcrawler.com/" target="_blank">WebCrawler</a> -- <a href="http://www.lycos.com/" target="_blank">Lycos</a> -- <a href="http://www.infoseek.com/" target="_blank">Infoseek</a> -- <a href="http://www.search.com/" target="_blank">search.com</a></p>
<p>These sites are not endorsed by the author.
<strong>Disclaimer</strong></p>
<p>I hope you have learned something from this introductory look at a very important language that is becoming more prevalent in the world of client-server computing. I wrote this web page in order to contribute something of value to the web and the web community. In fact, I have been informed that this document is being used at several colleges for use in database classes and for use by researchers. Also, look for this page in Waite Publishing&#39;s newest book about Borland C++ Builder, which will be out this summer, and in an upcoming Sams Publishing release. In addition, I would like to thank all of the people from across five continents who have contacted me regarding this web page.</p>
<p>I also hope to continue to add more material to this tutorial, such as topics about database design and nonstandard SQL extensions, even though I wish to stay away from material about individual Database Management Systems. Good luck in your SQL and other computing adventures.</p>
<p>Jim Hoffman
Comments or suggestions? Mail me at <a href="mailto:jhoffman@one.net">jhoffman@one.net.</a></p>
<p>Or you may wish to look at <a href="http://w3.one.net/~jhoffman/index.html" target="_blank">Jim Hoffman&#39;s Web Pages</a> for more information about myself.</p>
<p>Copyright 1996-1997, James Hoffman. This document can be used for free by any Internet user, but cannot be included in another document, published in any other form, or mass produced in any way.</p>
<p>This page is best viewed with <a href="http://home.netscape.com/" target="_blank">Netscape Navigator</a>; it doesn&#39;t look quite right with <a href="http://www.microsoft.com/ie" target="_blank">Microsoft Internet Explorer.</a></p>
<p>Last updated: 8-25-1997; added some material.</p>
<p><a href="http://w3.one.net/~jhoffman/sqltut.htm" target="_blank">http://w3.one.net/~jhoffman/sqltut.htm</a>
来源： <a href="[http://zql.sourceforge.net/sqltut.html](http://zql.sourceforge.net/sqltut.html)">[http://zql.sourceforge.net/sqltut.html](http://zql.sourceforge.net/sqltut.html)</a>  </p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li></span><span class="breadcrumb"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li><li><a href="/categories/Java&J2EE/SQL_Java/">SQL_Java</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Java&J2EE/" class="label label-primary">Java&J2EE</a><a href="/tags/SQL_Java/" class="label label-success">SQL_Java</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:41"datetime="2014-03-07 09:54:41"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-SQL_Java--IntroductiontoStructuredQueryLanguageZQL/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JavaJ2EE-SQL_Java--IntroductiontoStructuredQueryLanguageZQL" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JavaJ2EE-NIO--JAVANIO总结/">JAVA NIO总结</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:41.000Z"> <a href="/2014/02/02/2014-02-02-JavaJ2EE-NIO--JAVANIO总结/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="java-nio-">JAVA NIO总结</h1>
<p>（一）—基本概念</p>
<h2 id="1-">1、输入/输出：概念性描述</h2>
<h3 id="-1-1-i-o-"><a href=""></a>1.1） I/O简介</h3>
<p>I/O  或者输入/输出指的是计算机与外部世界或者一个程序与计算机的其余部分的之间的接口。它对于任何计算机系统都非常关键，因而所有 I/O 的主体实际上是内置在操作系统中的。单独的程序一般是让系统为它们完成大部分的工作。</p>
<p>在 Java 编程中，直到最近一直使用<strong>流</strong>的方式完成 I/O。所有 I/O 都被视为单个的字节的移动，通过一个称为 Stream 的对象一次移动一个字节。流 I/O 用于与外部世界接触。它也在内部使用，用于将对象转换为字节，然后再转换回对象。NIO 与原来的 I/O 有同样的作用和目的，但是它使用不同的方式? <strong>块 I/O</strong>。正如您将在本教程中学到的，块 I/O 的效率可以比流 I/O 高许多。</p>
<h3 id="-1-2-nio-"><a href=""></a>1.2）为什么要使用NIO？</h3>
<p>NIO 的创建目的是为了让 Java 程序员可以实现高速 I/O 而无需编写自定义的本机代码。NIO 将最耗时的 I/O 操作(即填充和提取缓冲区)转移回操作系统，因而可以极大地提高速度。</p>
<h3 id="-1-3-"><a href=""></a>1.3）流与块的比较</h3>
<p>原来的 I/O 库(在 </p>
<p>java.io./*
中) 与 NIO 最重要的区别是数据打包和传输的方式。正如前面提到的，原来的 I/O 以流的方式处理数据，而 NIO 以块的方式处理数据。</p>
<p><strong>面向流*</strong> *的 I/O 系统一次一个字节地处理数据。一个输入流产生一个字节的数据，一个输出流消费一个字节的数据。为流式数据创建过滤器非常容易。链接几个过滤器，以便每个过滤器只负责单个复杂处理机制的一部分，这样也是相对简单的。不利的一面是，面向流的 I/O 通常相当慢。</p>
<p>一个 <strong>面向块*</strong> *的 I/O 系统以块的形式处理数据。每一个操作都在一步中产生或者消费一个数据块。按块处理数据比按(流式的)字节处理数据要快得多。但是面向块的 I/O 缺少一些面向流的 I/O 所具有的优雅性和简单性。</p>
<h3 id="-1-4-io"><a href=""></a>1.4）集成的IO</h3>
<p>在 JDK 1.4 中原来的 I/O 包和 NIO 已经很好地集成了。 </p>
<p>java.io./*
 已经以 NIO 为基础重新实现了，所以现在它可以利用 NIO 的一些特性。例如， </p>
<p>java.io./*
 包中的一些类包含以块的形式读写数据的方法，这使得即使在更面向流的系统中，处理速度也会更快。</p>
<p>也可以用 NIO 库实现标准 I/O 功能。例如，可以容易地使用块 I/O 一次一个字节地移动数据。但是正如您会看到的，NIO 还提供了原 I/O 包中所没有的许多好处。</p>
<h2 id="-2-"><a href=""></a>2、通道和缓冲区</h2>
<h3 id="-2-1-"><a href=""></a>2.1）概述</h3>
<p>通道 
和 </p>
<p>缓冲区 
是 NIO 中的核心对象，几乎在每一个 I/O 操作中都要使用它们。</p>
<p>通道是对原 I/O 包中的流的模拟。到任何目的地(或来自任何地方)的所有数据都必须通过一个 Channel 对象。一个 Buffer 实质上是一个容器对象。发送给一个通道的所有对象都必须首先放到缓冲区中；同样地，从通道中读取的任何数据都要读到缓冲区中。</p>
<p>在本节中，您会了解到 NIO 中通道和缓冲区是如何工作的。</p>
<h3 id="-2-2-"><a href=""></a>2.2）什么是缓冲区</h3>
<p>Buffer
 是一个对象， 它包含一些要写入或者刚读出的数据。 在 NIO 中加入 </p>
<p>Buffer
 对象，体现了新库与原 I/O 的一个重要区别。在面向流的 I/O 中，您将数据直接写入或者将数据直接读到 </p>
<p>Stream
 对象中。</p>
<p>在 NIO 库中，所有数据都是用缓冲区处理的。在读取数据时，它是直接读到缓冲区中的。在写入数据时，它是写入到缓冲区中的。任何时候访问 NIO 中的数据，您都是将它放到缓冲区中。</p>
<p>缓冲区实质上是一个数组。通常它是一个字节数组，但是也可以使用其他种类的数组。但是一个缓冲区不 <em>仅仅 </em>是一个数组。缓冲区提供了对数据的结构化访问，而且还可以跟踪系统的读/写进程。</p>
<h3 id="-2-3-"><a href=""></a>2.3）缓冲区类型</h3>
<p>最常用的缓冲区类型是 </p>
<p>ByteBuffer
。一个 </p>
<p>ByteBuffer
 可以在其底层字节数组上进行 get/set 操作(即字节的获取和设置)。</p>
<p>ByteBuffer
 不是 NIO 中唯一的缓冲区类型。事实上，对于每一种基本 Java 类型都有一种缓冲区类型：</p>
<ul>
<li>ByteBuffer</li>
<li>CharBuffer</li>
<li>ShortBuffer</li>
<li>IntBuffer</li>
<li>LongBuffer</li>
<li>FloatBuffer</li>
<li>DoubleBuffer</li>
</ul>
<p>每一个 </p>
<p>Buffer
 类都是 </p>
<p>Buffer
 接口的一个实例。 除了 </p>
<p>ByteBuffer
，每一个 Buffer 类都有完全一样的操作，只是它们所处理的数据类型不一样。因为大多数标准 I/O 操作都使用 </p>
<p>ByteBuffer
，所以它具有所有共享的缓冲区操作以及一些特有的操作。</p>
<p>现在您可以花一点时间运行 UseFloatBuffer.java，它包含了类型化的缓冲区的一个应用例子。</p>
<h3 id="-2-4-"><a href=""></a>2.4）什么是通道</h3>
<p>Channel
是一个对象，可以通过它读取和写入数据。拿 NIO 与原来的 I/O 做个比较，通道就像是流。</p>
<p>正如前面提到的，所有数据都通过 </p>
<p>Buffer
 对象来处理。您永远不会将字节直接写入通道中，相反，您是将数据写入包含一个或者多个字节的缓冲区。同样，您不会直接从通道中读取字节，而是将数据从通道读入缓冲区，再从缓冲区获取这个字节。</p>
<h3 id="-2-5-"><a href=""></a>2.5）通道类型</h3>
<p>通道与流的不同之处在于通道是双向的。而流只是在一个方向上移动(一个流必须是 </p>
<p>InputStream
 或者 </p>
<p>OutputStream
 的子类)， 而 </p>
<p>通道 
可以用于读、写或者同时用于读写。因为它们是双向的，所以通道可以比流更好地反映底层操作系统的真实情况。特别是在 UNIX 模型中，底层操作系统通道是双向的。</p>
<h2 id="-3-nio-"><a href=""></a>3、从理论到实践：NIO的读和写</h2>
<h3 id="-3-1-"><a href=""></a>3.1）概述</h3>
<p>读和写是 I/O 的基本过程。从一个通道中读取很简单：只需创建一个缓冲区，然后让通道将数据读到这个缓冲区中。写入也相当简单：创建一个缓冲区，用数据填充它，然后让通道用这些数据来执行写入操作。</p>
<p>在本节中，我们将学习有关在 Java 程序中读取和写入数据的一些知识。我们将回顾 NIO 的主要组件(缓冲区、通道和一些相关的方法)，看看它们是如何交互以进行读写的。在接下来的几节中，我们将更详细地分析这其中的每个组件以及其交互。<strong>所有例子代码下载请点击<a href="http://www.ibm.com/developerworks/cn/education/java/j-nio/nio-src.zip" target="_blank">例子代码</a>。</strong></p>
<h3 id="-3-2-"><a href=""></a>3.2）从文件中读取</h3>
<p>在我们第一个练习中，我们将从一个文件中读取一些数据。如果使用原来的 I/O，那么我们只需创建一个 </p>
<p>FileInputStream
 并从它那里读取。而在 NIO 中，情况稍有不同：我们首先从 </p>
<p>FileInputStream
 获取一个 </p>
<p>FileInputStream
 对象，然后使用这个通道来读取数据。</p>
<p>在 NIO 系统中，任何时候执行一个读操作，您都是从通道中读取，但是您<strong>不是直接*</strong> *从通道读取。因为所有数据最终都驻留在缓冲区中，所以您是从通道读到缓冲区中。</p>
<p>因此读取文件涉及三个步骤：(1) 从 </p>
<p>FileInputStream
 获取 </p>
<p>Channel
，(2) 创建 </p>
<p>Buffer
，(3) 将数据从 </p>
<p>Channel
 读到 </p>
<p>Buffer 
中。现在，让我们看一下这个过程。</p>
<h3 id="-3-3-"><a href=""></a>3.3）三个容易的步骤</h3>
<p>第一步是获取通道。我们从 </p>
<p>FileInputStream
 获取通道：
FileInputStream fin = new FileInputStream( &quot;readandshow.txt&quot; );</p>
<p>FileChannel fc = fin.getChannel();</p>
<p>下一步是创建缓冲区：
ByteBuffer buffer = ByteBuffer.allocate( 1024 );</p>
<p>最后，需要将数据从通道读到缓冲区中，如下所示：
fc.read( buffer );</p>
<p>您会注意到，我们不需要告诉通道要读 <em>多少数据 </em>到缓冲区中。每一个缓冲区都有复杂的内部统计机制，它会跟踪已经读了多少数据以及还有多少空间可以容纳更多的数据。我们将在 <strong>缓冲区内部细节</strong> 中介绍更多关于缓冲区统计机制的内容。</p>
<h3 id="-3-4-"><a href=""></a>3.4）写入文件</h3>
<p>在 NIO 中写入文件类似于从文件中读取。首先从 </p>
<p>FileOutputStream
 获取一个通道：
FileOutputStream fout = new FileOutputStream( &quot;writesomebytes.txt&quot; );</p>
<p>FileChannel fc = fout.getChannel();</p>
<p>下一步是创建一个缓冲区并在其中放入一些数据 - 在这里，数据将从一个名为 </p>
<p>message
 的数组中取出，这个数组包含字符串 &quot;Some bytes&quot; 的 ASCII 字节(本教程后面将会解释 </p>
<p>buffer.flip()
 和 </p>
<p>buffer.put()
 调用)。
ByteBuffer buffer = ByteBuffer.allocate( 1024 );</p>
<p>for (int i=0; i&lt;message.length; ++i) {</p>
<pre><code> buffer.put( message[i] );
</code></pre><p>}</p>
<p>buffer.flip();</p>
<p>最后一步是写入通道中：
fc.write( buffer );</p>
<p>注意在这里同样不需要告诉通道要写入多数据。缓冲区的内部统计机制会跟踪它包含多少数据以及还有多少数据要写入。</p>
<h3 id="-3-5-"><a href=""></a>3.5）读写结合</h3>
<p>下面我们将看一下在结合读和写时会有什么情况。我们以一个名为 CopyFile.java 的简单程序作为这个练习的基础，它将一个文件的所有内容拷贝到另一个文件中。CopyFile.java 执行三个基本操作：首先创建一个 </p>
<p>Buffer
，然后从源文件中将数据读到这个缓冲区中，然后将缓冲区写入目标文件。这个程序不断重复 ― 读、写、读、写 ― 直到源文件结束。</p>
<p>CopyFile 程序让您看到我们如何检查操作的状态，以及如何使用 </p>
<p>clear()
 和 </p>
<p>flip()
 方法重设缓冲区，并准备缓冲区以便将新读取的数据写到另一个通道中。</p>
<h3 id="-copyfile-"><a href=""></a>运行CopyFile例子</h3>
<p>因为缓冲区会跟踪它自己的数据，所以 CopyFile 程序的内部循环 (inner loop) 非常简单，如下所示：
fcin.read( buffer );</p>
<p>fcout.write( buffer );</p>
<p>第一行将数据从输入通道 </p>
<p>fcin
 中读入缓冲区，第二行将这些数据写到输出通道 </p>
<p>fcout
 。</p>
<h3 id="-"><a href=""></a>检查状态</h3>
<p>下一步是检查拷贝何时完成。当没有更多的数据时，拷贝就算完成，并且可以在 </p>
<p>read()
 方法返回 -1 是判断这一点，如下所示：
int r = fcin.read( buffer );</p>
<p>if (r==-1) {</p>
<pre><code> break;
</code></pre><p>}</p>
<h3 id="-"><a href=""></a>重设缓冲区</h3>
<p>最后，在从输入通道读入缓冲区之前，我们调用 </p>
<p>clear()
 方法。同样，在将缓冲区写入输出通道之前，我们调用 </p>
<p>flip()
 方法，如下所示：</p>
<p>buffer.clear();</p>
<p>int r = fcin.read( buffer );</p>
<p>if (r==-1) {
     break;</p>
<p>}</p>
<p>buffer.flip();
fcout.write( buffer );</p>
<p>clear()
 方法重设缓冲区，使它可以接受读入的数据。 </p>
<p>flip()
 方法让缓冲区可以将新读入的数据写入另一个通道。</p>
<p>来源： <a href="[http://blog.csdn.net/ssjhust123/article/details/7904757](http://blog.csdn.net/ssjhust123/article/details/7904757)">[http://blog.csdn.net/ssjhust123/article/details/7904757](http://blog.csdn.net/ssjhust123/article/details/7904757)</a> </p>
<p><a href="http://blog.csdn.net/ssjhust123/article/details/7905278" target="_blank">（二）—缓冲区原理</a></p>
<h2 id="4-">4、缓冲区的内部细节</h2>
<h3 id="-"><a href=""></a><strong>概述</strong></h3>
<p>本节将介绍 NIO 中两个重要的缓冲区组件：状态变量和访问方法 (accessor)。</p>
<p>状态变量是前一节中提到的&quot;内部统计机制&quot;的关键。每一个读/写操作都会改变缓冲区的状态。通过记录和跟踪这些变化，缓冲区就可能够内部地管理自己的资源。</p>
<p>在从通道读取数据时，数据被放入到缓冲区。在有些情况下，可以将这个缓冲区直接写入另一个通道，但是在一般情况下，您还需要查看数据。这是使用 <em>访问方法 </em></p>
<p>get()
 来完成的。同样，如果要将原始数据放入缓冲区中，就要使用访问方法 </p>
<p>put()
。</p>
<p>在本节中，您将学习关于 NIO 中的状态变量和访问方法的内容。我们将描述每一个组件，并让您有机会看到它的实际应用。虽然 NIO 的内部统计机制初看起来可能很复杂，但是您很快就会看到大部分的实际工作都已经替您完成了。您可能习惯于通过手工编码进行簿记 ― 即使用字节数组和索引变量，现在它已在 NIO 中内部地处理了。</p>
<h3 id="-"><a href=""></a>状态变量</h3>
<p>可以用三个值指定缓冲区在任意时刻的状态：</p>
<ul>
<li>position</li>
<li>limit</li>
<li>capacity</li>
</ul>
<p>这三个变量一起可以跟踪缓冲区的状态和它所包含的数据。我们将在下面的小节中详细分析每一个变量，还要介绍它们如何适应典型的读/写(输入/输出)进程。在这个例子中，我们假定要将数据从一个输入通道拷贝到一个输出通道。</p>
<h3 id="-position"><a href=""></a>position</h3>
<p>您可以回想一下，缓冲区实际上就是美化了的数组。在从通道读取时，您将所读取的数据放到底层的数组中。 </p>
<p>position
 变量跟踪已经写了多少数据。更准确地说，它指定了下一个字节将放到数组的哪一个元素中。因此，如果您从通道中读三个字节到缓冲区中，那么缓冲区的 </p>
<p>position
 将会设置为3，指向数组中第四个元素。</p>
<p>同样，在写入通道时，您是从缓冲区中获取数据。 </p>
<p>position
 值跟踪从缓冲区中获取了多少数据。更准确地说，它指定下一个字节来自数组的哪一个元素。因此如果从缓冲区写了5个字节到通道中，那么缓冲区的 </p>
<p>position
 将被设置为5，指向数组的第六个元素。</p>
<h3 id="-"><a href=""></a></h3>
<p>limit</p>
<p>limit
 变量表明还有多少数据需要取出(在从缓冲区写入通道时)，或者还有多少空间可以放入数据(在从通道读入缓冲区时)。</p>
<p>position
 总是小于或者等于 </p>
<p>limit
。</p>
<h3 id="-capacity-"><a href=""></a><strong>capacity</strong></h3>
<p>缓冲区的 </p>
<p>capacity
 表明可以储存在缓冲区中的最大数据容量。实际上，它指定了底层数组的大小 ― 或者至少是指定了准许我们使用的底层数组的容量。</p>
<p>limit
 决不能大于 </p>
<p>capacity
。</p>
<h3 id="-"><a href=""></a><strong>观察变量</strong></h3>
<p>我们首先观察一个新创建的缓冲区。出于本例子的需要，我们假设这个缓冲区的 </p>
<p>总容量 
为8个字节。 </p>
<p>Buffer
 的状态如下所示：
<img src="" alt="Buffer state"> </p>
<p>回想一下 ，</p>
<p>limit
 决不能大于 </p>
<p>capacity
，此例中这两个值都被设置为 8。我们通过将它们指向数组的尾部之后(如果有第8个槽，则是第8个槽所在的位置)来说明这点。
<img src="" alt="Array"> </p>
<p>position
 设置为0。如果我们读一些数据到缓冲区中，那么下一个读取的数据就进入 slot 0 。如果我们从缓冲区写一些数据，从缓冲区读取的下一个字节就来自 slot 0 。 </p>
<p>position
 设置如下所示：
<img src="" alt="Position setting"> </p>
<p>由于 </p>
<p>capacity
 不会改变，所以我们在下面的讨论中可以忽略它。</p>
<h3 id="-"><a href=""></a><strong>第一次读取</strong></h3>
<p>现在我们可以开始在新创建的缓冲区上进行读/写操作。首先从输入通道中读一些数据到缓冲区中。第一次读取得到三个字节。它们被放到数组中从 </p>
<p>position
 开始的位置，这时 position 被设置为 0。读完之后，position 就增加到 3，如下所示：
<img src="" alt="Position increased to 3"> </p>
<p>limit
 没有改变。</p>
<h3 id="-"><a href=""></a><strong>第二次读取</strong></h3>
<p>在第二次读取时，我们从输入通道读取另外两个字节到缓冲区中。这两个字节储存在由 </p>
<p>position
 所指定的位置上， </p>
<p>position
 因而增加 2：
<img src="" alt="Position increased by 2"> </p>
<p>limit
 没有改变。</p>
<h3 id="-flip-"><a href=""></a><strong>flip</strong></h3>
<p>现在我们要将数据写到输出通道中。在这之前，我们必须调用 </p>
<p>flip()
 方法。这个方法做两件非常重要的事：</p>
<ol>
<li>它将 </li>
</ol>
<p>limit
 设置为当前 </p>
<p>position
。</p>
<ol>
<li>它将 </li>
</ol>
<p>position
 设置为 0。</p>
<p>前一小节中的图显示了在 flip 之前缓冲区的情况。下面是在 flip 之后的缓冲区：
<img src="" alt="Buffer after the flip"> </p>
<p>我们现在可以将数据从缓冲区写入通道了。 </p>
<p>position
 被设置为 0，这意味着我们得到的下一个字节是第一个字节。 </p>
<p>limit
 已被设置为原来的 </p>
<p>position
，这意味着它包括以前读到的所有字节，并且一个字节也不多。</p>
<h3 id="-"><a href=""></a><strong>第一次写入</strong></h3>
<p>在第一次写入时，我们从缓冲区中取四个字节并将它们写入输出通道。这使得 </p>
<p>position
 增加到 4，而 </p>
<p>limit
 不变，如下所示：
<img src="" alt="Position advanced to 4, limit unchanged"> </p>
<h3 id="-"><a href=""></a><strong>第二次写入</strong></h3>
<p>我们只剩下一个字节可写了。 </p>
<p>limit
在我们调用 </p>
<p>flip()
 时被设置为 5，并且 </p>
<p>position
 不能超过 </p>
<p>limit
。所以最后一次写入操作从缓冲区取出一个字节并将它写入输出通道。这使得 </p>
<p>position
 增加到 5，并保持 </p>
<p>limit
 不变，如下所示：
<img src="" alt="Position advanced to 5, limit unchanged"> </p>
<h3 id="-clear-"><a href=""></a><strong>clear</strong></h3>
<p>最后一步是调用缓冲区的 </p>
<p>clear()
 方法。这个方法重设缓冲区以便接收更多的字节。 </p>
<p>Clear
 做两种非常重要的事情：</p>
<ol>
<li>它将 </li>
</ol>
<p>limit
 设置为与 </p>
<p>capacity
 相同。</p>
<ol>
<li>它设置 </li>
</ol>
<p>position
 为 0。</p>
<p>下图显示了在调用 </p>
<p>clear()
 后缓冲区的状态：
<img src="" alt="State of the buffer after clear() has been called"> </p>
<p>缓冲区现在可以接收新的数据了。</p>
<p><strong>访问方法</strong></p>
<p>到目前为止，我们只是使用缓冲区将数据从一个通道转移到另一个通道。然而，程序经常需要直接处理数据。例如，您可能需要将用户数据保存到磁盘。在这种情况下，您必须将这些数据直接放入缓冲区，然后用通道将缓冲区写入磁盘。</p>
<p>或者，您可能想要从磁盘读取用户数据。在这种情况下，您要将数据从通道读到缓冲区中，然后检查缓冲区中的数据。</p>
<p>在本节的最后，我们将详细分析如何使用 </p>
<p>ByteBuffer
 类的 </p>
<p>get()
 和 </p>
<p>put()
 方法直接访问缓冲区中的数据</p>
<h3 id="-"><a href=""></a></h3>
<p>get()方法</p>
<p>ByteBuffer
 类中有四个 </p>
<p>get()
 方法：</p>
<ol>
<li>byte get();</li>
<li>ByteBuffer get( byte dst[] );</li>
<li>ByteBuffer get( byte dst[], int offset, int length );</li>
<li>byte get( int index );</li>
</ol>
<p>第一个方法获取单个字节。第二和第三个方法将一组字节读到一个数组中。第四个方法从缓冲区中的特定位置获取字节。那些返回</p>
<p>ByteBuffer
 的方法只是返回调用它们的缓冲区的 </p>
<p>this
 值。</p>
<p>此外，我们认为前三个 </p>
<p>get()
 方法是相对的，而最后一个方法是绝对的。 <em>相对 </em>意味着 </p>
<p>get()
 操作服从 </p>
<p>limit
 和 </p>
<p>position
 值 ― 更明确地说，字节是从当前 </p>
<p>position
 读取的，而 </p>
<p>position
 在 </p>
<p>get
 之后会增加。另一方面，一个 <em>绝对 </em>方法会忽略 </p>
<p>limit
 和 </p>
<p>position
 值，也不会影响它们。事实上，它完全绕过了缓冲区的统计方法。</p>
<p>上面列出的方法对应于 </p>
<p>ByteBuffer
 类。其他类有等价的 </p>
<p>get()
 方法，这些方法除了不是处理字节外，其它方面是是完全一样的，它们处理的是与该缓冲区类相适应的类型。</p>
<h3 id="-put-"><a href=""></a><strong>put()方法</strong></h3>
<p>ByteBuffer
 类中有五个 </p>
<p>put()
 方法：</p>
<ol>
<li>ByteBuffer put( byte b );</li>
<li>ByteBuffer put( byte src[] );</li>
<li>ByteBuffer put( byte src[], int offset, int length );</li>
<li>ByteBuffer put( ByteBuffer src );</li>
<li>ByteBuffer put( int index, byte b );</li>
</ol>
<p>第一个方法 </p>
<p>写入（put） 
单个字节。第二和第三个方法写入来自一个数组的一组字节。第四个方法将数据从一个给定的源</p>
<p>ByteBuffer
 写入这个 </p>
<p>ByteBuffer
。第五个方法将字节写入缓冲区中特定的 </p>
<p>位置 
。那些返回 </p>
<p>ByteBuffer
 的方法只是返回调用它们的缓冲区的 </p>
<p>this
 值。</p>
<p>与 </p>
<p>get()
 方法一样，我们将把 </p>
<p>put()
 方法划分为 <em>相对 </em>或者 <em>绝对 </em>的。前四个方法是相对的，而第五个方法是绝对的。</p>
<p>上面显示的方法对应于 </p>
<p>ByteBuffer
 类。其他类有等价的 </p>
<p>put()
 方法，这些方法除了不是处理字节之外，其它方面是完全一样的。它们处理的是与该缓冲区类相适应的类型。</p>
<h3 id="-get-put-"><a href=""></a>类型化的 get() 和 put() 方法</h3>
<p>除了前些小节中描述的 </p>
<p>get()
 和 </p>
<p>put()
 方法， </p>
<p>ByteBuffer
 还有用于读写不同类型的值的其他方法，如下所示：</p>
<ul>
<li>getByte()</li>
<li>getChar()</li>
<li>getShort()</li>
<li>getInt()</li>
<li>getLong()</li>
<li>getFloat()</li>
<li>getDouble()</li>
<li>putByte()</li>
<li>putChar()</li>
<li>putShort()</li>
<li>putInt()</li>
<li>putLong()</li>
<li>putFloat()</li>
<li>putDouble()</li>
</ul>
<p>事实上，这其中的每个方法都有两种类型 ― 一种是相对的，另一种是绝对的。它们对于读取格式化的二进制数据（如图像文件的头部）很有用。</p>
<p>您可以在例子程序 TypesInByteBuffer.java 中看到这些方法的实际应用。</p>
<h3 id="-"><a href=""></a><strong>缓冲区的使用：一个内部循环</strong></h3>
<p>下面的内部循环概括了使用缓冲区将数据从输入通道拷贝到输出通道的过程。
while (true) {</p>
<pre><code> buffer.clear();
 int r = fcin.read( buffer );


 if (r==-1) {

   break;
 }


 buffer.flip();

 fcout.write( buffer );
</code></pre><p>}</p>
<p>read()
 和 </p>
<p>write()
 调用得到了极大的简化，因为许多工作细节都由缓冲区完成了。 </p>
<p>clear()
 和 </p>
<p>flip()
 方法用于让缓冲区在读和写之间切换。</p>
<p>5、关于缓冲区的更多内容</p>
<p><strong>概述</strong></p>
<p>到目前为止，您已经学习了使用缓冲区进行日常工作所需要掌握的大部分内容。我们的例子没怎么超出标准的读/写过程种类，在原来的 I/O 中可以像在 NIO 中一样容易地实现这样的标准读写过程。</p>
<p>本节将讨论使用缓冲区的一些更复杂的方面，比如缓冲区分配、包装和分片。我们还会讨论 NIO 带给 Java 平台的一些新功能。您将学到如何创建不同类型的缓冲区以达到不同的目的，如可保护数据不被修改的 <em>只读 </em>缓冲区，和直接映射到底层操作系统缓冲区的 <em>直接 </em>缓冲区。我们将在本节的最后介绍如何在 NIO 中创建内存映射文件。</p>
<p><strong>缓冲区分配和包装</strong></p>
<p>在能够读和写之前，必须有一个缓冲区。要创建缓冲区，您必须 <em>分配 </em>它。我们使用静态方法 </p>
<p>allocate()
 来分配缓冲区：
ByteBuffer buffer = ByteBuffer.allocate( 1024 );</p>
<p>allocate()
 方法分配一个具有指定大小的底层数组，并将它包装到一个缓冲区对象中 ― 在本例中是一个 </p>
<p>ByteBuffer
。</p>
<p>您还可以将一个现有的数组转换为缓冲区，如下所示：
byte array[] = new byte[1024];</p>
<p>ByteBuffer buffer = ByteBuffer.wrap( array );</p>
<p>本例使用了 </p>
<p>wrap()
 方法将一个数组包装为缓冲区。必须非常小心地进行这类操作。一旦完成包装，底层数据就可以通过缓冲区或者直接访问。</p>
<p><strong>缓冲区分片</strong></p>
<p>slice()
 方法根据现有的缓冲区创建一种 <em>子缓冲区 </em>。也就是说，它创建一个新的缓冲区，新缓冲区与原来的缓冲区的一部分共享数据。</p>
<p>使用例子可以最好地说明这点。让我们首先创建一个长度为 10 的 </p>
<p>ByteBuffer
：
ByteBuffer buffer = ByteBuffer.allocate( 10 );</p>
<p>然后使用数据来填充这个缓冲区，在第 <em>n</em> 个槽中放入数字 <em>n</em>：
for (int i=0; i&lt;buffer.capacity(); ++i) {</p>
<pre><code> buffer.put( (byte)i );
</code></pre><p>}</p>
<p>现在我们对这个缓冲区 <em>分片 </em>，以创建一个包含槽 3 到槽 6 的子缓冲区。在某种意义上，子缓冲区就像原来的缓冲区中的一个 <em>窗口 </em>。</p>
<p>窗口的起始和结束位置通过设置 </p>
<p>position
 和 </p>
<p>limit
 值来指定，然后调用 </p>
<p>Buffer
 的 </p>
<p>slice()
 方法：
buffer.position( 3 );</p>
<p>buffer.limit( 7 );
ByteBuffer slice = buffer.slice();</p>
<p>片段
是缓冲区的 </p>
<p>子缓冲区 
。不过， </p>
<p>片段
和 </p>
<p>缓冲区
共享同一个底层数据数组，我们在下一节将会看到这一点。</p>
<p><strong>缓冲区分片和数据共享</strong></p>
<p>我们已经创建了原缓冲区的子缓冲区，并且我们知道缓冲区和子缓冲区共享同一个底层数据数组。让我们看看这意味着什么。</p>
<p>我们遍历子缓冲区，将每一个元素乘以 11 来改变它。例如，5 会变成 55。
for (int i=0; i&lt;slice.capacity(); ++i) {</p>
<pre><code> byte b = slice.get( i );
 b /*= 11;

 slice.put( i, b );
</code></pre><p>}</p>
<p>最后，再看一下原缓冲区中的内容：
buffer.position( 0 );</p>
<p>buffer.limit( buffer.capacity() );</p>
<p>while (buffer.remaining()&gt;0) {
     System.out.println( buffer.get() );</p>
<p>}</p>
<p>结果表明只有在子缓冲区窗口中的元素被改变了：
$ java SliceBuffer</p>
<p>0
1</p>
<p>2
33</p>
<p>44
55</p>
<p>66
7</p>
<p>8
9</p>
<p>缓冲区片对于促进抽象非常有帮助。可以编写自己的函数处理整个缓冲区，而且如果想要将这个过程应用于子缓冲区上，您只需取主缓冲区的一个片，并将它传递给您的函数。这比编写自己的函数来取额外的参数以指定要对缓冲区的哪一部分进行操作更容易。</p>
<p><strong>只读缓冲区</strong></p>
<p>只读缓冲区非常简单 ― 您可以读取它们，但是不能向它们写入。可以通过调用缓冲区的 </p>
<p>asReadOnlyBuffer()
 方法，将任何常规缓冲区转换为只读缓冲区，这个方法返回一个与原缓冲区完全相同的缓冲区(并与其共享数据)，只不过它是只读的。</p>
<p>只读缓冲区对于保护数据很有用。在将缓冲区传递给某个对象的方法时，您无法知道这个方法是否会修改缓冲区中的数据。创建一个只读的缓冲区可以 <em>保证 </em>该缓冲区不会被修改。</p>
<p>不能将只读的缓冲区转换为可写的缓冲区。</p>
<p><strong>直接和间接缓冲区</strong></p>
<p>另一种有用的 </p>
<p>ByteBuffer
 是直接缓冲区。 <em>直接缓冲区 </em>是为加快 I/O 速度，而以一种特殊的方式分配其内存的缓冲区。</p>
<p>实际上，直接缓冲区的准确定义是与实现相关的。Sun 的文档是这样描述直接缓冲区的：</p>
<p><em>给定一个直接字节缓冲区，Java 虚拟机将尽最大努力直接对它执行本机 I/O 操作。也就是说，它会在每一次调用底层操作系统的本机 I/O 操作之前(或之后)，尝试避免将缓冲区的内容拷贝到一个中间缓冲区中(或者从一个中间缓冲区中拷贝数据)。</em></p>
<p>您可以在例子程序 FastCopyFile.java 中看到直接缓冲区的实际应用，这个程序是 CopyFile.java 的另一个版本，它使用了直接缓冲区以提高速度。</p>
<p>还可以用内存映射文件创建直接缓冲区。</p>
<p><strong>[java]</strong> <a href="http://blog.csdn.net/ssjhust123/article/details/7905278#" title="view plain" target="_blank">view plain</a><a href="http://blog.csdn.net/ssjhust123/article/details/7905278#" title="copy" target="_blank">copy</a></p>
<ol>
<li>ByteBuffer buffer = ByteBuffer.allocateDirect( 1024 ); //直接缓冲区  </li>
</ol>
<p><strong>内存映射文件I/O</strong></p>
<p>内存映射文件 I/O 是一种读和写文件数据的方法，它可以比常规的基于流或者基于通道的 I/O 快得多。</p>
<p>内存映射文件 I/O 是通过使文件中的数据神奇般地出现为内存数组的内容来完成的。这其初听起来似乎不过就是将整个文件读到内存中，但是事实上并不是这样。一般来说，只有文件中实际读取或者写入的部分才会送入（或者 <em>映射 </em>）到内存中。</p>
<p>内存映射并不真的神奇或者多么不寻常。现代操作系统一般根据需要将文件的部分映射为内存的部分，从而实现文件系统。Java 内存映射机制不过是在底层操作系统中可以采用这种机制时，提供了对该机制的访问。</p>
<p>尽管创建内存映射文件相当简单，但是向它写入可能是危险的。仅只是改变数组的单个元素这样的简单操作，就可能会直接修改磁盘上的文件。修改数据与将数据保存到磁盘是没有分开的。</p>
<p><strong>将文件映射到内存</strong></p>
<p>了解内存映射的最好方法是使用例子。在下面的例子中，我们要将一个 </p>
<p>FileChannel
 (它的全部或者部分)映射到内存中。为此我们将使用 </p>
<p>FileChannel.map()
 方法。下面代码行将文件的前 1024 个字节映射到内存中：
MappedByteBuffer mbb = fc.map( FileChannel.MapMode.READ_WRITE,</p>
<pre><code> 0, 1024 );
</code></pre><p>map()
 方法返回一个 </p>
<p>MappedByteBuffer
，它是 </p>
<p>ByteBuffer
 的子类。因此，您可以像使用其他任何 </p>
<p>ByteBuffer
 一样使用新映射的缓冲区，操作系统会在需要时负责执行行映射。
来源： <a href="[http://blog.csdn.net/ssjhust123/article/details/7905278](http://blog.csdn.net/ssjhust123/article/details/7905278)">[http://blog.csdn.net/ssjhust123/article/details/7905278](http://blog.csdn.net/ssjhust123/article/details/7905278)</a> </p>
<p><a href="http://blog.csdn.net/ssjhust123/article/details/7905367" target="_blank">（三）—分散聚集、文件锁定、字符集</a></p>
<h2 id="6-">6、分散和聚集</h2>
<p><strong>概述</strong></p>
<p>分散/聚集 I/O 是使用多个而不是单个缓冲区来保存数据的读写方法。</p>
<p>一个分散的读取就像一个常规通道读取，只不过它是将数据读到一个缓冲区数组中而不是读到单个缓冲区中。同样地，一个聚集写入是向缓冲区数组而不是向单个缓冲区写入数据。分散/聚集 I/O 对于将数据流划分为单独的部分很有用，这有助于实现复杂的数据格式。</p>
<p><strong>分散/聚集IO</strong></p>
<p>通道可以有选择地实现两个新的接口： </p>
<p>ScatteringByteChannel
 和 </p>
<p>GatheringByteChannel
。一个 </p>
<p>ScatteringByteChannel
 是一个具有两个附加读方法的通道：</p>
<ul>
<li>long read( ByteBuffer[] dsts );</li>
<li>long read( ByteBuffer[] dsts, int offset, int length );</li>
</ul>
<p>这些 </p>
<p>long read()
 方法很像标准的 </p>
<p>read
 方法，只不过它们不是取单个缓冲区而是取一个缓冲区数组。</p>
<p>在 <em>分散读取 </em>中，通道依次填充每个缓冲区。填满一个缓冲区后，它就开始填充下一个。在某种意义上，缓冲区数组就像一个大缓冲区。</p>
<p><em>聚集写入 </em>类似于分散读取，只不过是用来写入。它也有接受缓冲区数组的方法：</p>
<ul>
<li>long write( ByteBuffer[] srcs );</li>
<li>long write( ByteBuffer[] srcs, int offset, int length );</li>
</ul>
<p>聚集写对于把一组单独的缓冲区中组成单个数据流很有用。为了与上面的消息例子保持一致，您可以使用聚集写入来自动将网络消息的各个部分组装为单个数据流，以便跨越网络传输消息。</p>
<p>从例子程序 UseScatterGather.java 中可以看到分散读取和聚集写入的实际应用。</p>
<p><strong>分散/聚集的应用</strong></p>
<p>分散/聚集 I/O 对于将数据划分为几个部分很有用。例如，您可能在编写一个使用消息对象的网络应用程序，每一个消息被划分为固定长度的头部和固定长度的正文。您可以创建一个刚好可以容纳头部的缓冲区和另一个刚好可以容难正文的缓冲区。当您将它们放入一个数组中并使用分散读取来向它们读入消息时，头部和正文将整齐地划分到这两个缓冲区中。</p>
<p>我们从缓冲区所得到的方便性对于缓冲区数组同样有效。因为每一个缓冲区都跟踪自己还可以接受多少数据，所以分散读取会自动找到有空间接受数据的第一个缓冲区。在这个缓冲区填满后，它就会移动到下一个缓冲区。</p>
<h2 id="-7-"><a href=""></a>7、文件锁定</h2>
<p><strong>概述</strong></p>
<p>文件锁定初看起来可能让人迷惑。它 <em>似乎 </em>指的是防止程序或者用户访问特定文件。事实上，文件锁就像常规的 Java 对象锁 ― 它们是 <em>劝告式的（advisory） </em>锁。它们不阻止任何形式的数据访问，相反，它们通过锁的共享和获取赖允许系统的不同部分相互协调。</p>
<p>您可以锁定整个文件或者文件的一部分。如果您获取一个排它锁，那么其他人就不能获得同一个文件或者文件的一部分上的锁。如果您获得一个共享锁，那么其他人可以获得同一个文件或者文件一部分上的共享锁，但是不能获得排它锁。文件锁定并不总是出于保护数据的目的。例如，您可能临时锁定一个文件以保证特定的写操作成为原子的，而不会有其他程序的干扰。</p>
<p>大多数操作系统提供了文件系统锁，但是它们并不都是采用同样的方式。有些实现提供了共享锁，而另一些仅提供了排它锁。事实上，有些实现使得文件的锁定部分不可访问，尽管大多数实现不是这样的。</p>
<p>在本节中，您将学习如何在 NIO 中执行简单的文件锁过程，我们还将探讨一些保证被锁定的文件尽可能可移植的方法。</p>
<p><strong>锁定文件</strong></p>
<p>要获取文件的一部分上的锁，您要调用一个打开的 </p>
<p>FileChannel
 上的 </p>
<p>lock()
 方法。注意，如果要获取一个排它锁，您必须以写方式打开文件。
RandomAccessFile raf = new RandomAccessFile( &quot;usefilelocks.txt&quot;, &quot;rw&quot; );</p>
<p>FileChannel fc = raf.getChannel();
FileLock lock = fc.lock( start, end, false );</p>
<p>在拥有锁之后，您可以执行需要的任何敏感操作，然后再释放锁：
lock.release();</p>
<p>在释放锁后，尝试获得锁的其他任何程序都有机会获得它。</p>
<p>本小节的例子程序 UseFileLocks.java 必须与它自己并行运行。这个程序获取一个文件上的锁，持有三秒钟，然后释放它。如果同时运行这个程序的多个实例，您会看到每个实例依次获得锁。如果两个程序分别获取同一个文件不同位置的锁，则不会阻塞。比如第一个程序获取文件范围为0-20的锁，而第二个程序获取21-40的锁，则会正常执行。</p>
<p><strong>文件锁定和可移植性</strong></p>
<p>文件锁定可能是一个复杂的操作，特别是考虑到不同的操作系统是以不同的方式实现锁这一事实。下面的指导原则将帮助您尽可能保持代码的可移植性：</p>
<ul>
<li>只使用排它锁。</li>
<li>将所有的锁视为劝告式的（advisory）。</li>
</ul>
<p>8、字符集</p>
<p><strong>概述</strong></p>
<p>根据 Sun 的文档，一个 </p>
<p>Charset
 是“十六位 Unicode 字符序列与字节序列之间的一个命名的映射”。实际上，一个 </p>
<p>Charset
 允许您以尽可能最具可移植性的方式读写字符序列。</p>
<p>Java 语言被定义为基于 Unicode。然而在实际上，许多人编写代码时都假设一个字符在磁盘上或者在网络流中用一个字节表示。这种假设在许多情况下成立，但是并不是在所有情况下都成立，而且随着计算机变得对 Unicode 越来越友好，这个假设就日益变得不能成立了。</p>
<p>在本节中，我们将看一下如何使用 </p>
<p>Charsets
 以适合现代文本格式的方式处理文本数据。这里将使用的示例程序相当简单，不过，它触及了使用 </p>
<p>Charset
 的所有关键方面：为给定的字符编码创建 </p>
<p>Charset
，以及使用该 </p>
<p>Charset
 解码和编码文本数据。</p>
<p><a href="http://www.ibm.com/developerworks/cn/education/java/j-nio/section10.html#ibm-pcon" target="_blank">回页首</a></p>
<p><strong>编码/解码</strong></p>
<p>要读和写文本，我们要分别使用 </p>
<p>CharsetDecoder
 和 </p>
<p>CharsetEncoder
。将它们称为 <em>编码器 </em>和 <em>解码器 </em>是有道理的。一个 <em>字符 </em>不再表示一个特定的位模式，而是表示字符系统中的一个实体。因此，由某个实际的位模式表示的字符必须以某种特定的 <em>编码 </em>来表示。</p>
<p>CharsetDecoder
 用于将逐位表示的一串字符转换为具体的 </p>
<p>char
 值。同样，一个 </p>
<p>CharsetEncoder
 用于将字符转换回位。</p>
<p>在下一个小节中，我们将考察一个使用这些对象来读写数据的程序。</p>
<p><a href="http://www.ibm.com/developerworks/cn/education/java/j-nio/section10.html#ibm-pcon" target="_blank">回页首</a></p>
<p><strong>处理文本的正确方式</strong></p>
<p>现在我们将分析这个例子程序 UseCharsets.java。这个程序非常简单 ― 它从一个文件中读取一些文本，并将该文本写入另一个文件。但是它把该数据当作文本数据，并使用 </p>
<p>CharBuffer
 来将该数句读入一个 </p>
<p>CharsetDecoder
 中。同样，它使用 </p>
<p>CharsetEncoder
 来写回该数据。</p>
<p>我们将假设字符以 ISO-8859-1(Latin1) 字符集（这是 ASCII 的标准扩展）的形式储存在磁盘上。尽管我们必须为使用 Unicode 做好准备，但是也必须认识到不同的文件是以不同的格式储存的，而 ASCII 无疑是非常普遍的一种格式。事实上，每种 Java 实现都要求对以下字符编码提供完全的支持：</p>
<ul>
<li>US-ASCII</li>
<li>ISO-8859-1</li>
<li>UTF-8</li>
<li>UTF-16BE</li>
<li>UTF-16LE</li>
<li>UTF-16</li>
</ul>
<p><a href="http://www.ibm.com/developerworks/cn/education/java/j-nio/section10.html#ibm-pcon" target="_blank">回页首</a></p>
<p><strong>示例程序</strong></p>
<p>在打开相应的文件、将输入数据读入名为 </p>
<p>inputData
 的 </p>
<p>ByteBuffer
 之后，我们的程序必须创建 ISO-8859-1 (Latin1) 字符集的一个实例：
Charset latin1 = Charset.forName( &quot;ISO-8859-1&quot; );</p>
<p>然后，创建一个解码器（用于读取）和一个编码器 （用于写入）：
CharsetDecoder decoder = latin1.newDecoder();</p>
<p>CharsetEncoder encoder = latin1.newEncoder();</p>
<p>为了将字节数据解码为一组字符，我们把 </p>
<p>ByteBuffer
 传递给 </p>
<p>CharsetDecoder
，结果得到一个 </p>
<p>CharBuffer
：
CharBuffer cb = decoder.decode( inputData );</p>
<p>如果想要处理字符，我们可以在程序的此处进行。但是我们只想无改变地将它写回，所以没有什么要做的。</p>
<p>要写回数据，我们必须使用 </p>
<p>CharsetEncoder
 将它转换回字节：
ByteBuffer outputData = encoder.encode( cb );</p>
<p>在转换完成之后，我们就可以将数据写到文件中了。
来源： <a href="[http://blog.csdn.net/ssjhust123/article/details/7905367](http://blog.csdn.net/ssjhust123/article/details/7905367)">[http://blog.csdn.net/ssjhust123/article/details/7905367](http://blog.csdn.net/ssjhust123/article/details/7905367)</a> <a href="http://blog.csdn.net/ssjhust123/article/details/7905401" target="_blank">（四）—网络和异步IO</a></p>
<p>9、连网和异步 I/O</p>
<p><strong>概述</strong></p>
<p>连网是学习异步 I/O 的很好基础，而异步 I/O 对于在 Java 语言中执行任何输入/输出过程的人来说，无疑都是必须具备的知识。NIO 中的连网与 NIO 中的其他任何操作没有什么不同 ― 它依赖通道和缓冲区，而您通常使用 </p>
<p>InputStream
 和 </p>
<p>OutputStream
 来获得通道。</p>
<p>本节首先介绍异步 I/O 的基础 ― 它是什么以及它不是什么，然后转向更实用的、程序性的例子。</p>
<p><strong>异步I/O</strong></p>
<p>异步 I/O 是一种 <em>没有阻塞地 </em>读写数据的方法。通常，在代码进行 </p>
<p>read()
 调用时，代码会阻塞直至有可供读取的数据。同样，</p>
<p>write()
 调用将会阻塞直至数据能够写入。</p>
<p>另一方面，异步 I/O 调用不会阻塞。相反，您将注册对特定 I/O 事件的兴趣 ― 可读的数据的到达、新的套接字连接，等等，而在发生这样的事件时，系统将会告诉您。</p>
<p>异步 I/O 的一个优势在于，它允许您同时根据大量的输入和输出执行 I/O。同步程序常常要求助于轮询，或者创建许许多多的线程以处理大量的连接。使用异步 I/O，您可以监听任何数量的通道上的事件，不用轮询，也不用额外的线程。</p>
<p>我们将通过研究一个名为 MultiPortEcho.java 的例子程序来查看异步 I/O 的实际应用。这个程序就像传统的 <em>echo server</em>，它接受网络连接并向它们回响它们可能发送的数据。不过它有一个附加的特性，就是它能同时监听多个端口，并处理来自所有这些端口的连接。并且它只在单个线程中完成所有这些工作。</p>
<p><strong>Selectors</strong></p>
<p>本节的阐述对应于 </p>
<p>MultiPortEcho
 的源代码中的 </p>
<p>go()
 方法的实现，因此应该看一下源代码，以便对所发生的事情有个更全面的了解。</p>
<p>异步 I/O 中的核心对象名为 </p>
<p>Selector
。</p>
<p>Selector
 就是您注册对各种 I/O 事件的兴趣的地方，而且当那些事件发生时，就是这个对象告诉您所发生的事件。</p>
<p>所以，我们需要做的第一件事就是创建一个 </p>
<p>Selector
：
Selector selector = Selector.open();</p>
<p>然后，我们将对不同的通道对象调用 </p>
<p>register()
 方法，以便注册我们对这些对象中发生的 I/O 事件的兴趣。</p>
<p>register()
 的第一个参数总是这个 </p>
<p>Selector
。</p>
<p><strong>打开一个Server Socket Channel</strong></p>
<p>为了接收连接，我们需要一个 </p>
<p>ServerSocketChannel
。事实上，我们要监听的每一个端口都需要有一个 </p>
<p>ServerSocketChannel
 。对于每一个端口，我们打开一个 </p>
<p>ServerSocketChannel
，如下所示：
ServerSocketChannel ssc = ServerSocketChannel.open();</p>
<p>ssc.configureBlocking( false );</p>
<p>ServerSocket ss = ssc.socket();
InetSocketAddress address = new InetSocketAddress( ports[i] );</p>
<p>ss.bind( address );</p>
<p>第一行创建一个新的 </p>
<p>ServerSocketChannel
 ，最后三行将它绑定到给定的端口。第二行将 </p>
<p>ServerSocketChannel
 设置为 <em>非阻塞的 </em>。我们必须对每一个要使用的套接字通道调用这个方法，否则异步 I/O 就不能工作。</p>
<p><strong>选择键</strong></p>
<p>下一步是将新打开的 </p>
<p>ServerSocketChannels
 注册到 </p>
<p>Selector
上。为此我们使用 ServerSocketChannel.register() 方法，如下所示：
SelectionKey key = ssc.register( selector, SelectionKey.OP_ACCEPT );</p>
<p>register()
 的第一个参数总是这个 </p>
<p>Selector
。第二个参数是 </p>
<p>OP_ACCEPT
，这里它指定我们想要监听 <em>accept</em> 事件，也就是在新的连接建立时所发生的事件。这是适用于 </p>
<p>ServerSocketChannel
 的唯一事件类型。</p>
<p>请注意对 </p>
<p>register()
 的调用的返回值。 </p>
<p>SelectionKey
 代表这个通道在此 </p>
<p>Selector
 上的这个注册。当某个 </p>
<p>Selector
 通知您某个传入事件时，它是通过提供对应于该事件的 </p>
<p>SelectionKey
 来进行的。</p>
<p>SelectionKey
 还可以用于取消通道的注册。</p>
<p><strong>内部循环</strong></p>
<p>现在已经注册了我们对一些 I/O 事件的兴趣，下面将进入主循环。使用 </p>
<p>Selectors
 的几乎每个程序都像下面这样使用内部循环：
int num = selector.select();</p>
<p>Set selectedKeys = selector.selectedKeys();</p>
<p>Iterator it = selectedKeys.iterator();</p>
<p>while (it.hasNext()) {
     SelectionKey key = (SelectionKey)it.next();</p>
<pre><code> // ... deal with I/O event ...
</code></pre><p>}</p>
<p>首先，我们调用 </p>
<p>Selector
 的 </p>
<p>select()
 方法。这个方法会阻塞，直到至少有一个已注册的事件发生。当一个或者更多的事件发生时，</p>
<p>select()
 方法将返回所发生的事件的数量。</p>
<p>接下来，我们调用 </p>
<p>Selector
 的 </p>
<p>selectedKeys()
 方法，它返回发生了事件的 </p>
<p>SelectionKey
 对象的一个 </p>
<p>集合 
。</p>
<p>我们通过迭代 </p>
<p>SelectionKeys
 并依次处理每个 </p>
<p>SelectionKey
 来处理事件。对于每一个 </p>
<p>SelectionKey
，您必须确定发生的是什么 I/O 事件，以及这个事件影响哪些 I/O 对象。</p>
<p><strong>监听新连接</strong></p>
<p>程序执行到这里，我们仅注册了 </p>
<p>ServerSocketChannel
，并且仅注册它们“接收”事件。为确认这一点，我们对 </p>
<p>SelectionKey
 调用</p>
<p>readyOps()
 方法，并检查发生了什么类型的事件：
if ((key.readyOps() &amp; SelectionKey.OP_ACCEPT)</p>
<pre><code> == SelectionKey.OP_ACCEPT) {


 // Accept the new connection
 // ...
</code></pre><p>}</p>
<p>可以肯定地说， </p>
<p>readOps()
 方法告诉我们该事件是新的连接。</p>
<p><strong>接收新的连接</strong></p>
<p>因为我们知道这个服务器套接字上有一个传入连接在等待，所以可以安全地接受它；也就是说，不用担心 </p>
<p>accept()
 操作会阻塞：
ServerSocketChannel ssc = (ServerSocketChannel)key.channel();</p>
<p>SocketChannel sc = ssc.accept();</p>
<p>下一步是将新连接的 </p>
<p>SocketChannel
 配置为非阻塞的。而且由于接受这个连接的目的是为了读取来自套接字的数据，所以我们还必须将 </p>
<p>SocketChannel
 注册到 </p>
<p>Selector
上，如下所示：
sc.configureBlocking( false );</p>
<p>SelectionKey newKey = sc.register( selector, SelectionKey.OP_READ );</p>
<p>注意我们使用 </p>
<p>register()
 的 </p>
<p>OP_READ
 参数，将 </p>
<p>SocketChannel
 注册用于 <em>读取 </em>而不是 <em>接受 </em>新连接。</p>
<p><strong>删除处理过的SelectionKey</strong></p>
<p>在处理 </p>
<p>SelectionKey
 之后，我们几乎可以返回主循环了。但是我们必须首先将处理过的 </p>
<p>SelectionKey
 从选定的键集合中删除。如果我们没有删除处理过的键，那么它仍然会在主集合中以一个激活的键出现，这会导致我们尝试再次处理它。我们调用迭代器的</p>
<p>remove()
 方法来删除处理过的 </p>
<p>SelectionKey
：
it.remove();</p>
<p>现在我们可以返回主循环并接受从一个套接字中传入的数据(或者一个传入的 I/O 事件)了。</p>
<p><strong>传入的I/O</strong></p>
<p>当来自一个套接字的数据到达时，它会触发一个 I/O 事件。这会导致在主循环中调用 </p>
<p>Selector.select()
，并返回一个或者多个 I/O 事件。这一次， </p>
<p>SelectionKey
 将被标记为 </p>
<p>OP_READ
 事件，如下所示：
} else if ((key.readyOps() &amp; SelectionKey.OP_READ)</p>
<pre><code> == SelectionKey.OP_READ) {
 // Read the data

 SocketChannel sc = (SocketChannel)key.channel();
 // ...
</code></pre><p>}</p>
<p>与以前一样，我们取得发生 I/O 事件的通道并处理它。在本例中，由于这是一个 echo server，我们只希望从套接字中读取数据并马上将它发送回去。关于这个过程的细节，请参见代码中的源代码 (MultiPortEcho.java)。</p>
<p><strong>回到主循环</strong></p>
<p>每次返回主循环，我们都要调用 </p>
<p>select
 的 </p>
<p>Selector()
方法，并取得一组 </p>
<p>SelectionKey
。每个键代表一个 I/O 事件。我们处理事件，从选定的键集中删除 </p>
<p>SelectionKey
，然后返回主循环的顶部。</p>
<p>这个程序有点过于简单，因为它的目的只是展示异步 I/O 所涉及的技术。在现实的应用程序中，您需要通过将通道从 </p>
<p>Selector
 中删除来处理关闭的通道。而且您可能要使用多个线程。这个程序可以仅使用一个线程，因为它只是一个演示，但是在现实场景中，创建一个线程池来负责 I/O 事件处理中的耗时部分会更有意义。
来源： <a href="[http://blog.csdn.net/ssjhust123/article/details/7905401](http://blog.csdn.net/ssjhust123/article/details/7905401)">[http://blog.csdn.net/ssjhust123/article/details/7905401](http://blog.csdn.net/ssjhust123/article/details/7905401)</a> </p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li></span><span class="breadcrumb"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li><li><a href="/categories/Java&J2EE/NIO/">NIO</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Java&J2EE/" class="label label-primary">Java&J2EE</a><a href="/tags/NIO/" class="label label-success">NIO</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:41"datetime="2014-03-07 09:54:41"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-NIO--JAVANIO总结/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JavaJ2EE-NIO--JAVANIO总结" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JavaJ2EE-NIO--Javaaio异步网络IO初探/">Java aio(异步网络IO)初探</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:41.000Z"> <a href="/2014/02/02/2014-02-02-JavaJ2EE-NIO--Javaaio异步网络IO初探/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="java-aio-io-">Java aio(异步网络IO)初探</h1>
<p><a href="">&lt;</a> <a href="">&gt;</a>  猎头职位: <a href="http://www.iteye.com/jobs/2509" target="_blank">上海:  Junior Product Manager</a></p>
<p>相关文章: <a href="&quot;关闭&quot;"> </a></p>
<ul>
<li><a href="http://www.iteye.com/topic/1113611" title="JDK7 AIO 初体验" target="_blank">JDK7 AIO 初体验</a></li>
<li><a href="http://www.iteye.com/topic/446298" title="JavaSE7新特性 异步非阻塞I/O 网络通信 AIO" target="_blank">JavaSE7新特性 异步非阻塞I/O 网络通信 AIO</a></li>
<li><p><a href="http://www.iteye.com/topic/834447" title="JAVA NIO 简介" target="_blank">JAVA NIO 简介</a>
推荐群组: <a href="http://dlang.group.iteye.com/" target="_blank">D语言</a>
<a href="http://www.iteye.com/wiki/topic/472333" target="_blank">更多相关推荐</a>
<a href="http://www.iteye.com/forums/tag/%E4%BC%81%E4%B8%9A%E5%BA%94%E7%94%A8" target="_blank">企业应用</a></p>
<p>  按照《Unix网络编程》的划分，IO模型可以分为：阻塞IO、非阻塞IO、IO复用、信号驱动IO和异步IO，按照POSIX标准来划分只分为两类：同步IO和异步IO。如何区分呢？首先一个IO操作其实分成了两个步骤：发起IO请求和实际的IO操作，同步IO和异步IO的区别就在于第二个步骤是否阻塞，如果实际的IO读写阻塞请求进程，那么就是同步IO，因此阻塞IO、非阻塞IO、IO服用、信号驱动IO都是同步IO，如果不阻塞，而是操作系统帮你做完IO操作再将结果返回给你，那么就是异步IO。阻塞IO和非阻塞IO的区别在于第一步，发起IO请求是否会被阻塞，如果阻塞直到完成那么就是传统的阻塞IO，如果不阻塞，那么就是非阻塞IO。
 Java nio 2.0的主要改进就是引入了异步IO（包括文件和网络），这里主要介绍下异步网络IO API的使用以及框架的设计，以TCP服务端为例。首先看下为了支持AIO引入的新的类和接口：
<strong>java.nio.channels.AsynchronousChannel</strong></p>
<pre><code> 标记一个channel支持异步IO操作。
</code></pre><p><strong> java.nio.channels.AsynchronousServerSocketChannel</strong></p>
<pre><code> ServerSocket的aio版本，创建TCP服务端，绑定地址，监听端口等。
</code></pre><p><strong> java.nio.channels.AsynchronousSocketChannel</strong></p>
<pre><code> 面向流的异步socket channel，表示一个连接。
</code></pre><p><strong> java.nio.channels.AsynchronousChannelGroup</strong></p>
<pre><code> 异步channel的分组管理，目的是为了资源共享。一个AsynchronousChannelGroup绑定一个线程池，这个线程池执行两个任务：处理IO事件和派发CompletionHandler。AsynchronousServerSocketChannel创建的时候可以传入一个 AsynchronousChannelGroup，那么通过AsynchronousServerSocketChannel创建的 AsynchronousSocketChannel将同属于一个组，共享资源。
</code></pre><p><strong> java.nio.channels.CompletionHandler</strong></p>
<pre><code> 异步IO操作结果的回调接口，用于定义在IO操作完成后所作的回调工作。AIO的API允许两种方式来处理异步操作的结果：返回的Future模式或者注册CompletionHandler，我更推荐用CompletionHandler的方式，这些handler的调用是由 AsynchronousChannelGroup的线程池派发的。显然，线程池的大小是性能的关键因素。AsynchronousChannelGroup允许绑定不同的线程池，通过三个静态方法来创建：
</code></pre></li>
</ul>
<p>Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>public static AsynchronousChannelGroup withFixedThreadPool(int nThreads,  </li>
<li>ThreadFactory threadFactory)  </li>
<li>throws IOException  </li>
<li></li>
<li>public static AsynchronousChannelGroup withCachedThreadPool(ExecutorService executor,  </li>
<li>int initialSize)  </li>
<li></li>
<li>public static AsynchronousChannelGroup withThreadPool(ExecutorService executor)  </li>
<li>throws IOException  </li>
</ol>
<p>public static AsynchronousChannelGroup withFixedThreadPool(int nThreads,</p>
<pre><code>                                                           ThreadFactory threadFactory)
    throws IOException
</code></pre><p>public static AsynchronousChannelGroup withCachedThreadPool(ExecutorService executor,</p>
<pre><code>                                                            int initialSize)
</code></pre><p>public static AsynchronousChannelGroup withThreadPool(ExecutorService executor)
        throws IOException</p>
<pre><code> 需要根据具体应用相应调整，从框架角度出发，需要暴露这样的配置选项给用户。
 在介绍完了aio引入的TCP的主要接口和类之后，我们来设想下一个aio框架应该怎么设计。参考非阻塞nio框架的设计，一般都是采用**Reactor**模式，Reacot负责事件的注册、select、事件的派发；相应地，异步IO有个**Proactor**模式，Proactor负责 CompletionHandler的派发，查看一个典型的IO写操作的流程来看两者的区别：
 Reactor:  send(msg) -&gt; 消息队列是否为空，如果为空  -&gt; 向Reactor注册OP_WRITE，然后返回 -&gt; Reactor select -&gt; 触发Writable，通知用户线程去处理 -&gt;先注销Writable(很多人遇到的cpu 100%的问题就在于没有注销）,处理Writeable，如果没有完全写入，继续注册OP_WRITE。注意到，写入的工作还是用户线程在处理。
 Proactor: send(msg) -&gt; 消息队列是否为空，如果为空,发起read异步调用，并注册CompletionHandler，然后返回。 -&gt; 操作系统负责将你的消息写入，并返回结果（写入的字节数）给Proactor -&gt; Proactor派发CompletionHandler。可见，写入的工作是操作系统在处理，无需用户线程参与。事实上在aio的API 中,**AsynchronousChannelGroup就扮演了Proactor的角色**。
CompletionHandler有三个方法，分别对应于处理成功、失败、被取消（通过返回的Future)情况下的回调处理：
</code></pre><p>Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>public interface CompletionHandler<V,A> {  </li>
<li></li>
<li>void completed(V result, A attachment);  </li>
<li></li>
<li>void failed(Throwable exc, A attachment);  </li>
<li></li>
<li></li>
<li>void cancelled(A attachment);  </li>
<li>}  </li>
</ol>
<p>public interface CompletionHandler<V,A> {</p>
<pre><code> void completed(V result, A attachment);


void failed(Throwable exc, A attachment);




void cancelled(A attachment);
</code></pre><p>}</p>
<pre><code>其中的泛型参数V表示IO调用的结果，而A是发起调用时传入的attchment。
在初步介绍完aio引入的类和接口后，我们看看一个典型的tcp服务端是怎么启动的，怎么接受连接并处理读和写，这里引用的代码都是yanf4j 的aio分支中的代码，可以从svn checkout，svn地址: [http://yanf4j.googlecode.com/svn/branches/yanf4j-aio](http://yanf4j.googlecode.com/svn/branches/yanf4j-aio)
第一步，创建一个AsynchronousServerSocketChannel，创建之前先创建一个 AsynchronousChannelGroup，上文提到AsynchronousServerSocketChannel可以绑定一个 AsynchronousChannelGroup，那么通过这个AsynchronousServerSocketChannel建立的连接都将同属于一个AsynchronousChannelGroup并共享资源：
</code></pre><p>Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>this.asynchronousChannelGroup = AsynchronousChannelGroup  </li>
<li>.withCachedThreadPool(Executors.newCachedThreadPool(),  </li>
<li>this.threadPoolSize);  </li>
</ol>
<p>this.asynchronousChannelGroup = AsynchronousChannelGroup</p>
<pre><code>                .withCachedThreadPool(Executors.newCachedThreadPool(),
                        this.threadPoolSize);

 然后初始化一个AsynchronousServerSocketChannel，通过open方法：
</code></pre><p>Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>this.serverSocketChannel = AsynchronousServerSocketChannel  </li>
<li>.open(this.asynchronousChannelGroup);  </li>
</ol>
<p>this.serverSocketChannel = AsynchronousServerSocketChannel</p>
<pre><code>            .open(this.asynchronousChannelGroup);


通过nio 2.0引入的SocketOption类设置一些TCP选项：
</code></pre><p>Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>this.serverSocketChannel  </li>
<li>.setOption(  </li>
<li>StandardSocketOption.SO_REUSEADDR,true);  </li>
<li>this.serverSocketChannel  </li>
<li>.setOption(  </li>
<li>StandardSocketOption.SO_RCVBUF,16/*1024);  </li>
</ol>
<p>this.serverSocketChannel</p>
<pre><code>                .setOption(
                        StandardSocketOption.SO_REUSEADDR,true);
</code></pre><p>this.serverSocketChannel
                    .setOption(</p>
<pre><code>                        StandardSocketOption.SO_RCVBUF,16/*1024);


绑定本地地址：
</code></pre><p>Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>this.serverSocketChannel  </li>
<li>.bind(new InetSocketAddress(&quot;localhost&quot;,8080), 100);  </li>
</ol>
<p>this.serverSocketChannel</p>
<pre><code>                .bind(new InetSocketAddress(&quot;localhost&quot;,8080), 100);



其中的100用于指定等待连接的队列大小(backlog)。完了吗？还没有，最重要的**监听**工作还没开始，监听端口是为了等待连接上来以便accept产生一个AsynchronousSocketChannel来表示一个新建立的连接，因此需要发起一个accept调用，调用是异步的，操作系统将在连接建立后，将最后的结果——**AsynchronousSocketChannel**返回给你：
</code></pre><p>Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>public void pendingAccept() {  </li>
<li>if (this.started &amp;&amp; this.serverSocketChannel.isOpen()) {  </li>
<li>this.acceptFuture = this.serverSocketChannel.accept(null,  </li>
<li>new AcceptCompletionHandler());  </li>
<li></li>
<li>} else {  </li>
<li>throw new IllegalStateException(&quot;Controller has been closed&quot;);  </li>
<li>}  </li>
<li>}  </li>
</ol>
<p>public void pendingAccept() {</p>
<pre><code>    if (this.started &amp;&amp; this.serverSocketChannel.isOpen()) {
        this.acceptFuture = this.serverSocketChannel.accept(null,

                new AcceptCompletionHandler());


    } else {
        throw new IllegalStateException(&quot;Controller has been closed&quot;);

    }
}
</code></pre><p>   注意，重复的accept调用将会抛出PendingAcceptException，后文提到的read和write也是如此。accept方法的第一个参数是你想传给CompletionHandler的attchment，第二个参数就是注册的用于回调的CompletionHandler，最后返回结果Future<AsynchronousSocketChannel>。你可以对future做处理，这里采用更推荐的方式就是注册一个CompletionHandler。那么accept的CompletionHandler中做些什么工作呢？显然一个赤裸裸的 AsynchronousSocketChannel是不够的，我们需要将它封装成session，一个session表示一个连接（mina里就叫 IoSession了），里面带了一个缓冲的消息队列以及一些其他资源等。在连接建立后，除非你的服务器只准备接受一个连接，不然你需要在后面<strong>继续调用pendingAccept来发起另一个accept请求</strong>：</p>
<p>Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>private final class AcceptCompletionHandler implements  </li>
<li>CompletionHandler<AsynchronousSocketChannel, Object> {  </li>
<li></li>
<li>@Override  </li>
<li>public void cancelled(Object attachment) {  </li>
<li>logger.warn(&quot;Accept operation was canceled&quot;);  </li>
<li>}  </li>
<li></li>
<li>@Override  </li>
<li>public void completed(AsynchronousSocketChannel socketChannel,  </li>
<li>Object attachment) {  </li>
<li>try {  </li>
<li>logger.debug(&quot;Accept connection from &quot;  </li>
<li><ul>
<li>socketChannel.getRemoteAddress());  </li>
</ul>
</li>
<li>configureChannel(socketChannel);  </li>
<li>AioSessionConfig sessionConfig = buildSessionConfig(socketChannel);  </li>
<li>Session session = new AioTCPSession(sessionConfig,  </li>
<li>AioTCPController.this.configuration  </li>
<li>.getSessionReadBufferSize(),  </li>
<li>AioTCPController.this.sessionTimeout);  </li>
<li>session.start();  </li>
<li>registerSession(session);  </li>
<li>} catch (Exception e) {  </li>
<li>e.printStackTrace();  </li>
<li>logger.error(&quot;Accept error&quot;, e);  </li>
<li>notifyException(e);  </li>
<li>} finally {  </li>
<li><strong>pendingAccept</strong>();  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>@Override  </li>
<li>public void failed(Throwable exc, Object attachment) {  </li>
<li>logger.error(&quot;Accept error&quot;, exc);  </li>
<li>try {  </li>
<li>notifyException(exc);  </li>
<li>} finally {  </li>
<li><strong>pendingAccept</strong>();  </li>
<li>}  </li>
<li>}  </li>
<li>}  </li>
</ol>
<p>private final class AcceptCompletionHandler implements</p>
<pre><code>        CompletionHandler&lt;AsynchronousSocketChannel, Object&gt; {


    @Override
    public void cancelled(Object attachment) {

        logger.warn(&quot;Accept operation was canceled&quot;);
    }


    @Override

    public void completed(AsynchronousSocketChannel socketChannel,
            Object attachment) {

        try {
            logger.debug(&quot;Accept connection from &quot;

                    + socketChannel.getRemoteAddress());
            configureChannel(socketChannel);

            AioSessionConfig sessionConfig = buildSessionConfig(socketChannel);
            Session session = new AioTCPSession(sessionConfig,

                    AioTCPController.this.configuration
                            .getSessionReadBufferSize(),

                    AioTCPController.this.sessionTimeout);
            session.start();

            registerSession(session);
        } catch (Exception e) {

            e.printStackTrace();
            logger.error(&quot;Accept error&quot;, e);

            notifyException(e);
        } finally {
</code></pre><p><strong>pendingAccept</strong></p>
<p>();
            }</p>
<pre><code>    }


    @Override
    public void failed(Throwable exc, Object attachment) {

        logger.error(&quot;Accept error&quot;, exc);
        try {

            notifyException(exc);
        } finally {
</code></pre><p><strong>pendingAccept</strong></p>
<p>();
            }</p>
<pre><code>    }
}



注意到了吧，我们在failed和completed方法中在最后都调用了pendingAccept来继续发起accept调用，等待新的连接上来。有的同学可能要说了，这样搞是不是递归调用，会不会堆栈溢出？实际上不会，因为发起accept调用的线程与CompletionHandler回调的线程并非同一个，不是一个上下文中，两者之间没有耦合关系。要注意到，CompletionHandler的回调共用的是 AsynchronousChannelGroup绑定的线程池，因此**千万别在CompletionHandler回调方法中调用阻塞或者长时间的操作**，例如sleep，回调方法最好能支持超时，防止线程池耗尽。
连接建立后，怎么读和写呢？回忆下在nonblocking nio框架中，连接建立后的第一件事是干什么？注册OP_READ事件等待socket可读。异步IO也同样如此，连接建立后马上发起一个异步read调用，等待socket可读，这个是Session.start方法中所做的事情：
</code></pre><p>Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>public class AioTCPSession {  </li>
<li>protected void start0() {  </li>
<li>pendingRead();  </li>
<li>}  </li>
<li></li>
<li>protected final void pendingRead() {  </li>
<li>if (!isClosed() &amp;&amp; this.asynchronousSocketChannel.isOpen()) {  </li>
<li>if (!this.readBuffer.hasRemaining()) {  </li>
<li>this.readBuffer = ByteBufferUtils  </li>
<li>.increaseBufferCapatity(this.readBuffer);  </li>
<li>}  </li>
<li>this.readFuture = this.asynchronousSocketChannel.read(  </li>
<li>this.readBuffer, this, this.readCompletionHandler);  </li>
<li>} else {  </li>
<li>throw new IllegalStateException(  </li>
<li>&quot;Session Or Channel has been closed&quot;);  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>}  </li>
</ol>
<p>public class AioTCPSession {</p>
<pre><code>protected void start0() {
    pendingRead();

}


protected final void pendingRead() {
    if (!isClosed() &amp;&amp; this.asynchronousSocketChannel.isOpen()) {

        if (!this.readBuffer.hasRemaining()) {
            this.readBuffer = ByteBufferUtils

                    .increaseBufferCapatity(this.readBuffer);
        }

        this.readFuture = this.asynchronousSocketChannel.read(
                this.readBuffer, this, this.readCompletionHandler);

    } else {
        throw new IllegalStateException(

                &quot;Session Or Channel has been closed&quot;);
    }

}
</code></pre><p>}</p>
<pre><code> AsynchronousSocketChannel的read调用与AsynchronousServerSocketChannel的accept调用类似，同样是非阻塞的，返回结果也是一个Future，但是写的结果是整数，表示写入了多少字节，因此read调用返回的是 **Future&lt;Integer&gt;**，方法的第一个参数是读的缓冲区，操作系统将IO读到数据拷贝到这个缓冲区，第二个参数是传递给 CompletionHandler的attchment，第三个参数就是注册的用于回调的CompletionHandler。这里保存了read的结果Future，这是为了在关闭连接的时候能够主动取消调用，accept也是如此。现在可以看看read的CompletionHandler的实现：
</code></pre><p>Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>public final class ReadCompletionHandler implements  </li>
<li>CompletionHandler<Integer, AbstractAioSession> {  </li>
<li></li>
<li>private static final Logger log = LoggerFactory  </li>
<li>.getLogger(ReadCompletionHandler.class);  </li>
<li>protected final AioTCPController controller;  </li>
<li></li>
<li>public ReadCompletionHandler(AioTCPController controller) {  </li>
<li>this.controller = controller;  </li>
<li>}  </li>
<li></li>
<li>@Override  </li>
<li>public void cancelled(AbstractAioSession session) {  </li>
<li>log.warn(&quot;Session(&quot; + session.getRemoteSocketAddress()  </li>
<li><ul>
<li>&quot;) read operation was canceled&quot;);  </li>
</ul>
</li>
<li>}  </li>
<li></li>
<li>@Override  </li>
<li>public void completed(Integer result, AbstractAioSession session) {  </li>
<li>if (log.isDebugEnabled())  </li>
<li>log.debug(&quot;Session(&quot; + session.getRemoteSocketAddress()  </li>
<li><ul>
<li>&quot;) read +&quot; + result + &quot; bytes&quot;);  </li>
</ul>
</li>
<li>if (result &lt; 0) {  </li>
<li>session.close();  </li>
<li>return;  </li>
<li>}  </li>
<li>try {  </li>
<li>if (result &gt; 0) {  </li>
<li>session.updateTimeStamp();  </li>
<li>session.getReadBuffer().flip();  </li>
<li>session.decode();  </li>
<li>session.getReadBuffer().compact();  </li>
<li>}  </li>
<li>} finally {  </li>
<li>try {  </li>
<li>session.pendingRead();  </li>
<li>} catch (IOException e) {  </li>
<li>session.onException(e);  </li>
<li>session.close();  </li>
<li>}  </li>
<li>}  </li>
<li>controller.checkSessionTimeout();  </li>
<li>}  </li>
<li></li>
<li>@Override  </li>
<li>public void failed(Throwable exc, AbstractAioSession session) {  </li>
<li>log.error(&quot;Session read error&quot;, exc);  </li>
<li>session.onException(exc);  </li>
<li>session.close();  </li>
<li>}  </li>
<li></li>
<li>}  </li>
</ol>
<p>public final class ReadCompletionHandler implements</p>
<pre><code>    CompletionHandler&lt;Integer, AbstractAioSession&gt; {


private static final Logger log = LoggerFactory
        .getLogger(ReadCompletionHandler.class);

protected final AioTCPController controller;


public ReadCompletionHandler(AioTCPController controller) {
    this.controller = controller;

}


@Override
public void cancelled(AbstractAioSession session) {

    log.warn(&quot;Session(&quot; + session.getRemoteSocketAddress()
            + &quot;) read operation was canceled&quot;);

}


@Override
public void completed(Integer result, AbstractAioSession session) {

    if (log.isDebugEnabled())
        log.debug(&quot;Session(&quot; + session.getRemoteSocketAddress()

                + &quot;) read +&quot; + result + &quot; bytes&quot;);
    if (result &lt; 0) {

        session.close();
        return;

    }
    try {

        if (result &gt; 0) {
            session.updateTimeStamp();

            session.getReadBuffer().flip();
            session.decode();

            session.getReadBuffer().compact();
        }

    } finally {
        try {

            session.pendingRead();
        } catch (IOException e) {

            session.onException(e);
            session.close();

        }
    }

    controller.checkSessionTimeout();
}


@Override

public void failed(Throwable exc, AbstractAioSession session) {
    log.error(&quot;Session read error&quot;, exc);

    session.onException(exc);
    session.close();

}
</code></pre><p>}</p>
<p>   如果IO读失败，会返回失败产生的异常，这种情况下我们就主动关闭连接，通过session.close()方法，这个方法干了两件事情：关闭channel和取消read调用：</p>
<p>Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>if (null != this.readFuture) {  </li>
<li>this.readFuture.cancel(true);  </li>
<li>}  </li>
<li>this.asynchronousSocketChannel.close();  </li>
</ol>
<p>if (null != this.readFuture) {</p>
<pre><code>        this.readFuture.cancel(true);
    }
</code></pre><p>this.asynchronousSocketChannel.close();</p>
<p>   在读成功的情况下，我们还需要判断结果result是否小于0，<strong>如果小于0就表示对端关闭了</strong>，这种情况下我们也主动关闭连接并返回。如果读到一定字节，也就是result大于0的情况下，我们就尝试从读缓冲区中decode出消息，并派发给业务处理器的回调方法，最终<strong>通过pendingRead继续发起read调用等待socket的下一次可读</strong>。可见，我们并不需要自己去调用channel来进行IO读，而是操作系统帮你直接读到了缓冲区，然后给你一个结果表示读入了多少字节，你处理这个结果即可。而nonblocking IO框架中，是reactor通知用户线程socket可读了，然后用户线程自己去调用read进行实际读操作。这里还有个需要注意的地方，就是decode出来的消息的派发给业务处理器工作最好交给一个线程池来处理，避免阻塞group绑定的线程池。</p>
<p>   IO写的操作与此类似，不过通常写的话我们会在session中关联一个缓冲队列来处理，没有完全写入或者等待写入的消息都存放在队列中，队列为空的情况下发起write调用：</p>
<p>Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>protected void write0(WriteMessage message) {  </li>
<li>boolean needWrite = false;  </li>
<li>synchronized (this.writeQueue) {  </li>
<li>needWrite = this.writeQueue.isEmpty();  </li>
<li>this.writeQueue.offer(message);  </li>
<li>}  </li>
<li>if (needWrite) {  </li>
<li>pendingWrite(message);  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>protected final void pendingWrite(WriteMessage message) {  </li>
<li>message = preprocessWriteMessage(message);  </li>
<li>if (!isClosed() &amp;&amp; this.asynchronousSocketChannel.isOpen()) {  </li>
<li>this.asynchronousSocketChannel.write(message.getWriteBuffer(),  </li>
<li>this, this.writeCompletionHandler);  </li>
<li>} else {  </li>
<li>throw new IllegalStateException(  </li>
<li>&quot;Session Or Channel has been closed&quot;);  </li>
<li>}  </li>
<li><p>}  </p>
<p>protected void write0(WriteMessage message) {</p>
<p>   boolean needWrite = false;
   synchronized (this.writeQueue) {</p>
<pre><code>   needWrite = this.writeQueue.isEmpty();
   this.writeQueue.offer(message);
</code></pre><p>   }
   if (needWrite) {</p>
<pre><code>   pendingWrite(message);
</code></pre><p>   }</p>
<p>}</p>
</li>
</ol>
<pre><code>protected final void pendingWrite(WriteMessage message) {
    message = preprocessWriteMessage(message);

    if (!isClosed() &amp;&amp; this.asynchronousSocketChannel.isOpen()) {
        this.asynchronousSocketChannel.write(message.getWriteBuffer(),

                this, this.writeCompletionHandler);
    } else {

        throw new IllegalStateException(
                &quot;Session Or Channel has been closed&quot;);

    }
}




write调用返回的结果与read一样是一个Future&lt;Integer&gt;，而write的CompletionHandler处理的核心逻辑大概是这样：
</code></pre><p>Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>@Override  </li>
<li>public void completed(Integer result, AbstractAioSession session) {  </li>
<li>if (log.isDebugEnabled())  </li>
<li>log.debug(&quot;Session(&quot; + session.getRemoteSocketAddress()  </li>
<li><ul>
<li>&quot;) writen &quot; + result + &quot; bytes&quot;);  </li>
</ul>
</li>
<li></li>
<li>WriteMessage writeMessage;  </li>
<li>Queue<WriteMessage> writeQueue = session.getWriteQueue();  </li>
<li>synchronized (writeQueue) {  </li>
<li>writeMessage = writeQueue.peek();  </li>
<li>if (writeMessage.getWriteBuffer() == null  </li>
<li>|| !writeMessage.getWriteBuffer().hasRemaining()) {  </li>
<li>writeQueue.remove();  </li>
<li>if (writeMessage.getWriteFuture() != null) {  </li>
<li>writeMessage.getWriteFuture().setResult(Boolean.TRUE);  </li>
<li>}  </li>
<li>try {  </li>
<li>session.getHandler().onMessageSent(session,  </li>
<li>writeMessage.getMessage());  </li>
<li>} catch (Exception e) {  </li>
<li>session.onException(e);  </li>
<li>}  </li>
<li>writeMessage = writeQueue.peek();  </li>
<li>}  </li>
<li>}  </li>
<li>if (writeMessage != null) {  </li>
<li>try {  </li>
<li>session.pendingWrite(writeMessage);  </li>
<li>} catch (IOException e) {  </li>
<li>session.onException(e);  </li>
<li>session.close();  </li>
<li>}  </li>
<li>}  </li>
<li>}  </li>
</ol>
<p>@Override</p>
<pre><code>public void completed(Integer result, AbstractAioSession session) {
    if (log.isDebugEnabled())

        log.debug(&quot;Session(&quot; + session.getRemoteSocketAddress()
                + &quot;) writen &quot; + result + &quot; bytes&quot;);


    WriteMessage writeMessage;

    Queue&lt;WriteMessage&gt; writeQueue = session.getWriteQueue();
    synchronized (writeQueue) {

        writeMessage = writeQueue.peek();
        if (writeMessage.getWriteBuffer() == null

                || !writeMessage.getWriteBuffer().hasRemaining()) {
            writeQueue.remove();

            if (writeMessage.getWriteFuture() != null) {
                writeMessage.getWriteFuture().setResult(Boolean.TRUE);

            }
            try {

                session.getHandler().onMessageSent(session,
                        writeMessage.getMessage());

            } catch (Exception e) {
                session.onException(e);

            }
            writeMessage = writeQueue.peek();

        }
    }

    if (writeMessage != null) {
        try {

            session.pendingWrite(writeMessage);
        } catch (IOException e) {

            session.onException(e);
            session.close();

        }
    }

}
</code></pre><p>   compete方法中的result就是实际写入的字节数，然后我们判断消息的缓冲区是否还有剩余，如果没有就将消息从队列中移除，如果队列中还有消息，那么继续发起write调用。
   重复一下，这里引用的代码都是yanf4j aio分支中的源码，感兴趣的朋友可以直接check out出来看看: <a href="http://yanf4j.googlecode.com/svn/branches/yanf4j-aio" target="_blank"><a href="http://yanf4j.googlecode.com/svn/branches/yanf4j-aio">http://yanf4j.googlecode.com/svn/branches/yanf4j-aio</a></a>。
   在引入了aio之后，java对于网络层的支持已经非常完善，该有的都有了，java也已经成为服务器开发的首选语言之一。java的弱项在于对内存的管理上，由于这一切都交给了GC，因此在高性能的网络服务器上还是Cpp的天下。java这种单一堆模型比之erlang的进程内堆模型还是有差距，很难做到高效的垃圾回收和细粒度的内存管理。
   这里仅仅是介绍了aio开发的核心流程，对于一个网络框架来说，还需要考虑超时的处理、缓冲buffer的处理、业务层和网络层的切分、可扩展性、性能的可调性以及一定的通用性要求。</p>
<p>刚看了一点，第一行有个错别字，不是IO服用，是复用，嘿嘿
老大终于开始介绍java NIO了。。
还有一点，看过一些源代码，对事件驱动还是理解不深，也请老大介绍下把。
rain2005 写道</p>
<p>刚看了一点，第一行有个错别字，不是IO服用，是复用，嘿嘿
老大终于开始介绍java NIO了。。
还有一点，看过一些源代码，对事件驱动还是理解不深，也请老大介绍下把。
多谢指正，关于事件机制，我会画个UML图可能比较清晰</p>
<p>上面提到几个类 怎么在jdk6中没发现那
是不是要下载第三方框架
正好想研究一下
收藏啦
xly_971223 写道</p>
<p>上面提到几个类 怎么在jdk6中没发现那
是不是要下载第三方框架
正好想研究一下
收藏啦
aio是在jdk7引入的，请下载JDK7 preview1版本，或者open jdk</p>
<p>dennis_zane 写道</p>
<p>xly_971223 写道</p>
<p>上面提到几个类 怎么在jdk6中没发现那
是不是要下载第三方框架
正好想研究一下
收藏啦
aio是在jdk7引入的，请下载JDK7 preview1版本，或者open jdk
是不是这个意思。
jdk7以前的nio是非阻塞IO,操作系统底层比方说linux,是用IO复用select实现的
jdk7用的是真正的异步IO,操作系统底层是用epoll实现的
是这样的吗？
rain2005 写道</p>
<p>dennis_zane 写道</p>
<p>xly_971223 写道</p>
<p>上面提到几个类 怎么在jdk6中没发现那
是不是要下载第三方框架
正好想研究一下
收藏啦
aio是在jdk7引入的，请下载JDK7 preview1版本，或者open jdk
是不是这个意思。
jdk7以前的nio是非阻塞IO,操作系统底层比方说linux,是用IO复用select实现的
jdk7用的是真正的异步IO,操作系统底层是用epoll实现的
是这样的吗？
epoll也不是异步IO啊。异步IO在linux上目前仅限于文件系统，并且还没有得到广泛应用，很多平台都没有这玩意。
java aio在windows上是利用iocp实现的，这是真正的异步IO。而在linux上，是通过epoll模拟的。</p>
<p>楼主，你好，我写的server是p2p的应用，恩，想请教一下，因为我对数据库这一块的操作并不是特别的多，基本是客户自己也有很多是服务器，不知道是否可以在事件响应的当前线程来对数据库操作呢？前提是把线程池子的数目设的大些？或者用那个JDK提供的可自己增加线程的池子？
因为如果在弄个池子来处理数据库的话，担心线程太多了，
你如果时间充分心情好的话，真希望你能讲解一下和别人公用一台服务器（主机）是怎么用的呢。。。
总之要谢谢你对这段代码的讲解，kang sang mi da
wujingsong 写道</p>
<p>楼主，你好，我写的server是p2p的应用，恩，想请教一下，因为我对数据库这一块的操作并不是特别的多，基本是客户自己也有很多是服务器，不知道是否可以在事件响应的当前线程来对数据库操作呢？前提是把线程池子的数目设的大些？或者用那个JDK提供的可自己增加线程的池子？
因为如果在弄个池子来处理数据库的话，担心线程太多了，
你如果时间充分心情好的话，真希望你能讲解一下和别人公用一台服务器（主机）是怎么用的呢。。。
总之要谢谢你对这段代码的讲解，kang sang mi da
按我的经验来说，类似数据库操作这样的IO操作，最好还是起个线程池来处理，防止阻塞框架内部的处理线程。如果这样的操作不是特别多，那么直接在响应线程处理也未尝不可，还是建议你自己搞两个版本性能对比一下。
wujingsong 写道</p>
<p>和别人公用一台是怎么用的呢？
我还真不明白什么意思，现在我们的应用基本都跑在虚拟机上了，几个应用跑在一个物理机上。虚拟化我不懂，就不乱弹了。</p>
<p>kang sa mi da,谢谢楼主的回复,确实是个很好的建议.
闲聊啊,今天无意看到Google 上一个音乐的图片链接,点进去后,看到了一个不大容易理解的词,说什么
            &quot;在南中国常年保持高收听率的极有个性的节目&quot;,
费解.....广东那边是这么叫的吗?不大可能吧..</p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li></span><span class="breadcrumb"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li><li><a href="/categories/Java&J2EE/NIO/">NIO</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Java&J2EE/" class="label label-primary">Java&J2EE</a><a href="/tags/NIO/" class="label label-success">NIO</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:41"datetime="2014-03-07 09:54:41"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-NIO--Javaaio异步网络IO初探/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JavaJ2EE-NIO--Javaaio异步网络IO初探" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>





<ul id="pagination" class="pagination pagination-lg">
  <li><a class="extend prev" href="/page/58/">&laquo;</a></li><li><a class="page-number" href="/">1</a></li><li><a class="page-number" href="/page/2/">2</a></li><li><span class="space">&hellip;</span></li><li><a class="page-number" href="/page/56/">56</a></li><li><a class="page-number" href="/page/57/">57</a></li><li><a class="page-number" href="/page/58/">58</a></li><li class="active"><li><span class="page-number current">59</span></li><li><a class="page-number" href="/page/60/">60</a></li><li><a class="page-number" href="/page/61/">61</a></li><li><a class="page-number" href="/page/62/">62</a></li><li><span class="space">&hellip;</span></li></li><li><a class="page-number" href="/page/164/">164</a></li><li><a class="page-number" href="/page/165/">165</a></li><li><a class="extend next" href="/page/60/">&raquo;</a></li>
  <div class="clearfix"></div>
</ul></div><!--wapper-->
       </div><!-- ID main-col END -->
       <aside id="sidebar" class="alignright col-sx-6 col-sm-4 col-md-3 col-lg-3">
<div id="widget_search" class="widget panel panel-primary">
    <form action="//google.com/search" method="get" accept-charset="utf-8">
  <div class="input-group">
    <input class="form-control" id="searchbox" type="search" name="q" results="0" placeholder="search">
    <span class="input-group-btn">
      <button class="btn btn-default" type="submit">Go!</button>
    </span>
    <input type="hidden" name="q" value="site:itsolife.com">
  </div>
</form>
</div>

<div id="widget_category" class="widget panel panel-primary">
  <div class="panel-heading">category</div>  <div data-src='category' class='ajax_widgets'>正在加载...</div>
</div>

<div id="widget_recent_posts" class="widget panel panel-primary">
  <div class="panel-heading">recent posts</div>  <div data-src='recent_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_tagcloud" class="widget panel panel-primary">
  <div class="panel-heading">tagcloud</div>  <div data-src='tagcloud' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_latest_update_posts" class="widget panel panel-primary">
  <div class="panel-heading">最近更新</div>  <div data-src='latest_update_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_recent_comments" class="widget panel panel-primary">
  <div class="panel-heading">recent comments</div>  

<div class="list-group-item ds-recent-comments" data-num-items="6" data-show-avatars="1" data-show-time="1" data-show-title="1" data-show-admin="1" data-excerpt-length="50"></div>



</div>

</aside>
       <div class="clearfix"></div>
     </div><!-- row END -->
  </div>
  <footer id="footer" class="container">
  <div class="panel panel-info">
  <section id='footer_widget'></section>  <div class="panel-footer">
  <div id="site-info">
    <span class='author'>
  
  &copy; 2014 RobinChia
  
    &nbsp;&nbsp;</span>
  
  <span id='analytics-51la'></span><span id='analytics-google'>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-48559895-1']);
  _gaq.push(['_trackPageview']);
  _js2load.push({src:('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'});
</script></span><span id='analytics-cnzz'>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_5774006'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s17.cnzz.com/stat.php%3Fid%3D5774006%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</span><span id='analytics-baidu'>
<script>
var _hmt = _hmt || [];
_js2load.push({src:"//hm.baidu.com/hm.js?1442f50724afc42380b51f097c43082c"});
</script>
</span>  </div>
  <div id="copyright">Blog powered by <a href='http://zespia.tw/hexo/'><strong>hexo</strong></a> Theme <strong><a href='https://github.com/chenall/hexo-theme-chenall'>chenall</a></strong>(Some change in it)<span class="pull-right"> 更新时间: <em>2014-03-15 15:12:18</em></span></div>
</div>
<div class="clearfix"></div>


  </div>
  </footer>
  
        <script src="http://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>        
        <script src="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>        
                
        <script src="http://cdn.bootcss.com/prettify/r298/prettify.min.js"></script>    <script type="text/javascript">
   var lang=["bsh", "c", "cc", "cpp", "cs", "csh", "cyc", "cv", "htm", "html",
    "java", "js", "m", "mxml", "perl", "pl", "pm", "py", "rb", "sh",
    "xhtml", "xml", "xsl"];
   var pretty_base='';
   $('script').each(function(){
	var c = $(this).attr('src');
	if (!c)
	    return;
	if (c.match(/(\/)?prettify(\.min)?\.js/i))
	{
	    var index = c.lastIndexOf('/');
	    if (index != -1)
		pretty_base = c.substr(0,index + 1);
	    return false;
	}
   })
   $('pre code').each(function(){
	var c = $(this).attr('class')
	if (!c)
	    return;
	c = c.match(/\s?(lang\-\w+)/i);
	if (c && lang.indexOf(c[1]) == -1)
	{
	    lang.push(c[1]);
	    $.getScript(pretty_base + c[1] + '.min.js');
	}
   })

    $(window).load(function(){
       $("pre").addClass("prettyprint");
       prettyPrint();
    })
</script>    
            <script type="text/javascript">
var duoshuoQuery = {short_name:"robinchia"};
_js2load.push({src:'http://static.duoshuo.com/embed.js',charset:'UTF-8'});
</script>
    
            <!--wumii_relatedItems-->
    
        <script src="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>    <script type="text/javascript">
(function($){
  $('.entry').each(function(i){
    $(this).find('img').each(function(){
      var alt = this.alt;

      if (alt){
        $(this).before('<span class="caption">' + alt + '</span>');
      }

      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="fancybox' + i + '" />');
    });
  });

  $('.fancybox').fancybox();
})(jQuery);
</script>    
        <script src="http://cdn.bootcss.com/mathjax/2.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>
    
<script type="text/javascript">
$('.ajax_widgets').each(function(){var src=$(this).attr('data-src');if(src)$(this).load('/widgets/'+src+'.html');});
$.each(_js2load,function(index,obj){loadjs(obj.src,obj.charset)});
</script>

<div id="scroll2top">
<img src="/scroll2top/arrow.png"/>
</div>
<script src="/scroll2top/scroll2top.min.js"></script>
<div id="winterland">
  <canvas></canvas>
</div>
<script src="/js/winterland.min.js"></script>

  </body>
</html>
