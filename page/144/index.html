
<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>The 144 Page | It so life</title>
<meta name="author" content="RobinChia">

<meta name="description" content="It so life">


<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta property="og:site_name" content="It so life"/>

<!--[if IE]><style>.testIE.IE{display:inline;}</style><![endif]-->
<!--[if lte IE 7]><link rel="stylesheet" href="/css/ie7.css" type="text/css"><![endif]-->
<!--[if (lt IE 9)&(gt IE 7)]><style>.testIE.IE8{display:inline;}</style><![endif]-->
<!--[if gt IE 8]><style>.testIE.IE9{display:inline;}</style><![endif]-->

<link href="/favicon.png" rel="icon">
<link rel="alternate" href="/atom.xml" title="It so life Feed" type="application/atom+xml">

<link rel="stylesheet" href="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/font-awesome/4.0.3/css/font-awesome.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/prettify/r298/prettify.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" type="text/css">
<link rel="stylesheet" href="/css/style.css" type="text/css">
<!--[if lt IE 9]>
   <style>article,aside,dialog,footer,header,section,footer,nav,figure,menu{display:block}</style>
   <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
   <script src="http://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
<link href="http://cdn.staticfile.org/respond.js/1.4.2/respond-proxy.html" id="respond-proxy" rel="respond-proxy" />
<link href="/js/respond.proxy.gif" id="respond-redirect" rel="respond-redirect" />
<script src="/js/respond.proxy.js"></script>
   <script src="http://cdn.bootcss.com/selectivizr/1.0.2/selectivizr-min.js"></script>
<![endif]-->
<script type="text/javascript">
function loadjs(c,d){var a=document.createElement("script");a.async=!0;a.type="text/javascript";a.src=c;a.charset=d||"gbk";(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(a)};
var _protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
var _js2load = [];
</script>

</head>
<body>
      <header id="header" class="container"><nav id="main-nav" class="navbar navbar-default navbar-fixed-top " role="navigation">
  <div class="container">
    <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/">It so life</a>
    </div>
    <div  class="collapse navbar-collapse">
      <ul  class="nav navbar-nav">
  
        <li><a href="/" title="Home">Home</a></li>      
        <li><a href="/about/" title="About">About</a></li>      
        <li><a href="/archives/" title="Archives">Archives</a></li>      
      <li class='dropdown'>
        <a class='dropdown-toggle' data-toggle='dropdown' href='#'>website<b class='caret'></b></a>
        <ul class='dropdown-menu pure-menu-selected'>
    
          <li><a href="//groups.google.com/forum/#!forum/pongba" title="TopLanguage">TopLanguage</a></li>    
          <li><a href="//itpub.net/" title="ITPub">ITPub</a></li>    
          <li><a href="//blog.jobbole.com/" title="Bole">Bole</a></li>    
          <li><a href="//nosql-database.org/" title="nosql">nosql</a></li>    
          <li><a href="//gitimmersion.googol.im/" title="Git">Git</a></li>    
        </ul>
      </li>
    
      </ul>
      <ul class="nav navbar-nav navbar-right">
      
        <li><a href="/atom.xml">RSS</a></li>
      
      
        <li><a href="https://twitter.com/robinchia">twitter</a></li>
      
      
      
      
        <li><a href="https://github.com/robinchia">github</a></li>
      
      </ul>
    </div>
  </div>
</nav>
<div class="clearfix"></div>
</header>
  <div id='content' class="container">
     <div class="page-header-wrapper">
      <!--[if lt IE 9]><div class="alert alert-warning alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>提示:</strong>您的浏览器版本太低了,建议升级到 <strong><a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" title="IE9">IE9</a></strong> 以上,本站使用<a href="https://www.google.com/intl/zh-CN/chrome/">Chrome浏览器</a>可以获得最好的显示效果.</div><![endif]-->
      <div class="page-header"><h1 align="center"><big>It so life</big> </h1>
        <h5 align="center"><big>love as life</big></h5>
      </div>
     </div>
     <div class="row">
       <div id="main-col" class="alignleft col-sx-12 col-sm-8 col-md-9 col-lg-9">
      <section id='header_widget'></section>
          <div id="wrapper"><article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-框架汇总-ORM-ibatis--使用ibatis操作数据库的封装/">使用ibatis操作数据库的封装</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:29.000Z"> <a href="/2014/02/02/2014-02-02-框架汇总-ORM-ibatis--使用ibatis操作数据库的封装/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="-ibatis-">使用ibatis操作数据库的封装</h1>
<p><strong><a href="http://blog.csdn.net/boaifeng/article/details/5966940" title="[置顶]使用ibatis操作数据库的封装" target="_blank">使用ibatis操作数据库的封装</a><em>**</em></strong></p>
<p>近期刚进入公司，也是本人的第一份正式工作，公司使用的ORM框架是ibatis，下面代码是对batis dao的一个封装，主要继承自spring的SqlMapClientDaoSupport，负责为单个Entity 提供CRUD操作的IBatis DAO基类，使用该基类，可以减少不少代码量。</p>
<p><a href="http://blog.csdn.net/boaifeng/article/details/5966940" title="view plain" target="_blank">view plain</a><a href="http://blog.csdn.net/boaifeng/article/details/5966940" title="copy to clipboard" target="_blank">copy to clipboard</a><a href="http://blog.csdn.net/boaifeng/article/details/5966940" title="print" target="_blank">print</a><a href="http://blog.csdn.net/boaifeng/article/details/5966940" title="?" target="_blank">?</a></p>
<ol>
<li><p>package com.nfschina.utils.dao.ibatis  </p>
</li>
<li></li>
<li><p>import java.io.Serializable;  </p>
</li>
<li><p>import java.sql.Connection;  </p>
</li>
<li><p>import java.sql.ResultSet;  </p>
</li>
<li><p>import java.sql.SQLException;  </p>
</li>
<li><p>import java.util.HashMap;  </p>
</li>
<li><p>import java.util.List;  </p>
</li>
<li><p>import java.util.Map;  </p>
</li>
<li></li>
<li><p>import org.apache.commons.beanutils.PropertyUtils;  </p>
</li>
<li><p>import org.apache.commons.lang.StringUtils;  </p>
</li>
<li><p>import org.springframework.util.Assert;  </p>
</li>
<li></li>
<li><p>import com.ibatis.sqlmap.engine.impl.SqlMapClientImpl;  </p>
</li>
<li><p>import com.ibatis.sqlmap.engine.mapping.sql.stat.StaticSql;  </p>
</li>
<li><p>import com.ibatis.sqlmap.engine.mapping.statement.MappedStatement;  </p>
</li>
<li></li>
<li><p>importcom.nfschina.utils.BaseException;  </p>
</li>
<li><p>import com.nfschina.utils.DataPage;  </p>
</li>
<li></li>
<li><p>import org.springframework.orm.ibatis.support.SqlMapClientDaoSupport  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* IBatis Dao的泛型基类. </p>
</li>
<li><p>/* 继承于Spring的SqlMapClientDaoSupport,提供分页函数和若干便捷查询方法，并对返回值作了泛型类型转换. </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>@SuppressWarnings(&quot;unchecked&quot;)  </p>
</li>
<li><p>public class IBatisGenericDao extends SqlMapClientDaoSupport {  </p>
</li>
<li></li>
<li><p>public static final String POSTFIX_INSERT = &quot;.insert&quot;;  </p>
</li>
<li></li>
<li><p>public static final String POSTFIX_UPDATE = &quot;.update&quot;;  </p>
</li>
<li></li>
<li><p>public static final String POSTFIX_DELETE = &quot;.delete&quot;;  </p>
</li>
<li></li>
<li><p>public static final String POSTFIX_DELETE_PRIAMARYKEY = &quot;.deleteByPrimaryKey&quot;;  </p>
</li>
<li></li>
<li><p>public static final String POSTFIX_SELECT = &quot;.select&quot;;  </p>
</li>
<li></li>
<li><p>public static final String POSTFIX_SELECTMAP = &quot;.selectByMap&quot;;  </p>
</li>
<li></li>
<li><p>public static final String POSTFIX_SELECTSQL = &quot;.selectBySql&quot;;  </p>
</li>
<li></li>
<li><p>public static final String POSTFIX_COUNT = &quot;.count&quot;;  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 根据ID获取对象 </p>
</li>
<li><p>/*  </p>
</li>
<li><p>/* @throws BaseException </p>
</li>
<li><p>/* @throws SQLException  </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public <T> T get(Class<T> entityClass, Serializable id) throws BaseException, SQLException {  </p>
</li>
<li></li>
<li><p>T o = (T) getSqlMapClient().queryForObject(entityClass.getName() + POSTFIX_SELECT, id);  </p>
</li>
<li><p>if (o == null)  </p>
</li>
<li><p>throw new BaseException(BaseException.DATA_NOTFOUND, &quot;未找到实体: &quot; + id);  </p>
</li>
<li><p>return o;  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 获取全部对象 </p>
</li>
<li><p>/* @throws SQLException  </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public <T> List<T> getAll(Class<T> entityClass) throws SQLException {  </p>
</li>
<li><p>return getSqlMapClient().queryForList(entityClass.getName() + POSTFIX_SELECT, null);  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 新增对象 </p>
</li>
<li><p>/* @throws SQLException  </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public void insert(Object o) throws SQLException {  </p>
</li>
<li><p>getSqlMapClient().insert(o.getClass().getName() + POSTFIX_INSERT, o);  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 保存对象 </p>
</li>
<li><p>/* @throws SQLException  </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public int update(Object o) throws SQLException {  </p>
</li>
<li><p>return getSqlMapClient().update(o.getClass().getName() + POSTFIX_UPDATE, o);  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 删除对象 </p>
</li>
<li><p>/* @throws SQLException  </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public int remove(Object o) throws SQLException {  </p>
</li>
<li><p>return getSqlMapClient().delete(o.getClass().getName() + POSTFIX_DELETE, o);  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 根据ID删除对象 </p>
</li>
<li><p>/* @throws SQLException  </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public <T> int removeById(Class<T> entityClass, Serializable id) throws SQLException {  </p>
</li>
<li><p>return getSqlMapClient().delete(entityClass.getName() + POSTFIX_DELETE_PRIAMARYKEY, id);  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* map查询. </p>
</li>
<li><p>/*  </p>
</li>
<li><p>/* @param map </p>
</li>
<li><p>/*            包含各种属性的查询 </p>
</li>
<li><p>/* @throws SQLException  </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public <T> List<T> find(Class<T> entityClass, Map<String, Object> map) throws SQLException {  </p>
</li>
<li><p>if (map == null)  </p>
</li>
<li><p>return this.getSqlMapClient().queryForList(entityClass.getName() + POSTFIX_SELECT, null);  </p>
</li>
<li><p>else {  </p>
</li>
<li><p>map.put(&quot;findBy&quot;, &quot;True&quot;);  </p>
</li>
<li><p>return this.getSqlMapClient()  </p>
</li>
<li><p>.queryForList(entityClass.getName() + POSTFIX_SELECTMAP, map);  </p>
</li>
<li><p>}  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* sql 查询. </p>
</li>
<li><p>/*  </p>
</li>
<li><p>/* @param sql </p>
</li>
<li><p>/*            直接sql的语句(需要防止注入式攻击) </p>
</li>
<li><p>/* @throws SQLException  </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public <T> List<T> find(Class<T> entityClass, String sql) throws SQLException {  </p>
</li>
<li><p>Assert.hasText(sql);  </p>
</li>
<li><p>if (StringUtils.isEmpty(sql))  </p>
</li>
<li><p>return this.getSqlMapClient().queryForList(entityClass.getName() + POSTFIX_SELECT, null);  </p>
</li>
<li><p>else  </p>
</li>
<li><p>return this.getSqlMapClient()  </p>
</li>
<li><p>.queryForList(entityClass.getName() + POSTFIX_SELECTSQL, sql);  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 根据属性名和属性值查询对象. </p>
</li>
<li><p>/*  </p>
</li>
<li><p>/* @return 符合条件的对象列表 </p>
</li>
<li><p>/* @throws SQLException  </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public <T> List<T> findBy(Class<T> entityClass, String name, Object value) throws SQLException {  </p>
</li>
<li><p>Assert.hasText(name);  </p>
</li>
<li><p>Map<String, Object> map = new HashMap<String, Object>();  </p>
</li>
<li><p>map.put(name, value);  </p>
</li>
<li><p>return find(entityClass, map);  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 根据属性名和属性值查询对象. </p>
</li>
<li><p>/*  </p>
</li>
<li><p>/* @return 符合条件的唯一对象 </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public <T> T findUniqueBy(Class<T> entityClass, String name, Object value) {  </p>
</li>
<li><p>Assert.hasText(name);  </p>
</li>
<li><p>Map<String, Object> map = new HashMap<String, Object>();  </p>
</li>
<li><p>try {  </p>
</li>
<li><p>PropertyUtils.getProperty(entityClass.newInstance(), name);  </p>
</li>
<li><p>map.put(name, value);  </p>
</li>
<li><p>map.put(&quot;findUniqueBy&quot;, &quot;True&quot;);  </p>
</li>
<li><p>return (T) getSqlMapClient().queryForObject(entityClass.getName() + POSTFIX_SELECTMAP,  </p>
</li>
<li><p>map);  </p>
</li>
<li><p>} catch (Exception e) {  </p>
</li>
<li><p>logger.error(&quot;Error when propertie on entity,&quot; + e.getMessage(), e.getCause());  </p>
</li>
<li><p>return null;  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 根据属性名和属性值以Like AnyWhere方式查询对象. </p>
</li>
<li><p>/* @throws SQLException  </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public <T> List<T> findByLike(Class<T> entityClass, String name, String value) throws SQLException {  </p>
</li>
<li><p>Assert.hasText(name);  </p>
</li>
<li><p>Map<String, Object> map = new HashMap<String, Object>();  </p>
</li>
<li><p>map.put(name, value);  </p>
</li>
<li><p>map.put(&quot;findLikeBy&quot;, &quot;True&quot;);  </p>
</li>
<li><p>return getSqlMapClient().queryForList(entityClass.getName() + POSTFIX_SELECTMAP, map);  </p>
</li>
<li></li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 判断对象某些属性的值在数据库中不存在重复 </p>
</li>
<li><p>/*  </p>
</li>
<li><p>/* @param tableName </p>
</li>
<li><p>/*            数据表名字 </p>
</li>
<li><p>/* @param names </p>
</li>
<li><p>/*            在POJO里不能重复的属性列表,以逗号分割 如&quot;name,loginid,password&quot; <br> </p>
</li>
<li><p>/*            FIXME how about in different schema? </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public boolean isNotUnique(Object entity, String tableName, String names) {  </p>
</li>
<li><p>try {  </p>
</li>
<li><p>String primarykey;  </p>
</li>
<li><p>Connection con = getSqlMapClient().getCurrentConnection();  </p>
</li>
<li><p>ResultSet dbMetaData = con.getMetaData().getPrimaryKeys(con.getCatalog(), null, tableName);  </p>
</li>
<li><p>dbMetaData.next();  </p>
</li>
<li><p>if (dbMetaData.getRow() &gt; 0) {  </p>
</li>
<li><p>primarykey = dbMetaData.getString(4);  </p>
</li>
<li><p>if (names.indexOf(primarykey) &gt; -1)  </p>
</li>
<li><p>return false;  </p>
</li>
<li><p>} else {  </p>
</li>
<li><p>return true;  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>} catch (SQLException e) {  </p>
</li>
<li><p>logger.error(e.getMessage(), e);  </p>
</li>
<li><p>return false;  </p>
</li>
<li><p>}  </p>
</li>
<li><p>return false;  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 分页查询函数，使用PaginatedList. </p>
</li>
<li><p>/*  </p>
</li>
<li><p>/* @param pageNo </p>
</li>
<li><p>/*            页号,从0开始. </p>
</li>
<li><p>/* @throws SQLException </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>@SuppressWarnings(&quot;rawtypes&quot;)  </p>
</li>
<li><p>public DataPage pagedQuery(String sqlName, HashMap<String, Object> hashMap, Integer pageNo, Integer pageSize)  </p>
</li>
<li><p>throws SQLException {  </p>
</li>
<li></li>
<li><p>if (pageNo == null || pageSize == null) {  </p>
</li>
<li><p>List list = getSqlMapClient().queryForList(sqlName, hashMap);  </p>
</li>
<li><p>if (list == null || list.size() == 0) {  </p>
</li>
<li><p>return new DataPage();  </p>
</li>
<li><p>} else {  </p>
</li>
<li><p>return new DataPage(0, list.size(), list.size(), list);  </p>
</li>
<li><p>}  </p>
</li>
<li><p>} else {  </p>
</li>
<li><p>Assert.hasText(sqlName);  </p>
</li>
<li><p>Assert.isTrue(pageNo &gt;= 1, &quot;pageNo should start from 1&quot;);  </p>
</li>
<li><p>// Count查询   </p>
</li>
<li><p>Integer totalCount = (Integer) getSqlMapClient().queryForObject(sqlName + &quot;.Count&quot;, hashMap);  </p>
</li>
<li></li>
<li><p>if (totalCount &lt; 1) {  </p>
</li>
<li><p>return new DataPage();  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>// 实际查询返回分页对象   </p>
</li>
<li><p>int startIndex = DataPage.getStartOfPage(pageNo, pageSize);  </p>
</li>
<li><p>hashMap.put(&quot;startIndex&quot;, startIndex);  </p>
</li>
<li><p>hashMap.put(&quot;pageSize&quot;, pageSize);  </p>
</li>
<li><p>List list = getSqlMapClient().queryForList(sqlName, hashMap);  </p>
</li>
<li></li>
<li><p>return new DataPage(startIndex, totalCount, pageSize, list);  </p>
</li>
<li><p>}  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>public String getMappedSQL(String sqlName) {  </p>
</li>
<li><p>String sql = null;  </p>
</li>
<li></li>
<li><p>SqlMapClientImpl sqlmap = (SqlMapClientImpl) getSqlMapClient();  </p>
</li>
<li></li>
<li><p>MappedStatement stmt = sqlmap.getMappedStatement(sqlName);  </p>
</li>
<li><p>StaticSql staticSql = (StaticSql) stmt.getSql();  </p>
</li>
<li><p>sql = staticSql.getSql(null, null);  </p>
</li>
<li><p>return sql;  </p>
</li>
<li><p>}  </p>
</li>
<li><p>}  </p>
</li>
</ol>
<p>package com.nfschina.utils.dao.ibatis import java.io.Serializable; import java.sql.Connection; import java.sql.ResultSet; import java.sql.SQLException; import java.util.HashMap; import java.util.List; import java.util.Map; import org.apache.commons.beanutils.PropertyUtils; import org.apache.commons.lang.StringUtils; import org.springframework.util.Assert; import com.ibatis.sqlmap.engine.impl.SqlMapClientImpl; import com.ibatis.sqlmap.engine.mapping.sql.stat.StaticSql; import com.ibatis.sqlmap.engine.mapping.statement.MappedStatement; importcom.nfschina.utils.BaseException; import com.nfschina.utils.DataPage; import org.springframework.orm.ibatis.support.SqlMapClientDaoSupport //<em>/</em> /<em> IBatis Dao的泛型基类. /</em> 继承于Spring的SqlMapClientDaoSupport,提供分页函数和若干便捷查询方法，并对返回值作了泛型类型转换. /<em>/ @SuppressWarnings(&quot;unchecked&quot;) public class IBatisGenericDao extends SqlMapClientDaoSupport { public static final String POSTFIX_INSERT = &quot;.insert&quot;; public static final String POSTFIX_UPDATE = &quot;.update&quot;; public static final String POSTFIX_DELETE = &quot;.delete&quot;; public static final String POSTFIX_DELETE_PRIAMARYKEY = &quot;.deleteByPrimaryKey&quot;; public static final String POSTFIX_SELECT = &quot;.select&quot;; public static final String POSTFIX_SELECTMAP = &quot;.selectByMap&quot;; public static final String POSTFIX_SELECTSQL = &quot;.selectBySql&quot;; public static final String POSTFIX_COUNT = &quot;.count&quot;; //</em>/<em> /</em> 根据ID获取对象 /<em> /</em> @throws BaseException /<em> @throws SQLException /</em>/ public <T> T get(Class<T> entityClass, Serializable id) throws BaseException, SQLException { T o = (T) getSqlMapClient().queryForObject(entityClass.getName() + POSTFIX_SELECT, id); if (o == null) throw new BaseException(BaseException.DATA_NOTFOUND, &quot;未找到实体: &quot; + id); return o; } //<em>/</em> /<em> 获取全部对象 /</em> @throws SQLException /<em>/ public <T> List<T> getAll(Class<T> entityClass) throws SQLException { return getSqlMapClient().queryForList(entityClass.getName() + POSTFIX_SELECT, null); } //</em>/<em> /</em> 新增对象 /<em> @throws SQLException /</em>/ public void insert(Object o) throws SQLException { getSqlMapClient().insert(o.getClass().getName() + POSTFIX_INSERT, o); } //<em>/</em> /<em> 保存对象 /</em> @throws SQLException /<em>/ public int update(Object o) throws SQLException { return getSqlMapClient().update(o.getClass().getName() + POSTFIX_UPDATE, o); } //</em>/<em> /</em> 删除对象 /<em> @throws SQLException /</em>/ public int remove(Object o) throws SQLException { return getSqlMapClient().delete(o.getClass().getName() + POSTFIX_DELETE, o); } //<em>/</em> /<em> 根据ID删除对象 /</em> @throws SQLException /<em>/ public <T> int removeById(Class<T> entityClass, Serializable id) throws SQLException { return getSqlMapClient().delete(entityClass.getName() + POSTFIX_DELETE_PRIAMARYKEY, id); } //</em>/<em> /</em> map查询. /<em> /</em> @param map /<em> 包含各种属性的查询 /</em> @throws SQLException /<em>/ public <T> List<T> find(Class<T> entityClass, Map<String, Object> map) throws SQLException { if (map == null) return this.getSqlMapClient().queryForList(entityClass.getName() + POSTFIX_SELECT, null); else { map.put(&quot;findBy&quot;, &quot;True&quot;); return this.getSqlMapClient() .queryForList(entityClass.getName() + POSTFIX_SELECTMAP, map); } } //</em>/<em> /</em> sql 查询. /<em> /</em> @param sql /<em> 直接sql的语句(需要防止注入式攻击) /</em> @throws SQLException /<em>/ public <T> List<T> find(Class<T> entityClass, String sql) throws SQLException { Assert.hasText(sql); if (StringUtils.isEmpty(sql)) return this.getSqlMapClient().queryForList(entityClass.getName() + POSTFIX_SELECT, null); else return this.getSqlMapClient() .queryForList(entityClass.getName() + POSTFIX_SELECTSQL, sql); } //</em>/<em> /</em> 根据属性名和属性值查询对象. /<em> /</em> @return 符合条件的对象列表 /<em> @throws SQLException /</em>/ public <T> List<T> findBy(Class<T> entityClass, String name, Object value) throws SQLException { Assert.hasText(name); Map<String, Object> map = new HashMap<String, Object>(); map.put(name, value); return find(entityClass, map); } //<em>/</em> /<em> 根据属性名和属性值查询对象. /</em> /<em> @return 符合条件的唯一对象 /</em>/ public <T> T findUniqueBy(Class<T> entityClass, String name, Object value) { Assert.hasText(name); Map<String, Object> map = new HashMap<String, Object>(); try { PropertyUtils.getProperty(entityClass.newInstance(), name); map.put(name, value); map.put(&quot;findUniqueBy&quot;, &quot;True&quot;); return (T) getSqlMapClient().queryForObject(entityClass.getName() + POSTFIX_SELECTMAP, map); } catch (Exception e) { logger.error(&quot;Error when propertie on entity,&quot; + e.getMessage(), e.getCause()); return null; } } //<em>/</em> /<em> 根据属性名和属性值以Like AnyWhere方式查询对象. /</em> @throws SQLException /<em>/ public <T> List<T> findByLike(Class<T> entityClass, String name, String value) throws SQLException { Assert.hasText(name); Map<String, Object> map = new HashMap<String, Object>(); map.put(name, value); map.put(&quot;findLikeBy&quot;, &quot;True&quot;); return getSqlMapClient().queryForList(entityClass.getName() + POSTFIX_SELECTMAP, map); } //</em>/<em> /</em> 判断对象某些属性的值在数据库中不存在重复 /<em> /</em> @param tableName /<em> 数据表名字 /</em> @param names /<em> 在POJO里不能重复的属性列表,以逗号分割 如&quot;name,loginid,password&quot; <br> /</em> FIXME how about in different schema? /<em>/ public boolean isNotUnique(Object entity, String tableName, String names) { try { String primarykey; Connection con = getSqlMapClient().getCurrentConnection(); ResultSet dbMetaData = con.getMetaData().getPrimaryKeys(con.getCatalog(), null, tableName); dbMetaData.next(); if (dbMetaData.getRow() &gt; 0) { primarykey = dbMetaData.getString(4); if (names.indexOf(primarykey) &gt; -1) return false; } else { return true; } } catch (SQLException e) { logger.error(e.getMessage(), e); return false; } return false; } //</em>/<em> /</em> 分页查询函数，使用PaginatedList. /<em> /</em> @param pageNo /<em> 页号,从0开始. /</em> @throws SQLException /*/ @SuppressWarnings(&quot;rawtypes&quot;) public DataPage pagedQuery(String sqlName, HashMap<String, Object> hashMap, Integer pageNo, Integer pageSize) throws SQLException { if (pageNo == null || pageSize == null) { List list = getSqlMapClient().queryForList(sqlName, hashMap); if (list == null || list.size() == 0) { return new DataPage(); } else { return new DataPage(0, list.size(), list.size(), list); } } else { Assert.hasText(sqlName); Assert.isTrue(pageNo &gt;= 1, &quot;pageNo should start from 1&quot;); // Count查询 Integer totalCount = (Integer) getSqlMapClient().queryForObject(sqlName + &quot;.Count&quot;, hashMap); if (totalCount &lt; 1) { return new DataPage(); } // 实际查询返回分页对象 int startIndex = DataPage.getStartOfPage(pageNo, pageSize); hashMap.put(&quot;startIndex&quot;, startIndex); hashMap.put(&quot;pageSize&quot;, pageSize); List list = getSqlMapClient().queryForList(sqlName, hashMap); return new DataPage(startIndex, totalCount, pageSize, list); } } public String getMappedSQL(String sqlName) { String sql = null; SqlMapClientImpl sqlmap = (SqlMapClientImpl) getSqlMapClient(); MappedStatement stmt = sqlmap.getMappedStatement(sqlName); StaticSql staticSql = (StaticSql) stmt.getSql(); sql = staticSql.getSql(null, null); return sql; } }</p>
<p><a href="http://blog.csdn.net/boaifeng/article/details/5966940" title="view plain" target="_blank">view plain</a><a href="http://blog.csdn.net/boaifeng/article/details/5966940" title="copy to clipboard" target="_blank">copy to clipboard</a><a href="http://blog.csdn.net/boaifeng/article/details/5966940" title="print" target="_blank">print</a><a href="http://blog.csdn.net/boaifeng/article/details/5966940" title="?" target="_blank">?</a></p>
<ol>
<li><p>package com.nfschina.utils.dao.ibatis;  </p>
</li>
<li></li>
<li><p>import java.io.Serializable;  </p>
</li>
<li><p>import java.lang.reflect.InvocationTargetException;  </p>
</li>
<li><p>import java.sql.SQLException;  </p>
</li>
<li><p>import java.util.List;  </p>
</li>
<li><p>import java.util.Map;  </p>
</li>
<li></li>
<li><p>import org.apache.commons.beanutils.PropertyUtils;  </p>
</li>
<li><p>import org.apache.commons.lang.StringUtils;  </p>
</li>
<li><p>import org.springframework.orm.ObjectRetrievalFailureException;  </p>
</li>
<li></li>
<li><p>import com.nfschina.utils.BaseException;  </p>
</li>
<li><p>import com.nfschina.utils.GenericsUtils;  </p>
</li>
<li></li>
<li><p>import   </p>
</li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 负责为单个Entity 提供CRUD操作的IBatis DAO基类. </p>
</li>
<li><p>/* <p/> </p>
</li>
<li><p>/* 子类只要在类定义时指定所管理Entity的Class, 即拥有对单个Entity对象的CRUD操作. </p>
</li>
<li><p>/*  </p>
</li>
<li><p>/* <pre> </p>
</li>
<li><p>/* public class UserManagerIbatis extends IBatisEntityDao<User> { </p>
</li>
<li><p>/* } </p>
</li>
<li><p>/* </pre> </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public class IBatisEntityDao<T> extends IBatisGenericDao {  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* DAO所管理的Entity类型. </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>protected Class<T> entityClass;  </p>
</li>
<li></li>
<li><p>protected String primaryKeyName;  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 在构造函数中将泛型T.class赋给entityClass. </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>@SuppressWarnings(&quot;unchecked&quot;)  </p>
</li>
<li><p>public IBatisEntityDao() {  </p>
</li>
<li><p>entityClass = (Class<T>) GenericsUtils.getSuperClassGenricType(getClass());  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 根据属性名和属性值查询对象. </p>
</li>
<li><p>/*  </p>
</li>
<li><p>/* @return 符合条件的对象列表 </p>
</li>
<li><p>/* @throws SQLException  </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public List<T> findBy(String name, Object value) throws SQLException {  </p>
</li>
<li><p>return findBy(getEntityClass(), name, value);  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 根据属性的名值对查询对象 </p>
</li>
<li><p>/* @param map </p>
</li>
<li><p>/* @return </p>
</li>
<li><p>/* @throws SQLException  </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public List<T> find(Map<String, Object> map) throws SQLException{  </p>
</li>
<li><p>return find(getEntityClass(), map);  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 根据属性的名值对查询唯一对象 </p>
</li>
<li><p>/* @param map </p>
</li>
<li><p>/* @return </p>
</li>
<li><p>/* @throws SQLException </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public T findUniqueByMap(Map<String, Object> map) throws SQLException{  </p>
</li>
<li><p>List<T> list = find(getEntityClass(), map);  </p>
</li>
<li><p>if(list == null || list.size() &lt;= 0){  </p>
</li>
<li><p>return null;  </p>
</li>
<li><p>}   </p>
</li>
<li><p>return list.get(0);  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 根据属性名和属性值以Like AnyWhere方式查询对象. </p>
</li>
<li><p>/* @throws SQLException  </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public List<T> findByLike(String name, String value) throws SQLException {  </p>
</li>
<li><p>return findByLike(getEntityClass(), name, value);  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 根据属性名和属性值查询单个对象. </p>
</li>
<li><p>/*  </p>
</li>
<li><p>/* @return 符合条件的唯一对象 </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public T findUniqueBy(String name, Object value) {  </p>
</li>
<li><p>return findUniqueBy(getEntityClass(), name, value);  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 根据ID获取对象. </p>
</li>
<li><p>/*  </p>
</li>
<li><p>/* @throws BaseException </p>
</li>
<li><p>/* @throws SQLException  </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public T get(Serializable id) throws BaseException, SQLException {  </p>
</li>
<li><p>return get(getEntityClass(), id);  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 获取全部对象. </p>
</li>
<li><p>/* @throws SQLException  </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public List<T> getAll() throws SQLException {  </p>
</li>
<li><p>return getAll(getEntityClass());  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 取得entityClass. </p>
</li>
<li><p>/* <p/> </p>
</li>
<li><p>/* JDK1.4不支持泛型的子类可以抛开Class<T> entityClass,重载此函数达到相同效果。 </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>protected Class<T> getEntityClass() {  </p>
</li>
<li><p>return entityClass;  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>public String getPrimaryKeyName() {  </p>
</li>
<li><p>if (StringUtils.isEmpty(primaryKeyName))  </p>
</li>
<li><p>primaryKeyName = &quot;id&quot;;  </p>
</li>
<li><p>return primaryKeyName;  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>protected Object getPrimaryKeyValue(Object o) throws NoSuchMethodException, IllegalAccessException,  </p>
</li>
<li><p>InvocationTargetException, InstantiationException {  </p>
</li>
<li><p>return PropertyUtils.getProperty(entityClass.newInstance(), getPrimaryKeyName());  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 根据ID移除对象. </p>
</li>
<li><p>/* @throws SQLException  </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public int removeById(Serializable id) throws SQLException {  </p>
</li>
<li><p>return removeById(getEntityClass(), id);  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>//<em>/</em> </p>
</li>
<li><p>/* 保存对象. 为了实现IEntityDao 我在内部使用了insert和upate 2个方法. </p>
</li>
<li><p>/* @throws SQLException  </p>
</li>
<li><p>/*/  </p>
</li>
<li><p>public void saveOrUpdate(Object o) throws SQLException {  </p>
</li>
<li><p>Object primaryKey;  </p>
</li>
<li><p>try {  </p>
</li>
<li><p>primaryKey = getPrimaryKeyValue(o);  </p>
</li>
<li><p>} catch (Exception e) {  </p>
</li>
<li><p>throw new ObjectRetrievalFailureException(entityClass, e);  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>if (primaryKey == null)  </p>
</li>
<li><p>insert(o);  </p>
</li>
<li><p>else  </p>
</li>
<li><p>update(o);  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>public void setPrimaryKeyName(String primaryKeyName) {  </p>
</li>
<li><p>this.primaryKeyName = primaryKeyName;  </p>
</li>
<li><p>}  </p>
</li>
<li></li>
<li><p>public String getIdName(Class&lt;?&gt; clazz) {  </p>
</li>
<li><p>return &quot;id&quot;;  </p>
</li>
<li><p>}  </p>
</li>
<li><p>}  </p>
</li>
</ol>
<p>package com.nfschina.utils.dao.ibatis; import java.io.Serializable; import java.lang.reflect.InvocationTargetException; import java.sql.SQLException; import java.util.List; import java.util.Map; import org.apache.commons.beanutils.PropertyUtils; import org.apache.commons.lang.StringUtils; import org.springframework.orm.ObjectRetrievalFailureException; import com.nfschina.utils.BaseException; import com.nfschina.utils.GenericsUtils; import //<em>/</em> /<em> 负责为单个Entity 提供CRUD操作的IBatis DAO基类. /</em> <p/> /<em> 子类只要在类定义时指定所管理Entity的Class, 即拥有对单个Entity对象的CRUD操作. /</em> /<em> <pre> /</em> public class UserManagerIbatis extends IBatisEntityDao<User> { /<em> } /</em> </pre> /<em>/ public class IBatisEntityDao<T> extends IBatisGenericDao { //</em>/<em> /</em> DAO所管理的Entity类型. /<em>/ protected Class<T> entityClass; protected String primaryKeyName; //</em>/<em> /</em> 在构造函数中将泛型T.class赋给entityClass. /<em>/ @SuppressWarnings(&quot;unchecked&quot;) public IBatisEntityDao() { entityClass = (Class<T>) GenericsUtils.getSuperClassGenricType(getClass()); } //</em>/<em> /</em> 根据属性名和属性值查询对象. /<em> /</em> @return 符合条件的对象列表 /<em> @throws SQLException /</em>/ public List<T> findBy(String name, Object value) throws SQLException { return findBy(getEntityClass(), name, value); } //<em>/</em> /<em> 根据属性的名值对查询对象 /</em> @param map /<em> @return /</em> @throws SQLException /<em>/ public List<T> find(Map<String, Object> map) throws SQLException{ return find(getEntityClass(), map); } //</em>/<em> /</em> 根据属性的名值对查询唯一对象 /<em> @param map /</em> @return /<em> @throws SQLException /</em>/ public T findUniqueByMap(Map<String, Object> map) throws SQLException{ List<T> list = find(getEntityClass(), map); if(list == null || list.size() &lt;= 0){ return null; } return list.get(0); } //<em>/</em> /<em> 根据属性名和属性值以Like AnyWhere方式查询对象. /</em> @throws SQLException /<em>/ public List<T> findByLike(String name, String value) throws SQLException { return findByLike(getEntityClass(), name, value); } //</em>/<em> /</em> 根据属性名和属性值查询单个对象. /<em> /</em> @return 符合条件的唯一对象 /<em>/ public T findUniqueBy(String name, Object value) { return findUniqueBy(getEntityClass(), name, value); } //</em>/<em> /</em> 根据ID获取对象. /<em> /</em> @throws BaseException /<em> @throws SQLException /</em>/ public T get(Serializable id) throws BaseException, SQLException { return get(getEntityClass(), id); } //<em>/</em> /<em> 获取全部对象. /</em> @throws SQLException /<em>/ public List<T> getAll() throws SQLException { return getAll(getEntityClass()); } //</em>/<em> /</em> 取得entityClass. /<em> <p/> /</em> JDK1.4不支持泛型的子类可以抛开Class<T> entityClass,重载此函数达到相同效果。 /<em>/ protected Class<T> getEntityClass() { return entityClass; } public String getPrimaryKeyName() { if (StringUtils.isEmpty(primaryKeyName)) primaryKeyName = &quot;id&quot;; return primaryKeyName; } protected Object getPrimaryKeyValue(Object o) throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException { return PropertyUtils.getProperty(entityClass.newInstance(), getPrimaryKeyName()); } //</em>/<em> /</em> 根据ID移除对象. /<em> @throws SQLException /</em>/ public int removeById(Serializable id) throws SQLException { return removeById(getEntityClass(), id); } //<em>/</em> /<em> 保存对象. 为了实现IEntityDao 我在内部使用了insert和upate 2个方法. /</em> @throws SQLException /*/ public void saveOrUpdate(Object o) throws SQLException { Object primaryKey; try { primaryKey = getPrimaryKeyValue(o); } catch (Exception e) { throw new ObjectRetrievalFailureException(entityClass, e); } if (primaryKey == null) insert(o); else update(o); } public void setPrimaryKeyName(String primaryKeyName) { this.primaryKeyName = primaryKeyName; } public String getIdName(Class&lt;?&gt; clazz) { return &quot;id&quot;; } }</p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/框架汇总/">框架汇总</a></li></span><span class="breadcrumb"><li><a href="/categories/框架汇总/">框架汇总</a></li><li><a href="/categories/框架汇总/ORM/">ORM</a></li><li><a href="/categories/框架汇总/ORM/ibatis/">ibatis</a></li></span></span> | <span class="tags">Tagged <a href="/tags/ORM/" class="label label-primary">ORM</a><a href="/tags/ibatis/" class="label label-success">ibatis</a><a href="/tags/框架汇总/" class="label label-info">框架汇总</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:29"datetime="2014-03-07 09:54:29"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-框架汇总-ORM-ibatis--使用ibatis操作数据库的封装/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-框架汇总-ORM-ibatis--使用ibatis操作数据库的封装" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-框架汇总-ORM-ibatis--对ibatis分页功能的改进-newpeter-ITeye技术网站/">对ibatis分页功能的改进 </a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:29.000Z"> <a href="/2014/02/02/2014-02-02-框架汇总-ORM-ibatis--对ibatis分页功能的改进-newpeter-ITeye技术网站/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="-ibatis-newpeter-iteye-">对ibatis分页功能的改进 - newpeter - ITeye技术网站</h1>
<p><a href="http://www.iteye.com/" target="_blank">首页</a> <a href="http://www.iteye.com/news" target="_blank">资讯</a> <a href="http://www.iteye.com/forums" target="_blank">论坛</a> <a href="http://www.iteye.com/ask" target="_blank">问答</a> <a href="http://www.iteye.com/blogs" target="_blank">博客</a> <a href="http://www.iteye.com/groups" target="_blank">群组</a> <a href="http://newpeter.iteye.com/blog/323135#" target="_blank">更多 ▼</a></p>
<p><a href="http://www.iteye.com/job" target="_blank">招聘</a> <a href="http://www.iteye.com/search" target="_blank">搜索</a></p>
<p><a href="http://newpeter.iteye.com/login" title="登录" target="_blank">您还未登录 !</a> <a href="http://www.iteye.com/all" target="_blank">我的应用</a> <a href="http://newpeter.iteye.com/login" target="_blank">登录</a> <a href="http://newpeter.iteye.com/signup" target="_blank">注册</a></p>
<h1 id="-newpeter-http-newpeter-iteye-com-"><a href="http://newpeter.iteye.com/" target="_blank">newpeter</a></h1>
<p>永久域名 <a href="http://newpeter.iteye.com/" target="_blank"><a href="http://newpeter.iteye.com/">http://newpeter.iteye.com/</a></a></p>
<p><a href="http://newpeter.iteye.com/blog/323137" title="当前比较全的Linux各种版本简介" target="_blank">当前比较全的Linux各种版本简介</a> | <a href="http://newpeter.iteye.com/blog/323130" title="常用正则表达式" target="_blank">常用正则表达式</a></p>
<p>2009-02-04</p>
<h3 id="-ibatis-http-newpeter-iteye-com-blog-323135-"><a href="http://newpeter.iteye.com/blog/323135" target="_blank">对ibatis分页功能的改进</a> **</h3>
<p><a href="http://www.iteye.com/blogs/tag/iBATIS" target="_blank">iBATIS</a><a href="http://www.iteye.com/blogs/tag/SQL" target="_blank">SQL</a><a href="http://www.iteye.com/blogs/tag/Hibernate" target="_blank">Hibernate</a><a href="http://www.iteye.com/blogs/tag/DAO" target="_blank">DAO</a><a href="http://www.iteye.com/blogs/tag/EXT" target="_blank">EXT</a></p>
<p>今天无意间看到了一篇关于这方面的文章，觉得是网上改进ibatis分页方面比较好的文章，这里转摘一下，希望能让更多的人用的到，也希望别人能把更好的解决方案贡献出来！
使ibatis支持hibernate式的物理分页</p>
<p>一直以来ibatis的分页都是通过滚动ResultSet实现的，应该算是逻辑分页吧。逻辑分页虽然能很干净地独立于特定数据库，但效率在多数情 况下不及特定数据库支持的物理分页，而hibernate的分页则是直接组装sql，充分利用了特定数据库的分页机制，效率相对较高。本文讲述的就是如何 在不重新编译ibatis源码的前提下，为ibatis引入hibernate式的物理分页机制。</p>
<p>基本思路就是找到ibatis执行sql的地方，截获sql并重新组装sql。通过分析ibatis源码知道，最终负责执行sql的类是 com.ibatis.sqlmap.engine.execution.SqlExecutor，此类没有实现任何接口，这多少有点遗憾，因为接口是相 对稳定契约，非大的版本更新，接口一般是不会变的，而类就相对易变一些，所以这里的代码只能保证对当前版本（2.1.7）的ibatis有效。下面是 SqlExecutor执行查询的方法：</p>
<p>//<em>/</em> /<em> Long form of the method to execute a query /</em> /<em> @param request - the request scope /</em> @param conn - the database connection /<em> @param sql - the SQL statement to execute /</em> @param parameters - the parameters for the statement /<em> @param skipResults - the number of results to skip /</em> @param maxResults - the maximum number of results to return /<em> @param callback - the row handler for the query /</em> /<em> @throws SQLException - if the query fails /</em>/ public void executeQuery(RequestScope request, Connection conn, String sql, Object[] parameters, int skipResults, int maxResults, RowHandlerCallback callback) throws SQLException { ErrorContext errorContext = request.getErrorContext(); errorContext.setActivity(&quot;executing query&quot;); errorContext.setObjectId(sql); PreparedStatement ps = null; ResultSet rs = null; try { errorContext.setMoreInfo(&quot;Check the SQL Statement (preparation failed).&quot;); Integer rsType = request.getStatement().getResultSetType(); if (rsType != null) { ps = conn.prepareStatement(sql, rsType.intValue(), ResultSet.CONCUR_READ_ONLY); } else { ps = conn.prepareStatement(sql); } Integer fetchSize = request.getStatement().getFetchSize(); if (fetchSize != null) { ps.setFetchSize(fetchSize.intValue()); } errorContext.setMoreInfo(&quot;Check the parameters (set parameters failed).&quot;); request.getParameterMap().setParameters(request, ps, parameters); errorContext.setMoreInfo(&quot;Check the statement (query failed).&quot;); ps.execute(); rs = getFirstResultSet(ps); if (rs != null) { errorContext.setMoreInfo(&quot;Check the results (failed to retrieve results).&quot;); handleResults(request, rs, skipResults, maxResults, callback); } // clear out remaining results while (ps.getMoreResults()); } finally { try { closeResultSet(rs); } finally { closeStatement(ps); } } }</p>
<p> 其中handleResults(request, rs, skipResults, maxResults, callback)一句用于处理分页，其实此时查询已经执行完毕，可以不必关心handleResults方法，但为清楚起见，下面来看看 handleResults的实现：</p>
<p>private void handleResults(RequestScope request, ResultSet rs, int skipResults, int maxResults, RowHandlerCallback callback) throws SQLException { try { request.setResultSet(rs); ResultMap resultMap = request.getResultMap(); if (resultMap != null) { // Skip Results if (rs.getType() != ResultSet.TYPE_FORWARD_ONLY) { if (skipResults &gt; 0) { rs.absolute(skipResults); } } else { for (int i = 0; i &lt; skipResults; i++) { if (!rs.next()) { break; } } } // Get Results int resultsFetched = 0; while ((maxResults == SqlExecutor.NO_MAXIMUM_RESULTS || resultsFetched &lt; maxResults) &amp;&amp; rs.next()) { Object[] columnValues = resultMap.resolveSubMap(request, rs).getResults(request, rs); callback.handleResultObject(request, columnValues, rs); resultsFetched++; } } } finally { request.setResultSet(null); } }</p>
<p> 此处优先使用的是ResultSet的absolute方法定位记录，是否支持absolute取决于具体数据库驱动，但一般当前版本的数据库都支 持该方法，如果不支持则逐条跳过前面的记录。由此可以看出如果数据库支持absolute，则ibatis内置的分页策略与特定数据库的物理分页效率差距 就在于物理分页查询与不分页查询在数据库中的执行效率的差距了。因为查询执行后读取数据前数据库并未把结果全部返回到内存，所以本身在存储占用上应该差距 不大，如果都使用索引，估计执行速度也差不太多。</p>
<p>继续我们的话题。其实只要在executeQuery执行前组装sql，然后将其传给executeQuery，并告诉handleResults 我们不需要逻辑分页即可。拦截executeQuery可以采用aop动态实现，也可直接继承SqlExecutor覆盖executeQuery来静态 地实现，相比之下后者要简单许多，而且由于SqlExecutor没有实现任何接口，比较易变，动态拦截反到增加了维护的工作量，所以我们下面来覆盖 executeQuery：</p>
<p>package com.aladdin.dao.ibatis.ext; import java.sql.Connection; import java.sql.SQLException; import org.apache.commons.logging.Log; import org.apache.commons.logging.LogFactory; import com.aladdin.dao.dialect.Dialect; import com.ibatis.sqlmap.engine.execution.SqlExecutor; import com.ibatis.sqlmap.engine.mapping.statement.RowHandlerCallback; import com.ibatis.sqlmap.engine.scope.RequestScope; public class LimitSqlExecutor extends SqlExecutor { private static final Log logger = LogFactory.getLog(LimitSqlExecutor.class); private Dialect dialect; private boolean enableLimit = true; public Dialect getDialect() { return dialect; } public void setDialect(Dialect dialect) { this.dialect = dialect; } public boolean isEnableLimit() { return enableLimit; } public void setEnableLimit(boolean enableLimit) { this.enableLimit = enableLimit; } @Override public void executeQuery(RequestScope request, Connection conn, String sql, Object[] parameters, int skipResults, int maxResults, RowHandlerCallback callback) throws SQLException { if ((skipResults != NO_SKIPPED_RESULTS || maxResults != NO_MAXIMUM_RESULTS) &amp;&amp; supportsLimit()) { sql = dialect.getLimitString(sql, skipResults, maxResults); if(logger.isDebugEnabled()){ logger.debug(sql); } skipResults = NO_SKIPPED_RESULTS; maxResults = NO_MAXIMUM_RESULTS; } super.executeQuery(request, conn, sql, parameters, skipResults, maxResults, callback); } public boolean supportsLimit() { if (enableLimit &amp;&amp; dialect != null) { return dialect.supportsLimit(); } return false; } }</p>
<p> 其中：</p>
<p>skipResults = NO_SKIPPED_RESULTS; maxResults = NO_MAXIMUM_RESULTS;</p>
<p> 告诉handleResults不分页（我们组装的sql已经使查询结果是分页后的结果了），此处引入了类似hibenate中的数据库方言接口Dialect，其代码如下：</p>
<p>package com.aladdin.dao.dialect; public interface Dialect { public boolean supportsLimit(); public String getLimitString(String sql, boolean hasOffset); public String getLimitString(String sql, int offset, int limit); }</p>
<p> 下面为Dialect接口的MySQL实现：package com.aladdin.dao.ibatis;</p>
<p>import java.io.Serializable; import java.util.List; import org.springframework.orm.ObjectRetrievalFailureException; import org.springframework.orm.ibatis.support.SqlMapClientDaoSupport; import com.aladdin.dao.ibatis.ext.LimitSqlExecutor; import com.aladdin.domain.BaseObject; import com.aladdin.util.ReflectUtil; import com.ibatis.sqlmap.client.SqlMapClient; import com.ibatis.sqlmap.engine.execution.SqlExecutor; import com.ibatis.sqlmap.engine.impl.ExtendedSqlMapClient; public abstract class BaseDaoiBatis extends SqlMapClientDaoSupport { private SqlExecutor sqlExecutor; public SqlExecutor getSqlExecutor() { return sqlExecutor; } public void setSqlExecutor(SqlExecutor sqlExecutor) { this.sqlExecutor = sqlExecutor; } public void setEnableLimit(boolean enableLimit) { if (sqlExecutor instanceof LimitSqlExecutor) { ((LimitSqlExecutor) sqlExecutor).setEnableLimit(enableLimit); } } public void initialize() throws Exception { if (sqlExecutor != null) { SqlMapClient sqlMapClient = getSqlMapClientTemplate() .getSqlMapClient(); if (sqlMapClient instanceof ExtendedSqlMapClient) { ReflectUtil.setFieldValue(((ExtendedSqlMapClient) sqlMapClient) .getDelegate(), &quot;sqlExecutor&quot;, SqlExecutor.class, sqlExecutor); } } } ... }</p>
<p>分享到： <a href="&quot;分享到新浪微博&quot;"><img src="" alt=""></a> <a href="&quot;分享到腾讯微博&quot;"><img src="" alt=""></a>
<a href="http://newpeter.iteye.com/blog/323137" title="当前比较全的Linux各种版本简介" target="_blank">当前比较全的Linux各种版本简介</a> | <a href="http://newpeter.iteye.com/blog/323130" title="常用正则表达式" target="_blank">常用正则表达式</a></p>
<ul>
<li>23:31</li>
<li><a href="http://newpeter.iteye.com/blog/323135#comments" target="_blank">评论</a> / 浏览 (1 / 2852)</li>
<li><a href="http://www.iteye.com/wiki/blog/323135" target="_blank">相关推荐</a><h3 id="-">评论</h3>
</li>
</ul>
<p><a href=""></a></p>
<p>1 楼 <a href="http://vasuer.iteye.com/" target="_blank">vasuer</a> 2010-08-29   <a href="http://newpeter.iteye.com/blog/323135#" target="_blank">引用</a></p>
<p>te<img src="" alt=""></p>
<h3 id="-">发表评论</h3>
<p>您还没有登录，请<a href="http://newpeter.iteye.com/login" target="_blank">登录</a>后发表评论(快捷键 Alt+S / Ctrl+Enter)</p>
<p><a href="http://newpeter.iteye.com/" target="_blank"><img src="&quot;newpeter的博客: newpeter&quot;" alt="newpeter的博客"></a></p>
<p>newpeter</p>
<ul>
<li>浏览: 16997 次</li>
<li>性别: <img src="&quot;男&quot;" alt="Icon_minigender_1"></li>
<li>来自: 深圳</li>
<li><img src="" alt=""></li>
<li><a href="http://newpeter.iteye.com/blog/profile" target="_blank">详细资料</a> <a href="http://newpeter.iteye.com/blog/guest_book" target="_blank">留言簿</a></li>
</ul>
<h3 id="-">搜索本博客</h3>
<h3 id="-http-newpeter-iteye-com-blog-user_visits-">最近访客 <a href="http://newpeter.iteye.com/blog/user_visits" target="_blank">&gt;&gt;更多访客</a></h3>
<p><a href="http://ankonlcy.iteye.com/" target="_blank"><img src="&quot;ankonlcy的博客: &quot;" alt="ankonlcy的博客"></a></p>
<p><a href="http://ankonlcy.iteye.com/" target="_blank">ankonlcy</a></p>
<p><a href="http://amazingstar.iteye.com/" target="_blank"><img src="&quot;amazingstar的博客: &quot;" alt="amazingstar的博客"></a></p>
<p><a href="http://amazingstar.iteye.com/" target="_blank">amazingstar</a>
<a href="http://woozyangel.iteye.com/" target="_blank"><img src="&quot;woozyangel的博客: &quot;" alt="woozyangel的博客"></a></p>
<p><a href="http://woozyangel.iteye.com/" target="_blank">woozyangel</a></p>
<p><a href="http://jdtangyin.iteye.com/" target="_blank"><img src="&quot;jdTangYin的博客: &quot;" alt="jdTangYin的博客"></a></p>
<p><a href="http://jdtangyin.iteye.com/" target="_blank">jdTangYin</a></p>
<h3 id="-">博客分类</h3>
<ul>
<li><a href="http://newpeter.iteye.com/" target="_blank">全部博客 (16)</a><h3 id="-http-newpeter-iteye-com-blog-guest_book-">我的留言簿 <a href="http://newpeter.iteye.com/blog/guest_book" target="_blank">&gt;&gt;更多留言</a></h3>
</li>
</ul>
<h3 id="-">其他分类</h3>
<ul>
<li><a href="http://newpeter.iteye.com/blog/favorite" target="_blank">我的收藏</a> (6)</li>
<li><a href="http://newpeter.iteye.com/blog/code_favorite" target="_blank">我的代码</a> (0)</li>
<li><a href="http://newpeter.iteye.com/blog/topic" target="_blank">我的论坛主题帖</a> (2)</li>
<li><a href="http://newpeter.iteye.com/blog/post" target="_blank">我的所有论坛帖</a> (5)</li>
<li><a href="http://newpeter.iteye.com/blog/article" target="_blank">我的精华良好帖</a> (0)<h3 id="-">最近加入群组</h3>
</li>
</ul>
<h3 id="-">存档</h3>
<ul>
<li><a href="http://newpeter.iteye.com/blog/monthblog/2009-02" target="_blank">2009-02</a> (13)</li>
<li><a href="http://newpeter.iteye.com/blog/monthblog/2009-01" target="_blank">2009-01</a> (1)</li>
<li><a href="http://newpeter.iteye.com/blog/monthblog/2007-05" target="_blank">2007-05</a> (2)</li>
<li><a href="http://newpeter.iteye.com/blog/monthblog_more" target="_blank">更多存档...</a></li>
<li><a href="http://newpeter.iteye.com/rss" target="_blank"><img src="" alt="Rss"></a></li>
<li><a href="http://fusion.google.com/add?feedurl=http://newpeter.iteye.com/rss" target="_blank"><img src="" alt="Rss_google"></a>
声明：ITeye文章版权属于作者，受法律保护。没有作者书面许可不得转载。若作者同意转载，必须以超链接形式标明文章原始出处和作者。
© 2003-2011 ITeye.com. All rights reserved. [ 京ICP证110151号 ]</li>
</ul>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/框架汇总/">框架汇总</a></li></span><span class="breadcrumb"><li><a href="/categories/框架汇总/">框架汇总</a></li><li><a href="/categories/框架汇总/ORM/">ORM</a></li><li><a href="/categories/框架汇总/ORM/ibatis/">ibatis</a></li></span></span> | <span class="tags">Tagged <a href="/tags/ORM/" class="label label-primary">ORM</a><a href="/tags/ibatis/" class="label label-success">ibatis</a><a href="/tags/框架汇总/" class="label label-info">框架汇总</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:29"datetime="2014-03-07 09:54:29"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-框架汇总-ORM-ibatis--对ibatis分页功能的改进-newpeter-ITeye技术网站/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-框架汇总-ORM-ibatis--对ibatis分页功能的改进-newpeter-ITeye技术网站" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-框架汇总-ORM-ibatis--对ibatis分页功能的改进/">对ibatis分页功能的改进</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:29.000Z"> <a href="/2014/02/02/2014-02-02-框架汇总-ORM-ibatis--对ibatis分页功能的改进/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="-ibatis-">对ibatis分页功能的改进</h1>
<p><strong>对ibatis**</strong>分页功能的改进**</p>
<p>2008-05-26 14:45
今天无意间看到了一篇关于这方面的文章，觉得是网上改进ibatis分页方面比较好的文章，这里转摘一下，希望能让更多的人用的到，也希望别人能把更好的解决方案贡献出来！</p>
<p>使ibatis支持hibernate式的物理分页</p>
<p>一直以来ibatis的分页都是通过滚动ResultSet实现的，应该算是逻辑分页吧。逻辑分页虽然能很干净地独立于特定数据库，但效率在多数情 况下不及特定数据库支持的物理分页，而hibernate的分页则是直接组装sql，充分利用了特定数据库的分页机制，效率相对较高。本文讲述的就是如何 在不重新编译ibatis源码的前提下，为ibatis引入hibernate式的物理分页机制。</p>
<p>基本思路就是找到ibatis执行sql的地方，截获sql并重新组装sql。通过分析ibatis源码知道，最终负责执行sql的类是 com.ibatis.sqlmap.engine.execution.SqlExecutor，此类没有实现任何接口，这多少有点遗憾，因为接口是相 对稳定契约，非大的版本更新，接口一般是不会变的，而类就相对易变一些，所以这里的代码只能保证对当前版本（2.1.7）的ibatis有效。下面是 SqlExecutor执行查询的方法：</p>
<p>  //<em>/</em>
    /<em> Long form of the method to execute a query
    /</em>
    /<em> @param request - the request scope
    /</em> @param conn - the database connection
    /<em> @param sql - the SQL statement to execute
    /</em> @param parameters - the parameters for the statement
    /<em> @param skipResults - the number of results to skip
    /</em> @param maxResults - the maximum number of results to return
    /<em> @param callback - the row handler for the query
    /</em>
    /<em> @throws SQLException - if the query fails
   /</em>/
  public void executeQuery(RequestScope request, Connection conn, String sql, Object[] parameters,
                           int skipResults, int maxResults, RowHandlerCallback callback)
      throws SQLException {
     ErrorContext errorContext = request.getErrorContext();
     errorContext.setActivity(&quot;executing query&quot;);
     errorContext.setObjectId(sql);
     PreparedStatement ps = null;
     ResultSet rs = null;
    try {
       errorContext.setMoreInfo(&quot;Check the SQL Statement (preparation failed).&quot;);
       Integer rsType = request.getStatement().getResultSetType();
      if (rsType != null) {
         ps = conn.prepareStatement(sql, rsType.intValue(), ResultSet.CONCUR_READ_ONLY);
       } else {
         ps = conn.prepareStatement(sql);
       }
       Integer fetchSize = request.getStatement().getFetchSize();
      if (fetchSize != null) {
         ps.setFetchSize(fetchSize.intValue());
       }
       errorContext.setMoreInfo(&quot;Check the parameters (set parameters failed).&quot;);
       request.getParameterMap().setParameters(request, ps, parameters);
       errorContext.setMoreInfo(&quot;Check the statement (query failed).&quot;);
       ps.execute();
       rs = getFirstResultSet(ps);
      if (rs != null) {
         errorContext.setMoreInfo(&quot;Check the results (failed to retrieve results).&quot;);
         handleResults(request, rs, skipResults, maxResults, callback);
       }
      // clear out remaining results
      while (ps.getMoreResults());
     } finally {
      try {
         closeResultSet(rs);
       } finally {
         closeStatement(ps);
       }
     }
   }</p>
<p>其中handleResults(request, rs, skipResults, maxResults, callback)一句用于处理分页，其实此时查询已经执行完毕，可以不必关心handleResults方法，但为清楚起见，下面来看看 handleResults的实现：</p>
<p>private void handleResults(RequestScope request, ResultSet rs, int skipResults, int maxResults, RowHandlerCallback callback) throws SQLException {
    try {
       request.setResultSet(rs);
       ResultMap resultMap = request.getResultMap();
      if (resultMap != null) {
        // Skip Results
        if (rs.getType() != ResultSet.TYPE_FORWARD_ONLY) {
          if (skipResults &gt; 0) {
             rs.absolute(skipResults);
           }
         } else {
          for (int i = 0; i &lt; skipResults; i++) {
            if (!rs.next()) {
              break;
             }
           }
         }
        // Get Results
        int resultsFetched = 0;
        while ((maxResults == SqlExecutor.NO_MAXIMUM_RESULTS || resultsFetched &lt; maxResults) &amp;&amp; rs.next()) {
           Object[] columnValues = resultMap.resolveSubMap(request, rs).getResults(request, rs);
           callback.handleResultObject(request, columnValues, rs);
           resultsFetched++;
         }
       }
     } finally {
       request.setResultSet(null);
     }
   }</p>
<p>此处优先使用的是ResultSet的absolute方法定位记录，是否支持absolute取决于具体数据库驱动，但一般当前版本的数据库都支 持该方法，如果不支持则逐条跳过前面的记录。由此可以看出如果数据库支持absolute，则ibatis内置的分页策略与特定数据库的物理分页效率差距 就在于物理分页查询与不分页查询在数据库中的执行效率的差距了。因为查询执行后读取数据前数据库并未把结果全部返回到内存，所以本身在存储占用上应该差距 不大，如果都使用索引，估计执行速度也差不太多。</p>
<p>继续我们的话题。其实只要在executeQuery执行前组装sql，然后将其传给executeQuery，并告诉handleResults 我们不需要逻辑分页即可。拦截executeQuery可以采用aop动态实现，也可直接继承SqlExecutor覆盖executeQuery来静态 地实现，相比之下后者要简单许多，而且由于SqlExecutor没有实现任何接口，比较易变，动态拦截反到增加了维护的工作量，所以我们下面来覆盖 executeQuery：</p>
<p>package com.aladdin.dao.ibatis.ext;
import java.sql.Connection;
import java.sql.SQLException;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import com.aladdin.dao.dialect.Dialect;
import com.ibatis.sqlmap.engine.execution.SqlExecutor;
import com.ibatis.sqlmap.engine.mapping.statement.RowHandlerCallback;
import com.ibatis.sqlmap.engine.scope.RequestScope;
public class LimitSqlExecutor extends SqlExecutor {
    private static final Log logger = LogFactory.getLog(LimitSqlExecutor.class);</p>
<pre><code>private Dialect dialect;
private boolean enableLimit = true;
public Dialect getDialect() {
    return dialect;
 }
public void setDialect(Dialect dialect) {
    this.dialect = dialect;
 }
public boolean isEnableLimit() {
    return enableLimit;
 }
public void setEnableLimit(boolean enableLimit) {
    this.enableLimit = enableLimit;
 }
 @Override
public void executeQuery(RequestScope request, Connection conn, String sql,
         Object[] parameters, int skipResults, int maxResults,
         RowHandlerCallback callback) throws SQLException {
    if ((skipResults != NO_SKIPPED_RESULTS || maxResults != NO_MAXIMUM_RESULTS)
            &amp;&amp; supportsLimit()) {
         sql = dialect.getLimitString(sql, skipResults, maxResults);
        if(logger.isDebugEnabled()){
             logger.debug(sql);
         }
         skipResults = NO_SKIPPED_RESULTS;
         maxResults = NO_MAXIMUM_RESULTS;            
     }
    super.executeQuery(request, conn, sql, parameters, skipResults,
             maxResults, callback);
 }
public boolean supportsLimit() {
    if (enableLimit &amp;&amp; dialect != null) {
        return dialect.supportsLimit();
     }
    return false;
 }
</code></pre><p>}</p>
<p>其中：</p>
<p>skipResults = NO_SKIPPED_RESULTS;
maxResults = NO_MAXIMUM_RESULTS;</p>
<p>告诉handleResults不分页（我们组装的sql已经使查询结果是分页后的结果了），此处引入了类似hibenate中的数据库方言接口Dialect，其代码如下：</p>
<p>package com.aladdin.dao.dialect;
public interface Dialect {</p>
<pre><code>public boolean supportsLimit();
public String getLimitString(String sql, boolean hasOffset);
public String getLimitString(String sql, int offset, int limit);
</code></pre><p>}</p>
<p>下面为Dialect接口的MySQL实现：</p>
<p>package com.aladdin.dao.dialect;
public class MySQLDialect implements Dialect {
    protected static final String SQL_END_DELIMITER = &quot;;&quot;;
    public String getLimitString(String sql, boolean hasOffset) {
        return new StringBuffer(sql.length() + 20).append(trim(sql)).append(
                 hasOffset ? &quot; limit ?,?&quot; : &quot; limit ?&quot;)
                 .append(SQL_END_DELIMITER).toString();
     }
    public String getLimitString(String sql, int offset, int limit) {
         sql = trim(sql);
         StringBuffer sb = new StringBuffer(sql.length() + 20);
         sb.append(sql);
        if (offset &gt; 0) {
             sb.append(&quot; limit &quot;).append(offset).append(&#39;,&#39;).append(limit)
                     .append(SQL_END_DELIMITER);
         } else {
             sb.append(&quot; limit &quot;).append(limit).append(SQL_END_DELIMITER);
         }
        return sb.toString();
     }
    public boolean supportsLimit() {
        return true;
     }
    private String trim(String sql) {
         sql = sql.trim();
        if (sql.endsWith(SQL_END_DELIMITER)) {
             sql = sql.substring(0, sql.length() - 1</p>
<pre><code>                - SQL_END_DELIMITER.length());
     }
    return sql;
 }
</code></pre><p>}</p>
<p>接下来的工作就是把LimitSqlExecutor注入ibatis中。我们是通过spring来使用ibatis的，所以在我们的dao基类中执行注入，代码如下：</p>
<p>package com.aladdin.dao.ibatis;
import java.io.Serializable;
import java.util.List;
import org.springframework.orm.ObjectRetrievalFailureException;
import org.springframework.orm.ibatis.support.SqlMapClientDaoSupport;
import com.aladdin.dao.ibatis.ext.LimitSqlExecutor;
import com.aladdin.domain.BaseObject;
import com.aladdin.util.ReflectUtil;
import com.ibatis.sqlmap.client.SqlMapClient;
import com.ibatis.sqlmap.engine.execution.SqlExecutor;
import com.ibatis.sqlmap.engine.impl.ExtendedSqlMapClient;
public abstract class BaseDaoiBatis extends SqlMapClientDaoSupport {
    private SqlExecutor sqlExecutor;
    public SqlExecutor getSqlExecutor() {
        return sqlExecutor;
     }
    public void setSqlExecutor(SqlExecutor sqlExecutor) {
        this.sqlExecutor = sqlExecutor;
     }
    public void setEnableLimit(boolean enableLimit) {
        if (sqlExecutor instanceof LimitSqlExecutor) {
             ((LimitSqlExecutor) sqlExecutor).setEnableLimit(enableLimit);
         }
     }
    public void initialize() throws Exception {
        if (sqlExecutor != null) {
             SqlMapClient sqlMapClient = getSqlMapClientTemplate()
                     .getSqlMapClient();
            if (sqlMapClient instanceof ExtendedSqlMapClient) {
                 ReflectUtil.setFieldValue(((ExtendedSqlMapClient) sqlMapClient)
                         .getDelegate(), &quot;sqlExecutor&quot;, SqlExecutor.class,
                         sqlExecutor);
             }
         }
     }
     ...
}</p>
<hr>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/框架汇总/">框架汇总</a></li></span><span class="breadcrumb"><li><a href="/categories/框架汇总/">框架汇总</a></li><li><a href="/categories/框架汇总/ORM/">ORM</a></li><li><a href="/categories/框架汇总/ORM/ibatis/">ibatis</a></li></span></span> | <span class="tags">Tagged <a href="/tags/ORM/" class="label label-primary">ORM</a><a href="/tags/ibatis/" class="label label-success">ibatis</a><a href="/tags/框架汇总/" class="label label-info">框架汇总</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:29"datetime="2014-03-07 09:54:29"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-框架汇总-ORM-ibatis--对ibatis分页功能的改进/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-框架汇总-ORM-ibatis--对ibatis分页功能的改进" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-架构师--大型的支付系统，如支付宝、财付通每天交易额都非常巨大，后系统是如何对账、风控的呢？/">大型的支付系统，如支付宝、财付通每天交易额都非常巨大，后系统是如何对账、风控的呢？</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:29.000Z"> <a href="/2014/02/02/2014-02-02-架构师--大型的支付系统，如支付宝、财付通每天交易额都非常巨大，后系统是如何对账、风控的呢？/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="-">大型的支付系统，如支付宝、财付通每天交易额都非常巨大，后系统是如何对账、风控的呢？</h1>
<p><a href="http://www.zhihu.com/question/20091391" target="_blank">大型的支付系统，如支付宝、财付通每天交易额都非常巨大，后系统是如何对账、风控的呢？</a></p>
<p><a href="http://www.zhihu.com/people/tian-shun" target="_blank">天顺</a>，<strong>搞支付的，接受各类支付业务咨询</strong><a href="">收起</a></p>
<p><a href="http://www.zhihu.com/people/liao-yan-48" target="_blank">廖艳</a>、<a href="http://www.zhihu.com/people/morbred" target="_blank">张大维</a>、<a href="http://www.zhihu.com/people/ze-fang-tong-yun" title="泽芳铜芸" target="_blank">泽芳铜芸</a><a href="">等人赞同</a>
谢邀，不过我看到一楼答案50多票赞同后就不想写了。
提问是大型支付系统的风控和对账是如何实现的，答案却是从商户角度谈使用支付公司产品对账的体验。
不过，我今天看到@黄继新 也在其他问题中逆袭了一把，质疑了第一答案。所以我就先放在这里，如果赞同数超过35票，我就把我所做的支付结算系统相关业务经验分享给大家，否则就算啦~
另，暂时没有答案，欢迎折叠。
鉴于已经有30票了，看这样子超过35是没什么太大问题，由于内容众多，我先准备起来了
请大家稍安勿躁
------------------------------------------------------------扯淡的分割线----------------------------------------------------------
先扯淡一下对账，这坑有点大，容我慢慢填。刚刚打了半小时的草稿由于没保存，死机后被系统吃掉了……知乎貌似原来有自动保存功能的……去哪里了……
业务上，为何对账，对账的操作步骤等@詹世波已经说得很多了，我谈谈一些没涉及的。
为了可以更好地解释支付结算系统对账过程，我们先把业务从头到尾串起来描述一下场景，帮助大家理解：
一个可能得不能再可能的场景，请大家深刻理解里面每个角色做了什么，获取了哪些信息：
某日阳光灿烂，支付宝用户小明在淘宝上看中了暖脚器一只，价格100元。犹豫再三后小明使用支付宝网银完成了支付，支付宝显示支付成功，淘宝卖家通知他已发货，最近几日注意查收。
我们来看看这个过程中有几个相关方，分别做了什么。我语文不好，写得饶口，如果看不懂请多看几次：
<strong>小明：</strong>持卡人，消费者，淘宝和支付宝的注册会员，完成了支付动作，自己的银行账户资金减少，交易成功。
<strong>银行：</strong>收单银行，接受来自支付宝的名为“支付宝BBB”的100元订单，并引导持卡人小明支付成功，扣除小明银行卡账户余额后返回给支付宝成功通知，并告诉支付宝这笔交易在银行流水号为“银行CCC”
<strong>支付宝：</strong>支付公司，接收到淘宝发来的订单号为“淘宝AAA”的商户订单号，并形成支付系统唯一流水号：“支付宝BBB”发往银行系统。然后获得银行回复的支付成功信息，顺带银行流水号“银行CCC”
<strong>淘宝：</strong>我们支付公司称淘宝这类电商为商户，是支付系统的客户。淘宝向支付系统发送了一笔交易收单请求，金额为100，订单号为:“淘宝AAA”，支付系统最后反馈给淘宝这笔支付流水号为“支付BBB”
以上流程貌似大家都达到了预期效果，但实际上仍然还有一个问题：
对支付公司（支付宝）而言，虽然银行通知了它支付成功，但资金实际还要T+1后结算到它银行账户，所以目前只是一个信息流，资金流还没过来。
<strong>Tips:</strong>插一句话，对支付系统内部账务来说，由于资金没有能够实时到账，所以此时小明的这笔100元交易资金并没有直接记入到系统资产类科目下的“银行存款”科目中，而是挂在“应收账款”或者“待清算科目”中。大白话就是，这100元虽然答应给我了，我也记下来了，但还没收到，我挂在那里。
对商户（淘宝）而言，虽然支付公司通知了它支付成功，他也发货了，但资金按照合同也是T+1到账。如果不对账确认一下，恐怕也会不安。
倒是对消费者（小明）而言：反正钱付了，你们也显示成功了，等暖脚器呀等暖脚器~
基于支付公司和商户的困惑，我们的支付结算系统需要进行两件事情：一是资金渠道对账，通称对银行帐；二是商户对账，俗称对客户帐。对客户帐又分为对公客户和对私客户，通常对公客户会对对账文件格式、对账周期、系统对接方案有特殊需求，而对私客户也就是我们一般的消费者只需要可以后台查询交易记录和支付历史流水就可以了。
<strong>我们先聊银行资金渠道对账，由于支付公司的资金真正落地在商业银行，所以资金渠道的对账显得尤为重要。</strong>
在一个银行会计日结束后，银行系统会先进行自己内部扎帐，完成无误后进行数据的清分和资金的结算，将支付公司当日应入账的资金结算到支付公司账户中。于此同时，目前多数银行已经支持直接系统对接的方式发送对账文件。
于是，在某日临晨4点，支付宝系统收到来自银行发来的前一会计日对账文件。根据数据格式解析正确后和前日支付宝的所有交易数据进行匹配，理想情况是一一匹配成功无误，然后将这些交易的对账状态勾对为“已对账”。
<strong>Tips:</strong>此时，对账完成的交易，会将该笔资金从“应收账款”或者“待清算账款”科目中移动到“银行存款”科目中，以示该交易真正资金到账。
以上太理想了，都那么理想就不要对账了。所以通常都会出一些差错，那么我总结了一下常见的差错情况：
1.支付时提交到银行后没有反馈，但对账时该交易状态为支付成功
这种情况很正常，因为我们在信息传输过程中，难免会出现掉包和信息不通畅。消费者在银行端完成了支付行为，银行的通知信息却被堵塞了，如此支付公司也不知道结果，商户也不知道结果。如果信息一直没法通知到支付公司这边，那么这条支付结果就只能在日终对账文件中体现了。这时支付公司系统需要对这笔交易进行补单操作，将交易置为成功并完成记账规则，有必要还要通知到商户。
<strong>此时的小明：估计急的跳起来了……付了钱怎么不给说支付成功呢！坑爹！</strong>
<strong>TIPS：</strong>通常银行系统会开放一个支付结果查询接口。支付公司会对提交到银行但没有回复结果的交易进行间隔查询，以确保支付结果信息的实时传达。所以以上情况出现的概率已经很少了。
2.我方支付系统记录银行反馈支付成功，金额为100，银行对账金额不为100
这种情况已经不太常见了，差错不管是长款和短款都不是我们想要的结果。通常双方系统通讯都是可作为纠纷凭证的，如果银行在支付结果返回时确认是100元，对账时金额不一致，可以要求银行进行协调处理。而这笔账在支付系统中通常也会做对应的挂账处理，直到纠纷解决。
3.我方支付系统记录银行反馈支付成功，但对账文件中压根不存在
这种情况也经常见到，因为跨交易会计日的系统时间不同，所以会出现我们认为交易是23点59分完成的，银行认为是第二天凌晨0点1分完成。对于这种情况我们通常会继续挂账，直到再下一日的对账文件送达后进行对账匹配。
如果这笔交易一直没有找到，那么就和第二种情况一样，是一种短款，需要和银行追究。
以上情况针对的是一家银行资金渠道所作的流程，实际情况中，支付公司会在不同银行开立不同银行账户，用以收单结算（成本会降低），所以真实情况极有可能是：
临晨1点，工行对账文件丢过来（支行A）
临晨1点01分，工行又丢一个文件过来（支行B）
临晨1点15分，农行对账文件丢过来
。 。 。
临晨5点，兴业银行文件丢过来
。。。
不管什么时候，中国银行都必须通过我方业务员下载对账文件再上传的方式进行对账，所以系统接收到中行文件一般都是早上9点05分……
对系统来说，每天都要处理大量并发的对账数据，如果在交易高峰时段进行，会引起客户交互的延迟和交易的失败，这是万万行不得的
所以通常支付公司不会用那么傻的方式处理数据，而是在一个会计日结束后，通常也是临晨时段，将前一日交易增量备份到专用对账服务器中，在物理隔绝环境下进行统一的对账行为，杜绝硬件资源的抢占。
以上是银行资金渠道入款的对账，出款基本原理一致，不过出款渠道在实际业务过程中还有一些特别之处，由于大家不是要建设系统，我就不赘述了。
<strong>谈完了资金渠道的对账，我们再来看看对客户帐。</strong>
前面提到了，由于资金落在银行，所以对支付公司来说，对银行帐非常重要。那么同理，由于资金落在支付公司，所以对商户来说，对支付公司账也一样重要。能否提供高品质甚至定制化的服务，是目前支付公司走差异化路线的一个主要竞争点。
就流程而言@詹世波已经说的差不多了，我就不赘述了……
----------------------------------------------------------没经过排版的小知识点---------------------------------------------------
之前说过，银行与支付公司之间的通讯都是可以作为纠纷凭证的。原理是对支付报文的关键信息进行密钥加签+md5处理，以确保往来报文“<strong>不可篡改，不可抵赖</strong>”。
同理，支付公司和商户之间也会有类似机制保证报文的可追溯性，由此我们可以知道，一旦我方支付系统通知商户支付结果，那么我们就要为此承担责任。由此我们再推断一个结论：
<strong>即便某支付订单银行方面出错导致资金未能到账，一旦我们支付系统通知商户该笔交易成功，那么根据协议该结算的资金还是要结算给这个商户。自然，我们回去追究银行的问题，把账款追回。</strong>
----------------------------------------------------------没经过排版的小知识点---------------------------------------------------
一、对支付系统而言，最基本的对账功能是供商户在其后台查询下载某一时间段内的支付数据文件，以供商户自己进行对账。
这个功能应该是个支付公司就有，如果没有就别混了。
二、对大多数支付系统而言，目前已经可以做到对账文件的主动投送功能。
这个功能方便了商户系统和支付系统的对接，商户的结算人员无须登录支付平台后台下载文件进行对账，省去了人工操作的麻烦和风险。
对大型支付系统而言，商户如果跨时间区域很大，反复查询该区域内的数据并下载，会对服务器造成比较大的压力。各位看官别笑，觉得查个数据怎么就有压力了。实际上为了这个查询，我最早就职的一家支付公司重新优化了所有SQL语句，并且因为查询压力过大服务器瘫痪过好几次。
现在比较主流的做法是把商户短期内查询过、或者经常要查询的数据做缓存。实在不行就干脆实时备份，两分钟同步一次数据到专用数据库供商户查询，以避免硬件资源占用。甚至……大多数支付公司都会对查询范围跨度和历史事件进行限制，比如最多只能查一个月跨度内，不超过24个月前的数据……以避免服务嗝屁。
对账这块大致就这样了，再往细的说就说不完了，大家有什么想问的可以单M我或者回复答案。
稍后给大家讲一下风控。
-----------------------------------------------风控的分割线-------------------------------------------
风险控制，在各行各业都尤其重要。
金融即风险，控制好风险，才有利润。
虽然第三方支付严格意义上说并非属于金融行业，但由于涉及资金的清分和结算，业务主体又是资金的收付，所以风险控制一样非常重要。
对支付公司来说，风控主要分为合规政策风控以及交易风控两种。
前者主要针对特定业务开展，特定产品形态进行法规层面的风险规避，通常由公司法务和风控部门一起合作进行。例如，一家公司要开展第三方支付业务，现在要获得由人民银行颁发的“支付业务许可证”。遵守中国对于金融管制的所有条规，帮助人行监控洗钱行为……这些法规合规风险，虽然条条框框，甚至显得文绉绉，但如果没人解读没人公关，业务都会无法开展。
当然，这块也不是本题所关注的重点，提问者关注的，应当是业务进行过程中的交易风控环节。
现在随着各支付公司风险控制意识的加强，风控系统渐渐被重视起来。除了上述提到的合规风控相关功能，风控系统最讲技术含量，最讲业务水平，最考究数据分析的业务就是交易风控环节。
对一笔支付交易而言，在它发生之前、发生过程中及发生过程后，都会被风控系统严密监控，以确保支付及客户资产安全。而所有的所有秘密，都归结到一个词头上：规则。风控系统是一系列规则的集合，任何再智能的风控方案，都绕不开规则二字。
我们先看看，哪些情况是交易风控需要监控处理的：
1.钓鱼网站
什么是钓鱼呢？
用我的说法，就是利用技术手段蒙蔽消费者，当消费者想付款给A的时候，替换掉A的支付页面，将钱付给B，以达成非法占用资金的目的。
还有更低级的，直接就是发小广告，里面带一个类似<a href="http://tiaobao.com/" target="_blank"><a href="http://tiaobao.com">http://tiaobao.com</a></a>的网址，打开后和淘宝页面一摸一样，上当客户直接付款给假冒网站主。
第一种情况风控系统是可以通过规则进行简单判定的，虽然有误杀，但不会多。
通常使用的规则是判断提交订单的IP地址和银行实际支付完成的IP地址是否一致，如果不一致，则判断为钓鱼网站风险交易，进入待确认订单。
但第二种情况，亲爹亲娘了，支付公司真的没办法。当然遇到客户投诉后可能会事后补救，但交易是无法阻止了。
2.盗卡组织利用盗卡进行交易
大家都知道，信用卡信息是不能随便公布给别人的，国内大多信用卡虽然都设置了密码，但银行仍然会开放无磁无密支付接口给到商户进行快速支付之用。
所谓无磁无密，就是不需要磁道信息，不需要密码就可以进行支付的通道。只需要获取到客户的CVV，有效期，卡号三个核心信息，而这三个信息是在卡上直接有的，所以大家不要随便把卡交给别人哦~
碰到类似的这种交易，风控系统就不会像钓鱼网站这样简单判断了。
过去我们所有的历史交易，都会存库，不仅会存支付相关信息，更会利用网页上的控件（对，恶心的activex或者目前用的比较多的flash控件）抓取支付者的硬件信息，存储在数据库中。
当一笔交易信息带着能够搜集到的硬件信息一同提交给风控系统时，风控系统会进行多种规则判定。
例如：当天该卡是否交易超过3次
当天该IP是否交易超过3次
该主机CPU的序列号是否在黑名单之列
等等等等，一批规则跑完后，风控系统会给该交易进行加权评分，标示其风险系数，然后根据评分给出处理结果。
通过硬件信息采集以及历史交易记录回溯，我们可以建立很多交易风控规则来进行监控。所以规则样式的好坏，规则系数的调整，就是非常重要的用以区别风控系统档次高低的标准。
例如，我听说著名的风控厂商RED，有一个“神经网络”机制，灰常牛逼。
其中有一个规则我到现在还记忆犹新：
某人早上八点在加利福尼亚进行了信用卡支付，到了下午一点，他在东亚某小国家发起了信用卡支付申请。系统判断两者距离过长，不是短短5小时内能够到达的，故判定交易无效，支付请求拒绝。
规则非常重要，当然，数据也一样重要。我们不仅需要从自己的历史记录中整合数据，同时还要联合卡组织、银行、风控机构，购买他们的数据和风控服务用来增加自己的风控实力。
SO，风控是一个不断积累数据、分析数据、运营数据、积累数据的循环过程。
好的风控规则和参数，需要经过无数次的规则修改和调整，是一个漫长的过程。
不知道大家做互联网，有没有利用GA做过AB测试，同样的，风控系统也需要反复地做类似AB测试的实验，以保证理论和实际的匹配。
最后给大家说一个小小的概念：
所谓风控，是指风险控制，不是风险杜绝。
风控的目标一定不是把所有风险全部杜绝。
合理的风控，目标一定是：利润最大化，而不是风险最小化
过于严格的风控规则，反而会伤害公司利益（看看销售和风控经常打架就知道了）
不光是交易的风控，我们日常制定规则，法规，公司流程，也一定要秉着这个出发点进行规划。
以上，基本上差不多了，有问题大家随时留言评论我。
谢谢大家原谅我的傲娇，给我点了那么多票赞同，受之有愧。
最近（2013年7月）回头看了一下这个答案，感觉有一些描述不够精确，有一些语言不够精炼，思考着是不是重构一下这个答案……<a href=""></a></p>
<p><a href="http://www.zhihu.com/question/20091391/answer/15591658" target="_blank">2013-07-02</a><a href="">57 条评论</a><a href="">感谢</a><a href="">分享</a><a href="">收藏</a>•<a href="">没有帮助</a>•<a href="">举报</a></p>
<p><a href=""></a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/yangxi" title="杨希"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/yangxi" title="杨希" target="_blank">杨希</a></p>
<p>顺哥傲娇了……
2012-11-14<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/tian-shun" title="天顺"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）回复 <a href="http://www.zhihu.com/people/yangxi" title="杨希" target="_blank">杨希</a></p>
<p>啊，哈哈哈
2012-11-14<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/huwei-98" title="HuWei"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/huwei-98" title="HuWei" target="_blank">HuWei</a></p>
<p>所以，没有答案，哪来赞同，奇怪~
2012-11-15<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/renxue" title="renxue"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/renxue" title="renxue" target="_blank">renxue</a></p>
<p>我也觉得傲娇了 你写答案是为了得到赞同吗？
2012-11-15<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/du-bai-xing" title="度百行"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/du-bai-xing" title="度百行" target="_blank">度百行</a></p>
<p>赞成一下，期待更多专业的回答~
2012-11-15<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/tian-shun" title="天顺"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）回复 <a href="http://www.zhihu.com/people/renxue" title="renxue" target="_blank">renxue</a></p>
<p>不喜勿入，根据知乎规定，目前这个答案可点“没有帮助”。
如果一个需要写好久的答案实际上没什么人关注，那我觉得没必要花那么多精力分享。我写答案不是为了赞同，但也不希望浪费时间。如果只有一两个人关心，我完全可以通过IM工具随时回答他们问题。
2012-11-15<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>2</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/zhanshibo" title="詹世波"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/zhanshibo" title="詹世波" target="_blank">詹世波</a></p>
<p>哈哈，我也希望看到更切题的答案和回复，但一直没有出现，然后我就个人知道和了解的抛砖引玉了一把，希望引出更多的意见和答案，结果来了60多票.....
兄台莫恼哈，其实很多人都想了解支付结算系统相关业务，你就给大家科普一把嘛。
2012-11-15<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/zhanshibo" title="詹世波"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/zhanshibo" title="詹世波" target="_blank">詹世波</a></p>
<p>看了下<a href="http://www.zhihu.com/people/tian-shun" target="_blank">@天顺</a> 的资料，原来是盛付通的啊，哈哈，真正的专业人士啊，欢迎科普
2012-11-15<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/tian-shun" title="天顺"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）回复 <a href="http://www.zhihu.com/people/zhanshibo" title="詹世波" target="_blank">詹世波</a></p>
<p>哈哈，我不恼，分享原本应该就是快乐的，不过我性格如此，说话总是比较刺，您才不要见怪。
2012-11-15<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><img src="&quot;知乎用户&quot;" alt=""></p>
<p>知乎用户</p>
<p>自动保存系统只有在草稿状态的时候才有用。所以在改答案的时候，要么就定期保存，要么就先在本地写好了…………【惨痛教训……
2012-11-15<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/ban-ma" title="斑马"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/ban-ma" title="斑马" target="_blank">斑马</a></p>
<p><a href="http://www.zhihu.com/people/liu-chu-qiao" target="_blank">@刘楚桥</a>
2012-11-15<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/tian-shun" title="天顺"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）回复 知乎用户</p>
<p>相当惨痛……
2012-11-15<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/san-tian" title="三田"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/san-tian" title="三田" target="_blank">三田</a></p>
<p>想请教一下小明那个场景，如果小明用支付宝网银支付淘宝上的购物的话，我理解应该这样，
消费者：小明
收单机构：支付宝
商户：淘宝
发卡银行：网银银行
卡组织：银联
关于对账还真是门学问呢，看来要学的还真多。多谢。
2012-11-16<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/tian-shun" title="天顺"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）回复 <a href="http://www.zhihu.com/people/san-tian" title="三田" target="_blank">三田</a></p>
<p>这个过程就把卡组织剔除掉吧，便于沟通。实际上大多数支付公司网银也是直连银行，没有通过银联系统做资金清分。
2012-11-16<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/zhanshibo" title="詹世波"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/zhanshibo" title="詹世波" target="_blank">詹世波</a></p>
<p><a href="http://www.zhihu.com/people/tian-shun" target="_blank">@天顺</a> 同学讲下Paypal或信用卡对账吧，我之前搞对账的时候最怕弄的就是这块，到现在都还有点搞不清楚
2012-11-16<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/tian-shun" title="天顺"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）</p>
<p><a href="http://www.zhihu.com/people/zhanshibo" target="_blank">@詹世波</a> 原本我的博客里把外卡相关的东西全给介绍了，无奈后来服务器没续费，报废了，又没保存……这些玩意写起来要命，关注的人又不多……所以我后来就越来越懒得写了，哈哈
2012-11-16<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/shi-wei-89-73" title="时伟"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/shi-wei-89-73" title="时伟" target="_blank">时伟</a></p>
<p>我怎么觉得，最后一句才是重点。。
2012-11-16<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/mi-su" title="米苏"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/mi-su" title="米苏" target="_blank">米苏</a></p>
<p>其实对账文件的收发，勾兑，差错处理基本上来说，已经可以实现系统自动化处理了。对于商户B2C平台、支付平台、自连银行之间由于扎差时间或系统时间不同产生的差异，才是对账处理最麻烦的地方
2012-11-16<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/iris-chen" title="Iris Chen"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/iris-chen" title="Iris Chen" target="_blank">Iris Chen</a></p>
<p>对账终于理顺了，等待风控的描述。
2012-11-17<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/he-jian-liang" title="何建亮"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/he-jian-liang" title="何建亮" target="_blank">何建亮</a></p>
<p>why 35?
2012-11-20<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/tian-shun" title="天顺"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）回复 <a href="http://www.zhihu.com/people/he-jian-liang" title="何建亮" target="_blank">何建亮</a></p>
<p>随便说个数字，哈哈~有点人数关注，写了才有意义呀
2012-11-21<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/lu-yao-21" title="璐瑶"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/lu-yao-21" title="璐瑶" target="_blank">璐瑶</a></p>
<p>“通常使用的规则是判断提交订单的IP地址和银行实际支付完成的IP地址是否一致，如果不一致，则判断为钓鱼网站风险交易，进入待确认订单。”
弱弱的问下，提交订单跟完成支付不都是用户行为么，为什么IP不一致会认定为钓鱼网站呢？
2012-11-28<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/tian-shun" title="天顺"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）回复 <a href="http://www.zhihu.com/people/lu-yao-21" title="璐瑶" target="_blank">璐瑶</a></p>
<p>完整支付行为的是用户，而发起订单的是钓鱼网站，两者IP不匹配。
2012-11-28<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/lu-yao-21" title="璐瑶"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/lu-yao-21" title="璐瑶" target="_blank">璐瑶</a>回复 <a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）</p>
<p>呵呵，了解了，非常感谢～
2012-11-30<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/jixin" title="黄继新"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/jixin" title="黄继新" target="_blank">黄继新</a></p>
<p>恭喜天顺逆袭成功！要相信知乎社区的力量〜
2012-12-05<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/tian-shun" title="天顺"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）回复 <a href="http://www.zhihu.com/people/jixin" title="黄继新" target="_blank">黄继新</a></p>
<p>感谢继新赐予我力量！
2012-12-05<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/tujian" title="柏拉图"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/tujian" title="柏拉图" target="_blank">柏拉图</a></p>
<p>辛苦了。码字哈多。<a href="http://www.zhihu.com/people/tian-shun" target="_blank">@天顺</a> 这个才是在支付公司应该学的东西。
2012-12-05<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/tian-shun" title="天顺"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）回复 <a href="http://www.zhihu.com/people/tujian" title="柏拉图" target="_blank">柏拉图</a></p>
<p>这只是系统建设层面小小的经验，其实要做支付，还有很多很多……都不知从何说起。
2012-12-05<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/jia-peng" title="贾鹏"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/jia-peng" title="贾鹏" target="_blank">贾鹏</a></p>
<p>天顺儿，这篇文章第一部分，有小明、银行、支付宝、淘宝的角色，在“银行”的角色里应该是“发卡行”而不是“收单行”吧，因为支付宝本身就处理收单工作了
2012-12-05<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/tian-shun" title="天顺"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）回复 <a href="http://www.zhihu.com/people/jia-peng" title="贾鹏" target="_blank">贾鹏</a></p>
<p>线上网银渠道，发卡行就是收单行，不太会有银行作为收单行替其他行收单。外卡除外。
2012-12-05<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/jia-peng" title="贾鹏"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/jia-peng" title="贾鹏" target="_blank">贾鹏</a>回复 <a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）</p>
<p>哈，在银联在线支付里，就有收单和发卡之分
2012-12-05<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/tian-shun" title="天顺"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）</p>
<p>不太明白你所说的究竟为何……
2012-12-05<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/etsir" title="徐梁君"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/etsir" title="徐梁君" target="_blank">徐梁君</a>回复 <a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）</p>
<p><a href="http://www.zhihu.com/people/jia-peng" target="_blank">@贾鹏</a> 第三方支付裏面，其實無所謂發卡、收單角色。如果一定要套用，的確銀行作爲發卡銀行來描述比較準確。<a href="http://www.zhihu.com/people/tian-shun" target="_blank">@天顺</a> 文中的描述有誤。
2012-12-05<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/tian-shun" title="天顺"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）回复 <a href="http://www.zhihu.com/people/etsir" title="徐梁君" target="_blank">徐梁君</a></p>
<p>对第三方支付公司而言，所有收单银行渠道，即是他的收单行。
对收单行来说，第三方支付公司是收单商户。对第三方支付而言，收单银行即是收单行。
什么情况下需要区分发卡行和收单行？
也就是收单渠道不仅支持本行银行卡收单，同时支持他行卡收单时，会区分发卡行和收单行。
在互联网上，通常对第三方支付而言，无所谓区分发卡行和收单行，原因是事实上互联网支付基本都是本银行卡走本银行渠道，也就是线下POS所称的“本代本”。试问自己发的卡自己收单，又何必计较收单和发卡呢？
线下POS、外卡支付之所以要区分发卡行收单行，是因为其资金渠道特殊性所致。例如：通过银联清分网络，招行的POS机也可以刷工行的卡，然后通过银联进行数据清分，走跨行的资金清算轧张。
但互联网渠道，网银支付，99.99%的第三方支付渠道都是一家一家银行系统对接，对第三方支付的商户来说，第三方支付公司是收单机构；对持卡人来说，他所持信用卡的所在银行是发卡行；对第三方支付公司来说，前面是商户，后面是收单行，仅此而已。
当然，外卡的渠道和国内不同，将来可以单开一个专题去讨论。
2012-12-05<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/baiya" title="白鸦"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/baiya" title="白鸦" target="_blank">白鸦</a></p>
<p>画图吧。这事儿文字太难说清楚了
2012-12-06<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/jia-peng" title="贾鹏"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/jia-peng" title="贾鹏" target="_blank">贾鹏</a>回复 <a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）</p>
<p>你说的对
2012-12-06<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/etsir" title="徐梁君"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/etsir" title="徐梁君" target="_blank">徐梁君</a>回复 <a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）</p>
<p>你说的都对，我之前的表述也是同一个意思，但是有一点：第三方模式下，银行对持卡人来说是发卡行，对第三方来说才是收单行。所以要看文中描述时的主语是谁
2012-12-06<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/tian-shun" title="天顺"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）回复 <a href="http://www.zhihu.com/people/etsir" title="徐梁君" target="_blank">徐梁君</a></p>
<p>在网银支付过程中，持卡人无所谓发卡行和收单行概念，他只需要知道商户需要收钱，钱付给了支付宝即可。收单银行只对第三方支付机构有意义，何况从头至尾，基本都是站在第三方支付的角度看待问题，我觉得兄台无需在这个称呼上继续纠结了。
2012-12-06<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/wu-jing-qi" title="吴婧婍"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/wu-jing-qi" title="吴婧婍" target="_blank">吴婧婍</a></p>
<p>对于后来者，这个答案确实和日常工作非常接近，学习了！
2012-12-07<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/tedeyang" title="宝术"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/tedeyang" title="宝术" target="_blank">宝术</a></p>
<p>「银行丢个文件」银行确实只会丢文件
2012-12-27<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><img src="&quot;知乎用户&quot;" alt=""></p>
<p>知乎用户</p>
<p>那家风控企业应该是ReD（Retail Decisions），但是我看到首先想到的是Red Bend，好容易混淆。
2013-04-19<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/chen-song-53" title="陈嵩"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/chen-song-53" title="陈嵩" target="_blank">陈嵩</a></p>
<p>所以，广义范围内“出纳”
2013-06-22<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/eddy07" title="Eddy"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/eddy07" title="Eddy" target="_blank">Eddy</a></p>
<p>咨询个问题：刚看到一些关于三方那个支付机构的法规,三方支付机构必须将资金托管在一个银行，而你在这里写到三方支付公司基本上在每个银行都会有一个账户。那么这个银行账户和托管银行的资金交接是怎么一个过程呢？
2013-06-23<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/lukenothing" title="luke luke"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/lukenothing" title="luke luke" target="_blank">luke luke</a></p>
<p>请问，“支付BBB”与“支付宝BBB”是不是一样的？
2013-06-24<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/tian-shun" title="天顺"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）回复 <a href="http://www.zhihu.com/people/lukenothing" title="luke luke" target="_blank">luke luke</a></p>
<p>恩，一样的。
2013-06-24<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>1</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/tian-shun" title="天顺"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）回复 <a href="http://www.zhihu.com/people/eddy07" title="Eddy" target="_blank">Eddy</a></p>
<p>私信回了。
2013-06-24<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/roy-xie" title="Roy.Xie"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/roy-xie" title="Roy.Xie" target="_blank">Roy.Xie</a>回复 <a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）</p>
<p>天顺 老兄厉害，长知识了。听君一席话，胜读10年书。
2013-06-27<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/yituo-xiao-xin" title="一坨小欣"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/yituo-xiao-xin" title="一坨小欣" target="_blank">一坨小欣</a></p>
<p>举手提问：顺哥写的好清晰，但是还有几个小问题请教：
1.既然支付公司会在各家银行都开账户，那客户支付的款项不是可以立刻到账么?为什么是T+1日？（我知道这是个小问题，跟主题没啥子关系，囧。。。）
2.是否有人通过支付系统进行洗钱？现在有把反洗钱纳入风控范畴么？
3.风控预警的效率高不高?会不会有很多误判？（银行从业人员表示，我们的预警量实在是忒多了= =!）
2013-07-08<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/tian-shun" title="天顺"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）回复 <a href="http://www.zhihu.com/people/yituo-xiao-xin" title="一坨小欣" target="_blank">一坨小欣</a></p>
<p>一个一个回答哈。
1.T+1日只是普遍情况，大多数银行的网银收单产品的确就是规定的T+1保证到款。当然据我所知已经有部分银行支持即时到账了，这个问题应该问银行，而不是支付公司。
2.有通过支付公司洗钱的，目前仍然有，甚至不少支付公司（不点名了）很多产品就是明着往灰色地带走的。当然，人民银行要求配合的反洗钱措施都会做的，商户审核也会相对走过场，不会太过分。
3.会有误判，这个避免不了，所以风控才是一门学问啊。
2013-07-08<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/chen-han-66" title="沈晗"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/chen-han-66" title="沈晗" target="_blank">沈晗</a></p>
<p>哥们你现在不搞技术，专心忽悠了吧，这么罗里吧嗦的解释最终细节部分却少的可怜。
2013-07-08<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/tian-shun" title="天顺"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）回复 <a href="http://www.zhihu.com/people/chen-han-66" title="沈晗" target="_blank">沈晗</a></p>
<p>哥们，不知道你现在是搞什么的，相信大家都会鼓励你来一篇细节部分多得令人发指的答案出来，我第一时间帮你点赞！
2013-07-08<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/min-you" title="闵游"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/min-you" title="闵游" target="_blank">闵游</a></p>
<p>作者好用心，还很谦逊，好人一个
2013-07-08<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/su-chi-chi" title="苏迟迟"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/su-chi-chi" title="苏迟迟" target="_blank">苏迟迟</a></p>
<p>请问支付宝公司账户上客户的资金，会用于购买短期的定期理财产品么？还是说，只是和银行谈一个比较高的利率，吃利息？
2013-07-08<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/tian-shun" title="天顺"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/tian-shun" title="天顺" target="_blank">天顺</a>（作者）回复 <a href="http://www.zhihu.com/people/su-chi-chi" title="苏迟迟" target="_blank">苏迟迟</a></p>
<p>八仙过海各显神通，呵呵。你说的方式其实都是可以的，主要看合作的商业银行内部如何帮你包装这个事情，单纯吃活期利息岂不亏死了……
2013-07-09<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/zhang-hong-wei-95" title="张宏伟"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/zhang-hong-wei-95" title="张宏伟" target="_blank">张宏伟</a></p>
<p>很有帮助
2013-07-09<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a></p>
<p><a href=""></a><a href="http://www.zhihu.com/people/hai-li-35" title="hai li"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/hai-li-35" title="hai li" target="_blank">hai li</a></p>
<p>不错
2013-07-09<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
<a href=""></a><a href="http://www.zhihu.com/people/ziming-shen" title="ziming shen"><img src="" alt=""></a></p>
<p><a href="http://www.zhihu.com/people/ziming-shen" title="ziming shen" target="_blank">ziming shen</a></p>
<h2 id="-">合理的风控，目标一定是：利润最大化，而不是风险最小化</h2>
<p>多希望公司那个213的风控能看到。
2013-07-09<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">回复</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">赞</a><em>0</em> 赞<a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">举报</a>
写下你的评论…</p>
<p><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">评论</a><a href="http://www.zhihu.com/question/20091391/answer/15591658#" target="_blank">取消</a>
只有作者关注的人才能在这里评论
知乎是一个真实的问答社区，在这里分享知识、经验和见解，发现更大的世界。
<a href="">使用邮箱注册 »</a></p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/架构师/">架构师</a></li></span></span> | <span class="tags">Tagged <a href="/tags/架构师/" class="label label-primary">架构师</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:29"datetime="2014-03-07 09:54:29"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-架构师--大型的支付系统，如支付宝、财付通每天交易额都非常巨大，后系统是如何对账、风控的呢？/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-架构师--大型的支付系统，如支付宝、财付通每天交易额都非常巨大，后系统是如何对账、风控的呢？" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-架构师--PODC-keynote/">PODC</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:29.000Z"> <a href="/2014/02/02/2014-02-02-架构师--PODC-keynote/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="podc-keynote">PODC-keynote</h1>
<p><img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> Inktomi at a Glance
Company Overview Applications
Search Technology Network Products Online Shopping Wireless Systems
Towards Robust Distributed Systems
Dr. Eric A. Brewer
Professor, UC Berkeley Co-Founder &amp; Chief Scientist, Inktomi CoPODC Keynote, July 19, 2000
“INKT” on NASDAQ Founded 1996 out of UC Berkeley ~700 Employees
PODC Keynote, July 19, 2000
Our Perspective
Inktomi builds two distributed systems:
– Global Search Engines – Distributed Web Caches
“Distributed Systems” don’t work...
There exist working DS:
– Simple protocols: DNS, WWW – Inktomi search, Content Delivery Networks – Napster, Verisign, AOL
Based on scalable cluster &amp; parallel computing technology But very little use of classic DS research...
PODC Keynote, July 19, 2000
But these are not classic DS:
– – – – Not distributed objects No RPC No modularity Complex ones are single owner (except phones)
PODC Keynote, July 19, 2000
1
<img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> Three Basic Issues
Where is the state? Consistency vs. Availability Understanding Boundaries
PODC Keynote, July 19, 2000
Where’s the state?
(not all locations are equal)
PODC Keynote, July 19, 2000
Santa Clara Cluster
Delivering High Availability
We kept up the service through: Crashes &amp; disk failures (weekly) Database upgrades (daily) Software upgrades (weekly to monthly) OS upgrades (twice) Power outage (several) Network outages (now have 11 connections) Physical move of all equipment (twice)
PODC Keynote, July 19, 2000 PODC Keynote, July 19, 2000
• Very uniform • No monitors • No people • No cables • Working power • Working A/C • Working BW
2
<img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> Berkeley Ninja Architecture Persistent State is HARD
Base: Scalable, highlyavailable platform for persistent-state services
Classic DS focus on the computation, not the data
– this is WRONG, computation is the easy part
Workstations &amp; PCs
Data centers exist for a reason
– can’t have consistency or availability without them AP
Internet
Other locations are for caching only:
– proxies, basestations, set-top boxes, desktops basestations, set– phones, PDAs, … PDAs,
Active Proxy: Bootstraps thin devices into infrastructure, runs mobile code
AP
Distributed systems can’t ignore location distinctions
Cellphones, Pagers, etc.
PODC Keynote, July 19, 2000
PDAs (e.g. IBM Workpad)
ACID vs. BASE
DBMS research is about ACID (mostly)
Consistency vs. Availability
(ACID vs. BASE)
But we forfeit “C” and “I” for availability, graceful degradation, and performance
This tradeoff is fundamental.
BASE: – Basically Available – Soft-state oft– Eventual consistency
PODC Keynote, July 19, 2000
PODC Keynote, July 19, 2000
3
<img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> ACID vs. BASE
ACID
Strong consistency Isolation Focus on “commit” Nested transactions Availability? Conservative (pessimistic) Difficult evolution (e.g. schema)
–
The CAP Theorem
BASE
Weak consistency
stale data OK
Availability first Best effort Approximate answers OK Aggressive (optimistic) Simpler! Faster Easier evolution Tolerance to network
Consistency
Availability
Partitions
But I think it’s a spectrum
PODC Keynote, July 19, 2000
Theorem: You can have at most two of these properties for any shared-data system
PODC Keynote, July 19, 2000
Forfeit Partitions
Examples Single-site databases SingleCluster databases
Forfeit Availability
Examples Distributed databases Distributed locking
Consistency
Availability
LDAP xFS file system Traits 2-phase commit cache validation protocols
PODC Keynote, July 19, 2000
Consistency
Availability
Majority protocols
Traits Tolerance to network
Tolerance to network
Partitions
Partitions
Pessimistic locking Make minority partitions unavailable
PODC Keynote, July 19, 2000
4
<img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> Forfeit Consistency
Examples Coda Web cachinge
These Tradeoffs are Real
The whole space is useful Real internet systems are a careful mixture of ACID and BASE subsystems
– We use ACID for user profiles and logging (for revenue) Traits
Consistency
Availability
DNS
But there is almost no work in this area Symptom of a deeper problem: systems and database communities are separate but overlapping (with distinct vocabulary)
PODC Keynote, July 19, 2000
Tolerance to network
expirations/leases conflict resolution optimistic
PODC Keynote, July 19, 2000
Partitions
CAP Take Homes
Can have consistency &amp; availability within a cluster (foundation of Ninja), but it is still hard in practice OS/Networking good at BASE/Availability, but terrible at consistency Databases better at C than Availability Wide-area databases can’t have both WideDisconnected clients can’t have both All systems are probabilistic…
PODC Keynote, July 19, 2000 PODC Keynote, July 19, 2000
Understanding Boundaries
(the RPC hangover)
5
<img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> The Boundary
The interface between two modules
– client/server, peers, libaries, etc… libaries,
Different Address Spaces
What if the two sides are NOT in the same address space?
– IPC or LRPC
Basic boundary = the procedure call
C S
Can’t do pass-by-reference (pointers) pass-by– Most IPC screws this up: pass by value-result value– There are TWO copies of args not one
– thread traverses the boundary – two sides are in the same address space
PODC Keynote, July 19, 2000
What if they share some memory?
– Can pass pointers, but… – Need synchronization between client/server – Not all pointers can be passed
PODC Keynote, July 19, 2000
Trust the other side?
What if we don’t trust the other side? Have to check args, no pointer passing args, Kernels get this right:
– copy/check args – use opaque references (e.g. File Descriptors)
Partial Failure
Can the two sides fail independently?
– RPC, IPC, LRPC
Can’t be transparent (like RPC) !! New exceptions (other side gone) Reclaim local resources
– e.g. kernels leak sockets over time =&gt; reboot
Most systems do not:
– TCP – Napster – web browsers
PODC Keynote, July 19, 2000
Can use leases?
– Different new exceptions: lease expired
RPC tries to hide these issues (but fails)
PODC Keynote, July 19, 2000
6
<img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> Multiplexing clients?
Boundary evolution?
Does the server have to:
– – – – – deal with high concurrency? Say “no” sometimes (graceful degradation) Treat clients equally (fairness) Bill for resources (and have audit trail) Isolate clients performance, data, ….
Can the two sides be updated independently? (NO) The DLL problem... Boundaries need versions Negotiation protocol for upgrade? Promises of backward compatibility? Affects naming too (version number)
These all affect the boundary definition
PODC Keynote, July 19, 2000
PODC Keynote, July 19, 2000
Example: protocols vs. APIs
Example: XML
Protocols have been more successful the APIs Some reasons:
– – – – protocols are pass by value protocols designed for partial failure not trying to look like local procedure calls explicit state machine, rather than call/return (this exposes exceptions well)
XML doesn’t solve any of these issues It is RPC with an extensible type system It makes evolution better?
– two sides need to agree on schema – can ignore stuff you don’t understand
Protocols still not good at trust, billing, evolution
PODC Keynote, July 19, 2000
Can mislead us to ignore the real issues
PODC Keynote, July 19, 2000
7
<img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> Boundary Summary
Conclusions
We have been very sloppy about boundaries Leads to fragile systems Root cause is false transparency: trying to look like local procedure calls Relatively little work in evolution, federation, client-based resource allocation, failure recovery client-
Classic Distributed Systems are fragile Some of the causes:
– – – – focus on computation, not data ignoring location distinctions poor definitions of consistency/availability goals poor understanding of boundaries (RPC in particular)
These are all fixable, but need to be far more common
PODC Keynote, July 19, 2000
PODC Keynote, July 19, 2000
The DQ Principle
Harvest &amp; Yield
Yield: Fraction of Answered Queries Yield:
Data/query /<em> Queries/sec = constant = DQ
– for a given node – for a given app/OS release
– Related to uptime but measured by queries, not by time – Drop 1 out of 10 connections =&gt; 90% yield – At full utilization: yield ~ capacity ~ Q
Harvest: Fraction of the Complete Result Harvest:
– Reflects that some of the data may be missing due to faults – Replication: maintain D under faults
A fault can reduce the capacity (Q), completeness (D) or both Faults reduce this constant linearly (at best)
DQ corollary: harvest /</em> yield ~ constant
– ACID =&gt; choose 100% harvest (reduce Q but 100% D) – Internet =&gt; choose 100% yield (available but reduced D)
PODC Keynote, July 19, 2000
PODC Keynote, July 19, 2000
8
<img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> Harvest Options
1) Ignore lost nodes
– RPC gives up – forfeit small part of the database – reduce D, keep Q
Replica Groups
With n members: Each fault reduces Q by 1/n 1/n D stable until nth fault Added load is 1/(n-1) per fault 1/(n
RAID RAID – n=2 =&gt; double load or 50% capacity – n=4 =&gt; 133% load or 75% capacity – “load redirection problem”
2) Pair up nodes
– RPC tries alternate – survives one fault per pair – reduce Q, keep D
3) n-member replica groups Decide when you care...
PODC Keynote, July 19, 2000
Disaster tolerance: better have &gt;3 mirrors
PODC Keynote, July 19, 2000
Graceful Degradation
Goal: smooth decrease in harvest/yield proportional to faults
– we know DQ drops linearly
Thinking Probabilistically
Maximize symmetry
– SPMD + simple replication schemes
Make faults independent
– – – – requires thought avoid cascading errors/faults understand redirected load KISS
Saturation will occur
– high peak/average ratios... – must reduce harvest or yield (or both) – must do admission control!!!
One answer: reduce D dynamically
– disaster =&gt; redirect load, then reduce D to compensate for extra load
PODC Keynote, July 19, 2000
Use randomness
– makes worst-case and average case the same worst– ex: Inktomi spreads data &amp; queries randomly – Node loss implies a random 1% harvest reduction
PODC Keynote, July 19, 2000
9
<img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> Server Pollution
Can’t fix all memory leaks Third-party software leaks memory and sockets Third– so does the OS sometimes
Evolution
Three Approaches: Flash Upgrade
– Fast reboot into new version – Focus on MTTR (&lt; 10 sec) – Reduces yield (and uptime)
Some failures tie up local resources Solution: planned periodic “bounce”
– Not worth the stress to do any better – Bounce time is less than 10 seconds – Nice to remove load first…
PODC Keynote, July 19, 2000
Rolling Upgrade
– Upgrade nodes one at time in a “wave” – Temporary 1/n harvest reduction, 100% yield – Requires co-existing versions co-
“Big Flip”
PODC Keynote, July 19, 2000
The Big Flip
Steps:
1) take down 1/2 the nodes 2) upgrade that half 3) flip the “active half” (site upgraded) 4) upgrade second half 5) return to 100%
Key New Problems
Unknown but large growth
– Incremental &amp; Absolute scalability – 1000’s of components
Must be truly highly available
– Hot swap everything (no recovery time allowed) – No “night” – Graceful degradation under faults &amp; saturation
50% Harvest, 100% Yield
– or inverse?
Constant evolution (internet time)
– Software will be buggy – Hardware will fail – These can’t be emergencies...
PODC Keynote, July 19, 2000
No mixed versions
– can replace schema, protocols, ...
Twice used to change physical location
PODC Keynote, July 19, 2000
10
<img src="" alt=""> <img src="" alt=""> <img src="" alt=""> <img src="" alt=""> Conclusions
Parallel Programming is very relevant, except…
– – – – historically avoids availability no notion of online evolution limited notions of graceful degradation (checkpointing) best for CPU-bound tasks CPU-
Conclusions
Winning solution is message-passing clusters message– fine-grain communication =&gt; finefine-grain exception handling fine– don’t want every load/store to deal with partial failure
Key open problems:
– – – – – – libraries &amp; data structures for HA shared state support for replication and partial failure better understanding of probabilistic systems cleaner support for exceptions (graceful degradation) support for split-phase I/O and many concurrent threads splitsupport for 10,000 threads/node (to avoid FSMs)
PODC Keynote, July 19, 2000
Must think probabilistically about everything
– – – – no such thing as a 100% working system no such thing as 100% fault tolerance partial results are often OK (and better than none) Capacity /* Completeness == Constant
PODC Keynote, July 19, 2000
New Hard Problems...
Really need to manage disks well
– problems are I/O bound, not CPU bound
Backup slides
Lots of simultaneous connections
– 50Kb/s =&gt; at least 2000 connections/node
HAS to be highly available
– no maintenance window, even for upgrades
Continuous evolution
– constant site changes, always small bugs... – large but unpredictable traffic growth
Graceful degradation under saturation
PODC Keynote, July 19, 2000 PODC Keynote, July 19, 2000
11
<img src="" alt=""> Parallel Disk I/O
Want 50+ outstanding reads/disk
– Provides disk-head scheduler with many choices disk– Trades response time for throughput
Pushes towards a split-phase approach to disks splitGeneral trend: each query is a finite-state machine finite– split-phase disk/network operations are state transitions split– multiplex many FSMs over small number of threads – FSM handles state rather than thread stack
PODC Keynote, July 19, 2000
12</p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/架构师/">架构师</a></li></span></span> | <span class="tags">Tagged <a href="/tags/架构师/" class="label label-primary">架构师</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:29"datetime="2014-03-07 09:54:29"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-架构师--PODC-keynote/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-架构师--PODC-keynote" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>





<ul id="pagination" class="pagination pagination-lg">
  <li><a class="extend prev" href="/page/143/">&laquo;</a></li><li><a class="page-number" href="/">1</a></li><li><a class="page-number" href="/page/2/">2</a></li><li><span class="space">&hellip;</span></li><li><a class="page-number" href="/page/141/">141</a></li><li><a class="page-number" href="/page/142/">142</a></li><li><a class="page-number" href="/page/143/">143</a></li><li class="active"><li><span class="page-number current">144</span></li><li><a class="page-number" href="/page/145/">145</a></li><li><a class="page-number" href="/page/146/">146</a></li><li><a class="page-number" href="/page/147/">147</a></li><li><span class="space">&hellip;</span></li></li><li><a class="page-number" href="/page/161/">161</a></li><li><a class="page-number" href="/page/162/">162</a></li><li><a class="extend next" href="/page/145/">&raquo;</a></li>
  <div class="clearfix"></div>
</ul></div><!--wapper-->
       </div><!-- ID main-col END -->
       <aside id="sidebar" class="alignright col-sx-6 col-sm-4 col-md-3 col-lg-3">
<div id="widget_search" class="widget panel panel-primary">
    <form action="//google.com/search" method="get" accept-charset="utf-8">
  <div class="input-group">
    <input class="form-control" id="searchbox" type="search" name="q" results="0" placeholder="search">
    <span class="input-group-btn">
      <button class="btn btn-default" type="submit">Go!</button>
    </span>
    <input type="hidden" name="q" value="site:itsolife.com">
  </div>
</form>
</div>

<div id="widget_category" class="widget panel panel-primary">
  <div class="panel-heading">category</div>  <div data-src='category' class='ajax_widgets'>正在加载...</div>
</div>

<div id="widget_recent_posts" class="widget panel panel-primary">
  <div class="panel-heading">recent posts</div>  <div data-src='recent_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_tagcloud" class="widget panel panel-primary">
  <div class="panel-heading">tagcloud</div>  <div data-src='tagcloud' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_latest_update_posts" class="widget panel panel-primary">
  <div class="panel-heading">最近更新</div>  <div data-src='latest_update_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_recent_comments" class="widget panel panel-primary">
  <div class="panel-heading">recent comments</div>  

<div class="list-group-item ds-recent-comments" data-num-items="6" data-show-avatars="1" data-show-time="1" data-show-title="1" data-show-admin="1" data-excerpt-length="50"></div>



</div>

</aside>
       <div class="clearfix"></div>
     </div><!-- row END -->
  </div>
  <footer id="footer" class="container">
  <div class="panel panel-info">
  <section id='footer_widget'></section>  <div class="panel-footer">
  <div id="site-info">
    <span class='author'>
  
  &copy; 2014 RobinChia
  
    &nbsp;&nbsp;</span>
  
  <span id='analytics-51la'></span><span id='analytics-google'>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-48559895-1']);
  _gaq.push(['_trackPageview']);
  _js2load.push({src:('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'});
</script></span><span id='analytics-cnzz'>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_5774006'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s17.cnzz.com/stat.php%3Fid%3D5774006%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</span><span id='analytics-baidu'>
<script>
var _hmt = _hmt || [];
_js2load.push({src:"//hm.baidu.com/hm.js?1442f50724afc42380b51f097c43082c"});
</script>
</span>  </div>
  <div id="copyright">Site powered by <a href='http://zespia.tw/hexo/'><strong>hexo</strong></a>  update time: <em>2014-04-07 19:05:47</em></span></div>
</div>
<div class="clearfix"></div>


  </div>
  </footer>
  
        <script src="http://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>        
        <script src="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>        
                
        <script src="http://cdn.bootcss.com/prettify/r298/prettify.min.js"></script>    <script type="text/javascript">
   var lang=["bsh", "c", "cc", "cpp", "cs", "csh", "cyc", "cv", "htm", "html",
    "java", "js", "m", "mxml", "perl", "pl", "pm", "py", "rb", "sh",
    "xhtml", "xml", "xsl"];
   var pretty_base='';
   $('script').each(function(){
	var c = $(this).attr('src');
	if (!c)
	    return;
	if (c.match(/(\/)?prettify(\.min)?\.js/i))
	{
	    var index = c.lastIndexOf('/');
	    if (index != -1)
		pretty_base = c.substr(0,index + 1);
	    return false;
	}
   })
   $('pre code').each(function(){
	var c = $(this).attr('class')
	if (!c)
	    return;
	c = c.match(/\s?(lang\-\w+)/i);
	if (c && lang.indexOf(c[1]) == -1)
	{
	    lang.push(c[1]);
	    $.getScript(pretty_base + c[1] + '.min.js');
	}
   })

    $(window).load(function(){
       $("pre").addClass("prettyprint");
       prettyPrint();
    })
</script>    
            <script type="text/javascript">
var duoshuoQuery = {short_name:"robinchia"};
_js2load.push({src:'http://static.duoshuo.com/embed.js',charset:'UTF-8'});
</script>
    
            <!--wumii_relatedItems-->
    
        <script src="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>    <script type="text/javascript">
(function($){
  $('.entry').each(function(i){
    $(this).find('img').each(function(){
      var alt = this.alt;

      if (alt){
        $(this).before('<span class="caption">' + alt + '</span>');
      }

      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="fancybox' + i + '" />');
    });
  });

  $('.fancybox').fancybox();
})(jQuery);
</script>    
        <script src="http://cdn.bootcss.com/mathjax/2.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>
    
<script type="text/javascript">
$('.ajax_widgets').each(function(){var src=$(this).attr('data-src');if(src)$(this).load('/widgets/'+src+'.html');});
$.each(_js2load,function(index,obj){loadjs(obj.src,obj.charset)});
</script>

<div id="scroll2top">
<img src="/scroll2top/arrow.png"/>
</div>
<script src="/scroll2top/scroll2top.min.js"></script>
<div id="winterland">
  <canvas></canvas>
</div>
<script src="/js/winterland.min.js"></script>

  </body>
</html>
