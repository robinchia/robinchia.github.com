
<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>The 139 Page | It so life</title>
<meta name="author" content="RobinChia">

<meta name="description" content="It so life">


<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta property="og:site_name" content="It so life"/>

<!--[if IE]><style>.testIE.IE{display:inline;}</style><![endif]-->
<!--[if lte IE 7]><link rel="stylesheet" href="/css/ie7.css" type="text/css"><![endif]-->
<!--[if (lt IE 9)&(gt IE 7)]><style>.testIE.IE8{display:inline;}</style><![endif]-->
<!--[if gt IE 8]><style>.testIE.IE9{display:inline;}</style><![endif]-->

<link href="/favicon.png" rel="icon">
<link rel="alternate" href="/atom.xml" title="It so life Feed" type="application/atom+xml">

<link rel="stylesheet" href="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/font-awesome/4.0.3/css/font-awesome.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/prettify/r298/prettify.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" type="text/css">
<link rel="stylesheet" href="/css/style.css" type="text/css">
<!--[if lt IE 9]>
   <style>article,aside,dialog,footer,header,section,footer,nav,figure,menu{display:block}</style>
   <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
   <script src="http://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
<link href="http://cdn.staticfile.org/respond.js/1.4.2/respond-proxy.html" id="respond-proxy" rel="respond-proxy" />
<link href="/js/respond.proxy.gif" id="respond-redirect" rel="respond-redirect" />
<script src="/js/respond.proxy.js"></script>
   <script src="http://cdn.bootcss.com/selectivizr/1.0.2/selectivizr-min.js"></script>
<![endif]-->
<script type="text/javascript">
function loadjs(c,d){var a=document.createElement("script");a.async=!0;a.type="text/javascript";a.src=c;a.charset=d||"gbk";(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(a)};
var _protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
var _js2load = [];
</script>

</head>
<body>
      <header id="header" class="container"><nav id="main-nav" class="navbar navbar-default navbar-fixed-top " role="navigation">
  <div class="container">
    <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/">It so life</a>
    </div>
    <div  class="collapse navbar-collapse">
      <ul  class="nav navbar-nav">
  
        <li><a href="/" title="Home">Home</a></li>      
        <li><a href="/about/" title="About">About</a></li>      
        <li><a href="/archives/" title="Archives">Archives</a></li>      
      <li class='dropdown'>
        <a class='dropdown-toggle' data-toggle='dropdown' href='#'>website<b class='caret'></b></a>
        <ul class='dropdown-menu pure-menu-selected'>
    
          <li><a href="//groups.google.com/forum/#!forum/pongba" title="TopLanguage">TopLanguage</a></li>    
          <li><a href="//itpub.net/" title="ITPub">ITPub</a></li>    
          <li><a href="//blog.jobbole.com/" title="Bole">Bole</a></li>    
          <li><a href="//nosql-database.org/" title="nosql">nosql</a></li>    
          <li><a href="//gitimmersion.googol.im/" title="Git">Git</a></li>    
        </ul>
      </li>
    
      </ul>
      <ul class="nav navbar-nav navbar-right">
      
        <li><a href="/atom.xml">RSS</a></li>
      
      
        <li><a href="https://twitter.com/robinchia">twitter</a></li>
      
      
      
      
        <li><a href="https://github.com/robinchia">github</a></li>
      
      </ul>
    </div>
  </div>
</nav>
<div class="clearfix"></div>
</header>
  <div id='content' class="container">
     <div class="page-header-wrapper">
      <!--[if lt IE 9]><div class="alert alert-warning alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>提示:</strong>您的浏览器版本太低了,建议升级到 <strong><a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" title="IE9">IE9</a></strong> 以上,本站使用<a href="https://www.google.com/intl/zh-CN/chrome/">Chrome浏览器</a>可以获得最好的显示效果.</div><![endif]-->
      <div class="page-header"><h1 align="center"><big>It so life</big> </h1>
        <h5 align="center"><big>love as life</big></h5>
      </div>
     </div>
     <div class="row">
       <div id="main-col" class="alignleft col-sx-12 col-sm-8 col-md-9 col-lg-9">
      <section id='header_widget'></section>
          <div id="wrapper"><article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-Nosql-mongo--MongoDB客户端MongoVue-张善友-博客园/">MongoDB 客户端 MongoVue </a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:31.000Z"> <a href="/2014/02/02/2014-02-02-Nosql-mongo--MongoDB客户端MongoVue-张善友-博客园/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="mongodb-mongovue-">MongoDB 客户端 MongoVue - 张善友 - 博客园</h1>
<p><a href=""></a></p>
<p><a href="http://www.cnblogs.com/shanyou/" target="_blank">自由、创新、研究、探索</a></p>
<p>Linux/Windows Mono/DotNet [ Open Source .NET Development/使用开源工具进行DotNet软件开发]</p>
<ul>
<li><a href="http://www.cnblogs.com/" target="_blank">博客园</a></li>
<li><a href="http://www.cnblogs.com/shanyou/" target="_blank">首页</a></li>
<li><a href="http://q.cnblogs.com/" target="_blank">博问</a></li>
<li><a href="http://home.cnblogs.com/ing/" target="_blank">闪存</a></li>
<li><a href="http://www.cnblogs.com/shanyou/admin/EditPosts.aspx?opt=1" target="_blank">新随笔</a></li>
<li><a href="http://space.cnblogs.com/msg/send/%e5%bc%a0%e5%96%84%e5%8f%8b" target="_blank">联系</a></li>
<li><a href="http://www.cnblogs.com/shanyou/rss" target="_blank">订阅</a></li>
<li><a href="http://www.cnblogs.com/shanyou/admin/EditPosts.aspx" target="_blank">管理</a>
随笔-1233 文章-57 评论-4326 </li>
</ul>
<h1 id="-mongodb-mongovue-http-www-cnblogs-com-shanyou-archive-2011-05-20-2052354-html-"><a href="http://www.cnblogs.com/shanyou/archive/2011/05/20/2052354.html" target="_blank">MongoDB 客户端 MongoVue</a></h1>
<p>今天在同事那里看到了一个很不错的MongoDB的客户端工具MongoVue，地址是<a href="http://www.mongovue.com/" title="http://www.mongovue.com/" target="_blank"><a href="http://www.mongovue.com/">http://www.mongovue.com/</a></a>。做的不错，1.0版本的开始收费了，费用也不贵才35＄。真正需要的同学可以掏点钱买个吧，也算是支持这个工具，如果只是学习研究用的话我这里还有一个0.9.7版本，虽然比起1.0版来说有些bug，平常使用也够了，需要的同学可以单独联系我。</p>
<p>1.0版之后超过15天后功能受限。可以通过删除以下注册表项来解除限制：</p>
<p>[HKEY_CURRENT_USER\Software\Classes\CLSID{B1159E65-821C3-21C5-CE21-34A484D54444}\4FF78130]</p>
<p>把这个项下的值全删掉就可以了。</p>
<p>下面上图给大家感受下强大的MongoVue，可以提高你使用MongoDB的幸福指数好几十点，上图是王道：</p>
<p>1、配置连接</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/shanyou/201105/201105202156379291.png" target="_blank"><img src="&quot;image&quot;" alt="image"></a></p>
<p>2、试下新建一个名为AccessLog的Collection ：</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/shanyou/201105/201105202156459404.png" target="_blank"><img src="&quot;image&quot;" alt="image"></a></p>
<p><a href="http://images.cnblogs.com/cnblogs_com/shanyou/201105/201105202156514807.png" target="_blank"><img src="&quot;image&quot;" alt="image"></a></p>
<p>3、插入一个Document</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/shanyou/201105/201105202157028144.png" target="_blank"><img src="&quot;image&quot;" alt="image"></a></p>
<p>4、查看我们插入的数据，数据可以通过多种方式展示（树形、表格、文本）</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/shanyou/201105/201105202157089643.png" target="_blank"><img src="&quot;image&quot;" alt="image"></a></p>
<p>上面我们都是通过图形界面的操作的吧，下面有一个窗口列出了上述操作的客户端命令哦，这是学习的好资源，在用图形界面的时候依然可以学习熟悉下命令行。</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/shanyou/201105/201105202157122038.png" target="_blank"><img src="&quot;image&quot;" alt="image"></a></p>
<p>当然上述只是介绍了下最基本的功能，还有更新，删除数据库，从mysql数据库导入数据等等功能，想了解更详细的内容请访问官方网站：<a href="http://www.mongovue.com/" title="http://www.mongovue.com/" target="_blank"><a href="http://www.mongovue.com/">http://www.mongovue.com/</a></a> </p>
<p><a href="http://blog.nosqlfan.com/tags/mongodb" title="http://blog.nosqlfan.com/tags/mongodb" target="_blank"><a href="http://blog.nosqlfan.com/tags/mongodb">http://blog.nosqlfan.com/tags/mongodb</a></a></p>
<p>posted @ 2011-05-20 21:57 <a href="http://www.cnblogs.com/shanyou/" target="_blank">张善友</a> 阅读(12667) 评论(71) <a href="http://www.cnblogs.com/shanyou/admin/EditPosts.aspx?postid=2052354" target="_blank">编辑</a> <a href="http://www.cnblogs.com/shanyou/archive/2011/05/20/2052354.html#" target="_blank">收藏</a>
<img src="" alt=""></p>
<p><a href="">刷新评论</a><a href="http://www.cnblogs.com/shanyou/archive/2011/05/20/2052354.html#" target="_blank">刷新页面</a><a href="http://www.cnblogs.com/shanyou/archive/2011/05/20/2052354.html#top" target="_blank">返回顶部</a></p>
<p><a href="http://www.cnblogs.com/" title="程序员的网上家园" target="_blank">博客园首页</a><a href="http://q.cnblogs.com/" title="程序员问答社区" target="_blank">博问</a><a href="http://news.cnblogs.com/" title="IT新闻" target="_blank">新闻</a><a href="http://home.cnblogs.com/ing/" target="_blank">闪存</a><a href="http://job.cnblogs.com/" target="_blank">程序员招聘</a><a href="http://kb.cnblogs.com/" target="_blank">知识库</a></p>
<h3 id="-">公告</h3>
<p>Copyright ©2013 张善友</p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Nosql/">Nosql</a></li></span><span class="breadcrumb"><li><a href="/categories/Nosql/">Nosql</a></li><li><a href="/categories/Nosql/mongo/">mongo</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Nosql/" class="label label-primary">Nosql</a><a href="/tags/mongo/" class="label label-success">mongo</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:31"datetime="2014-03-07 09:54:31"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-Nosql-mongo--MongoDB客户端MongoVue-张善友-博客园/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-Nosql-mongo--MongoDB客户端MongoVue-张善友-博客园" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-Nosql-mongo--MongoDB基础篇-残夜-博客园/">MongoDB基础篇 </a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:31.000Z"> <a href="/2014/02/02/2014-02-02-Nosql-mongo--MongoDB基础篇-残夜-博客园/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="mongodb-">MongoDB基础篇 - 残夜 - 博客园</h1>
<p><a href=""></a></p>
<p><a href="http://www.cnblogs.com/oubo/" target="_blank"><img src="" alt="返回主页"></a></p>
<h1 id="-oubo-http-www-cnblogs-com-oubo-"><a href="http://www.cnblogs.com/oubo/" target="_blank">Oubo的博客</a></h1>
<h1 id="-">#</h1>
<ul>
<li><a href="http://www.cnblogs.com/" target="_blank">博客园</a></li>
<li><a href="http://www.cnblogs.com/oubo/" target="_blank">首页</a></li>
<li><a href="http://q.cnblogs.com/" target="_blank">博问</a></li>
<li><a href="http://home.cnblogs.com/ing/" target="_blank">闪存</a></li>
<li><a href="http://www.cnblogs.com/oubo/admin/EditPosts.aspx?opt=1" target="_blank">新随笔</a></li>
<li><a href="http://space.cnblogs.com/msg/send/%e6%ae%8b%e5%a4%9c" target="_blank">联系</a></li>
<li><a href="http://www.cnblogs.com/oubo/rss" target="_blank">订阅</a></li>
<li><a href="http://www.cnblogs.com/oubo/admin/EditPosts.aspx" target="_blank">管理</a>
随笔- 139 文章- 23 评论- 18 </li>
</ul>
<h1 id="-mongodb-http-www-cnblogs-com-oubo-archive-2012-02-21-2394663-html-"><a href="http://www.cnblogs.com/oubo/archive/2012/02/21/2394663.html" target="_blank">MongoDB基础篇</a></h1>
<h1 id="-mongodb-"><strong>一、走进MongoDB</strong></h1>
<p>MongoDB 是一个高性能，开源，面向集合，无模式的文档型数据库。它在许多场景下可用于替代传统的关系型数据库或键-值存储方式，MongoDB 使用C++开发。</p>
<h2 id="1-1-mongodb">1.1、初识MongoDB</h2>
<p>MongoDB 是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。他支持的数据结构非常松散，是类似json 的bjson 格式，因此可以存储比较复杂的数据类型。MongoDB 最大的特点是他支持的查询语言非常强大，其语法有点类似于面向对象的查询语言，几乎可以实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索引。它是一个面向集合的,模式自由的文档型数据库。</p>
<h3 id="1-1-1-collenction-orented-">1.1.1 面向集合（Collenction-Orented）</h3>
<p>数据被分组存储在数据集中， 被称为一个集合（Collenction)。每个集合在数据库中都有一个唯一的标识名，并且可以包含无限数目的文档。集合的概念类似关系型数据库（RDBMS）里的表（table），不同的是它不需要定义任何模式（schema)。</p>
<h3 id="1-1-2-schema-free-">1.1.2 模式自由（Schema-free)</h3>
<p>存储在MongoDB 数据库中的文件，我们不需要知道它的任何结构定义。</p>
<h3 id="1-1-3-document-file-">1.1.3 文档型（Document File）</h3>
<p>存储的数据是键-值对的集合&quot;JSON&quot;，键是字符串，值可以是数据类型集合里的任意类型，包括数组和文档。我们把这个数据格式称作 “BSON” 即 “Binary Serialized DocumentNotation.”  </p>
<h2 id="-2-mongodb-"><strong>2、MongoDB的特点</strong></h2>
<ul>
<li>面向集合存储，易于存储对象类型的数据</li>
<li>模式自由</li>
<li>支持动态查询</li>
<li>支持完全索引，包含内部对象</li>
<li>支持复制和故障恢复</li>
<li>使用高效的二进制数据存储，包括大型对象（如视频、图片等）</li>
<li>自动处理碎片，以支持云计算层次的扩展性</li>
<li>支持Python，PHP，Ruby，Java，C，C/#，Javascript，Perl 及C++语言的驱动程序，社区中也提供了对Erlang 及.NET 等平台的驱动程序 文件存储格式为BSON（一种JSON 的扩展）</li>
<li>可通过网络访问</li>
</ul>
<h2 id="-3-mongodb-"><strong>3、MongoDB的功能</strong></h2>
<ul>
<li>面向集合的存储：适合存储对象及JSON 形式的数据</li>
<li>动态查询：MongoDB 支持丰富的查询表达式。查询指令使用JSON 形式的标记，可轻易查询文档中内嵌的对象及数组</li>
<li>完整的索引支持：包括文档内嵌对象及数组。MongoDB 的查询优化器会分析查询表达式，并生成一个高效的查询计划</li>
<li>查询监视：MongoDB 包含一系列监视工具用于分析数据库操作的性能</li>
<li>复制及自动故障转移：MongoDB 数据库支持服务器之间的数据复制，支持主-从模式及服务器之间的相互复制。复制的主要目标是提供冗余及自动故障转移</li>
<li>高效的传统存储方式：支持二进制数据及大型对象（如照片或视频）</li>
<li>自动分片以支持云级别的伸缩性：自动分片功能支持水平的数据库集群，可动态添加额外的机器。</li>
</ul>
<h2 id="-4-mongodb-"><strong>4、MongoDB的场景</strong></h2>
<p>适用场景：</p>
<ul>
<li>网站数据：MongoDB 非常适合实时的插入，更新与查询，并具备网站实时数据存储所需的复制及高度伸缩性</li>
<li>缓存：由于性能很高，MongoDB 也适合作为信息基础设施的缓存层。在系统重启之后，由MongoDB 搭建的持久化缓存层可以避免下层的数据源过载</li>
<li>大尺寸，低价值的数据：使用传统的关系型数据库存储一些数据时可能会比较昂贵，在此之前，很多时候程序员往往会选择传统的文件进行存储</li>
<li>高伸缩性的场景：MongoDB 非常适合由数十或数百台服务器组成的数据库。MongoDB的路线图中已经包含对MapReduce 引擎的内置支持</li>
<li><p>用于对象及JSON 数据的存储：MongoDB 的BSON 数据格式非常适合文档化格式的存储及查询
不适用场景：</p>
</li>
<li><p>高度事务性的系统，例如银行或会计系统。</p>
</li>
<li>传统的商业智能应用：针对特定问题的BI数据库会对产生高度优化的查询方式。</li>
<li>极为复杂的SQL查询</li>
</ul>
<h1 id="-"><strong>二、安装和配置</strong></h1>
<p>MongoDB 的官方下载站是<a href="http://www.mongodb.org/downloads，可以去上面下载最新的安装程序下来。在下载页面可以看到，它对操作系统支持很全面，如OS" target="_blank">http://www.mongodb.org/downloads，可以去上面下载最新的安装程序下来。在下载页面可以看到，它对操作系统支持很全面，如OS</a> X、Linux、Windows、Solaris都支持，而且都有各自的32 位和64 位版本。 <strong>注意:</strong></p>
<ol>
<li>MongoDB 1.8.1 Linux 版要求glibc 必须是2.5 以上。</li>
<li><p>在32 位平台MongoDB 不允许数据库文件（累计总和）超过2G，而64 位平台没有这个限制。
这里主要介绍Linux平台的安装：</p>
</li>
<li><p>步骤一: 下载MongoDB下载安装包：curl -O <a href="http://fastdl.mongodb.org/linux/mongodb-linux-i686-1.8.1.tgz" target="_blank">http://fastdl.mongodb.org/linux/mongodb-linux-i686-1.8.1.tgz</a></p>
</li>
<li>步骤二: 设置MongoDB程序存放目录将其解压到/Apps，再重命名为mongo，路径为/Apps/mongo</li>
<li>步骤三: 设置数据文件存放目录建立/data/db 的目录, mkdir –p /data/db</li>
<li>步骤四: 启动MongoDB服务/Apps/mongo/bin/mongod --dbpath=/data/db；（MongoDB 服务端的默认连接端口是 27017）</li>
<li>步骤五: 将MongoDB作为 Linux 服务随机启动；先创建/Apps/mongo/logs/mongodb.log 文件，用于存储MongoDB 的日志文件vi /etc/rc.local, 使用vi 编辑器打开配置文件，并在其中加入下面一行代码/Apps/mongo/bin/mongod --dbpath=/data/db --logpath=/Apps/mongo/logs/mongodb.log</li>
<li>步骤六: 客户端连接验证；新打开一个Shell 输入：/Apps/mongo/bin/mongo，就可以开始我们的mongo之旅了。</li>
<li>步骤七: 查看MongoDB日志；</li>
</ol>
<h1 id="-">三、体系结构</h1>
<p>MongoDB 是一个可移植的数据库，它在流行的每一个平台上都可以使用，即所谓的跨平台特性。在不同的操作系统上虽然略有差别，但是从整体构架上来看，MongoDB 在不同的平台上是一样的，如数据逻辑结构和数据的存储等等。 一个运行着的MongoDB 数据库就可以看成是一个MongoDB Server，该Server 由实例和数据库组成，在一般的情况下一个MongoDB Server 机器上包含一个实例和多个与之对应的数据库，但是在特殊情况下，如硬件投入成本有限或特殊的应用需求，也允许一个Server 机器上可以有多个实例和多个数据库。 MongoDB 中一系列物理文件（数据文件，日志文件等）的集合或与之对应的逻辑结构（集合，文档等）被称为数据库，简单的说，就是数据库是由一系列与磁盘有关系的物理文件的组成。</p>
<h2 id="3-1-">3.1 数据逻辑结构</h2>
<p>MongoDB 的逻辑结构是一种层次结构。主要由：文档(document)、集合(collection)、数据库(database)这三部分组成的。 逻辑结构是面向用户的，用户使用MongoDB 开发应用程序使用的就是逻辑结构。</p>
<ol>
<li>MongoDB 的文档（document），相当于关系数据库中的一行记录。</li>
<li>多个文档组成一个集合（collection），相当于关系数据库的表。</li>
<li>多个集合（collection），逻辑上组织在一起，就是数据库（database）。</li>
<li>一个MongoDB 实例支持多个数据库（database）。
<a href="http://zhoubo.sinaapp.com/?attachment_id=1646" target="_blank"><img src="&quot;RDBMS和MongoDB&quot;" alt=""></a> </li>
</ol>
<h2 id="3-2-">3.2 数据存储结构</h2>
<p>MongoDB 内部有预分配空间的机制，每个预分配的文件都用0进行填充，由于有了这个机制，MongoDB 始终保持额外的空间和空余的数据文件，从而有效避免了由于数据暴增而带来的磁盘压力过大的问题。 由于表中数据量的增加，数据文件每新分配一次，它的大小都会是上一个数据文件大小的2倍，每个数据文件最大2G。这样的机制有利于防止较小的数据库浪费过多的磁盘空间，同时又能保证较大的数据库有相应的预留空间使用。 数据库的每张表都对应一个命名空间，每个索引也有对应的命名空间。这些命名空间的元数据都集中在/*.ns 文件中。每个命名空间可以包含多个不同的盘区，这些盘区并不是连续的。与数据文件的增长相同，每一个命名空间对应的盘区大小的也是随着分配的次数不断增长的。这样做的目的是为了平衡命名空间浪费的空间与保持某一个命名空间中数据的连续性。每当命名空间需要分配新的盘区的时候，都会先查看$freelist (用于记录不再使用的盘区的命名空间)是否有大小合适的盘区可以使用，这样就回收空闲的磁盘空间。  </p>
<h1 id="-">四、快速入门</h1>
<h2 id="4-1-">4.1 启动数据库</h2>
<h3 id="4-1-1-">4.1.1 命令行启动方式</h3>
<p>MongoDB 默认存储数据目录为/data/db/ (或者 c:\data\db), 默认端口27017，默认HTTP 端口28017。当然你也可以修改成不同目录,只需要指定dbpath 参数:</p>
<p>$mongod -h
$mongod --dbpath=/data/db --logpath=/tmp/mongod.log</p>
<h3 id="4-1-2-">4.1.2 配置文件启动方式</h3>
<p>为减少命令后参数过多和维护成本，MongoDB 也支持同mysql 一样的读取启动配置文件的方式来启动数据库，配置文件的内容如下:</p>
<p>$ cat /etc/mongod.conf
dbpath=/data/db
$ mongod -f /etc/mongod.conf</p>
<h3 id="4-1-3-daemon-">4.1.3 Daemon方式启动</h3>
<p>前面两种都提供的前台启动mongodb进程，但当mongodb进程的session被关闭时，mongodb进程也随之停止，这是非常不安全的。MongoDB提供了一种后台启动的选择，只需要加上一个--fork参数即可。</p>
<p>$ mongod --dbpath=/data/db --logpath=/tmp/mongod.log --fork</p>
<h2 id="-"> </h2>
<h2 id="4-2-">4.2 停止数据库</h2>
<p>MongoDB 提供的停止数据库命令也非常丰富，如果Control-C、发送shutdownServer()指令及发送Unix 系统中断信号等。</p>
<h3 id="4-2-1-control-c">4.2.1 Control-C</h3>
<p>$ mongo</p>
<blockquote>
<p>Control-C</p>
</blockquote>
<h3 id="4-2-2-shutdownserver-">4.2.2 shutdownServer()</h3>
<p>$ mongo</p>
<blockquote>
<p>db.shutdownServer()</p>
</blockquote>
<h3 id="4-2-3-linux-">4.2.3 linux 系统中断信号</h3>
<p>$ ps aux|grep mongod
$ kill -9 pid</p>
<h2 id="-"> </h2>
<h2 id="4-3-mongo-api">4.3 Mongo  API</h2>
<p>$ ./mongo</p>
<blockquote>
<p>help //查看客户端帮忙命令
db.help() //查看db的api
db.mycroll.help() //查看collection的api</p>
</blockquote>
<h3 id="4-3-1-">4.3.1 插入操作</h3>
<blockquote>
<p>use mydb
db.things.save({name:&quot;mongo&quot;})
db.things.insert({x:1})</p>
</blockquote>
<h3 id="4-3-2-">4.3.2 更新操作</h3>
<blockquote>
<p>use mydb
db.things.update({name:&quot;mongo&quot;},{$set:{name:&quot;new_mongo&quot;}})</p>
</blockquote>
<h3 id="4-3-3-">4.3.3 删除操作</h3>
<blockquote>
<p>use mydb
db.things.remove({name:&quot;mongo&quot;})</p>
</blockquote>
<h3 id="4-3-4-">4.3.4 查询操作</h3>
<blockquote>
<p>use mydb
db.things.find({name:&quot;mongo&quot;})</p>
</blockquote>
<h2 id="4-4-">4.4 常用工具集</h2>
<p>MongoDB 在bin 目录下提供了一系列有用的工具，这些工具提供了MongoDB 在运维管理上的方便。</p>
<ul>
<li>bsondump: 将bson 格式的文件转储为json 格式的数据</li>
<li>mongo: 客户端命令行工具，其实也是一个js 解释器，支持js 语法</li>
<li>mongod: 数据库服务端，每个实例启动一个进程，可以fork 为后台运行</li>
<li>mongodump/ mongorestore: 数据库备份和恢复工具</li>
<li>mongoexport/ mongoimport: 数据导出和导入工具</li>
<li>mongofiles:GridFS 管理工具，可实现二制文件的存取</li>
<li>mongos: 分片路由，如果使用了sharding 功能，则应用程序连接的是mongos 而不是mongod</li>
<li>mongosniff: 这一工具的作用类似于tcpdump，不同的是他只监控MongoDB 相关的包请求，并且是以指定的可读性的形式输出</li>
<li>mongostat: 实时性能监控工具</li>
</ul>
<h2 id="4-6-">4.6 客户端工具</h2>
<ul>
<li>MongoVUE：一个桌面程序，提供了对MongoDB 数据库的基本操作，如查看、查询、更新、删除等，简单易用，但是功能还比较弱，以后发展应该不错。</li>
<li>RockMongo：是一个PHP5 写的MongoDB 管理工具。</li>
<li>MongoHub：是一个针对Mac 平台的MongoDB 图形管理客户端，可用来管理MongoDB 数据的应用程序。</li>
</ul>
<p>参考资料：《MongoDB总结.pdf》+<a href="http://www.mongodb.org/display/DOCS/Home" target="_blank"><a href="http://www.mongodb.org/display/DOCS/Home">http://www.mongodb.org/display/DOCS/Home</a></a>    </p>
<p>posted @ 2012-02-21 17:55 <a href="http://www.cnblogs.com/oubo/" target="_blank">残夜</a> 阅读(359) 评论(0) <a href="http://www.cnblogs.com/oubo/admin/EditPosts.aspx?postid=2394663" target="_blank">编辑</a> <a href="http://www.cnblogs.com/oubo/archive/2012/02/21/2394663.html#" target="_blank">收藏</a>
<img src="" alt=""></p>
<p><a href="">刷新评论</a><a href="http://www.cnblogs.com/oubo/archive/2012/02/21/2394663.html#" target="_blank">刷新页面</a><a href="http://www.cnblogs.com/oubo/archive/2012/02/21/2394663.html#top" target="_blank">返回顶部</a></p>
<p><a href="http://www.cnblogs.com/" title="程序员的网上家园" target="_blank">博客园首页</a><a href="http://q.cnblogs.com/" title="程序员问答社区" target="_blank">博问</a><a href="http://news.cnblogs.com/" title="IT新闻" target="_blank">新闻</a><a href="http://home.cnblogs.com/ing/" target="_blank">闪存</a><a href="http://job.cnblogs.com/" target="_blank">程序员招聘</a><a href="http://kb.cnblogs.com/" target="_blank">知识库</a></p>
<h3 id="-">公告</h3>
<p>Copyright ©2013 残夜</p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Nosql/">Nosql</a></li></span><span class="breadcrumb"><li><a href="/categories/Nosql/">Nosql</a></li><li><a href="/categories/Nosql/mongo/">mongo</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Nosql/" class="label label-primary">Nosql</a><a href="/tags/mongo/" class="label label-success">mongo</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:31"datetime="2014-03-07 09:54:31"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-Nosql-mongo--MongoDB基础篇-残夜-博客园/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-Nosql-mongo--MongoDB基础篇-残夜-博客园" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-Nosql-mongo--Memcached笔记——（四）应对高并发攻击/">Memcached笔记——（四）应对高并发攻击</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:31.000Z"> <a href="/2014/02/02/2014-02-02-Nosql-mongo--Memcached笔记——（四）应对高并发攻击/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="memcached-">Memcached笔记——（四）应对高并发攻击</h1>
<p><a href="http://www.iteye.com/" target="_blank">首页</a> <a href="http://www.iteye.com/news" target="_blank">资讯</a> <a href="http://www.iteye.com/magazines" target="_blank">精华</a> <a href="http://www.iteye.com/forums" target="_blank">论坛</a> <a href="http://www.iteye.com/ask" target="_blank">问答</a> <a href="http://www.iteye.com/blogs" target="_blank">博客</a> <a href="http://www.iteye.com/blogs/subjects" target="_blank">专栏</a> <a href="http://www.iteye.com/groups" target="_blank">群组</a> <a href="">更多 ▼</a></p>
<p><a href="http://job.iteye.com/iteye" target="_blank">招聘</a> <a href="http://www.iteye.com/search" target="_blank">搜索</a></p>
<p><a href="http://snowolf.iteye.com/login" title="登录" target="_blank">您还未登录 !</a> <a href="http://snowolf.iteye.com/login" target="_blank">登录</a> <a href="http://snowolf.iteye.com/signup" target="_blank">注册</a></p>
<h1 id="-snowolf-http-snowolf-iteye-com-"><a href="http://snowolf.iteye.com/" target="_blank">Snowolf的意境空间！</a></h1>
<ul>
<li><a href="http://snowolf.iteye.com/" target="_blank"><strong>博客</strong></a></li>
<li><a href="http://snowolf.iteye.com/weibo" target="_blank">微博</a></li>
<li><a href="http://snowolf.iteye.com/album" target="_blank">相册</a></li>
<li><a href="http://snowolf.iteye.com/link" target="_blank">收藏</a></li>
<li><a href="http://snowolf.iteye.com/blog/guest_book" target="_blank">留言</a></li>
<li><a href="http://snowolf.iteye.com/blog/profile" target="_blank">关于我</a></li>
</ul>
<h3 id="-memcached-"><a href="">Memcached笔记——（四）应对高并发攻击</a> **</h3>
<p><strong>博客分类：</strong></p>
<ul>
<li><a href="http://snowolf.iteye.com/category/214766" target="_blank">Java／Cache</a></li>
<li><a href="http://snowolf.iteye.com/category/28518" target="_blank">Spring</a></li>
<li><a href="http://snowolf.iteye.com/category/64267" target="_blank">Server Architecture／Distributed</a>
<a href="http://www.iteye.com/blogs/tag/memcached" target="_blank">memcached</a><a href="http://www.iteye.com/blogs/tag/add" target="_blank">add</a><a href="http://www.iteye.com/blogs/tag/xmemcached" target="_blank">xmemcached</a> </li>
</ul>
<p>近半个月过得很痛苦，主要是产品上线后，引来无数机器用户恶意攻击，不停的刷新产品各个服务入口，制造垃圾数据，消耗资源。他们的最好成绩，1秒钟可以并发6次，赶在Database入库前，Cache进行Missing Loading前，强占这其中十几毫秒的时间，进行恶意攻击。</p>
<p><strong>相关链接： 
<a href="http://snowolf.iteye.com/blog/1447348" target="_blank">Memcached笔记——（一）安装&amp;常规错误&amp;监控 </a>
<a href="http://snowolf.iteye.com/blog/1471805" target="_blank">Memcached笔记——（二）XMemcached&amp;Spring集成</a> 
<a href="http://snowolf.iteye.com/blog/1576818" target="_blank">Memcached笔记——（三）Memcached使用总结</a> </strong></p>
<p><a href="http://snowolf.iteye.com/admin/blogs/1677495/edit" title="Memcached笔记——（四）应对高并发攻击" target="_blank"><strong>Memcached笔记——（四）应对高并发攻击</strong></a></p>
<p>为了应对上述情况，做了如下调整：</p>
<ol>
<li>更新数据时，先写Cache，然后写Database，如果可以，写操作交给队列后续完成。</li>
<li>限制统一帐号，同一动作，同一秒钟并发次数，超过1次不做做动作，返回操作失败。</li>
<li>限制统一用户，每日动作次数，超限返回操作失败。</li>
</ol>
<p>要完成上述操作，同事给我支招。用Memcached的add方法，就可以很快速的解决问题。不需要很繁琐的开发，也不需要依赖数据库记录，完全内存操作。<img src="" alt=""></p>
<p>以下实现一个判定冲突的方法：</p>
<p>Java代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>//<em>/</em> </li>
<li>/* 冲突延时 1秒 </li>
<li>/*/  </li>
<li>public static final int MUTEX_EXP = 1;  </li>
<li>//<em>/</em> </li>
<li>/* 冲突键 </li>
<li>/*/  </li>
<li>public static final String MUTEX<em>KEY_PREFIX = &quot;MUTEX</em>&quot;;  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 冲突判定 </li>
<li>/*  </li>
<li>/* @param key </li>
<li>/*/  </li>
<li>public boolean isMutex(String key) {  </li>
<li>return isMutex(key, MUTEX_EXP);  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 冲突判定 </li>
<li>/*  </li>
<li>/* @param key </li>
<li>/* @param exp </li>
<li>/* @return true 冲突 </li>
<li>/*/  </li>
<li>public boolean isMutex(String key, int exp) {  </li>
<li>boolean status = true;  </li>
<li>try {  </li>
<li>if (memcachedClient.add(MUTEX_KEY_PREFIX + key, exp, &quot;true&quot;)) {  </li>
<li>status = false;  </li>
<li>}  </li>
<li>} catch (Exception e) {  </li>
<li>logger.error(e.getMessage(), e);  </li>
<li>}  </li>
<li>return status;  </li>
<li></li>
<li>}<br>//<em>/</em> /<em> 冲突延时 1秒 /</em>/ public static final int MUTEX<em>EXP = 1; //<em>/</em> /<em> 冲突键 /</em>/ public static final String MUTEX_KEY_PREFIX = &quot;MUTEX</em>&quot;; //<em>/</em> /<em> 冲突判定 /</em> /<em> @param key /</em>/ public boolean isMutex(String key) { return isMutex(key, MUTEX_EXP); } //<em>/</em> /<em> 冲突判定 /</em> /<em> @param key /</em> @param exp /<em> @return true 冲突 /</em>/ public boolean isMutex(String key, int exp) { boolean status = true; try { if (memcachedClient.add(MUTEX_KEY_PREFIX + key, exp, &quot;true&quot;)) { status = false; } } catch (Exception e) { logger.error(e.getMessage(), e); } return status; }</li>
</ol>
<p>做个说明：</p>
<p>选项 说明 add 仅当存储空间中不存在键相同的数据时才保存 replace 仅当存储空间中存在键相同的数据时才保存 set 与add和replace不同，无论何时都保存</p>
<p>也就是说，如果add操作返回为true，则认为当前不冲突！<img src="" alt=""></p>
<p>回归场景，恶意用户1秒钟操作6次，遇到上述这个方法，只有乖乖地1秒后再来。别小看这1秒钟，一个数据库操作不过几毫秒。1秒延迟，足以降低系统负载，增加恶意用户成本。</p>
<p>附我用到的基于XMemcached实现：</p>
<p>Java代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>import net.rubyeye.xmemcached.MemcachedClient;  </li>
<li></li>
<li>import org.apache.log4j.Logger;  </li>
<li>import org.springframework.beans.factory.annotation.Autowired;  </li>
<li>import org.springframework.stereotype.Component;  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/*  </li>
<li>/* @author Snowolf </li>
<li>/* @version 1.0 </li>
<li>/* @since 1.0 </li>
<li>/*/  </li>
<li>@Component  </li>
<li>public class MemcachedManager {  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 缓存时效 1天 </li>
<li>/*/  </li>
<li>public static final int CACHE_EXP_DAY = 3600 /* 24;  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 缓存时效 1周 </li>
<li>/*/  </li>
<li>public static final int CACHE_EXP_WEEK = 3600 /<em> 24 /</em> 7;  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 缓存时效 1月 </li>
<li>/*/  </li>
<li>public static final int CACHE_EXP_MONTH = 3600 /<em> 24 /</em> 30;  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 缓存时效 永久 </li>
<li>/*/  </li>
<li>public static final int CACHE_EXP_FOREVER = 0;  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 冲突延时 1秒 </li>
<li>/*/  </li>
<li>public static final int MUTEX_EXP = 1;  </li>
<li>//<em>/</em> </li>
<li>/* 冲突键 </li>
<li>/*/  </li>
<li>public static final String MUTEX<em>KEY_PREFIX = &quot;MUTEX</em>&quot;;  </li>
<li>//<em>/</em> </li>
<li>/* Logger for this class </li>
<li>/*/  </li>
<li>private static final Logger logger = Logger  </li>
<li>.getLogger(MemcachedManager.class);  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* Memcached Client </li>
<li>/*/  </li>
<li>@Autowired  </li>
<li>private MemcachedClient memcachedClient;  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 缓存 </li>
<li>/*  </li>
<li>/* @param key </li>
<li>/* @param value </li>
<li>/* @param exp </li>
<li>/*            失效时间 </li>
<li>/*/  </li>
<li>public void cacheObject(String key, Object value, int exp) {  </li>
<li>try {  </li>
<li>memcachedClient.set(key, exp, value);  </li>
<li>} catch (Exception e) {  </li>
<li>logger.error(e.getMessage(), e);  </li>
<li>}  </li>
<li>logger.info(&quot;Cache Object: [&quot; + key + &quot;]&quot;);  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* Shut down the Memcached Cilent. </li>
<li>/*/  </li>
<li>public void finalize() {  </li>
<li>if (memcachedClient != null) {  </li>
<li>try {  </li>
<li>if (!memcachedClient.isShutdown()) {  </li>
<li>memcachedClient.shutdown();  </li>
<li>logger.debug(&quot;Shutdown MemcachedManager...&quot;);  </li>
<li>}  </li>
<li>} catch (Exception e) {  </li>
<li>logger.error(e.getMessage(), e);  </li>
<li>}  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 清理对象 </li>
<li>/*  </li>
<li>/* @param key </li>
<li>/*/  </li>
<li>public void flushObject(String key) {  </li>
<li>try {  </li>
<li>memcachedClient.deleteWithNoReply(key);  </li>
<li>} catch (Exception e) {  </li>
<li>logger.error(e.getMessage(), e);  </li>
<li>}  </li>
<li>logger.info(&quot;Flush Object: [&quot; + key + &quot;]&quot;);  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 冲突判定 </li>
<li>/*  </li>
<li>/* @param key </li>
<li>/*/  </li>
<li>public boolean isMutex(String key) {  </li>
<li>return isMutex(key, MUTEX_EXP);  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 冲突判定 </li>
<li>/*  </li>
<li>/* @param key </li>
<li>/* @param exp </li>
<li>/* @return true 冲突 </li>
<li>/*/  </li>
<li>public boolean isMutex(String key, int exp) {  </li>
<li>boolean status = true;  </li>
<li>try {  </li>
<li>if (memcachedClient.add(MUTEX_KEY_PREFIX + key, exp, &quot;true&quot;)) {  </li>
<li>status = false;  </li>
<li>}  </li>
<li>} catch (Exception e) {  </li>
<li>logger.error(e.getMessage(), e);  </li>
<li>}  </li>
<li>return status;  </li>
<li>}  </li>
<li></li>
<li>//<em>/</em> </li>
<li>/* 加载缓存对象 </li>
<li>/*  </li>
<li>/* @param key </li>
<li>/* @return </li>
<li>/*/  </li>
<li>public <T> T loadObject(String key) {  </li>
<li>T object = null;  </li>
<li>try {  </li>
<li>object = memcachedClient.<T> get(key);  </li>
<li>} catch (Exception e) {  </li>
<li>logger.error(e.getMessage(), e);  </li>
<li>}  </li>
<li>logger.info(&quot;Load Object: [&quot; + key + &quot;]&quot;);  </li>
<li>return object;  </li>
<li>}  </li>
<li></li>
<li>}<br>import net.rubyeye.xmemcached.MemcachedClient; import org.apache.log4j.Logger; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.stereotype.Component; //<em>/</em> /<em> /</em> @author Snowolf /<em> @version 1.0 /</em> @since 1.0 /<em>/ @Component public class MemcachedManager { //</em>/<em> /</em> 缓存时效 1天 /<em>/ public static final int CACHE_EXP_DAY = 3600 /</em> 24; //<em>/</em> /<em> 缓存时效 1周 /</em>/ public static final int CACHE<em>EXP_WEEK = 3600 /<em> 24 /</em> 7; //<em>/</em> /<em> 缓存时效 1月 /</em>/ public static final int CACHE_EXP_MONTH = 3600 /<em> 24 /</em> 30; //<em>/</em> /<em> 缓存时效 永久 /</em>/ public static final int CACHE_EXP_FOREVER = 0; //<em>/</em> /<em> 冲突延时 1秒 /</em>/ public static final int MUTEX_EXP = 1; //<em>/</em> /<em> 冲突键 /</em>/ public static final String MUTEX_KEY_PREFIX = &quot;MUTEX</em>&quot;; //<em>/</em> /<em> Logger for this class /</em>/ private static final Logger logger = Logger .getLogger(MemcachedManager.class); //<em>/</em> /<em> Memcached Client /</em>/ @Autowired private MemcachedClient memcachedClient; //<em>/</em> /<em> 缓存 /</em> /<em> @param key /</em> @param value /<em> @param exp /</em> 失效时间 /<em>/ public void cacheObject(String key, Object value, int exp) { try { memcachedClient.set(key, exp, value); } catch (Exception e) { logger.error(e.getMessage(), e); } logger.info(&quot;Cache Object: [&quot; + key + &quot;]&quot;); } //</em>/<em> /</em> Shut down the Memcached Cilent. /<em>/ public void finalize() { if (memcachedClient != null) { try { if (!memcachedClient.isShutdown()) { memcachedClient.shutdown(); logger.debug(&quot;Shutdown MemcachedManager...&quot;); } } catch (Exception e) { logger.error(e.getMessage(), e); } } } //</em>/<em> /</em> 清理对象 /<em> /</em> @param key /<em>/ public void flushObject(String key) { try { memcachedClient.deleteWithNoReply(key); } catch (Exception e) { logger.error(e.getMessage(), e); } logger.info(&quot;Flush Object: [&quot; + key + &quot;]&quot;); } //</em>/<em> /</em> 冲突判定 /<em> /</em> @param key /<em>/ public boolean isMutex(String key) { return isMutex(key, MUTEX_EXP); } //</em>/<em> /</em> 冲突判定 /<em> /</em> @param key /<em> @param exp /</em> @return true 冲突 /<em>/ public boolean isMutex(String key, int exp) { boolean status = true; try { if (memcachedClient.add(MUTEX_KEY_PREFIX + key, exp, &quot;true&quot;)) { status = false; } } catch (Exception e) { logger.error(e.getMessage(), e); } return status; } //</em>/<em> /</em> 加载缓存对象 /<em> /</em> @param key /<em> @return /</em>/ public <T> T loadObject(String key) { T object = null; try { object = memcachedClient.<T> get(key); } catch (Exception e) { logger.error(e.getMessage(), e); } logger.info(&quot;Load Object: [&quot; + key + &quot;]&quot;); return object; } }</li>
</ol>
<p><strong>相关链接： 
<a href="http://snowolf.iteye.com/blog/1447348" target="_blank">Memcached笔记——（一）安装&amp;常规错误&amp;监控 </a>
<a href="http://snowolf.iteye.com/blog/1471805" target="_blank">Memcached笔记——（二）XMemcached&amp;Spring集成</a> 
<a href="http://snowolf.iteye.com/blog/1576818" target="_blank">Memcached笔记——（三）Memcached使用总结</a> </strong></p>
<p><a href=""><strong>Memcached笔记——（四）应对高并发攻击</strong></a>
<strong>2</strong>
顶</p>
<p><strong>2</strong>
踩</p>
<p>分享到： <a href="&quot;分享到新浪微博&quot;"><img src="" alt=""></a> <a href="&quot;分享到腾讯微博&quot;"><img src="" alt=""></a></p>
<p><a href="http://snowolf.iteye.com/blog/1679923" title="MySQL 运维笔记（一）—— 终止高负载SQL" target="_blank">MySQL 运维笔记（一）—— 终止高负载SQL</a> | <a href="http://snowolf.iteye.com/blog/1667104" title="征服 Redis + Jedis + Spring （二）—— 哈希表操作（HMGET HMSET）" target="_blank">征服 Redis + Jedis + Spring （二）—— ...</a></p>
<ul>
<li>2012-09-13 09:48</li>
<li>浏览 3788</li>
<li><a href="">评论(4)</a></li>
<li>分类:<a href="http://www.iteye.com/blogs/category/architecture" target="_blank">企业架构</a></li>
<li><a href="http://www.iteye.com/wiki/blog/1677495" target="_blank">相关推荐</a></li>
</ul>
<h3 id="-">评论</h3>
<p><a href=""></a></p>
<p>4 楼 <a href="http://snowolf.iteye.com/" title="snowolf" target="_blank">snowolf</a> 2012-12-11  </p>
<p>zym820910 写道</p>
<p>snowolf 写道</p>
<p>CurrentJ 写道</p>
<p>先写Cache，然后写Database，断电或者故障会导致用户数据丢失。
各有利弊，需要根据业务需求权衡。<img src="" alt="">
写得非常好！应对高并发的时候，我们通常的思维是泄洪模式，通过一道又一道的防洪大堤将洪水分流，尤其是在应对数据要求不严厉的SNS这类产品，异步的保存数据值得提倡！
不过，更好的方式是：通过旁路式架构，解决代码层面的大部分压力。现在很多商城的商品展示和搜索都采用NOSQL技术来应对处理，异步增加或更新，并不显得那么重要了，更多的是通过产品和技术架构来调整，比如通过分析用户喜好，事先静态化搜索结果。
赞同，感谢分享！<img src="" alt=""> 最核心的优化，还是应当在产品层面多下工夫。找到用户-产品-技术，三方都能满足的平衡点。
3 楼 <a href="http://zym820910.iteye.com/" title="zym820910" target="_blank">zym820910</a> 2012-12-11  </p>
<p>snowolf 写道</p>
<p>CurrentJ 写道</p>
<p>先写Cache，然后写Database，断电或者故障会导致用户数据丢失。
各有利弊，需要根据业务需求权衡。<img src="" alt="">
写得非常好！应对高并发的时候，我们通常的思维是泄洪模式，通过一道又一道的防洪大堤将洪水分流，尤其是在应对数据要求不严厉的SNS这类产品，异步的保存数据值得提倡！
不过，更好的方式是：通过旁路式架构，解决代码层面的大部分压力。现在很多商城的商品展示和搜索都采用NOSQL技术来应对处理，异步增加或更新，并不显得那么重要了，更多的是通过产品和技术架构来调整，比如通过分析用户喜好，事先静态化搜索结果。</p>
<p>2 楼 <a href="http://snowolf.iteye.com/" title="snowolf" target="_blank">snowolf</a> 2012-11-07  </p>
<p>CurrentJ 写道</p>
<p>先写Cache，然后写Database，断电或者故障会导致用户数据丢失。
各有利弊，需要根据业务需求权衡。<img src="" alt="">
1 楼 <a href="http://currentj.iteye.com/" title="CurrentJ" target="_blank">CurrentJ</a> 2012-11-07  </p>
<p>先写Cache，然后写Database，断电或者故障会导致用户数据丢失。</p>
<h3 id="-">发表评论</h3>
<p><a href="http://snowolf.iteye.com/login" target="_blank"><img src="" alt=""></a><a href="http://snowolf.iteye.com/login" target="_blank">您还没有登录,请您登录后再发表评论</a></p>
<p><a href="http://snowolf.iteye.com/" target="_blank"><img src="&quot;snowolf的博客: Snowolf的意境空间！&quot;" alt="snowolf的博客"></a></p>
<p>snowolf</p>
<ul>
<li>浏览: 902532 次</li>
<li>性别: <img src="&quot;男&quot;" alt="Icon_minigender_1"></li>
<li>来自: 北京</li>
<li><img src="" alt=""><h3 id="-http-snowolf-iteye-com-blog-user_visits-">最近访客 <a href="http://snowolf.iteye.com/blog/user_visits" target="_blank">更多访客&gt;&gt;</a></h3>
</li>
</ul>
<p><a href="http://torry-he.iteye.com/" target="_blank"><img src="&quot;torry_he的博客: &quot;" alt="torry_he的博客"></a></p>
<p><a href="http://torry-he.iteye.com/" title="torry_he" target="_blank">torry_he</a></p>
<p><a href="http://cxzucc.iteye.com/" target="_blank"><img src="&quot;cxzucc的博客: &quot;" alt="cxzucc的博客"></a></p>
<p><a href="http://cxzucc.iteye.com/" title="cxzucc" target="_blank">cxzucc</a>
<a href="http://greatestrabit.iteye.com/" target="_blank"><img src="&quot;greatestrabit的博客: &quot;" alt="greatestrabit的博客"></a></p>
<p><a href="http://greatestrabit.iteye.com/" title="greatestrabit" target="_blank">greatestrabit</a></p>
<p><a href="http://zhumingyuan.iteye.com/" target="_blank"><img src="&quot;zhumingyuan的博客: &quot;" alt="zhumingyuan的博客"></a></p>
<p><a href="http://zhumingyuan.iteye.com/" title="zhumingyuan" target="_blank">zhumingyuan</a></p>
<h3 id="-">文章分类</h3>
<ul>
<li><a href="http://snowolf.iteye.com/" target="_blank">全部博客 (161)</a></li>
<li><a href="http://snowolf.iteye.com/category/44718" target="_blank">职场 &amp;&amp; 心情 (22)</a></li>
<li><a href="http://snowolf.iteye.com/category/28520" target="_blank">Java／Basic (17)</a></li>
<li><a href="http://snowolf.iteye.com/category/102898" target="_blank">Java／Compression (7)</a></li>
<li><a href="http://snowolf.iteye.com/category/68576" target="_blank">Java／Security (22)</a></li>
<li><a href="http://snowolf.iteye.com/category/147023" target="_blank">Java／Maven (3)</a></li>
<li><a href="http://snowolf.iteye.com/category/214766" target="_blank">Java／Cache (11)</a></li>
<li><a href="http://snowolf.iteye.com/category/38039" target="_blank">Eclipse (4)</a></li>
<li><a href="http://snowolf.iteye.com/category/28518" target="_blank">Spring (19)</a></li>
<li><a href="http://snowolf.iteye.com/category/39212" target="_blank">ORM／Hibernate (2)</a></li>
<li><a href="http://snowolf.iteye.com/category/36643" target="_blank">ORM／iBatis (3)</a></li>
<li><a href="http://snowolf.iteye.com/category/28851" target="_blank">DB／NoSQL (10)</a></li>
<li><a href="http://snowolf.iteye.com/category/34962" target="_blank">DB／MySQL (7)</a></li>
<li><a href="http://snowolf.iteye.com/category/93301" target="_blank">DB／MS SQL Server (4)</a></li>
<li><a href="http://snowolf.iteye.com/category/64032" target="_blank">OS／Linux (10)</a></li>
<li><a href="http://snowolf.iteye.com/category/124565" target="_blank">OS／Mac (7)</a></li>
<li><a href="http://snowolf.iteye.com/category/67920" target="_blank">C／C++ (4)</a></li>
<li><a href="http://snowolf.iteye.com/category/48004" target="_blank">Server Architecture／Basic (11)</a></li>
<li><a href="http://snowolf.iteye.com/category/64267" target="_blank">Server Architecture／Distributed (17)</a></li>
<li><a href="http://snowolf.iteye.com/category/51869" target="_blank">Moblie／Andriod (2)</a></li>
<li><a href="http://snowolf.iteye.com/category/64109" target="_blank">WebService (3)</a></li>
<li><a href="http://snowolf.iteye.com/category/195003" target="_blank">Objective-C (1)</a></li>
<li><a href="http://snowolf.iteye.com/category/28519" target="_blank">Html (1)</a></li>
<li><a href="http://snowolf.iteye.com/category/68028" target="_blank">设计模式 (1)</a></li>
<li><a href="http://snowolf.iteye.com/category/271868" target="_blank">Scala (0)</a></li>
<li><p><a href="http://snowolf.iteye.com/category/274875" target="_blank">Kafka (1)</a></p>
<h3 id="-">社区版块</h3>
</li>
<li><p><a href="http://snowolf.iteye.com/blog/news" target="_blank">我的资讯</a> (0)</p>
</li>
<li><a href="http://snowolf.iteye.com/blog/post" target="_blank">我的论坛</a> (66)</li>
<li><a href="http://snowolf.iteye.com/blog/answered_problems" target="_blank">我的问答</a> (4)</li>
</ul>
<h3 id="-">存档分类</h3>
<ul>
<li><a href="http://snowolf.iteye.com/blog/monthblog/2013-05" target="_blank">2013-05</a> (2)</li>
<li><a href="http://snowolf.iteye.com/blog/monthblog/2013-04" target="_blank">2013-04</a> (1)</li>
<li><a href="http://snowolf.iteye.com/blog/monthblog/2013-03" target="_blank">2013-03</a> (3)</li>
<li><p><a href="http://snowolf.iteye.com/blog/monthblog_more" target="_blank">更多存档...</a></p>
<h3 id="-">评论排行榜</h3>
</li>
<li><p><a href="http://snowolf.iteye.com/blog/1667104" title="征服 Redis + Jedis + Spring （二）—— 哈希表操作（HMGET HMSET）" target="_blank">征服 Redis + Jedis + Spring （二）—— ...</a></p>
</li>
<li><a href="http://snowolf.iteye.com/blog/1681944" title="MySQL 查询时强制区分大小写" target="_blank">MySQL 查询时强制区分大小写</a></li>
<li><a href="http://snowolf.iteye.com/blog/1679923" title="MySQL 运维笔记（一）—— 终止高负载SQL" target="_blank">MySQL 运维笔记（一）—— 终止高负载SQL</a></li>
<li><a href="http://snowolf.iteye.com/blog/1666908" title="征服 Redis + Jedis + Spring （一）—— 配置&amp;常规操作（GET SET DEL）" target="_blank">征服 Redis + Jedis + Spring （一）—— ...</a></li>
<li><a href="http://snowolf.iteye.com/blog/1748094" title="我的职场生涯（十）——又一个两年" target="_blank">我的职场生涯（十）——又一个两年</a></li>
</ul>
<h3 id="-">最新评论</h3>
<ul>
<li><a href="http://dbh0512.iteye.com/" title="dbh0512" target="_blank">dbh0512</a>： 这样操作只是在缓存中读取吗?项目中是不是只有在海量频繁读取某一 ...
<a href="http://snowolf.iteye.com/blog/1666908#bc2322585" target="_blank">征服 Redis + Jedis + Spring （一）—— 配置&amp;常规操作（GET SET DEL）</a></li>
<li><a href="http://jacy9.iteye.com/" title="愤怒的程序猿" target="_blank">愤怒的程序猿</a>： LZ:keytool错误:java.lang.Exceptio ...
<a href="http://snowolf.iteye.com/blog/397693#bc2322089" target="_blank">Java加密技术（九）——初探SSL</a></li>
<li><a href="http://snowolf.iteye.com/" title="snowolf" target="_blank">snowolf</a>： juwend 写道如果被加密的明文使用String ming ...
<a href="http://snowolf.iteye.com/blog/381767#bc2321550" target="_blank">Java加密技术（四）——非对称加密算法RSA</a></li>
<li><a href="http://simylau.iteye.com/" title="simylau" target="_blank">simylau</a>： water_lang 写道@Autowired      pr ...
<a href="http://snowolf.iteye.com/blog/577989#bc2320738" target="_blank">Spring 注解学习手札（一） 构建简单Web应用</a></li>
<li><a href="http://ifox.iteye.com/" title="ifox" target="_blank">ifox</a>： phrmgb 写道学习了，这些东东有时感觉很偏的，但是特殊的业 ...
<a href="http://snowolf.iteye.com/blog/1329649#bc2319809" target="_blank">Java关键字——transient</a>
声明：ITeye文章版权属于作者，受法律保护。没有作者书面许可不得转载。若作者同意转载，必须以超链接形式标明文章原始出处和作者。
© 2003-2012 ITeye.com. All rights reserved. [ 京ICP证110151号 京公网安备110105010620 ]
<img src="http://stat.iteye.com/?url=http%3A%2F%2Fsnowolf.iteye.com%2Fblog%2F1677495&amp;referrer=&amp;user_id=" alt=""> <img src="http://dt.tongji.linezing.com/tongji.do?unit_id=1122445&amp;uv_id=15753577192130187469&amp;uv_new=0&amp;cna=&amp;cg=&amp;mid=&amp;mmland=&amp;ade=&amp;adtm=&amp;sttm=&amp;cpa=&amp;ss_id=3627902245&amp;ss_no=0&amp;ec=1&amp;ref=&amp;url=http%3A//snowolf.iteye.com/blog/1677495&amp;title=Memcached%u7B14%u8BB0%u2014%u2014%uFF08%u56DB%uFF09%u5E94%u5BF9%u9AD8%u5E76%u53D1%u653B%u51FB - Snowolf%u7684%u610F%u5883%u7A7A%u95F4%uFF01 - ITeye%u6280%u672F%u7F51%u7AD9&amp;charset=utf-8&amp;domain=iteye.com&amp;hashval=909&amp;filtered=0&amp;app=Microsoft Internet Explorer&amp;agent=Mozilla/5.0 %28compatible%3B MSIE 9.0%3B Windows NT 6.1%3B WOW64%3B Trident/5.0%3B SLCC2%3B .NET CLR 2.0.50727%3B .NET CLR 3.5.30729%3B .NET CLR 3.0.30729%3B Media Center PC 6.0%3B .NET4.0C%3B .NET4.0E%3B InfoPath.3%29&amp;color=24-bit&amp;screen=1600x900&amp;lg=zh-cn&amp;je=1&amp;fv=10.0&amp;st=1377062586&amp;vc=eee3dea2&amp;ut=2&amp;url_id=0&amp;cnu=0.01284455030611481" alt=""><a href="http://tongji.alimama.com/report.html?unit_id=1122445" target="_blank"><img src="" alt="量子统计"></a></li>
</ul>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Nosql/">Nosql</a></li></span><span class="breadcrumb"><li><a href="/categories/Nosql/">Nosql</a></li><li><a href="/categories/Nosql/mongo/">mongo</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Nosql/" class="label label-primary">Nosql</a><a href="/tags/mongo/" class="label label-success">mongo</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:31"datetime="2014-03-07 09:54:31"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-Nosql-mongo--Memcached笔记——（四）应对高并发攻击/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-Nosql-mongo--Memcached笔记——（四）应对高并发攻击" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-Nosql--GoogleDremel原理–如何能3秒分析1PB/">Google Dremel 原理 – 如何能3秒分析1PB</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:31.000Z"> <a href="/2014/02/02/2014-02-02-Nosql--GoogleDremel原理–如何能3秒分析1PB/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="google-dremel-3-1pb">Google Dremel 原理 – 如何能3秒分析1PB</h1>
<h3 id="-">简介</h3>
<p>Dremel 是Google 的“交互式”数据分析系统。可以组建成规模上千的集群，处理PB级别的数据。MapReduce处理一个数据，需要分钟级的时间。作为MapReduce的发起人，Google开发了Dremel将处理时间缩短到秒级，作为MapReduce的有力补充。Dremel作为Google BigQuery的report引擎，获得了很大的成功。最近Apache计划推出Dremel的开源实现Drill，将Dremel的技术又推到了浪尖上。</p>
<h3 id="google-dremel-">Google Dremel设计</h3>
<p>根据Google公开的论文《<a href="http://research.google.com/pubs/pub36632.html" target="_blank">Dremel: Interactive Analysis of WebScaleDatasets</a>》可以看到Dremel的设计原理。还有一些测试报告。论文写于2006年，公开于2010年，Google在处理大数据方面，果真有得天独厚的优势。下面的内容，很大部分来自这篇论文。</p>
<p>随着Hadoop的流行，大规模的数据分析系统已经越来越普及。数据分析师需要一个能将数据“玩转”的交互式系统。如此，就可以非常方便快捷的浏览数据，建立分析模型。Dremel系统有下面几个主要的特点：</p>
<ul>
<li><strong>Dremel**</strong>是一个大规模系统。**在一个PB级别的数据集上面，将任务缩短到秒级，无疑需要大量的并发。磁盘的顺序读速度在100MB/S上下，那么在1S内处理1TB数据，意味着至少需要有1万个磁盘的并发读! Google一向是用廉价机器办大事的好手。但是机器越多，出问题概率越大，如此大的集群规模，需要有足够的容错考虑，保证整个分析的速度不被集群中的个别慢(坏)节点影响。</li>
<li><strong>Dremel**</strong>是MR<strong>**交互式查询能力不足的补充。</strong>和MapReduce一样，Dremel也需要和数据运行在一起，将计算移动到数据上面。所以它需要GFS这样的文件系统作为存储层。在设计之初，Dremel并非是MapReduce的替代品，它只是可以执行非常快的分析，在使用的时候，常常用它来处理MapReduce的结果集或者用来建立分析原型。</li>
<li><strong>Dremel**</strong>的数据模型是嵌套(nested)<strong>**的。</strong>互联网数据常常是非关系型的。Dremel还需要有一个灵活的数据模型，这个数据模型至关重要。Dremel支持一个嵌套(nested)的数据模型，类似于Json。而传统的关系模型，由于不可避免的有大量的Join操作，在处理如此大规模的数据的时候，往往是有心无力的。</li>
<li><strong>Dremel**</strong>中的数据是用列式存储的。**使用列式存储，分析的时候，可以只扫描需要的那部分数据的时候，减少CPU和磁盘的访问量。同时列式存储是压缩友好的，使用压缩，可以综合CPU和磁盘，发挥最大的效能。对于关系型数据，如果使用列式存储，我们都很有经验。但是对于嵌套(nested)的结构，Dremel也可以用列存储，非常值得我们学习。</li>
<li><strong>Dremel**</strong>结合了Web<strong><strong>搜索</strong></strong>和并行DBMS<strong>**的技术。</strong>首先，他借鉴了Web搜索中的“查询树”的概念，将一个相对巨大复杂的查询，分割成较小较简单的查询。大事化小，小事化了，能并发的在大量节点上跑。其次，和并行DBMS类似，Dremel可以提供了一个SQL-like的接口，就像Hive和Pig那样。</li>
</ul>
<h3 id="google-dremel-">Google Dremel应用场景</h3>
<p>设想一个使用场景。我们的美女数据分析师，她有一个新的想法要验证。要验证她的想法，需要在一个上亿条数据上面，跑一个查询，看看结果和她的想法是不是一样，她可不希望等太长时间，最好几秒钟结果就出来。当然她的想法不一定完善，还需要不断调整语句。然后她验证了想法，发现了数据中的价值。最后，她可以将这个语句完善成一个长期运行的任务。</p>
<p>对于Google,数据一开始是放在GFS上的。可以通过MapReduce将数据导入到Dremel中去，在这些MapReduce中还可以做一些处理。然后分析师使用Dremel，轻松愉悦的分析数据，建立模型。最后可以编制成一个长期运行的MapReduce任务。</p>
<p>这种处理方式，让笔者联想到Greenplum的<a href="http://www.greenplum.com/products/chorus" target="_blank">Chorus</a>. Chorus也可以为分析师提供快速的数据查询，不过解决方案是通过预处理，导入部分数据，减少数据集的大小。用的是三十六计，走为上计，避开的瞬时分析大数据的难题。Chorus最近即将开源，可以关注下。</p>
<p>还有一点特别的就是按列存储的嵌套数据格式。如图所示，在按记录存储的模式中，一个记录的多列是连续的写在一起的。在按列存储中，可以将数据按列分开。也就是说，可以仅仅扫描A.B.C而不去读A.E或者A.B.C。难点在于，我们如何能同时高效地扫描若干列，并做一些分析。</p>
<p><a href="http://yankaycom-wordpress.stor.sinaapp.com/uploads/2012/12/13458644104566_f.jpg" target="_blank"><img src="&quot;Record-wise vs. columnar representation of nested data  &quot;" alt=""></a></p>
<h3 id="google-dremel-">Google Dremel数据模型</h3>
<p>在Google, 用Protocol Buffer常常作为序列化的方案。其数据模型可以用数学方法严格的表示如下：</p>
<p>t=dom|<A1:t[∗|?],...,An:t[∗|?]></p>
<p>其中t可以是一个基本类型或者组合类型。其中基本类型可以是integer,float和string。组合类型可以是若干个基本类型拼凑。星号(/*)指的是任何类型都可以重复，就是数组一样。问号(?)指的是任意类型都是可以是可选的。简单来说，除了没有Map外，和一个Json几乎没有区别。</p>
<p>下图是例子，Schema定义了一个组合类型Document.有一个必选列DocId，可选列Links，还有一个数组列Name。可以用Name.Language.Code来表示Code列。</p>
<p><a href="http://yankaycom-wordpress.stor.sinaapp.com/uploads/2012/12/13458646314107_f.jpg" target="_blank"><img src="&quot;Two sample nested records and their schema&quot;" alt=""></a></p>
<p>这种数据格式是语言无关，平台无关的。可以使用Java来写MR程序来生成这个格式，然后用C++来读取。在这种列式存储中，能够快速通用处理也是非常的重要的。</p>
<p>上图，是一个示例数据的抽象的模型；下图是这份数据在Dremel实际的存储的格式。</p>
<p><a href="http://yankaycom-wordpress.stor.sinaapp.com/uploads/2012/12/13458643358445_f.jpg" target="_blank"><img src="&quot;Column-striped representation of the sample data in Figure&quot;" alt=""></a></p>
<p>如果是关系型数据，而不是嵌套的结构。存储的时候，我们可以将每一列的值直接排列下来，不用引入其他的概念，也不会丢失数据。对于嵌套的结构，我们还需要两个变量R (Repetition Level) ,D (Definition Level) 才能存储其完整的信息。</p>
<p><strong>Repetition Level</strong>是记录该列的值是在哪一个级别上重复的。举个例子说明：对于Name.Language.Code? 我们一共有三条非Null的记录。</p>
<ol>
<li>第一个是”en-us”，出现在第一个Name的第一个Lanuage的第一个Code里面。在此之前，这三个元素是没有重复过的，都是第一个。所以其R为0。</li>
<li>第二个是”en”，出现在下一个Lanuage里面。也就是说Lanague是重复的元素。Name.Language.Code中Lanague排第二个，所以其R为2.</li>
<li>第三个是”en-gb”，出现在下一个Name中，Name是重复元素，排第一个，所以其R为1。</li>
</ol>
<p>我们可以想象，将所有的没有值的列，设值为NULL。如果是数组列，我们也想象有一个NULL值。有了Repetition Level，我们就可以很好的用列表示嵌套的结构了。但是还有一点不足。就是还需要表示一个数组是不是我们想象出来的。</p>
<p><strong>Definition Level</strong> 是定义的深度，用来记录该列是否是”想象”出来的。所以对于非NULL的记录，是没有意义的，其值必然为相同。同样举个例子。例如Name.Language.Country,</p>
<ul>
<li>第一个”us”是在R1里面，其中Name,Language,Country是有定义的。所以D为3。</li>
<li>第二个”NULL”也是在R1的里面，其中Name,Language是有定义的,其他是想象的。所以D为2。</li>
<li>第三个”NULL”还是在R1的里面，其中Name是有定义的,其他是想象的。所以D为1。</li>
<li>第四个”gb”是在R1里面，其中Name,Language,Country是有定义的。所以D为3。</li>
</ul>
<p>就是这样，如果路径中有required，可以将其减去，因为required必然会define，记录其数量没有意义。</p>
<p>理解了如何存储这种嵌套结构。写没有难度。读的时候，我们只读其中部分字段，来构建部分的数据模型。例如，只读取DocID和Name.Language.Country。我们可以同时扫描两个字段，先扫描DocID。记录下第一个，然后发现下一个DocID的R是0；于是该读Name.Language.Country，如果下一个R是1或者2就继续读，如果是0就开始读下一个DocID。</p>
<p><a href="http://yankaycom-wordpress.stor.sinaapp.com/uploads/2012/12/13458640099204_f.jpg" target="_blank"><img src="&quot;Automaton for assembling records from two fields, and&quot;" alt=""></a></p>
<p>下图展示了一个更为复杂的读取的状态机示例。在读取过程中使用了Definition Level来快速Jump,提升性能。
<a href="http://yankaycom-wordpress.stor.sinaapp.com/uploads/2012/12/13460300363599_f.jpg"><img src="&quot;Complete record assembly automaton. Edges are labeled&lt;br /&gt;
with repetition levels&quot;" alt=""></a></p>
<p>到此为止，我们已经知道了Dremel的数据结构。就像其他数据分析系统一样，数据结构确定下来，功能就决定了一大半。对于Dremel的数据查询，必然是“全表扫描”，但由于其巧妙的列存储设计，良好的数据模型设计可以回避掉大部分Join需求和扫描最少的列。</p>
<h3 id="google-dremel-">Google Dremel查询方式</h3>
<p>Dremel可以使用一种SQL-like的语法查询嵌套数据。由于Dremel的数据是只读的，并且会密集的发起多次类似的请求。所以可以保留上次请求的信息，还优化下次请求的explain过程。那又是如何explain的呢？</p>
<p><a href="http://yankaycom-wordpress.stor.sinaapp.com/uploads/2012/12/13458646380664_f.jpg" target="_blank"><img src="&quot;System architecture and execution inside a server node&quot;" alt=""></a></p>
<p>这是一个树状架构。当Client发其一个请求，根节点受到请求，根据metadata，将其分解到枝叶，直到到位于数据上面的叶子Server。他们扫描处理数据，又不断汇总到根节点。</p>
<p>举个例子：对于请求：
SELECT A, COUNT(B) FROM T GROUP BY A</p>
<p>根节点收到请求，会根据数据的分区请求，将请求变成可以拆分的样子。原来的请求会变为。</p>
<p>SELECT A, SUM(c) FROM (R1 UNION ALL ... Rn) GROUP BY A</p>
<p>R1,…RN是T的分区计算出的结果集。越大的表有越多的分区，越多的分区可以越好的支持并发。</p>
<p>然后再将请求切分，发送到每个分区的叶子Server上面去,对于每个Server
?Ri = SELECT A, COUNT(B) AS c FROM Ti GROUP BY A</p>
<p>结构集一定会比原始数据小很多，处理起来也更快。根服务器可以很快的将数据汇总。具体的聚合方式，可以使用现有的并行数据库技术。</p>
<p>Dremel是一个多用户的系统。切割分配任务的时候，还需要考虑用户优先级和负载均衡。对于大型系统，还需要考虑容错，如果一个叶子Server出现故障或变慢，不能让整个查询也受到明显影响。</p>
<p>通常情况下，每个计算节点，执行多个任务。例如，技巧中有3000个叶子Server，每个Server使用8个线程，有可以有24000个计算单元。如果一张表可以划分为100000个区，就意味着大约每个计算单元需要计算5个区。这执行的过程中，如果某一个计算单元太忙，就会另外启一个来计算。这个过程是动态分配的。</p>
<p>对于GFS这样的存储，一份数据一般有3份拷贝，计算单元很容易就能分配到数据所在的节点上，典型的情况可以到达95%的命中率。</p>
<p>Dremel还有一个配置，就是在执行查询的时候，可以指定扫描部分分区，比如可以扫描30%的分区，在使用的时候，相当于随机抽样，加快查询。</p>
<h3 id="google-dremel-">Google Dremel测试实验</h3>
<p>实验的数据源如下表示。大部分数据复制了3次，也有一个两次。每个表会有若干分区，每个分区的大小在100K到800K之间。如果压缩率是25%，并且计入复制3份的事实的话。T1的大小已经达到PB级别。这么小且巨量的分区，对于GFS的要求很高，现在的Hdfs稳定版恐怕受不了。接下来的测试会逐步揭示其是如何超过MR，并对性能作出分析。
<strong>表名</strong> <strong>记录数</strong> <strong>大小(**</strong>已压缩)<strong> </strong>列数<strong> </strong>数据中心<strong> </strong>复制数量** T1 85 billion 87 TB 270 A 3× T2 24 billion 13 TB 530 A 3× T3 4 billion 70 TB 1200 A 3× T4 1+ trillion 105 TB 50 B 2× T5 1+ trillion 20 TB 30 B 3×</p>
<h3 id="-">列存测试</h3>
<p>首先，我们测试看看列存的效果。对于T1表，1GB的数据大约有300K行，使用列存的话压缩后大约在375MB。这台机器磁盘的吞吐在70MB/s左右。这1GB的数据，就是我们的现在的测试数据源，测试环境是单机。</p>
<p><a href="http://yankaycom-wordpress.stor.sinaapp.com/uploads/2012/12/13458638268923_f.jpg" target="_blank"><img src="" alt=""></a></p>
<p>见上图。</p>
<ul>
<li>曲线A，是用列存读取数据并解压的耗时。</li>
<li>曲线B是一条一条记录挨个读的时间。</li>
<li>曲线C是在B的基础上，加上了反序列化的时间。</li>
<li>曲线d，是按行存读并解压的耗时。</li>
<li>曲线e加上了反序列化的时间。因为列很多，反序列化耗时超过了读并解压的50%。</li>
</ul>
<p>从图上可以看出。如果需要读的列很少的话，列存的优势就会特别的明显。对于列的增加，产生的耗时也几乎是线性的。而一条一条该个读和反序列化的开销是很大的，几乎都在原来基础上增加了一倍。而按行读，列数的增加没有影响，因为一次性读了全部列。</p>
<h3 id="dremel-mapreduce-">Dremel和MapReduce的对比测试</h3>
<p>MR和Dremel最大的区别在于行存和列存。如果不能击败MapReduce，Remel就没有意义了。使用最常见的WordCount测试，计算这个数据中Word的个数。
Q1: SELECT SUM(CountWords(txtField)) / COUNT(/*) FROM T1</p>
<p><a href="http://yankaycom-wordpress.stor.sinaapp.com/uploads/2012/12/13458638073453_f.jpg" target="_blank"><img src="&quot;MR and Dremel execution on columnar vs. recordoriented&quot;" alt=""></a></p>
<p>上图是测试的结果。使用了两个MR任务。这两个任务和Dremel一样都运行在3000个节点上面。如果使用列存，Dremel的按列读的MR只需要读0.5TB的数据，而按行存需要读87TB。 MR提供了一个方便有效的途经来讲按行数据转换成按列的数据。Dremel可以方便的导入MapReduce的处理结果。</p>
<h3 id="-server-">树状计算Server测试</h3>
<p>接下来我们要对比在T2表示使用两个不同的Group BY查询。T2表有24 billion 行的记录。每个记录有一个 item列表，每一item有一个amount 字段。总共有40 billion个item.amount。这两个Query分别是。
Q2: SELECT country, SUM(item.amount) FROM T2 GROUP BY country</p>
<p>Q3: SELECT domain, SUM(item.amount) FROM T2 WHERE domain CONTAINS ’.net’ GROUP BY domain</p>
<p>Q2需要扫描60GB的压缩数据，Q3需要扫描180GB，同时还要过滤一个条件。</p>
<p><a href="http://yankaycom-wordpress.stor.sinaapp.com/uploads/2012/12/13458647595741_f.jpg" target="_blank"><img src="&quot;Execution time as a function of serving tree levels for&quot;" alt=""></a></p>
<p>上图是这两个Query在不同的server拓扑下的性能。每个测试都是有2900个叶子Server。在2级拓扑中，根server直接和叶子Server通信。在3级拓扑中，各个级别的比例是1:100:2900，增加了100个中间Server。在4级拓扑中，比例为1:10:100:2900.</p>
<p>Q2可以在3级拓扑下3秒内执行完毕，但是为他提供更高的拓扑级别，对性能提升没有裨益。相比之下，为Q3提供更高的拓扑级别，性能可以有效提升。这个测试体现了树状拓扑对性能提升的作用。</p>
<h3 id="-">每个分区的执行情况</h3>
<p>对于刚刚的两个查询，具体的每个分区的执行情况是这样的。</p>
<p><a href="http://yankaycom-wordpress.stor.sinaapp.com/uploads/2012/12/13458637868939_f.jpg" target="_blank"><img src="&quot;Histograms of processing times&quot;" alt=""></a></p>
<p>可以看到99%的分区都在1s内完成了。Dremel会自动调度，使用新的Server计算拖后腿的任务。</p>
<h3 id="-">记录内聚合</h3>
<p>由于Demel支持List的数据类型，有的时候，我们需要计算每个记录里面的各个List的聚合。如
Q4 : SELECT COUNT(c1 &gt; c2) FROM</p>
<p>(SELECT SUM(a.b.c.d) WITHIN RECORD AS c1,</p>
<p>SUM(a.b.p.q.r) WITHIN RECORD AS c2</p>
<p>FROM T3)</p>
<p>我们需要count所有sum(a.b.c.d)比sum(a.b.p.q.r)，执行这条语句实际只需要扫描13GB的数据，耗时15s，而整张表有70TB。如果没有这样的嵌套数据结构，这样的查询会很复杂。</p>
<h3 id="-">扩展性测试</h3>
<p>Dremel有良好的扩展性，可以通过增加机器来缩短查询的时间。并且可以处理数以万亿计的记录。</p>
<p>对于查询：
Q5: SELECT TOP(aid, 20), COUNT(/*) FROM T4?WHERE bid = fvalue1g AND cid = fvalue2g</p>
<p>使用不同的叶子Server数目来进行测试。</p>
<p><a href="http://yankaycom-wordpress.stor.sinaapp.com/uploads/2012/12/13458644318827_f.jpg" target="_blank"><img src="&quot;Scaling the system from 1000 to 4000 nodes using a&quot;" alt=""></a></p>
<p>可以发现CPU的耗时总数是基本不变的，在30万秒左右。但是随着节点数的增加，执行时间也会相应缩短。几乎呈线性递减。如果我们使用通过CPU时间计费的“云计算”机器，每个租户的查询都可以很快，成本也会非常低廉。</p>
<h3 id="-">容错测试</h3>
<p>一个大团队里面，总有几个拖油瓶。对于有万亿条记录的T5，我们执行下面的语句。
Q6: SELECT COUNT(DISTINCT a) FROM T5</p>
<p>值得注意的是T5的数据只有两份拷贝，所以有更高的概率出现坏节点和拖油瓶。这个查询需要扫描大约1TB的压缩数据，使用2500个节点。</p>
<p><a href="http://yankaycom-wordpress.stor.sinaapp.com/uploads/2012/12/13458642912961_f.jpg" target="_blank"><img src="&quot;Query Q5 on T5 illustrating stragglers&quot;" alt=""></a></p>
<p>可以看到99%的分区都在5S内完成的。不幸的是，有一些分区需要较长的时间来处理。尽管通过动态调度可以加快一些，但在如此大规模的计算上面，很难完全不出问题。如果不在意太精确的结果，完全可以小小减少覆盖的比例，大大提升相应速度。</p>
<h3 id="google-dremel-">Google Dremel 的影响</h3>
<p>Google Dremel的能在如此短的时间内处理这么大的数据，的确是十分惊艳的。有个伯克利分校的教授Armando Fox说过一句话“如果你曾事先告诉我Dremel声称其将可做些什么，那么我不会相信你能开发出这种工具”。这么给力的技术，必然对业界造成巨大的影响。第一个被波及到的必然是Hadoop。</p>
<h3 id="dremel-hadoop">Dremel与Hadoop</h3>
<p>Dremel的公开论文里面已经说的很明白，Dremel不是用来替代MapReduce，而是和其更好的结合。Hadoop的Hive，Pig无法提供及时的查询，而Dremel的快速查询技术可以给Hadoop提供有力的补充。同时Dremel可以用来分析MapReduce的结果集，只需要将MapReduce的OutputFormat修改为Dremel的格式，就可以几乎不引入额外开销，将数据导入Dremel。使用Dremel来开发数据分析模型，MapReduce来执行数据分析模型。</p>
<p>Hadoop的Hive,Pig现在也有了列存的模式，架构上和Dremel也接近。但是无论存储结构还是计算方式都没有Dremel精致。对Hadoop实时性的改进也一直是个热点话题。要想在Hadoop中山寨一个Dremel，并且相对现有解决方案有突破，笔者觉得Hadoop自身需要一些改进。一个是HDFS需要对并发细碎的数据读性能有大的改进，HDFS需要更加的低延迟。再者是Hadoop需要不仅仅支持MapReduce这一种计算框架。其他部分,Hadoop都有对应的开源组件，万事俱备只欠东风。</p>
<h3 id="dremel-">Dremel的开源实现</h3>
<p>Dremel现在还没有一个可以运行的开源实现，不过我们看到很多努力。一个是Apache的Drill，一个是OpenDremel/Dazo。</p>
<p><strong>OpenDremel/Dazo</strong></p>
<p>OpenDremel是一个开源项目，最近改名为Dazo。可以在GoogleCode上找到<a href="http://code.google.com/p/dremel/" target="_blank"><a href="http://code.google.com/p/dremel/">http://code.google.com/p/dremel/</a></a>。目前还没有发布。作者声称他已经完成了一个通用执行引擎和OpenStack Swift的集成。笔者感觉其越走越歪，离Dremel越来越远了。</p>
<p><strong>Apache Drill</strong></p>
<p><a href="http://wiki.apache.org/incubator/DrillProposal" target="_blank">Drill</a>是Hadoop的赞助商之一MapR发起的。Drill作为一个Dremel的山寨项目，有和Dremel相似的架构和能力。他们希望Drill最终会想Hive,Pig一样成为Hadoop上的重要组成部分。为Hadoop提供快速查询的能力。和Dremel有一点不同，在数据模型上，开源的项目需要支持更标准的数据结构。比如CSV和JSON。同时Drill还有更大的灵活性，支持多重查询语言，多种接口。</p>
<p>现在Drill的目标是完成初始的需求，架构。完成一个初始的实现。这个实现包括一个执行引擎和DrQL。DrQL是一个基于列的格式，类似于Dremel。目前，Drill已经完成的需求和架构设计。总共分为了四个组件</p>
<ul>
<li>Query language:类似Google BigQuery的查询语言，支持嵌套模型，名为DrQL.</li>
<li>Low-lantency distribute execution engine:执行引擎，可以支持大规模扩展和容错。可以运行在上万台机器上计算数以PB的数据。</li>
<li>Nested data format:嵌套数据模型，和Dremel类似。也支持CSV,JSON,YAML类似的模型。这样执行引擎就可以支持更多的数据类型。</li>
<li>Scalable data source: 支持多种数据源，现阶段以Hadoop为数据源。</li>
</ul>
<p>目前这四个组件在分别积极的推进，Drill也非常希望有社区其他公司来加入。Drill希望加入到Hadoop生态系统中去。</p>
<h3 id="-">最后的话</h3>
<p>本文介绍了Google Dremel的使用场景，设计实现，测试实验，和对开源世界的影响。相信不久的将来，Dremel的技术会得到广泛的应用。
Share the post &quot;Google Dremel 原理 - 如何能3秒分析1PB&quot;</p>
<ul>
<li><a href="http://service.weibo.com/share/share.php?url=http%3A%2F%2Fwww.yankay.com%2Fgoogle-dremel-rationale%2F" title="Share this article on Weibo" target="_blank">Weibo</a></li>
</ul>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Nosql/">Nosql</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Nosql/" class="label label-primary">Nosql</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:31"datetime="2014-03-07 09:54:31"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-Nosql--GoogleDremel原理–如何能3秒分析1PB/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-Nosql--GoogleDremel原理–如何能3秒分析1PB" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-Nosql--NoSQL反模式–文档数据库篇/">NoSQL反模式 – 文档数据库篇</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:31.000Z"> <a href="/2014/02/02/2014-02-02-Nosql--NoSQL反模式–文档数据库篇/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="nosql-">NoSQL反模式 – 文档数据库篇</h1>
<ul>
<li><p><a href="http://www.yankay.com/" target="_blank">首页</a></p>
</li>
<li><p><a href="http://www.yankay.com/about/" target="_blank">关于</a></p>
</li>
</ul>
<h1 id="-http-www-yankay-com-"><a href="http://www.yankay.com/" target="_blank">我自然</a></h1>
<h2 id="-">颜开的博客</h2>
<h2 id="nosql-">NoSQL反模式 - 文档数据库篇</h2>
<p>作者: <a href="http://www.yankay.com/author/admin/" title="查看 颜开 的所有文章" target="_blank">颜开</a> 日期: 2013 年 1 月 25 日  <a href="&quot;发表评论？&quot;">发表评论</a> (14) <a href="&quot;查看评论？&quot;">查看评论</a></p>
<p>我们设计关系数据库Schema的都有一套完整的方案，而NoSQL却没有这些。半年前笔者读了本《SQL反模式》的书，觉得非常好。就开始留意，对于NoSQL是否也有反模式？好的反模式可以在我们设计Schema告诉哪里是陷阱和悬崖。NoSQL宣传的时候往往宣称是SchemaLess的，这会让人误解其不需要设计Schema。但如果不意识到设计Schema的必要，陷阱就在一直在黑暗中等着我们。这篇文章就总结一些别人的，也有自己犯过的深痛的设计Schema错误。</p>
<p>NoSQL数据库最主流的有文档数据库，列存数据库，键值数据库。三者分别有代表作MongoDB，HBase和Redis。如果将NoSQL比作兵器的话，可以这样(MySQL是典型的关系型数据库，一样参与比较)： <a href="http://yankaycom-wordpress.stor.sinaapp.com/uploads/2013/01/NosqlImage.png" target="_blank"><img src="&quot;Nosql兵器谱&quot;" alt=""></a></p>
<ul>
<li><strong>MySQL</strong>产生年代较早，而且随着LAMP大潮得以成熟。尽管其没有什么大的改进，但是新兴的互联网使用的最多的数据库。就像传统的菜刀，结构简单，几百年没有改进。但是不妨碍产生各式各样的刀法，只要有一把，就能胜任厨房里的大部分事务。MySQL也是一样，核心已经稳定。但是切库，分表，备份，监控，等等手段一应俱全。</li>
<li><strong>MongoDB</strong>是个新生事物，提供更灵活的Schema，Capped Collection，异步提交，地理位置索引等五花十色的功能。就像瑞士军刀，不但可以当刀用，还可以开瓶盖，剪指甲。但是他也不比MySQL强，因为还缺乏时间的磨砺。一是系统本身的稳定性，二是开发，运维需要更多经验才能流行。</li>
<li><strong>HBase</strong>是个仗势欺人的大象兵。依仗着Hadoop的生态环境，可以有很好的扩展性。但是就像象兵一样，使用者需要养一头大象(Hadoop),才能驱使他。</li>
<li><strong>Redis</strong>是键值存储的代表，功能最简单。提供随机数据存储。就像一根棒子一样，没有多余的构造。但是也正是因此，他的伸缩性特别好。就像悟空手里的金箍棒，大可捅破天，小能成缩成针。</li>
</ul>
<h3 id="-">文档数据库的得失</h3>
<p>关系模型试图将数据库模型和数据库实现分开，让开发者可以脱离底层很好的操作数据。但笔者以为关系模型在一些应用场景下有弱点，现在已经不得不面对。</p>
<ul>
<li><strong>**</strong>SQL<strong>**弱点一：必须支持Join</strong>。因为数据不能够有重复。所以使用范式的关系模型会不可避免的大量Join。如果参与Join的是一张比内存小的表还好。但是如果大表Join或者表分布在多台机器上的话，Join就是性能的噩梦。</li>
<li><strong>**SQL弱点二：</strong>计算和存储耦合**。关系模型作为统一的数据模型既可以用于数据分析，也可以用于在线业务。但这两者一个强调高吞吐，一个强调低延时，已经演化出完全不同的架构。用同一套模型来抽象显然是不合适的。Hadoop针对的就是计算的部分。MongoDB,Redis等针对在线业务。两者都抛弃了关系模型。</li>
</ul>
<p>针对这两个梦魇。文档数据库如MongoDB的的主要目的是<strong> 提供更丰富的数据结构来抛弃Join来适应在线业务</strong>。当然也不是MongoDB完全不能用Join，不能拿来做数据分析，讨论这个只是见仁见智的问题。所以文档数据库并不比关系数据库强大，由于对Join的弱支持，功能会弱许多。设计关系模型的时候，通常只需要考虑好数据直接的关系，定义数据模型。而设计文档数据库模型的时候，还需要考虑应用如何使用。因此设计好一个的文档数据库Schema比设计关系模型更加的困难。除此之外，由于文档数据库事务的支持也是比较弱，一般NoSQL只会提供一个行锁。这也给设计Schema更加增加了难度。对于文档数据库的使用有很多需要注意的地方，本文只关注模型设计的部分。</p>
<h3 id="-">反模式一：惯性思维/沿用关系模型</h3>
<p>关系模型是数据存储的经典模型，使用数据模型范式的好处非常的明显。但是由于文档数据库不支持Join(包括和外键息息相关的外键约束)等特性，习惯性的沿用关系模型有的时候会出现问题。需要利用起文档数据库提供的丰富的数据模型来应对。</p>
<p>值得一提的是文档数据库的设计和关系模型不同，是灵活多样的。对于同一个情形，可以设计出有多种能够工作的模型，没有绝对意义上最好的模型。</p>
<p>下图是关系模型和文档模型的对比。
<a href="http://yankaycom-wordpress.stor.sinaapp.com/uploads/2013/01/r-d1.png" target="_blank"><img src="&quot;关系模型 VS 文档模型&quot;" alt=""></a></p>
<p>关系模型 VS 文档模型</p>
<p>这个一个博客的数据模型，有Blog,User等表。左侧是关系模型，右侧是文档模型。这个文档模型并不是完全合理，可以作为“正反两面教材”在下文不断阐述。</p>
<p><strong>问题一：存在描述多对多的关系表</strong>
症状：文档数据库中存储在有纯粹的关系表，例如：
id user_id blog_id 0 0 0 1 0 1</p>
<p>这样的表就算在关系模型中也是不妥的，因为这个ID非常的多余，可以用联合主键来解决。但是在文档数据库中，由于必须强制单主键，不得不采取这样的设计。</p>
<p>坏处：</p>
<ol>
<li>破坏数据完备性。由于ID是主键，在数据模型上没有约束来保证不出现重复的user_id,blog_id对。一旦数据出现重复，更新删除都是问题。</li>
<li>索引过多。由于是关系表，必须在user_id和blog_id上面分别建一个索引。影响性能。</li>
</ol>
<p>解决方案：
使用文档数据库典型的处理多对多的办法。不是建立一张关系表，而是在其中一个文档(如User)中，加入一个List字段。
user_id user_name blog_id[] …… 0 Jake 0,1 …… 1 Rose 1,2 ……</p>
<p><strong>问题二:没有区分&quot;一对多关系&quot;和“多对一关系”</strong>
症状：关系模型不区分“一对多”和“多对一”，对于文档数据库来讲，关系模型只有“多对一”。就像这张Comment表：
comment_id user_id content …… 0 0 “NoSQL反模式是好文章” …… 1 0 “是啊” ……</p>
<p>如果整个模型都是这样的“多对一”关系就需要反思了。</p>
<p>坏处：</p>
<ol>
<li>额外索引。如果客户端已知user_id,需要获得User信息和Comment信息，需要执行两次查询。其中一次查询需要使用索引。并且要在客户端自己Join。这样可能有潜在性能问题。</li>
</ol>
<p>解决方案：
问题的核心在于是已知user_id查询两张表，还是已知comment_id查询两张表。如果是已知comment_id这样的设计就是合理的，但是如果是已知user_id来查询，把关系放在user表里的设计更合理一些。
user_id user_name comment_id[] …… 0 Jake 0,1 …… 1 Rose 1,2 ……</p>
<p>这样的设计，就可以避免一个索引。同理，对于多对多也是一样的，通过合理的安排字段的位置可以避免索引。</p>
<p>正确使用的场合：</p>
<p>关系型模型是非常成功的数据模型，合理的沿用是非常好的。但是由于文档数据库的特点，需要适当的调整，这样得出的数据模型，尽管性能不是最优，但是有最好的灵活性。并且也有利于和关系数据库转换。</p>
<h3 id="-join">反模式二：处处引用客户端Join</h3>
<p>症状：数据库设计中充满了xx_id的字端，在查询的时候需要大量的手动Join操作。就涉及到了这个反模式。正如上面提到的博客的关系模型，如果已知blog_id查询comments，需要至少执行3次查询，并且手动Join。</p>
<p>坏处：</p>
<ol>
<li>手动Join，麻烦且易出错。文档数据库不支持Join且没有外键保证。因此需要在客户端Join，这样的操作对于软件开发来讲是比较繁琐的。由于没有外键保证，因此不能保证取得的ID在数据库里面是有数据的。在处理的时候需要不断判断，容易出错。</li>
<li>多次查询。如果引用过多，查询的时候需要多次查询才能查到足够的数据。本来文档数据库是很快的，但是由于多次查询，给数据库增加了压力，获取全部数据的时间也会增加。</li>
<li>事务处理繁琐。文档数据库一般不支持一般意义上事务，只支持行锁。如果文档数据库有给多个连接。在插入的时候，事务的处理就是噩梦。在文档数据库中使用事务，需要使用行锁，在进行大量的处理。太过繁琐，感兴趣的读者可以搜一下。</li>
</ol>
<p>解决方案：
适当使用内联数据结构。由于文档数据库支持更复杂的数据结构可以将引用转换为内联的数据，而不用新建一张表。这样做可以解决上面的一些问题，是一个推荐的方案。就像上面博客的例子一样。将五张表简化成了两张表。那什么时候使用内联呢？一般认为</p>
<ul>
<li>使用内联可以解决读性能问题，明显减少Query的次数的时候。</li>
<li>可以简化数据模型，化简表之间的关系，而同时不会影响灵活性的时候。</li>
<li>事务可以得到简化为单行事务的时候</li>
</ul>
<p>正确使用的场合：</p>
<p>范式化的使用场景，文档数据库会被多个应用使用。由于数据库设计无法估计多个应用现在及将来的查询情况，需要极大的灵活性。在这个时候，使用引用比内联靠谱。</p>
<h3 id="-">反模式三 滥用内联后患无穷</h3>
<p><strong>问题一 妨碍到查询的内联</strong>
症状：频繁查询一些内联字段，丢弃其他字段。</p>
<p>坏处：</p>
<ol>
<li>无ID约束：使用内联字段和引用不同，是没有ID约束的。因此不能通过ID(主键)来管理，如果经常需要单独操作内联对象会非常不便。</li>
<li>索引泛滥：如果以内联字段为条件进行查询，需要建立索引。有可能造成索引泛滥。</li>
<li>性能浪费：大部分文档数据库的实现是按行存储的，也就意味着，尽管只查询一个字段，但是DB需要将整行从磁盘中取出。如果字段够小，文档够大，是很不合算的。</li>
</ol>
<p>解决方案：
如果出现以上的症结，就可以考虑使用引用代替内联了。内联特性主要的用途在于提高性能，如果出现性能不升反降，那就没有意义了。如果对性能有很强烈的要求，可以考虑使用重复数据，同样的数据即在内联字段中也在引用的表里面。这样可以结合内联和引用的性能优势。缺点是数据出现重复，维护会比较麻烦。</p>
<p><strong>问题二 无限膨胀的内联</strong>
症状：List,Map类型的内联字段不断膨胀，而且没有限制。就像前面提到的Blog的内联字段Comment。如果对每一篇Blog的Comment数量没有限制的话，Comment会无限膨胀。轻则影响性能，重则插入失败。
Blog_id content Comment[] …… 0 “…” “NoSQL反模式是好文章”, “是啊”,”无限增长中”… ……</p>
<p>坏处：</p>
<ol>
<li>插入失败。文档数据库的每条记录都有最大大小，并且也有推荐最佳的大小。一般不会超过4M。就像刚刚提到的例子，如果是篇热门的博文的话，评论的大小很容易就超过4M。届时文档将无法更新，新的评论无法插入。</li>
<li>性能拖油瓶。由于内联字段膨胀，其大小将远远超过其他部分，影响其他部分的性能表现。并且因此导致该记录大小频繁变化，对档数据库的数据文件内部可能因此产生很多碎片。</li>
</ol>
<p>解决方案：
设定最大数目或者使用引用。还是Blog和Comment的例子，可以将Comment从Blog中剥离出成一张表。如果考虑到性能，可以在Blog表中新建一个字段如最近的评论。这样既保证了性能，又能够预防膨胀。
Blog_id content last_five_comment[] …… 0 “…” “NoSQL反模式是好文章”, “是啊”,”最多5条”… ……</p>
<p><strong>问题三 无法维护的内联</strong>
症状：DBA想单独维护内联字段，但无法做到。</p>
<p>坏处：</p>
<ol>
<li>权限管理难。数据库的权限管理的最小粒度是表。如果使用内联技术，就意味着内联部分必须和其他字段用同一个权限来管理。没有办法在DB级别隐藏。</li>
<li>切表难。如果发现一张表的庞大需要切表。这个时候就比较纠结了。如果一刀切，partion Key的选择；索引的失效都会成为问题。如果觉得拆为两张表，就会很好操作的话，就是内联的过度使用了 。</li>
<li>备份难。关系数据库中每张表可以有不同的备份策略。但是如果内联起来，这样的备份就做不到了。
解决办法：</li>
</ol>
<p>设计数据库模型的时候需要考量之后的维护操作，尤其是内联的字段需不需要单独的维护。需要和运维商量。如果对内联的字段有单独维护的要求，可以拆分出来作为引用。</p>
<p><strong>问题四 盯死应用的内联</strong>
症状：应用可以非常好的运行在数据库上。但是当新的应用接入的时候会很麻烦。因为设计数据模型的时候考虑到了查询。所以当有新应用，新查询接入的时候，就会难于使用原有的模型。</p>
<p>坏处：</p>
<ol>
<li>新应用接入难。当新的应用试图使用同一个数据库的时候，接入比较困难。因为查询时不同的，需要调整数据模型才能适应。但是调整模型又会影响原有应用。</li>
<li>集成难。不同的关系型数据库可以集成在一起，共同使用。但是对于文档数据库，虽然功能上可以互补，但是由于内联数据结构的差异，也比较难于集成。</li>
<li>ETL难。现在大部分的数据分析系统使用的是关系模型，就连Hadoop虽然不用关系模型，但是其上的Hive的常用工具也是按关系模型设计的。</li>
</ol>
<p>解决方案：</p>
<p>使用范式设计数据库，即用引用代替内联。或者在使用内联的时候，给每个内联对象一个全局唯一的Key，保证其和关系模型直接可以存在映射关系，这样可以提高数据模型的灵活性。如Blog表：
Blog_id content Comment[] …… 0 “…” [{&quot;id&quot;=1,&quot;content&quot;=“NoSQL反模式是好文章”}, {&quot;id&quot;=2,&quot;content&quot;=“是啊”}…] ……</p>
<p>这样的设计既可以利用到内联的好处，又能将其和关系模型映射起来。确定是需要手动维护comment_id，保证其全局唯一性。</p>
<h3 id="-">反模式四：在线计算</h3>
<p>症状：有一些运行时间很长的Query,由于有聚合计算，索引也不能解决。随着数据量的增长，逐渐成为性能瓶颈。</p>
<p>坏处：</p>
<ol>
<li>影响用户体验。在线业务中，如果一个查询大于4s，用户体验会急剧下降。按主键和按索引的查询都能满足要求。但是聚合操作往往需要扫描全表或者大量的数据，随着数据量的增加，查询时间会变长，用户不可容忍。</li>
<li>影响数据库性能。长查询的坏处数不清。在线上应用中，如果出现长查询，可能会霸占数据的大部分资源，包括IO，连接，CPU等等。导致其他很好的查询，轻则性能也下降，重者无法使用数据库。长查询可以称之为DB杀手。</li>
</ol>
<p>解决方案：
首先要权衡，这个聚合操作是不是必要的，必须实时完成。如果没有必要实时完成的话，可以采取离线操作的方案。在夜深人静的时候，跑一个长查询，将结果缓存起来，给第二天使用。如果必须实时完成，则可以新建一个字段，用“incr”这样的操作，在运行的时候，实时聚合结果。而不是查询的时候执行一次长查询。如果逻辑比较复杂，或者觉得大量“incr”操作给数据库系统带来了压力，可以使用Storm之类的实时数据处理框架。总之，要慎用长查询。</p>
<h3 id="-map-key-id-">反模式五：把内联Map对象的Key当作ID用</h3>
<p>症状：文档数据库支持内联Map类型。将其中Map的Key当作数据库的主键来用。
Blog_id content Comment{} …… 0 “…” {&quot;1&quot;=“NoSQL反模式是好文章”, &quot;2&quot;=“是啊”} ……</p>
<p>这个反模式很容易犯，因为在编程语言中Map数据结构就是这么用的。但是对于数据库模型来说，这是不折不扣的反模式。</p>
<p>坏处：</p>
<ol>
<li>无法通过数据库做各种(&gt;&lt;=)查询。对于关系型数据库来说，虽然数据结构可以很灵活，但查询的时候都是按层次的。比如comment.id，comment.content。也就是说其Map类型中的Key可以理解为属性名的，而不是用作ID。因此一旦这样使用，就脱离的数据库管制，无法使用各种查询功能。</li>
<li>无法通过索引查询。文档数据可建立索引是需要列名的。比如comment.id。而这样的数据结构没有固定的列名，因此无法建立索引。</li>
</ol>
<p>解决方案：
使用数组+Map来解决。如：
Blog_id content Comment[] …… 0 “…” [{&quot;id&quot;=1,&quot;content&quot;=“NoSQL反模式是好文章”}, {&quot;id&quot;=2,&quot;content&quot;=“是啊”}…] ……</p>
<p>这样，就可以使用comment.id作为索引，也可以使用数据库的查询功能。简单有效。Map类型中的Key是属性名，Value是属性值。这样的用法是文档数据库数据模型的本意，因此其提供的各种功能才能利用上。否则就无法使用。</p>
<h3 id="-id">反模式六：不合理的ID</h3>
<p>症状：使用String甚至更复杂数据结构作为的ID，或者全部使用数据库提供的自生成ID。如：
id(该ID系系统自生成） Blog_id content …… 0 0 ... ……</p>
<p>坏处:</p>
<ol>
<li>ID混乱。如果使用数据库提供的自生成ID，同时表中还有一个类似有主键含义的Blog_id，这样很不好，容易造成逻辑混乱。由于文档数据库不支持ID的重命名，习惯关系数据库做法的人可能会再建立一个自己的逻辑ID字段。这是没有必要的。</li>
<li>索引庞大，性能低下。ID是数据库的非常重要的部分。ID的长度将决定索引(包括主键的索引)的大小，直接影响到数据库性能。如果索引比内存小，性能会很好。但一旦索引大小超过内存，出现数据交换，性能会急剧下降。一个Long占8字节，一个20个字符的UTF8 String占用约60个字节。相差10倍之巨，不能不考虑。</li>
</ol>
<p>解决方案：
尽量使用有一定意义的字段做ID，并且不在其他字段中重复出现。不使用复杂的数据类型做ID，只使用int,long或者系统提供的主键类型做ID。</p>
<h3 id="-">文档数据库的反模式总结</h3>
<p>阐述了这么多的反模式，下面有个一览表，涵盖了上面所有的反模式。这个一览表，是按照文档数据库模型建立的。是个文档数据库模型的例子。
ID 反模式名 问题 0 存在描述多对多的关系表 [{ID：00
症状：文档数据库中存储在有纯粹的关系表
坏处：[破坏数据完备性，索引过多]
解决方案：加入一个List字段
},{
ID：01
症状：关系模型不区分“一对多”和“多对一”
坏处：额外索引
解决方案：合理的安排字段的位置
}] 1 处处引用客户端Join [{
ID：10
症状：查询的时候需要大量的手动Join操作
坏处：[手动Join，多次查询, 事务处理繁琐]
解决方案：适当使用内联数据结构。
}] 2 滥用内联后患无穷 [{
ID：20
症状：频繁查询一些内联字段，丢弃其他字段
坏处：[无ID约束，索引泛滥, 性能浪费]
解决方案：使用引用代替内联了,允许重复数据
},{
ID：21
症状：List,Map类型的内联字段不断膨胀，而且没有限制
坏处：[插入失败, 性能拖油瓶]
解决方案：设定最大数目或者使用引用。
},{
ID：22
症状：DBA想单独维护内联字段，但无法做到
坏处：[权限管理难, 切表难, 备份难]
解决方案：设计数据库模型的时候需要考量之后的维护操作
},{
ID：23
症状：应用可以非常好的运行在数据库上。但是当新的应用接入的时候会很麻烦。内联盯死了应用
坏处：[新应用接入难, 集成难, ETL难]
解决方案：使用范式设计数据库，即用引用代替内联。保证其和关系模型直接可以存在映射关系
}] 3 在线计算 [{
ID：30
症状：有一些运行时间很长的Query, 逐渐成为性能瓶颈。
坏处：[影响用户体验，影响数据库性能]
解决方案：取消不必要的聚合操作. 运行的时候，实时聚合结果.使用第三方实时或非实时工具。如Hadoop，Storm.
}] 4 把内联Map对象的Key当作ID用 [{
ID：40
症状：文档数据库支持内联Map类型。将其中Map的Key当作数据库的主键来用。
坏处：[无法通过数据库做各种(&gt;&lt;=)查询，无法通过索引查询]
解决方案：使用数组+Map来解决。
}] 5 不合理的ID [{
ID：50
症状：用String甚至更复杂数据结构作为的ID，或者全部使用数据库提供的自生成ID。
坏处：[ID混乱，索引庞大]
解决方案：尽量使用有一定意义的字段做ID。不使用复杂的数据类型做ID。
}]</p>
<p>本文试图总结了笔者知道的重要的文档数据库的反模式。现在关于NoSQL数据模型设计模式的讨论才刚刚起步，将来也许会逐渐自成体系。对于列数据库和Key-Value的反模式，笔者等到有了足够积累的时候，再和大家分享。</p>
<p>Share the post &quot;NoSQL反模式 - 文档数据库篇&quot;</p>
<ul>
<li><a href="http://service.weibo.com/share/share.php?url=http%3A%2F%2Fwww.yankay.com%2Fnosql-anti-pattern-document%2F" title="Share this article on Weibo" target="_blank">Weibo</a>
<a href="http://www.yankay.com/category/%e6%8a%80%e6%9c%af/%e6%af%8f%e6%97%a5%e5%bf%83%e5%be%97/" title="查看 每日心得 中的全部文章" target="_blank">每日心得</a><a href="http://www.yankay.com/tag/nosql/" target="_blank">NoSQL</a>, <a href="http://www.yankay.com/tag/%e5%8f%8d%e6%a8%a1%e5%bc%8f/" target="_blank">反模式</a>, <a href="http://www.yankay.com/tag/%e6%96%87%e6%a1%a3%e6%95%b0%e6%8d%ae%e5%ba%93/" target="_blank">文档数据库</a></li>
</ul>
<p><a href="http://www.yankay.com/2012%e5%b9%b4%e5%ad%a6%e4%b9%a0%e5%b0%8f%e7%bb%93/" target="_blank">← 2012年学习小结</a></p>
<p><a href="http://www.yankay.com/scala-tour-choiceness/" target="_blank">Scala Tour - 精选 →</a></p>
<p><a href="&quot;发表评论？&quot;">发表评论？</a></p>
<h2 id="14-">14 条评论。</h2>
<ol>
<li><img src="" alt=""> <a href="http://heroicyang.com/" target="_blank">Heroic</a> <a href="">2013 年 1 月 27 日 在 下午 2:32</a></li>
</ol>
<p>如果采用内联，数据的同步更新方面怎么做呢？比如：User和Blog，Blog采用内联User的一些信息，以便在显示Blog列表时不用再去查询User。但是当User更新了昵称或头像等Blog内联的信息时，该怎么处理呢？需要更新内联信息吗？实时更新？延时更新？（应用的首页就是加载Blog列表）
<a href="http://www.yankay.com/nosql-anti-pattern-document/?replytocom=4583#respond" target="_blank">回复</a></p>
<ol>
<li><img src="" alt=""> <a href="http://heroicyang.com/" target="_blank">Heroic</a> <a href="">2013 年 1 月 28 日 在 上午 12:05</a></li>
</ol>
<p>想请教一下关于内联设计的数据同步更新问题。比如User和Blog，Blog文档中内联一个简单的User信息结构，如用户名、昵称、头像，以便在首页加载所有的Blog列表时不用再查询User。那如果User的信息更新了该怎么处理呢？是同时更新到Blog的内联文档，还是延时更新？或者说不更新？
<a href="http://www.yankay.com/nosql-anti-pattern-document/?replytocom=4591#respond" target="_blank">回复</a></p>
<ul>
<li><img src="" alt=""> 颜开 <a href="">2013 年 2 月 13 日 在 下午 7:33</a></li>
</ul>
<p>如果会导致<strong>重复数据</strong>就不建立这样内联，可以内联UserID。除非当使用UserID的时候，性能会差到不可以接受。这个时候可以考虑延迟更新，不更新之类的更复杂的设计。
<a href="http://www.yankay.com/nosql-anti-pattern-document/?replytocom=4665#respond" target="_blank">回复</a></p>
<ul>
<li><img src="" alt=""> vincent <a href="">2013 年 1 月 28 日 在 上午 9:30</a></li>
</ul>
<p>我们项目中用到了mongodb和redis,HBase的确是大象兵,一般公司养不起,mongodb应该更好的利用array或称list,但发现我们还是存在一个问题:使用关系数据库的思想去设计mongodb结构...
<a href="http://www.yankay.com/nosql-anti-pattern-document/?replytocom=4594#respond" target="_blank">回复</a></p>
<ul>
<li><img src="" alt=""> Filix <a href="">2013 年 3 月 17 日 在 下午 10:39</a></li>
</ul>
<p>关系模型最大的优点就是，在关系不变的情况下可以适应以后各种需求。
所以，我觉得在mongodb的模型设计中，采用关系模型并不是什么坏事。
文中作者也提到了，各种内嵌式设计都只是对当前问题的解决方法。当我们的需求变化时，蛋疼的事就来了。</p>
<p>所以，我是墙头草，两种设计结合比较好。
<a href="http://www.yankay.com/nosql-anti-pattern-document/?replytocom=5087#respond" target="_blank">回复</a></p>
<ul>
<li><img src="" alt=""> clarkorz <a href="">2013 年 2 月 14 日 在 上午 11:41</a></li>
</ul>
<p>内容不错，但我有很多疑问。因为每个反模式只交代了问题，没有交代场景，所以我觉得解决方案对不上。比如反模式一的问题一，关系表的存在肯定是个问题，但是解决该问题的方案要看是什么场景。例如一个可能的场景是“用户点击author浏览该autor发布的blog文章（含内容）分页展示每页10条”，此时用你给出的解决方案只能得到该author发布的所有blog文章的bolg_id，要达到取得10个文章内容的目的，还要再去blog集合中查询1次（或10次）。这个场景我认为把user_id放在blog文档里更合适（甚至可以把user的name、email等重要且不易变的信息也一同放进blog文档里）。这就变成了问题二，必须在blog集合中为user_id增加索引，按照你对问题二的解决方案，把blog_id放在user文档里，只查一次db也只能取得用户信息和一堆blog_id，要取得blog内容还是要再查db。而且，没有经过压力测试也不好说给user_id增加索引会引起多大的性能问题，如果在可接受范围内那也没问题。
所以我觉得就我给出的场景来说，问题二可以不必解决。有必要把和user关联的blog_id及comment_id都放进user文档里的场景，我暂时还没有想到，如果你有例子可以举一个么？：）
<a href="http://www.yankay.com/nosql-anti-pattern-document/?replytocom=4668#respond" target="_blank">回复</a></p>
<ul>
<li><img src="" alt=""> 颜开 <a href="">2013 年 2 月 16 日 在 下午 12:49</a></li>
</ul>
<p>谢谢你的留言。
你说的对。对于问题二，我觉得除了加一个索引外，还有一个可能的隐患是分区的困难。因为这张表需要按blog_id,user_id查询，而分区的时候只能选择一个Key。
您觉得呢？
<a href="http://www.yankay.com/nosql-anti-pattern-document/?replytocom=4673#respond" target="_blank">回复</a></p>
<ul>
<li><img src="" alt=""> 颜开 <a href="">2013 年 2 月 16 日 在 下午 1:09</a></li>
</ul>
<p>的确，在场景不够明晰的环境下，这些问题之间甚至会自相冲突。我也觉得把blog_id，comment_id都放在user里的场景是很少的。
<a href="http://www.yankay.com/nosql-anti-pattern-document/?replytocom=4674#respond" target="_blank">回复</a></p>
<ul>
<li><img src="" alt=""> Cloud <a href="">2013 年 2 月 22 日 在 上午 4:15</a></li>
</ul>
<p>我感觉对于内联内容的更新问题，可以只内联不需要更新的部分，比如用户名称，这种基本不会经常变化的。或者内联用户头像，发表过的评论不随用户profile更新头像，这样还可以让用户想起来自己当时发表评论时使用的头像，这在一些社交网络中会有不错的效果，不过见仁见智了。
<a href="http://www.yankay.com/nosql-anti-pattern-document/?replytocom=4690#respond" target="_blank">回复</a></p>
<ul>
<li><img src="" alt=""> <a href="http://larry-wang.com/" target="_blank">Larry</a> <a href="">2013 年 4 月 15 日 在 下午 3:54</a></li>
</ul>
<p>从王信文的博客上看到你的链接。呵呵，写的很好。我是王小龙，有空交换个链接，嘿嘿。
<a href="http://www.yankay.com/nosql-anti-pattern-document/?replytocom=5648#respond" target="_blank">回复</a></p>
<ul>
<li><img src="" alt=""> 颜开 <a href="">2013 年 5 月 2 日 在 下午 9:23</a></li>
</ul>
<p>好啊
<a href="http://www.yankay.com/nosql-anti-pattern-document/?replytocom=5892#respond" target="_blank">回复</a></p>
<ul>
<li><a href="http://www.xp500.com/Software/multimedia/onlinetv/13002.html" target="_blank">电视棒</a> - trackback on 2013 年 5 月 20 日 在 下午 10:35</li>
<li><a href="http://www.xhfz.net/thread-2843-1-1.html" target="_blank">苹果电视棒</a> - trackback on 2013 年 6 月 13 日 在 下午 12:21</li>
<li><a href="http://www.ryands.net/?p=182" target="_blank">NoSQL反模式 – 文档数据库篇 - RYAN 大叔</a> - pingback on 2013 年 6 月 29 日 在 上午 10:37<h3 id="-">发表评论 <a href="">取消回复</a></h3>
</li>
</ul>
<p>昵称</p>
<p>邮箱</p>
<p>网址</p>
<p><a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a> <a href=""><img src="" alt=""></a></p>
<p>注意 - 你可以用以下 HTML tags and attributes:</p>
<p><a href="" title=""> <abbr title=""> <acronym title=""> <b> <blockquote cite=""> <cite> <code> <del datetime=""> <em> <i> <q cite=""> <strike> <strong></p>
<h3 id="trackbacks-and-pingbacks-">Trackbacks and Pingbacks:</h3>
<ul>
<li><a href="http://www.xp500.com/Software/multimedia/onlinetv/13002.html" target="_blank">电视棒</a> - Trackback on 2013/05/20/ 22:35</li>
<li><a href="http://www.xhfz.net/thread-2843-1-1.html" target="_blank">苹果电视棒</a> - Trackback on 2013/06/13/ 12:21</li>
<li><a href="http://www.ryands.net/?p=182" target="_blank">NoSQL反模式 – 文档数据库篇 - RYAN 大叔</a> - Pingback on 2013/06/29/ 10:37
<a href="http://www.yankay.com/feed/" title="RSS 订阅" target="_blank">RSS 订阅</a> <a href="http://weibo.com/yankaycom" title="微博" target="_blank">微博</a></li>
</ul>
<h3 id="-">近期文章</h3>
<ul>
<li><a href="http://www.yankay.com/scala-tour-choiceness/" title="Scala Tour - 精选" target="_blank">Scala Tour - 精选</a></li>
<li><a href="http://www.yankay.com/nosql-anti-pattern-document/" title="NoSQL反模式 - 文档数据库篇" target="_blank">NoSQL反模式 - 文档数据库篇</a></li>
<li><a href="http://www.yankay.com/2012%e5%b9%b4%e5%ad%a6%e4%b9%a0%e5%b0%8f%e7%bb%93/" title="2012年学习小结" target="_blank">2012年学习小结</a></li>
<li><a href="http://www.yankay.com/go-clear-concurreny/" title="Go-简洁的并发" target="_blank">Go-简洁的并发</a></li>
<li><a href="http://www.yankay.com/google-spanner%e5%8e%9f%e7%90%86-%e5%85%a8%e7%90%83%e7%ba%a7%e7%9a%84%e5%88%86%e5%b8%83%e5%bc%8f%e6%95%b0%e6%8d%ae%e5%ba%93/" title="Google Spanner原理- 全球级的分布式数据库" target="_blank">Google Spanner原理- 全球级的分布式数据库</a></li>
<li><a href="http://www.yankay.com/google-dremel-rationale/" title="Google Dremel 原理 - 如何能3秒分析1PB" target="_blank">Google Dremel 原理 - 如何能3秒分析1PB</a></li>
<li><a href="http://www.yankay.com/java-fast-byte-comparison/" title="Java使用&quot;指针&quot;快速比较字节" target="_blank">Java使用&quot;指针&quot;快速比较字节</a></li>
<li><a href="http://www.yankay.com/hbase-slider/" title="HBase介绍PPT" target="_blank">HBase介绍PPT</a></li>
<li><a href="http://www.yankay.com/amazon-ebs%e6%9e%b6%e6%9e%84%e7%8c%9c%e6%83%b3/" title="Amazon EBS架构猜想" target="_blank">Amazon EBS架构猜想</a></li>
<li><a href="http://www.yankay.com/linux%e5%a4%a7%e6%96%87%e4%bb%b6%e4%bc%a0%e8%be%93/" title="Linux大文件传输" target="_blank">Linux大文件传输</a></li>
</ul>
<h3 id="-">标签</h3>
<p><a href="http://www.yankay.com/tag/android/" title="1 个话题" target="_blank">Android</a> <a href="http://www.yankay.com/tag/apache/" title="1 个话题" target="_blank">apache</a> <a href="http://www.yankay.com/tag/arch/" title="1 个话题" target="_blank">arch</a> <a href="http://www.yankay.com/tag/bigtable/" title="1 个话题" target="_blank">BigTable</a> <a href="http://www.yankay.com/tag/common-cloud/" title="1 个话题" target="_blank">Common Cloud</a> <a href="http://www.yankay.com/tag/eclipse/" title="2 个话题" target="_blank">eclipse</a> <a href="http://www.yankay.com/tag/facebook/" title="2 个话题" target="_blank">Facebook</a> <a href="http://www.yankay.com/tag/friendmap/" title="1 个话题" target="_blank">FriendMap</a> <a href="http://www.yankay.com/tag/gae/" title="3 个话题" target="_blank">Gae</a> <a href="http://www.yankay.com/tag/gaes/" title="5 个话题" target="_blank">GaeS</a> <a href="http://www.yankay.com/tag/gaevfs/" title="1 个话题" target="_blank">GaeVfs</a> <a href="http://www.yankay.com/tag/gdp/" title="1 个话题" target="_blank">GDP</a> <a href="http://www.yankay.com/tag/ggg/" title="1 个话题" target="_blank">GGG</a> <a href="http://www.yankay.com/tag/giant-global-graph/" title="1 个话题" target="_blank">Giant Global Graph</a> <a href="http://www.yankay.com/tag/google-reader/" title="1 个话题" target="_blank">Google Reader</a> <a href="http://www.yankay.com/tag/google-reader-play/" title="1 个话题" target="_blank">Google Reader Play</a> <a href="http://www.yankay.com/tag/hadoop/" title="2 个话题" target="_blank">Hadoop</a> <a href="http://www.yankay.com/tag/hbase/" title="2 个话题" target="_blank">Hbase</a> <a href="http://www.yankay.com/tag/html5/" title="2 个话题" target="_blank">HTML5</a> <a href="http://www.yankay.com/tag/java/" title="4 个话题" target="_blank">Java</a> <a href="http://www.yankay.com/tag/jpa2-0/" title="1 个话题" target="_blank">JPA2.0</a> <a href="http://www.yankay.com/tag/jsa4j/" title="2 个话题" target="_blank">Jsa4j</a> <a href="http://www.yankay.com/tag/latex/" title="2 个话题" target="_blank">latex</a> <a href="http://www.yankay.com/tag/linux/" title="2 个话题" target="_blank">Linux</a> <a href="http://www.yankay.com/tag/maven/" title="1 个话题" target="_blank">maven</a> <a href="http://www.yankay.com/tag/nosql/" title="5 个话题" target="_blank">NoSQL</a> <a href="http://www.yankay.com/tag/tortoisehg/" title="2 个话题" target="_blank">TortoiseHg</a> <a href="http://www.yankay.com/tag/ubuntu/" title="2 个话题" target="_blank">Ubuntu</a> <a href="http://www.yankay.com/tag/%e4%b8%ad%e6%96%87/" title="2 个话题" target="_blank">中文</a> <a href="http://www.yankay.com/tag/%e4%b8%ad%e7%a7%91%e6%9d%af/" title="1 个话题" target="_blank">中科杯</a> <a href="http://www.yankay.com/tag/%e4%b9%b1%e7%a0%81/" title="2 个话题" target="_blank">乱码</a> <a href="http://www.yankay.com/tag/%e4%bc%98%e5%8c%96/" title="2 个话题" target="_blank">优化</a> <a href="http://www.yankay.com/tag/%e5%8a%a8%e6%80%81%e8%a7%84%e5%88%92/" title="1 个话题" target="_blank">动态规划</a> <a href="http://www.yankay.com/tag/%e5%90%8c%e5%ad%a6/" title="1 个话题" target="_blank">同学</a> <a href="http://www.yankay.com/tag/%e5%9b%be%e4%b9%a6%e9%a6%86/" title="1 个话题" target="_blank">图书馆</a> <a href="http://www.yankay.com/tag/%e5%9c%a8%e6%b0%b4%e6%bb%a9/" title="1 个话题" target="_blank">在水滩</a> <a href="http://www.yankay.com/tag/%e6%95%b0%e6%8d%ae%e5%ba%93/" title="1 个话题" target="_blank">数据库</a> <a href="http://www.yankay.com/tag/%e6%96%87%e4%bb%b6/" title="1 个话题" target="_blank">文件</a> <a href="http://www.yankay.com/tag/%e6%a8%a1%e6%9d%bf/" title="1 个话题" target="_blank">模板</a> <a href="http://www.yankay.com/tag/%e6%b1%9f%e8%8b%8f%e6%9d%af/" title="1 个话题" target="_blank">江苏杯</a> <a href="http://www.yankay.com/tag/%e7%9f%a5%e8%af%86%e5%9b%be/" title="1 个话题" target="_blank">知识图</a> <a href="http://www.yankay.com/tag/%e7%ab%8b%e5%bf%97/" title="1 个话题" target="_blank">立志</a> <a href="http://www.yankay.com/tag/%e7%bb%b4%e5%9f%ba%e7%99%be%e7%a7%91/" title="1 个话题" target="_blank">维基百科</a> <a href="http://www.yankay.com/tag/%e8%a7%86%e9%a2%91/" title="1 个话题" target="_blank">视频</a> <a href="http://www.yankay.com/tag/%e9%85%92/" title="1 个话题" target="_blank">酒</a></p>
<h3 id="-">我的应用</h3>
<ul>
<li><a href="http://zh.scala-tour.com/" title="精彩的Scala之旅" target="_blank">Scala Tour</a></li>
<li><a href="http://weibagua.cloudfoundry.com/" target="_blank">趣味应用-微八卦</a></li>
</ul>
<h3 id="-">相关组织</h3>
<ul>
<li><a href="http://qing.weibo.com/emclabschina" title="EMC中国研究院" target="_blank">EMC中国研究院</a></li>
<li><p><a href="http://blog.nosqlfan.com/" target="_blank">nosqlfan</a></p>
<h3 id="-">友情链接</h3>
</li>
<li><p><a href="http://laynepeng.cloudfoundry.com/" target="_blank">Layne Peng的博客</a></p>
</li>
<li><a href="http://www.iiira.com/" target="_blank">爱陶</a></li>
<li><a href="http://larry-wang.com/" target="_blank">王小龙的博客</a></li>
<li><a href="http://loveharbor.net/" target="_blank">高晟</a>
版权所有 © 2013 我自然 | Powered by <a href="http://wordpress.org/" target="_blank">WordPress</a> and <a href="http://zww.me/" target="_blank">zBench</a>
↑ <a href="&quot;Back to top&quot;">回到顶部</a></li>
</ul>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Nosql/">Nosql</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Nosql/" class="label label-primary">Nosql</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:31"datetime="2014-03-07 09:54:31"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-Nosql--NoSQL反模式–文档数据库篇/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-Nosql--NoSQL反模式–文档数据库篇" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>





<ul id="pagination" class="pagination pagination-lg">
  <li><a class="extend prev" href="/page/138/">&laquo;</a></li><li><a class="page-number" href="/">1</a></li><li><a class="page-number" href="/page/2/">2</a></li><li><span class="space">&hellip;</span></li><li><a class="page-number" href="/page/136/">136</a></li><li><a class="page-number" href="/page/137/">137</a></li><li><a class="page-number" href="/page/138/">138</a></li><li class="active"><li><span class="page-number current">139</span></li><li><a class="page-number" href="/page/140/">140</a></li><li><a class="page-number" href="/page/141/">141</a></li><li><a class="page-number" href="/page/142/">142</a></li><li><span class="space">&hellip;</span></li></li><li><a class="page-number" href="/page/164/">164</a></li><li><a class="page-number" href="/page/165/">165</a></li><li><a class="extend next" href="/page/140/">&raquo;</a></li>
  <div class="clearfix"></div>
</ul></div><!--wapper-->
       </div><!-- ID main-col END -->
       <aside id="sidebar" class="alignright col-sx-6 col-sm-4 col-md-3 col-lg-3">
<div id="widget_search" class="widget panel panel-primary">
    <form action="//google.com/search" method="get" accept-charset="utf-8">
  <div class="input-group">
    <input class="form-control" id="searchbox" type="search" name="q" results="0" placeholder="search">
    <span class="input-group-btn">
      <button class="btn btn-default" type="submit">Go!</button>
    </span>
    <input type="hidden" name="q" value="site:itsolife.com">
  </div>
</form>
</div>

<div id="widget_category" class="widget panel panel-primary">
  <div class="panel-heading">category</div>  <div data-src='category' class='ajax_widgets'>正在加载...</div>
</div>

<div id="widget_recent_posts" class="widget panel panel-primary">
  <div class="panel-heading">recent posts</div>  <div data-src='recent_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_tagcloud" class="widget panel panel-primary">
  <div class="panel-heading">tagcloud</div>  <div data-src='tagcloud' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_latest_update_posts" class="widget panel panel-primary">
  <div class="panel-heading">最近更新</div>  <div data-src='latest_update_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_recent_comments" class="widget panel panel-primary">
  <div class="panel-heading">recent comments</div>  

<div class="list-group-item ds-recent-comments" data-num-items="6" data-show-avatars="1" data-show-time="1" data-show-title="1" data-show-admin="1" data-excerpt-length="50"></div>



</div>

</aside>
       <div class="clearfix"></div>
     </div><!-- row END -->
  </div>
  <footer id="footer" class="container">
  <div class="panel panel-info">
  <section id='footer_widget'></section>  <div class="panel-footer">
  <div id="site-info">
    <span class='author'>
  
  &copy; 2014 RobinChia
  
    &nbsp;&nbsp;</span>
  
  <span id='analytics-51la'></span><span id='analytics-google'>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-48559895-1']);
  _gaq.push(['_trackPageview']);
  _js2load.push({src:('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'});
</script></span><span id='analytics-cnzz'>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_5774006'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s17.cnzz.com/stat.php%3Fid%3D5774006%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</span><span id='analytics-baidu'>
<script>
var _hmt = _hmt || [];
_js2load.push({src:"//hm.baidu.com/hm.js?1442f50724afc42380b51f097c43082c"});
</script>
</span>  </div>
  <div id="copyright">Blog powered by <a href='http://zespia.tw/hexo/'><strong>hexo</strong></a> Theme <strong><a href='https://github.com/chenall/hexo-theme-chenall'>chenall</a></strong>(Some change in it)<span class="pull-right"> 更新时间: <em>2014-03-15 16:43:40</em></span></div>
</div>
<div class="clearfix"></div>


  </div>
  </footer>
  
        <script src="http://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>        
        <script src="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>        
                
        <script src="http://cdn.bootcss.com/prettify/r298/prettify.min.js"></script>    <script type="text/javascript">
   var lang=["bsh", "c", "cc", "cpp", "cs", "csh", "cyc", "cv", "htm", "html",
    "java", "js", "m", "mxml", "perl", "pl", "pm", "py", "rb", "sh",
    "xhtml", "xml", "xsl"];
   var pretty_base='';
   $('script').each(function(){
	var c = $(this).attr('src');
	if (!c)
	    return;
	if (c.match(/(\/)?prettify(\.min)?\.js/i))
	{
	    var index = c.lastIndexOf('/');
	    if (index != -1)
		pretty_base = c.substr(0,index + 1);
	    return false;
	}
   })
   $('pre code').each(function(){
	var c = $(this).attr('class')
	if (!c)
	    return;
	c = c.match(/\s?(lang\-\w+)/i);
	if (c && lang.indexOf(c[1]) == -1)
	{
	    lang.push(c[1]);
	    $.getScript(pretty_base + c[1] + '.min.js');
	}
   })

    $(window).load(function(){
       $("pre").addClass("prettyprint");
       prettyPrint();
    })
</script>    
            <script type="text/javascript">
var duoshuoQuery = {short_name:"robinchia"};
_js2load.push({src:'http://static.duoshuo.com/embed.js',charset:'UTF-8'});
</script>
    
            <!--wumii_relatedItems-->
    
        <script src="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>    <script type="text/javascript">
(function($){
  $('.entry').each(function(i){
    $(this).find('img').each(function(){
      var alt = this.alt;

      if (alt){
        $(this).before('<span class="caption">' + alt + '</span>');
      }

      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="fancybox' + i + '" />');
    });
  });

  $('.fancybox').fancybox();
})(jQuery);
</script>    
        <script src="http://cdn.bootcss.com/mathjax/2.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>
    
<script type="text/javascript">
$('.ajax_widgets').each(function(){var src=$(this).attr('data-src');if(src)$(this).load('/widgets/'+src+'.html');});
$.each(_js2load,function(index,obj){loadjs(obj.src,obj.charset)});
</script>

<div id="scroll2top">
<img src="/scroll2top/arrow.png"/>
</div>
<script src="/scroll2top/scroll2top.min.js"></script>
<div id="winterland">
  <canvas></canvas>
</div>
<script src="/js/winterland.min.js"></script>

  </body>
</html>
