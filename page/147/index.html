
<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>The 147 Page | It so life</title>
<meta name="author" content="RobinChia">

<meta name="description" content="It so life">


<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta property="og:site_name" content="It so life"/>

<!--[if IE]><style>.testIE.IE{display:inline;}</style><![endif]-->
<!--[if lte IE 7]><link rel="stylesheet" href="/css/ie7.css" type="text/css"><![endif]-->
<!--[if (lt IE 9)&(gt IE 7)]><style>.testIE.IE8{display:inline;}</style><![endif]-->
<!--[if gt IE 8]><style>.testIE.IE9{display:inline;}</style><![endif]-->

<link href="/favicon.png" rel="icon">
<link rel="alternate" href="/atom.xml" title="It so life Feed" type="application/atom+xml">

<link rel="stylesheet" href="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/font-awesome/4.0.3/css/font-awesome.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/prettify/r298/prettify.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" type="text/css">
<link rel="stylesheet" href="/css/style.css" type="text/css">
<!--[if lt IE 9]>
   <style>article,aside,dialog,footer,header,section,footer,nav,figure,menu{display:block}</style>
   <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
   <script src="http://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
<link href="http://cdn.staticfile.org/respond.js/1.4.2/respond-proxy.html" id="respond-proxy" rel="respond-proxy" />
<link href="/js/respond.proxy.gif" id="respond-redirect" rel="respond-redirect" />
<script src="/js/respond.proxy.js"></script>
   <script src="http://cdn.bootcss.com/selectivizr/1.0.2/selectivizr-min.js"></script>
<![endif]-->
<script type="text/javascript">
function loadjs(c,d){var a=document.createElement("script");a.async=!0;a.type="text/javascript";a.src=c;a.charset=d||"gbk";(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(a)};
var _protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
var _js2load = [];
</script>

</head>
<body>
      <header id="header" class="container"><nav id="main-nav" class="navbar navbar-default navbar-fixed-top " role="navigation">
  <div class="container">
    <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/">It so life</a>
    </div>
    <div  class="collapse navbar-collapse">
      <ul  class="nav navbar-nav">
  
        <li><a href="/" title="Home">Home</a></li>      
        <li><a href="/about/" title="About">About</a></li>      
        <li><a href="/archives/" title="Archives">Archives</a></li>      
      <li class='dropdown'>
        <a class='dropdown-toggle' data-toggle='dropdown' href='#'>website<b class='caret'></b></a>
        <ul class='dropdown-menu pure-menu-selected'>
    
          <li><a href="//groups.google.com/forum/#!forum/pongba" title="TopLanguage">TopLanguage</a></li>    
          <li><a href="//itpub.net/" title="ITPub">ITPub</a></li>    
          <li><a href="//blog.jobbole.com/" title="Bole">Bole</a></li>    
          <li><a href="//nosql-database.org/" title="nosql">nosql</a></li>    
          <li><a href="//gitimmersion.googol.im/" title="Git">Git</a></li>    
        </ul>
      </li>
    
      </ul>
      <ul class="nav navbar-nav navbar-right">
      
        <li><a href="/atom.xml">RSS</a></li>
      
      
        <li><a href="https://twitter.com/robinchia">twitter</a></li>
      
      
      
      
        <li><a href="https://github.com/robinchia">github</a></li>
      
      </ul>
    </div>
  </div>
</nav>
<div class="clearfix"></div>
</header>
  <div id='content' class="container">
     <div class="page-header-wrapper">
      <!--[if lt IE 9]><div class="alert alert-warning alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>提示:</strong>您的浏览器版本太低了,建议升级到 <strong><a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" title="IE9">IE9</a></strong> 以上,本站使用<a href="https://www.google.com/intl/zh-CN/chrome/">Chrome浏览器</a>可以获得最好的显示效果.</div><![endif]-->
      <div class="page-header"><h1 align="center"><big>It so life</big> </h1>
        <h5 align="center"><big>love as life</big></h5>
      </div>
     </div>
     <div class="row">
       <div id="main-col" class="alignleft col-sx-12 col-sm-8 col-md-9 col-lg-9">
      <section id='header_widget'></section>
          <div id="wrapper"><article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-架构师-架构--Twitter架构图cache篇–Tim后端技术/">Twitter架构图(cache篇) – Tim[后端技术]</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:29.000Z"> <a href="/2014/02/02/2014-02-02-架构师-架构--Twitter架构图cache篇–Tim后端技术/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="twitter-cache-tim-">Twitter架构图(cache篇) – Tim[后端技术]</h1>
<h1 id="-tim-http-timyang-net-home-"><a href="http://timyang.net/" title="Home" target="_blank">Tim[后端技术]</a></h1>
<p>Tim&#39;s blog, 关于后端架构、互联网技术、分布式、大型网络应用、NoSQL、技术感悟等</p>
<p><a href="http://timyang.net/" target="_blank">Home</a> | <a href="http://timyang.net/about/" target="_blank">About</a> | <a href="http://timyang.net/tag/English/" target="_blank">English version</a> | <a href="http://timyang.net/about/#comment" target="_blank">留言(Guestbook)</a> | <a href="http://timyang.net/feed/" target="_blank"><img src="" alt=""></a><a href="http://timyang.net/feed/" target="_blank">订阅RSS</a> <a href="http://fusion.google.com/add?source=atgs&amp;feedurl=http%3A//timyang.net/feed/" target="_blank"><img src="" alt="Add to Google"></a></p>
<ul>
<li></li>
<li><p>Email: <img src="" alt=""></p>
</li>
<li><h3 id="similar-posts">Similar Posts</h3>
</li>
<li><p><a href="http://timyang.net/architecture/notes-timelines-twitter/" title="May 3, 2012" target="_blank">Notes about Timelines @ Twitter</a></p>
</li>
<li><a href="http://timyang.net/tech/twitter-whale/" title="March 8, 2010" target="_blank">Twitter“鲸鱼”故障技术剖析</a></li>
<li><a href="http://timyang.net/data/mcdb-tt-redis/" title="August 11, 2009" target="_blank">MemcacheDB, Tokyo Tyrant, Redis performance test</a></li>
<li><a href="http://timyang.net/architecture/farmville/" title="March 8, 2010" target="_blank">FarmVille(美版开心农场)谈架构:所有模块都是一个可降级的服务</a></li>
<li><p><a href="http://timyang.net/tech/twitter-operations/" title="November 2, 2009" target="_blank">Twitter系统运维经验</a></p>
</li>
<li><h3 id="most-commented">Most Commented</h3>
</li>
<li><p><a href="http://timyang.net/data/mcdb-tt-redis/" title="MemcacheDB, Tokyo Tyrant, Redis performance test" target="_blank">MemcacheDB, Tokyo Tyrant, Redis performance test</a> (101)</p>
</li>
<li><a href="http://timyang.net/programming/c-erlang-java-performance/" title="C, Erlang, Java and Go Web Server performance test" target="_blank">C, Erlang, Java and Go Web Server performance test</a> (85)</li>
<li><a href="http://timyang.net/about/" title="About Tim Yang" target="_blank">About Tim Yang</a> (83)</li>
<li><a href="http://timyang.net/data/redis-misunderstanding/" title="Redis几个认识误区" target="_blank">Redis几个认识误区</a> (62)</li>
<li><a href="http://timyang.net/programming/memcache-mutex/" title="Memcache mutex设计模式" target="_blank">Memcache mutex设计模式</a> (47)</li>
<li><a href="http://timyang.net/architecture/microblog-design-qcon-beijing/" title="构建可扩展的微博架构(qcon beijing 2010演讲)" target="_blank">构建可扩展的微博架构(qcon beijing 2010演讲)</a> (39)</li>
<li><a href="http://timyang.net/architecture/consistent-hashing-practice/" title="某分布式应用实践一致性哈希的一些问题" target="_blank">某分布式应用实践一致性哈希的一些问题</a> (38)</li>
<li><a href="http://timyang.net/google/open-source/" title="为什么优秀开发者进入Google后就不参与开源了" target="_blank">为什么优秀开发者进入Google后就不参与开源了</a> (33)</li>
<li><a href="http://timyang.net/misc/macbook-air-productive/" title="MacBook Air与工作效率" target="_blank">MacBook Air与工作效率</a> (32)</li>
<li><p><a href="http://timyang.net/data/memcached-lru-evictions/" title="Memcached数据被踢(evictions&gt;0)现象分析" target="_blank">Memcached数据被踢(evictions&gt;0)现象分析</a> (30)</p>
</li>
<li><h3 id="recent-posts">Recent Posts</h3>
</li>
<li><p><a href="http://timyang.net/tao/speech-practice/" title="演讲小组的第一次活动" target="_blank">演讲小组的第一次活动</a></p>
</li>
<li><a href="http://timyang.net/tao/connect-the-dots/" title="“connect the dots” 随想" target="_blank">“connect the dots” 随想</a></li>
<li><a href="http://timyang.net/tao/talents/" title="跨领域人才" target="_blank">跨领域人才</a></li>
<li><a href="http://timyang.net/product/discontinued-servic/" title="产品下线杂谈" target="_blank">产品下线杂谈</a></li>
<li><a href="http://timyang.net/misc/speech/" title="当我谈演讲时候，我谈些什么" target="_blank">当我谈演讲时候，我谈些什么</a></li>
<li><a href="http://timyang.net/architecture/k/" title="案例与故障的知识库" target="_blank">案例与故障的知识库</a></li>
<li><a href="http://timyang.net/management/learning-tao/" title="团队中的为师之道" target="_blank">团队中的为师之道</a></li>
<li><a href="http://timyang.net/google/hybrid-research/" title="有感Google的混合研究方法" target="_blank">有感Google的混合研究方法</a></li>
<li><a href="http://timyang.net/management/probation/" title="谈技术人员“转正”" target="_blank">谈技术人员“转正”</a></li>
<li><a href="http://timyang.net/architecture/notes-weixin/" title="微信架构的启示" target="_blank">微信架构的启示</a></li>
<li><a href="http://timyang.net/misc/macbook-air-productive/" title="MacBook Air与工作效率" target="_blank">MacBook Air与工作效率</a></li>
<li><a href="http://timyang.net/architecture/notes-timelines-twitter/" title="Notes about Timelines @ Twitter" target="_blank">Notes about Timelines @ Twitter</a></li>
<li><a href="http://timyang.net/management/engineer-performance/" title="技术工程师的能力与目标" target="_blank">技术工程师的能力与目标</a></li>
<li><a href="http://timyang.net/management/design-review/" title="技术方案评审" target="_blank">技术方案评审</a></li>
<li><p><a href="http://timyang.net/management/planning/" title="谈技术团队目标" target="_blank">谈技术团队目标</a></p>
</li>
<li><h3 id="recent-comments">Recent Comments</h3>
</li>
<li><p><a href="http://emake.info/the-redis-several-misunderstandings.html" target="_blank">Redis几个认识误区 | 创造</a> on <a href="http://timyang.net/data/redis-misunderstanding/comment-page-2/#comment-224409" target="_blank">Redis几个认识误区</a></p>
</li>
<li><a href="http://emake.info/the-redis-several-misunderstandings.html" target="_blank">Redis几个认识误区 | 创造</a> on <a href="http://timyang.net/data/mcdb-tt-redis/comment-page-3/#comment-224408" target="_blank">MemcacheDB, Tokyo Tyrant, Redis performance test</a></li>
<li><a href="http://outofmemory.cn/" target="_blank">甄码农</a> on <a href="http://timyang.net/management/learning-tao/comment-page-1/#comment-224161" target="_blank">团队中的为师之道</a></li>
<li><a href="http://outofmemory.cn/" target="_blank">甄码农</a> on <a href="http://timyang.net/tao/talents/comment-page-1/#comment-224158" target="_blank">跨领域人才</a></li>
<li><p>阿秀 on <a href="http://timyang.net/about/comment-page-2/#comment-223584" target="_blank">About Tim Yang</a></p>
</li>
<li><h3 id="categories">Categories</h3>
</li>
<li><p><a href="http://timyang.net/category/data/" title="View all posts filed under data" target="_blank">data</a></p>
</li>
<li><a href="http://timyang.net/category/erlang/" title="Erlang语言" target="_blank">Erlang</a></li>
<li><a href="http://timyang.net/category/google/" title="View all posts filed under Google" target="_blank">Google</a></li>
<li><a href="http://timyang.net/category/java/" title="View all posts filed under Java" target="_blank">Java</a></li>
<li><a href="http://timyang.net/category/linux/" title="View all posts filed under Linux" target="_blank">Linux</a></li>
<li><a href="http://timyang.net/category/lua/" title="View all posts filed under Lua" target="_blank">Lua</a></li>
<li><a href="http://timyang.net/category/python/" title="View all posts filed under Python" target="_blank">Python</a></li>
<li><a href="http://timyang.net/category/sns/" title="View all posts filed under SNS" target="_blank">SNS</a></li>
<li><a href="http://timyang.net/category/tech/" title="View all posts filed under tech" target="_blank">tech</a></li>
<li><a href="http://timyang.net/category/web/" title="View all posts filed under Web" target="_blank">Web</a></li>
<li><a href="http://timyang.net/category/product/" title="View all posts filed under 产品" target="_blank">产品</a></li>
<li><a href="http://timyang.net/category/distributed/" title="分布式算法及思想" target="_blank">分布式</a></li>
<li><a href="http://timyang.net/category/management/" title="View all posts filed under 技术管理" target="_blank">技术管理</a></li>
<li><a href="http://timyang.net/category/architecture/" title="后端架构" target="_blank">架构</a></li>
<li><a href="http://timyang.net/category/programming/" title="View all posts filed under 编程" target="_blank">编程</a></li>
<li><a href="http://timyang.net/category/tao/" title="View all posts filed under 随想" target="_blank">随想</a></li>
<li><p><a href="http://timyang.net/category/misc/" title="非技术话题" target="_blank">非技术</a></p>
</li>
<li><h3 id="archives">Archives</h3>
</li>
<li><p><a href="http://timyang.net/2012/10/" title="October 2012" target="_blank">October 2012</a> (5)</p>
</li>
<li><a href="http://timyang.net/2012/09/" title="September 2012" target="_blank">September 2012</a> (4)</li>
<li><a href="http://timyang.net/2012/05/" title="May 2012" target="_blank">May 2012</a> (3)</li>
<li><a href="http://timyang.net/2012/02/" title="February 2012" target="_blank">February 2012</a> (3)</li>
<li><a href="http://timyang.net/2012/01/" title="January 2012" target="_blank">January 2012</a> (2)</li>
<li><a href="http://timyang.net/2011/12/" title="December 2011" target="_blank">December 2011</a> (1)</li>
<li><a href="http://timyang.net/2011/08/" title="August 2011" target="_blank">August 2011</a> (1)</li>
<li><a href="http://timyang.net/2011/07/" title="July 2011" target="_blank">July 2011</a> (1)</li>
<li><a href="http://timyang.net/2011/04/" title="April 2011" target="_blank">April 2011</a> (2)</li>
<li><a href="http://timyang.net/2011/02/" title="February 2011" target="_blank">February 2011</a> (1)</li>
<li><a href="http://timyang.net/2011/01/" title="January 2011" target="_blank">January 2011</a> (2)</li>
<li><a href="http://timyang.net/2010/12/" title="December 2010" target="_blank">December 2010</a> (2)</li>
<li><a href="http://timyang.net/2010/11/" title="November 2010" target="_blank">November 2010</a> (2)</li>
<li><a href="http://timyang.net/2010/09/" title="September 2010" target="_blank">September 2010</a> (1)</li>
<li><a href="http://timyang.net/2010/08/" title="August 2010" target="_blank">August 2010</a> (1)</li>
<li><a href="http://timyang.net/2010/07/" title="July 2010" target="_blank">July 2010</a> (3)</li>
<li><a href="http://timyang.net/2010/06/" title="June 2010" target="_blank">June 2010</a> (2)</li>
<li><a href="http://timyang.net/2010/05/" title="May 2010" target="_blank">May 2010</a> (2)</li>
<li><a href="http://timyang.net/2010/04/" title="April 2010" target="_blank">April 2010</a> (1)</li>
<li><a href="http://timyang.net/2010/03/" title="March 2010" target="_blank">March 2010</a> (4)</li>
<li><a href="http://timyang.net/2010/02/" title="February 2010" target="_blank">February 2010</a> (1)</li>
<li><a href="http://timyang.net/2010/01/" title="January 2010" target="_blank">January 2010</a> (1)</li>
<li><a href="http://timyang.net/2009/12/" title="December 2009" target="_blank">December 2009</a> (3)</li>
<li><a href="http://timyang.net/2009/11/" title="November 2009" target="_blank">November 2009</a> (3)</li>
<li><a href="http://timyang.net/2009/10/" title="October 2009" target="_blank">October 2009</a> (3)</li>
<li><a href="http://timyang.net/2009/09/" title="September 2009" target="_blank">September 2009</a> (4)</li>
<li><a href="http://timyang.net/2009/08/" title="August 2009" target="_blank">August 2009</a> (5)</li>
<li><a href="http://timyang.net/2009/07/" title="July 2009" target="_blank">July 2009</a> (6)</li>
<li><a href="http://timyang.net/2009/06/" title="June 2009" target="_blank">June 2009</a> (5)</li>
<li><a href="http://timyang.net/2009/05/" title="May 2009" target="_blank">May 2009</a> (11)</li>
<li><a href="http://timyang.net/2009/04/" title="April 2009" target="_blank">April 2009</a> (7)</li>
<li><a href="http://timyang.net/2009/03/" title="March 2009" target="_blank">March 2009</a> (3)</li>
<li><a href="http://timyang.net/2009/02/" title="February 2009" target="_blank">February 2009</a> (2)</li>
<li><a href="http://timyang.net/2009/01/" title="January 2009" target="_blank">January 2009</a> (2)</li>
<li><a href="http://timyang.net/2008/12/" title="December 2008" target="_blank">December 2008</a> (2)</li>
<li><h3 id="feeds">Feeds</h3>
</li>
<li><p><a href="http://timyang.net/feed/" target="_blank">Entries (RSS)</a></p>
</li>
<li><a href="http://timyang.net/comments/feed/" target="_blank">Comments (RSS)</a>
*</li>
</ul>
<h2 id="-twitter-cache-http-timyang-net-architecture-twitter-cache-architecture-permanent-link-to-twitter-cache-"><a href="http://timyang.net/architecture/twitter-cache-architecture/" title="Permanent Link to Twitter架构图(cache篇)" target="_blank">Twitter架构图(cache篇)</a></h2>
<p>Wednesday, Oct 28th, 2009 by Tim | Tags: <a href="http://timyang.net/tag/twitter/" target="_blank">twitter</a></p>
<p>根据网上公开资料整理的Twitter架构，主要是cache方面，加了作者自己的补充，跟实际的架构未必完全一致。
<img src="&quot;twitter cache&quot;" alt="twitter cache">
一些数据：</p>
<ul>
<li>Cache分Page cache, fragment cache, row cache, vector Cache, cache命中率见图。</li>
<li>Fragment cache存放了API各种请求格式的数据，包括XML, JSON, RSS, ATOM。</li>
<li>发表Tweets是先放入Kestrel, 再异步处理，Kestrel用的也是memcached协议。</li>
<li>API requests: 550 r/s。</li>
<li>POST tweets: 峰值：平时 80tweets/s, 奥巴马就任时达到 350tweets/s。</li>
<li>Aggregator模块需要访问memcached multi get  数百个/s。</li>
<li>Ruby on Rails前面还用了Varnish作前端反向代理。</li>
</ul>
<p>参考资料：</p>
<ul>
<li><a href="http://gojko.net/2009/03/16/qcon-london-2009-upgrading-twitter-without-service-disruptions/" target="_blank">QCon London 2009: Upgrading Twitter without service disruptions</a></li>
<li><a href="http://qconlondon.com/london-2009/file?path=/qcon-london-2009/slides/EvanWeaver_ImprovingRunningComponentsAtTwitter.pdf" target="_blank">Improving Running Components at Twitter</a> (PDF slide)</li>
</ul>
<h3 id="9-comments-http-timyang-net-architecture-twitter-cache-architecture-postcomment-jump-to-the-comments-form-">9 Comments <a href="http://timyang.net/architecture/twitter-cache-architecture/#postcomment" title="Jump to the comments form" target="_blank">»</a></h3>
<ol>
<li><img src="" alt="">Lee Su Min says:</li>
</ol>
<p><a href="http://timyang.net/architecture/twitter-cache-architecture/comment-page-1/#comment-2070" target="_blank">Nov 1st 2009 at 17:15</a></p>
<p>Is a blue print same as a jia gou tu?</p>
<ol>
<li><img src="" alt=""><a href="http://hi.baidu.com/crazy_computer" target="_blank">王潇</a> says:</li>
</ol>
<p><a href="http://timyang.net/architecture/twitter-cache-architecture/comment-page-1/#comment-3405" target="_blank">Mar 8th 2010 at 18:10</a></p>
<p>我是一个大三的学生，现在在学习PHP！看了您的博客，学习一下，也就只是看看表面，现在对整个的WEB体系有了一定的了解了，但是我还是不太清晰！请您指点一下，我还不清楚现在所做的东西处于什么地方，对整个系统有什么影响？我开发网站时也都没用到您所做的东西啊，究竟何时用！还有就是究竟应该按照什么线路来学习技术，请您务必指教！！！</p>
<ol>
<li><img src="" alt=""><a href="http://blog.chinaunix.net/u2/84280" target="_blank">遥方</a> says:</li>
</ol>
<p><a href="http://timyang.net/architecture/twitter-cache-architecture/comment-page-1/#comment-4367" target="_blank">Jun 25th 2010 at 16:42</a></p>
<p>博主能力很强。向你学习</p>
<ol>
<li><img src="" alt=""><a href="http://www.wangdacuo.com/" target="_blank">小黑</a> says:</li>
</ol>
<p><a href="http://timyang.net/architecture/twitter-cache-architecture/comment-page-1/#comment-4940" target="_blank">Sep 11th 2010 at 22:25</a></p>
<p>请问像这样实时性强、数据量巨大的数据库应该做哪些优化和处理？</p>
<ol>
<li><img src="" alt=""><a href="http://apan.me/" target="_blank">Pan</a> says:</li>
</ol>
<p><a href="http://timyang.net/architecture/twitter-cache-architecture/comment-page-1/#comment-29611" target="_blank">May 21st 2011 at 12:50</a></p>
<p>Row Cache是否有些出入？图中Row Cache似乎是用来存储关系链的，而Evan Weaver在2009 London Qcon上的ppt中，显示Row Cache应该是用来缓存tweet正文内容的吧。<a href="http://qconlondon.com/dl/qcon-london-2009/slides/EvanWeaver_ImprovingRunningComponentsAtTwitter.pdf" target="_blank">http://qconlondon.com/dl/qcon-london-2009/slides/EvanWeaver_ImprovingRunningComponentsAtTwitter.pdf</a></p>
<ol>
<li><img src="" alt=""><a href="http://tsingroo.sinaapp.com/" target="_blank">罗青</a> says:</li>
</ol>
<p><a href="http://timyang.net/architecture/twitter-cache-architecture/comment-page-1/#comment-124260" target="_blank">Jan 17th 2012 at 12:53</a></p>
<p>我觉得除了缓存之外，数据库的表设计是最关键的部分。架构这些什么的都要依据数据库结构来设计。</p>
<ol>
<li><img src="" alt="">段见尼宜 says:</li>
</ol>
<p><a href="http://timyang.net/architecture/twitter-cache-architecture/comment-page-1/#comment-220186" target="_blank">Nov 7th 2012 at 06:43</a></p>
<p>(网站打不开请点百度快照}手机号码任意显示|号码任意显示|去电号码任意显示|来电号码任意显示|号码随意显|电话号码任意显示|手机号码随意显|电话号码随意显|
手机号码任意显示 (可以免费测试一次)
鹏诚通讯科技有限公司
24小时客服QQ：13417527</p>
<p>24小时免费咨询电话：18268787444</p>
<p>公司网址：<a href="http://www.pcwltx.com/" target="_blank">http://www.pcwltx.com/</a>
朋友,想不想让你的手机很有个性? 明明你在深圳,而你跟朋友聊天的时候,你朋友的电话上显示你在广州(上 海/天津/武汉/兰州等)以至香港. 明明你在跟朋友玩,而你打电话给你家人,让家人以为你在外地出差. 明天你不是刘德华,而你总是你用刘德华的电话号在打电话 明明你现在在内地,而你非要在你朋友面前说你在香港. 想不想拥有了?</p>
<p>专业手机，座机，小灵通等打电话发短信可以任意显示电话号码的, 此产品不需要下载任何软件,只需要绑定您的号码即可实现显示.您要对方显示什么号码!我这里免费给您测试,让您亲眼所见！不想让别人知道自己在哪里的时候，被人追踪讨债不接您电话的时候很有用出的！您只需花上几百元钱就能买到您想要的任何靓号，吉祥号！以及港澳台和国际号码，任意显示您的电话号码，随时隐藏您的号码！
本业务不会影响你本手机的使用，想使用改号业务时就拨一下我们系统的预约号码，不想使用时就直接用你手机打出还是原来的号，不会改变你手机原来的实际号码，互不干扰.</p>
<p>为防止各种违法乱纪,本软件特定设置号码规范如下：
1、出于安全考虑国家特殊号码 110 120 119等号码，不可以随意设置，
一经发现删除该帐户！
2、不可以设置各种银行，移动的客服号码（95599 10086等）一经发现删除该帐户！</p>
<p>交易方式：支持各大银行和淘宝交易.</p>
<p>1， 无须在电话（手机，小灵通，座机）上下载任何软件
2， 无月租，无长途漫游费，全国号码任意设置，任意拨打，任意显示。0.2元/分钟
3， 绑定号码无次数限制，设置显示号码无次数限制。自行操作，自己做主，
4， 开通后没有时效限制，有话费即可使用。
5， 话费没了，续费继续使用。
6， 不影响你本机号码的话费，和正常使用，两者互不干扰。
7， 双方都为接电话型式，不扣通话双方的电话（手机，小灵通，座机）话费。
8，不想使用时就直接用你手机打出还是原来的号，不会改变你手机原来的实际号码，互不干扰.
显示号码自己设置，操作方法可以手机直接操作也可以网页上操作最后都是通过自己的手机打出，
让对方显示你要的号码，本机是接回拨所以免费,显示号码自由设置
可以让你亲自测试，自己打出一个任意显示的电话。
交易方式：支持各大银行和淘宝交易.</p>
<p>24小时客服QQ：13417527</p>
<p>24小时免费咨询电话：18268781444</p>
<p>公司网址：<a href="http://www.pcwltx.com/" target="_blank">http://www.pcwltx.com/</a>
骗子各种手法介绍：不允许测试，让你直接汇款，汇款后开通。</p>
<p><a href="http://timyang.net/architecture/twitter-cache-architecture/feed/" target="_blank">RSS feed for comments on this post</a>, <a href="http://timyang.net/architecture/twitter-cache-architecture/trackback/" target="_blank">TrackBack URI</a>
<a href="http://timyang.net/architecture/twitter-cache-architecture/#respond" target="_blank">Cancel Reply</a></p>
<h3 id="leave-a-comment">Leave a Comment</h3>
<p>Name (required)</p>
<p>E-mail (required, never displayed)</p>
<p>URI</p>
<p>Except where otherwise noted, content on this site is licensed under a <a href="http://creativecommons.org/licenses/by/3.0/" target="_blank">Creative Commons Attribution 3.0</a> License</p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/架构师/">架构师</a></li></span><span class="breadcrumb"><li><a href="/categories/架构师/">架构师</a></li><li><a href="/categories/架构师/架构/">架构</a></li></span></span> | <span class="tags">Tagged <a href="/tags/架构/" class="label label-primary">架构</a><a href="/tags/架构师/" class="label label-success">架构师</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:29"datetime="2014-03-07 09:54:29"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-架构师-架构--Twitter架构图cache篇–Tim后端技术/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-架构师-架构--Twitter架构图cache篇–Tim后端技术" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-架构师-架构--YouTube架构学习体会-IT青藤屋-青藤园/">YouTube架构学习体会 </a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:29.000Z"> <a href="/2014/02/02/2014-02-02-架构师-架构--YouTube架构学习体会-IT青藤屋-青藤园/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="youtube-it-">YouTube架构学习体会 - IT青藤屋 - 青藤园</h1>
<p><a href="http://www.itivy.com/ivy/archive/2011/3/6/634350416046298451.html#main-copy" target="_blank">Skip to main content.</a></p>
<h1 id="-it-http-www-itivy-com-ivy-"><a href="http://www.itivy.com/ivy" target="_blank">IT青藤屋</a></h1>
<p>Article date: 关注架构、关注前端、关注生活，愿天下的程序员像常青藤一样绿意盎然、自强不息
Navigation:</p>
<ul>
<li><a href="http://www.itivy.com/" target="_blank">青藤园首页</a></li>
<li><a href="http://www.itivy.com/ivy" target="_blank">首页</a></li>
<li><a href="http://www.itivy.com/ivy/Rss" target="_blank">订阅</a></li>
<li><a href="http://www.itivy.com/MyAdmin/Post" target="_blank">写博客</a><h1 id="-">公告</h1>
</li>
</ul>
<p>今天让我感到了知识产权对作者的重要性，博客中的文章如果没有特殊说明，均为原创或者翻译，转载请注明原文出处。另外，在我博客中的一些文章，或许有意无意侵犯了您的知识产权，如果您发现了，请及时发邮件联系我，我将立即作出处理。我的邮箱：</p>
<p>sxwgf.com@gmail.com</p>
<p>谢谢！</p>
<p><a href="http://feed.feedsky.com/wangguofeng" target="_blank"><img src="" alt="feedsky"></a>
<a href="http://www.zhuaxia.com/add_channel.php?url=http://feed.feedsky.com/wangguofeng" target="_blank"><img src="" alt="抓虾"></a> <a href="http://fusion.google.com/add?feedurl=http://feed.feedsky.com/wangguofeng" target="_blank"><img src="" alt="google reader"></a> <a href="http://www.netvibes.com/subscribe.php?url=http://feed.feedsky.com/wangguofeng" target="_blank"><img src="" alt="netvibes"></a> <a href="http://www.xianguo.com/subscribe.php?url=http://feed.feedsky.com/wangguofeng" target="_blank"><img src="" alt="鲜果"></a> <a href="http://reader.youdao.com/b.do?keyfrom=feedsky&amp;url=http://feed.feedsky.com/wangguofeng" target="_blank"><img src="" alt="有道"></a> <a href="http://mail.qq.com/cgi-bin/feed?u=http://feed.feedsky.com/wangguofeng" target="_blank"><img src="" alt="QQ邮箱"></a></p>
<p>如果能成为巨人，我愿意献出肩膀
<a href="http://www.itivy.com/ivy" target="_blank">王国峰</a>       2011年毕业于     <a href="http://www.cjlu.edu.cn/">中国计量学院
</a></p>
<p><a href="http://www.cnblogs.com/sxwgf" target="_blank">我的博客园</a>     <a href="mailto:sxwgf.com@gmail.com">Email联系我</a></p>
<h1 id="-">文章分类</h1>
<ul>
<li><a href="http://www.itivy.com/ivy/rss/634334857626039072" target="_blank">(rss)</a><a href="http://www.itivy.com/ivy/category/634334857626039072" target="_blank">网站架构 (57)</a></li>
<li><a href="http://www.itivy.com/ivy/rss/634341473485624363" target="_blank">(rss)</a><a href="http://www.itivy.com/ivy/category/634341473485624363" target="_blank">程序人生 (46)</a></li>
<li><a href="http://www.itivy.com/ivy/rss/634344865065808132" target="_blank">(rss)</a><a href="http://www.itivy.com/ivy/category/634344865065808132" target="_blank">Web前端 (64)</a></li>
<li><a href="http://www.itivy.com/ivy/rss/634373775058504208" target="_blank">(rss)</a><a href="http://www.itivy.com/ivy/category/634373775058504208" target="_blank">云计算 (5)</a></li>
<li><a href="http://www.itivy.com/ivy/rss/634420334988588647" target="_blank">(rss)</a><a href="http://www.itivy.com/ivy/category/634420334988588647" target="_blank">交互设计 (36)</a></li>
<li><a href="http://www.itivy.com/ivy/rss/634676846231486688" target="_blank">(rss)</a><a href="http://www.itivy.com/ivy/category/634676846231486688" target="_blank">其他 (13)</a></li>
<li><a href="http://www.itivy.com/ivy/rss/634676846436695587" target="_blank">(rss)</a><a href="http://www.itivy.com/ivy/category/634676846436695587" target="_blank">个人日记 (5)</a></li>
<li><a href="http://www.itivy.com/ivy/rss/634412348539180312" target="_blank">(rss)</a><a href="http://www.itivy.com/ivy/category/634412348539180312" target="_blank">互联网资讯 (54)</a></li>
<li><a href="http://www.itivy.com/ivy/rss/634395014757871203" target="_blank">(rss)</a><a href="http://www.itivy.com/ivy/category/634395014757871203" target="_blank">数据库 (5)</a></li>
<li><a href="http://www.itivy.com/ivy/rss/634428901658822055" target="_blank">(rss)</a><a href="http://www.itivy.com/ivy/category/634428901658822055" target="_blank">Javascript游戏 (22)</a></li>
<li><a href="http://www.itivy.com/ivy/rss/634329522769715132" target="_blank">(rss)</a><a href="http://www.itivy.com/ivy/category/634329522769715132" target="_blank">.NET技术 (23)</a></li>
<li><a href="http://www.itivy.com/ivy/rss/634329522944214971" target="_blank">(rss)</a><a href="http://www.itivy.com/ivy/category/634329522944214971" target="_blank">jQuery插件 (35)</a></li>
<li><a href="http://www.itivy.com/ivy/rss/634331340966127746" target="_blank">(rss)</a><a href="http://www.itivy.com/ivy/category/634331340966127746" target="_blank">设计模式 (4)</a><h1 id="-">搜索</h1>
</li>
</ul>
<h1 id="-">文章归档</h1>
<ul>
<li><a href="http://www.itivy.com/ivy/archive/2012/4" target="_blank">2012年4月 (1)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2012/3" target="_blank">2012年3月 (6)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2012/2" target="_blank">2012年2月 (12)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2012/1" target="_blank">2012年1月 (21)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/12" target="_blank">2011年12月 (19)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/11" target="_blank">2011年11月 (38)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/10" target="_blank">2011年10月 (29)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/9" target="_blank">2011年9月 (18)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/8" target="_blank">2011年8月 (36)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/7" target="_blank">2011年7月 (38)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/6" target="_blank">2011年6月 (69)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/5" target="_blank">2011年5月 (28)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/4" target="_blank">2011年4月 (14)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/3" target="_blank">2011年3月 (36)</a></li>
<li><p><a href="http://www.itivy.com/ivy/archive/2011/2" target="_blank">2011年2月 (26)</a></p>
<h1 id="-">最新评论</h1>
</li>
<li><p><a href="http://www.itivy.com/ivy/archive/2012/3/21/talk-about-cookie-security.html#635024174735802860" target="_blank">COOKIES如今很多浏览器都比较讨厌。</a></p>
</li>
<li><a href="http://www.itivy.com/ivy/archive/2012/3/29/jquery-rotate3di-3d-rotate.html#635024172890545000" target="_blank">这个效果还是不错的，比较适合一些大的文章站。</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/6/4/jquery-flot-chinese-doc.html#635019834501840539" target="_blank">很好的东西，正在看</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2012/1/16/css-shape.html#635013628113327522" target="_blank">果断收藏</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2012/3/29/jquery-rotate3di-3d-rotate.html#635005778757226060" target="_blank">我以为你说的是rotate3Di的原理呢。。。</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2012/2/18/image-storage-cache-1.html#635005777013789343" target="_blank">还有就是用又拍云存储或者阿里云的话可以提升各地用户访问的速度</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2012/2/18/image-storage-cache-1.html#635005775941923653" target="_blank">图片服务器和web服务器分离还有一个好处就是用户上传的带有代...</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/6/4/jquery-flot-chinese-doc.html#635005773508750000" target="_blank">博主翻译的真辛苦！</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2012/1/4/flash-js-css-nav.html#635000165409091711" target="_blank">这个滑动菜单有个BUG，index.html中&lt;ahe...</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2012/3/18/gogo6-ipv6.html#634980862642912518" target="_blank">我怎么连接失败呢  </a></li>
</ul>
<h1 id="-">阅读排行</h1>
<ul>
<li><a href="http://www.itivy.com/ivy/archive/2011/3/7/634351294385186067.html" target="_blank">Flickr 网站架构分析(12957)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2012/3/18/gogo6-ipv6.html" target="_blank">我是如何用IPV6快速“翻墙”的(12156)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/3/7/634351257301504864.html" target="_blank">回顾MySpace架构的坎坷之路(11723)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/8/13/the-architecture-of-youku.html" target="_blank">优酷网架构学习笔记(10581)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/3/5/634349627089221280.html" target="_blank">PlentyOfFish.com .NET网站的又一传奇(8971)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/6/4/best-10-flash-website-of-2011.html" target="_blank">分享10个2011最佳flash网站(8533)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/2/26/634343492754434530.html" target="_blank">30个基于jQuery的日期时间选择插件(8475)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/2/24/634341508379645903.html" target="_blank">45个非常漂亮的jQuery导航插件(7540)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/6/4/jquery-flot-chinese-doc.html" target="_blank">jQuery图表插件Flot中文文档(7136)</a></li>
<li><p><a href="http://www.itivy.com/ivy/archive/2012/1/16/css-shape.html" target="_blank">纯CSS画的基本图形（矩形、圆形、三角形、多边形、爱心、八卦等），NB么(6932)</a></p>
<h1 id="-">评论排行</h1>
</li>
<li><p><a href="http://www.itivy.com/ivy/archive/2011/11/25/how-i-become-a-programmer-in-12-weeks.html" target="_blank">我是如何在12周内由零基础成为一名程序员的(22)</a></p>
</li>
<li><a href="http://www.itivy.com/ivy/archive/2011/3/1/634345857534732714.html" target="_blank">漫画：为什么搞计算机工作的人总是看上去很清闲(10)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/3/7/634351294385186067.html" target="_blank">Flickr 网站架构分析(8)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/12/25/just-love-you.html" target="_blank">因为喜欢，仅此而已(8)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/8/13/the-architecture-of-youku.html" target="_blank">优酷网架构学习笔记(7)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/12/21/let-us-fk-csdn-together.html" target="_blank">我们是该告CSDN还是FK了CSDN？(7)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2012/3/12/where-is-our-copyright-in-china.html" target="_blank">在中国，我们的知识产权真的陨落了吗？(7)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2012/2/16/image-storage-1.html" target="_blank">图片存储架构学习：独立的图片服务器，给爱一个独立的空间(6)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2011/8/17/the-20-jquery-table-plugins.html" target="_blank">20个jquery表格插件(5)</a></li>
<li><a href="http://www.itivy.com/ivy/archive/2012/1/16/css-shape.html" target="_blank">纯CSS画的基本图形（矩形、圆形、三角形、多边形、爱心、八卦等），NB么(5)</a></li>
</ul>
<h1 id="-">我的书屋</h1>
<p><a href="http://www.ppurl.com/2010/02/clr-via-csharp-third-edition.html" target="_blank"><img src="" alt=""></a>        <a href="http://www.ppurl.com/2010/08/rework.html" target="_blank"><img src="" alt=""></a></p>
<h1 id="-">友情链接</h1>
<ul>
<li><a href="http://www.itivy.com/klvoek" target="_blank">klvoek（温金鹿）</a></li>
<li><a href="http://ninofocus.com/" target="_blank">NinoFocus（倪朱国）</a></li>
<li><a href="http://www.itivy.com/android" target="_blank">Android Studio</a></li>
<li><a href="http://www.itivy.com/jquery" target="_blank">jQuery资源宝库</a></li>
<li><a href="http://www.itivy.com/php" target="_blank">php开发园地</a></li>
<li><a href="http://www.ppurl.com/" target="_blank">皮皮书屋（一个很好的电子书网站）</a></li>
<li><a href="http://zazhi.itivy.com/android" target="_blank">Android开发者</a></li>
</ul>
<h1 id="-youtube-"><a href="">YouTube架构学习体会</a></h1>
<p>这几天一直在关注和学习一些大型网站的架构，希望有一天自己也能设计一个高并发、高容错的系统并能应用在实践上。今天在网上找架构相关的资料时，看到一个被和谐的视频网站YouTube的架构分析，看了以后觉得自己又向架构走近了一步，于是赶快拿出来与大家一起分享。</p>
<p>YouTube发展迅速，每天超过1亿的视频点击量，但只有很少人在维护站点和确保伸缩性。这点和PlentyOfFish类似，少数人维护庞大系统。是什么原因呢？放心绝对不是靠人品，也不是靠寂寞，下面就来看看YouTube的整体技术架构吧。</p>
<p><strong>平台</strong></p>
<hr>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
<strong>Apache</p>
<p>Python
Linux(SuSe)</p>
<p>MySQL
psyco，一个动态的Python到C的编译器</p>
<p>lighttpd代替Apache做视频查看</strong></p>
<p><strong>状态</strong></p>
<hr>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
<strong>支持每天超过1亿的视频点击量</p>
<p>成立于2005年2月
于2006年3月达到每天3千万的视频点击量</p>
<p>于2006年7月达到每天1亿的视频点击量
2个系统管理员，2个伸缩性软件架构师</p>
<p>2个软件开发工程师，2个网络工程师，1个DBA</strong></p>
<p><strong>Web服务器</strong></p>
<hr>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12
13</p>
<p>14
15<strong>1，NetScaler用于负载均衡和静态内容缓存</p>
<p>2，使用mod_fast_cgi运行Apache
3，使用一个Python应用服务器来处理请求的路由</p>
<p>4，应用服务器与多个数据库和其他信息源交互来获取数据和格式化html页面
5，一般可以通过添加更多的机器来在Web层提高伸缩性</p>
<p>6，Python的Web层代码通常不是性能瓶颈，大部分时间阻塞在RPC
7，Python允许快速而灵活的开发和部署</p>
<p>8，通常每个页面服务少于100毫秒的时间
9，使用psyco(一个类似于JIT编译器的动态的Python到C的编译器)来优化内部循环</p>
<p>10，对于像加密等密集型CPU活动，使用C扩展
11，对于一些开销昂贵的块使用预先生成并缓存的html</p>
<p>12，数据库里使用行级缓存
13，缓存完整的Python对象</p>
<p>14，有些数据被计算出来并发送给各个程序，所以这些值缓存在本地内存中。这是个使用不当的策略。</p>
<p>应用服务器里最快的缓存将预先计算的值发送给所有服务器也花不了多少时间。只需弄一个代理来监听更改，预计算，然后发送。</strong></p>
<p><strong>视频服务</strong></p>
<hr>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12
13</p>
<p>14
15</p>
<p>16
17</p>
<p>18
<strong>1，花费包括带宽，硬件和能源消耗</p>
<p>2，每个视频由一个迷你集群来host，每个视频被超过一台机器持有
3，使用一个集群意味着：</p>
<p>-更多的硬盘来持有内容意味着更快的速度</p>
<p>-failover。如果一台机器出故障了，另外的机器可以继续服务</p>
<p>-在线备份
4，使用lighttpd作为Web服务器来提供视频服务：</p>
<p>-Apache开销太大</p>
<p>-使用epoll来等待多个fds</p>
<p>-从单进程配置转变为多进程配置来处理更多的连接
5，大部分流行的内容移到CDN：</p>
<p>-CDN在多个地方备份内容，这样内容离用户更近的机会就会更高</p>
<p>-CDN机器经常内存不足，因为内容太流行以致很少有内容进出内存的颠簸</p>
<p>6，不太流行的内容(每天1-20浏览次数)在许多colo站点使用YouTube服务器</p>
<p>-长尾效应。一个视频可以有多个播放，但是许多视频正在播放。随机硬盘块被访问</p>
<p>-在这种情况下缓存不会很好，所以花钱在更多的缓存上可能没太大意义。</p>
<p>-调节RAID控制并注意其他低级问题</p>
<p>-调节每台机器上的内存，不要太多也不要太少 </strong></p>
<p><strong>视频服务关键点</strong></p>
<p>1</p>
<p>2
3</p>
<p>4
51，保持简单和廉价</p>
<p>2，保持简单网络路径，在内容和用户间不要有太多设备
3，使用常用硬件，昂贵的硬件很难找到帮助文档</p>
<p>4，使用简单而常见的工具，使用构建在Linux里或之上的大部分工具
5，很好的处理随机查找(SATA，tweaks)缩略图服务</p>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12
13</p>
<p>14
15</p>
<p>16
171，做到高效令人惊奇的难</p>
<p>2，每个视频大概4张缩略图，所以缩略图比视频多很多
3，缩略图仅仅host在几个机器上</p>
<p>4，持有一些小东西所遇到的问题：</p>
<p>-OS级别的大量的硬盘查找和inode和页面缓存问题</p>
<p>-单目录文件限制，特别是Ext3，后来移到多分层的结构。内核2.6的最近改进可能让 Ext3允许大目录，但在一个文件系统里存储大量文件不是个好主意</p>
<p>-每秒大量的请求，因为Web页面可能在页面上显示60个缩略图</p>
<p>-在这种高负载下Apache表现的非常糟糕</p>
<p>-在Apache前端使用squid，这种方式工作了一段时间，但是由于负载继续增加而以失败告终。它让每秒300个请求变为20个</p>
<p>-尝试使用lighttpd但是由于使用单线程它陷于困境。遇到多进程的问题，因为它们各自保持自己单独的缓存</p>
<p>-如此多的图片以致一台新机器只能接管24小时</p>
<p>-重启机器需要6-10小时来缓存
5，为了解决所有这些问题YouTube开始使用Google的BigTable，一个分布式数据存储：</p>
<p>-避免小文件问题，因为它将文件收集到一起</p>
<p>-快，错误容忍</p>
<p>-更低的延迟，因为它使用分布式多级缓存，该缓存与多个不同collocation站点工作</p>
<p>-更多信息参考Google Architecture，GoogleTalk Architecture和BigTable</p>
<p>数据库</p>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12
13</p>
<p>14
15</p>
<p>16
171，早期</p>
<p>-使用MySQL来存储元数据，如用户，tags和描述</p>
<p>-使用一整个10硬盘的RAID 10来存储数据</p>
<p>-依赖于信用卡所以YouTube租用硬件</p>
<p>-YouTube经过一个常见的革命：单服务器，然后单master和多read slaves，然后数据库分区，然后sharding方式</p>
<p>-痛苦与备份延迟。master数据库是多线程的并且运行在一个大机器上所以它可以处理许多工作，slaves是单线程的并且通常运行在小一些的服务器上并且备份是异步的，所以slaves会远远落后于master</p>
<p>-更新引起缓存失效，硬盘的慢I/O导致慢备份</p>
<p>-使用备份架构需要花费大量的money来获得增加的写性能</p>
<p>-YouTube的一个解决方案是通过把数据分成两个集群来将传输分出优先次序：一个视频查看池和一个一般的集群</p>
<p>2，后期</p>
<p>-数据库分区</p>
<p>-分成shards，不同的用户指定到不同的shards</p>
<p>-扩散读写</p>
<p>-更好的缓存位置意味着更少的IO</p>
<p>-导致硬件减少30%</p>
<p>-备份延迟降低到0</p>
<p>-现在可以任意提升数据库的伸缩性数据中心策略</p>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
1，依赖于信用卡，所以最初只能使用受管主机提供商</p>
<p>2，受管主机提供商不能提供伸缩性，不能控制硬件或使用良好的网络协议
3，YouTube改为使用colocation arrangement。现在YouTube可以自定义所有东西并且协定自己的契约</p>
<p>4，使用5到6个数据中心加CDN
5，视频来自任意的数据中心，不是最近的匹配或其他什么。如果一个视频足够流行则移到CDN</p>
<p>6，依赖于视频带宽而不是真正的延迟。可以来自任何colo
7，图片延迟很严重，特别是当一个页面有60张图片时</p>
<p>8，使用BigTable将图片备份到不同的数据中心，代码查看谁是最近的学到的东西</p>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
111，Stall for time。创造性和风险性的技巧让你在短期内解决问题而同时你会发现长期的解决方案</p>
<p>2，Proioritize。找出你的服务中核心的东西并对你的资源分出优先级别
3，Pick your battles。别怕将你的核心服务分出去。YouTube使用CDN来分布它们最流行的内容。创建自己的网络将花费太多时间和太多money</p>
<p>4，Keep it simple！简单允许你更快的重新架构来回应问题
5，Shard。Sharding帮助隔离存储，CPU，内存和IO，不仅仅是获得更多的写性能</p>
<p>6，Constant iteration on bottlenecks：</p>
<p>-软件：DB，缓存</p>
<p>-OS：硬盘I/O</p>
<p>-硬件：内存，RAID</p>
<p>7，You succeed as a team。拥有一个跨越条律的了解整个系统并知道系统内部是什么样的团队，如安装打印机，安装机器，安装网络等等的人。</p>
<p>With a good team all things are possible。</p>
<p>分享到： <a href="&quot;分享到QQ空间&quot;">QQ空间</a> <a href="&quot;分享到新浪微博&quot;">新浪微博</a> <a href="&quot;分享到人人网&quot;">人人网</a> <a href="http://www.jiathis.com/share/" target="_blank">更多</a> <a href="">6</a>
标签： <a href="http://www.itivy.com/ivy/search?keyword=%e9%ab%98%e6%80%a7%e8%83%bd" target="_blank">高性能</a>, <a href="http://www.itivy.com/ivy/search?keyword=%e6%9e%b6%e6%9e%84" target="_blank">架构</a>, <a href="http://www.itivy.com/ivy/search?keyword=YouTube" target="_blank">YouTube</a>, <a href="http://www.itivy.com/ivy/search?keyword=%e8%a7%86%e9%a2%91" target="_blank">视频</a></p>
<p>Posted by <a href="http://www.itivy.com/ivy" target="_blank">ivy</a> @ 2011-3-6 20:53:24 <a href="">阅读</a>(6410) <a href="http://www.itivy.com/ivy/archive/2011/3/6/634350416046298451.html#comment" target="_blank">评论</a>(2)
上一篇：<a href="http://www.itivy.com/ivy/archive/2011/3/6/634350387821952102.html" target="_blank">【IE6.0 Bug总结之二】双倍边距(margin)的bug</a>
下一篇：<a href="http://www.itivy.com/ivy/archive/2011/3/7/634351127072679482.html" target="_blank">WikiPedia技术架构学习笔记</a></p>
<h3 id="feedback">Feedback</h3>
<ol>
<li><a href="">回复</a>  2011-10-28 14:45:36 by <a href="http://www.oustudy.com/" target="_blank">pc</a>
牛</li>
<li><a href="">回复</a>  2013-1-24 14:43:45 by <a href="http://www.bbkongs.com/" target="_blank">Godaddy 优惠码</a>
没图片看不懂啊
你还可以输入<em>600</em>/600个字符  发表评论</li>
</ol>
<p>称呼： (必填) <a href="http://passport.itivy.com/common/login?ReturnUrl=http%3a%2f%2fwww.itivy.com%2fivy%2farchive%2f2011%2f3%2f6%2f634350416046298451.html" target="_blank">登录</a> | <a href="http://passport.itivy.com/common/register" target="_blank">开通博客</a>
邮箱： (选填) 你的邮箱地址不会被公开</p>
<p>网站： (选填)
<a href="&quot;字体&quot;"></a><a href="&quot;文字大小&quot;"></a><a href="&quot;文字颜色&quot;"></a><a href="&quot;文字背景&quot;"></a><a href="&quot;粗体(Ctrl+B"></a>&quot;)<a href="&quot;斜体(Ctrl+I"></a>&quot;)<a href="&quot;下划线(Ctrl+U"></a>&quot;)<a href="&quot;删除格式&quot;"></a><a href="&quot;左对齐&quot;"></a><a href="&quot;居中&quot;"></a><a href="&quot;右对齐&quot;"></a><a href="&quot;编号&quot;"></a><a href="&quot;项目符号&quot;"></a><a href="&quot;插入表情&quot;"></a><a href="&quot;图片&quot;"></a><a href="&quot;超级链接&quot;"></a><a href="&quot;取消超级链接&quot;"></a></p>
<p>验证码： (必填)
<img src="" alt="看不清换一张"> <a href="">看不清楚换一张</a></p>
<p>Copyright © <a href="http://www.itivy.com/ivy" target="_blank">ivy</a> 2011 . Powered by 青藤园
Courtesy of <a href="http://www.openwebdesign.org/" target="_blank">Open Web Design</a> &amp; <a href="http://www.dubaiapartments.biz/hotels/" target="_blank">Hotels - Dubai</a>
<a href="http://tongji.baidu.com/hm-web/welcome/ico?s=add0db9dee36c7a9b64141788e26de72" target="_blank"><img src="" alt=""></a></p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/架构师/">架构师</a></li></span><span class="breadcrumb"><li><a href="/categories/架构师/">架构师</a></li><li><a href="/categories/架构师/架构/">架构</a></li></span></span> | <span class="tags">Tagged <a href="/tags/架构/" class="label label-primary">架构</a><a href="/tags/架构师/" class="label label-success">架构师</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:29"datetime="2014-03-07 09:54:29"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-架构师-架构--YouTube架构学习体会-IT青藤屋-青藤园/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-架构师-架构--YouTube架构学习体会-IT青藤屋-青藤园" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-架构师-架构--多IDC的数据分布设计一/">多IDC的数据分布设计(一)</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:29.000Z"> <a href="/2014/02/02/2014-02-02-架构师-架构--多IDC的数据分布设计一/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="-idc-">多IDC的数据分布设计(一)</h1>
<h1 id="-tim-http-timyang-net-home-"><a href="http://timyang.net/" title="Home" target="_blank">Tim[后端技术]</a></h1>
<p>Tim&#39;s blog, 关于后端架构、互联网技术、分布式、大型网络应用、NoSQL、技术感悟等</p>
<p><a href="http://timyang.net/" target="_blank">Home</a> | <a href="http://timyang.net/about/" target="_blank">About</a> | <a href="http://timyang.net/tag/English/" target="_blank">English version</a> | <a href="http://timyang.net/about/#comment" target="_blank">留言(Guestbook)</a> | <a href="http://timyang.net/feed/" target="_blank"><img src="" alt=""></a><a href="http://timyang.net/feed/" target="_blank">订阅RSS</a> <a href="http://fusion.google.com/add?source=atgs&amp;feedurl=http%3A//timyang.net/feed/" target="_blank"><img src="" alt="Add to Google"></a></p>
<ol>
<li></li>
</ol>
<ul>
<li><p>Email: <img src="" alt=""></p>
</li>
<li><h3 id="most-commented">Most Commented</h3>
</li>
<li><p><a href="http://timyang.net/data/mcdb-tt-redis/" title="MemcacheDB, Tokyo Tyrant, Redis performance test" target="_blank">MemcacheDB, Tokyo Tyrant, Redis performance test</a> (101)</p>
</li>
<li><a href="http://timyang.net/programming/c-erlang-java-performance/" title="C, Erlang, Java and Go Web Server performance test" target="_blank">C, Erlang, Java and Go Web Server performance test</a> (85)</li>
<li><a href="http://timyang.net/about/" title="About Tim Yang" target="_blank">About Tim Yang</a> (83)</li>
<li><a href="http://timyang.net/data/redis-misunderstanding/" title="Redis几个认识误区" target="_blank">Redis几个认识误区</a> (62)</li>
<li><a href="http://timyang.net/programming/memcache-mutex/" title="Memcache mutex设计模式" target="_blank">Memcache mutex设计模式</a> (47)</li>
<li><a href="http://timyang.net/architecture/microblog-design-qcon-beijing/" title="构建可扩展的微博架构(qcon beijing 2010演讲)" target="_blank">构建可扩展的微博架构(qcon beijing 2010演讲)</a> (39)</li>
<li><a href="http://timyang.net/architecture/consistent-hashing-practice/" title="某分布式应用实践一致性哈希的一些问题" target="_blank">某分布式应用实践一致性哈希的一些问题</a> (38)</li>
<li><a href="http://timyang.net/google/open-source/" title="为什么优秀开发者进入Google后就不参与开源了" target="_blank">为什么优秀开发者进入Google后就不参与开源了</a> (33)</li>
<li><a href="http://timyang.net/misc/macbook-air-productive/" title="MacBook Air与工作效率" target="_blank">MacBook Air与工作效率</a> (32)</li>
<li><p><a href="http://timyang.net/data/memcached-lru-evictions/" title="Memcached数据被踢(evictions&gt;0)现象分析" target="_blank">Memcached数据被踢(evictions&gt;0)现象分析</a> (30)</p>
</li>
<li><h3 id="recent-posts">Recent Posts</h3>
</li>
<li><p><a href="http://timyang.net/tao/speech-practice/" title="演讲小组的第一次活动" target="_blank">演讲小组的第一次活动</a></p>
</li>
<li><a href="http://timyang.net/tao/connect-the-dots/" title="“connect the dots” 随想" target="_blank">“connect the dots” 随想</a></li>
<li><a href="http://timyang.net/tao/talents/" title="跨领域人才" target="_blank">跨领域人才</a></li>
<li><a href="http://timyang.net/product/discontinued-servic/" title="产品下线杂谈" target="_blank">产品下线杂谈</a></li>
<li><a href="http://timyang.net/misc/speech/" title="当我谈演讲时候，我谈些什么" target="_blank">当我谈演讲时候，我谈些什么</a></li>
<li><a href="http://timyang.net/architecture/k/" title="案例与故障的知识库" target="_blank">案例与故障的知识库</a></li>
<li><a href="http://timyang.net/management/learning-tao/" title="团队中的为师之道" target="_blank">团队中的为师之道</a></li>
<li><a href="http://timyang.net/google/hybrid-research/" title="有感Google的混合研究方法" target="_blank">有感Google的混合研究方法</a></li>
<li><a href="http://timyang.net/management/probation/" title="谈技术人员“转正”" target="_blank">谈技术人员“转正”</a></li>
<li><a href="http://timyang.net/architecture/notes-weixin/" title="微信架构的启示" target="_blank">微信架构的启示</a></li>
<li><a href="http://timyang.net/misc/macbook-air-productive/" title="MacBook Air与工作效率" target="_blank">MacBook Air与工作效率</a></li>
<li><a href="http://timyang.net/architecture/notes-timelines-twitter/" title="Notes about Timelines @ Twitter" target="_blank">Notes about Timelines @ Twitter</a></li>
<li><a href="http://timyang.net/management/engineer-performance/" title="技术工程师的能力与目标" target="_blank">技术工程师的能力与目标</a></li>
<li><a href="http://timyang.net/management/design-review/" title="技术方案评审" target="_blank">技术方案评审</a></li>
<li><p><a href="http://timyang.net/management/planning/" title="谈技术团队目标" target="_blank">谈技术团队目标</a></p>
</li>
<li><h3 id="recent-comments">Recent Comments</h3>
</li>
<li><p><a href="http://emake.info/the-redis-several-misunderstandings.html" target="_blank">Redis几个认识误区 | 创造</a> on <a href="http://timyang.net/data/redis-misunderstanding/comment-page-2/#comment-224409" target="_blank">Redis几个认识误区</a></p>
</li>
<li><a href="http://emake.info/the-redis-several-misunderstandings.html" target="_blank">Redis几个认识误区 | 创造</a> on <a href="http://timyang.net/data/mcdb-tt-redis/comment-page-3/#comment-224408" target="_blank">MemcacheDB, Tokyo Tyrant, Redis performance test</a></li>
<li><a href="http://outofmemory.cn/" target="_blank">甄码农</a> on <a href="http://timyang.net/management/learning-tao/comment-page-1/#comment-224161" target="_blank">团队中的为师之道</a></li>
<li><a href="http://outofmemory.cn/" target="_blank">甄码农</a> on <a href="http://timyang.net/tao/talents/comment-page-1/#comment-224158" target="_blank">跨领域人才</a></li>
<li><p>阿秀 on <a href="http://timyang.net/about/comment-page-2/#comment-223584" target="_blank">About Tim Yang</a></p>
</li>
<li><h3 id="categories">Categories</h3>
</li>
<li><p><a href="http://timyang.net/category/data/" title="View all posts filed under data" target="_blank">data</a></p>
</li>
<li><a href="http://timyang.net/category/erlang/" title="Erlang语言" target="_blank">Erlang</a></li>
<li><a href="http://timyang.net/category/google/" title="View all posts filed under Google" target="_blank">Google</a></li>
<li><a href="http://timyang.net/category/java/" title="View all posts filed under Java" target="_blank">Java</a></li>
<li><a href="http://timyang.net/category/linux/" title="View all posts filed under Linux" target="_blank">Linux</a></li>
<li><a href="http://timyang.net/category/lua/" title="View all posts filed under Lua" target="_blank">Lua</a></li>
<li><a href="http://timyang.net/category/python/" title="View all posts filed under Python" target="_blank">Python</a></li>
<li><a href="http://timyang.net/category/sns/" title="View all posts filed under SNS" target="_blank">SNS</a></li>
<li><a href="http://timyang.net/category/tech/" title="View all posts filed under tech" target="_blank">tech</a></li>
<li><a href="http://timyang.net/category/web/" title="View all posts filed under Web" target="_blank">Web</a></li>
<li><a href="http://timyang.net/category/product/" title="View all posts filed under 产品" target="_blank">产品</a></li>
<li><a href="http://timyang.net/category/distributed/" title="分布式算法及思想" target="_blank">分布式</a></li>
<li><a href="http://timyang.net/category/management/" title="View all posts filed under 技术管理" target="_blank">技术管理</a></li>
<li><a href="http://timyang.net/category/architecture/" title="后端架构" target="_blank">架构</a></li>
<li><a href="http://timyang.net/category/programming/" title="View all posts filed under 编程" target="_blank">编程</a></li>
<li><a href="http://timyang.net/category/tao/" title="View all posts filed under 随想" target="_blank">随想</a></li>
<li><p><a href="http://timyang.net/category/misc/" title="非技术话题" target="_blank">非技术</a></p>
</li>
<li><h3 id="archives">Archives</h3>
</li>
<li><p><a href="http://timyang.net/2012/10/" title="October 2012" target="_blank">October 2012</a> (5)</p>
</li>
<li><a href="http://timyang.net/2012/09/" title="September 2012" target="_blank">September 2012</a> (4)</li>
<li><a href="http://timyang.net/2012/05/" title="May 2012" target="_blank">May 2012</a> (3)</li>
<li><a href="http://timyang.net/2012/02/" title="February 2012" target="_blank">February 2012</a> (3)</li>
<li><a href="http://timyang.net/2012/01/" title="January 2012" target="_blank">January 2012</a> (2)</li>
<li><a href="http://timyang.net/2011/12/" title="December 2011" target="_blank">December 2011</a> (1)</li>
<li><a href="http://timyang.net/2011/08/" title="August 2011" target="_blank">August 2011</a> (1)</li>
<li><a href="http://timyang.net/2011/07/" title="July 2011" target="_blank">July 2011</a> (1)</li>
<li><a href="http://timyang.net/2011/04/" title="April 2011" target="_blank">April 2011</a> (2)</li>
<li><a href="http://timyang.net/2011/02/" title="February 2011" target="_blank">February 2011</a> (1)</li>
<li><a href="http://timyang.net/2011/01/" title="January 2011" target="_blank">January 2011</a> (2)</li>
<li><a href="http://timyang.net/2010/12/" title="December 2010" target="_blank">December 2010</a> (2)</li>
<li><a href="http://timyang.net/2010/11/" title="November 2010" target="_blank">November 2010</a> (2)</li>
<li><a href="http://timyang.net/2010/09/" title="September 2010" target="_blank">September 2010</a> (1)</li>
<li><a href="http://timyang.net/2010/08/" title="August 2010" target="_blank">August 2010</a> (1)</li>
<li><a href="http://timyang.net/2010/07/" title="July 2010" target="_blank">July 2010</a> (3)</li>
<li><a href="http://timyang.net/2010/06/" title="June 2010" target="_blank">June 2010</a> (2)</li>
<li><a href="http://timyang.net/2010/05/" title="May 2010" target="_blank">May 2010</a> (2)</li>
<li><a href="http://timyang.net/2010/04/" title="April 2010" target="_blank">April 2010</a> (1)</li>
<li><a href="http://timyang.net/2010/03/" title="March 2010" target="_blank">March 2010</a> (4)</li>
<li><a href="http://timyang.net/2010/02/" title="February 2010" target="_blank">February 2010</a> (1)</li>
<li><a href="http://timyang.net/2010/01/" title="January 2010" target="_blank">January 2010</a> (1)</li>
<li><a href="http://timyang.net/2009/12/" title="December 2009" target="_blank">December 2009</a> (3)</li>
<li><a href="http://timyang.net/2009/11/" title="November 2009" target="_blank">November 2009</a> (3)</li>
<li><a href="http://timyang.net/2009/10/" title="October 2009" target="_blank">October 2009</a> (3)</li>
<li><a href="http://timyang.net/2009/09/" title="September 2009" target="_blank">September 2009</a> (4)</li>
<li><a href="http://timyang.net/2009/08/" title="August 2009" target="_blank">August 2009</a> (5)</li>
<li><a href="http://timyang.net/2009/07/" title="July 2009" target="_blank">July 2009</a> (6)</li>
<li><a href="http://timyang.net/2009/06/" title="June 2009" target="_blank">June 2009</a> (5)</li>
<li><a href="http://timyang.net/2009/05/" title="May 2009" target="_blank">May 2009</a> (11)</li>
<li><a href="http://timyang.net/2009/04/" title="April 2009" target="_blank">April 2009</a> (7)</li>
<li><a href="http://timyang.net/2009/03/" title="March 2009" target="_blank">March 2009</a> (3)</li>
<li><a href="http://timyang.net/2009/02/" title="February 2009" target="_blank">February 2009</a> (2)</li>
<li><a href="http://timyang.net/2009/01/" title="January 2009" target="_blank">January 2009</a> (2)</li>
<li><a href="http://timyang.net/2008/12/" title="December 2008" target="_blank">December 2008</a> (2)</li>
<li><h3 id="feeds">Feeds</h3>
</li>
<li><p><a href="http://timyang.net/feed/" target="_blank">Entries (RSS)</a></p>
</li>
<li><a href="http://timyang.net/comments/feed/" target="_blank">Comments (RSS)</a>
*</li>
</ul>
<h2 id="archive-for-the-category">Archive for the ‘分布式’ Category</h2>
<h2 id="-idc-http-timyang-net-distributed-multi-idc-consensus-permanent-link-to-idc-"><a href="http://timyang.net/distributed/multi-idc-consensus/" title="Permanent Link to 多IDC的数据分布设计(一)" target="_blank">多IDC的数据分布设计(一)</a></h2>
<p>Tuesday, Feb 2nd, 2010 by Tim | <strong><a href="http://timyang.net/distributed/multi-idc-consensus/#comments" target="_blank">13 Comments</a></strong>
Filed under: <a href="http://timyang.net/category/distributed/" title="View all posts in 分布式" target="_blank">分布式</a> | Tags: <a href="http://timyang.net/tag/2pc/" target="_blank">2PC</a>, <a href="http://timyang.net/tag/3pc/" target="_blank">3PC</a>, <a href="http://timyang.net/tag/consensus/" target="_blank">consensus</a>, <a href="http://timyang.net/tag/paxos/" target="_blank">paxos</a>, <a href="http://timyang.net/tag/three-phase-commit/" target="_blank">Three-phase commit</a>, <a href="http://timyang.net/tag/two-phase-commit/" target="_blank">Two-phase commit</a></p>
<p>上个月跟某个朋友谈及多IDC数据同时读写访问的问题(<a href="http://twitter.com/xmpp/status/7625866165" target="_blank">tweet</a>)，当时觉得有不少解决方案，但觉得思路还不够清晰。最近看了Google App Engine工程师Ryan Barrett介绍GAE后端数据服务的演讲稿<a href="http://snarfed.org/space/transactions_across_datacenters_io.html" target="_blank">Transactions Across Datacenters</a>(<a href="http://www.youtube.com/watch?v=srOgpXECblk" target="_blank">视频</a>)，用Ryan的方法来分析这个问题后就豁然开朗。</p>
<p>按Ryan的方法，多IDC实现有以下几种思路。</p>
<h2 id="-master-slave">一、Master/slave</h2>
<p>这个是多机房数据访问最常用的方案，一般的需求用此方案即可。因此大家也经常提到“premature optimization is the root of all evil”。
<strong>优点：</strong>利用mysql replication即可实现，成熟稳定。
<strong>缺点：</strong>写操作存在单点故障，master坏掉之后slave不能写。另外slave的延迟也是个困扰人的小问题。</p>
<h2 id="-multi-master">二、Multi-master</h2>
<p><a href="http://en.wikipedia.org/wiki/Multi-master_replication" target="_blank">Multi-master</a>指一个系统存在多个master, 每个master都具有read-write能力，需根据时间戳或业务逻辑合并版本。比如分布式版本管理系统git可以理解成multi-master模式。具备最终一致性。多版本数据修改可以借鉴Dynamo的vector clock等方法。</p>
<p><strong>优点：</strong>解决了单点故障。
<strong>缺点：</strong>不易实现一致性，合并版本的逻辑复杂。</p>
<h2 id="-two-phase-commit-2pc-">三、Two-phase commit(2PC)</h2>
<p><a href="http://en.wikipedia.org/wiki/Two-phase_commit_protocol" target="_blank">Two-phase commit</a>是一个比较简单的一致性算法。由于一致性算法通常用神话(如Paxos的The Part-Time Parliament论文)来比喻容易理解，下面也举个类似神话的例子。</p>
<p>某班要组织一个同学聚会，前提条件是所有参与者同意则活动举行，任意一人拒绝则活动取消。用2PC算法来执行过程如下</p>
<h3 id="phase-1">Phase 1</h3>
<p><strong>Prepare:</strong>组织者(coordinator)打电话给所有参与者(participant) ，同时告知参与者列表。
<strong>Proposal:</strong> 提出周六2pm-5pm举办活动。
<strong>Vote:</strong> participant需vote结果给coordinator：accept or reject。
<strong>Block:</strong> 如果accept, participant锁住周六2pm-5pm的时间，不再接受其他请求。</p>
<h3 id="phase-2">Phase 2</h3>
<p><strong>Commit:</strong> 如果所有参与者都同意，组织者coodinator通知所有参与者commit, 否则通知abort，participant解除锁定。</p>
<h3 id="failure-">Failure 典型失败情况分析</h3>
<p><strong>Participant failure:</strong>
任一参与者无响应，coordinator直接执行abort
<strong>Coordinator failure:</strong>
<strong>Takeover:</strong> 如果participant一段时间没收到cooridnator确认(commit/abort)，则认为coordinator不在了。这时候可自动成为Coordinator备份(watchdog)
<strong>Query:</strong> watchdog根据phase 1接收的participant列表发起query
<strong>Vote:</strong> 所有participant回复vote结果给watchdog, accept or reject
<strong>Commit:</strong> 如果所有都同意，则commit, 否则abort。</p>
<p><strong>优点：</strong>实现简单。
<strong>缺点：</strong>所有参与者需要阻塞(block)，throughput低；无容错机制，一节点失败则整个事务失败。</p>
<h2 id="-three-phase-commit-3pc-">四、Three-phase commit (3PC)</h2>
<p><a href="http://en.wikipedia.org/wiki/Three-phase_commit_protocol" target="_blank">Three-phase commit</a>是一个2PC的改进版。2PC有一些很明显的缺点，比如在coordinator做出commit决策并开始发送commit之后，某个participant突然crash，这时候没法abort transaction, 这时候集群内实际上就存在不一致的情况，crash恢复后的节点跟其他节点数据是不同的。因此3PC将2PC的commit的过程1分为2,分成preCommit及commit, 如图。
<img src="&quot;3PC&quot;" alt="">
(图片来源：<a href="http://en.wikipedia.org/wiki/File:Three-phase_commit_diagram.png" target="_blank"><a href="http://en.wikipedia.org/wiki/File:Three-phase_commit_diagram.png">http://en.wikipedia.org/wiki/File:Three-phase_commit_diagram.png</a></a>)</p>
<p>从图来看，cohorts(participant)收到preCommit之后，如果没收到commit, 默认也执行commit, 即图上的timeout cause commit。</p>
<p>如果coodinator发送了一半preCommit crash, watchdog接管之后通过query, 如果有任一节点收到commit, 或者全部节点收到preCommit, 则可继续commit, 否则abort。</p>
<p><strong>优点：</strong>允许发生单点故障后继续达成一致。
<strong>缺点：</strong>网络分离问题，比如preCommit消息发送后突然两个机房断开，这时候coodinator所在机房会abort, 另外剩余replicas机房会commit。</p>
<h2 id="-paxos">五、Paxos</h2>
<p>Google Chubby的作者Mike Burrows说过， “there is only one consensus protocol, and that’s Paxos” – all other approaches are just broken versions of Paxos. 意即“世上只有一种一致性算法，那就是Paxos”，所有其他一致性算法都是Paxos算法的不完整版。相比2PC/3PC, Paxos算法的改进</p>
<ul>
<li>P1a. 每次Paxos实例执行都分配一个编号，编号需要递增，每个replica不接受比当前最大编号小的提案</li>
<li>P2. 一旦一个 value v 被replica通过，那么之后任何再批准的 value 必须是 v，即没有拜占庭将军(Byzantine)问题。拿上面请客的比喻来说，就是一个参与者一旦accept周六2pm-5pm的proposal, 就不能改变主意。以后不管谁来问都是accept这个value。</li>
<li>一个proposal只需要多数派同意即可通过。因此比2PC/3PC更灵活，在一个2f+1个节点的集群中，允许有f个节点不可用。</li>
</ul>
<p>另外Paxos还有很多约束的细节，特别是Google的chubby从工程实现的角度将Paxos的细节补充得非常完整。比如如何避免Byzantine问题，由于节点的持久存储可能会发生故障，Byzantine问题会导致Paxos算法P2约束失效。</p>
<p>以上几种方式原理比较如下</p>
<p><a href=""><img src="&quot;idc-transaction&quot;" alt=""></a></p>
<p>(图片来源：<a href="http://snarfed.org/space/transactions_across_datacenters_io.html" target="_blank"><a href="http://snarfed.org/space/transactions_across_datacenters_io.html">http://snarfed.org/space/transactions_across_datacenters_io.html</a></a>)</p>
<p>后文会继续比较实践环境选取何种策略合适。</p>
<p>（PS: 写完后在Google Reader上发现本文跟王建硕最近发表的《<a href="http://home.wangjianshuo.com/cn/20100201_aeaeaecee.htm" target="_blank">关于两个机房的讨论</a>》文章有点类似，特别是本文一、二方式。不过他的文章偏MySQL的实现，我的重点是一致性算法，大家可以有选择性的阅读。）</p>
<h2 id="-paxos-http-timyang-net-distributed-paxos-scenarios-permanent-link-to-paxos-"><a href="http://timyang.net/distributed/paxos-scenarios/" title="Permanent Link to Paxos在大型系统中常见的应用场景" target="_blank">Paxos在大型系统中常见的应用场景</a></h2>
<p>Wednesday, Sep 23rd, 2009 by Tim | <strong><a href="http://timyang.net/distributed/paxos-scenarios/#comments" target="_blank">5 Comments</a></strong>
Filed under: <a href="http://timyang.net/category/distributed/" title="View all posts in 分布式" target="_blank">分布式</a> | Tags: <a href="http://timyang.net/tag/chubby/" target="_blank">chubby</a>, <a href="http://timyang.net/tag/paxos/" target="_blank">paxos</a>, <a href="http://timyang.net/tag/zookeeper/" target="_blank">zookeeper</a></p>
<p>在分布式算法领域，有个非常重要的算法叫Paxos, 它的重要性有多高呢，Google的Chubby [1]中提到
all working protocols for asynchronous consensus we have so far encountered have Paxos at their core.</p>
<p>关于Paxos算法的详述在维基百科中有更多介绍，中文版介绍的是choose value的规则[2]，英文版介绍的是Paxos 3 phase commit的流程[3]，中文版不是从英文版翻译而是独立写的，所以非常具有互补性。Paxos算法是由Leslie Lamport提出的，他在Paxos Made Simple[4]中写道</p>
<p>The Paxos algorithm, when presented in plain English, is very simple.</p>
<p>当你研究了很长一段时间Paxos算法还是有点迷糊的时候，看到上面这句话可能会有点沮丧。但是公认的它的算法还是比较繁琐的，尤其是要用程序员严谨的思维将所有细节理清的时候，你的脑袋里更是会充满了问号。Leslie Lamport也是用了长达9年的时间来完善这个算法的理论。</p>
<p>实际上对于一般的开发人员，我们并不需要了解Paxos所有细节及如何实现，只需要知道Paxos是一个分布式选举算法就够了。本文主要介绍一下Paxos常用的应用场合，或许有一天当你的系统增大到一定规模，你知道有这样一个技术，可以帮助你正确及优雅的解决技术架构上一些难题。</p>
<ol>
<li><p>database replication, log replication等， 如bdb的数据复制就是使用paxos兼容的算法。Paxos最大的用途就是保持多个节点数据的一致性。</p>
</li>
<li><p>naming service, 如大型系统内部通常存在多个接口服务相互调用。
1) 通常的实现是将服务的ip/hostname写死在配置中，当service发生故障时候，通过手工更改配置文件或者修改DNS指向的方法来解决。缺点是可维护性差，内部的单元越多，故障率越大。
2) LVS双机冗余的方式，缺点是所有单元需要双倍的资源投入。
通过Paxos算法来管理所有的naming服务，则可保证high available分配可用的service给client。象ZooKeeper还提供watch功能，即watch的对象发生了改变会自动发notification, 这样所有的client就可以使用一致的，高可用的接口。</p>
</li>
</ol>
<p>3.config配置管理
1) 通常手工修改配置文件的方法，这样容易出错，也需要人工干预才能生效，所以节点的状态无法同时达到一致。
2) 大规模的应用都会实现自己的配置服务，比如用http web服务来实现配置中心化。它的缺点是更新后所有client无法立即得知，各节点加载的顺序无法保证，造成系统中的配置不是同一状态。</p>
<p>4.membership用户角色/access control list, 比如在权限设置中，用户一旦设置某项权限比如由管理员变成普通身份，这时应在所有的服务器上所有远程CDN立即生效，否则就会导致不能接受的后果。</p>
<ol>
<li>号码分配。通常简单的解决方法是用数据库自增ID, 这导致数据库切分困难，或程序生成GUID, 这通常导致ID过长。更优雅的做法是利用paxos算法在多台replicas之间选择一个作为master, 通过master来分配号码。当master发生故障时，再用paxos选择另外一个master。</li>
</ol>
<p>这里列举了一些常见的Paxos应用场合，对于类似上述的场合，如果用其它解决方案，一方面不能提供自动的高可用性方案，同时也远远没有Paxos实现简单及优雅。</p>
<p>Yahoo!开源的ZooKeeper [5]是一个开源的类Paxos实现。它的编程接口看起来很像一个可提供强一致性保证的分布式小文件系统。对上面所有的场合都可以适用。但可惜的是，ZooKeeper并不是遵循Paxos协议，而是基于自身设计并优化的一个2 phase commit的协议，因此它的理论[6]并未经过完全证明。但由于ZooKeeper在Yahoo!内部已经成功应用在HBase, Yahoo! Message Broker, Fetch Service of Yahoo! crawler等系统上，因此完全可以放心采用。</p>
<p>另外选择Paxos made live [7]中一段实现体会作为结尾。
/<em>  There are significant gaps between the description of the Paxos algorithm and the needs of a real-world system. In order to build a real-world system, an expert needs to use numerous ideas scattered in the literature and make several relatively small protocol extensions. The cumulative effort will be substantial and the final system will be based on an unproven protocol.
/</em> 由于chubby填补了Paxos论文中未提及的一些细节，所以最终的实现系统不是一个理论上完全经过验证的系统</p>
<p>/<em> The fault-tolerance computing community has not developed the tools to make it easy to implement their algorithms.
/</em> 分布式容错算法领域缺乏帮助算法实现的的配套工具, 比如编译领域尽管复杂，但是yacc, ANTLR等工具已经将这个领域的难度降到最低。</p>
<p>/<em> The fault-tolerance computing community has not paid enough attention to testing, a key ingredient for building fault-tolerant systems.
/</em> 分布式容错算法领域缺乏测试手段</p>
<p>这里要补充一个背景，就是要证明分布式容错算法的正确性通常比实现算法还困难，Google没法证明Chubby是可靠的，Yahoo!也不敢保证它的ZooKeeper理论正确性。大部分系统都是靠在实践中运行很长一段时间才能谨慎的表示，目前系统已经基本没有发现大的问题了。</p>
<p><strong>Resources</strong>
[1] <a href="http://labs.google.com/papers/chubby-osdi06.pdf" target="_blank">The Chubby lock service for loosely-coupled distributed systems</a> (PDF)
[2] <a href="http://zh.wikipedia.org/wiki/Paxos%E7%AE%97%E6%B3%95" target="_blank"><a href="http://zh.wikipedia.org/wiki/Paxos%E7%AE%97%E6%B3%95">http://zh.wikipedia.org/wiki/Paxos%E7%AE%97%E6%B3%95</a></a>
[3] <a href="http://en.wikipedia.org/wiki/Paxos_algorithm" target="_blank"><a href="http://en.wikipedia.org/wiki/Paxos_algorithm">http://en.wikipedia.org/wiki/Paxos_algorithm</a></a>
[4] <a href="http://research.microsoft.com/en-us/um/people/lamport/pubs/paxos-simple.pdf" target="_blank">Paxos Made Simple</a> (PDF)
[5] <a href="http://hadoop.apache.org/zookeeper/" target="_blank">ZooKeeper</a>
[6] <a href="http://portal.acm.org/citation.cfm?id=1583991.1584007" target="_blank">The life and times of a zookeeper</a>
[7] <a href="http://labs.google.com/papers/paxos_made_live.pdf" target="_blank">Paxos Made Live – An Engineering Perspective</a> (PDF)</p>
<p>Except where otherwise noted, content on this site is licensed under a <a href="http://creativecommons.org/licenses/by/3.0/" target="_blank">Creative Commons Attribution 3.0</a> License</p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/架构师/">架构师</a></li></span><span class="breadcrumb"><li><a href="/categories/架构师/">架构师</a></li><li><a href="/categories/架构师/架构/">架构</a></li></span></span> | <span class="tags">Tagged <a href="/tags/架构/" class="label label-primary">架构</a><a href="/tags/架构师/" class="label label-success">架构师</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:29"datetime="2014-03-07 09:54:29"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-架构师-架构--多IDC的数据分布设计一/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-架构师-架构--多IDC的数据分布设计一" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-框架汇总-activemq--activemq的网络层介绍/">activemq的网络层介绍</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:29.000Z"> <a href="/2014/02/02/2014-02-02-框架汇总-activemq--activemq的网络层介绍/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="activemq-">activemq的网络层介绍</h1>
<p>#</p>
<h3 id="-">概要</h3>
<p>activemq是一个apache的顶级项目，其实现了<a href="http://www.goldendoc.org/2011/08/jms_spec_message/" title="JMS规范介绍(1) JMS消息" target="_blank">JMS规范</a>，作为一个开源的JMS实现，activemq已经在很多地方得到了应用。同时，开源小组在研究JMS实现的时候，也选择了activemq作为研究对象，希望能够读其源码，让<a href="http://www.goldendoc.org/" title="开源学习小组：黄金档" target="_blank">开源小组</a>更好的明白JMS规范和实现。</p>
<p>在学习activemq的时候，我们发现还不能一下子就进去学习JMS规范的实现，而是需要了解其底层代码，包括其对网络连接的处理等等。所以，这篇文章就学习了<a href="http://www.goldendoc.org/2011/09/activemq-network-process/" title="activemq的网络层实现" target="_blank">activemq的网络层实现</a>。</p>
<h3 id="activemq-">activemq网络层概念</h3>
<p>activemq 是支持多协议的，因此，把单一协议的server抽象成更高一层，就很有意义，请看下面这张图：
<a href="http://www.goldendoc.org/wp-content/uploads/2011/09/activemq%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A51.png" target="_blank"><img src="" alt=""></a></p>
<p>在activemq中，差不多每种概念都有生命周期（见Service接口）。
这张图十分简单，实际中当然比这个要复杂。下面针对每个概念进行叙述。</p>
<h3 id="transport">Transport</h3>
<p>Transport 应该算是很底层的概念，他封装了 Socket，职责是发送和接受连接方的信息。
同时，在Transport中，增加了同步和异步的概念。
Transport拥有一个TransportListener。</p>
<h3 id="transportlistener">TransportListener</h3>
<p>顾名思义，TransportListener 就是监听 Transport 事件的发生以及做出一定的反映。
在activemq中，正是利用了 TransportListener 对 Command 进行处理 —— Command 是 activemq 网络传递的形式，每个请求都会被反序列化成一个 Command。</p>
<h3 id="transportserver">TransportServer</h3>
<p>就是一个server实例，他会处理外部进来的Socket，进而封装成 Transport 。此 Server 拥有一个 TransportAcceptListener 。</p>
<h3 id="transportacceptlistener">TransportAcceptListener</h3>
<p>负责 Accept Transport，将 Transport 封装成 Connection，从而开启 Connection 的生命周期。
这里需要注意的是：TransportServer 将 Socket 封装成 Transport，而 TransportAcceptListener 将 Transport 封装成 Connection。</p>
<h3 id="connection">Connection</h3>
<p>可以理解成业务层面上的连接。 Connection 会给相应的 Transport 设置 TransportListener ，从而获取底层 Socket 的活动情况，进行业务的处理。</p>
<h3 id="connector">Connector</h3>
<p>Connector就是较高层次的抽象，它代表对外的连接器，每个连接器都可以支持不同的协议。
Connector 通过给 TransportServer 设置 TransportAcceptListener ，从而能够控制 Transport 并产生相应的 Connection。</p>
<h3 id="-">总结</h3>
<p>总体来说，两个Listener是连接 Conncetor与TransportServer 和 Connection和Transport 的关键概念。
至于为什么要分成 Connector ， TransportServer 这两层，我想原因应该就是开头提到的： activemq需要支持多协议，因此 Connector 抽象起来，可以当作是针对不同协议的统一行为；而 TransportServer 就是针对各协议的具体实现。 对于 Connection,Transport 来说， Connector 是与 Connection 统一层次， Transport 是与 TransportServer 统一层次。
如果读者有时间，还可以查看<a href="http://www.goldendoc.org/" title="开源小组" target="_blank">开源小组</a>当时分析的<a href="http://www.goldendoc.org/wp-content/uploads/2011/09/activemq%E7%BD%91%E7%BB%9C%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B.png" target="_blank">activemq网络连接序列图</a>（是基于TcpTransportServer的，图像有点大，需要耐心看）</p>
<p><img src="" alt="">
来源： <a href="[http://www.goldendoc.org/2011/09/activemq-network-process/](http://www.goldendoc.org/2011/09/activemq-network-process/)">[http://www.goldendoc.org/2011/09/activemq-network-process/](http://www.goldendoc.org/2011/09/activemq-network-process/)</a></p>
<p>本文会把主要篇幅集中在这几个组件的创建时期，运行时期来讲解，最后会总结一下这几个组建使用的线程情况。一下的分析是基于 bio 的（nio 也是在这个结构当中，只是行为是基于 nio 特点的）。在<a href="http://www.goldendoc.org/2011/09/activemq-network-process/" title="activemq的网络层介绍（一）" target="_blank">activemq的网络层介绍（一）</a>也讲过，activemq中很多组件都实现了 Service 接口，而 Service 接口的作用就是赋予实现者有生命周期的意义。</p>
<h3 id="transportconnector">TransportConnector</h3>
<p>TransportConnector 是 Connector 的实现，是基于 Transport 的 Connector（目前activemq的Connector实现，也就是基于Transport的）。其内部依赖了 TransportServer ，这个也容易理解，因为这个 Connector 是基于 Transport 的。因此 TransportServer 也是其所重点依赖的组件。 值得注意的是 TransportServer 的 AcceptListener 也是在 TransportConnector 中指定的，具体见下文。</p>
<h3 id="transportconnector-">TransportConnector 的创建</h3>
<p>TransportConnector 的创建比较简单，直接接受传入进来的 TransportServer （关于 TransportServer 的创建，详见下文）。</p>
<h3 id="transportconnector-">TransportConnector 的运行</h3>
<p>TransportConnector 是一个 Service，有自己的生命周期。因此，在 activemq 开始的时候，其生命周期，会被启动（具体表现为被调用 start 方法）。</p>
<p>在 TransportConnector 的 start 方法中，可以很明显的看到两个主要的逻辑：为 TransportServer 设置一个匿名的 AcceptListener ，调用 TransportServer 启动。</p>
<p>对于 TransportConnector 为 TransportServer 设置的 AcceptListener，其逻辑主要是当 TransportServer 接收到传输进来的 Transport（由 TransportServer 将 Socket 封装成 Transport）之后，将 Transport 封装成 Connection ，并且启动 Connection 的生命周期。这里也不难理解：在<a href="http://www.goldendoc.org/2011/09/activemq-network-process/" title="activemq的网络层介绍（一）" target="_blank">activemq网络层介绍（一）</a>中也讲过， Connector 是与 Connection 一个层次的，TransportServer 与 Transport 是一个层次的。因此，将 AcceptListener 的匿名实现放在 TransportConnector 中，也就很好理解了。</p>
<h3 id="connection">Connection</h3>
<p>在 TransportServer 的 AcceptListener 收到传输进来的 Transport 之后，就创建了 Connection（实际类型是 TransportConnection），然后为 Connection 开启生命周期。
但一个Socket是从什么时候传进来，进而被封装成 Transport 的，会在下文有描述。现在让我们跟着 TransportConnection ，看看他是如何被创建的，以及在它的生命周期中，会做什么事情。</p>
<h3 id="transportconnection-">TransportConnection 的创建</h3>
<p>TransportConnection 是在 AcceptListener 收到 TransportServer 传进来的 Transport 之后创建的。可以想象，TransportConnection 是封装了 Transport 的。同时， Transport 的 TransportListener ，也是在 TransportConnection 的构造方法中进行了创建。此 TransportListener 的逻辑就是服务一个 Command (Command是 activemq 实例之间交互的基本对象，任何请求和响应都被activemq 序列化成一个 Command)，在得到响应的时候，进行分发（响应其实也是一个Command）。</p>
<h3 id="transportconnection-">TransportConnection 的运行</h3>
<p>在开始说 TransportConnection 的生命周期之前，可以先说一下 activemq 的 Task 接口，此接口有一个 iterate 遍历方法，activemq 一般对这个接口的用法都是使用一个线程去跑 iterater 方法，直到 iterater 返回 false 。一般的，iterater 方法里面都是在重复的做一段逻辑，只不过是这个逻辑实施的对象不一样而已。TransportConnection 正是实现了此接口。</p>
<p>在 TransportConnection 的 start 方法中，主要做了两件事情：创建一个 taskRunner ，以做好跑 Task 的准备（就是在另起线程跑自己的 Iiterater 方法）；调用 Transport 的 Start 方法，开启 Transport 的生命周期。</p>
<p>在 TransportConnection 自己的 Iiterater 方法中，就是到一个队列中取出 Command，并且使用 Transport 的 oneWay，将 Command 发送出去。</p>
<h3 id="transportserver">TransportServer</h3>
<p>按理说要接下来讲 Transport，但如果不先把 TransportServer 弄清出的话， Transport 还是有些难以理解的。因为是 TransportServer 将 接受到的 Socket 封装成 Transport。这里说的是 TransportServer 的实现， TcpTransportServer。</p>
<h3 id="tcptransportserver-">TcpTransportServer 的创建</h3>
<p>TransportServer 是由 TransportFactory 创建的。TransportFactory，不同的 TransportFactory 创建出不同的 TransportServer，而 TcpTransportServer 则是由 TcpTransportFactory 创建的。关于 TransportFactory 如何创建相应的 TransportServer，activemq使用了一套基于分析参数和配置文件来实现，说起来很高深，其实很朴实的，有兴趣也可以了解一下，这里不做深入。</p>
<h3 id="tcptransportserver-">TcpTransportServer 的运行</h3>
<p>这里主要使用 TcpTransportServer，TcpTransportServer 生命周期，是通过 TransportConnector 来开启的，这点在上面已经有所讲述。</p>
<p>这里要说一下 TransportServerThreadSupport，此类的作用是支持 TransportServer 能够开启另外一个线程，只要实现了 TransportServer Runnable，在 start 的时候，就能够开启另外一个线程，这也是 TransportServerThreadSupport 命令的含义。同样的机制也出现在 TransportThreadSupport 中。</p>
<p>现在来看一下 TcpTransportServer 的 start ：
TcpTransportServer 会开启两个线程，包括：</p>
<ol>
<li>实现了Runnable的线程，此线程的工作是不停的 accept 外部的 socket，然后将 socket 扔到一个队列中。简单来说，此线程是一个 acceptor。</li>
<li>另外一个线程的工作是，从队列中取出 socket ，并且将 WireFormat（ WireFormat 是在 activemq 中负责序列化和发序列化的组件） 和socket 封装成一个 Transport ，然后将创建好的 Transport 通知到 AcceptListener 中。</li>
</ol>
<h3 id="transport">Transport</h3>
<p>这里也主要讲 TcpTransport。</p>
<h3 id="tcptransport-">TcpTransport 的创建</h3>
<p>上面已经讲到，TcpTransport 是在 TcpTransportServer 中创建，并扔给了 AcceptListener 。并且，TcpTransport 也支持 TransportThreadSupport 的形式，可以另起一个线程。</p>
<h3 id="tcptransport-">TcpTransport 的运行</h3>
<p>TcpTransport 开始执行之后，专注于做两个事情：</p>
<ol>
<li>初始化 socket，并且把 socket 的流给设置起来。</li>
<li>另起一个线程，利用 wireFormat 将 socket 传过来的字节序列转化成一个 command ，然后将 Command 扔给 transportListener 。transportListener 所做的事情就是进行业务处理，然后将得到的 response （也是一个 command）通过 tcpTransport 的 oneway 传给对方。</li>
</ol>
<p>这样，这个网络通讯的过程就完成了。下面我们来总结一下 TcpTransportServer 的线程模型。</p>
<h3 id="tcptransportserver-">TcpTransportServer 的线程模型</h3>
<p>如图所示：
<a href="http://www.goldendoc.org/wp-content/uploads/2011/09/activemq%E6%A8%A1%E5%9E%8B.jpg" target="_blank"><img src="" alt="activemq网络线程模型"></a></p>
<p>activemq网络线程模型</p>
<h3 id="-">总结</h3>
<p>从上图中可以看出，accpetor 和 sockethandler 线程是在整个 transportServer 中的，而 ThreadPool 中的线程不会进行消息的发送，相反，当需要发送消息的时候，总是会创建新的线程去发送。这也是为了 ThreadPool 能将自己的线程利用率提高。因为这是 bio 的网络，如果消息的发送是利用线程池中的线程来发送的，那么很有可能线程池中的线程会在发送的时候阻塞，因为对方的网络不可预知。因此，新建一个新的线程，利用新建的线程发送消息，则是很明智的选择。
来源： <a href="[http://www.goldendoc.org/2011/09/activemq-network-process-2/](http://www.goldendoc.org/2011/09/activemq-network-process-2/)">[http://www.goldendoc.org/2011/09/activemq-network-process-2/](http://www.goldendoc.org/2011/09/activemq-network-process-2/)</a> </p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/框架汇总/">框架汇总</a></li></span><span class="breadcrumb"><li><a href="/categories/框架汇总/">框架汇总</a></li><li><a href="/categories/框架汇总/activemq/">activemq</a></li></span></span> | <span class="tags">Tagged <a href="/tags/activemq/" class="label label-primary">activemq</a><a href="/tags/框架汇总/" class="label label-success">框架汇总</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:29"datetime="2014-03-07 09:54:29"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-框架汇总-activemq--activemq的网络层介绍/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-框架汇总-activemq--activemq的网络层介绍" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-框架汇总-Spring--Spring-设计模式-aop-ioc/">Spring</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:29.000Z"> <a href="/2014/02/02/2014-02-02-框架汇总-Spring--Spring-设计模式-aop-ioc/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="spring-aop-ioc">Spring-设计模式-aop-ioc</h1>
<p><a href="http://www.goldendoc.org/" target="_blank">黄金档</a></p>
<p>路漫漫其修远兮，吾将上下而求索……</p>
<ul>
<li><a href="http://www.goldendoc.org/" title="首页" target="_blank">首页</a></li>
<li><a href="http://www.goldendoc.org/hire/" target="_blank">招聘</a></li>
<li><a href="http://www.goldendoc.org/about/" target="_blank">关于</a></li>
</ul>
<h1 id="spring">Spring</h1>
<h2 id="-spring-http-www-goldendoc-org-2010-12-spring_design_pattern-spring-"><a href="http://www.goldendoc.org/2010/12/spring_design_pattern/" title="永久链接：Spring中的设计模式" target="_blank">Spring中的设计模式</a></h2>
<p><a href="http://www.goldendoc.org/2010/12/spring_design_pattern/#comments" target="_blank">2</a></p>
<p>2年前</p>
<p>由<a href="http://www.goldendoc.org/author/jackey/" title="jackey发表的文章 " target="_blank">jackey</a>发布 在<a href="http://www.goldendoc.org/category/spring/" title="Spring (4主题)" target="_blank">Spring</a>
应该说设计模式是我们在写代码时候的一种被承认的较好的模式。好的设计模式就像是给代码造了一个很好的骨架，在这个骨架里，你可以知道心在哪里，肺在哪里，因为大多数人都认识这样的骨架，就有了很好的传播性。这是从易读和易传播来感知设计模式的好处。当然设计模式本身更重要的是设计原则的一种实现，比如开闭原则，依赖倒置原则，这些是在代码的修改和扩展上说事。说到底就是人类和代码发生关系的四种场合：阅读，修改，增加，删除。让每一种场合都比较舒服的话，就需要用设计模式。</p>
<p>下面来简单列举Spring中的设计模式：
<strong>1. 简单工厂</strong>
又叫做静态工厂方法（StaticFactory Method）模式，但不属于23种GOF设计模式之一。
简单工厂模式的实质是由一个工厂类根据传入的参数，动态决定应该创建哪一个产品类。
Spring中的BeanFactory就是简单工厂模式的体现，根据传入一个唯一的标识来获得Bean对象，但是否是在传入参数后创建还是传入参数前创建这个要根据具体情况来定。
<strong>2. 工厂方法（Factory Method）</strong>
定义一个用于创建对象的接口，让子类决定实例化哪一个类。Factory Method使一个类的实例化延迟到其子类。
Spring中的FactoryBean就是典型的工厂方法模式。如下图：
<a href="http://pic.yupoo.com/goldendoc/AFbYXQy8/cgvMF.jpg" target="_blank"><img src="" alt=""></a></p>
<p><strong>3. 单例（Singleton）</strong>
保证一个类仅有一个实例，并提供一个访问它的全局访问点。
Spring中的单例模式完成了后半句话，即提供了全局的访问点BeanFactory。但没有从构造器级别去控制单例，这是因为Spring管理的是是任意的Java对象。
<strong>4. 适配器（Adapter）</strong>
将一个类的接口转换成客户希望的另外一个接口。Adapter模式使得原本由于接口不兼容而不能一起工作的那些类可以一起工作。
Spring中在对于AOP的处理中有Adapter模式的例子，见如下图：
<a href="http://pic.yupoo.com/goldendoc/AFbYXG9r/yaKsE.jpg" target="_blank"><img src="" alt=""></a>
由于Advisor链需要的是MethodInterceptor对象，所以每一个Advisor中的Advice都要适配成对应的MethodInterceptor对象。
<strong>5.包装器（Decorator）</strong>
动态地给一个对象添加一些额外的职责。就增加功能来说，Decorator模式相比生成子类更为灵活。 <em>**</em></p>
<p><a href="http://pic.yupoo.com/goldendoc/AFbYXVzM/iEPst.jpg" target="_blank"><img src="" alt=""></a>
Spring中用到的包装器模式在类名上有两种表现：一种是类名中含有Wrapper，另一种是类名中含有Decorator。基本上都是动态地给一个对象添加一些额外的职责。
<strong>6. 代理（Proxy）</strong>
为其他对象提供一种代理以控制对这个对象的访问。
从结构上来看和Decorator模式类似，但Proxy是控制，更像是一种对功能的限制，而Decorator是增加职责。
<img src="" alt="">
Spring的Proxy模式在aop中有体现，比如JdkDynamicAopProxy和Cglib2AopProxy。
<strong>7.观察者（Observer）</strong>
定义对象间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖于它的对象都得到通知并被自动更新。
<a href="http://pic.yupoo.com/goldendoc/AFbYY79B/QRttX.jpg" target="_blank"><img src="" alt=""></a>
Spring中Observer模式常用的地方是listener的实现。如ApplicationListener。
<strong>8. 策略（Strategy）</strong>
定义一系列的算法，把它们一个个封装起来，并且使它们可相互替换。本模式使得算法可独立于使用它的客户而变化。
Spring中在实例化对象的时候用到Strategy模式，见如下图：
<a href="http://pic.yupoo.com/goldendoc/AFbYYjl6/c2IJb.jpg" target="_blank"><img src="" alt=""></a>
在SimpleInstantiationStrategy中有如下代码说明了策略模式的使用情况：
<a href="http://pic.yupoo.com/goldendoc/AFbYYecL/xJ2n1.jpg" target="_blank"><img src="" alt=""></a>
<strong>9.模板方法（Template Method）</strong>
定义一个操作中的算法的骨架，而将一些步骤延迟到子类中。Template Method使得子类可以不改变一个算法的结构即可重定义该算法的某些特定步骤。
<img src="" alt="">
Template Method模式一般是需要继承的。这里想要探讨另一种对Template Method的理解。Spring中的JdbcTemplate，在用这个类时并不想去继承这个类，因为这个类的方法太多，但是我们还是想用到JdbcTemplate已有的稳定的、公用的数据库连接，那么我们怎么办呢？我们可以把变化的东西抽出来作为一个参数传入JdbcTemplate的方法中。但是变化的东西是一段代码，而且这段代码会用到JdbcTemplate中的变量。怎么办？那我们就用回调对象吧。在这个回调对象中定义一个操纵JdbcTemplate中变量的方法，我们去实现这个方法，就把变化的东西集中到这里了。然后我们再传入这个回调对象到JdbcTemplate，从而完成了调用。这可能是Template Method不需要继承的另一种实现方式吧。</p>
<p>以下是一个具体的例子：
JdbcTemplate中的execute方法：</p>
<p><a href="http://pic.yupoo.com/goldendoc/AFbYXJ1i/Gqxeo.jpg" target="_blank"><img src="" alt=""></a>
JdbcTemplate执行execute方法：
<a href="http://pic.yupoo.com/goldendoc/AFbYYoCZ/coCXA.jpg" target="_blank"><img src="" alt=""></a></p>
<p><a href="http://www.goldendoc.org/tag/%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f/" title="设计模式 (1主题)" target="_blank">设计模式</a></p>
<h2 id="-spring-aop-http-www-goldendoc-org-2010-12-spring_aop-spring-aop-"><a href="http://www.goldendoc.org/2010/12/spring_aop/" title="永久链接：Spring AOP介绍及源码分析" target="_blank">Spring AOP介绍及源码分析</a></h2>
<p><a href="http://www.goldendoc.org/2010/12/spring_aop/#comments" target="_blank">3</a></p>
<p>2年前</p>
<p>由<a href="http://www.goldendoc.org/author/lwei/" title="lwei发表的文章 " target="_blank">lwei</a>发布 在<a href="http://www.goldendoc.org/category/spring/" title="Spring (4主题)" target="_blank">Spring</a>
软件开发经历了从汇编语言到高级语言和从过程化编程到面向对象编程；前者是为了提高开发效率，而后者则使用了归纳法，把具有共性的东西进行归类并使之模块化，达到便于维护和扩展的目的；如果说面向对象编程可以对业务需求进行很好的分解使之模块化；那么面向切面编程AOP（Aspect-Oriented Programming）则可以对系统需求进行很好的模软件开发经历了从汇编语言到高级语言和从过程化编程到面向对象编程；前者是为了提高开发效率，而后者则使用了归纳法，把具有共性的东西进行归类并使之模块化，达到便于维护和扩展的目的；如果说面向对象编程可以对业务需求进行很好的分解使之模块化；那么面向切面编程AOP（Aspect-Oriented Programming）则可以对系统需求进行很好的模块组织，简化系统需求和实现之间的对比关系，是对OOP思想的一种补充；块组织，简化系统需求和实现之间的对比关系，是对OOP思想的一种补充；</p>
<p><strong>一、AOP介绍
</strong></p>
<p>举个例子来说明一下吧！现在系统中有很多的业务方法，如上传产品信息、修改产品信息、发布公司库等；现在需要对这些方法的执行做性能监控，看每个业务方法的执行时间；在不改变原业务代码的基础上，也许我们会这么做：</p>
<p><strong>Offer接口：
</strong></p>
<p><img src="" alt=""></p>
<p><strong>Offer实现：
</strong></p>
<p><img src="" alt=""></p>
<p><strong>Offer代理：
</strong></p>
<p><img src="" alt=""></p>
<p>我们要通过下面的方式来使用：</p>
<p><img src="" alt=""></p>
<p>上面的例子的输出为：</p>
<p><img src="" alt=""></p>
<p>上面的例子中，OfferProxy实现了IOffer，而所有的业务实现均委托给其成员offer；可以想像，这应该就是最简单的AOP的实现了；但这种方式会存在一个问题：如果有非常多的这种业务对象需要性能监控，我们就需要写同样多的XyzProxy来满足需求，这也是非常巨大的工作量。</p>
<p>上面说到了代理，我们先看看代理模式吧！</p>
<p><strong>二、代理模式及实现
</strong></p>
<p>下面是代理模式的类图：</p>
<p><img src="" alt=""></p>
<p>代理模式类图</p>
<p>代理模式中，存在一个称为ProxyObject的代理对象和RealObject的真实对象，它们都实现了相同的接口；在调用的地方持有ProxyObject的实例，当调用request()方法时，ProxyObject可以在执行RealObject.request()前后做一些特定的业务，甚至不调用RealObject.request()方法。</p>
<p>目前实现代理模式的方式有两种：基于JDK的动态代理和基于CGLIB字节码的代理。</p>
<p><strong>2.1 JDK动态代理
</strong></p>
<p>JDK动态代理，顾名思义，是基于JDK的反射(reflect)机制；在JDK中，提供了InvocationHandler这个接口，下面是JDK里面的注释：</p>
<p>InvocationHandler is the interface implemented by the invocation handler of a proxy instance.</p>
<p>Each proxy instance has an associated invocation handler. When a method is invoked on a proxy instance, the method invocation is encoded and dispatched to the invoke method of its invocation handler.</p>
<p>简单翻译，意思是说：该接口由被代理对象的handler所实现；当调用代理对象的方法时，该方法调用将被编码，然后交给代理对象的invoke方法去执行；</p>
<p>是不是有一种豁然开朗的感觉呢？没错，答案就在你心中。</p>
<p>这样，上面的代码就可以改成下面的实现方式：</p>
<p><img src="" alt=""><em>**</em></p>
<p><strong>调用端：
</strong></p>
<p><img src="" alt=""></p>
<p>通过这种方式，你不需要为针对每一个业务写一个代理对象，就可以很轻松地完成你的需求；但也许你已经注意到了，JDK的动态代理，在创建代理对象(上面红色代码部分)时，被代理的对象需要实现接口(即面向接口编程)；</p>
<p>这就是JDK的动态代理，简单吧！下面看看CGLIB代理方式。</p>
<p><strong>2.2 CGLIB代理
</strong></p>
<p>如果目标对象没有实现任何接口，那怎么办呢？不用担心，你可以用CGLIB来实现代理：</p>
<p><img src="" alt=""></p>
<p><strong>调用端：
</strong></p>
<p><img src="" alt=""></p>
<p>使用CGLIB创建的代理对象，其实就是继承了要代理的目标类，然后对目标类中所有非final方法进行覆盖，但在覆盖方法时会添加一些拦截代码(上面CglibProxyFactory类中的intercept方法)。</p>
<p>下面看看Spring中是如何实现AOP的。</p>
<p><strong>三、Spring AOP的实现
</strong></p>
<p><strong>3.1 Spring AOP的几个概念
</strong></p>
<p>Spring AOP中的几个基本概念，每次学习AOP都被这几个概念折腾的很不爽，我们在这里再把这几个概念描述一遍，力争把这几个概念搞清，在每次review这块内容的时候可以很快上手。</p>
<ol>
<li>切面(Aspect)：切面就是一个关注点的模块化，如事务管理、日志管理、权限管理等；</li>
<li>连接点(Joinpoint)：程序执行时的某个特定的点，在Spring中就是一个方法的执行；</li>
<li>通知(Advice)：通知就是在切面的某个连接点上执行的操作，也就是事务管理、日志管理等；</li>
<li>切入点(Pointcut)：切入点就是描述某一类选定的连接点，也就是指定某一类要织入通知的方法；</li>
<li>目标对象(Target)：就是被AOP动态代理的目标对象；</li>
</ol>
<p>用一张图来形象地表达AOP的概念及其关系如下：</p>
<p><img src="" alt=""></p>
<p><strong>3.2 Spring AOP中切入点、通知、切面的实现
</strong></p>
<p>理解了上面的几个概念后，我们分别来看看Spring AOP是如何实现这些概念的；</p>
<ol>
<li>切入点(Pointcut)：它定义了哪些连接点需要被织入横切逻辑；在Java中，连接点对应哪些类(接口)的方法。因此，我们都能猜到，所谓的切入点，就是定义了匹配哪些娄的哪些方法的一些规则，可以是静态的基于类(方法)名的值匹配，也可以是基于正则表达式的模式匹配。来看看Spring AOP Pointcut相关的类图：</li>
</ol>
<p><img src="" alt=""></p>
<p>在Pointcut接口的定义中，也许你已经想到了，ClassFilter是类过滤器，它定义了哪些类名需要拦截；典型的两个实现类为<strong>TypePatternClassFilter</strong>和<strong>TrueClassFilter</strong>(所有类均匹配)；而MethodMatcher为方法匹配器，定义哪些方法需要拦截。</p>
<p>在上面的类图中：</p>
<ul>
<li>StaticMethodMatch与DynamicMethodMatch的区别是后者在运行时会依据方法的参数值进行匹配。</li>
<li>NameMatchMethodPointCut根据指定的mappedNames来匹配方法。</li>
<li>AbstractRegexpMethodPointCut根据正则表达式来匹配方法。</li>
</ul>
<ol>
<li>通知(Advice)：通知定义了具体的横切逻辑。在Spring中，存在两种类型的Advice，即per-class和per-instance的Advice。</li>
</ol>
<p>所谓per-class，即该类型的Advice只提供方法拦截，不会为目标对象保存任何状态或者添加新的特性，它也是我们最常见的Advice。下面是per-class的类图：</p>
<p><img src="" alt=""></p>
<ul>
<li>BeforeAdvice：在连接点前执行的横切逻辑。</li>
<li>AfterReturningAdvice：在连接点执行后，再执行横切逻辑。</li>
<li>AfterAdvice：一般由程序自己实现，当抛出异常后，执行横切逻辑。</li>
<li>AroundAdvice：Spring AOP中并没有提供这个接口，而是采用了AOP Alliance的MethodInteceptor接口；通过看AfterReturningAdvice的源码我们知道，它是不能更改连接点所在方法的返回值的(更改引用)；但使用的MethodInteceptor，所有的事情，都不在话下。</li>
</ul>
<p>在上面的类图中，还有两种类没有介绍，那就是/<em>/</em>/<em>AdviceAdapter和/</em>/<em>/</em>AdviceInteceptor，我们以AfterReturningAdviceInterceptor为例来说明：</p>
<p><img src="" alt=""></p>
<p>该类实现了MethodInterceptor和AfterAdvice接口，同时构造函数中还有一个AfterReturningAdvice实例的参数；这个类存在的作用是为了什么呢？对，没错，Spring AOP把所有的Advice都适配成了MethodInterceptor，统一的好处是方便后面横切逻辑的执行(参看下一节)，适配的工作即由/<em>/</em>/*AdviceAdapter完成；</p>
<p>哈哈，Spring AOP的代码也不过如此嘛：所谓的AfterReturningAdvice，通过适配成MethodInterceptor后，其实就是在invoke方法中，先执行目标对象的方法，再执行的AfterReturningAdvice所定义的横切逻辑。你现在明白它为什么不能修改返回值的引用了吧？</p>
<p>对于per-instance的Advice，目前只有一种实现，就是Introduction，使用的场景比较少，有兴趣的同学可以自己研究一下，呵呵！</p>
<ol>
<li>切面(Aspect)：在Spring中，Advisor就是切面；但与通常的Aspect不同的是，Advisor通常只有一个Pointcut和一个Advice，而Aspect则可以包含多个Pointcut和多个Advice，因此Advisor是一种特殊的Aspect。但，这已经够用了！</li>
</ol>
<p>接下来看下per-class Advisor的类图：</p>
<p><img src="" alt=""></p>
<p>其实没有什么好看的，前面已经说过，Advisor包含一个Pointcut和一个Advisor；在AbstractGenericPointcutAdvisor中，持有一个Advice的引用；下面的几个实现，均是针对前面提到的几种不同的Pointcut的实现。</p>
<p><strong>3.3 Spring AOP实现的基本线索
</strong></p>
<p>我们选择ProxyFactoryBean作为入口点和分析的开始。ProxyFactoryBean是在Spring IoC环境中，创建AOP应用的最底层方法，从中，可以看到一条实现AOP的基本线索。</p>
<p>所有的逻辑从以下的方法开始,我们主要针对单例的代理对象的生成：</p>
<p><img src="" alt=""></p>
<p>下面我们深入到SpringAOP核心代码的内部，看看代理对象的生成机制，拦截器横切逻辑以及织入的实现。</p>
<p><strong>3.4  代理对象的生成
</strong></p>
<p>对于getSingletonInstance()方法返回了什么，这就是代理对象如何产生的逻辑了，然我们须根溯源，看看传说中的proxy到底是如何一步一步的产生的。</p>
<p><img src="" alt=""></p>
<p>ProxyFactoryBean是AdvisedSupport的子类，Spring使用AopProxy接口把AOP代理的实现与框架的其他部分分离开来。在AdvisedSupport中通过这样的方式来得到AopProxy,当然这里需要得到AopProxyFactory的帮助 ，从JDK或者cglib中得到想要的代理对象：</p>
<p><img src="" alt=""></p>
<p>这个DefaultAopProxyFactory是Spring用来生成AopProxy的地方，它包含JDK和Cglib两种实现方式。让我接着往里面看：</p>
<p><img src="" alt=""></p>
<p>可以看到其中的代理对象可以由JDK或者Cglib来生成，JdkDynamicAopProxy类和Cglib2AopProxy都实现的是AopProxy的接口，我们进入JdkDynamicAopProxy实现中看看Proxy是怎样生成的：</p>
<p><img src="" alt=""></p>
<p>用Proxy包装target之后，通过ProxyFactoryBean得到对其方法的调用就被Proxy拦截了， ProxyFactoryBean的getObject()方法得到的实际上是一个Proxy了，target对象已经被封装了。对 ProxyFactoryBean这个工厂bean而言，其生产出来的对象是封装了目标对象的代理对象。</p>
<p><strong>3.5 拦截器的作用
</strong></p>
<p>前面分析了SpringAOP实现中得到Proxy对象的过程，接下来我们去探寻Spring AOP中拦截器链是怎样被调用的，也就是Proxy模式是怎样起作用的。
还记得在JdkDynamicAopProxy中生成Proxy对象的时候，有一句这样的代码吗？</p>
<p><strong>return</strong> Proxy.<em>newProxyInstance</em>(classLoader, proxiedInterfaces, <strong>this</strong>);<em>**</em></p>
<p>这里我们的JdkDynamicAopProxy实现了InvocationHandler这个接口，this参数对应的是InvocationHandler对象,也就是说当 Proxy对象的函数被调用的时候，InvocationHandler的invoke方法会被作为回调函数调用：</p>
<p><img src="" alt=""></p>
<p><img src="" alt=""></p>
<p>上面所说的目标对象方法的调用，是通过AopUtils的方法调用，使用反射机制来对目标对象的方法进行的：</p>
<p><img src="" alt=""></p>
<p>接下来，我们来看具体的ReflectiveMethodInvocation中proceed()方法的实现，也就是拦截器链的实现机制：</p>
<p><img src="" alt=""></p>
<p>从上面的分析我们看到了Spring AOP拦截机制的基本实现，比如Spring怎样得到Proxy，怎样利用JAVA Proxy以及反射机制对用户定义的拦截器链进行处理。</p>
<p><strong>3.6 织入的实现
</strong></p>
<p>在上面调用拦截器的时候，经过一系列的注册，适配的过程以后，拦截器在拦截的时候，会调用到预置好的一个通知适配器，设置通知拦截器，这是一系列Spring设计好为通知服务的类的一个，是最终完成通知拦截和实现的地方，例如对 MethodBeforeAdviceInterceptor的实现是这样的：</p>
<p><img src="" alt=""></p>
<p>可以看到通知适配器将advice适配成Interceptor以后，会调用advice的before方法去执行横切逻辑。这样就成功的完成了before通知的织入。</p>
<p><a href="http://www.goldendoc.org/tag/aop/" title="AOP (1主题)" target="_blank">AOP</a></p>
<h2 id="-spring-ioc-applicationcontext-http-www-goldendoc-org-2010-11-spring_ioc_applicationcontext-2-spring-ioc-applicationcontext-"><a href="http://www.goldendoc.org/2010/11/spring_ioc_applicationcontext-2/" title="永久链接：Spring IoC之ApplicationContext" target="_blank">Spring IoC之ApplicationContext</a></h2>
<p><a href="http://www.goldendoc.org/2010/11/spring_ioc_applicationcontext-2/#comments" target="_blank">0</a></p>
<p>2年前</p>
<p>由<a href="http://www.goldendoc.org/author/iwlh/" title="iwlh发表的文章 " target="_blank">iwlh</a>发布 在<a href="http://www.goldendoc.org/category/spring/" title="Spring (4主题)" target="_blank">Spring</a>
本章主要讲ApplicationContext接口对BeanFactory接口的扩展内容。BeanFactory接口主要围绕着bean和bean相关配置方式，没有关注应用环境的相关配置。ApplicationContext接口从BeanFactory接口派生而来，它与BeanFactory的对比如下图所示：</p>
<p>BeanFactory </p>
<p>ApplicationContext  Bean配置/实例化</p>
<p>Yes </p>
<p>Yes  自动装配BeanPostProcessor</p>
<p>No </p>
<p>Yes  自动装配BeanFactoryPostProcessor</p>
<p>No </p>
<p>Yes  国际化信息（MessageSources）支持</p>
<p>No </p>
<p>Yes  容器内部事件（ApplicationEvent）支持</p>
<p>No </p>
<p>Yes  多配置模块加载</p>
<p>No </p>
<p>Yes </p>
<p><strong>1、统一资源加载
</strong></p>
<p>Spring中提供了org.springframework.core.io.Resource接口作为所有资源的抽象。Spring中默认提供了一些Resource接口的实现类，如图所示：</p>
<p><img src="" alt=""></p>
<p>实现类命名上就可以看出对应的资源，比如ClassPathResource类是从java应用程序的ClassPath中加载相关资源等等。</p>
<p>Spring中使用ResourceLoader来查找和定位Resource资源。ResorceLoader接口类图如下所示：</p>
<p><img src="" alt=""></p>
<p>从上图可以看出，ApplicationContext接口继承自ResourceLoader接口。AbstractApplicationContext抽象类也继承自DefaultResourceLoader类，而且还拥有一个PathMatchingResourcePatternResolver属性字段，需要加载多个Resource时候，委派给PathMatchingResourcePatternResolver类加载即可。</p>
<p>回过来，让我们再看下DefaultResourceLoader中getResource方法的实现代码。</p>
<p><img src="" alt=""></p>
<p>可以看到getResource方法尝试了classPath、url方式加载资源。需要注意的是，该类不能加载相对路径或绝对路径下的资源（例如文件），如果需要加载绝对路径的资源，可以使用FileSystemResourceLoader对象。</p>
<p><strong>2、国际化信息支持
</strong></p>
<p>Java SE中已经有了国际化支持，也就是java.util.Locale和java.util.ResourceBundle。Spring在JavaSE的国际化支持上，进一步抽象了国际化信息的访问接口，提供了org.springframework.context.MessageSource接口，该接口提供一下方法：</p>
<p><img src="" alt=""></p>
<p>ApplicationContext也实现了MessageSource接口。当ApplicationContext初始化时，它会自动在容器中查找名称为”messageSource”的bean。如果找到，对上述方法的调用将被委托给该bean。否则ApplicationContext会在其父类中查找是否含有同名的bean。如果有，就把它作为MessageSource。如果它最终没有找到任何的消息源，一个空的StaticMessageSource将会被实例化，使它能够接受上述方法的调用。messageSource bean的配置实例如下：</p>
<p><img src="" alt=""></p>
<p>Spring提供了三种MessageSource的实现。即StaticMessageSource（提供简单实现，可通过编程方式添加信息条目，多用于测试，不应该用于正式的生产环境）、ResourceBundleMessageSource（基于标准的java.util.ResourceBundle而实现的MessageSource，对父类AbstractMessageSource进行扩展，提供对多个ResourceBundle的缓存以提高查询速度。是最常用的，可用于生产环境下的MessageSource）、ReloadableResourceBundleMessageSource（同样是基于标准的java.util.ResourceBundle而实现的MessageSource，通过cacheSeconds属性可以定期刷新并检查properties资源文件是否发生变化，并且通过ResourceLoader加载properties资源文件。）</p>
<p>另外，MessageSourceAware接口还能用于获取任何已定义的MessageSource引用。任何实现了MessageSourceAware接口的bean将在Spring容器初始化时候与MessageSource一同被注入。</p>
<p>MessageSource与ApplicationContext的类结构图如下所示：</p>
<p><img src="" alt=""></p>
<p><strong>3、Spring容器内部事件发布
</strong></p>
<p>ApplicationContext容器提供了容器内部事件发布功能，是继承自JavaSE标准自定义事件类而实现的。</p>
<p>JavaSE标准自定义事件结构不在此详细描述，一张图很直观的描述清楚：</p>
<p><img src="" alt=""></p>
<p>EventObject，为JavaSE提供的事件类型基类，任何自定义的事件都继承自该类，例如上图中右侧灰色的各个事件。Spring中提供了该接口的子类ApplicationEvent。</p>
<p>EventListener，为JavaSE提供的事件监听者接口，任何自定义的事件监听者都实现了该接口，如上图左侧的各个事件监听者。Spring中提供了该接口的子类ApplicationListener接口。</p>
<p>JavaSE中未提供事件发布者这一角色类， 由各个应用程序自行实现事件发布者这一角色。Spring中提供了ApplicationEventPublisher接口作为事件发布者，并且ApplicationContext实现了这个接口，担当起了事件发布者这一角色。但ApplicationContext在具体实现上有所差异，Spring提供了ApplicationEventMulticaster接口，负责管理ApplicationListener和发布ApplicationEvent。ApplicationContext会把相应的事件相关工作委派给ApplicationEventMulticaster接口实现类来做。类图如下所示：</p>
<p><img src="" alt=""></p>
<p>附上一张事件发布的时序图：</p>
<p><a href="http://pic.yupoo.com/goldendoc/AH0MxsWp/jBIbm.png" target="_blank"><img src="" alt=""></a></p>
<p><strong>4、多配置模块加载
</strong></p>
<p>现在的应用程序，一般都会把配置信息按照某些规则进行分割，将不同类型或关注点的配置项放置在不同的文件中。相对BeanFactory来说，ApplicationContext已经支持了加载多个配置文件。</p>
<p>ApplicationContext加载多个配置文件的方法有：</p>
<p>1) 数组方式</p>
<p>String[] locations = new String[]{ “conf/bean1.xml”,”conf/bean2.xml”, “conf/bean3.xml”};</p>
<p>ApplicationContext container = new FileSystemXmlApplicationContext(locations);</p>
<p>2) 通配符</p>
<p>ApplicationContext container = new FileSystemXmlApplicationContext(“conf//<em>/</em>//*.xml”);</p>
<p>3) ClassPathXmlApplicationContext特性</p>
<p>ApplicationContext ctx = new ClassPathXmlApplicationContext(new String[] {“services.xml”, “daos.xml”}, MessengerService.class);</p>
<p>该方法可以通过MessengerService类在ClassPath中的位置定位配置文件，而不用指定每个配置文件的完整路径名。</p>
<p><a href="http://www.goldendoc.org/tag/applicationcontext/" title="ApplicationContext (1主题)" target="_blank">ApplicationContext</a></p>
<h2 id="-spring-ioc-beanfactory-http-www-goldendoc-org-2010-11-spring-ioc-e4-b9-8bbeanfactory-spring-ioc-beanfactory-"><a href="http://www.goldendoc.org/2010/11/spring-ioc%e4%b9%8bbeanfactory/" title="永久链接：Spring IoC之BeanFactory" target="_blank">Spring IoC之BeanFactory</a></h2>
<p><a href="http://www.goldendoc.org/2010/11/spring-ioc%e4%b9%8bbeanfactory/#comments" target="_blank">0</a></p>
<p>2年前</p>
<p>由<a href="http://www.goldendoc.org/author/khotyn/" title="khotyn发表的文章 " target="_blank">khotyn</a>发布 在<a href="http://www.goldendoc.org/category/spring/" title="Spring (4主题)" target="_blank">Spring</a>
本文的内容为对Spring IoC容器实现的分析。</p>
<p>本文一共分为5个部分：</p>
<ul>
<li>第一部分简要讲述了IoC的概念</li>
<li>第二部分对Spring IoC容器中的主要类及其职责做一些了解</li>
<li>第三部分分析了Spring IoC容器的初始化过程</li>
<li>第四部分分析了从Spring IoC容器中获取Bean的过程</li>
<li>第五部分简要讲述了Spring IoC容器对Bean生命周期的管理。</li>
</ul>
<p>本文假设读者对以下的概念有所了解：IoC（控制反转），DI（依赖注入），Bean，并且读者有使用Spring IoC容器的经验。</p>
<p>约定：本文中所指的IoC容器没有特别说明均为Spring IoC容器</p>
<h3 id="-ioc-"><a href="">一、什么是</a><a href="">IoC</a><a href=""></a></h3>
<p><a href=""></a></p>
<p><a href="">IoC是Inversion of Control的缩写，中文的意思是控制反转，在IoC中，组件不需要去寻找它所依赖的对象，而是由IoC容器来负责将组件所依赖的对象通过Java Bean的Setter方法或者是构造函数等方式注入给组件。IoC的另一个名字是DI，即依赖注入，关于IoC和DI之间的关系以及关于IoC的更多内容，大家可以参考Wiki上的</a><a href="http://www.google.com/url?q=http%3A%2F%2Fzh.wikipedia.org%2Fzh%2F%E6%8E%A7%E5%88%B6%E5%8F%8D%E8%BD%AC&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNGHDFZSBvJ9wlCDET_IgqV-4DVCzw">控制反转条目。
</a></p>
<p><a href="http://www.google.com/url?q=http%3A%2F%2Fzh.wikipedia.org%2Fzh%2F%E6%8E%A7%E5%88%B6%E5%8F%8D%E8%BD%AC&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNGHDFZSBvJ9wlCDET_IgqV-4DVCzw">
</a></p>
<h3 id="-http-www-google-com-url-q-http-3a-2f-2fzh-wikipedia-org-2fzh-2f-e6-8e-a7-e5-88-b6-e5-8f-8d-e8-bd-ac-sa-d-sntz-1-usg-afqjcnghdfzsbvj9wlcdet_igqv-4dvczw-ioc-"><a href="http://www.google.com/url?q=http%3A%2F%2Fzh.wikipedia.org%2Fzh%2F%E6%8E%A7%E5%88%B6%E5%8F%8D%E8%BD%AC&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNGHDFZSBvJ9wlCDET_IgqV-4DVCzw"></a>[二、IoC容器中的类主要类及其职责</h3>
<p>]()</p>
<p><a href="">
我们先来看下IoC容器的一个大概的类图：
</a></p>
<p><a href=""></a><a href="http://www.google.com/url?q=http%3A%2F%2Fpic.yupoo.com%2Fkhotyn%2F816909ab9c75%2Fji8tx5ue.jpg&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNEixIuYlet6oZmgnSPQy-ZxrCs4yA"><img src="" alt=""></a></p>
<p><a href="http://www.google.com/url?q=http%3A%2F%2Fpic.yupoo.com%2Fkhotyn%2F816909ab9c75%2Fji8tx5ue.jpg&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNEixIuYlet6oZmgnSPQy-ZxrCs4yA" target="_blank">点击查看大图</a></p>
<p>这张图中比较简单的展示了IoC容器中的各个类及其指责，我们需要重点把握几个接口的职责：</p>
<ul>
<li>BeanFactory：这个接口是整个IoC容器最底层的接口，定义了一组访问Bean容器的基本方法。一些其他的接口，比如ListableBeanFactory和ConfigurableBeanFactory，都是继承了BeanFactory，并添加了其他的方法来完成某些特别的功能（比如ConfigurableBeanFactory，顾名思义，这个接口的职责是让BeanFactory变得可配置，那么它就定义了一组可以配置BeanFactory的方法）。</li>
<li>AbstractBeanFactory：从名字可以看出，这个类是BeanFactory接口的一个抽象实现类，这个类本身实现的是ConfigurableBeanFactory，对ConfigurableBeanFactory以及BeanFactory中的方法提供了实现，并且提供了一些诸如单例缓存，别名等等功能。</li>
<li>SingletonBeanRegistry：定义了一组操作单例Bean的方法</li>
</ul>
<h3 id="-ioc-"><a href="">三、</a>[IoC容器的初始化</h3>
<p>]()<a href=""></a></p>
<p>[
使用过Spring的人都知道，我们都是在一份Bean配置文件中定义Bean，然后就可以通过BeanFactory的getBean()方法来获取Bean，那么我们就可以大致猜想到IoC容器的初始化工作大概就是将我们编写的Bean配置文件转换成IoC容器内部定义的用于放置Bean定义信息的数据结构，而这个数据结构就是BeanDefinition这个类。下面我们就来了解下这个转换过程是如何进行的。</p>
<p>我们通过实例化ClassPathXmlApplicationContext这个类来一步步来看其初始化的过程，简单地实例化ClassPathXmlApplicationContext的代码如下：</p>
<p><img src="" alt=""></p>
<p>这里我们传入一个beans.xml作为配置文件的路径去实例化一个ClassPathXmlApplicationContext。</p>
<p>首先我们还是来看下整个初始化过程的序列图：
]()</p>
<p><a href=""></a><a href="http://www.google.com/url?q=http%3A%2F%2Fpic.yupoo.com%2Fkhotyn%2F005389ab9c75%2Fogfhmraj.jpg&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHa07fld9fiZq1BzNzeljU3nfHFXQ"><img src="" alt=""></a></p>
<p><a href="http://www.google.com/url?q=http%3A%2F%2Fpic.yupoo.com%2Fkhotyn%2F005389ab9c75%2Fogfhmraj.jpg&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHa07fld9fiZq1BzNzeljU3nfHFXQ" target="_blank">点击查看大图</a></p>
<p>这个图中涉及到的类或许有点吓人，且慢，下面我会慢慢带你了解整个过程。从序列图里面我们看到初始化过程首先调用了refresh()方法，后面调用到了AbstractXmlApplicationContext的loadBeanDefinitions方法，来看下这个方法的实现：</p>
<p><img src="" alt=""></p>
<p>这个方法将beanFactory（实现了BeanDefinitionRegistry接口，后续将通过这个接口将Bean定义信息注册到BeanFactory中去）传入new了一个XmlBeanDefinitionReader对象，然后将刚刚new出来的beanDefinitionReader传入调用loadBeanDefinitions方法，最终调用了XmlBeanDefinitionReader的loadBeanDefinitions(EncodedResource encodedResource)方法：</p>
<p><img src="" alt=""></p>
<p>这个方法获取了Bean配置文件的输入流，并且调用了doLoadBeanDefinitions方法，在这个方法里面，程序将输入流转换成Document对象，然后调用了下面这个方法：</p>
<p><img src="" alt=""></p>
<p>需要注意这个createReaderContext(resource)方法，创建这个方法的时候XmlBeanDefinitionReader将自己传入，以便在后面可以获取到它的Registry对象。最终DefaultBeanDefinitionDocumentReader将解析BeanDefinition的工作又交给了BeanDefinitionParserDelegate对象：</p>
<p><img src="" alt=""></p>
<p>从上面的方法中，我们可以看到BeanDefinitionParserDelegate对象解析出BeanDefinition后，就由BeanDefinitionRegistry来将BeanDefinition注册到BeanFactory中去了。</p>
<p>至此，整个BeanFactory就初始化完毕了，可能一大堆方法调来调去地早就把大家给调晕了，我们就来总结下初始化过程中设计到的几个主要的类以及它们的职责吧：</p>
<ul>
<li>XmlBeanDefinitionReader：读取定义Bean的XML文件并且将XML文件转成Document对象，交给BeanDefinitionDocuementReader再做解析。它持有一个BeanDefinitionRegistry对象，用于将BeanDefinition注册到BeanFactory中去。</li>
<li>XmlBeanDefinitionDocumentReader：取出Docuement对象内的各个元素并将这些元素交给BeanDefinitionParserDelegate来解析。</li>
<li>BeanDefinitionParserDelegate：用于解析Bean定义信息的代理类，负责一个Bean定义信息（可以看作是一个<bean></bean>标签对）解析成一个BeanDefinition对象。</li>
<li>BeanDefinitionRegister：负责将BeanDefinition注册到BeanFactory中去。</li>
</ul>
<h3 id="-ioc-bean-"><a href="">四、从</a><a href="">IoC容器中获取Bean</a><a href=""></a></h3>
<p><a href="">
用过Spring的人大概都知道，在Spring中，我们是通过调用BeanFactory的getBean()方法来取得我们所需要的Bean的，而getBean()方法的主要逻辑在AbstactBeanFactory的doGetBean()方法中。在Spring中，有单例Bean和原型Bean的区分，在从容器中获取Bean的时候，单例Bean和原型Bean有些不同，当第一次获取单例Bean的时候，整个过程和获取原型Bean几乎是一样的，都需要创建一个Bean，但是当第二次，第三次，……，获取同样的单例Bean的时候，容器就直接从单例缓存中获取Bean了，而不会再去像获取原型Bean一样一而再再而三地创建Bean了。这样我们这一节也主要从两个方面来讲，一个是获取原型Bean，第一次获取单例Bean的逻辑和这个类似，有特别的地方也会在这里顺带提到，二则是将从单例缓存中获取单例Bean的过程，首先我们来看获取原型Bean：
</a></p>
<h3 id="-4-1-bean"><a href=""></a>[4.1、获取原型Bean</h3>
<p>]()</p>
<p>[
正如前面所说，我们来看下AbstractBeanFactory的doGetBean()方法来了解获取原型Bean的整个过程。</p>
<p>在获取Bean的时候，无论这个Bean是单例的还是原型的，Spring都会尝试从单例缓存中获取Bean，但是当拿原型Bean的时候，这里显然是拿不到的，接下来程序就会根据BeanDefinition信息来判断要创建的Bean是不是原型Bean，如果是，则进入下面这段逻辑：</p>
<p><img src="" alt=""></p>
<p>程序在上图的（1）中的位置调用了beforePrototypeCreation方法，告诉容器当前的这个Bean正在创建中，来防止发生重复创建的情况。接下来，程序在（2）处调用了createBean方法来创建这个prototypeBean，最后，在（3）处，程序调用afterProtytypeCreation来告诉容器，这个Bean现在已经不再创建过程中了。</p>
<p>那么，让我们来关注下createBean这个方法里面干了些什么事情：</p>
<p><img src="" alt=""></p>
<p>在做了一堆准备工作后，程序就到了上面的这一段中，从代码中我们可以看出这个方法主要的功能为以下两点：</p>
<ul>
<li>调用resolveBeforeInstantiation方法，让BeanPostProcessor可以有机会给你返回一个代理类而不是原来的类，当后面我们看到Spring AOP代理类的生成的时候，就会看到这个方法的用处了。</li>
<li>调用doCreateBean()方法创建Bean</li>
</ul>
<p>我们再来看下doCreateBean方法：</p>
<p><img src="" alt=""></p>
<p>同样，这个方法里面也有两个主要的功能：</p>
<ul>
<li>一是调用createBeanInstance方法，创建一个Bean实例，在这个方法的内部，会调用BeanUtils的instantiateClass来实例化Bean，并把它包装成一个BeanWrapper</li>
<li>二是调用populateBean方法来将Bean依赖的属性设置进去。
]()</li>
</ul>
<h3 id="-4-2-bean"><a href=""></a>[4.2、创建单例Bean</h3>
<p>]()</p>
<p>[
整个获取原型Bean的过程大概就是这样样子，因为创建单例Bean和这个过程基本上是一样的，但是也有一些稍微不一样的地方，这里也稍微提到一下：</p>
<p><img src="" alt=""></p>
<p>创建单例Bean是通过调用getSingleton来实现的，这个方法传入一个beanName和一个ObjectFactory，这个ObjectFactory的getObject方法里面调用到了我们前面提到的createBean方法，所以我们看下getSingleton这个方法的实现：</p>
<p><img src="" alt=""></p>
<p>这个方法先尝试从singletonObjects中获取单例Bean，如果获取不到，则自己创建，同样，和创建原型Bean一样，在创建开始之前会调用beforeSingletonCreation方法来将beanName放到singletonsCurrentlyInCreation来告诉容器这个Bean已经在创建中了，在创建完成之后，会将BeanName从singletonsCurrentlyInCreation中删除掉。创建的过程是调用了传入的ObjectFactory的getObject方法，和创建原型Bean类似。在创建完成之后，还有一步addSingleton的操作，来讲单例放到单例缓存中去，看一下这个的实现：</p>
<p><img src="" alt=""></p>
<p>方法的逻辑非常简单：把创建出来的单例Bean放到singletonObjects中去，然后从singletonFactories和earlySingletonObjects中删除掉，最后在registeredSingletons里面再加入这个Bean，对于这里面用到的几个容器，我觉得有必要在这里描述一下其作用，要不然读者肯定是晕呼晕呼的：</p>
<ul>
<li>singletonObjects：用于保存BeanName和Bean实例之间的关系</li>
<li>singletonFactories：用于保存BeanName和创建Bean的工厂之间的关系</li>
<li>earlySingletonObjects：也是保存BeanName和Bean实例之间的关系，与singletonObjects的不同之处在于，当一个单例Bean被放到这里面去后，那么当Bean还在创建过程中，就可以通过getBean来拿到了，其目的是用来检测循环引用。</li>
<li>registeredSingletons：用来保存当前所有已注册的Bean
]()</li>
</ul>
<h3 id="-4-3-bean"><a href=""></a>[4.3、从单例缓存中获取单例Bean</h3>
<p>]()</p>
<p>[
单例在Spring的同一个容器内只会被创建一次，后续再获取Bean，就直接从单例缓存中获取了，我们来看下这一段过程，看下doGetBean里面调用的getSingleton方法：</p>
<p><img src="" alt=""></p>
<p>这个方法的逻辑也相对简单，先尝试从singletonObjects里面获取，如果获取不到再从earlySingletonObjects里面获取，如果再获取不到，再尝试从singletonFactories里面获取beanName对应的ObjectFactory，然后调用这个ObjectFactory的getObject来创建Bean，并放到earlySingletonObjects里面去，并且从singletonFacotories里面remove掉这个ObjectFactory。</p>
<h3 id="-ioc-bean-">六、IoC容器对Bean生命周期的管理</h3>
<p>Spring有一套Bean生命周期去管理Bean，值得注意的是，Spring只对非单例的Bean进行生命周期管理。关于Spring中Bean的生命周期，我们来看下一张老图：</p>
<p><img src="" alt=""></p>
<p>在上面这张图里面，我们看到有很多的生命周期方法，那么这些生命周期方法是在哪里调用的呢？在前面获取原型Bean的一节中，我们已经知道，Spring会先调用createBeanInstance方法来创建Bean实例，然后通过populateBean方法来设置Bean的属性，在调用这个方法之后，其实Spring还调用了一个initializeBean的方法，上图中我们看到的生命周期方法基本上都在这个方法里面调用：</p>
<p><img src="" alt=""></p>
<p>在这个方法里面：</p>
<ul>
<li>Spring首先调用了invokeAwareMethods来调用各个Aware方法，包括BeanNameAware，BeanClassLoaderAware和BeanFactoryAware</li>
<li>然后调用了所有BeanPostProcessor的postProcessBeforeInitialization方法</li>
<li>接着调用invokeInitMethods方法，里面包括调用afterPropertiesSet和自定义的init方法</li>
<li>最后调用了所有BeanPostProcessor的postProcessAfterInitialization方法</li>
</ul>
<p>在调用这些方法以后，我们的Bean才算是可以使用啦。至于生命周期的最后两个方法，是在容器销毁的时候来调用的。
]()<a href=""></a></p>
<p><a href=""></a></p>
<p><a href=""></a><a href="http://www.goldendoc.org/tag/beanfactory/" title="BeanFactory (1主题)">BeanFactory</a></p>
<p>*</p>
<ul>
<li><h3 id="-">分类</h3>
</li>
<li><p><a href="http://www.goldendoc.org/category/java-nio/" title="查看 Java NIO下的所有文章" target="_blank">Java NIO <strong>(9)</strong> Java NIO相关内容</a></p>
</li>
<li><a href="http://www.goldendoc.org/category/jms/" title="查看 JMS下的所有文章" target="_blank">JMS <strong>(3)</strong> Java Messaging Service</a></li>
<li><a href="http://www.goldendoc.org/category/juc/" title="查看 JUC下的所有文章" target="_blank">JUC <strong>(4)</strong></a></li>
<li><a href="http://www.goldendoc.org/category/jvm/" title="查看 JVM下的所有文章" target="_blank">JVM <strong>(8)</strong> Java Virtual Machine</a></li>
<li><a href="http://www.goldendoc.org/category/spring/" title="查看 Spring下的所有文章" target="_blank">Spring <strong>(4)</strong></a></li>
<li><a href="http://www.goldendoc.org/category/tomcat/" title="查看 Tomcat下的所有文章" target="_blank">Tomcat <strong>(7)</strong></a></li>
<li><a href="http://www.goldendoc.org/category/translation/" title="查看 翻译下的所有文章" target="_blank">翻译 <strong>(1)</strong></a></li>
<li><h3 id="-">最新评论</h3>
</li>
<li><p><a href="http://www.goldendoc.org/2012/01/optimization-barrier3/#comment-306" title="在 优化屏障（Optimization barrier）第三讲" target="_blank"><img src="" alt="熊猫家族">  熊猫家族 很详细，了解了很多 5个月前</a></p>
</li>
<li><a href="http://www.goldendoc.org/2011/06/juc_concurrenthashmap/#comment-304" title="在 Java并发编程之ConcurrentHashMap" target="_blank"><img src="" alt="聊聊并发（四）深入分析ConcurrentHashMap并发编程网 | 并发编程网">  聊聊并发（四）深入分析ConcurrentHashMap并发编程网 | 并发编程网 [...] Java并发编程之ConcurrentHashMap [...] 6个月前</a></li>
<li><a href="http://www.goldendoc.org/2011/06/juc_concurrenthashmap/#comment-301" title="在 Java并发编程之ConcurrentHashMap" target="_blank"><img src="" alt="Jun">  Jun for (HashEntry p = first; p != e; p = p.next) newFirst = new HashEntry(p.key, p.hash, […] 6个月前</a></li>
<li><a href="http://www.goldendoc.org/2011/06/juc_concurrenthashmap/#comment-294" title="在 Java并发编程之ConcurrentHashMap" target="_blank"><img src="" alt="khotyn">  khotyn 这里是我搞错了，已经纠正过来了，谢谢赵姐夫指正。 7个月前</a></li>
<li><a href="http://www.goldendoc.org/2011/06/juc_concurrenthashmap/#comment-293" title="在 Java并发编程之ConcurrentHashMap" target="_blank"><img src="" alt="老赵">  老赵 这里Segment的数量是不大于concurrentLevel的最大的2的指数 应该是“不小于concurrentLevel”的最小的2的指数吧。 7个月前</a>
<a href="&quot;显示下5个条目&quot;">显示更多</a></li>
<li><h3 id="-">最新文章</h3>
</li>
<li><p><a href="http://www.goldendoc.org/2013/01/parentdelegation/" title="从问题出发看双亲委派" target="_blank">从问题出发看双亲委派 (0)  同事A问了这样一个问题： <em>BootstrapClassLoader为什么能够加载用户自定义的类？</em> 当时我想到的是这样的场景： javaagent设置Boot-Class-Path，或者添加启动参数-Xbootclasspath、-Xbootclasspath/a […] 5个月前</a></p>
</li>
<li><a href="http://www.goldendoc.org/2012/07/somethings_i_ve_learnt_about_programming/" title="我学到的一些关于编程的事儿（翻译）" target="_blank">我学到的一些关于编程的事儿（翻译） (3) 原文地址：Some things I&#39;ve learnt about programming ---- By John Graham-Cumming 我已经从事编程 30 年了，用过的机器包括从现在看来很差的（基于 Z80 和 6502）到最新的，用过的语言包括 […] 11个月前</a></li>
<li><a href="http://www.goldendoc.org/2012/02/classloader-jvm/" title="ClassLoader与JVM" target="_blank">ClassLoader与JVM (0) <strong>一、ClassLoader与HotSpot</strong> 对JVM有所了解的人应该知道，类文件的格式是不能违背JVM规范的，而JVM自然会有解析类文件的工具ClassFileParser。 ClassFileParser由ClassFileStream/*构造，其实 […] 1年前</a></li>
<li><a href="http://www.goldendoc.org/2012/01/optimization-barrier3/" title="优化屏障（Optimization barrier）第三讲" target="_blank">优化屏障（Optimization barrier）第三讲 (1) 上一篇 优化屏障（Optimization barrier）第二讲 1. […] 1年前</a></li>
<li><a href="http://www.goldendoc.org/2012/01/optimization-barrier2/" title="优化屏障（Optimization barrier）第二讲" target="_blank">优化屏障（Optimization barrier）第二讲 (1) 上一篇 优化屏障（Optimization barrier）第一讲 1. gcc编译的大致过程 可以看到，gcc优化主要分两大部分:Tree优化和RTL(Register Transfer Language)优化； 前文所说的指令调度（Instruction […] 1年前</a>
<a href="&quot;显示下5个条目&quot;">显示更多</a></li>
<li><h3 id="-">友情链接</h3>
</li>
<li><p><a href="http://ifeve.com/" target="_blank">并发编程促进并发编程的研究和传播</a>
自豪地使用<a href="http://wordpress.org/" target="_blank">WordPress</a>，Mystique主题来自<a href="http://digitalnature.eu/" target="_blank">digitalnature</a> | <a href="http://www.goldendoc.org/feed/" target="_blank">RSS订阅</a>  <a href="">回到顶部</a></p>
</li>
</ul>
<p><a href=""> </a></p>
<p><a href=""> </a></p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/框架汇总/">框架汇总</a></li></span><span class="breadcrumb"><li><a href="/categories/框架汇总/">框架汇总</a></li><li><a href="/categories/框架汇总/Spring/">Spring</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Spring/" class="label label-primary">Spring</a><a href="/tags/框架汇总/" class="label label-success">框架汇总</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:29"datetime="2014-03-07 09:54:29"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-框架汇总-Spring--Spring-设计模式-aop-ioc/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-框架汇总-Spring--Spring-设计模式-aop-ioc" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>





<ul id="pagination" class="pagination pagination-lg">
  <li><a class="extend prev" href="/page/146/">&laquo;</a></li><li><a class="page-number" href="/">1</a></li><li><a class="page-number" href="/page/2/">2</a></li><li><span class="space">&hellip;</span></li><li><a class="page-number" href="/page/144/">144</a></li><li><a class="page-number" href="/page/145/">145</a></li><li><a class="page-number" href="/page/146/">146</a></li><li class="active"><li><span class="page-number current">147</span></li><li><a class="page-number" href="/page/148/">148</a></li><li><a class="page-number" href="/page/149/">149</a></li><li><a class="page-number" href="/page/150/">150</a></li><li><span class="space">&hellip;</span></li></li><li><a class="page-number" href="/page/161/">161</a></li><li><a class="page-number" href="/page/162/">162</a></li><li><a class="extend next" href="/page/148/">&raquo;</a></li>
  <div class="clearfix"></div>
</ul></div><!--wapper-->
       </div><!-- ID main-col END -->
       <aside id="sidebar" class="alignright col-sx-6 col-sm-4 col-md-3 col-lg-3">
<div id="widget_search" class="widget panel panel-primary">
    <form action="//google.com/search" method="get" accept-charset="utf-8">
  <div class="input-group">
    <input class="form-control" id="searchbox" type="search" name="q" results="0" placeholder="search">
    <span class="input-group-btn">
      <button class="btn btn-default" type="submit">Go!</button>
    </span>
    <input type="hidden" name="q" value="site:itsolife.com">
  </div>
</form>
</div>

<div id="widget_category" class="widget panel panel-primary">
  <div class="panel-heading">category</div>  <div data-src='category' class='ajax_widgets'>正在加载...</div>
</div>

<div id="widget_recent_posts" class="widget panel panel-primary">
  <div class="panel-heading">recent posts</div>  <div data-src='recent_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_tagcloud" class="widget panel panel-primary">
  <div class="panel-heading">tagcloud</div>  <div data-src='tagcloud' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_latest_update_posts" class="widget panel panel-primary">
  <div class="panel-heading">最近更新</div>  <div data-src='latest_update_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_recent_comments" class="widget panel panel-primary">
  <div class="panel-heading">recent comments</div>  

<div class="list-group-item ds-recent-comments" data-num-items="6" data-show-avatars="1" data-show-time="1" data-show-title="1" data-show-admin="1" data-excerpt-length="50"></div>



</div>

</aside>
       <div class="clearfix"></div>
     </div><!-- row END -->
  </div>
  <footer id="footer" class="container">
  <div class="panel panel-info">
  <section id='footer_widget'></section>  <div class="panel-footer">
  <div id="site-info">
    <span class='author'>
  
  &copy; 2014 RobinChia
  
    &nbsp;&nbsp;</span>
  
  <span id='analytics-51la'></span><span id='analytics-google'>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-48559895-1']);
  _gaq.push(['_trackPageview']);
  _js2load.push({src:('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'});
</script></span><span id='analytics-cnzz'>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_5774006'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s17.cnzz.com/stat.php%3Fid%3D5774006%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</span><span id='analytics-baidu'>
<script>
var _hmt = _hmt || [];
_js2load.push({src:"//hm.baidu.com/hm.js?1442f50724afc42380b51f097c43082c"});
</script>
</span>  </div>
  <div id="copyright">Site powered by <a href='http://zespia.tw/hexo/'><strong>hexo</strong></a>  update time: <em>2014-04-07 19:25:40</em></span></div>
</div>
<div class="clearfix"></div>


  </div>
  </footer>
  
        <script src="http://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>        
        <script src="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>        
                
        <script src="http://cdn.bootcss.com/prettify/r298/prettify.min.js"></script>    <script type="text/javascript">
   var lang=["bsh", "c", "cc", "cpp", "cs", "csh", "cyc", "cv", "htm", "html",
    "java", "js", "m", "mxml", "perl", "pl", "pm", "py", "rb", "sh",
    "xhtml", "xml", "xsl"];
   var pretty_base='';
   $('script').each(function(){
	var c = $(this).attr('src');
	if (!c)
	    return;
	if (c.match(/(\/)?prettify(\.min)?\.js/i))
	{
	    var index = c.lastIndexOf('/');
	    if (index != -1)
		pretty_base = c.substr(0,index + 1);
	    return false;
	}
   })
   $('pre code').each(function(){
	var c = $(this).attr('class')
	if (!c)
	    return;
	c = c.match(/\s?(lang\-\w+)/i);
	if (c && lang.indexOf(c[1]) == -1)
	{
	    lang.push(c[1]);
	    $.getScript(pretty_base + c[1] + '.min.js');
	}
   })

    $(window).load(function(){
       $("pre").addClass("prettyprint");
       prettyPrint();
    })
</script>    
            <script type="text/javascript">
var duoshuoQuery = {short_name:"robinchia"};
_js2load.push({src:'http://static.duoshuo.com/embed.js',charset:'UTF-8'});
</script>
    
            <!--wumii_relatedItems-->
    
        <script src="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>    <script type="text/javascript">
(function($){
  $('.entry').each(function(i){
    $(this).find('img').each(function(){
      var alt = this.alt;

      if (alt){
        $(this).before('<span class="caption">' + alt + '</span>');
      }

      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="fancybox' + i + '" />');
    });
  });

  $('.fancybox').fancybox();
})(jQuery);
</script>    
        <script src="http://cdn.bootcss.com/mathjax/2.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>
    
<script type="text/javascript">
$('.ajax_widgets').each(function(){var src=$(this).attr('data-src');if(src)$(this).load('/widgets/'+src+'.html');});
$.each(_js2load,function(index,obj){loadjs(obj.src,obj.charset)});
</script>

<div id="scroll2top">
<img src="/scroll2top/arrow.png"/>
</div>
<script src="/scroll2top/scroll2top.min.js"></script>
<div id="winterland">
  <canvas></canvas>
</div>
<script src="/js/winterland.min.js"></script>

  </body>
</html>
