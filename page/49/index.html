
<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>The 49 Page | It so life</title>
<meta name="author" content="RobinChia">

<meta name="description" content="It so life">


<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta property="og:site_name" content="It so life"/>

<!--[if IE]><style>.testIE.IE{display:inline;}</style><![endif]-->
<!--[if lte IE 7]><link rel="stylesheet" href="/css/ie7.css" type="text/css"><![endif]-->
<!--[if (lt IE 9)&(gt IE 7)]><style>.testIE.IE8{display:inline;}</style><![endif]-->
<!--[if gt IE 8]><style>.testIE.IE9{display:inline;}</style><![endif]-->

<link href="/favicon.png" rel="icon">
<link rel="alternate" href="/atom.xml" title="It so life Feed" type="application/atom+xml">

<link rel="stylesheet" href="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/font-awesome/4.0.3/css/font-awesome.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/prettify/r298/prettify.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" type="text/css">
<link rel="stylesheet" href="/css/style.css" type="text/css">
<!--[if lt IE 9]>
   <style>article,aside,dialog,footer,header,section,footer,nav,figure,menu{display:block}</style>
   <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
   <script src="http://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
<link href="http://cdn.staticfile.org/respond.js/1.4.2/respond-proxy.html" id="respond-proxy" rel="respond-proxy" />
<link href="/js/respond.proxy.gif" id="respond-redirect" rel="respond-redirect" />
<script src="/js/respond.proxy.js"></script>
   <script src="http://cdn.bootcss.com/selectivizr/1.0.2/selectivizr-min.js"></script>
<![endif]-->
<script type="text/javascript">
function loadjs(c,d){var a=document.createElement("script");a.async=!0;a.type="text/javascript";a.src=c;a.charset=d||"gbk";(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(a)};
var _protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
var _js2load = [];
</script>

</head>
<body>
      <header id="header" class="container"><nav id="main-nav" class="navbar navbar-default navbar-fixed-top " role="navigation">
  <div class="container">
    <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/">It so life</a>
    </div>
    <div  class="collapse navbar-collapse">
      <ul  class="nav navbar-nav">
  
        <li><a href="/" title="Home">Home</a></li>      
        <li><a href="/about/" title="About">About</a></li>      
        <li><a href="/archives/" title="Archives">Archives</a></li>      
      <li class='dropdown'>
        <a class='dropdown-toggle' data-toggle='dropdown' href='#'>website<b class='caret'></b></a>
        <ul class='dropdown-menu pure-menu-selected'>
    
          <li><a href="//groups.google.com/forum/#!forum/pongba" title="TopLanguage">TopLanguage</a></li>    
          <li><a href="//itpub.net/" title="ITPub">ITPub</a></li>    
          <li><a href="//blog.jobbole.com/" title="Bole">Bole</a></li>    
          <li><a href="//nosql-database.org/" title="nosql">nosql</a></li>    
          <li><a href="//gitimmersion.googol.im/" title="Git">Git</a></li>    
        </ul>
      </li>
    
      </ul>
      <ul class="nav navbar-nav navbar-right">
      
        <li><a href="/atom.xml">RSS</a></li>
      
      
        <li><a href="https://twitter.com/robinchia">twitter</a></li>
      
      
      
      
        <li><a href="https://github.com/robinchia">github</a></li>
      
      </ul>
    </div>
  </div>
</nav>
<div class="clearfix"></div>
</header>
  <div id='content' class="container">
     <div class="page-header-wrapper">
      <!--[if lt IE 9]><div class="alert alert-warning alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>提示:</strong>您的浏览器版本太低了,建议升级到 <strong><a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" title="IE9">IE9</a></strong> 以上,本站使用<a href="https://www.google.com/intl/zh-CN/chrome/">Chrome浏览器</a>可以获得最好的显示效果.</div><![endif]-->
      <div class="page-header"><h1 align="center"><big>It so life</big> </h1>
        <h5 align="center"><big>love as life</big></h5>
      </div>
     </div>
     <div class="row">
       <div id="main-col" class="alignleft col-sx-12 col-sm-8 col-md-9 col-lg-9">
      <section id='header_widget'></section>
          <div id="wrapper"><article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--JVM调优的-标准参数-的各种陷阱/">JVM调优的</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:42.000Z"> <a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--JVM调优的-标准参数-的各种陷阱/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="jvm-">JVM调优的&quot;标准参数&quot;的各种陷阱</h1>
<p><a href="http://hllvm.group.iteye.com/login" title="登录" target="_blank">您还未登录 !</a> <a href="http://hllvm.group.iteye.com/login" target="_blank">登录</a> <a href="http://hllvm.group.iteye.com/signup" target="_blank">注册</a></p>
<p><a href="http://www.iteye.com/" target="_blank"><img src="&quot;ITeye-最棒的软件开发交流社区&quot;" alt="ITeye3.0"></a></p>
<p><a href="http://www.iteye.com/groups" target="_blank">群组首页</a> → <a href="http://hllvm.group.iteye.com/groups/category/language" target="_blank">编程语言</a> → <a href="http://hllvm.group.iteye.com/" target="_blank">高级语言虚拟机</a> → <a href="http://hllvm.group.iteye.com/group/forum" target="_blank">论坛</a></p>
<p><img src="" alt=""> <a href="http://hllvm.group.iteye.com/group/topic/27945/post/new" target="_blank">发表回复</a></p>
<p>« 上一页 1 <a href="http://hllvm.group.iteye.com/group/topic/27945?page=2" target="_blank">2</a> <a href="http://hllvm.group.iteye.com/group/topic/27945?page=3" target="_blank">3</a> <a href="http://hllvm.group.iteye.com/group/topic/27945?page=2" target="_blank">下一页 »</a></p>
<h3 id="-http-hllvm-group-iteye-com-group-forum-tag_id-690-jvm-"><a href="http://hllvm.group.iteye.com/group/forum?tag_id=690" target="_blank">[讨论]</a> <a href="">JVM调优的&quot;标准参数&quot;的各种陷阱</a></h3>
<p><a href="http://rednaxelafx.iteye.com/" target="_blank"><img src="&quot;RednaxelaFX的博客: Script Ahead, Code Behind&quot;" alt="RednaxelaFX的博客"></a> <a href="http://rednaxelafx.iteye.com/" title="RednaxelaFX" target="_blank">RednaxelaFX</a> 2011-10-23</p>
<p>开个帖大家来讨论下自己遇到过的情况吧？我在顶楼举几个例子。
开这帖的目的是想让大家了解到，所谓“标准参数”是件很微妙的事情。确实有许多前辈经过多年开发积累下了许多有用的调优经验，但向他们问“标准参数”并照单全收是件危险的事情。
前辈们提供的“标准参数”或许适用于他们的应用场景，他们或许也知道这些参数里隐含的陷阱；但听众却不一定知道各种参数背后的缘由。
原则上说，在生产环境使用非标准参数（这里指的是在各JDK/JRE实现特有的、相互之间不通用的参数）应该尽量避免。这些参数与具体实现密切相关，不是光了解很抽象的“JVM原理”就足以理解的；即便在同一系列的JDK/JRE实现中，非标准参数也不保证在各版本间有一样的作用；而且许多人只看名字就猜想参数的左右，做“调优”却适得其反。
非标准参数的默认值在不同版本间或许会悄然发生变化。这些变化的背后多半有合理的理由。设了一大堆非标准参数、不明就里的同学在升级JDK/JRE的时候也容易掉坑里。
下面用<strong>Oracle/Sun JDK 6</strong>来举几个例子。这帖顶楼里的讨论如果没明确指出JDK版本的都是指Oracle/Sun JDK 6（OpenJDK 6也可以算在内）。</p>
<h1 id="-sun-jdk-1-4-2-sun-jdk-5-oracle-jdk-7-">经验不一定适用于Sun JDK 1.4.2、Sun JDK 5、Oracle JDK 7。</h1>
<p>0、各参数的默认值
在讨论HotSpot VM的各参数的陷阱前，大家应该先了解HotSpot VM到底有哪些参数可以设置，这些参数的默认值都是什么。
有几种办法可以帮助大家获取参数的信息。首先为了大致了解都有些什么参数可以设置，可以参考HotSpot VM里的各个globals.hpp文件：（以下链接取自HotSpot 20.0，与JDK 6 update 25对应）
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/share/vm/runtime/globals.hpp" target="_blank">globals.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/share/vm/runtime/globals_extension.hpp" target="_blank">globals_extension.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/share/vm/c1/c1_globals.hpp" target="_blank">c1_globals.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/os/linux/vm/c1_globals_linux.hpp" target="_blank">c1_globals_linux.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/os/solaris/vm/c1_globals_solaris.hpp" target="_blank">c1_globals_solaris.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/cpu/sparc/vm/c1_globals_sparc.hpp" target="_blank">c1_globals_sparc.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/os/windows/vm/c1_globals_windows.hpp" target="_blank">c1_globals_windows.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/cpu/x86/vm/c1_globals_x86.hpp" target="_blank">c1_globals_x86.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/share/vm/opto/c2_globals.hpp" target="_blank">c2_globals.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/os/linux/vm/c2_globals_linux.hpp" target="_blank">c2_globals_linux.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/os/solaris/vm/c2_globals_solaris.hpp" target="_blank">c2_globals_solaris.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/cpu/sparc/vm/c2_globals_sparc.hpp" target="_blank">c2_globals_sparc.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/os/windows/vm/c2_globals_windows.hpp" target="_blank">c2_globals_windows.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/cpu/x86/vm/c2_globals_x86.hpp" target="_blank">c2_globals_x86.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/share/vm/gc_implementation/g1/g1_globals.hpp" target="_blank">g1_globals.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/os/linux/vm/globals_linux.hpp" target="_blank">globals_linux.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/os_cpu/linux_sparc/vm/globals_linux_sparc.hpp" target="_blank">globals_linux_sparc.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/os_cpu/linux_x86/vm/globals_linux_x86.hpp" target="_blank">globals_linux_x86.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/os_cpu/linux_zero/vm/globals_linux_zero.hpp" target="_blank">globals_linux_zero.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/os/solaris/vm/globals_solaris.hpp" target="_blank">globals_solaris.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/os_cpu/solaris_sparc/vm/globals_solaris_sparc.hpp" target="_blank">globals_solaris_sparc.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/os_cpu/solaris_x86/vm/globals_solaris_x86.hpp" target="_blank">globals_solaris_x86.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/cpu/sparc/vm/globals_sparc.hpp" target="_blank">globals_sparc.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/os/windows/vm/globals_windows.hpp" target="_blank">globals_windows.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/os_cpu/windows_x86/vm/globals_windows_x86.hpp" target="_blank">globals_windows_x86.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/cpu/x86/vm/globals_x86.hpp" target="_blank">globals_x86.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/cpu/zero/vm/globals_zero.hpp" target="_blank">globals_zero.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/share/vm/shark/shark_globals.hpp" target="_blank">shark_globals.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/cpu/zero/vm/shark_globals_zero.hpp" target="_blank">shark_globals_zero.hpp</a>
<a href="http://hg.openjdk.java.net/hsx/hsx20/master/file/f0f676c5a2c6/src/share/vm/runtime/arguments.cpp" target="_blank">arguments.cpp</a>
然后是 <strong>-XX:+PrintCommandLineFlags</strong> 。这个参数的作用是显示出VM初始化完毕后所有跟最初的默认值不同的参数及它们的值。
这个参数至少在Sun JDK 5上已经开始支持，Oracle/Sun JDK 6以及Oracle JDK 7上也可以使用。Sun JDK 1.4.2还不支持这个参数。
例子：
Command prompt代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>$ java -XX:+PrintCommandLineFlags  </li>
<li>VM option &#39;+PrintCommandLineFlags&#39;  </li>
<li><p>-XX:InitialHeapSize=57344000 -XX:MaxHeapSize=917504000 -XX:ParallelGCThreads=4 -XX:+PrintCommandLineFlags -XX:+UseCompressedOops -XX:+UseParallelGC<br>$ java -XX:+PrintCommandLineFlags VM option &#39;+PrintCommandLineFlags&#39; -XX:InitialHeapSize=57344000 -XX:MaxHeapSize=917504000 -XX:ParallelGCThreads=4 -XX:+PrintCommandLineFlags -XX:+UseCompressedOops -XX:+UseParallelGC
<a href="http://book.douban.com/annotation/15146892/" target="_blank">《Java Performance》一书</a>主要是用这个参数来介绍HotSpot VM各参数的效果的。
接着是 <strong>-XX:+PrintFlagsFinal</strong> 。前一个参数只显示跟默认值不同的，而这个参数则可以显示所有可设置的参数及它们的值。不过这个参数本身只从JDK 6 update 21开始才可以用，之前的Oracle/Sun JDK则用不了。
可以设置的参数默认是不包括diagnostic或experimental系的。要在-XX:+PrintFlagsFinal的输出里看到这两种参数的信息，分别需要显式指定<strong>-XX:+UnlockDiagnosticVMOptions</strong> / <strong>-XX:+UnlockExperimentalVMOptions</strong> 。
再下来，<strong>-XX:+PrintFlagsInitial</strong> 。这个参数显示在处理参数之前所有可设置的参数及它们的值，然后直接退出程序。“参数处理”包括许多步骤，例如说检查参数之间是否有冲突，通过ergonomics调整某些参数的值，之类的。
结合-XX:+PrintFlagsInitial与-XX:+PrintFlagsFinal，对比两者的差异，就可以知道ergonomics对哪些参数做了怎样的调整。
这两个参数的例子：
Command prompt代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>$ java -version  </p>
</li>
<li>java version &quot;1.6.0_29&quot;  </li>
<li>Java(TM) SE Runtime Environment (build 1.6.0_29-b11)  </li>
<li>Java HotSpot(TM) 64-Bit Server VM (build 20.4-b02, mixed mode)  </li>
<li>$ java -XX:+PrintFlagsInitial | grep UseCompressedOops  </li>
<li>bool UseCompressedOops                         = false           {lp64_product}        </li>
<li>$ java -XX:+PrintFlagsFinal | grep UseCompressedOops  </li>
<li><p>bool UseCompressedOops                        := true            {lp64_product}<br>$ java -version java version &quot;1.6.0_29&quot; Java(TM) SE Runtime Environment (build 1.6.0_29-b11) Java HotSpot(TM) 64-Bit Server VM (build 20.4-b02, mixed mode) $ java -XX:+PrintFlagsInitial | grep UseCompressedOops bool UseCompressedOops = false {lp64_product} $ java -XX:+PrintFlagsFinal | grep UseCompressedOops bool UseCompressedOops := true {lp64_product}
<a href="http://rednaxelafx.iteye.com/blog/1010079" target="_blank">Oracle/Sun JDK 6从update 23开始会由ergonomics在合适的条件下默认启用压缩指针功能</a>。这个例子演示的是UseCompressedOops的初始默认值是false，由PrintFlagsInitial的输出可以看到；然后经过ergonomics自动调整后，最终采用的默认值是true，由PrintFlagsFinal的输出可以看到。
输出里“=”表示使用的是初始默认值，而“:=”表示使用的不是初始默认值，可能是命令行传进来的参数、配置文件里的参数或者是ergonomics自动选择了别的值。
除了在VM启动时传些特殊的参数让它打印出自己的各参数外，<strong>jinfo -flag</strong> 可以用来查看某个参数的值，也可以用来设定manageable系参数的值。请参考这帖的例子：<a href="http://rednaxelafx.iteye.com/blog/1049240" target="_blank">通过jinfo工具在full GC前后做heap dump</a></p>
<h1 id="-hotspot-vm-http-rednaxelafx-iteye-com-blog-906807-">之前发过<a href="http://rednaxelafx.iteye.com/blog/906807" target="_blank">某些环境中HotSpot VM的各参数的默认值</a>，可以参考一下。</h1>
<p>1、-XX:+DisableExplicitGC 与 NIO的direct memory
很多人都见过JVM调优建议里使用这个参数，对吧？但是为什么要用它，什么时候应该用而什么时候用了会掉坑里呢？
首先要了解的是这个参数的作用。在Oracle/Sun JDK这个具体实现上，System.gc()的默认效果是引发一次stop-the-world的full GC，对整个GC堆做收集。有几个参数可以改变默认行为，之前<a href="http://rednaxelafx.iteye.com/blog/1042471" target="_blank">发过一帖简单描述</a>过，这里就不重复了。关键点是，用了-XX:+DisableExplicitGC参数后，System.gc()的调用就会变成一个空调用，完全不会触发任何GC（但是“函数调用”本身的开销还是存在的哦～）。
为啥要用这个参数呢？最主要的原因是为了防止某些手贱的同学在代码里到处写System.gc()的调用而干扰了程序的正常运行吧。有些应用程序本来可能正常跑一天也不会出一次full GC，但就是因为有人在代码里调用了System.gc()而不得不间歇性被暂停。也有些时候这些调用是在某些库或框架里写的，改不了它们的代码但又不想被这些调用干扰也会用这参数。
OK。看起来这参数应该总是开着嘛。有啥坑呢？
其中一种情况是下述三个条件同时满足时会发生的：
1、应用本身在GC堆内的对象行为良好，正常情况下很久都不发生full GC；
2、应用大量使用了NIO的direct memory，经常、反复的申请DirectByteBuffer
3、使用了-XX:+DisableExplicitGC
能观察到的现象是：
Log代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>java.lang.OutOfMemoryError: Direct buffer memory  </p>
</li>
<li>at java.nio.Bits.reserveMemory(Bits.java:633)  </li>
<li>at java.nio.DirectByteBuffer.<init>(DirectByteBuffer.java:98)  </li>
<li>at java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:288)  </li>
<li><p>...<br>java.lang.OutOfMemoryError: Direct buffer memory at java.nio.Bits.reserveMemory(Bits.java:633) at java.nio.DirectByteBuffer.<init>(DirectByteBuffer.java:98) at java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:288) ...
做个简单的例子来演示这现象：
Java代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>import java.nio./*;  </p>
</li>
<li></li>
<li>public class DisableExplicitGCDemo {  </li>
<li>public static void main(String[] args) {  </li>
<li>for (int i = 0; i &lt; 100000; i++) {  </li>
<li>ByteBuffer.allocateDirect(128);  </li>
<li>}  </li>
<li>System.out.println(&quot;Done&quot;);  </li>
<li>}  </li>
<li><p>}<br>import java.nio./*; public class DisableExplicitGCDemo { public static void main(String[] args) { for (int i = 0; i &lt; 100000; i++) { ByteBuffer.allocateDirect(128); } System.out.println(&quot;Done&quot;); } }
然后编译、运行之：
Command prompt代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>$ java -version  </p>
</li>
<li>java version &quot;1.6.0_25&quot;  </li>
<li>Java(TM) SE Runtime Environment (build 1.6.0_25-b06)  </li>
<li>Java HotSpot(TM) 64-Bit Server VM (build 20.0-b11, mixed mode)  </li>
<li>$ javac DisableExplicitGCDemo.java   </li>
<li>$ java -XX:MaxDirectMemorySize=10m -XX:+PrintGC -XX:+DisableExplicitGC DisableExplicitGCDemo  </li>
<li>Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Direct buffer memory  </li>
<li>at java.nio.Bits.reserveMemory(Bits.java:633)  </li>
<li>at java.nio.DirectByteBuffer.<init>(DirectByteBuffer.java:98)  </li>
<li>at java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:288)  </li>
<li>at DisableExplicitGCDemo.main(DisableExplicitGCDemo.java:6)  </li>
<li>$ java -XX:MaxDirectMemorySize=10m -XX:+PrintGC DisableExplicitGCDemo  </li>
<li>[GC 10996K-&gt;10480K(120704K), 0.0433980 secs]  </li>
<li>[Full GC 10480K-&gt;10415K(120704K), 0.0359420 secs]  </li>
<li><p>Done<br>$ java -version java version &quot;1.6.0_25&quot; Java(TM) SE Runtime Environment (build 1.6.0_25-b06) Java HotSpot(TM) 64-Bit Server VM (build 20.0-b11, mixed mode) $ javac DisableExplicitGCDemo.java $ java -XX:MaxDirectMemorySize=10m -XX:+PrintGC -XX:+DisableExplicitGC DisableExplicitGCDemo Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Direct buffer memory at java.nio.Bits.reserveMemory(Bits.java:633) at java.nio.DirectByteBuffer.<init>(DirectByteBuffer.java:98) at java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:288) at DisableExplicitGCDemo.main(DisableExplicitGCDemo.java:6) $ java -XX:MaxDirectMemorySize=10m -XX:+PrintGC DisableExplicitGCDemo [GC 10996K-&gt;10480K(120704K), 0.0433980 secs] [Full GC 10480K-&gt;10415K(120704K), 0.0359420 secs] Done
可以看到，同样的程序，不带-XX:+DisableExplicitGC时能正常完成运行，而带上这个参数后却出现了OOM。
例子里用-XX:MaxDirectMemorySize=10m限制了DirectByteBuffer能分配的空间的限额，以便问题更容易展现出来。不用这个参数就得多跑一会儿了。
在这个例子里，main()里的循环不断申请DirectByteBuffer但并没有引用、使用它们，所以这些DirectByteBuffer应该刚创建出来就已经满足被GC的条件，等下次GC运行的时候就应该可以被回收。
实际上却没这么简单。DirectByteBuffer是种典型的“冰山”对象，也就是说它的Java对象虽然很小很无辜，但它背后却会关联着一定量的native memory资源，而这些资源并不在GC的控制之下，需要自己注意控制好。对JVM如何使用native memory不熟悉的同学可以参考去年JavaOne上IBM的一个演讲，“Where Does All the Native Memory Go”。
Oracle/Sun JDK的实现里，DirectByteBuffer有几处值得注意的地方。
1、DirectByteBuffer没有finalizer，它的native memory的清理工作是通过sun.misc.Cleaner自动完成的。
2、sun.misc.Cleaner是一种基于PhantomReference的清理工具，比普通的finalizer轻量些。对PhantomReference不熟悉的同学请参考Bob Lee最近几年在JavaOne上做的演讲，<a href="http://www.parleys.com/d/2657" target="_blank">&quot;The Ghost in the Virtual Machine: A Reference to References&quot;</a>。<a href="https://oracleus.wingateweb.com/scheduler/eventcatalog/eventCatalogJavaOne.do" target="_blank">今年的JavaOne</a>上他也讲了同一个主题，内容比前几年的稍微更新了些。PPT可以从链接里的页面下载到。
Java代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>//<em>/</em> </p>
</li>
<li>/* General-purpose phantom-reference-based cleaners. </li>
<li>/* </li>
<li>/* <p> Cleaners are a lightweight and more robust alternative to finalization. </li>
<li>/* They are lightweight because they are not created by the VM and thus do not </li>
<li>/* require a JNI upcall to be created, and because their cleanup code is </li>
<li>/* invoked directly by the reference-handler thread rather than by the </li>
<li>/* finalizer thread.  They are more robust because they use phantom references, </li>
<li>/* the weakest type of reference object, thereby avoiding the nasty ordering </li>
<li>/* problems inherent to finalization. </li>
<li>/* </li>
<li>/* <p> A cleaner tracks a referent object and encapsulates a thunk of arbitrary </li>
<li>/* cleanup code.  Some time after the GC detects that a cleaner&#39;s referent has </li>
<li>/* become phantom-reachable, the reference-handler thread will run the cleaner. </li>
<li>/* Cleaners may also be invoked directly; they are thread safe and ensure that </li>
<li>/* they run their thunks at most once. </li>
<li>/* </li>
<li>/* <p> Cleaners are not a replacement for finalization.  They should be used </li>
<li>/* only when the cleanup code is extremely simple and straightforward. </li>
<li>/* Nontrivial cleaners are inadvisable since they risk blocking the </li>
<li>/* reference-handler thread and delaying further cleanup and finalization. </li>
<li>/* </li>
<li>/* </li>
<li>/* @author Mark Reinhold </li>
<li>/* @version %I%, %E% </li>
<li><p>/<em>/<br>//</em>/<em> /</em> General-purpose phantom-reference-based cleaners. /<em> /</em> <p> Cleaners are a lightweight and more robust alternative to finalization. /<em> They are lightweight because they are not created by the VM and thus do not /</em> require a JNI upcall to be created, and because their cleanup code is /<em> invoked directly by the reference-handler thread rather than by the /</em> finalizer thread. They are more robust because they use phantom references, /<em> the weakest type of reference object, thereby avoiding the nasty ordering /</em> problems inherent to finalization. /<em> /</em> <p> A cleaner tracks a referent object and encapsulates a thunk of arbitrary /<em> cleanup code. Some time after the GC detects that a cleaner&#39;s referent has /</em> become phantom-reachable, the reference-handler thread will run the cleaner. /<em> Cleaners may also be invoked directly; they are thread safe and ensure that /</em> they run their thunks at most once. /<em> /</em> <p> Cleaners are not a replacement for finalization. They should be used /<em> only when the cleanup code is extremely simple and straightforward. /</em> Nontrivial cleaners are inadvisable since they risk blocking the /<em> reference-handler thread and delaying further cleanup and finalization. /</em> /<em> /</em> @author Mark Reinhold /<em> @version %I%, %E% /</em>/
重点是这两句：&quot;A cleaner tracks a referent object and encapsulates a thunk of arbitrary cleanup code.  Some time after the GC detects that a cleaner&#39;s referent has become phantom-reachable, the reference-handler thread will run the cleaner.&quot;
Oracle/Sun JDK 6中的HotSpot VM只会在old gen GC（full GC/major GC或者concurrent GC都算）的时候才会对old gen中的对象做reference processing，而在young GC/minor GC时只会对young gen里的对象做reference processing。
（死在young gen中的DirectByteBuffer对象会在young GC时被处理的例子，请参考这里：<a href="https://gist.github.com/1614952" target="_blank"><a href="https://gist.github.com/1614952">https://gist.github.com/1614952</a></a>）
也就是说，做full GC的话会对old gen做reference processing，进而能触发Cleaner对已死的DirectByteBuffer对象做清理工作。而如果很长一段时间里没做过GC或者只做了young GC的话则不会在old gen触发Cleaner的工作，那么就可能让本来已经死了的、但已经晋升到old gen的DirectByteBuffer关联的native memory得不到及时释放。
3、为DirectByteBuffer分配空间过程中会显式调用System.gc()，以期通过full GC来强迫已经无用的DirectByteBuffer对象释放掉它们关联的native memory：
Java代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>// These methods should be called whenever direct memory is allocated or  </p>
</li>
<li>// freed.  They allow the user to control the amount of direct memory  </li>
<li>// which a process may access.  All sizes are specified in bytes.  </li>
<li>static void reserveMemory(long size) {  </li>
<li></li>
<li>synchronized (Bits.class) {  </li>
<li>if (!memoryLimitSet &amp;&amp; VM.isBooted()) {  </li>
<li>maxMemory = VM.maxDirectMemory();  </li>
<li>memoryLimitSet = true;  </li>
<li>}  </li>
<li>if (size &lt;= maxMemory - reservedMemory) {  </li>
<li>reservedMemory += size;  </li>
<li>return;  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>System.gc();  </li>
<li>try {  </li>
<li>Thread.sleep(100);  </li>
<li>} catch (InterruptedException x) {  </li>
<li>// Restore interrupt status  </li>
<li>Thread.currentThread().interrupt();  </li>
<li>}  </li>
<li>synchronized (Bits.class) {  </li>
<li>if (reservedMemory + size &gt; maxMemory)  </li>
<li>throw new OutOfMemoryError(&quot;Direct buffer memory&quot;);  </li>
<li>reservedMemory += size;  </li>
<li>}  </li>
<li></li>
<li>}<br>// These methods should be called whenever direct memory is allocated or // freed. They allow the user to control the amount of direct memory // which a process may access. All sizes are specified in bytes. static void reserveMemory(long size) { synchronized (Bits.class) { if (!memoryLimitSet &amp;&amp; VM.isBooted()) { maxMemory = VM.maxDirectMemory(); memoryLimitSet = true; } if (size &lt;= maxMemory - reservedMemory) { reservedMemory += size; return; } } System.gc(); try { Thread.sleep(100); } catch (InterruptedException x) { // Restore interrupt status Thread.currentThread().interrupt(); } synchronized (Bits.class) { if (reservedMemory + size &gt; maxMemory) throw new OutOfMemoryError(&quot;Direct buffer memory&quot;); reservedMemory += size; } }
这几个实现特征使得Oracle/Sun JDK 6依赖于System.gc()触发GC来保证DirectByteMemory的清理工作能及时完成。如果打开了-XX:+DisableExplicitGC，清理工作就可能得不到及时完成，于是就有机会见到direct memory的OOM，也就是上面的例子演示的情况。我们这边在实际生产环境中确实遇到过这样的问题。<h1 id="-oracle-sun-jdk-6-direct-memory-xx-disableexplicitgc-direct-memory-oom-oom-system-gc-full-gc-xx-explicitgcinvokesconcurrent-">教训是：如果你在使用Oracle/Sun JDK 6，应用里有任何地方用了direct memory，那么使用-XX:+DisableExplicitGC要小心。如果用了该参数而且遇到direct memory的OOM，可以尝试去掉该参数看是否能避开这种OOM。如果担心System.gc()调用造成full GC频繁，可以尝试下面提到 -XX:+ExplicitGCInvokesConcurrent 参数</h1>
2、-XX:+DisableExplicitGC 与 Remote Method Invocation (RMI) 与 -Dsun.rmi.dgc.{server|client}.gcInterval=
看了上一个例子有没有觉得-XX:+DisableExplicitGC参数用起来很危险？那干脆完全不要用这个参数吧。又有什么坑呢？
前段时间有个应用的开发来抱怨，说某次升级JDK之前那应用的GC状况都很好，很长时间都不会发生full GC，但升级后发现每一小时左右就会发生一次。经过对比发现，升级的同时也吧启动参数改了，把原本有的-XX:+DisableExplicitGC给去掉了。
观察到的日志有明显特征。一位同事表示：
引用</li>
</ol>
<p>线上机器出现一个场景；每隔1小时出现一次Full GC,用btrace看了一下调用地：
who call system.gc :
sun.misc.GC$Daemon.run(GC.java:92)
预发机没什么流量，也会每一小时一次Full GC
频率正好是一小时一次
Gc log代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>2011-09-23T10:49:38.071+0800: 327692.227: [Full GC (System) 327692.227: [CMS: 75793K-&gt;75759K(2097152K), 0.6923690 secs] 430298K-&gt;75759K(3984640K), [CMS Perm : 104136K-&gt;104124K(173932K)], 0.6925570 secs]<br>2011-09-23T10:49:38.071+0800: 327692.227: [Full GC (System) 327692.227: [CMS: 75793K-&gt;75759K(2097152K), 0.6923690 secs] 430298K-&gt;75759K(3984640K), [CMS Perm : 104136K-&gt;104124K(173932K)], 0.6925570 secs]
实际上这里在做的是分布式GC。Sun JDK的分布式GC是用纯Java实现的，为RMI服务。
RMI DGC相关参数的介绍文档：<a href="http://docs.oracle.com/javase/6/docs/technotes/guides/rmi/sunrmiproperties.html" target="_blank"><a href="http://docs.oracle.com/javase/6/docs/technotes/guides/rmi/sunrmiproperties.html">http://docs.oracle.com/javase/6/docs/technotes/guides/rmi/sunrmiproperties.html</a></a>
（后面回头再补…先睡觉去了）
资料：
<a href="http://java.sun.com/developer/onlineTraining/rmi/exercises/DistributedGarbageCollector/index.html" target="_blank">jGuru: Distributed Garbage Collection</a>
<a href="http://mail.openjdk.java.net/pipermail/hotspot-dev/2011-December/004909.html" target="_blank"><a href="http://mail.openjdk.java.net/pipermail/hotspot-dev/2011-December/004909.html">http://mail.openjdk.java.net/pipermail/hotspot-dev/2011-December/004909.html</a></a>
Tony Printezis 写道</li>
</ol>
<p>RMI has a distributed GC that relies on reference processing to allow
each node to recognize that some objects are unreachable so it can
notify a remote node (or nodes) that some remote references to them do
not exist any more. The remote node might then be able to reclaim
objects that are only remotely reachable. (Or this is how I understood
it at least.)
RMI used to call System.gc() once a minute (!!!) but after some
encouragement from yours truly they changed the default to once an hour
(this is configurable using a property). Note that a STW Full GC is not
really required as long as references are processed. So, in CMS (and
G1), a concurrent cycle is fine which is why we recommend to use
-XX:+ExplicitGCInvokesConcurrent in this case.
I had been warned by the RMI folks against totally disabling those
System.gc()&#39;s (e.g., using -XX:+DisableExplicitGC) given that if Full
GCs / concurrent cycles do not otherwise happen at a reasonable
frequency then remote nodes might experience memory leaks since they
will consider that some otherwise unreachable remote references are
still live. I have no idea how severe such memory leaks would be. I
guess they&#39;d be very application-dependent.
An additional thought that just occurred to me: instead of calling
System.gc() every hour what RMI should really be doing is calling
System.gc() every hour provided no old gen GC has taken place during the
last hour. This would be relatively easy to implement by accessing the
old GC counter through the GC MXBeans.
Tony
再加俩链接：<a href="http://mail.openjdk.java.net/pipermail/hotspot-dev/2012-January/004929.html" target="_blank"><a href="http://mail.openjdk.java.net/pipermail/hotspot-dev/2012-January/004929.html">http://mail.openjdk.java.net/pipermail/hotspot-dev/2012-January/004929.html</a></a>
<a href="http://mail.openjdk.java.net/pipermail/hotspot-dev/2012-January/004946.html" target="_blank"><a href="http://mail.openjdk.java.net/pipermail/hotspot-dev/2012-January/004946.html">http://mail.openjdk.java.net/pipermail/hotspot-dev/2012-January/004946.html</a></a></p>
<h1 id="-java-performance-303-411-xx-disableexplicitgc-rmi-">《Java Performance》的303和411页正好也提到了-XX:+DisableExplicitGC与RMI之间的干扰的事情，有兴趣可以读一下，虽然只有一小段。</h1>
<p>3、-XX:+ExplicitGCInvokesConcurrent 或 -XX:+ExplicitGCInvokesConcurrentAndUnloadsClasses
C++代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>product(bool, ExplicitGCInvokesConcurrent, false,                  \  </li>
<li>&quot;A System.gc() request invokes a concurrent collection;&quot;         \  </li>
<li>&quot; (effective only when UseConcMarkSweepGC)&quot;)                     \  </li>
<li>\  </li>
<li>product(bool, ExplicitGCInvokesConcurrentAndUnloadsClasses, false, \  </li>
<li>&quot;A System.gc() request invokes a concurrent collection and &quot;     \  </li>
<li>&quot;also unloads classes during such a concurrent gc cycle &quot;        \  </li>
<li><p>&quot;(effective only when UseConcMarkSweepGC)&quot;)                      \<br>product(bool, ExplicitGCInvokesConcurrent, false, \ &quot;A System.gc() request invokes a concurrent collection;&quot; \ &quot; (effective only when UseConcMarkSweepGC)&quot;) \ \ product(bool, ExplicitGCInvokesConcurrentAndUnloadsClasses, false, \ &quot;A System.gc() request invokes a concurrent collection and &quot; \ &quot;also unloads classes during such a concurrent gc cycle &quot; \ &quot;(effective only when UseConcMarkSweepGC)&quot;) \
跟上面的第一个例子的-XX:+DisableExplicitGC一样，这两个参数也是用来改变System.gc()的默认行为用的；不同的是这两个参数只能配合CMS使用（-XX:+UseConcMarkSweepGC），而且System.gc()还是会触发GC的，只不过不是触发一个完全stop-the-world的full GC，而是一次并发GC周期。
CMS GC周期中也会做reference processing。所以如果用这两个参数的其中一个，而不是用-XX:+DisableExplicitGC的话，就避开了由full GC带来的长GC pause，同时NIO direct memory的OOM也不会那么容易发生。
做了个跟第一个例子类似的例子，在这里：<a href="https://gist.github.com/1344251" target="_blank"><a href="https://gist.github.com/1344251">https://gist.github.com/1344251</a></a>
《Java Performance》的303页有讲到这俩参数。
相关bug：<a href="http://bugs.sun.com/view_bug.do?bug_id=6919638" target="_blank">6919638 CMS: ExplicitGCInvokesConcurrent misinteracts with gc locker</a></p>
<h1 id="-jdk6u23-">&lt;&lt; JDK6u23修复了这个问题</h1>
<p>4、-XX:+GCLockerInvokesConcurrent
C++代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>product(bool, GCLockerInvokesConcurrent, false,        \  </p>
</li>
<li>&quot;The exit of a JNI CS necessitating a scavenge also&quot; \  </li>
<li><p>&quot; kicks off a bkgrd concurrent collection&quot;)          \<br>product(bool, GCLockerInvokesConcurrent, false, \ &quot;The exit of a JNI CS necessitating a scavenge also&quot; \ &quot; kicks off a bkgrd concurrent collection&quot;) \</p>
<h1 id="-">（内容回头补…）</h1>
<p>5、MaxDirectMemorySize 与 NIO direct memory 的默认上限
<strong>-XX:MaxDirectMemorySize</strong> 是用来配置NIO direct memory上限用的VM参数。
C++代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>product(intx, MaxDirectMemorySize, -1,                         \  </p>
</li>
<li><p>&quot;Maximum total size of NIO direct-buffer allocations&quot;) \<br>product(intx, MaxDirectMemorySize, -1, \ &quot;Maximum total size of NIO direct-buffer allocations&quot;) \
但如果不配置它的话，direct memory默认最多能申请多少内存呢？这个参数默认值是-1，显然不是一个“有效值”。所以真正的默认值肯定是从别的地方来的。
在Sun JDK 6和OpenJDK 6里，有这样一段代码，sun.misc.VM：
Java代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>// A user-settable upper limit on the maximum amount of allocatable direct  </p>
</li>
<li>// buffer memory.  This value may be changed during VM initialization if  </li>
<li>// &quot;java&quot; is launched with &quot;-XX:MaxDirectMemorySize=<size>&quot;.  </li>
<li>//  </li>
<li>// The initial value of this field is arbitrary; during JRE initialization  </li>
<li>// it will be reset to the value specified on the command line, if any,  </li>
<li>// otherwise to Runtime.getRuntime().maxMemory().  </li>
<li>//  </li>
<li>private static long directMemory = 64 /<em> 1024 /</em> 1024;  </li>
<li></li>
<li>// If this method is invoked during VM initialization, it initializes the  </li>
<li>// maximum amount of allocatable direct buffer memory (in bytes) from the  </li>
<li>// system property sun.nio.MaxDirectMemorySize.  The system property will  </li>
<li>// be removed when it is accessed.  </li>
<li>//  </li>
<li>// If this method is invoked after the VM is booted, it returns the  </li>
<li>// maximum amount of allocatable direct buffer memory.  </li>
<li>//  </li>
<li>public static long maxDirectMemory() {  </li>
<li>if (booted)  </li>
<li>return directMemory;  </li>
<li></li>
<li>Properties p = System.getProperties();  </li>
<li>String s = (String)p.remove(&quot;sun.nio.MaxDirectMemorySize&quot;);  </li>
<li>System.setProperties(p);  </li>
<li></li>
<li>if (s != null) {  </li>
<li>if (s.equals(&quot;-1&quot;)) {  </li>
<li>// -XX:MaxDirectMemorySize not given, take default  </li>
<li>directMemory = Runtime.getRuntime().maxMemory();  </li>
<li>} else {  </li>
<li>long l = Long.parseLong(s);  </li>
<li>if (l &gt; -1)  </li>
<li>directMemory = l;  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>return directMemory;  </li>
<li><p>}<br>// A user-settable upper limit on the maximum amount of allocatable direct // buffer memory. This value may be changed during VM initialization if // &quot;java&quot; is launched with &quot;-XX:MaxDirectMemorySize=<size>&quot;. // // The initial value of this field is arbitrary; during JRE initialization // it will be reset to the value specified on the command line, if any, // otherwise to Runtime.getRuntime().maxMemory(). // private static long directMemory = 64 /<em> 1024 /</em> 1024; // If this method is invoked during VM initialization, it initializes the // maximum amount of allocatable direct buffer memory (in bytes) from the // system property sun.nio.MaxDirectMemorySize. The system property will // be removed when it is accessed. // // If this method is invoked after the VM is booted, it returns the // maximum amount of allocatable direct buffer memory. // public static long maxDirectMemory() { if (booted) return directMemory; Properties p = System.getProperties(); String s = (String)p.remove(&quot;sun.nio.MaxDirectMemorySize&quot;); System.setProperties(p); if (s != null) { if (s.equals(&quot;-1&quot;)) { // -XX:MaxDirectMemorySize not given, take default directMemory = Runtime.getRuntime().maxMemory(); } else { long l = Long.parseLong(s); if (l &gt; -1) directMemory = l; } } return directMemory; }
（代码里原本的注释有个写错的地方，上面有修正）
当MaxDirectMemorySize参数没被显式设置时它的值就是-1，在Java类库初始化时maxDirectMemory()被java.lang.System的静态构造器调用，走的路径就是这条：
Java代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>if (s.equals(&quot;-1&quot;)) {  </p>
</li>
<li>// -XX:MaxDirectMemorySize not given, take default  </li>
<li>directMemory = Runtime.getRuntime().maxMemory();  </li>
<li><p>}<br>if (s.equals(&quot;-1&quot;)) { // -XX:MaxDirectMemorySize not given, take default directMemory = Runtime.getRuntime().maxMemory(); }
而Runtime.maxMemory()在HotSpot VM里的实现是：
C++代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>JVM_ENTRY_NO_ENV(jlong, JVM_MaxMemory(void))  </p>
</li>
<li>JVMWrapper(&quot;JVM_MaxMemory&quot;);  </li>
<li>size_t n = Universe::heap()-&gt;max_capacity();  </li>
<li>return convert_size_t_to_jlong(n);  </li>
<li><p>JVM_END<br>JVM_ENTRY_NO_ENV(jlong, JVM_MaxMemory(void)) JVMWrapper(&quot;JVM_MaxMemory&quot;); size_t n = Universe::heap()-&gt;max_capacity(); return convert_size_t_to_jlong(n); JVM_END
这个max_capacity()实际返回的是 -Xmx减去一个survivor space的预留大小（G1除外）。
结论：MaxDirectMemorySize没显式配置的时候，NIO direct memory可申请的空间的上限就是<strong>-Xmx减去一个survivor space的预留大小</strong>。
大家感兴趣的话可以试试在不同的-Xmx的条件下不设置MaxDirectMemorySize，并且调用一下sun.misc.VM.maxDirectMemory()看得到的值的相关性。</p>
<h1 id="-jdk7-http-hg-openjdk-java-net-jdk7-jdk7-jdk-rev-b444f86c4abe-http-hg-openjdk-java-net-jdk7-jdk7-jdk-rev-b444f86c4abe-">该行为在JDK7里没变，虽然具体实现的代码有些变化。请参考<a href="http://hg.openjdk.java.net/jdk7/jdk7/jdk/rev/b444f86c4abe" target="_blank"><a href="http://hg.openjdk.java.net/jdk7/jdk7/jdk/rev/b444f86c4abe">http://hg.openjdk.java.net/jdk7/jdk7/jdk/rev/b444f86c4abe</a></a></h1>
<p>6、-verbose:gc 与 -XX:+PrintGCDetails
经常能看到在推荐的标准参数里这两个参数一起出现。实际上它们有啥关系？
在Oracle/Sun JDK 6里，&quot;java&quot;这个启动程序遇到&quot;-verbosegc&quot;会将其转换为&quot;-verbose:gc&quot;，将启动参数传给HotSpot VM后，HotSpot VM遇到&quot;-verbose:gc&quot;则会当作&quot;-XX:+PrintGC&quot;来处理。
也就是说 -verbosegc、-verbose:gc、-XX:+PrintGC 三者的作用是完全一样的。
而当HotSpot VM遇到 -XX:+PrintGCDetails 参数时，会顺带把 -XX:+PrintGC 给设置上。
也就是说 -XX:+PrintGCDetails 包含 -XX:+PrintGC，进而也就包含 -verbose:gc。</p>
<h1 id="-verbose-gc-">既然 -verbose:gc 都被包含了，何必在命令行参数里显式设置它呢？<img src="" alt=""></h1>
<p>7、-XX:+UseFastEmptyMethods 与 -XX:+UseFastAccessorMethods
虽然不常见，但偶尔也会见到推荐的标准参数上有这俩的身影。
empty method顾名思义就是空方法，也就是方法体只包含一条return指令、返回值类型为void的Java方法。
accessor method在这里则有很具体的定义：
C++代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>bool methodOopDesc::is_accessor() const {  </p>
</li>
<li>if (code_size() != 5) return false;  </li>
<li>if (size_of_parameters() != 1) return false;  </li>
<li>if (java_code_at(0) != Bytecodes::_aload_0 ) return false;  </li>
<li>if (java_code_at(1) != Bytecodes::_getfield) return false;  </li>
<li>if (java_code_at(4) != Bytecodes::_areturn &amp;&amp;  </li>
<li>java_code_at(4) != Bytecodes::_ireturn ) return false;  </li>
<li>return true;  </li>
<li><p>}<br>bool methodOopDesc::is_accessor() const { if (code_size() != 5) return false; if (size_of_parameters() != 1) return false; if (java_code_at(0) != Bytecodes::_aload_0 ) return false; if (java_code_at(1) != Bytecodes::_getfield) return false; if (java_code_at(4) != Bytecodes::_areturn &amp;&amp; java_code_at(4) != Bytecodes::_ireturn ) return false; return true; }
如果从Java源码的角度来理解，accessor method就是形如这样的：
Java代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>public class Foo {  </p>
</li>
<li>private int value;  </li>
<li></li>
<li>public int getValue() {  </li>
<li>return this.value;  </li>
<li>}  </li>
<li><p>}<br>public class Foo { private int value; public int getValue() { return this.value; } }
关键点是：
1、必须是成员方法；静态方法不行
2、返回值类型必须是引用类型或者int，其它都不算
3、方法体的代码必须满足aload_0; getfield /#index; areturn或ireturn这样的模式。
留意：方法名是什么都没关系，是不是get、is、has开头都不重要。
那么这俩有啥问题？
取自JDK 6 update 27：
C++代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>product(bool, UseFastEmptyMethods, true,                   \  </p>
</li>
<li>&quot;Use fast method entry code for empty methods&quot;)    \  </li>
<li>\  </li>
<li>product(bool, UseFastAccessorMethods, true,                \  </li>
<li><p>&quot;Use fast method entry code for accessor methods&quot;) \<br>product(bool, UseFastEmptyMethods, true, \ &quot;Use fast method entry code for empty methods&quot;) \ \ product(bool, UseFastAccessorMethods, true, \ &quot;Use fast method entry code for accessor methods&quot;) \
看到这俩参数的默认值都是true了么？也就是说，在Oracle/Sun JDK 6上设置这参数其实也是没意义的，跟默认一样，一直到最新的JDK 6 update 29都是如此。
不过在Oracle/Sun JDK 7里，情况有变化。
<a href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6385687" target="_blank">Bug ID: 6385687 UseFastEmptyMethods/UseFastAccessorMethods considered harmful</a>
在<a href="http://hg.openjdk.java.net/jdk7/hotspot-comp/hotspot/rev/c2323e2ea62b" target="_blank">上述bug对应的代码变更</a>后，这俩参数的默认值改为了false。
本来想多写点这块的…算，还是长话短说。
Oracle JDK 7里的HotSpot VM已经开始有比较好的<a href="http://rednaxelafx.iteye.com/blog/1022095" target="_blank">多层编译（tiered compilation）支持</a>，可以预见在不久的将来该模式将成为HotSpot VM默认的执行模式。当前该模式尚未默认开启；可以通过 <strong>-XX:+TieredCompilation</strong> 来开启。
有趣的是，在使用多层编译模式时，如果UseFastAccessorMethods/UseFastEmptyMethods是开着的，有些多态方法调用点的性能反而会显著下降。所以，为了适应多层编译模式，JDK 7里这两个参数的默认值就被改为false了。</p>
<h1 id="-review-for-6385687-usefastemptymethods-usefastaccessormethods-considered-harmful-http-mail-openjdk-java-net-pipermail-hotspot-compiler-dev-2011-march-005057-html-">在邮件列表上有过相关讨论：<a href="http://mail.openjdk.java.net/pipermail/hotspot-compiler-dev/2011-March/005057.html" target="_blank">review for 6385687: UseFastEmptyMethods/UseFastAccessorMethods considered harmful</a></h1>
<p>8、-XX:+UseCMSCompactAtFullCollection
这个参数在Oracle/Sun JDK 6里一直都默认是true，完全没必要显式设置，设了也不会有啥不同的效果。
C++代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>product(bool, UseCMSCompactAtFullCollection, true,    \  </p>
</li>
<li><p>&quot;Use mark sweep compact at full collections&quot;) \<br>product(bool, UseCMSCompactAtFullCollection, true, \ &quot;Use mark sweep compact at full collections&quot;) \
我不认为显式设置一个跟默认值相同的参数有什么维护上的好处。要维护的参数多了反而更容易成为维护的噩梦吧。后面的人会不知道到底当初为什么要设置这个参数。
相关的有个 <strong>CMSFullGCsBeforeCompaction</strong> 参数，请参考另一帖里的讨论：<a href="http://hllvm.group.iteye.com/group/topic/28854#209294" target="_blank"><a href="http://hllvm.group.iteye.com/group/topic/28854/#209294">http://hllvm.group.iteye.com/group/topic/28854/#209294</a></a>
同样，在Oracle/Sun JDK 6和OpenJDK 6里，<strong>CMSParallelRemarkEnabled</strong> 也一直默认是true，没必要显式设置-XX:+CMSParallelRemarkEnabled。
有很多bool类型的参数默认都是true，显式设置它们之前最好先用这帖开头介绍的办法看看默认值是否已经是想要的值了。
C++代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>product(bool, CMSScavengeBeforeRemark, false,          \  </p>
</li>
<li><p>&quot;Attempt scavenge before the CMS remark step&quot;) \<br>product(bool, CMSScavengeBeforeRemark, false, \ &quot;Attempt scavenge before the CMS remark step&quot;) \</p>
<h1 id="-false-young-gc-cms-remark-remark-young-gc-remark-">这个默认倒是false。如果一个应用统计到的young GC时间都比较短而CMS remark的时间比较长，那么可以试试打开这个参数，在做remark之前先做一次young GC。是否能有效缩短remark的时间视应用情况而异，所以开这个参数的话请一定做好测试。</h1>
<p>9、-XX:CMSMaxAbortablePrecleanTime=5000
同上…默认就是5000
C++代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>product(intx, CMSMaxAbortablePrecleanTime, 5000,    \  </p>
</li>
<li>&quot;(Temporary, subject to experimentation)&quot;   \  </li>
<li><p>&quot;Maximum time in abortable preclean in ms&quot;) \<br>product(intx, CMSMaxAbortablePrecleanTime, 5000, \ &quot;(Temporary, subject to experimentation)&quot; \ &quot;Maximum time in abortable preclean in ms&quot;) \</p>
<h1 id="-">还是不要设跟默认值一样的参数了吧。</h1>
<p>10、-Xss 与 -XX:ThreadStackSize
参考我之前发过的两帖：
<a href="http://mail.openjdk.java.net/pipermail/hotspot-dev/2011-June/004272.html" target="_blank">What the difference between -Xss and -XX:ThreadStackSize is?</a>
<a href="http://mail.openjdk.java.net/pipermail/hotspot-dev/2011-July/004288.html" target="_blank">Inconsistency between -Xss and -XX:ThreadStackSize in the java launcher</a></p>
<h1 id="-">（详情回头补～）</h1>
<p>11、-Xmn 与 -XX:NewSize、-XX:MaxNewSize</p>
<h1 id="-xx-newsize-xx-maxnewsize-could-not-reserve-enough-space-for-object-heap-http-hllvm-group-iteye-com-group-topic-28467-206341-jdk-6-jdk-6-update-14-">如果同时设置了-XX:NewSize与-XX:MaxNewSize遇到“Could not reserve enough space for object heap”错误的话，请看看是不是<a href="http://hllvm.group.iteye.com/group/topic/28467#206341" target="_blank">这帖所说的问题</a>。早期JDK 6似乎都受这问题影响，一直到JDK 6 update 14才修复。</h1>
<h1 id="12-xmn-xx-newratio">12、-Xmn 与 -XX:NewRatio</h1>
<h1 id="13-xx-newratio-xx-newsize-xx-oldsize">13、-XX:NewRatio 与 -XX:NewSize、-XX:OldSize</h1>
<p>14、jmap -heap看到的参数值与实际起作用的参数的关系？
发了几个例子在这里：<a href="https://gist.github.com/1363195" target="_blank"><a href="https://gist.github.com/1363195">https://gist.github.com/1363195</a></a>
其中有个看起来很恐怖的值：
Java代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>MaxNewSize       = 17592186044415 MB<br>MaxNewSize = 17592186044415 MB
这是啥来的？
C++代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>product(uintx, MaxNewSize, max_uintx,                                  \  </p>
</li>
<li>&quot;Maximum new generation size (in bytes), max_uintx means set &quot; \  </li>
<li><p>&quot;ergonomically&quot;)<br>product(uintx, MaxNewSize, max_uintx, \ &quot;Maximum new generation size (in bytes), max_uintx means set &quot; \ &quot;ergonomically&quot;)
在HotSpot VM里，intx是跟平台字长一样宽的带符号整型，uintx是其无符号版。
max_uintx是(uintx) -1，也就是说在32位平台上是无符号的0xFFFFFFFF，64位平台上则是0xFFFFFFFFFFFFFFFF。
jmap -heap显示的部分参数是以MB为单位来显示的，而MaxNewSize的单位是byte。我跑例子的平台是64位的，于是算一下 0xFFFFFFFFFFFFFFFF / 1024 / 1024 = 17592186044415 MB 。
参数的说明告诉我们，当MaxNewSize的值等于max_uintx时，意思就是交由ergonomics来自动选择young gen的最大大小。<strong>并不是说young gen的最大大小真的有0xFFFFFFFFFFFFFFFF这么大</strong>。
要注意的是，HotSpot VM有大量可调节的参数，并不是所有参数在某次运行的时候都有效。
例如说设置了-Xmn的话，NewRatio就没作用了。
又例如说，
C++代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>product(uintx, OldSize, ScaleForWordSize(4/*M),        \  </p>
</li>
<li><p>&quot;Initial tenured generation size (in bytes)&quot;) \<br>product(uintx, OldSize, ScaleForWordSize(4/*M), \ &quot;Initial tenured generation size (in bytes)&quot;) \
-XX:OldSize参数的默认值在32位平台上是4M，在64位平台上是5M多。但如果这个参数没有被显式设置过，那它实际上是没作用的；old gen的大小会通过Java heap的整体大小与young gen的大小配置计算出来，但OldSize参数却没有被更新（因为根本没用它）。于是这个参数的值与实际运行的状况就可能会不相符。
一种例外的情况是，如果-Xmx非常小，比NewSize+OldSize的默认值还小，那这个OldSize的默认值就会起作用，把MaxHeapSize给撑大。
C++代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>void TwoGenerationCollectorPolicy::initialize_flags() {  </p>
</li>
<li>GenCollectorPolicy::initialize_flags();  </li>
<li></li>
<li>OldSize = align_size_down(OldSize, min_alignment());  </li>
<li>if (NewSize + OldSize &gt; MaxHeapSize) {  </li>
<li>MaxHeapSize = NewSize + OldSize;  </li>
<li>}  </li>
<li>MaxHeapSize = align_size_up(MaxHeapSize, max_alignment());  </li>
<li>//...  </li>
<li><p>}<br>void TwoGenerationCollectorPolicy::initialize_flags() { GenCollectorPolicy::initialize_flags(); OldSize = align_size_down(OldSize, min_alignment()); if (NewSize + OldSize &gt; MaxHeapSize) { MaxHeapSize = NewSize + OldSize; } MaxHeapSize = align_size_up(MaxHeapSize, max_alignment()); //... }</p>
<h1 id="-https-gist-github-com-1375782-https-gist-github-com-1375782-">可以看这边的一个例子：<a href="https://gist.github.com/1375782" target="_blank"><a href="https://gist.github.com/1375782">https://gist.github.com/1375782</a></a></h1>
<p>15、-XX:+AlwaysTenure、-XX:+NeverTenure、-XX:MaxTenuringThreshold=0 或 &quot;-XX:MaxTenuringThreshold=markOopDesc::max_age + 1&quot;
ParNew的时候，设定-XX:+AlwaysTenure隐含-XX:MaxTenuringThreshold=0；不过-XX:+NeverTenure却没啥特别的作用。</p>
<h1 id="-xx-alwaystenure-xx-nevertenure-">-XX:+AlwaysTenure 与 -XX:+NeverTenure 是互斥的，最后一个出现的那个会同时决定这两个参数的值。</h1>
<p>16、-XX:MaxTenuringThreshold 的默认值？
C++代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>product(intx, MaxTenuringThreshold,    15, \  </p>
</li>
<li><p>&quot;Maximum value for tenuring threshold&quot;)  \<br>product(intx, MaxTenuringThreshold, 15, \ &quot;Maximum value for tenuring threshold&quot;) \
Oracle/Sun JDK 6中，选择CMS之外的GC时，MaxTenuringThreshold（以下简称MTT）的默认值是15；而选择了CMS的时候，MTT的默认值是4而不是15。设定是在 Arguments::set_cms_and_parnew_gc_flags() 里做的。
在Sun JDK 6之前（1.4.2、5），选择CMS的时候MTT的默认值则是0，也就是等于设定了-XX:+AlwaysTenure——所有eden里的活对象在经历第一次minor GC的时候就会直接晋升到old gen，而survivor space直接就没用了。
Command prompt代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>$ java -version  </p>
</li>
<li>java version &quot;1.6.0_25&quot;  </li>
<li>Java(TM) SE Runtime Environment (build 1.6.0_25-b06)  </li>
<li>Java HotSpot(TM) 64-Bit Server VM (build 20.0-b11, mixed mode)  </li>
<li>$ java -XX:+PrintFlagsFinal | egrep &#39;MaxTenuringThreshold|UseParallelGC|UseConcMarkSweepGC&#39;  </li>
<li>intx MaxTenuringThreshold                      = 15              {product}             </li>
<li>bool UseConcMarkSweepGC                        = false           {product}             </li>
<li>bool UseParallelGC                            := true            {product}             </li>
<li>$ java -XX:+PrintFlagsFinal -XX:+UseConcMarkSweepGC | egrep &#39;MaxTenuringThreshold|UseParallelGC|UseConcMarkSweepGC&#39;  </li>
<li>intx MaxTenuringThreshold                     := 4               {product}             </li>
<li>bool UseConcMarkSweepGC                       := true            {product}             </li>
<li><p>bool UseParallelGC                             = false           {product}             </p>
<h1 id="-java-version-java-version-1-6-0_25-java-tm-se-runtime-environment-build-1-6-0_25-b06-java-hotspot-tm-64-bit-server-vm-build-20-0-b11-mixed-mode-java-xx-printflagsfinal-egrep-maxtenuringthreshold-useparallelgc-useconcmarksweepgc-intx-maxtenuringthreshold-15-product-bool-useconcmarksweepgc-false-product-bool-useparallelgc-true-product-java-xx-printflagsfinal-xx-useconcmarksweepgc-egrep-maxtenuringthreshold-useparallelgc-useconcmarksweepgc-intx-maxtenuringthreshold-4-product-bool-useconcmarksweepgc-true-product-bool-useparallelgc-false-product-">$ java -version java version &quot;1.6.0_25&quot; Java(TM) SE Runtime Environment (build 1.6.0_25-b06) Java HotSpot(TM) 64-Bit Server VM (build 20.0-b11, mixed mode) $ java -XX:+PrintFlagsFinal | egrep &#39;MaxTenuringThreshold|UseParallelGC|UseConcMarkSweepGC&#39; intx MaxTenuringThreshold = 15 {product} bool UseConcMarkSweepGC = false {product} bool UseParallelGC := true {product} $ java -XX:+PrintFlagsFinal -XX:+UseConcMarkSweepGC | egrep &#39;MaxTenuringThreshold|UseParallelGC|UseConcMarkSweepGC&#39; intx MaxTenuringThreshold := 4 {product} bool UseConcMarkSweepGC := true {product} bool UseParallelGC = false {product}</h1>
<p>17、-XX:+CMSClassUnloadingEnabled</p>
<h1 id="cms-remark-string-intern-">CMS remark暂停时间会增加，所以如果类加载并不频繁、String的intern也没有大量使用的话，这个参数还是不开的好。</h1>
<h1 id="18-xx-aggressiveheap">18、-XX:+AggressiveHeap</h1>
<p>19、-XX:+UseCompressedOops 有益？有害？
先把微博上回复别人问题的解答放这边。
本来如果功能没bug的话，Oracle/Sun JDK 6的64位HotSpot上，GC堆在26G以下（-Xmx + -XX:MaxPermSize）的时候用多数都是有益的。
开启压缩指针后，从代码路径（code path）和CPI（cycles per instruction）两个角度看，情况是不一样的：
·开启压缩指针会使代码路径变长，因为所有在GC堆里的、指向GC堆内对象的指针都会被压缩，这些指针的访问就需要更多的代码才可以实现。不要以为只是读写字段才受影响，其实实例方法调用、子类型检查等操作也受影响——“klass”也是一个指针，也被压缩了。
·但从CPI的角度看，由于压缩指针使需要拷贝的数据量变小了，cache miss的几率随之降低，结果CPI可能会比压缩前降低。综合来看，开了压缩指针通常能大幅降低GC堆内存的消耗，同时维持或略提高Java程序的速度。
但，JDK6u23之前那个参数的bug实在太多，最好别用；而6u23之后它就由ergonomics自动开启了，不用自己设。如果在6u23或更高版本碰到压缩指针造成的问题的话，显式设置 <strong>-XX:-UseCompressedOops</strong> 。
我能做的建议是如果在64位Oracle/Sun JDK 6/7上，那个参数不要显式设置。
关于HotSpot VM的ergonomics自动开启压缩指针功能，请参考<a href="http://rednaxelafx.iteye.com/blog/1010079" target="_blank">之前的一帖</a>。</p>
<h1 id="-vm-berkeley-db-java-edition-http-www-oracle-com-technetwork-database-berkeleydb-overview-index-093405-html-bdb-je-xx-usecompressedoops-bdb-je-java-permgen-32gb-xx-usecompressedoops-warning-on-compressed-oops-https-forums-oracle-com-forums-thread-jspa-messageid-10017916-">有些库比较“聪明”，会自行读取VM参数来调整自己的一些参数，例如<a href="http://www.oracle.com/technetwork/database/berkeleydb/overview/index-093405.html" target="_blank">Berkeley DB Java Edition</a>。但这些库实现得不好的时候反而会带来一些麻烦：BDB JE要求<strong>显式指定-XX:+UseCompressedOops</strong>才能有效的调整它的缓存大小。所以在用BDB JE并且Java堆+PermGen大小小于32GB的时候，请显式指定-XX:+UseCompressedOops吧。参考<a href="https://forums.oracle.com/forums/thread.jspa?messageID=10017916" target="_blank">Warning on Compressed Oops</a></h1>
<p>20、-XX:LargePageSizeInBytes=128m ？
或者是 -XX:LargePageSizeInBytes=256m ？
其实这个参数的值是多少不是问题，问题是这个参数到底有没有起作用。
或许有人读过很老的调优建议资料，例如这个：
<a href="http://java.sun.com/performance/reference/whitepapers/tuning.html#section4.2.3" target="_blank">(2005) Java Tuning White Paper - 4.2.3 Tuning Example 3: Try 256 MB pages</a>
或者是别的一些内容很老的资料。它们提到了-XX:LargePageSizeInBytes=参数。这些老资料也没说错，在Sun JDK 5里 -XX:LargePageSizeInBytes= 参数只在Solaris上有效，使用的时候没有别的参数保护。
但是，实际上这个参数在Oracle/Sun JDK 6里不配合-XX:+UseLargePages的话是不会起任何作用的。
JDK 6里的JVM的Linux版上初始化large page的地方：
C++代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>bool os::large_page_init() {  </p>
</li>
<li>if (!UseLargePages) return false;  </li>
<li></li>
<li>if (LargePageSizeInBytes) {  </li>
<li>_large_page_size = LargePageSizeInBytes;  </li>
<li>} else {  </li>
<li>// ...  </li>
<li>}  </li>
<li></li>
<li>// ...  </li>
<li></li>
<li>// Large page support is available on 2.6 or newer kernel, some vendors  </li>
<li>// (e.g. Redhat) have backported it to their 2.4 based distributions.  </li>
<li>// We optimistically assume the support is available. If later it turns out  </li>
<li>// not true, VM will automatically switch to use regular page size.  </li>
<li>return true;  </li>
<li><p>}<br>bool os::large_page_init() { if (!UseLargePages) return false; if (LargePageSizeInBytes) { _large_page_size = LargePageSizeInBytes; } else { // ... } // ... // Large page support is available on 2.6 or newer kernel, some vendors // (e.g. Redhat) have backported it to their 2.4 based distributions. // We optimistically assume the support is available. If later it turns out // not true, VM will automatically switch to use regular page size. return true; }
看到了么，没有将UseLargePages设置为true的话，LargePageSizeInBytes根本没机会被用上。
对应的，Solaris版：
C++代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>bool os::large_page_init() {  </p>
</li>
<li>if (!UseLargePages) {  </li>
<li>UseISM = false;  </li>
<li>UseMPSS = false;  </li>
<li>return false;  </li>
<li>}  </li>
<li></li>
<li>// ...  </li>
<li><p>}<br>bool os::large_page_init() { if (!UseLargePages) { UseISM = false; UseMPSS = false; return false; } // ... }
以及Windows版：
C++代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>bool os::large_page_init() {  </p>
</li>
<li>if (!UseLargePages) return false;  </li>
<li></li>
<li>// ...  </li>
<li>}<br>bool os::large_page_init() { if (!UseLargePages) return false; // ... }<h1 id="-oracle-sun-jdk-6-oracle-jdk-7-xx-largepagesizeinbytes-xx-uselargepages-large-pages-regular-pages-">在Oracle/Sun JDK 6以及Oracle JDK 7上要使用 -XX:LargePageSizeInBytes= 的话，请务必也设置上 -XX:+UseLargePages 。使用这两个参数之前最好先确认操作系统是否真的只是large pages；操作系统不支持的话，设置这两个参数也没作用，只会退回到使用regular pages而已。</h1>
21、-XX:+AlwaysPreTouch
会把commit的空间跑循环赋值为0以达到“pretouch”的目的。开这个参数会增加VM初始化时的开销，但后面涉及虚拟内存的开销可能降低。<h1 id="-http-hllvm-group-iteye-com-group-topic-28839-209144-http-hllvm-group-iteye-com-group-topic-28839-209144-">在另一个讨论帖里有讲该参数：<a href="http://hllvm.group.iteye.com/group/topic/28839#209144" target="_blank"><a href="http://hllvm.group.iteye.com/group/topic/28839/#209144">http://hllvm.group.iteye.com/group/topic/28839/#209144</a></a></h1>
<h1 id="22-xx-usetlab-runtime-freememory-">22、-XX:+UseTLAB 与 Runtime.freeMemory()</h1>
23、-XX:+ParallelRefProcEnabled
这个功能可以加速reference processing，但在JDK6u25和6u26上不要使用，有bug：<h1 id="-bug-id-7028845-cms-6984287-broke-parallel-reference-processing-in-cms-http-bugs-sun-com-bugdatabase-view_bug-do-bug_id-7028845-"><a href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=7028845" target="_blank">Bug ID 7028845: CMS: 6984287 broke parallel reference processing in CMS</a></h1>
24、-XX:+UseConcMarkSweepGC 与 -XX:+UseAdaptiveSizePolicy
这两个选项在现有的Oracle/Sun JDK 6和Oracle JDK 7上都不要搭配在一起使用——CMS用的adaptive size policy还没实现完，用的话可能会crash。
目前HotSpot VM上只有ParallelScavenge系的GC才可以配合-XX:+UseAdaptiveSizePolicy使用；也就是只有-XX:+UseParallelGC或者-XX:+UseParallelOldGC。<a href="http://mail.openjdk.java.net/pipermail/hotspot-gc-use/2011-November/000954.html" target="_blank">Jon Masamitsu在邮件列表上提到过</a>。<h1 id="-useadaptivesizepolicy-parallelscavenge-survivor-space-jon-masamitsu-http-mail-openjdk-java-net-pipermail-hotspot-gc-use-2012-october-001390-html-">题外话：开着UseAdaptiveSizePolicy的ParallelScavenge会动态调整各空间的大小，有可能会造成两个survivor space的大小被调整得不一样大。Jon Masamitsu在<a href="http://mail.openjdk.java.net/pipermail/hotspot-gc-use/2012-October/001390.html" target="_blank">这封邮件</a>里解释了原因。</h1>
25、-XX:+UseAdaptiveGCBoundary<h1 id="jdk-6-bug-">JDK 6里不要用这个选项，有bug。</h1>
26、-XX:HeapDumpPath 与 -XX:+HeapDumpBeforeFullGC、-XX:+HeapDumpAfterFullGC、-XX:+HeapDumpOnOutOfMemoryError
-XX:+HeapDumpBeforeFullGC、-XX:+HeapDumpAfterFullGC、-XX:+HeapDumpOnOutOfMemoryError 这几个参数可以在不同条件下做出HPROF格式的heap dump。但很多人都会疑惑：做出来的heap dump存到哪里去了？
如果不想费神去摸索到底各种环境被配置成什么样、“working directory”到底在哪里的话，就在VM启动参数里加上 <strong>-XX:HeapDumpPath=一个绝对路径</strong> 吧。这样，自动做出的heap dump就会被存到指定的目录里去。<h1 id="-working-directory-">当然相对路径也支持，不过用了相对路径就又得弄清楚当前的“working directory”在哪里了。</h1>
26、UseDepthFirstScavengeOrder
以前有过这样一个参数可以设置young gen遍历对象图的顺序，深度还是广度优先不过高于JDK 6 update 22就没用了，ParallelScavenge变为只用深度优先而不用广度优先。
具体的changeset在这里：<a href="http://hg.openjdk.java.net/hsx/hotspot-main/hotspot/rev/9d7a8ab3736b" target="_blank"><a href="http://hg.openjdk.java.net/hsx/hotspot-main/hotspot/rev/9d7a8ab3736b">http://hg.openjdk.java.net/hsx/hotspot-main/hotspot/rev/9d7a8ab3736b</a></a>
HotSpot VM里的arguments.cpp文件里有obsolete_jvm_flags数组，那边声明的参数都要留意是已经没用的。
（下文待续～）
<img src="" alt="Spinner"> <a href="http://learnworld.iteye.com/" target="_blank"><img src="&quot;learnworld的博客: 一路远行&quot;" alt="learnworld的博客"></a> <a href="http://learnworld.iteye.com/" title="learnworld" target="_blank">learnworld</a> 2011-10-23</li>
</ol>
<p>好贴，坐等下文。
<img src="" alt="Spinner"> <a href="http://jolestar.iteye.com/" target="_blank"><img src="&quot;jolestar的博客: 午夜咖啡&quot;" alt="jolestar的博客"></a> <a href="http://jolestar.iteye.com/" title="jolestar" target="_blank">jolestar</a> 2011-10-23</p>
<p>lz不厚道，说了个半句话就闪了。太吊胃口了。
<img src="" alt="Spinner"> <a href="http://boy00fly.iteye.com/" target="_blank"><img src="&quot;boy00fly的博客: 石头边的老牛&quot;" alt="boy00fly的博客"></a> <a href="http://boy00fly.iteye.com/" title="boy00fly" target="_blank">boy00fly</a> 2011-10-24</p>
<p>jolestar 写道</p>
<p>lz不厚道，说了个半句话就闪了。太吊胃口了。
哈哈，确实吊胃口。。下文呢？
<img src="" alt="Spinner"> <a href="http://icanfly.iteye.com/" target="_blank"><img src="&quot;icanfly的博客: 老罗宣言&quot;" alt="icanfly的博客"></a> <a href="http://icanfly.iteye.com/" title="icanfly" target="_blank">icanfly</a> 2011-10-24</p>
<p>好文。<img src="" alt="">
<img src="" alt="Spinner"> <a href="http://liuyes.iteye.com/" target="_blank"><img src="&quot;liuyes的博客: &quot;" alt="liuyes的博客"></a> <a href="http://liuyes.iteye.com/" title="liuyes" target="_blank">liuyes</a> 2011-10-24</p>
<p>楼主人呢？这发文的也有坑<img src="" alt="">
<img src="" alt="Spinner"> <a href="http://khotyn.iteye.com/" target="_blank"><img src="&quot;khotyn的博客: 码工作坊&quot;" alt="khotyn的博客"></a> <a href="http://khotyn.iteye.com/" title="khotyn" target="_blank">khotyn</a> 2011-10-24</p>
<p>坐等R大把坑填上～～
<img src="" alt="Spinner"> <a href="http://furturestrategist.iteye.com/" target="_blank"><img src="&quot;程序新手的博客: HappyProgramme&quot;" alt="程序新手的博客"></a> <a href="http://furturestrategist.iteye.com/" title="程序新手" target="_blank">程序新手</a> 2011-10-24</p>
<p>内容受益、风格简洁，期待下文
  另外大胆猜测从日志中获取的信息是部分FULL GC由System.gc()引发的
  Full GC (System)
<img src="" alt="Spinner"> <a href="http://furturestrategist.iteye.com/" target="_blank"><img src="&quot;程序新手的博客: HappyProgramme&quot;" alt="程序新手的博客"></a> <a href="http://furturestrategist.iteye.com/" title="程序新手" target="_blank">程序新手</a> 2011-10-25</p>
<p>又受益了 <img src="" alt=""> ..想了解大大收集这些知识点的方法~
<img src="" alt="Spinner"> <a href="http://hittyt.iteye.com/" target="_blank"><img src="&quot;hittyt的博客: 笨小孩&quot;" alt="hittyt的博客"></a> <a href="http://hittyt.iteye.com/" title="hittyt" target="_blank">hittyt</a> 2011-11-08</p>
<p>本人的java环境如下：
Command line代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>java -version  </li>
<li>java version &quot;1.6.0_18&quot;  </li>
<li>Java(TM) SE Runtime Environment (build 1.6.0_18-b07)  </li>
<li><p>Java HotSpot(TM) 64-Bit Server VM (build 16.0-b13, mixed mode)<br>java -version java version &quot;1.6.0_18&quot; Java(TM) SE Runtime Environment (build 1.6.0_18-b07) Java HotSpot(TM) 64-Bit Server VM (build 16.0-b13, mixed mode)
但使用PrintFlagsFinal时得到的输出却是下面的结果：
Command line代码 <a href="&quot;复制代码&quot;"><img src="" alt="复制代码"></a> <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>java -XX:+PrintFlagsFinal  </p>
</li>
<li>Unrecognized VM option &#39;+PrintFlagsFinal&#39;  </li>
<li>Could not create the Java virtual machine.<br>java -XX:+PrintFlagsFinal Unrecognized VM option &#39;+PrintFlagsFinal&#39; Could not create the Java virtual machine.
求LZ解答问题在哪里呢？
<img src="" alt="Spinner"></li>
</ol>
<p><img src="" alt=""> <a href="http://hllvm.group.iteye.com/group/topic/27945/post/new" target="_blank">发表回复</a></p>
<p>« 上一页 1 <a href="http://hllvm.group.iteye.com/group/topic/27945?page=2" target="_blank">2</a> <a href="http://hllvm.group.iteye.com/group/topic/27945?page=3" target="_blank">3</a> <a href="http://hllvm.group.iteye.com/group/topic/27945?page=2" target="_blank">下一页 »</a></p>
<p><a href="http://hllvm.group.iteye.com/" target="_blank">&gt;&gt;返回群组首页</a></p>
<p><a href="http://hllvm.group.iteye.com/" target="_blank"><img src="&quot;高级语言虚拟机: 关注各种高级语言虚拟机（high-level language virtual machine，HLL VM）的设计与实现，泛化至各种高级语言的运行时的设计与实现。讨论范围包括JVM、CLI、Parrot等当前流行的VM平台，也包括Python、Ruby、JavaScript、Lua、Perl、Forth、Smalltalk等众多语言的引擎，还有历史上有影响的各种高级语言虚拟机，如SECD等。&quot;" alt="高级语言虚拟机群组"></a></p>
<h3 id="-">相关讨论</h3>
<ul>
<li><a href="http://www.iteye.com/topic/212967" target="_blank">一次Java垃圾收集调优实战</a></li>
<li><a href="http://www.iteye.com/topic/894148" target="_blank">HotSpot VM 内存堆的两个Servivor区</a></li>
<li><a href="http://www.iteye.com/topic/802638" target="_blank">JVM内存管理：深入垃圾收集器与内存分配策略</a></li>
<li><a href="http://www.iteye.com/topic/473874" target="_blank">CMS gc实践总结</a></li>
<li><a href="http://www.iteye.com/topic/756538" target="_blank">优化JVM参数提高eclipse运行速度</a></li>
<li><a href="http://www.iteye.com/" target="_blank">首页</a></li>
<li><a href="http://www.iteye.com/news" target="_blank">资讯</a></li>
<li><a href="http://www.iteye.com/magazines" target="_blank">精华</a></li>
<li><a href="http://www.iteye.com/forums" target="_blank">论坛</a></li>
<li><a href="http://www.iteye.com/ask" target="_blank">问答</a></li>
<li><a href="http://www.iteye.com/blogs" target="_blank">博客</a></li>
<li><a href="http://www.iteye.com/blogs/subjects" target="_blank">专栏</a></li>
<li><a href="http://www.iteye.com/groups" target="_blank">群组</a></li>
<li><a href="http://job.iteye.com/iteye" target="_blank">招聘</a></li>
<li><a href="http://www.iteye.com/search" target="_blank">搜索</a></li>
<li><a href="http://hllvm.group.iteye.com/index/service" target="_blank">广告服务</a></li>
<li><a href="http://webmaster.iteye.com/" target="_blank">ITeye黑板报</a></li>
<li><a href="http://hllvm.group.iteye.com/index/contactus" target="_blank">联系我们</a></li>
<li><a href="http://hllvm.group.iteye.com/index/friend_links" target="_blank">友情链接</a></li>
</ul>
<p>© 2003-2012 ITeye.com. [ <a href="http://www.miibeian.gov.cn/" target="_blank">京ICP证110151号</a> 京公网安备110105010620 ]
百联优力(北京)投资有限公司 版权所有 <img src="http://stat.iteye.com/?url=http%3A%2F%2Fhllvm.group.iteye.com%2Fgroup%2Ftopic%2F27945&amp;referrer=http%3A%2F%2Fhllvm.group.iteye.com%2F&amp;user_id=" alt=""></p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li></span><span class="breadcrumb"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li><li><a href="/categories/Java&J2EE/JVM/">JVM</a></li></span></span> | <span class="tags">Tagged <a href="/tags/JVM/" class="label label-primary">JVM</a><a href="/tags/Java&J2EE/" class="label label-success">Java&J2EE</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:42"datetime="2014-03-07 09:54:42"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-JVM--JVM调优的-标准参数-的各种陷阱/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JavaJ2EE-JVM--JVM调优的-标准参数-的各种陷阱" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--Java7的新特性一览表/">Java 7 的新特性一览表</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:42.000Z"> <a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--Java7的新特性一览表/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="java-7-">Java 7 的新特性一览表</h1>
<h1 id="java-7-">Java 7 的新特性一览表</h1>
<p><a href="http://my.oschina.net/javayou" target="_blank">红薯</a> 发布于： 2011年07月27日 (<a href="">82评</a>)</p>
<p><strong>分享到 </strong></p>
<p><a href="&quot;分享到新浪微博&quot;">新浪微博</a><a href="&quot;分享到腾讯微博&quot;">腾讯微博</a>
<a href="&quot;收藏此新闻&quot;">收藏</a>+72
<img src="" alt=""></p>
<p>官方说是 7月28日 正式发布 Java 7 ，正常的话我们应该在 7月29日 看到这个版本。很快了，就两天时间。</p>
<p>发布之前让我们先来看看 Java 7 都有什么新特性吧。</p>
<p>Java 7 的架构图：</p>
<p><img src="" alt=""></p>
<p>新特性一览表：</p>
<p><strong>Swing</strong></p>
<ul>
<li>新增 <a href="http://download.oracle.com/javase/7/docs/api/javax/swing/JLayer.html">
JLayer
</a> 类，是一个灵活而且功能强大的Swing组件修饰器，使用方法：<a href="http://download.oracle.com/javase/tutorial/uiswing/misc/jlayer.html" target="_blank">How to Decorate Components with JLayer</a>.</li>
<li><a href="http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/nimbus.html" target="_blank">Nimbus Look and Feel</a> 外观从</li>
</ul>
<p>com.sun.java.swing
包移到</p>
<p>javax.swing
包中，详情：<a href="http://download.oracle.com/javase/7/docs/api/javax/swing/plaf/nimbus/package-summary.html">
javax.swing.plaf.nimbus
</a></p>
<ul>
<li><a href="http://java.sun.com/developer/technicalArticles/GUI/mixing_components/index.html" target="_blank">更轻松的重量级和轻量级组件的混合</a></li>
<li>支持透明窗体以及非矩形窗体的图形界面，请看 <a href="http://download.oracle.com/javase/tutorial/uiswing/misc/trans_shaped_windows.html" target="_blank">How to Create Translucent and Shaped Windows</a></li>
<li><a href="http://download.oracle.com/javase/7/docs/api/javax/swing/JColorChooser.html">
JColorChooser
</a> 类新增 HSV tab.</li>
</ul>
<p><strong>网络</strong></p>
<ul>
<li>新增
<a href="http://download.oracle.com/javase/7/docs/api/java/net/URLClassLoader.html#close%28%29">
URLClassLoader.close
</a> 方法，请看 <a href="http://download.oracle.com/javase/7/docs/technotes/guides/net/ClassLoader.html" target="_blank">Closing a URLClassLoader</a>.</li>
<li>支持 Sockets Direct Protocol (SDP) 提供高性能网络连接，详情请看 <a href="http://download.oracle.com/javase/tutorial/sdp/sockets/index.html" target="_blank">Understanding the Sockets Direct Protocol</a>.</li>
</ul>
<p><strong>集合</strong></p>
<ul>
<li>新增
<a href="http://download.oracle.com/javase/7/docs/api/java/util/concurrent/TransferQueue.html">
TransferQueue
</a> 接口，是 <a href="http://download.oracle.com/javase/7/docs/api/java/util/concurrent/BlockingQueue.html">
BlockingQueue
</a> 的改进版，实现类为 <a href="http://download.oracle.com/javase/7/docs/api/java/util/concurrent/LinkedTransferQueue.html">
LinkedTransferQueue
</a></li>
</ul>
<p><strong>RIA/发布</strong></p>
<ul>
<li>拖拽的小程序使用一个默认或者定制的标题进行修饰，详情：<a href="http://download.oracle.com/javase/tutorial/deployment/applet/draggableApplet.html#decoration" target="_blank">Requesting and Customizing Applet Decoration in Draggable Applets</a>.</li>
<li><p>JNLP 文件做了如下方面的增强，详情请看 <a href="http://download.oracle.com/javase/7/docs/technotes/guides/javaws/developersguide/syntax.html" target="_blank">JNLP File Syntax</a>:</p>
</li>
<li><p>The</p>
</li>
</ul>
<p>os
attribute in the</p>
<p>information
and</p>
<p>resources
elements can now contain specific versions of Windows, such as Windows Vista or Windows 7.</p>
<ul>
<li>Applications can use the</li>
</ul>
<p>install
attribute in the</p>
<p>shortcut
element to specify their their desire to be installed. Installed applications are not removed when the Java Web Start cache is cleared, but can be explicitly removed using the Java Control Panel.</p>
<ul>
<li>Java Web Start applications can be deployed without specifying the</li>
</ul>
<p>codebase
attribute; see <a href="http://download.oracle.com/javase/tutorial/deployment/deploymentInDepth/deployingWithoutCodebase.html" target="_blank">Deploying Without Codebase</a></p>
<ul>
<li>可直接在 HTML 中嵌入 JNLP 文件：<a href="http://download.oracle.com/javase/tutorial/deployment/deploymentInDepth/embeddingJNLPFileInWebPage.html" target="_blank">Embedding JNLP File in Applet Tag</a>.</li>
<li>可在 JavaScript 代码中检查 Applet 是否已经加载完成：<a href="http://download.oracle.com/javase/tutorial/deployment/applet/appletStatus.html" target="_blank">Handling Initialization Status With Event Handlers</a>.</li>
<li>可在 Applet 从快捷方式启动或者拖出浏览器时对窗口样式和标题进行控制：<a href="http://download.oracle.com/javase/tutorial/deployment/applet/draggableApplet.html#decoration" target="_blank">Requesting and Customizing Applet Decoration</a> in <a href="http://download.oracle.com/javase/tutorial/deployment/applet/draggableApplet.html" target="_blank">Developing Draggable Applets</a>.</li>
</ul>
<p><strong>XML</strong></p>
<ul>
<li>包含 <a href="http://jaxp.java.net/" target="_blank">Java API for XML Processing</a> (JAXP) 1.4.5, 支持 <a href="http://jaxb.java.net/" target="_blank">Java Architecture for XML Binding</a> (JAXB) 2.2.3, 和 <a href="http://jax-ws.java.net/" target="_blank">Java API for XML Web Services</a> (JAX-WS) 2.2.4.</li>
</ul>
<p><strong>java.lang 包</strong></p>
<ul>
<li>消除了在多线程环境下的非层次话类加载时导致的潜在死锁，详情：<a href="http://download.oracle.com/javase/7/docs/technotes/guides/lang/cl-mt.html" target="_blank">Multithreaded Custom Class Loaders in Java SE 7</a>.</li>
</ul>
<p><strong>Java 虚拟机</strong></p>
<ul>
<li><a href="http://download.oracle.com/javase/7/docs/technotes/guides/vm/multiple-language-support.html" target="_blank">支持非 Java 语言</a>: Java SE 7 引入一个新的 JVM 指令用于简化实现动态类型编程语言</li>
<li><a href="http://download.oracle.com/javase/7/docs/technotes/guides/vm/G1.html" target="_blank">Garbage-First Collector</a> 是一个服务器端的垃圾收集器用于替换 Concurrent Mark-Sweep Collector (CMS).</li>
<li><a href="http://download.oracle.com/javase/7/docs/technotes/guides/vm/performance-enhancements-7.html" target="_blank">提升了 Java HotSpot 虚拟机的性能</a></li>
</ul>
<p><strong>Java I/O</strong></p>
<p><a href="http://download.oracle.com/javase/7/docs/api/java/nio/file/package-summary.html">
java.nio.file
</a> 包以及相关的包 <a href="http://download.oracle.com/javase/7/docs/api/java/nio/file/attribute/package-summary.html">
java.nio.file.attribute
</a> 提供对文件 I/O 以及访问文件系统的全面支持，请看 <a href="http://download.oracle.com/javase/tutorial/essential/io/fileio.html" target="_blank">File I/O (featuring NIO.2)</a>.</p>
<ul>
<li>目录</li>
</ul>
<p><em><Java home></em>/sample/nio/chatserver/
包含使用 java.nio.file 包的演示程序</p>
<ul>
<li>目录</li>
</ul>
<p><em><Java home></em>/demo/nio/zipfs/
包含 NIO.2 NFS 文件系统的演示程序</p>
<p><strong>安全性</strong></p>
<ul>
<li>新的内置对多个基于 ECC 算法(ECDSA/ECDH)的支持，详情请看：<a href="http://download.oracle.com/javase/7/docs/technotes/guides/security/p11guide.html#ALG" target="_blank">Sun PKCS/#11 Provider&#39;s Supported Algorithms</a> in <a href="http://download.oracle.com/javase/7/docs/technotes/guides/security/p11guide.html" target="_blank">Java PKCS/#11 Reference Guide</a>.</li>
<li>禁用了一些弱加密算法，详情请看 <a href="http://download.oracle.com/javase/7/docs/technotes/guides/security/certpath/CertPathProgGuide.html#AppD" target="_blank">Appendix D: Disabling Cryptographic Algorithms</a> in <a href="http://download.oracle.com/javase/7/docs/technotes/guides/security/certpath/CertPathProgGuide.html" target="_blank">Java PKI Programmer&#39;s Guide</a> and <a href="http://download.oracle.com/javase/7/docs/technotes/guides/security/jsse/JSSERefGuide.html#DisabledAlgorithms" target="_blank">Disabled Cryptographic Algorithms</a> in <a href="http://download.oracle.com/javase/7/docs/technotes/guides/security/jsse/JSSERefGuide.html" target="_blank">Java Secure Socket Extension (JSSE) Reference Guide</a>.</li>
<li>Java 安全套接字扩展中对 SSL/TLS 的增强</li>
</ul>
<p><strong>并发</strong></p>
<ul>
<li><p>fork/join 框架，基于 <a href="http://download.oracle.com/javase/7/docs/api/java/util/concurrent/ForkJoinPool.html">
ForkJoinPool
</a> 类，是 <a href="http://download.oracle.com/javase/7/docs/api/java/util/concurrent/Executor.html">
Executor
</a> 接口的实现，设计它用来进行高效的运行大量任务；使用 work-stealing 技术用来保证大量的 worker 线程工作，特别适合多处理器环境，详情请看 <a href="http://download.oracle.com/javase/tutorial/essential/concurrency/forkjoin.html" target="_blank">Fork/Join</a></p>
</li>
<li><p>目录</p>
</li>
</ul>
<p><em><Java home></em>/sample/forkjoin/
包含了 fork/join 框架的演示程序</p>
<ul>
<li><a href="http://download.oracle.com/javase/7/docs/api/java/util/concurrent/ThreadLocalRandom.html">
ThreadLocalRandom
</a> 类class 消除了使用伪随机码线程的竞争，请看 <a href="http://download.oracle.com/javase/tutorial/essential/concurrency/threadlocalrandom.html" target="_blank">Concurrent Random Numbers</a>.</li>
<li><a href="http://download.oracle.com/javase/7/docs/api/java/util/concurrent/Phaser.html">
Phaser
</a> 类是一个新的同步的屏障，与 <a href="http://download.oracle.com/javase/7/docs/api/java/util/concurrent/CyclicBarrier.html">
CyclicBarrier
</a> 类似.</li>
</ul>
<p><strong>Java 2D</strong></p>
<ul>
<li>一个新的基于 XRender 的 Java 2D 渲染管道支持现在的 X11 桌面，改善了图形性能，请看 <a href="http://download.oracle.com/javase/7/docs/technotes/guides/2d/flags.html#xrender" target="_blank">System Properties for Java 2D Technology</a> 中的</li>
</ul>
<p>xrender
.</p>
<ul>
<li>JDK 可枚举并显示出已安装的 OpenType/CFF 字体，通过 <a href="http://download.oracle.com/javase/7/docs/api/java/awt/GraphicsEnvironment.html#getAvailableFontFamilyNames%28%29">
GraphicsEnvironment.getAvailableFontFamilyNames
</a> 方法 See <a href="http://download.oracle.com/javase/tutorial/2d/text/fonts.html" target="_blank">Selecting a Font</a>.</li>
<li><a href="http://download.oracle.com/javase/7/docs/api/java/awt/font/TextLayout.html">
TextLayout
</a> 类支持西藏语脚本</li>
<li>libfontconfig
, 是一个字体配置 api ，see <a href="http://www.fontconfig.org/" target="_blank">Fontconfig</a>.</li>
</ul>
<p><strong>国际化</strong></p>
<ul>
<li><p>支持 <a href="http://www.unicode.org/versions/Unicode6.0.0" target="_blank">Unicode 6.0.0</a> </p>
</li>
<li><p>目录</p>
</li>
</ul>
<p><em><Java home></em>/demo/jfc/Font2DTest/
包含 Unicode 6.0 的演示程序</p>
<ul>
<li>Java SE 7 可容纳在 ISO 4217 中新的货币，详情请看 <a href="http://download.oracle.com/javase/7/docs/api/java/util/Currency.html">
Currency
</a> 类.</li>
</ul>
<p><strong>Java 编程语言特性</strong></p>
<ul>
<li><a href="http://download.oracle.com/javase/7/docs/technotes/guides/language/binary-literals.html" target="_blank">二进制数字表达方式</a></li>
<li><a href="http://download.oracle.com/javase/7/docs/technotes/guides/language/underscores-literals.html" target="_blank">使用下划线对数字进行分隔表达，例如 1_322_222</a></li>
<li><a href="http://download.oracle.com/javase/7/docs/technotes/guides/language/strings-switch.html" target="_blank">switch 语句支持字符串变量</a></li>
<li><a href="http://download.oracle.com/javase/7/docs/technotes/guides/language/type-inference-generic-instance-creation.html" target="_blank">泛型实例创建的类型推断</a></li>
<li><a href="http://download.oracle.com/javase/7/docs/technotes/guides/language/non-reifiable-varargs.html" target="_blank">使用可变参数时，提升编译器的警告和错误信息</a></li>
<li><a href="http://download.oracle.com/javase/7/docs/technotes/guides/language/try-with-resources.html">try-with-resources 语句
</a></li>
<li><a href="http://download.oracle.com/javase/7/docs/technotes/guides/language/catch-multiple.html" target="_blank">同时捕获多个异常处理</a></li>
</ul>
<p><strong>JDBC 4.1</strong></p>
<ul>
<li>支持使用 <a href="http://download.oracle.com/javase/7/docs/technotes/guides/language/try-with-resources.html">
try
-with-resources</a> 语句进行自动的资源释放，包括连接、语句和结果集</li>
<li>支持 RowSet 1.1</li>
</ul>
<p>Java 的详细介绍：<a href="http://www.oschina.net/p/java" target="_blank">请点这里</a>
Java 的下载地址：<a href="http://www.oschina.net/action/project/go?id=16962&amp;p=download" target="_blank">请点这里</a>
想通过手机客户端访问开源中国：<a href="http://www.oschina.net/app" target="_blank">请点这里</a>
本站文章除注明转载外，均为本站原创或编译
欢迎任何形式的转载，但请务必注明出处，尊重他人劳动共创开源社区
转载请注明：文章转载自：<strong>开源中国社区</strong> [<a href="http://www.oschina.net/" target="_blank"><a href="http://www.oschina.net">http://www.oschina.net</a></a>]
本文标题：Java 7 的新特性一览表
本文地址：<a href="http://www.oschina.net/news/20119/new-features-of-java-7" target="_blank"><a href="http://www.oschina.net/news/20119/new-features-of-java-7">http://www.oschina.net/news/20119/new-features-of-java-7</a></a></p>
<p><strong>旧一篇：<a href="http://www.oschina.net/news/20118/kohana-3-2" target="_blank">Kohana 3.2 分支发布</a> 2年前</strong>
<strong>新一篇：<a href="http://www.oschina.net/news/20120/are-older-people-better" target="_blank">程序员越老越优秀吗？</a> 2年前</strong>
<strong>相关资讯</strong></p>
<ul>
<li><a href="http://www.oschina.net/news/42676/apache-uima-java-sdk-2-4-1" title="Apache UIMA Java SDK 2.4.1 发布" target="_blank">Apache UIMA Java SDK 2.4.1 发布...</a>2天前</li>
<li><a href="http://www.oschina.net/news/42651" title="Java Web快速开发平台 WebBuilder 6.8 发布" target="_blank">Java Web快速开发平台 WebBuilder 6...</a>3天前</li>
<li><a href="http://www.oschina.net/news/42295/spring-amqp-1-2-0-for-java" title="Spring AMQP 1.2.0 for Java 发布" target="_blank">Spring AMQP 1.2.0 for Java 发布...</a>15天前</li>
<li><a href="http://www.oschina.net/news/42225/fastjson-1-1-33" title="fastjson 1.1.33 发布，Java 的 JSON 库" target="_blank">fastjson 1.1.33 发布，Java 的 JS...</a>18天前</li>
<li><a href="http://www.oschina.net/news/42112/demux-framework-0-6-1" title="DEMUX Framework 0.6.1 发布，Java 框架" target="_blank">DEMUX Framework 0.6.1 发布，Java ...</a>22天前</li>
<li><a href="http://www.oschina.net/news/42092/aspose-email-for-java-3-1-0" title="Aspose.Email for Java 3.1.0 发布" target="_blank">Aspose.Email for Java 3.1.0 发布...</a>23天前</li>
<li><a href="http://www.oschina.net/news/41946/mariadb-java-client-1-1-3" title="MariaDB Java Client 1.1.3 发布" target="_blank">MariaDB Java Client 1.1.3 发布...</a>29天前</li>
<li><a href="http://www.oschina.net/news/41926/httl-1-0-10" title="HTTL 1.0.10 版本发布，Java 模版引擎" target="_blank">HTTL 1.0.10 版本发布，Java 模版引...</a>29天前</li>
<li><a href="http://www.oschina.net/news/41916/beetl-1-24" title="Beetl 1.24 发布，java模板引擎" target="_blank">Beetl 1.24 发布，java模板引擎...</a>29天前</li>
<li><p><a href="http://www.oschina.net/news/41863/freemarker-2-3-20" title="FreeMarker 2.3.20 发布，Java 模板引擎" target="_blank">FreeMarker 2.3.20 发布，Java 模板...</a>1个月前
<strong>相关讨论话题</strong></p>
</li>
<li><p><a href="http://www.oschina.net/question/1177024_120104" title="这样的状态不知道该不该留下来，求指教" target="_blank">这样的状态不知道该不该留下来，求指教</a>15小时前</p>
</li>
<li><a href="http://www.oschina.net/question/571225_120116" title="快速排序，眉庄说这个思路是极好的，可惜就是死了个循环TUT（java）" target="_blank">快速排序，眉庄说这个思路是极好的，...</a>14小时前</li>
<li><a href="http://www.oschina.net/question/817133_119906" title="每个职业都是有天花板的" target="_blank">每个职业都是有天花板的</a>2天前</li>
<li><a href="http://www.oschina.net/question/1170472_120132" title="eclipse怎么设置中文版？" target="_blank">eclipse怎么设置中文版？</a>13小时前</li>
<li><a href="http://www.oschina.net/question/49614_90267" title="android开发界面有什么好用的拖拽工具" target="_blank">android开发界面有什么好用的拖拽工...</a>5个月前</li>
<li><a href="http://www.oschina.net/question/944819_120014" title="两张大表对比找出差集" target="_blank">两张大表对比找出差集</a>昨天(20:05)</li>
<li><a href="http://www.oschina.net/question/571225_119905" title="疯狂JAVA里这段代码为什么first.count=3删除成功，为20就不成功了呢？" target="_blank">疯狂JAVA里这段代码为什么first.cou...</a>2天前</li>
<li><a href="http://www.oschina.net/question/43796_120102" title="有没有像Highcharts,D3这样的可视化java包" target="_blank">有没有像Highcharts,D3这样的可视化...</a>15小时前</li>
<li><a href="http://www.oschina.net/question/137332_120098" title="java 操作ldap, 怎么修改objectclass ， 或者定义自己的objectclass" target="_blank">java 操作ldap, 怎么修改objectcla...</a>15小时前</li>
<li><a href="http://www.oschina.net/question/1050447_120054" title="java计算大文件的md5，有什么快速方法吗" target="_blank">java计算大文件的md5，有什么快速方...</a>20小时前</li>
</ul>
<p><strong><a href="">X</a>你也许会喜欢</strong></p>
<ul>
<li><a href="http://www.oschina.net/news/42676/apache-uima-java-sdk-2-4-1" title="Apache UIMA Java SDK 2.4.1 发布" target="_blank">Apache UIMA Java SDK 2.4.1 发布</a>2天前</li>
<li><a href="http://www.oschina.net/news/42651" title="Java Web快速开发平台 WebBuilder 6.8 发布" target="_blank">Java Web快速开发平台 WebBuilder 6.8 发布...</a>3天前</li>
<li><a href="http://www.oschina.net/news/42295/spring-amqp-1-2-0-for-java" title="Spring AMQP 1.2.0 for Java 发布" target="_blank">Spring AMQP 1.2.0 for Java 发布</a>15天前</li>
</ul>
<h2 id="-82-"><a href="">回到顶部</a><a href="">发表评论</a> 网友评论，共 82 条</h2>
<ul>
<li><a href="http://my.oschina.net/zhangthe9" target="_blank"><img src="&quot;ddatsh&quot;" alt="ddatsh"></a> 1楼：<strong>dd</strong>发表于 2011-07-27 23:04 <a href="">回复此评论</a></li>
</ul>
<p>目前不关心</p>
<ul>
<li><a href="http://my.oschina.net/seamanmei" target="_blank"><img src="&quot;梅公子&quot;" alt="梅公子"></a> 2楼：<strong>幽幽</strong> 发表于 2011-07-27 23:06 <a href="">回复此评论</a></li>
</ul>
<p>我不想做小白鼠啊~</p>
<ul>
<li><a href="http://my.oschina.net/haorizi" target="_blank"><img src="&quot;haorizi&quot;" alt="haorizi"></a> 3楼：<strong>haorizi</strong>发表于 2011-07-27 23:08 <a href="">回复此评论</a></li>
</ul>
<p>鼓掌！！！</p>
<ul>
<li><a href="http://my.oschina.net/WilliamShen" target="_blank"><img src="&quot;CheckStyle&quot;" alt="CheckStyle"></a> 4楼：<strong>CheckStyle</strong>发表于 2011-07-28 00:14 <a href="">回复此评论</a></li>
</ul>
<p>有几项还是非常值得期待的</p>
<ul>
<li><a href="http://my.oschina.net/u/158986" target="_blank"><img src="&quot;穿着马甲的鸟&quot;" alt="穿着马甲的鸟"></a> 5楼：<strong>穿着马甲的鸟</strong> 发表于 2011-07-28 05:14 <a href="">回复此评论</a></li>
</ul>
<p>期待做小白鼠。。。</p>
<ul>
<li><a href="http://my.oschina.net/yidao620c" target="_blank"><img src="&quot;一刀&quot;" alt="一刀"></a> 6楼：<strong>一刀</strong> 发表于 2011-07-28 06:47 <a href="">回复此评论</a></li>
</ul>
<p>不错不错~~ JAVA加油</p>
<ul>
<li><a href="http://my.oschina.net/szpengvictor" target="_blank"><img src="&quot;景德真人&quot;" alt="景德真人"></a> 7楼：<strong>景德真人</strong> 发表于 2011-07-28 07:15 <a href="">回复此评论</a></li>
</ul>
<p>又要努力学习了</p>
<ul>
<li><a href="http://my.oschina.net/jiahut" target="_blank"><img src="&quot;jazz&quot;" alt="jazz"></a> 8楼：<strong>jazz</strong>发表于 2011-07-28 08:42 <a href="">回复此评论</a></li>
</ul>
<p>都是些语法糖，用工具类有时候做的可能比这更好</p>
<ul>
<li><a href="http://my.oschina.net/heronote" target="_blank"><img src="&quot;heronote&quot;" alt="heronote"></a> 9楼：<strong>heronote</strong>发表于 2011-07-28 08:46 <a href="">回复此评论</a></li>
</ul>
<p>2000年以前Java走在其他语言之前（虚拟执行的概念以及隔离底层变化的机制）
2005年以前Java和追上来的语言一起前行
2005年以后Java......
2005年以前做过几个Java的项目，包括B/S和桌面应用，从语言机制上说Exception机制很烦人，从类库上说太一般了，尤其是UI库和IO库：So Stupid，从打包机制来说浪费了大量的时间，从配置来说.....</p>
<ul>
<li><a href="http://my.oschina.net/lcx2007" target="_blank"><img src="&quot;douglarek&quot;" alt="douglarek"></a> 10楼：<strong>Java行者</strong> 发表于 2011-07-28 10:03 <a href="">回复此评论</a></li>
</ul>
<h3 id="-heronote-">引用来自“heronote”的评论</h3>
<p>2000年以前Java走在其他语言之前（虚拟执行的概念以及隔离底层变化的机制）
2005年以前Java和追上来的语言一起前行
2005年以后Java......
2005年以前做过几个Java的项目，包括B/S和桌面应用，从语言机制上说Exception机制很烦人，从类库上说太一般了，尤其是UI库和IO库：So Stupid，从打包机制来说浪费了大量的时间，从配置来说.....
哥们，貌似你Java很厉害阿，不过看到你最后一段的评论，我还是感觉你太肤浅了，你说的Exception很烦人，我想问你哪种主流编程语言没有这一项？你说UI的设计一般，你也做个跨平台的UI类库，你说I/O库一般，正说明你连Java还不入门，I/O库是Java实现的接近完美的一个类库！打包机制浪费了时间，别跟我说这些没用的，那还不是为了方便程序员阿？</p>
<ul>
<li><a href="http://my.oschina.net/zhlmmc" target="_blank"><img src="&quot;虫虫&quot;" alt="虫虫"></a> 11楼：<strong>虫虫</strong> 发表于 2011-07-28 11:56 <a href="">回复此评论</a></li>
</ul>
<p>鼓掌！！！</p>
<ul>
<li><a href="http://my.oschina.net/zhlmmc" target="_blank"><img src="&quot;虫虫&quot;" alt="虫虫"></a> 12楼：<strong>虫虫</strong> 发表于 2011-07-28 12:05 <a href="">回复此评论</a></li>
</ul>
<h3 id="-java-">引用来自“Java行者”的评论</h3>
<h3 id="-heronote-">引用来自“heronote”的评论</h3>
<p>2000年以前Java走在其他语言之前（虚拟执行的概念以及隔离底层变化的机制）
2005年以前Java和追上来的语言一起前行
2005年以后Java......
2005年以前做过几个Java的项目，包括B/S和桌面应用，从语言机制上说Exception机制很烦人，从类库上说太一般了，尤其是UI库和IO库：So Stupid，从打包机制来说浪费了大量的时间，从配置来说.....
哥们，貌似你Java很厉害阿，不过看到你最后一段的评论，我还是感觉你太肤浅了，你说的Exception很烦人，我想问你哪种主流编程语言没有这一项？你说UI的设计一般，你也做个跨平台的UI类库，你说I/O库一般，正说明你连Java还不入门，I/O库是Java实现的接近完美的一个类库！打包机制浪费了时间，别跟我说这些没用的，那还不是为了方便程序员阿？</p>
<p>这跟选老婆是一样的，各花入各眼。讨论技术还是不要扯到人身攻击上了……</p>
<ul>
<li><a href="http://my.oschina.net/WilliamShen" target="_blank"><img src="&quot;CheckStyle&quot;" alt="CheckStyle"></a> 13楼：<strong>CheckStyle</strong>发表于 2011-07-28 12:28 <a href="">回复此评论</a></li>
</ul>
<h3 id="-java-">引用来自“Java行者”的评论</h3>
<h3 id="-heronote-">引用来自“heronote”的评论</h3>
<p>2000年以前Java走在其他语言之前（虚拟执行的概念以及隔离底层变化的机制）
2005年以前Java和追上来的语言一起前行
2005年以后Java......
2005年以前做过几个Java的项目，包括B/S和桌面应用，从语言机制上说Exception机制很烦人，从类库上说太一般了，尤其是UI库和IO库：So Stupid，从打包机制来说浪费了大量的时间，从配置来说.....
哥们，貌似你Java很厉害阿，不过看到你最后一段的评论，我还是感觉你太肤浅了，你说的Exception很烦人，我想问你哪种主流编程语言没有这一项？你说UI的设计一般，你也做个跨平台的UI类库，你说I/O库一般，正说明你连Java还不入门，I/O库是Java实现的接近完美的一个类库！打包机制浪费了时间，别跟我说这些没用的，那还不是为了方便程序员阿？</p>
<p>人家是指Checked Exception很烦人.
Checked Exception目前我所知道,Java是唯一使用的语言.而那些后续更先进的语言,都没加入这个feature. 我也认为这是Java的败笔.</p>
<ul>
<li><a href="http://my.oschina.net/WilliamShen" target="_blank"><img src="&quot;CheckStyle&quot;" alt="CheckStyle"></a> 14楼：<strong>CheckStyle</strong>发表于 2011-07-28 12:29 <a href="">回复此评论</a></li>
</ul>
<h3 id="-java-">引用来自“Java行者”的评论</h3>
<h3 id="-heronote-">引用来自“heronote”的评论</h3>
<p>2000年以前Java走在其他语言之前（虚拟执行的概念以及隔离底层变化的机制）
2005年以前Java和追上来的语言一起前行
2005年以后Java......
2005年以前做过几个Java的项目，包括B/S和桌面应用，从语言机制上说Exception机制很烦人，从类库上说太一般了，尤其是UI库和IO库：So Stupid，从打包机制来说浪费了大量的时间，从配置来说.....
哥们，貌似你Java很厉害阿，不过看到你最后一段的评论，我还是感觉你太肤浅了，你说的Exception很烦人，我想问你哪种主流编程语言没有这一项？你说UI的设计一般，你也做个跨平台的UI类库，你说I/O库一般，正说明你连Java还不入门，I/O库是Java实现的接近完美的一个类库！打包机制浪费了时间，别跟我说这些没用的，那还不是为了方便程序员阿？</p>
<p>你的水平不如被你拍的人. I/O完美么? Windows平台的Java,连NIO都没真正实现, 你敢说完美?</p>
<ul>
<li><a href="http://my.oschina.net/zantesu" target="_blank"><img src="&quot;Gmail.com&quot;" alt="Gmail.com"></a> 15楼：<strong>zantesu</strong>发表于 2011-07-28 13:10 <a href="">回复此评论</a></li>
</ul>
<p>我觉得Java的几个无法忍受的缺陷
不是纯面向对象的
不支持泛型
不支持属性
不支持匿名方法
不支持方法对象传递
不支持yield机制
不支持lambda表达式
不支持类型推断</p>
<h2 id="-checked-exception">还有就是上面提到的Checked Exception</h2>
<p>为什么Java的lambda表达式迟迟不能实装,估计就是因为Checked Exception的缘故
为什么总是有人说建议学习Python/Ruby,就是相比落后的Java,Python/Ruby的编程思维,生产力能得到极大的解放</p>
<ul>
<li><a href="http://my.oschina.net/lcx2007" target="_blank"><img src="&quot;douglarek&quot;" alt="douglarek"></a> 16楼：<strong>Java行者</strong> 发表于 2011-07-28 13:40 <a href="">回复此评论</a></li>
</ul>
<h3 id="-checkstyle-">引用来自“CheckStyle”的评论</h3>
<h3 id="-java-">引用来自“Java行者”的评论</h3>
<h3 id="-heronote-">引用来自“heronote”的评论</h3>
<p>2000年以前Java走在其他语言之前（虚拟执行的概念以及隔离底层变化的机制）
2005年以前Java和追上来的语言一起前行
2005年以后Java......
2005年以前做过几个Java的项目，包括B/S和桌面应用，从语言机制上说Exception机制很烦人，从类库上说太一般了，尤其是UI库和IO库：So Stupid，从打包机制来说浪费了大量的时间，从配置来说.....
哥们，貌似你Java很厉害阿，不过看到你最后一段的评论，我还是感觉你太肤浅了，你说的Exception很烦人，我想问你哪种主流编程语言没有这一项？你说UI的设计一般，你也做个跨平台的UI类库，你说I/O库一般，正说明你连Java还不入门，I/O库是Java实现的接近完美的一个类库！打包机制浪费了时间，别跟我说这些没用的，那还不是为了方便程序员阿？</p>
<p>你的水平不如被你拍的人. I/O完美么? Windows平台的Java,连NIO都没真正实现, 你敢说完美?</p>
<p>&quot;从JDK 1.4开始，Java的标准库中就包含了NIO，即所谓的“New IO”。其中最重要的功能就是提供了“非阻塞”的IO，当然包括了Socket。NonBlocking的IO就是对select(Unix平台下)以及 WaitForMultipleObjects(Windows平台)的封装，提供了高性能、易伸缩的服务架构。&quot; 你自己看吧，别跟我说没用的，我平时不用windows的。</p>
<ul>
<li><a href="http://my.oschina.net/lcx2007" target="_blank"><img src="&quot;douglarek&quot;" alt="douglarek"></a> 17楼：<strong>Java行者</strong> 发表于 2011-07-28 13:48 <a href="">回复此评论</a></li>
</ul>
<h3 id="-checkstyle-">引用来自“CheckStyle”的评论</h3>
<h3 id="-java-">引用来自“Java行者”的评论</h3>
<h3 id="-heronote-">引用来自“heronote”的评论</h3>
<p>2000年以前Java走在其他语言之前（虚拟执行的概念以及隔离底层变化的机制）
2005年以前Java和追上来的语言一起前行
2005年以后Java......
2005年以前做过几个Java的项目，包括B/S和桌面应用，从语言机制上说Exception机制很烦人，从类库上说太一般了，尤其是UI库和IO库：So Stupid，从打包机制来说浪费了大量的时间，从配置来说.....
哥们，貌似你Java很厉害阿，不过看到你最后一段的评论，我还是感觉你太肤浅了，你说的Exception很烦人，我想问你哪种主流编程语言没有这一项？你说UI的设计一般，你也做个跨平台的UI类库，你说I/O库一般，正说明你连Java还不入门，I/O库是Java实现的接近完美的一个类库！打包机制浪费了时间，别跟我说这些没用的，那还不是为了方便程序员阿？</p>
<p>人家是指Checked Exception很烦人.
Checked Exception目前我所知道,Java是唯一使用的语言.而那些后续更先进的语言,都没加入这个feature. 我也认为这是Java的败笔.</p>
<p>我想问一下，你怎么知道他指的是“Checked Exception”，你是他的马甲还是什么？至于你说的那些后续的语言都没有加进什么所谓的feature，那我想问你，Java发明之初，她能设计的那么齐全和周到吗？你可能会问，他为什么部把这个feature去掉，现在没法去了，兼容性是个大问题！还有那我问你，C语言没有运用面向对象的思想，是不是也是C语言的败笔？说了那么多，总而言之，言而总之就是：上面的那位哥们他明显的在评论语言的优劣，而我从没有说过哪种语言设计的非常好，我从没有比较过哪种语言谁好谁差，这种比较本身就是一种无知的表现！</p>
<ul>
<li><a href="http://my.oschina.net/free" target="_blank"><img src="&quot;SudyX&quot;" alt="SudyX"></a> 18楼：<strong>SudyX</strong>发表于 2011-07-28 14:43 <a href="">回复此评论</a></li>
</ul>
<h3 id="-zantesu-">引用来自“zantesu”的评论</h3>
<p>我觉得Java的几个无法忍受的缺陷
不是纯面向对象的
不支持泛型
不支持属性
不支持匿名方法
不支持方法对象传递
不支持yield机制
不支持lambda表达式
不支持类型推断</p>
<h2 id="-checked-exception">还有就是上面提到的Checked Exception</h2>
<p>为什么Java的lambda表达式迟迟不能实装,估计就是因为Checked Exception的缘故
为什么总是有人说建议学习Python/Ruby,就是相比落后的Java,Python/Ruby的编程思维,生产力能得到极大的解放
没用过就别发言...</p>
<ul>
<li><a href="&quot;yissyo&quot;"><img src="&quot;非会员用户&quot;" alt="非会员用户"></a> 19楼：<strong>yissyo</strong>发表于 2011-07-28 15:00 (非会员)</li>
</ul>
<p>鼓掌围观高手</p>
<ul>
<li><a href="http://my.oschina.net/zantesu" target="_blank"><img src="&quot;Gmail.com&quot;" alt="Gmail.com"></a> 20楼：<strong>zantesu</strong>发表于 2011-07-28 15:10 <a href="">回复此评论</a></li>
</ul>
<h3 id="-sudyx-">引用来自“SudyX”的评论</h3>
<h3 id="-zantesu-">引用来自“zantesu”的评论</h3>
<p>我觉得Java的几个无法忍受的缺陷
不是纯面向对象的
不支持泛型
不支持属性
不支持匿名方法
不支持方法对象传递
不支持yield机制
不支持lambda表达式
不支持类型推断</p>
<h2 id="-checked-exception">还有就是上面提到的Checked Exception</h2>
<p>为什么Java的lambda表达式迟迟不能实装,估计就是因为Checked Exception的缘故
为什么总是有人说建议学习Python/Ruby,就是相比落后的Java,Python/Ruby的编程思维,生产力能得到极大的解放
没用过就别发言...</p>
<p>敢问你来解释解释?还是就只有你用过Java么?</p>
<ul>
<li><a href="http://www.oschina.net/news/20119/?p=1" target="_blank">1</a></li>
<li><a href="http://www.oschina.net/news/20119/?p=2#comments" target="_blank">2</a></li>
<li><a href="http://www.oschina.net/news/20119/?p=3#comments" target="_blank">3</a></li>
<li><a href="http://www.oschina.net/news/20119/?p=4#comments" target="_blank">4</a></li>
<li><a href="http://www.oschina.net/news/20119/?p=5#comments" target="_blank">5</a></li>
<li><a href="http://www.oschina.net/news/20119/?p=2#comments" target="_blank">&gt;</a>
<a href=""></a>                            </li>
</ul>
<pre><code> [](http://www.51idc.com/activit/sale_hulan.html &quot;租服务器，就上51IDC&quot;)       
</code></pre><p>网名： (必填) 邮箱： (必填，不公开) 网址：
文明上网，理性发言</p>
<p><a href=""></a> <a href=""></a><a href=""></a>
<img src="" alt=""></p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li></span><span class="breadcrumb"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li><li><a href="/categories/Java&J2EE/JVM/">JVM</a></li></span></span> | <span class="tags">Tagged <a href="/tags/JVM/" class="label label-primary">JVM</a><a href="/tags/Java&J2EE/" class="label label-success">Java&J2EE</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:42"datetime="2014-03-07 09:54:42"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-JVM--Java7的新特性一览表/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JavaJ2EE-JVM--Java7的新特性一览表" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JavaJ2EE-report--DynamicReportsGettingstarted/">DynamicReports(Getting started)</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:42.000Z"> <a href="/2014/02/02/2014-02-02-JavaJ2EE-report--DynamicReportsGettingstarted/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="dynamicreports-getting-started-">DynamicReports(Getting started)</h1>
<h2 id="getting-started">Getting started</h2>
<p><strong>Table of contents</strong></p>
<ol>
<li><a href="http://www.dynamicreports.org/getting-started#overview" target="_blank">Overview</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#simplereport" target="_blank">Simple report</a></li>
</ol>
<ul>
<li><a href="http://www.dynamicreports.org/getting-started#step1" target="_blank">Step 1 : Start</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step2" target="_blank">Step 2 : Styles</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step3" target="_blank">Step 3 : Additional columns</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step4" target="_blank">Step 4 : Group</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step5" target="_blank">Step 5 : Subtotals</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step6" target="_blank">Step 6 : Charts</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step7" target="_blank">Step 7 : Column grid &amp; Containers</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step8" target="_blank">Step 8 : Hide subtotal</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step9" target="_blank">Step 9 : Title</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step10" target="_blank">Step 10 : Currency data type</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step11" target="_blank">Step 11 : Detail row highlighters</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step12" target="_blank">Step 12 : Conditional styles</a></li>
</ul>
<p><a href=""></a></p>
<h3 id="overview">Overview</h3>
<p>Creating a report with <strong>DynamicReports</strong> is very easy, take a look at the example below
01</p>
<p>import</p>
<p>static</p>
<p>net.sf.dynamicreports.report.builder.DynamicReports./*;</p>
<p>02</p>
<p>public</p>
<p>class</p>
<p>Report {
03</p>
<p>04</p>
<p>private</p>
<p>void</p>
<p>build() {
05</p>
<p>try</p>
<p>{</p>
<p>06</p>
<p>report()</p>
<p>//create new report design
07</p>
<p>.columns(...)</p>
<p>//adds columns</p>
<p>08</p>
<p>.groupBy(...)</p>
<p>//adds groups
09</p>
<p>.subtotalsAtSummary(...)</p>
<p>//adds subtotals</p>
<p>10</p>
<p>...
11</p>
<p>//set datasource</p>
<p>12</p>
<p>.setDataSource(...)
13</p>
<p>//export report</p>
<p>14</p>
<p>.toPdf(...)</p>
<p>//export report to pdf
15</p>
<p>.toXls(...)</p>
<p>//export report to excel</p>
<p>16</p>
<p>...
17</p>
<p>//other outputs</p>
<p>18</p>
<p>.toJasperPrint()</p>
<p>//creates jasperprint object
19</p>
<p>.show()</p>
<p>//shows report</p>
<p>20</p>
<p>.print()</p>
<p>//prints report
21</p>
<p>...</p>
<p>22</p>
<p>}</p>
<p>catch</p>
<p>(DRException e) {
23</p>
<p>e.printStackTrace(); </p>
<p>24</p>
<p>}
25</p>
<p>} </p>
<p>26</p>
<p>... 
27</p>
<p>}</p>
<p>See <a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/ReportBuilder.html" target="_blank">ReportBuilder</a> class for all available features and <a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/jasper/builder/JasperReportBuilder.html" target="_blank">JasperReportBuilder</a> class for all available exports and outputs</p>
<p><a href=""></a></p>
<h3 id="simple-report">Simple report</h3>
<p>Please note that this is a tutorial example and that this tutorial doesn&#39;t describe all features!</p>
<p>You will learn in this section how to create a simple report step by step.
First we need to create an empty report desing, configure it and set a datasource. Afterwards the report will be ready to export into any format.
It&#39;s important to remember the <a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/DynamicReports.html" target="_blank">DynamicReports</a> class, through which you will have available most of features. The class provides methods for building a particular piece of a report.
Let&#39;s start!</p>
<p><a href=""></a></p>
<h3 id="step-1-start">Step 1 : Start</h3>
<p>First define columns through <a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/column/ColumnBuilders.html" target="_blank">DynamicReports.col</a>.column(title, field name, datatype) (the field name must match with the name of a field contained in the datasource) and pass them into the report as follows:
1</p>
<p>.columns(</p>
<p>//add columns</p>
<p>2</p>
<p>//             title,     field name     data type
3</p>
<p>col.column(</p>
<p>&quot;Item&quot;</p>
<p>,      </p>
<p>&quot;item&quot;</p>
<p>,      type.stringType()),</p>
<p>4</p>
<p>col.column(</p>
<p>&quot;Quantity&quot;</p>
<p>,  </p>
<p>&quot;quantity&quot;</p>
<p>,  type.integerType()),
5</p>
<p>col.column(</p>
<p>&quot;Unit price&quot;</p>
<p>,</p>
<p>&quot;unitprice&quot;</p>
<p>, type.bigDecimalType()))</p>
<p>now define some text at the title and number of pages at the page footer as follows:</p>
<p>1</p>
<p>.title(cmp.text(</p>
<p>&quot;Getting started&quot;</p>
<p>))</p>
<p>//shows report title</p>
<p>2</p>
<p>.pageFooter(cmp.pageXofY())</p>
<p>//shows number of page at page footer</p>
<p><a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/component/ComponentBuilders.html" target="_blank">DynamicReports.cmp</a>.text(some text) - creates a component that shows a text
<a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/component/ComponentBuilders.html" target="_blank">DynamicReports.cmp</a>.pageXofY() - creates a component that shows page X of Y
Methods <strong>title(...)</strong> and <strong>pageFooter(...)</strong> allows to customize a particular report band by adding components to it</p>
<p><a href="http://www.dynamicreports.org/examples/simplereport_step01.png" title="SimpleReport_Step01" target="_blank"><img src="" alt="SimpleReport_Step01"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step01.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step01.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step01" title="SimpleReport_Step01" target="_blank">SimpleReport_Step01</a></p>
<p><a href=""></a></p>
<h3 id="step-2-styles">Step 2 : Styles</h3>
<p>Each style can have a parent style from which it will inherit its properties. Empty style can be created by <a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/style/StyleBuilders.html" target="_blank">DynamicReports.stl</a>.style()
01</p>
<p>StyleBuilder boldStyle         = stl.style().bold(); </p>
<p>02</p>
<p>StyleBuilder boldCenteredStyle = stl.style(boldStyle)
03</p>
<p>.setHorizontalAlignment(HorizontalAlignment.CENTER);</p>
<p>04</p>
<p>StyleBuilder columnTitleStyle  = stl.style(boldCenteredStyle)
05</p>
<p>.setBorder(stl.pen1Point())</p>
<p>06</p>
<p>.setBackgroundColor(Color.LIGHT_GRAY);
07</p>
<p>report()</p>
<p>08</p>
<p>.setColumnTitleStyle(columnTitleStyle) 
09</p>
<p>.highlightDetailEvenRows() </p>
<p>10</p>
<p>.title(cmp.text(</p>
<p>&quot;Getting started&quot;</p>
<p>).setStyle(boldCenteredStyle))
11</p>
<p>.pageFooter(cmp.pageXofY().setStyle(boldCenteredStyle)) <a href="http://www.dynamicreports.org/examples/simplereport_step02.png" title="SimpleReport_Step02" target="_blank"><img src="" alt="SimpleReport_Step02"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step02.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step02.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step02" title="SimpleReport_Step02" target="_blank">SimpleReport_Step02</a></p>
<p><a href=""></a></p>
<h3 id="step-3-additional-columns">Step 3 : Additional columns</h3>
<p>You can very easy multiply, divide, add or subtract column of numbers by another column of numbers or by a number value
1</p>
<p>//price = unitPrice /* quantity </p>
<p>2</p>
<p>TextColumnBuilder<BigDecimal> priceColumn = unitPriceColumn.multiply(quantityColumn)
3</p>
<p>.setTitle(</p>
<p>&quot;Price&quot;</p>
<p>);</p>
<p>Adding percentage of any column of numbers is simple <a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/column/ColumnBuilders.html" target="_blank">DynamicReports.col</a>.percentageColumn(title, column)</p>
<p>1</p>
<p>PercentageColumnBuilder pricePercColumn = col.percentageColumn(</p>
<p>&quot;Price %&quot;</p>
<p>, priceColumn);</p>
<p><a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/column/ColumnBuilders.html" target="_blank">DynamicReports.col</a>.reportRowNumberColumn(title) creates a column that shows row number</p>
<p>1</p>
<p>TextColumnBuilder<Integer> rowNumberColumn =</p>
<p>2</p>
<p>col.reportRowNumberColumn(</p>
<p>&quot;No.&quot;</p>
<p>) 
3</p>
<p>//sets the fixed width of a column, width = 2 /* character width </p>
<p>4</p>
<p>.setFixedColumns(</p>
<p>2</p>
<p>) 
5</p>
<p>.setHorizontalAlignment(HorizontalAlignment.CENTER);  <a href="http://www.dynamicreports.org/examples/simplereport_step03.png" title="SimpleReport_Step03" target="_blank"><img src="" alt="SimpleReport_Step03"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step03.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step03.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step03" title="SimpleReport_Step03" target="_blank">SimpleReport_Step03</a></p>
<p><a href=""></a></p>
<h3 id="step-4-group">Step 4 : Group</h3>
<p>We continue by adding a group as shown below
1</p>
<p>.groupBy(itemColumn) <a href="http://www.dynamicreports.org/examples/simplereport_step04.png" title="SimpleReport_Step04" target="_blank"><img src="" alt="SimpleReport_Step04"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step04.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step04.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step04" title="SimpleReport_Step04" target="_blank">SimpleReport_Step04</a></p>
<p><a href=""></a></p>
<h3 id="step-5-subtotals">Step 5 : Subtotals</h3>
<p>Now we can try to sum a column of numbers. Subtotal of sum is created through <a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/subtotal/SubtotalBuilders.html" target="_blank">DynamicReports.sbt</a>.sum(column)
1</p>
<p>.subtotalsAtSummary( </p>
<p>2</p>
<p>sbt.sum(unitPriceColumn), sbt.sum(priceColumn)) 
3</p>
<p>.subtotalsAtFirstGroupFooter( </p>
<p>4</p>
<p>sbt.sum(unitPriceColumn), sbt.sum(priceColumn)) </p>
<p>Method <strong>subtotalsAtSummary(...)</strong> allows to add subtotals to the summary band
Method <strong>subtotalsAtFirstGroupFooter(...)</strong> will find first defined group and add subtotals to the group footer band</p>
<p><a href="http://www.dynamicreports.org/examples/simplereport_step05.png" title="SimpleReport_Step05" target="_blank"><img src="" alt="SimpleReport_Step05"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step05.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step05.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step05" title="SimpleReport_Step05" target="_blank">SimpleReport_Step05</a></p>
<p><a href=""></a></p>
<h3 id="step-6-charts">Step 6 : Charts</h3>
<p><a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/chart/ChartBuilders.html" target="_blank">DynamicReports.cht</a> provide methods for building charts. Category and series are required.
01</p>
<p>Bar3DChartBuilder itemChart = cht.bar3DChart()</p>
<p>02</p>
<p>.setTitle(</p>
<p>&quot;&lt;a href=&quot;</p>
<p>http:</p>
<p>//www.dynamicreports.org/examples/sales&quot; title=&quot;Sales&quot;&gt;Sales</a> by item&quot;)
03</p>
<p>.setCategory(itemColumn)</p>
<p>04</p>
<p>.addSerie(
05</p>
<p>cht.serie(unitPriceColumn), cht.serie(priceColumn));</p>
<p>06</p>
<p>Bar3DChartBuilder itemChart2 = cht.bar3DChart()
07</p>
<p>.setTitle(</p>
<p>&quot;&lt;a href=&quot;</p>
<p>http:</p>
<p>//www.dynamicreports.org/examples/sales&quot; title=&quot;Sales&quot;&gt;Sales</a> by item&quot;)</p>
<p>08</p>
<p>.setCategory(itemColumn)
09</p>
<p>.setUseSeriesAsCategory(</p>
<p>true</p>
<p>)</p>
<p>10</p>
<p>.addSerie(
11</p>
<p>cht.serie(unitPriceColumn), cht.serie(priceColumn));</p>
<p>Chart is a component and can be placed into any report band.</p>
<p>1</p>
<p>.summary(itemChart, itemChart2) <a href="http://www.dynamicreports.org/examples/simplereport_step06.png" title="SimpleReport_Step06" target="_blank"><img src="" alt="SimpleReport_Step06"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step06.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step06.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step06" title="SimpleReport_Step06" target="_blank">SimpleReport_Step06</a></p>
<p><a href=""></a></p>
<h3 id="step-7-column-grid-containers">Step 7 : Column grid &amp; Containers</h3>
<p>Components inserted into the bands are arranged vertically, each component is below the previously added component. To arrange components horizontally it is needed to wrap these components with a horizontal container. Container is a component as well and therefore it can be added to any of the report bands.
1</p>
<p>.summary( </p>
<p>2</p>
<p>cmp.horizontalList(itemChart, itemChart2))</p>
<p>Columns layout can be modified by a column grid. The layout is applied to the columns title, details and subtotals.</p>
<p>1</p>
<p>.columnGrid( </p>
<p>2</p>
<p>rowNumberColumn, quantityColumn, unitPriceColumn,
3</p>
<p>grid.verticalColumnGridList(priceColumn, pricePercColumn)) <a href="http://www.dynamicreports.org/examples/simplereport_step07.png" title="SimpleReport_Step07" target="_blank"><img src="" alt="SimpleReport_Step07"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step07.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step07.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step07" title="SimpleReport_Step07" target="_blank">SimpleReport_Step07</a></p>
<p><a href=""></a></p>
<h3 id="step-8-hide-subtotal">Step 8 : Hide subtotal</h3>
<p>Subtotal for the group notebook is unnecessary because contains only one row.
We need to change the group declaration and set the boolean expression condition on which depends whether subtotal is printed.
<a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/expression/ExpressionBuilders.html" target="_blank">DynamicReports.exp</a>.printWhenGroupHasMoreThanOneRow(itemGroup) creates a boolean condition which returns true when itemGroup has more than one row.
1</p>
<p>ColumnGroupBuilder itemGroup = grp.group(itemColumn); </p>
<p>2</p>
<p>itemGroup.setPrintSubtotalsWhenExpression(
3</p>
<p>exp.printWhenGroupHasMoreThanOneRow(itemGroup));</p>
<p>1</p>
<p>.groupBy(itemGroup)
<a href="http://www.dynamicreports.org/examples/simplereport_step08.png" title="SimpleReport_Step08" target="_blank"><img src="" alt="SimpleReport_Step08"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step08.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step08.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step08" title="SimpleReport_Step08" target="_blank">SimpleReport_Step08</a></p>
<p><a href=""></a></p>
<h3 id="step-9-title">Step 9 : Title</h3>
<p>First define a title style.
1</p>
<p>StyleBuilder titleStyle = stl.style(boldCenteredStyle)</p>
<p>2</p>
<p>.setVerticalAlignment(VerticalAlignment.MIDDLE)
3</p>
<p>.setFontSize(</p>
<p>15</p>
<p>);</p>
<p><a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/component/ComponentBuilders.html" target="_blank">DynamicReports.cmp</a>.image() creates an image component
<a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/component/ComponentBuilders.html" target="_blank">DynamicReports.cmp</a>.filler() creates an empty component</p>
<p>1</p>
<p>.title(</p>
<p>//shows report title</p>
<p>2</p>
<p>cmp.horizontalList()
3</p>
<p>.add(</p>
<p>4</p>
<p>cmp.image(getClass().getResourceAsStream(</p>
<p>&quot;../images/dynamicreports.png&quot;</p>
<p>)).setFixedDimension(</p>
<p>80</p>
<p>,</p>
<p>80</p>
<p>),
5</p>
<p>cmp.text(</p>
<p>&quot;DynamicReports&quot;</p>
<p>).setStyle(titleStyle).setHorizontalAlignment(HorizontalAlignment.LEFT),</p>
<p>6</p>
<p>cmp.text(</p>
<p>&quot;Getting started&quot;</p>
<p>).setStyle(titleStyle).setHorizontalAlignment(HorizontalAlignment.RIGHT))
7</p>
<p>.newRow()</p>
<p>8</p>
<p>.add(cmp.filler().setStyle(stl.style().setTopBorder(stl.pen2Point())).setFixedHeight(</p>
<p>10</p>
<p>)))</p>
<p>The defined filler creates an additional blank space between the title and the column header.
Setting top border of a filler draws the line at the bottom of the title.
Horizontal list, as previously mentioned, arranges components horizontally in one row but by calling the method row() a new horizontal list is created which is located at the bottom of the previous horizontal list.</p>
<p><a href="http://www.dynamicreports.org/examples/simplereport_step09.png" title="SimpleReport_Step09" target="_blank"><img src="" alt="SimpleReport_Step09"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step09.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step09.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step09" title="SimpleReport_Step09" target="_blank">SimpleReport_Step09</a></p>
<p><a href=""></a></p>
<h3 id="step-10-currency-data-type">Step 10 : Currency data type</h3>
<p>Unit price and price column are currency types.
Showing currency is possible by setting pattern to both columns (via method setPattern()), but the best practice is to create a custom data type and apply it to the columns. The custom data type then can be used in other reports.
01</p>
<p>CurrencyType currencyType =</p>
<p>new</p>
<p>CurrencyType();</p>
<p>02</p>
<p>TextColumnBuilder<BigDecimal> unitPriceColumn = col.column(</p>
<p>&quot;Unit price&quot;</p>
<p>,</p>
<p>&quot;unitprice&quot;</p>
<p>, currencyType);
03</p>
<p>//price = unitPrice /* quantity</p>
<p>04</p>
<p>TextColumnBuilder<BigDecimal> priceColumn     = unitPriceColumn.multiply(quantityColumn).setTitle(</p>
<p>&quot;Price&quot;</p>
<p>)
05</p>
<p>.setDataType(currencyType);</p>
<p>06</p>
<p>private</p>
<p>class</p>
<p>CurrencyType</p>
<p>extends</p>
<p>BigDecimalType {
07</p>
<p>private</p>
<p>static</p>
<p>final</p>
<p>long</p>
<p>serialVersionUID = 1L;</p>
<p>08</p>
<p>09</p>
<p>@Override</p>
<p>10</p>
<p>public</p>
<p>String getPattern() {
11</p>
<p>return</p>
<p>&quot;$ /#,/#/#/#.00&quot;</p>
<p>;</p>
<p>12</p>
<p>}
13</p>
<p>} <a href="http://www.dynamicreports.org/examples/simplereport_step10.png" title="SimpleReport_Step10" target="_blank"><img src="" alt="SimpleReport_Step10"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step10.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step10.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step10" title="SimpleReport_Step10" target="_blank">SimpleReport_Step10</a></p>
<p><a href=""></a></p>
<h3 id="step-11-detail-row-highlighters">Step 11 : Detail row highlighters</h3>
<p>1</p>
<p>ConditionalStyleBuilder condition1 = stl.conditionalStyle(cnd.greater(priceColumn,</p>
<p>150</p>
<p>))</p>
<p>2</p>
<p>.setBackgroundColor(</p>
<p>new</p>
<p>Color(</p>
<p>210</p>
<p>,</p>
<p>255</p>
<p>,</p>
<p>210</p>
<p>));
3</p>
<p>ConditionalStyleBuilder condition2 = stl.conditionalStyle(cnd.smaller(priceColumn,</p>
<p>30</p>
<p>))</p>
<p>4</p>
<p>.setBackgroundColor(</p>
<p>new</p>
<p>Color(</p>
<p>255</p>
<p>,</p>
<p>210</p>
<p>,</p>
<p>210</p>
<p>));</p>
<p>1</p>
<p>.detailRowHighlighters(</p>
<p>2</p>
<p>condition1, condition2)</p>
<p>Condition1 is applied only if price is greater than 150 and sets background color of a row to green.
Condition2 is applied only if price is smaller than 30 and sets background color of a row to red.
<a href="http://www.dynamicreports.org/examples/simplereport_step11.png" title="SimpleReport_Step11" target="_blank"><img src="" alt="SimpleReport_Step11"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step11.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step11.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step11" title="SimpleReport_Step11" target="_blank">SimpleReport_Step11</a></p>
<p><a href=""></a></p>
<h3 id="step-12-conditional-styles">Step 12 : Conditional styles</h3>
<p>1</p>
<p>ConditionalStyleBuilder condition3 = stl.conditionalStyle(cnd.greater(priceColumn,</p>
<p>200</p>
<p>))</p>
<p>2</p>
<p>.setBackgroundColor(</p>
<p>new</p>
<p>Color(</p>
<p>0</p>
<p>,</p>
<p>190</p>
<p>,</p>
<p>0</p>
<p>))
3</p>
<p>.bold();</p>
<p>4</p>
<p>ConditionalStyleBuilder condition4 = stl.conditionalStyle(cnd.smaller(priceColumn,</p>
<p>20</p>
<p>))
5</p>
<p>.setBackgroundColor(</p>
<p>new</p>
<p>Color(</p>
<p>190</p>
<p>,</p>
<p>0</p>
<p>,</p>
<p>0</p>
<p>))</p>
<p>6</p>
<p>.bold();
7</p>
<p>StyleBuilder priceStyle = stl.style()</p>
<p>8</p>
<p>.conditionalStyles(
9</p>
<p>condition3, condition4);</p>
<p>1</p>
<p>priceColumn = unitPriceColumn.multiply(quantityColumn).setTitle(</p>
<p>&quot;Price&quot;</p>
<p>)</p>
<p>2</p>
<p>.setDataType(currencyType)
3</p>
<p>.setStyle(priceStyle);</p>
<p>Condition3 is applied only if price is greater than 200 and sets background color of a price to green.
Condition4 is applied only if price is smaller than 20 and sets background color of a price to red.
<a href="http://www.dynamicreports.org/examples/simplereport_step12.png" title="SimpleReport_Step12" target="_blank"><img src="" alt="SimpleReport_Step12"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step12.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step12.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step12" title="SimpleReport_Step12" target="_blank">SimpleReport_Step1</a></p>
<p>来源： <a href="[http://www.dynamicreports.org/getting-started](http://www.dynamicreports.org/getting-started)">[http://www.dynamicreports.org/getting-started](http://www.dynamicreports.org/getting-started)</a></p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li></span><span class="breadcrumb"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li><li><a href="/categories/Java&J2EE/report/">report</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Java&J2EE/" class="label label-primary">Java&J2EE</a><a href="/tags/report/" class="label label-success">report</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:42"datetime="2014-03-07 09:54:42"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-report--DynamicReportsGettingstarted/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JavaJ2EE-report--DynamicReportsGettingstarted" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--Java垃圾回收策略调优-实践篇/">Java 垃圾回收策略调优</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:42.000Z"> <a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--Java垃圾回收策略调优-实践篇/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="java-">Java 垃圾回收策略调优-实践篇</h1>
<p><a href="http://www.douban.com/accounts/login?source=group" target="_blank">登录</a> <a href="http://www.douban.com/accounts/register?source=group" target="_blank">注册</a></p>
<ul>
<li><a href="http://www.douban.com/" target="_blank">豆瓣</a></li>
<li><a href="http://book.douban.com/" target="_blank">读书</a></li>
<li><a href="http://movie.douban.com/" target="_blank">电影</a></li>
<li><a href="http://music.douban.com/" target="_blank">音乐</a></li>
<li><a href="http://www.douban.com/location/" target="_blank">同城</a></li>
<li><a href="http://www.douban.com/group/" target="_blank">小组</a></li>
<li><a href="http://read.douban.com/?dcs=top-nav&amp;dcm=douban" target="_blank">阅读</a></li>
<li><a href="http://douban.fm/" target="_blank">豆瓣FM</a></li>
<li><a href="">更多</a></li>
</ul>
<p><a href="http://9.douban.com/" target="_blank">九点</a> <a href="http://alphatown.com/" target="_blank">阿尔法城</a> <a href="http://www.douban.com/mobile/" target="_blank">移动应用</a></p>
<p><a href="http://www.douban.com/group/" target="_blank">豆瓣小组</a></p>
<ul>
<li><a href="http://www.douban.com/group/explore" target="_blank">发现小组</a></li>
<li><a href="http://www.douban.com/group/explore_topic" target="_blank">发现话题</a>
搜索：  小组、话题<h1 id="java-">Java 垃圾回收策略调优，实践篇</h1>
</li>
</ul>
<p><a href="http://www.douban.com/people/1851090/" target="_blank"><img src="" alt="KK"></a></p>
<h3 id="-kk-http-www-douban-com-people-1851090-2008-10-22-13-26-30">来自: <a href="http://www.douban.com/people/1851090/" target="_blank">KK</a> 2008-10-22 13:26:30</h3>
<p>JVM参数调优是一个很头痛的问题，可能和应用有关系，下面是本人一些调优的实践经验，希望对读者能有帮助，环境LinuxAS4,resin2.1.17,JDK6.0,2CPU,4G内存,dell2950服务器，网站是shedewang.com，新手可能觉得这文章没有用。
一：串行垃圾回收，也就是默认配置，完成10万request用时153秒，JVM参数配置如下
$JAVA_ARGS .= &quot; -Dresin.home=$SERVER_ROOT -server -Xms2048M -Xmx2048M -Xmn512M -XX:PermSize=256M -XX:MaxPermSize=256M -XX:MaxTenuringThreshold=7 -XX:GCTimeRatio=19 -Xnoclassgc -Xloggc:log/gc.log -XX:+PrintGCDetails -XX:+PrintGCTimeStamps &quot;;
这种配置一般在resin启动24小时内似乎没有大问题，网站可以正常访问，但查看日志发现，在接近24小时时，Full GC执行越来越频繁，大约每隔3分钟就有一次Full GC，每次Full GC系统会停顿6秒左右，作为一个网站来说，用户等待6秒恐怕太长了，所以这种方式有待改善。MaxTenuringThreshold=7表示一个对象如果在救助空间移动7次还没有被回收就放入年老代，GCTimeRatio=19表示java可以用5%的时间来做垃圾回收，1/(1+19)=1 /20=5%。
二：并行回收，完成10万request用时117秒，配置如下：
$JAVA_ARGS .= &quot; -Dresin.home=$SERVER_ROOT -server -Xmx2048M -Xms2048M -Xmn512M -XX:PermSize=256M -XX:MaxPermSize=256M -Xnoclassgc -Xloggc:log/gc.log -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseParallelGC -XX:ParallelGCThreads=20 -XX:+UseParallelOldGC -XX:MaxGCPauseMillis=500 -XX:+UseAdaptiveSizePolicy -XX:MaxTenuringThreshold=7 -XX:GCTimeRatio=19 &quot;;
并行回收我尝试过多种组合配置，似乎都没什么用，resin启动3小时左右就会停顿，时间超过10 秒。也有可能是参数设置不够好的原因，MaxGCPauseMillis表示GC最大停顿时间，在resin刚启动还没有执行Full GC时系统是正常的，但一旦执行Full GC，MaxGCPauseMillis根本没有用，停顿时间可能超过20秒，之后会发生什么我也不再关心了，赶紧重启resin，尝试其他回收策略。
三：并发回收，完成10万request用时60秒，比并行回收差不多快一倍，是默认回收策略性能的2.5倍，配置如下：
$JAVA_ARGS .= &quot; -Dresin.home=$SERVER_ROOT -server -Xms2048M -Xmx2048M -Xmn512M -XX:PermSize=256M -XX:MaxPermSize=256M -XX:+UseConcMarkSweepGC -XX:MaxTenuringThreshold=7 -XX:GCTimeRatio=19 -Xnoclassgc -Xloggc:log/gc.log -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseCMSCompactAtFullCollection -XX:CMSFullGCsBeforeCompaction=0 &quot;;
这个配置虽然不会出现10秒连不上的情况，但系统重启3个小时左右，每隔几分钟就会有5秒连不上的情况，查看gc.log，发现在执行ParNewGC时有个promotion failed错误，从而转向执行Full GC，造成系统停顿，而且会很频繁，每隔几分钟就有一次，所以还得改善。UseCMSCompactAtFullCollection是表是执行Full GC后对内存进行整理压缩，免得产生内存碎片，CMSFullGCsBeforeCompaction=N表示执行N次Full GC后执行内存压缩。
四：增量回收，完成10万request用时171秒，太慢了，配置如下
$JAVA_ARGS .= &quot; -Dresin.home=$SERVER_ROOT -server -Xms2048M -Xmx2048M -Xmn512M -XX:PermSize=256M -XX:MaxPermSize=256M -XX:MaxTenuringThreshold=7 -XX:GCTimeRatio=19 -Xnoclassgc -Xloggc:log/gc.log -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -Xincgc &quot;;
似乎回收得也不太干净，而且也对性能有较大影响，不值得试。
五：并发回收的I-CMS模式，和增量回收差不多，完成10万request用时170秒。
$JAVA_ARGS .= &quot; -Dresin.home=$SERVER_ROOT -server -Xms2048M -Xmx2048M -Xmn512M -XX:PermSize=256M -XX:MaxPermSize=256M -XX:MaxTenuringThreshold=7 -XX:GCTimeRatio=19 -Xnoclassgc -Xloggc:log/gc.log -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseConcMarkSweepGC -XX:+CMSIncrementalMode -XX:+CMSIncrementalPacing -XX:CMSIncrementalDutyCycleMin=0 -XX:CMSIncrementalDutyCycle=10 -XX:-TraceClassUnloading &quot;;
采用了sun推荐的参数，回收效果不好，照样有停顿，数小时之内就会频繁出现停顿，什么sun推荐的参数，照样不好使。
六：递增式低暂停收集器，还叫什么火车式回收，不知道属于哪个系，完成10万request用时153秒
$JAVA_ARGS .= &quot; -Dresin.home=$SERVER_ROOT -server -Xms2048M -Xmx2048M -Xmn512M -XX:PermSize=256M -XX:MaxPermSize=256M -XX:MaxTenuringThreshold=7 -XX:GCTimeRatio=19 -Xnoclassgc -Xloggc:log/gc.log -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseTrainGC &quot;;
该配置效果也不好，影响性能，所以没试。
七：相比之下，还是并发回收比较好，性能比较高，只要能解决ParNewGC（并行回收年轻代）时的promotion failed错误就一切好办了，查了很多文章，发现引起promotion failed错误的原因是CMS来不及回收（CMS默认在年老代占到90%左右才会执行），年老代又没有足够的空间供GC把一些活的对象从年轻代移到年老代，所以执行Full GC。CMSInitiatingOccupancyFraction=70表示年老代占到约70%时就开始执行CMS，这样就不会出现Full GC了。SoftRefLRUPolicyMSPerMB这个参数也是我认为比较有用的，官方解释是softly reachable objects will remain alive for some amount of time after the last time they were referenced. The default value is one second of lifetime per free megabyte in the heap，我觉得没必要等1秒，所以设置成0。配置如下
$JAVA_ARGS .= &quot; -Dresin.home=$SERVER_ROOT -server -Xms2048M -Xmx2048M -Xmn512M -XX:PermSize=256M -XX:MaxPermSize=256M -XX:SurvivorRatio=8 -XX:MaxTenuringThreshold=7 -XX:GCTimeRatio=19 -Xnoclassgc -XX:+DisableExplicitGC -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:+CMSPermGenSweepingEnabled -XX:+UseCMSCompactAtFullCollection -XX:CMSFullGCsBeforeCompaction=0 -XX:+CMSClassUnloadingEnabled -XX:-CMSParallelRemarkEnabled -XX:CMSInitiatingOccupancyFraction=70 -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+PrintClassHistogram -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCApplicationConcurrentTime -XX:+PrintGCApplicationStoppedTime -Xloggc:log/gc.log &quot;;
上面这个配置内存上升的很慢，24小时之内几乎没有停顿现象，最长的只停滞了0.8s，ParNew GC每30秒左右才执行一次，每次回收约0.2秒，看来问题应该暂时解决了。
参数不明白的可以上网查，本人认为比较重要的几个参数是：-Xms -Xmx -Xmn MaxTenuringThreshold GCTimeRatio UseConcMarkSweepGC CMSInitiatingOccupancyFraction SoftRefLRUPolicyMSPerMB
<a href="http://www.douban.com/group/topic/4450520/?type=like#sep" target="_blank">7人</a> 喜欢  <a href="http://www.douban.com/accounts/register?reason=like" title="标为喜欢？" target="_blank">喜欢</a></p>
<p><a href="">回应</a> <a href="http://www.douban.com/group/topic/4450520/?type=rec#sep" target="_blank">推荐</a> <a href="http://www.douban.com/group/topic/4450520/?type=like#sep" target="_blank">喜欢</a>  <a href="http://www.douban.com/group/topic/4450520/?author=1#sep" target="_blank">只看楼主</a></p>
<ul>
<li><a href="http://www.douban.com/people/xds2000/" target="_blank"><img src="" alt="肖"></a></li>
</ul>
<h3 id="-http-www-douban-com-people-xds2000-beijing-2008-10-22-22-53-34"><a href="http://www.douban.com/people/xds2000/" target="_blank">肖</a> (@Beijing) 2008-10-22 22:53:34</h3>
<p>首先使用64 bit os,是一个提高性能的不二法规.
第二,任何调优应该有场景,在未知情况应该使用loggc导出日志分析,再加参数.对于参数的好与坏,我希望楼主能贴出更多的自已的思路</p>
<p><a href="http://www.douban.com/group/topic/4450520/?cid=36481624#last" target="_blank">回应</a> <a href="&quot;真的要删除肖的发言?&quot;">删除</a></p>
<ul>
<li><a href="http://www.douban.com/people/1851090/" target="_blank"><img src="" alt="KK"></a></li>
</ul>
<h3 id="-kk-http-www-douban-com-people-1851090-2008-10-27-15-32-12"><a href="http://www.douban.com/people/1851090/" target="_blank">KK</a> 2008-10-27 15:32:12</h3>
<p>还有，如果遇到内存泄漏，要用jstack和jmap、jstat等多看看，应该可以找到问题，还要多看看gc日志各个区域内存使用情况和gc频率，这样才可以作出最佳配置。Good Luck</p>
<p><a href="http://www.douban.com/group/topic/4450520/?cid=36890822#last" target="_blank">回应</a> <a href="&quot;真的要删除KK的发言?&quot;">删除</a></p>
<ul>
<li><a href="http://www.douban.com/people/1851090/" target="_blank"><img src="" alt="KK"></a></li>
</ul>
<h3 id="-kk-http-www-douban-com-people-1851090-2008-11-03-17-37-21"><a href="http://www.douban.com/people/1851090/" target="_blank">KK</a> 2008-11-03 17:37:21</h3>
<p>内存问题和应用有很大关系，我的应用因为用到了缓存，所以年老代比较大，多看看gc日志，出了问题多用Jstack,jmap等工具查看，这样才可以最大的优化JVM参数。经过进两个星期的调试，我的配置是/usr/local/jdk/bin/java -Dresin.home=/usr/local/resin -server -Xms1800M -Xmx1800M -Xmn300M -Xss512K -XX:PermSize=300M -XX:MaxPermSize=300M -XX:SurvivorRatio=8 -XX:MaxTenuringThreshold=5 -XX:GCTimeRatio=19 -Xnoclassgc -XX:+DisableExplicitGC -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:+UseCMSCompactAtFullCollection -XX:CMSFullGCsBeforeCompaction=0 -XX:-CMSParallelRemarkEnabled -XX:CMSInitiatingOccupancyFraction=70 -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+PrintClassHistogram -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintHeapAtGC -Xloggc:log/gc.log
72小时之内没有一点停顿，我是32位LinuxAS4操作系统。</p>
<p><a href="http://www.douban.com/group/topic/4450520/?cid=37459097#last" target="_blank">回应</a> <a href="&quot;真的要删除KK的发言?&quot;">删除</a></p>
<ul>
<li><a href="http://www.douban.com/people/foxswily/" target="_blank"><img src="" alt="Foxswily"></a></li>
</ul>
<h3 id="-foxswily-http-www-douban-com-people-foxswily-2008-11-03-17-45-09"><a href="http://www.douban.com/people/foxswily/" target="_blank">Foxswily</a> 2008-11-03 17:45:09</h3>
<p>mark先，前一段做一个对性能要求高的项目，典型的高DB负载，把着眼点都放在了DB优化上(最终效果也不错，大概提高了40倍左右的性能)，一直没有考虑jvm优化，疏忽了。
but，jvm的优化性价比貌似不是很高，化很大力气得到回报如何有待实践检验。</p>
<p><a href="http://www.douban.com/group/topic/4450520/?cid=37459727#last" target="_blank">回应</a> <a href="&quot;真的要删除Foxswily的发言?&quot;">删除</a></p>
<ul>
<li><a href="http://www.douban.com/people/1851090/" target="_blank"><img src="" alt="KK"></a></li>
</ul>
<h3 id="-kk-http-www-douban-com-people-1851090-2008-11-03-17-55-02"><a href="http://www.douban.com/people/1851090/" target="_blank">KK</a> 2008-11-03 17:55:02</h3>
<p>不是纯粹性能问题，到一定时候JVM参数必须优化，不然访问量大的时候会造成频繁的Full GC或者CMS，Full GC有时能让整个系统停顿10秒，10秒内用户的任何点击都在等待状态，要是隔2分钟就来一次Full GC，恐怕用户和老板都受不了了。
并发回收如果配置的不好照样会产生Full GC。:)</p>
<p><a href="http://www.douban.com/group/topic/4450520/?cid=37460534#last" target="_blank">回应</a> <a href="&quot;真的要删除KK的发言?&quot;">删除</a></p>
<ul>
<li><a href="http://www.douban.com/people/foxswily/" target="_blank"><img src="" alt="Foxswily"></a></li>
</ul>
<h3 id="-foxswily-http-www-douban-com-people-foxswily-2008-11-03-17-58-43"><a href="http://www.douban.com/people/foxswily/" target="_blank">Foxswily</a> 2008-11-03 17:58:43</h3>
<p>有道理，支持这种有内容、有见地的讨论贴。</p>
<p><a href="http://www.douban.com/group/topic/4450520/?cid=37460849#last" target="_blank">回应</a> <a href="&quot;真的要删除Foxswily的发言?&quot;">删除</a></p>
<ul>
<li><a href="http://www.douban.com/people/lozen/" target="_blank"><img src="" alt="洛臻星轮"></a></li>
</ul>
<h3 id="-http-www-douban-com-people-lozen-2012-05-22-23-22-11"><a href="http://www.douban.com/people/lozen/" target="_blank">洛臻星轮</a> 2012-05-22 23:22:11</h3>
<p>感谢下，用了里面的很多参数，目前好使了，让它再多跑跑
项目中Full GC一次停顿了个快十秒，一停顿事件就积压，隔段时间又停顿，事件积压得越来越严重，程序就崩了...</p>
<p><a href="http://www.douban.com/group/topic/4450520/?cid=347193386#last" target="_blank">回应</a> <a href="&quot;真的要删除洛臻星轮的发言?&quot;">删除</a></p>
<ul>
<li><h3 id="-alzq-http-www-douban-com-people-55956054-2012-07-20-13-00-19"><a href="http://www.douban.com/people/55956054/" target="_blank">alzq</a> 2012-07-20 13:00:19</h3>
</li>
</ul>
<p>好配置，实验中……效果不错～</p>
<p><a href="http://www.douban.com/group/topic/4450520/?cid=364769409#last" target="_blank">回应</a> <a href="&quot;真的要删除alzq的发言?&quot;">删除</a></p>
<h2 id="-">你的回应</h2>
<p>回应请先 <a href="http://www.douban.com/accounts/register?reason=discuss" target="_blank">登录</a> , 或 <a href="http://www.douban.com/accounts/register?reason=discuss" target="_blank">注册</a></p>
<p>推荐到广播</p>
<p><a href="http://www.douban.com/group/java/?ref=sidebar" target="_blank"><img src="" alt=""></a></p>
<p><a href="http://www.douban.com/group/java/?ref=sidebar" target="_blank">Java&amp;Android移动应用编程</a></p>
<p>9641 人聚集在这个小组
 <a href="">加入小组</a></p>
<h2 id="-http-www-douban-com-group-java-topics-">最新话题  ( <a href="http://www.douban.com/group/java/#topics" target="_blank">更多</a> )</h2>
<ul>
<li><a href="http://www.douban.com/group/topic/41487832/" title="[Java开发] Java怎么用POI读取Excel函数" target="_blank">[Java开发] Java怎么用POI读取Excel函数</a>   (若水520sunny)</li>
<li><a href="http://www.douban.com/group/topic/41485336/" title="帮5买-招聘ETL开发工程师" target="_blank">帮5买-招聘ETL开发工程师</a>   (挚爱Bernabeu)</li>
<li><a href="http://www.douban.com/group/topic/41482883/" title="搜狗-招聘Java软件工程师" target="_blank">搜狗-招聘Java软件工程师</a>   (挚爱Bernabeu)</li>
<li><a href="http://www.douban.com/group/topic/41472005/" title="谁能稍稍帮我分析下Logcat，给个提示，感激不尽！" target="_blank">谁能稍稍帮我分析下Logcat，给个提示，感激不尽！</a>   (shanby)</li>
<li><p><a href="http://www.douban.com/group/topic/41466302/" title="推荐一个很好的android&amp;ios学习网站" target="_blank">推荐一个很好的android&amp;ios学习网站</a>   (　)</p>
<h2 id="-">全站热点话题:</h2>
</li>
<li><p><a href="http://www.douban.com/group/topic/41486032/?r=1" title="【搬运中】别小看吃货的智慧 818某些外面卖的看起来挺贵的甜品饮料 很多可以自己在家做" target="_blank">【搬运中】别小看吃货的智慧 818某些外面...</a>   37回应</p>
</li>
<li><a href="http://www.douban.com/group/topic/41483943/?r=1" title="【推荐】夏日彩妆routine" target="_blank">【推荐】夏日彩妆routine</a>   55回应</li>
<li><a href="http://www.douban.com/group/topic/41414533/?r=1" title="有关毕业报到证，公务员，事业单位考试面试神马的都可以问我" target="_blank">有关毕业报到证，公务员，事业单位考试面...</a>   197回应</li>
<li><a href="http://www.douban.com/group/topic/41448032/?r=1" title="【意向】Mitsui.家的男装" target="_blank">【意向】Mitsui.家的男装</a>   45回应</li>
<li><a href="http://www.douban.com/group/topic/41321572/?r=1" title="【异国】分享一点关于西方世界的看法" target="_blank">【异国】分享一点关于西方世界的看法</a>   184回应</li>
<li><a href="http://www.douban.com/group/topic/41462291/?r=1" title="【住在我房子里的美女到底是个什么东西？？？!!!】" target="_blank">【住在我房子里的美女到底是个什么东西？...</a>   63回应</li>
<li><a href="http://www.douban.com/group/topic/41358235/?r=1" title="关于天蝎男喜欢女生类型的讨论" target="_blank">关于天蝎男喜欢女生类型的讨论</a>   283回应</li>
<li><a href="http://www.douban.com/group/topic/41460023/?r=1" title="求扒苏见信！！！196的黑料有木有？" target="_blank">求扒苏见信！！！196的黑料有木有？</a>   285回应</li>
</ul>
<h3 id="-">手机扫描二维码，让小组随时陪伴你</h3>
<p><img src="" alt=""></p>
<p><a href="http://www.douban.com/mobile/ipa?app_name=group" target="_blank">App Store下载</a> <a href="http://www.douban.com/j/app/apk?app_name=group_android" target="_blank">点击直接下载</a></p>
<p>© 2005－2013 douban.com, all rights reserved   <a href="http://www.douban.com/about" target="_blank">关于豆瓣</a> · <a href="http://www.douban.com/jobs" target="_blank">在豆瓣工作</a> · <a href="http://www.douban.com/about?topic=contactus" target="_blank">联系我们</a> · <a href="http://www.douban.com/about?policy=disclaimer" target="_blank">免责声明</a> · <a href="http://www.douban.com/help/group" target="_blank">帮助中心</a> · <a href="http://developers.douban.com/" target="_blank">开发者</a> · <a href="http://www.douban.com/mobile/group" target="_blank">手机小组</a> · <a href="http://www.douban.com/partner/" target="_blank">豆瓣广告</a></p>
<p><a href="">↑回顶部</a>
<a href="">×</a></p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li></span><span class="breadcrumb"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li><li><a href="/categories/Java&J2EE/JVM/">JVM</a></li></span></span> | <span class="tags">Tagged <a href="/tags/JVM/" class="label label-primary">JVM</a><a href="/tags/Java&J2EE/" class="label label-success">Java&J2EE</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:42"datetime="2014-03-07 09:54:42"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-JVM--Java垃圾回收策略调优-实践篇/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JavaJ2EE-JVM--Java垃圾回收策略调优-实践篇" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--Java虚拟机技术总结07年写的-原JavaEye精华帖/">Java虚拟机技术总结(07年写的</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:42.000Z"> <a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--Java虚拟机技术总结07年写的-原JavaEye精华帖/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="java-07-javaeye-">Java虚拟机技术总结(07年写的,原JavaEye精华帖)</h1>
<p>原文：IBM WebSphere Application Server 诊断和调优（一））
大家可以google：“IBM WebSphere Application Server 诊断和调优”。
近段时间，我们项目中用到的WebSphere应用服务器(WAS)，但在客户的production环境下极不稳定，经常宕机。给客户造成非常不好的影响，同时，也给项目组很大压力。为此，我们花了近一个月时间对其诊断，现在基本上稳定了，需要继续观察一段时间。现在我主要将工作做一个阶段性的总结。
我们的产品环境是：WAS6.0＋DB2 8.1＋AIX5.3＋RS/6000。在该产品环境下，出现的问题非常多，现象如下：
WAS经常不稳定、宕机几乎一天一次，经常报告OutOfMemory(内存泄漏吗？NO)。
DB2连接数过大，有时把DB2撑死，有时也把AIX撑死。
AIX虚拟内存报错、分页报错、IO也报错、还有很多其它莫名奇妙的错。
总是，每次问题发生的现象和理论上的总是不一致，导致我们不知道从何入手，也无从检测自己的优化参数。咨询过多次IBM技术支持，只解决了某些局部问题。
虽然问题依然存在，但我想，解决问题的思路、特别是理论基础，还是有一些规律和原则。
对于WAS这块，我近段时间的主要时间集中在以下几个方面(时间顺序)：
1、Java性能监测工具：Jprofiler，也用到Jprobe。后来发现Jprofiler在AIX下几乎不可用。
2、IBM Java虚拟机和WAS技术细节，特别是IBM JVM的GC原理，我发现它和sun、bea的差别很大。
3、IBM的heap分析器Heap Analyzer、GCCollector。这两个事后监测工具非常实用，特别是我们的产品运行环境，非测试环境。
4、某些Application的怀疑和诊断。
5、AIX诊断，我几乎没有这个能力，只能常规监测一下，需另请高人。
我打算将本文分成以下几个部分总结：
JVM原理、IBM JVM的GC策略和调优
Jprofiler和IBM工具的实际体会
WAS的诊断体会和AIX调优
下面开始主题吧，可能比较零碎，另外，开始的理论篇基本上看书都可以，我只是总结一下，再添加一些自己的理解。
以下是我参考的最重要的两本电子书和一些网站：
《Inside Java Vrtual Machine》:半部分有约四章我认为非常棒，其它章节可能意义不大。
《The Java Virtual Machine Specification, 2nd》：前半部分有两三章很不错，不过可以对照上一本书看。
sun的hotspot虚拟机技术：[url]<a href="http://java.sun.com/javase/technologies/hotspot/" target="_blank">http://java.sun.com/javase/technologies/hotspot/</a> [/url]
BEA的JRockit虚拟机技术：[url]<a href="http://edocs.bea.com/jrockit/geninfo/genintro/index.html" target="_blank">http://edocs.bea.com/jrockit/geninfo/genintro/index.html</a> [/url]JVM技术文档入口，虚拟机理论，内存泄漏诊断等的索引页。
IBM诊断资料：<a href="http://www-128.ibm.com/developerworks/java/jdk/diagnosis/" target="_blank">http://www-128.ibm.com/developerworks/java/jdk/diagnosis/</a> 上面有一个500多页的pdf文档，对IBM JVM技术和诊断讲解很深入。
我不得不提的是，在查资料这块，BEA和Sun都有很好的官方文档和论坛支持，并且官方文档导航非常好。虽然IBM的诊断资料也不少，但需要搜索，其搜索是很痛苦的。而且，IBM官方论坛很差。如果用IBM的产品出问题，切记：找IBM技术支持，千万不要蒙着头搞！反正它们的产品很少免费。说实话，它们的技术支持还是挺负责的，一般会为你推荐很多support资料，而该资料往往都在developerworks网站上，属于support那个频道，但你就是搜不着。
<strong>Java虚拟机规范概要</strong>
研究Java虚拟机，首先要了解Sun的Java虚拟机规范。现在，该实现版本很多，如比较有名的Sun、IBM、BEA、Apple、HP、MS、Apache Harmony。它们都实现了JVM规范，但有各自扩展。譬如，针对IBM虚拟机的堆碎片导致OutOfMemory（OOM），在Sun的虚拟机上就不会发生。Sun的JVM有maxPermSize的概念，IBM就没有，如果你设置这个参数，虚拟机根本就启动不了。
比较有意思的是，学Java，就一定要了解各种规范，这和MS的风格很不一样。Sun总是在定义一些规范，实现都留给各厂商。我们除了理解规范本身外，一定要理解规范和实现之间的关系，譬如JDBC规范和JDBC驱动的关系，它们是怎么组合到一起的。要是你用过php的xml解析库，或db函数，就会体会深刻，它们可没有什么规范可言，所以每个数据库厂商的db函数用法都不一样。我推荐大家研读一下HSQLDB的jdbc和Tomcat的servlet相关实现，因为我认为它们还是比较好懂的。
JVM规范只是定义一个虚拟机该做什么，但它并没有要求你该怎么做。例如我们最常见的Servlet规范，在该规范中，有HttpServletRequest、HttpServletResponse，HttpSession等接口，但它们的实现都留给了各个容器厂商。遗憾的是，规范留下的空白，会把我们这些开发人员给整惨了：容器间移植有时候就是恶梦。譬如J2EE并没有SSO规范，但它很重要，我以前专门针对它做过WebSphere AppServer和Weblogic AppServer的SSO项目，差别还是不小，不过还是有点共通，那就是都遵循JAAS规范。
<strong>JVM的结构</strong>
从功能上分，Java虚拟机主要由六个部分组成，可以分成三类：
第一类：JVM API：就是我们最常用的Java API，它是开发人员和Java交互的入口，它主要是JAVA_HOME/jre/lib下的运行时类库rt.jar和编译相关的tools.jar
第二类：JVM内部组件
类装载器(ClassLoader)：将Byte Array的 .class文件装载、链接和初始化。
内存管理(Memory Managent)：为对象分配内存，以及释放内存。后者就是垃圾回收Garbage Collector（GC）。由于JVM最复杂的、最影响性能的就是GC，所以内存管理一般就指垃圾回收。
诊断接口(Diagostics Interface)：这主要体现在JVMTI(jdk1.4下的JVMPI和JVMDI)，它主要用来诊断程序的问题和性能，一般提供给工具厂商实现。如eclispe IDE下的debug功能，Jprofiler性能调优工具。
类解释器(Interpreter)：解释装载进虚拟机的class对象，包括JIT等特性相关。
第三类：平台相关接口(Platform Interface)：主要为了跨操作系统平台重用JVM代码，不过，它和我们开发人员关系不大。
在以上六个组件中，我们开发人员最关心的是ClassLoader和GC，用Java做系统框架、容器和它们密切相关。做业务系统时一些基础代码也和它们打交道，譬如最常用的Class.forName(),Thread.currentThread.getContextClassLoader()。我们仔细想想，为什么是上面两个问题？因为，它和我们class的整个生命周期最为相关：怎么将一个class和相关class加载进来，class实例什么时候创建，什么时候被销毁？
所以，下面的部分我们要专门讨论这些问题。
<strong>ClassLoader</strong>
JVM主要有三类ClassLoader：Bootstrap、Extention、Application，该三类ClassLoader从上到下是分级(hierarchy)结构，遵循代理模型(Delegation Model)。
Tip：大家可以看看sun.misc.Launcher的源码，Bootstrap和Extention就在该文件里。该src可以在sun的网站上下载该压缩包，约60M(jdk-1_5_0-src-scsl.zip)，它不在jdk自带的那个src.zip里。
Bootstrap ClassLoader：也称为primordial(root) class loader。主要是负责装载jre/lib下的jar文件，当然，你也可以通过-Xbootclasspath参数定义。该ClassLoader不能被Java代码实例化，因为它是JVM本身的一部分。
Extention ClassLoader：该ClassLoader是Bootstrap classLoader的子class loader。它主要负责加载jre/lib/ext/下的所有jar文件。只要jar包放置这个位置，就会被虚拟机加载。一个常见的、类似的问题是，你将mysql的低版本驱动不小心放置在这儿，但你的Web应用程序的lib下有一个新的jdbc驱动，但怎么都报错，譬如不支持JDBC2.0的DataSource，这时你就要当心你的新jdbc可能并没有被加载。这就是ClassLoader的delegate现象。常见的有log4j、common-log、dbcp会出现问题，因为它们很容易被人塞到这个ext目录，或是Tomcat下的common/lib目录。
Application ClassLoader：也称为System ClassLoaer。它负责加载CLASSPATH环境变量下的classes。缺省情况下，它是用户创建的任何ClassLoader的父ClassLoader，我们创建的standalone应用的main class缺省情况下也是由它加载(通过Thread.currentThread().getContextClassLoader()查看)。
我们实际开发中，用ClassLoader更多时候是用其加载classpath下的资源，特别是配置文件，如ClassLoader.getResource()，比FileInputStream直接。
ClassLoader是一种分级(hierarchy)的代理(delegation)模型。
Delegation：其实是Parent Delegation，当需要加载一个class时，当前线程的ClassLoader首先会将请求代理到其父classLoader，递归向上，如果该class已经被父classLoader加载，那么直接拿来用，譬如典型的ArrayList，它最终由Bootstrap ClassLoader加载。并且，每个ClassLoader只有一个父ClassLoader。
Class查找的位置和顺序依次是：Cache、parent、self。
Hierarchy：上面的delegation已经暗示了一种分级结构，同时它也说明：一个ClassLoader只能看到被它自己加载的classes，或是看到其父(parent) ClassLoader或祖先(ancestor) ClassLoader加载的Classes。
在一个单虚拟机环境下，标识一个类有两个因素：class的全路径名、该类的ClassLoader。
我碰到的一个典型的例子是：在做WAS的SSO开发时，由于我们的类是由WAS在启动时加载，该ClassLoader比下面的部署的Applicaton的ClassLoader的级别高。所以，在我们自己的类中没法用到应用程序的连接池，必须自建。
代理模型是Java安全模型的保证。譬如，我们自己写一个String.java，并且编译、package到自己的java.lang包下。按照代理模型，当前线程的ClassLoader会将其代理到父ClassLoader，父ClassLoader(最终会是Bootstrap)会找到rt.jar下的String.class，也就是说我们的String.class不会捣乱。
<strong>自定义ClassLoader</strong>
我们前面说过，自定义ClassLoader的缺省父ClassLoader是Application ClassLoader。一般的应用开发用不到它，但我们最好理解。因为在内存泄漏查找、应用程序部署出问题时，很多都和它有关。
譬如，内存泄漏是怎么产生的？这就涉及到ClassLoader和Class的生命周期。我曾经碰到这样一个问题：我们的程序用到了Webwork和Spring框架，当部署到Tomcat下时没有任何问题，但部署到WAS下，报告找不到Webwork的xml的DTD文件，而且Spring的日志也总是失效。Why？因为解析xml dtd时，用的是IBM的Xerces，不是我们的。而Spring日志问题是因为应用程序用的是WAS的Common-log.jar，而不是我们的。将应用的ClassLoader从默认的Parent-First，改成Parent-Last就可以解决，不过我们项目中用到其它库，又发生了其它问题。
<strong>一般来说，用到自定义ClassLoader有三种情况：</strong>
1、应用框架可以自己控制Classes的目录，并且自动部署。
我读过Jive公司的Wildfire(著名的即时通讯服务器)，它自己有一套应用框架，非常灵活，遵循该框架插件规范的的第三方的plug-in放置在指定目录可以自动部署，实现某些扩展功能，如文件传输、语音聊天。
2、区分用户代码
这被广泛应用在Servlet容器和类似容器，譬如EJB Container设计中，大家看到Tomcat下有common、server、share三个目录吧(ClassLoader顺序从左到有)，另外也有用户应用的WEB-INF目录，它是我们自己开发的。
3、允许Classes卸载
如果没有自定义的ClassLoader，那么我们自己应用中的classes永远都不能被卸载，因为这些类被Application ClassLoader加载后cache起来了，我们的classes一直对该ClassLoader有引用，而该系统级的ClassLoader永远都不会被卸载，除非JVM shutdown了。JSP和Servlet的动态部署就用到这个特性。
待续…….
Note: 还有JVM运行时(Runtime)架构，ClassLoader加载class过程没有总结，这两部分我觉得太重要了，但内容太多，写不完啊。
这部分内容，《Inside Java Virtual Machine》讲解非常清楚，BEA的官方网站这部分也非常不错，要理解深刻，我建议结合JProfiler工具，非常直观。
待续…….
该文仅存的一点回复：
[zwchen]
<strong>为什么都说WAS难用？</strong>
<strong>安装过程</strong>
1、先安装WAS，然后创建三种不同类型的profiles(manager,default,custom)，譬如缺省的profiles吧，在创建这个profiles过程中，需要启动至少10个端口，要是那10个默认端口有些被你的系统占用了，麻烦就来了。改端口不就ok了吗？但你知道怎么改吗？可能你觉得没有必要10个端口，但WAS就是需要这么多：控制台端口两个(http，https),引导端口2089，soap、ORB，单元 cell发现….  总之，你都不知道你为什么要关心这么多端口。WLS够绝了：一个smart端口 7001全部搞定，在上走各种协议。
2、系统为你生成的上百个bat命令文件，里面交叉引用的path都是绝对路径，所以，往往你的机器重装了，那么WAS也重装吧。WLS和JBoss可以将整个文件夹移动，WAS不行，如果你喜欢折腾，当然也可以做到，就看值不值了。
控制台的部署过程
1、它总是以为我们的应用前台是httpd Server分发，于是让我们选择虚拟主机。其实，我们不是CMS系统，我们的Web前端就是WAS的web容器。
2、它总是以为我们的应用包含EJB，或是要发布成Web Services，于是让我们选择进退两难。其实，我们只是简单的Web应用。
3、它总是以为我们的应用要部署分散在多个WAS上，或者在cluster里，所以会强制要求我们选择发布目标位置。其实，我们只是用单Server。
4、它以为我们发布的应用是EAR企业包，而WAR包只是一个Web前端展示模块，所以它总是在xml配置里面写一堆。其实，我们很想手动修改配置文件。
我刚才特别部署了一个简单的web应用，就是Struts的sample，写入了29个xml配置文件。设想，保存部署文件是一个事务性的过程，如果你在大连，服务器在北京，速度超级慢，这个写入文件过程失败，呵呵，你就下地狱吧，我们碰到个几次，有一次就被迫服务器profiles重建。
虽然上面很多步骤我省略了，对于我特别说到的，虽然有默认，但每个默认页有上10个选项，而你并不是很明白这些选择的确切含义，它们是否相互冲突。
我建议WAS的设计师：请留下尽量少的发布步骤，需要定制，可以部署后修改，学学WLS吧：考虑普通开发人员的感受。
<strong>开发过程</strong>
用WAS，最好有其配套的开发工具，eclipse那个WAS插件，我试过不太好用。用RAD吧，要lisence。RAD也是个超级大户，官方推荐内存是最低768M，WAS官方推荐大概是1000M，我的1G机器也可以跑，就是慢了点。
大家如果用WAS的EJB容器，并且你想做standalone的ejb客户端，那么，千万不要选择IBM之外的JVM，我固执地试过，最后用sun的JVM成功了，但需要一堆IBM WAS下的jar，而且必须走IIOP协议，我可以说，初次使用99%的尝试是失败的。而且，此时的开发工具一定要选择IBM的 RAD或WSAD。建议，学习EJB这类分布式开发阶段，用WLS或JBoss吧，因为它们的EJB standalone客户端都支持smart stub。譬如，对于JBoss，它会通过socket先将客户端stub下载到本地，你察觉不到这个过程。大概WLS是通过反射生成stub。而WAS 必须部署过程编译一堆stub，需要引用一堆jar，sun的ejb部署大概也这样。之所以sun的简单点，那是因为你的ejb客户端jar往往自动被它加入了classpath，或者客户端是在AppServer里。
如果你要开发基于WAS的Web Services，并且用WAS内置的Web Services引擎，那么你一定要用它自己的开发工具发布和部署，我虽然成功了，只是因为太固执，付出的代价太大。
<strong>问题诊断</strong>
用WAS出问题比不出问题正常。出问题咋办？这个我暂时不说了，留给我的后文吧，总之一句话：问题独一无二。
我本人并不是说WAS做得烂，我只是想说明一点，它的使用，对我们的理论技术水平要求太高，特别不适合初学者。
———————————————————-
抛出异常的爱 写道
用的是5.只有一本。。。中文的。。
6有没有中文的红宝书？
[zwchen]像是现在还没有，我建议看它的原著吧，非常易懂，图特多，一天看200多页应该不困难。学习WAS，往往一本红皮书是不够的。市面上介绍WAS的书，大概极少有超越红皮书的。
——————————————————–
[zwchen]惭愧啊，我确实算不上高手，真正的高手在北京的IBM中国技术支持中心。我和那边的人电话和邮件聊过好多次，那才是一个字：高！
了解WAS，我随便总结一下吧：
引用</p>
<p>前提：你是项目组专门负责WAS上开发、部署、调优的，并且有与WAS抗争的决心。
1、学习WAS宝典丛书：WAS相关红皮书，前面我介绍过几本。并且多研究研究WAS的目录结构。
2、一本非红皮书，IBM内部的技术支持汇总，主要是关于诊断，但它最难吃透但最受用：《IBM® Developer Kit and Runtime Environment, Java™ 2 Technology Edition, Version 6.0  Diagnostics Guide》，500多页。
3、一定要有JVM相关技术积累：ClassLoader、GC策略，而且一定要注意它们与Sun的JVM的区别，往往WAS的问题发生在这个上面。如Sun的JVM一般建议heap的最大最小值一样，但IBM的JVM你要是这么做会导致严重的碎片问题。Why？默认的GC策略不同。
4、用JProfiler这类工具深入到WAS内部。
5、最好对JavaEE相关技术的原理有较深入的了解，譬如EJB的原理、Servlet的原理。而且，最好是这些技术怎么实现的，譬如读读Tomcat的源码,我强烈建议大家读一下这篇文章：<a href="http://www.onjava.com/pub/a/onjava/2003/05/14" target="_blank">http://www.onjava.com/pub/a/onjava/2003/05/14</a> /java_webserver.html。
整体体会，WAS的功底是在WAS之外，它只是对JVM、JavaEE规范的一个实现罢了。
另外也建议：不要花太多的时间的在WAS上，我认为非常不值。想研究，还不如去看JBoss，WLS。WAS这东西，知道一般的用法就够了，而且你永远都不可能明白它为什么有那么多的bug和不合理，明白了又能咋样？你的时间都白白浪费了。</p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li></span><span class="breadcrumb"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li><li><a href="/categories/Java&J2EE/JVM/">JVM</a></li></span></span> | <span class="tags">Tagged <a href="/tags/JVM/" class="label label-primary">JVM</a><a href="/tags/Java&J2EE/" class="label label-success">Java&J2EE</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:42"datetime="2014-03-07 09:54:42"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-JVM--Java虚拟机技术总结07年写的-原JavaEye精华帖/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JavaJ2EE-JVM--Java虚拟机技术总结07年写的-原JavaEye精华帖" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>





<ul id="pagination" class="pagination pagination-lg">
  <li><a class="extend prev" href="/page/48/">&laquo;</a></li><li><a class="page-number" href="/">1</a></li><li><a class="page-number" href="/page/2/">2</a></li><li><span class="space">&hellip;</span></li><li><a class="page-number" href="/page/46/">46</a></li><li><a class="page-number" href="/page/47/">47</a></li><li><a class="page-number" href="/page/48/">48</a></li><li class="active"><li><span class="page-number current">49</span></li><li><a class="page-number" href="/page/50/">50</a></li><li><a class="page-number" href="/page/51/">51</a></li><li><a class="page-number" href="/page/52/">52</a></li><li><span class="space">&hellip;</span></li></li><li><a class="page-number" href="/page/164/">164</a></li><li><a class="page-number" href="/page/165/">165</a></li><li><a class="extend next" href="/page/50/">&raquo;</a></li>
  <div class="clearfix"></div>
</ul></div><!--wapper-->
       </div><!-- ID main-col END -->
       <aside id="sidebar" class="alignright col-sx-6 col-sm-4 col-md-3 col-lg-3">
<div id="widget_search" class="widget panel panel-primary">
    <form action="//google.com/search" method="get" accept-charset="utf-8">
  <div class="input-group">
    <input class="form-control" id="searchbox" type="search" name="q" results="0" placeholder="search">
    <span class="input-group-btn">
      <button class="btn btn-default" type="submit">Go!</button>
    </span>
    <input type="hidden" name="q" value="site:itsolife.com">
  </div>
</form>
</div>

<div id="widget_category" class="widget panel panel-primary">
  <div class="panel-heading">category</div>  <div data-src='category' class='ajax_widgets'>正在加载...</div>
</div>

<div id="widget_recent_posts" class="widget panel panel-primary">
  <div class="panel-heading">recent posts</div>  <div data-src='recent_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_tagcloud" class="widget panel panel-primary">
  <div class="panel-heading">tagcloud</div>  <div data-src='tagcloud' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_latest_update_posts" class="widget panel panel-primary">
  <div class="panel-heading">最近更新</div>  <div data-src='latest_update_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_recent_comments" class="widget panel panel-primary">
  <div class="panel-heading">recent comments</div>  

<div class="list-group-item ds-recent-comments" data-num-items="6" data-show-avatars="1" data-show-time="1" data-show-title="1" data-show-admin="1" data-excerpt-length="50"></div>



</div>

</aside>
       <div class="clearfix"></div>
     </div><!-- row END -->
  </div>
  <footer id="footer" class="container">
  <div class="panel panel-info">
  <section id='footer_widget'></section>  <div class="panel-footer">
  <div id="site-info">
    <span class='author'>
  
  &copy; 2014 RobinChia
  
    &nbsp;&nbsp;</span>
  
  <span id='analytics-51la'></span><span id='analytics-google'>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-48559895-1']);
  _gaq.push(['_trackPageview']);
  _js2load.push({src:('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'});
</script></span><span id='analytics-cnzz'>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_5774006'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s17.cnzz.com/stat.php%3Fid%3D5774006%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</span><span id='analytics-baidu'>
<script>
var _hmt = _hmt || [];
_js2load.push({src:"//hm.baidu.com/hm.js?1442f50724afc42380b51f097c43082c"});
</script>
</span>  </div>
  <div id="copyright">Blog powered by <a href='http://zespia.tw/hexo/'><strong>hexo</strong></a> Theme <strong><a href='https://github.com/chenall/hexo-theme-chenall'>chenall</a></strong>(Some change in it)<span class="pull-right"> 更新时间: <em>2014-03-15 16:43:39</em></span></div>
</div>
<div class="clearfix"></div>


  </div>
  </footer>
  
        <script src="http://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>        
        <script src="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>        
                
        <script src="http://cdn.bootcss.com/prettify/r298/prettify.min.js"></script>    <script type="text/javascript">
   var lang=["bsh", "c", "cc", "cpp", "cs", "csh", "cyc", "cv", "htm", "html",
    "java", "js", "m", "mxml", "perl", "pl", "pm", "py", "rb", "sh",
    "xhtml", "xml", "xsl"];
   var pretty_base='';
   $('script').each(function(){
	var c = $(this).attr('src');
	if (!c)
	    return;
	if (c.match(/(\/)?prettify(\.min)?\.js/i))
	{
	    var index = c.lastIndexOf('/');
	    if (index != -1)
		pretty_base = c.substr(0,index + 1);
	    return false;
	}
   })
   $('pre code').each(function(){
	var c = $(this).attr('class')
	if (!c)
	    return;
	c = c.match(/\s?(lang\-\w+)/i);
	if (c && lang.indexOf(c[1]) == -1)
	{
	    lang.push(c[1]);
	    $.getScript(pretty_base + c[1] + '.min.js');
	}
   })

    $(window).load(function(){
       $("pre").addClass("prettyprint");
       prettyPrint();
    })
</script>    
            <script type="text/javascript">
var duoshuoQuery = {short_name:"robinchia"};
_js2load.push({src:'http://static.duoshuo.com/embed.js',charset:'UTF-8'});
</script>
    
            <!--wumii_relatedItems-->
    
        <script src="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>    <script type="text/javascript">
(function($){
  $('.entry').each(function(i){
    $(this).find('img').each(function(){
      var alt = this.alt;

      if (alt){
        $(this).before('<span class="caption">' + alt + '</span>');
      }

      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="fancybox' + i + '" />');
    });
  });

  $('.fancybox').fancybox();
})(jQuery);
</script>    
        <script src="http://cdn.bootcss.com/mathjax/2.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>
    
<script type="text/javascript">
$('.ajax_widgets').each(function(){var src=$(this).attr('data-src');if(src)$(this).load('/widgets/'+src+'.html');});
$.each(_js2load,function(index,obj){loadjs(obj.src,obj.charset)});
</script>

<div id="scroll2top">
<img src="/scroll2top/arrow.png"/>
</div>
<script src="/scroll2top/scroll2top.min.js"></script>
<div id="winterland">
  <canvas></canvas>
</div>
<script src="/js/winterland.min.js"></script>

  </body>
</html>
