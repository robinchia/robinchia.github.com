
<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>The 49 Page | It so life</title>
<meta name="author" content="RobinChia">

<meta name="description" content="It so life">


<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta property="og:site_name" content="It so life"/>

<!--[if IE]><style>.testIE.IE{display:inline;}</style><![endif]-->
<!--[if lte IE 7]><link rel="stylesheet" href="/css/ie7.css" type="text/css"><![endif]-->
<!--[if (lt IE 9)&(gt IE 7)]><style>.testIE.IE8{display:inline;}</style><![endif]-->
<!--[if gt IE 8]><style>.testIE.IE9{display:inline;}</style><![endif]-->

<link href="/favicon.png" rel="icon">
<link rel="alternate" href="/atom.xml" title="It so life Feed" type="application/atom+xml">

<link rel="stylesheet" href="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/font-awesome/4.0.3/css/font-awesome.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/prettify/r298/prettify.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" type="text/css">
<link rel="stylesheet" href="/css/style.css" type="text/css">
<!--[if lt IE 9]>
   <style>article,aside,dialog,footer,header,section,footer,nav,figure,menu{display:block}</style>
   <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
   <script src="http://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
<link href="http://cdn.staticfile.org/respond.js/1.4.2/respond-proxy.html" id="respond-proxy" rel="respond-proxy" />
<link href="/js/respond.proxy.gif" id="respond-redirect" rel="respond-redirect" />
<script src="/js/respond.proxy.js"></script>
   <script src="http://cdn.bootcss.com/selectivizr/1.0.2/selectivizr-min.js"></script>
<![endif]-->
<script type="text/javascript">
function loadjs(c,d){var a=document.createElement("script");a.async=!0;a.type="text/javascript";a.src=c;a.charset=d||"gbk";(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(a)};
var _protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
var _js2load = [];
</script>

</head>
<body>
      <header id="header" class="container"><nav id="main-nav" class="navbar navbar-default navbar-fixed-top " role="navigation">
  <div class="container">
    <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/">It so life</a>
    </div>
    <div  class="collapse navbar-collapse">
      <ul  class="nav navbar-nav">
  
        <li><a href="/" title="Home">Home</a></li>      
        <li><a href="/about/" title="About">About</a></li>      
        <li><a href="/archives/" title="Archives">Archives</a></li>      
      <li class='dropdown'>
        <a class='dropdown-toggle' data-toggle='dropdown' href='#'>website<b class='caret'></b></a>
        <ul class='dropdown-menu pure-menu-selected'>
    
          <li><a href="//groups.google.com/forum/#!forum/pongba" title="TopLanguage">TopLanguage</a></li>    
          <li><a href="//itpub.net/" title="ITPub">ITPub</a></li>    
          <li><a href="//blog.jobbole.com/" title="Bole">Bole</a></li>    
          <li><a href="//nosql-database.org/" title="nosql">nosql</a></li>    
          <li><a href="//gitimmersion.googol.im/" title="Git">Git</a></li>    
        </ul>
      </li>
    
      </ul>
      <ul class="nav navbar-nav navbar-right">
      
        <li><a href="/atom.xml">RSS</a></li>
      
      
        <li><a href="https://twitter.com/robinchia">twitter</a></li>
      
      
      
      
        <li><a href="https://github.com/robinchia">github</a></li>
      
      </ul>
    </div>
  </div>
</nav>
<div class="clearfix"></div>
</header>
  <div id='content' class="container">
     <div class="page-header-wrapper">
      <!--[if lt IE 9]><div class="alert alert-warning alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>提示:</strong>您的浏览器版本太低了,建议升级到 <strong><a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" title="IE9">IE9</a></strong> 以上,本站使用<a href="https://www.google.com/intl/zh-CN/chrome/">Chrome浏览器</a>可以获得最好的显示效果.</div><![endif]-->
      <div class="page-header"><h1 align="center"><big>It so life</big> </h1>
        <h5 align="center"><big>love as life</big></h5>
      </div>
     </div>
     <div class="row">
       <div id="main-col" class="alignleft col-sx-12 col-sm-8 col-md-9 col-lg-9">
      <section id='header_widget'></section>
          <div id="wrapper"><article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--JVM内存管理：深入Java内存区域与OOM-高级语言虚拟机/">JVM内存管理：深入Java内存区域与OOM </a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:42.000Z"> <a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--JVM内存管理：深入Java内存区域与OOM-高级语言虚拟机/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="jvm-java-oom-">JVM内存管理：深入Java内存区域与OOM - 高级语言虚拟机</h1>
<p><a href="http://hllvm.group.iteye.com/login" title="登录" target="_blank">您还未登录 !</a> <a href="http://hllvm.group.iteye.com/login" target="_blank">登录</a> <a href="http://hllvm.group.iteye.com/signup" target="_blank">注册</a></p>
<p><a href="http://www.iteye.com/" target="_blank"><img src="&quot;ITeye-最棒的软件开发交流社区&quot;" alt="ITeye3.0"></a></p>
<p><a href=""></a></p>
<p><a href="http://www.iteye.com/groups" target="_blank">群组首页</a> → <a href="http://hllvm.group.iteye.com/groups/category/language" target="_blank">编程语言</a> → <a href="http://hllvm.group.iteye.com/" target="_blank">高级语言虚拟机</a> → <a href="http://hllvm.group.iteye.com/group/wiki" target="_blank">知识库</a> → <a href="http://hllvm.group.iteye.com/group/wiki?category_id=316" target="_blank">JVM基础</a> → <a href="">JVM内存管理：深入Java内存区域与OOM</a>
原创作者: <a href="http://www.javaeye.com/topic/802573" target="_blank">IcyFenix</a>   阅读:10325次   评论:5条   更新时间:2011-05-26    </p>
<p>Java与C++之间有一堵由内存动态分配和垃圾收集技术所围成的高墙，墙外面的人想进去，墙里面的人却想出来。</p>
<h2 id="-">概述：</h2>
<p>对于从事C、C++程序开发的开发人员来说，在内存管理领域，他们即是拥有最高权力的皇帝又是执行最基础工作的劳动人民——拥有每一个对象的“所有权”，又担负着每一个对象生命开始到终结的维护责任。</p>
<p>对于Java程序员来说，不需要在为每一个new操作去写配对的delete/free，不容易出现内容泄漏和内存溢出错误，看起来由JVM管理内存一切都很美好。不过，也正是因为Java程序员把内存控制的权力交给了JVM，一旦出现泄漏和溢出，如果不了解JVM是怎样使用内存的，那排查错误将会是一件非常困难的事情。</p>
<h2 id="vm-">VM运行时数据区域</h2>
<p>JVM执行Java程序的过程中，会使用到各种数据区域，这些区域有各自的用途、创建和销毁时间。根据《Java虚拟机规范（第二版）》（下文称VM Spec）的规定，JVM包括下列几个运行时数据区域：</p>
<p>1.程序计数器（Program Counter Register）：</p>
<p>每一个Java线程都有一个程序计数器来用于保存程序执行到当前方法的哪一个指令，对于非Native方法，这个区域记录的是正在执行的VM原语的地址，如果正在执行的是Natvie方法，这个区域则为空（undefined）。此内存区域是唯一一个在VM Spec中没有规定任何OutOfMemoryError情况的区域。</p>
<p>2.Java虚拟机栈（Java Virtual Machine Stacks）</p>
<p>与程序计数器一样，VM栈的生命周期也是与线程相同。VM栈描述的是Java方法调用的内存模型：每个方法被执行的时候，都会同时创建一个帧（Frame）用于存储本地变量表、操作栈、动态链接、方法出入口等信息。每一个方法的调用至完成，就意味着一个帧在VM栈中的入栈至出栈的过程。在后文中，我们将着重讨论VM栈中本地变量表部分。</p>
<p>经常有人把Java内存简单的区分为堆内存（Heap）和栈内存（Stack），实际中的区域远比这种观点复杂，这样划分只是说明与变量定义密切相关的内存区域是这两块。其中所指的“堆”后面会专门描述，而所指的“栈”就是VM栈中各个帧的本地变量表部分。本地变量表存放了编译期可知的各种标量类型（boolean、byte、char、short、int、float、long、double）、对象引用（不是对象本身，仅仅是一个引用指针）、方法返回地址等。其中long和double会占用2个本地变量空间（32bit），其余占用1个。本地变量表在进入方法时进行分配，当进入一个方法时，这个方法需要在帧中分配多大的本地变量是一件完全确定的事情，在方法运行期间不改变本地变量表的大小。</p>
<p>在VM Spec中对这个区域规定了2中异常状况：如果线程请求的栈深度大于虚拟机所允许的深度，将抛出StackOverflowError异常；如果VM栈可以动态扩展（VM Spec中允许固定长度的VM栈），当扩展时无法申请到足够内存则抛出OutOfMemoryError异常。</p>
<p>3.本地方法栈（Native Method Stacks）</p>
<p>本地方法栈与VM栈所发挥作用是类似的，只不过VM栈为虚拟机运行VM原语服务，而本地方法栈是为虚拟机使用到的Native方法服务。它的实现的语言、方式与结构并没有强制规定，甚至有的虚拟机（譬如Sun Hotspot虚拟机）直接就把本地方法栈和VM栈合二为一。和VM栈一样，这个区域也会抛出StackOverflowError和OutOfMemoryError异常。</p>
<p>4.Java堆（Java Heap）</p>
<p>对于绝大多数应用来说，Java堆是虚拟机管理最大的一块内存。Java堆是被所有线程共享的，在虚拟机启动时创建。Java堆的唯一目的就是存放对象实例，绝大部分的对象实例都在这里分配。这一点在VM Spec中的描述是：所有的实例以及数组都在堆上分配（原文：The heap is the runtime data area from which memory for all class instances and arrays is allocated），但是在逃逸分析和标量替换优化技术出现后，VM Spec的描述就显得并不那么准确了。</p>
<p>Java堆内还有更细致的划分：新生代、老年代，再细致一点的：eden、from survivor、to survivor，甚至更细粒度的本地线程分配缓冲（TLAB）等，无论对Java堆如何划分，目的都是为了更好的回收内存，或者更快的分配内存，在本章中我们仅仅针对内存区域的作用进行讨论，Java堆中的上述各个区域的细节，可参见本文第二章《JVM内存管理：深入垃圾收集器与内存分配策略》。</p>
<p>根据VM Spec的要求，Java堆可以处于物理上不连续的内存空间，它逻辑上是连续的即可，就像我们的磁盘空间一样。实现时可以选择实现成固定大小的，也可以是可扩展的，不过当前所有商业的虚拟机都是按照可扩展来实现的（通过-Xmx和-Xms控制）。如果在堆中无法分配内存，并且堆也无法再扩展时，将会抛出OutOfMemoryError异常。</p>
<p>5.方法区（Method Area）</p>
<p>叫“方法区”可能认识它的人还不太多，如果叫永久代（Permanent Generation）它的粉丝也许就多了。它还有个别名叫做Non-Heap（非堆），但是VM Spec上则描述方法区为堆的一个逻辑部分（原文：the method area is logically part of the heap），这个名字的问题还真容易令人产生误解，我们在这里就不纠结了。</p>
<p>方法区中存放了每个Class的结构信息，包括常量池、字段描述、方法描述等等。VM Space描述中对这个区域的限制非常宽松，除了和Java堆一样不需要连续的内存，也可以选择固定大小或者可扩展外，甚至可以选择不实现垃圾收集。相对来说，垃圾收集行为在这个区域是相对比较少发生的，但并不是某些描述那样永久代不会发生GC（至少对当前主流的商业JVM实现来说是如此），这里的GC主要是对常量池的回收和对类的卸载，虽然回收的“成绩”一般也比较差强人意，尤其是类卸载，条件相当苛刻。</p>
<p>6.运行时常量池（Runtime Constant Pool）</p>
<p>Class文件中除了有类的版本、字段、方法、接口等描述等信息外，还有一项信息是常量表(constant_pool table)，用于存放编译期已可知的常量，这部分内容将在类加载后进入方法区（永久代）存放。但是Java语言并不要求常量一定只有编译期预置入Class的常量表的内容才能进入方法区常量池，运行期间也可将新内容放入常量池（最典型的String.intern()方法）。</p>
<p>运行时常量池是方法区的一部分，自然受到方法区内存的限制，当常量池无法在申请到内存时会抛出OutOfMemoryError异常。</p>
<p>7.本机直接内存（Direct Memory）</p>
<p>直接内存并不是虚拟机运行时数据区的一部分，它根本就是本机内存而不是VM直接管理的区域。但是这部分内存也会导致OutOfMemoryError异常出现，因此我们放到这里一起描述。</p>
<p>在JDK1.4中新加入了NIO类，引入一种基于渠道与缓冲区的I/O方式，它可以通过本机Native函数库直接分配本机内存，然后通过一个存储在Java堆里面的DirectByteBuffer对象作为这块内存的引用进行操作。这样能在一些场景中显著提高性能，因为避免了在Java对和本机堆中来回复制数据。</p>
<p>显然本机直接内存的分配不会受到Java堆大小的限制，但是即然是内存那肯定还是要受到本机物理内存（包括SWAP区或者Windows虚拟内存）的限制的，一般服务器管理员配置JVM参数时，会根据实际内存设置-Xmx等参数信息，但经常忽略掉直接内存，使得各个内存区域总和大于物理内存限制（包括物理的和操作系统级的限制），而导致动态扩展时出现OutOfMemoryError异常。</p>
<h2 id="-outofmemoryerror">实战OutOfMemoryError</h2>
<p>上述区域中，除了程序计数器，其他在VM Spec中都描述了产生OutOfMemoryError（下称OOM）的情形，那我们就实战模拟一下，通过几段简单的代码，令对应的区域产生OOM异常以便加深认识，同时初步介绍一些与内存相关的虚拟机参数。下文的代码都是基于Sun Hotspot虚拟机1.6版的实现，对于不同公司的不同版本的虚拟机，参数与程序运行结果可能结果会有所差别。</p>
<p><strong>Java**</strong>堆**</p>
<p>Java堆存放的是对象实例，因此只要不断建立对象，并且保证GC Roots到对象之间有可达路径即可产生OOM异常。测试中限制Java堆大小为20M，不可扩展，通过参数-XX:+HeapDumpOnOutOfMemoryError让虚拟机在出现OOM异常的时候Dump出内存映像以便分析。（关于Dump映像文件分析方面的内容，可参见本文第三章《JVM内存管理：深入JVM内存异常分析与调优》。）</p>
<p>清单1：Java堆OOM测试
//<em>/</em></p>
<p> /* VM Args：-Xms20m -Xmx20m -XX:+HeapDumpOnOutOfMemoryError</p>
<p> /* @author zzm</p>
<p> /*/</p>
<p>public class HeapOOM {</p>
<pre><code>   static class OOMObject {

   }



   public static void main(String[] args) {

          List&lt;OOMObject&gt; list = new ArrayList&lt;OOMObject&gt;();



          while (true) {

                 list.add(new OOMObject());

          }

   }
</code></pre><p>}</p>
<p>运行结果：
java.lang.OutOfMemoryError: Java heap space</p>
<p>Dumping heap to java_pid3404.hprof ...</p>
<p>Heap dump file created [22045981 bytes in 0.663 secs]</p>
<p><strong>VM**</strong>栈和本地方法栈**</p>
<p>Hotspot虚拟机并不区分VM栈和本地方法栈，因此-Xoss参数实际上是无效的，栈容量只由-Xss参数设定。关于VM栈和本地方法栈在VM Spec描述了两种异常：StackOverflowError与OutOfMemoryError，当栈空间无法继续分配分配时，到底是内存太小还是栈太大其实某种意义上是对同一件事情的两种描述而已，在笔者的实验中，对于单线程应用尝试下面3种方法均无法让虚拟机产生OOM，全部尝试结果都是获得SOF异常。</p>
<p>1.使用-Xss参数削减栈内存容量。结果：抛出SOF异常时的堆栈深度相应缩小。</p>
<p>2.定义大量的本地变量，增大此方法对应帧的长度。结果：抛出SOF异常时的堆栈深度相应缩小。</p>
<p>3.创建几个定义很多本地变量的复杂对象，打开逃逸分析和标量替换选项，使得JIT编译器允许对象拆分后在栈中分配。结果：实际效果同第二点。</p>
<p>清单2：VM栈和本地方法栈OOM测试（仅作为第1点测试程序）
//<em>/</em></p>
<p> /* VM Args：-Xss128k</p>
<p> /* @author zzm</p>
<p> /*/</p>
<p>public class JavaVMStackSOF {</p>
<pre><code>   private int stackLength = 1;



   public void stackLeak() {

          stackLength++;

          stackLeak();

   }



   public static void main(String[] args) throws Throwable {

          JavaVMStackSOF oom = new JavaVMStackSOF();

          try {

                 oom.stackLeak();

          } catch (Throwable e) {

                 System.out.println(&quot;stack length:&quot; + oom.stackLength);

                 throw e;

          }

   }
</code></pre><p>}</p>
<p>运行结果：
stack length:2402</p>
<p>Exception in thread &quot;main&quot; java.lang.StackOverflowError</p>
<pre><code>    at org.fenixsoft.oom.JavaVMStackSOF.stackLeak(JavaVMStackSOF.java:20)

    at org.fenixsoft.oom.JavaVMStackSOF.stackLeak(JavaVMStackSOF.java:21)

    at org.fenixsoft.oom.JavaVMStackSOF.stackLeak(JavaVMStackSOF.java:21)
</code></pre><p>如果在多线程环境下，不断建立线程倒是可以产生OOM异常，但是基本上这个异常和VM栈空间够不够关系没有直接关系，甚至是给每个线程的VM栈分配的内存越多反而越容易产生这个OOM异常。</p>
<p>原因其实很好理解，操作系统分配给每个进程的内存是有限制的，譬如32位Windows限制为2G，Java堆和方法区的大小JVM有参数可以限制最大值，那剩余的内存为2G（操作系统限制）-Xmx（最大堆）-MaxPermSize（最大方法区），程序计数器消耗内存很小，可以忽略掉，那虚拟机进程本身耗费的内存不计算的话，剩下的内存就供每一个线程的VM栈和本地方法栈瓜分了，那自然每个线程中VM栈分配内存越多，就越容易把剩下的内存耗尽。</p>
<p>清单3：创建线程导致OOM异常
//<em>/</em></p>
<p> /* VM Args：-Xss2M （这时候不妨设大些）</p>
<p> /* @author zzm</p>
<p> /*/</p>
<p>public class JavaVMStackOOM {</p>
<pre><code>   private void dontStop() {

          while (true) {

          }

   }



   public void stackLeakByThread() {

          while (true) {

                 Thread thread = new Thread(new Runnable() {

                        @Override

                        public void run() {

                               dontStop();

                        }

                 });

                 thread.start();

          }

   }



   public static void main(String[] args) throws Throwable {

          JavaVMStackOOM oom = new JavaVMStackOOM();

          oom.stackLeakByThread();

   }
</code></pre><p>}</p>
<p>特别提示一下，如果读者要运行上面这段代码，记得要存盘当前工作，上述代码执行时有很大令操作系统卡死的风险。</p>
<p>运行结果：
Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: unable to create new native thread</p>
<p><strong>运行时常量池</strong></p>
<hr>
<p>要在常量池里添加内容，最简单的就是使用String.intern()这个Native方法。由于常量池分配在方法区内，我们只需要通过-XX:PermSize和-XX:MaxPermSize限制方法区大小即可限制常量池容量。实现代码如下：</p>
<p>清单4：运行时常量池导致的OOM异常
//<em>/</em></p>
<p> /* VM Args：-XX:PermSize=10M -XX:MaxPermSize=10M</p>
<p> /* @author zzm</p>
<p> /*/</p>
<p>public class RuntimeConstantPoolOOM {</p>
<pre><code>   public static void main(String[] args) {

          // 使用List保持着常量池引用，压制Full GC回收常量池行为

          List&lt;String&gt; list = new ArrayList&lt;String&gt;();

          // 10M的PermSize在integer范围内足够产生OOM了

          int i = 0;

          while (true) {

                 list.add(String.valueOf(i++).intern());

          }

   }
</code></pre><p>}</p>
<p>运行结果：
Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: PermGen space</p>
<pre><code>   at java.lang.String.intern(Native Method)

   at org.fenixsoft.oom.RuntimeConstantPoolOOM.main(RuntimeConstantPoolOOM.java:18)
</code></pre><p><strong>方法区</strong></p>
<p>上文讲过，方法区用于存放Class相关信息，所以这个区域的测试我们借助CGLib直接操作字节码动态生成大量的Class，值得注意的是，这里我们这个例子中模拟的场景其实经常会在实际应用中出现：当前很多主流框架，如Spring、Hibernate对类进行增强时，都会使用到CGLib这类字节码技术，当增强的类越多，就需要越大的方法区用于保证动态生成的Class可以加载入内存。</p>
<p>清单5：借助CGLib使得方法区出现OOM异常
//<em>/</em></p>
<p> /* VM Args： -XX:PermSize=10M -XX:MaxPermSize=10M</p>
<p> /* @author zzm</p>
<p> /*/</p>
<p>public class JavaMethodAreaOOM {</p>
<pre><code>   public static void main(String[] args) {

          while (true) {

                 Enhancer enhancer = new Enhancer();

                 enhancer.setSuperclass(OOMObject.class);

                 enhancer.setUseCache(false);

                 enhancer.setCallback(new MethodInterceptor() {

                        public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable {

                               return proxy.invokeSuper(obj, args);

                        }

                 });

                 enhancer.create();

          }

   }



   static class OOMObject {



   }
</code></pre><p>}</p>
<p>运行结果：
Caused by: java.lang.OutOfMemoryError: PermGen space</p>
<pre><code>   at java.lang.ClassLoader.defineClass1(Native Method)

   at java.lang.ClassLoader.defineClassCond(ClassLoader.java:632)

   at java.lang.ClassLoader.defineClass(ClassLoader.java:616)

   ... 8 more
</code></pre><p><strong>本机直接内存</strong></p>
<p>DirectMemory容量可通过-XX:MaxDirectMemorySize指定，不指定的话默认与Java堆（-Xmx指定）一样，下文代码越过了DirectByteBuffer，直接通过反射获取Unsafe实例进行内存分配（Unsafe类的getUnsafe()方法限制了只有引导类加载器才会返回实例，也就是基本上只有rt.jar里面的类的才能使用），因为DirectByteBuffer也会抛OOM异常，但抛出异常时实际上并没有真正向操作系统申请分配内存，而是通过计算得知无法分配既会抛出，真正申请分配的方法是unsafe.allocateMemory()。</p>
<p>//<em>/</em></p>
<p> /* VM Args：-Xmx20M -XX:MaxDirectMemorySize=10M</p>
<p> /* @author zzm</p>
<p> /*/</p>
<p>public class DirectMemoryOOM {</p>
<pre><code>   private static final int _1MB = 1024 /* 1024;



   public static void main(String[] args) throws Exception {

          Field unsafeField = Unsafe.class.getDeclaredFields()[0];

          unsafeField.setAccessible(true);

          Unsafe unsafe = (Unsafe) unsafeField.get(null);

          while (true) {

                 unsafe.allocateMemory(_1MB);

          }

   }
</code></pre><p>}</p>
<p>运行结果：
Exception in thread &quot;main&quot; java.lang.OutOfMemoryError</p>
<pre><code>   at sun.misc.Unsafe.allocateMemory(Native Method)

   at org.fenixsoft.oom.DirectMemoryOOM.main(DirectMemoryOOM.java:20)
</code></pre><h1 id="-">总结</h1>
<p>到此为止，我们弄清楚虚拟机里面的内存是如何划分的，哪部分区域，什么样的代码、操作可能导致OOM异常。虽然Java有垃圾收集机制，但OOM仍然离我们并不遥远，本章内容我们只是知道各个区域OOM异常出现的原因，下一章我们将看看Java垃圾收集机制为了避免OOM异常出现，做出了什么样的努力。
<a href="http://hllvm.group.iteye.com/group/wiki/2859-JVM" title="JVM内存管理：深入垃圾收集器与内存分配策略" target="_blank">JVM内存管理：深入垃圾收集器与内存分配策 ...</a> | <a href="http://hllvm.group.iteye.com/group/wiki/2871-JVM" title="深入理解JVM" target="_blank">深入理解JVM</a></p>
<p>评论 共 5 条 请<a href="http://hllvm.group.iteye.com/login" target="_blank">登录</a>后发表评论 <a href=""></a></p>
<h3 id="5-http-bahaihe-iteye-com-2013-06-26-21-38">5 楼 <a href="http://bahaihe.iteye.com/" title="巴海和" target="_blank">巴海和</a> 2013-06-26 21:38</h3>
<p>前辈，能够讲一下关于类被加载到内存后，它运行过程是什么？就是讲一下方法区、栈区、程序计数器是如何相互配合完成类的运行的？谢谢</p>
<h3 id="4-zhifeidie12-http-zhifeidie12-iteye-com-zhifeidie12-2013-02-26-23-58">4 楼 <a href="http://zhifeidie12.iteye.com/" title="zhifeidie12" target="_blank">zhifeidie12</a> 2013-02-26 23:58</h3>
<p><img src="" alt=""></p>
<h3 id="3-java-http-pinefantasy-iteye-com-java-2011-04-14-13-19">3 楼 <a href="http://pinefantasy.iteye.com/" title="独爱Java" target="_blank">独爱Java</a> 2011-04-14 13:19</h3>
<p>谢谢作者的好文章，受教了!!!</p>
<h3 id="2-nathanyu-http-nathanyu-iteye-com-nathanyu-2011-04-11-12-32">2 楼 <a href="http://nathanyu.iteye.com/" title="Nathanyu" target="_blank">Nathanyu</a> 2011-04-11 12:32</h3>
<p>  有了这资料 正好把基础打好点.</p>
<h3 id="1-sd6733531-http-sd6733531-iteye-com-sd6733531-2011-02-22-11-20">1 楼 <a href="http://sd6733531.iteye.com/" title="sd6733531" target="_blank">sd6733531</a> 2011-02-22 11:20</h3>
<p><img src="" alt="">
看了前辈的讲解对JVM有了更深入的了解了</p>
<h3 id="-">发表评论</h3>
<p><a href="http://hllvm.group.iteye.com/login" target="_blank"><img src="" alt=""> 您还没有登录,请您登录后再发表评论</a></p>
<p><a href="http://hllvm.group.iteye.com/group/wiki/new" target="_blank"><img src="" alt="New-page"></a></p>
<h3 id="-">文章信息</h3>
<p><a href="http://hllvm.group.iteye.com/group/wiki/" target="_blank">知识库: 高级语言虚拟机</a></p>
<ul>
<li>由<a href="http://kiral.iteye.com/" title="fantasy" target="_blank">fantasy</a>在2010-11-08创建</li>
<li><p>由<a href="http://kiral.iteye.com/" title="fantasy" target="_blank">fantasy</a>在2011-05-26更新</p>
<h3 id="-">相关新闻</h3>
</li>
<li><p><a href="http://hllvm.group.iteye.com/news/27958-JVM" target="_blank">你必须知道的5个JVM命令行标志</a></p>
</li>
<li><a href="http://hllvm.group.iteye.com/news/16601" target="_blank">Azul Systems将要开源Managed Runtime Initiative中的重要技术</a></li>
<li><a href="http://hllvm.group.iteye.com/news/2823" target="_blank">推荐风轻扬：Java 6中的性能优化</a></li>
</ul>
<h3 id="-">相关讨论</h3>
<ul>
<li><a href="http://hllvm.group.iteye.com/topic/802573" target="_blank">JVM内存管理：深入Java内存区域与OOM</a></li>
<li><a href="http://hllvm.group.iteye.com/topic/966928" target="_blank">jvm的各个运行时数据区域的理解</a></li>
<li><a href="http://hllvm.group.iteye.com/topic/622488" target="_blank">[JVM-翻译]揭开java.lang.OutOfMemoryError面纱之一</a></li>
<li><a href="http://hllvm.group.iteye.com/topic/808550" target="_blank">线程安全总结（二）</a></li>
<li><p><a href="http://hllvm.group.iteye.com/topic/1120656" target="_blank">java内存区域与内存溢出异常</a></p>
<h3 id="-">相关博客</h3>
</li>
<li><p><a href="http://tomyz0223.iteye.com/blog/803943" target="_blank">JVM 运行时区域划分（转载）</a></p>
</li>
<li><a href="http://zhuyuehua.iteye.com/blog/930058" target="_blank">JVM运行时数据区结构</a></li>
<li><a href="http://alanlhy.iteye.com/blog/1165044" target="_blank">VM运行时数据区域</a></li>
<li><a href="http://tanghongjun1985.iteye.com/blog/1748159" target="_blank">jdk优化和配置</a></li>
<li><a href="http://wujianjun12315.iteye.com/blog/1683962" target="_blank">深入了解Java运行时的内存区域</a></li>
<li><a href="http://www.iteye.com/" target="_blank">首页</a></li>
<li><a href="http://www.iteye.com/news" target="_blank">资讯</a></li>
<li><a href="http://www.iteye.com/magazines" target="_blank">精华</a></li>
<li><a href="http://www.iteye.com/forums" target="_blank">论坛</a></li>
<li><a href="http://www.iteye.com/ask" target="_blank">问答</a></li>
<li><a href="http://www.iteye.com/blogs" target="_blank">博客</a></li>
<li><a href="http://www.iteye.com/blogs/subjects" target="_blank">专栏</a></li>
<li><a href="http://www.iteye.com/groups" target="_blank">群组</a></li>
<li><a href="http://job.iteye.com/iteye" target="_blank">招聘</a></li>
<li><a href="http://www.iteye.com/search" target="_blank">搜索</a></li>
<li><a href="http://hllvm.group.iteye.com/index/service" target="_blank">广告服务</a></li>
<li><a href="http://webmaster.iteye.com/" target="_blank">ITeye黑板报</a></li>
<li><a href="http://hllvm.group.iteye.com/index/contactus" target="_blank">联系我们</a></li>
<li><a href="http://hllvm.group.iteye.com/index/friend_links" target="_blank">友情链接</a></li>
</ul>
<p>© 2003-2012 ITeye.com. [ <a href="http://www.miibeian.gov.cn/" target="_blank">京ICP证110151号</a> 京公网安备110105010620 ]
百联优力(北京)投资有限公司 版权所有 <img src="http://stat.iteye.com/?url=http%3A%2F%2Fhllvm.group.iteye.com%2Fgroup%2Fwiki%2F2857-JVM&amp;referrer=http%3A%2F%2Fhllvm.group.iteye.com%2Fgroup%2Fwiki%2F%3Fcategory_id%3D316&amp;user_id=" alt=""></p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li></span><span class="breadcrumb"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li><li><a href="/categories/Java&J2EE/JVM/">JVM</a></li></span></span> | <span class="tags">Tagged <a href="/tags/JVM/" class="label label-primary">JVM</a><a href="/tags/Java&J2EE/" class="label label-success">Java&J2EE</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:42"datetime="2014-03-07 09:54:42"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-JVM--JVM内存管理：深入Java内存区域与OOM-高级语言虚拟机/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JavaJ2EE-JVM--JVM内存管理：深入Java内存区域与OOM-高级语言虚拟机" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--IBMWebSphereApplicationServer诊断和调优07年写的-原Java/">IBM WebSphere Application Server 诊断和调优(07年写的</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:42.000Z"> <a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--IBMWebSphereApplicationServer诊断和调优07年写的-原Java/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="ibm-websphere-application-server-07-javaeye-">IBM WebSphere Application Server 诊断和调优(07年写的,原JavaEye精华帖)</h1>
<p><a href="http://www.iteye.com/" target="_blank">首页</a> <a href="http://www.iteye.com/news" target="_blank">资讯</a> <a href="http://www.iteye.com/magazines" target="_blank">精华</a> <a href="http://www.iteye.com/forums" target="_blank">论坛</a> <a href="http://www.iteye.com/ask" target="_blank">问答</a> <a href="http://www.iteye.com/blogs" target="_blank">博客</a> <a href="http://www.iteye.com/blogs/subjects" target="_blank">专栏</a> <a href="http://www.iteye.com/groups" target="_blank">群组</a> <a href="">更多 ▼</a></p>
<p><a href="http://job.iteye.com/iteye" target="_blank">招聘</a> <a href="http://www.iteye.com/search" target="_blank">搜索</a></p>
<p><a href="http://zwchen.iteye.com/login" title="登录" target="_blank">您还未登录 !</a> <a href="http://zwchen.iteye.com/login" target="_blank">登录</a> <a href="http://zwchen.iteye.com/signup" target="_blank">注册</a></p>
<h1 id="-zwchen-http-zwchen-iteye-com-"><a href="http://zwchen.iteye.com/" target="_blank">zwchen的博客</a></h1>
<ul>
<li><a href="http://zwchen.iteye.com/" target="_blank"><strong>博客</strong></a></li>
<li><a href="http://zwchen.iteye.com/weibo" target="_blank">微博</a></li>
<li><a href="http://zwchen.iteye.com/album" target="_blank">相册</a></li>
<li><a href="http://zwchen.iteye.com/link" target="_blank">收藏</a></li>
<li><a href="http://zwchen.iteye.com/blog/guest_book" target="_blank">留言</a></li>
<li><a href="http://zwchen.iteye.com/blog/profile" target="_blank">关于我</a></li>
</ul>
<h3 id="-ibm-websphere-application-server-07-javaeye-"><a href="">IBM WebSphere Application Server 诊断和调优(07年写的,原JavaEye精华帖)</a> **</h3>
<p><strong>博客分类：</strong></p>
<ul>
<li><a href="http://zwchen.iteye.com/category/9634" target="_blank">IT技术</a>
<a href="http://www.iteye.com/blogs/tag/IBM" target="_blank">IBM</a><a href="http://www.iteye.com/blogs/tag/Websphere" target="_blank">Websphere</a><a href="http://www.iteye.com/blogs/tag/AIX" target="_blank">AIX</a><a href="http://www.iteye.com/blogs/tag/JVM" target="_blank">JVM</a><a href="http://www.iteye.com/blogs/tag/CMS" target="_blank">CMS</a></li>
</ul>
<p>这是<a href="http://zwchen.iteye.com/blog/646063" target="_blank">上篇文章</a>的续篇，也是07年初发表于JavaEye，被评为精华帖，浏览近四万次，也被各大IT媒体转载（google可查）。基于同样的原因，被删除了）。
对WebSphere一线开发人员，这么珍贵的文章，特别是会员的评论，就被这个商业社会给和谐。
因为，寻找和阅读WebSphere诊断和调优的资料，非常困难，否则，它那高额的服务费哪里来？（IBM的WebSphere服务费：人民币10000元/天）。</p>
<h2 id="-"><img src="&quot;点击查看原始大小图片&quot;" alt=""></h2>
<p>续写这篇文章，已经过去一个半月了。直到现在，系统一直运行平稳。
先说说我接手这项工作的经历吧：该项目大部分是06年10月就部署在客户那边了，到07年3月份，WAS宕机问题实在无法忍受，我才加入进来，前半年有另外一位同事断断续续处理，但对问题一直都无可奈何，而且项目负责人也没有引起足够的重视。可想而知，最后付出的代价是非常惨重的。在这近半年的时间内，服务器宕机63次。每次宕机时，WAS的JVM会dump出一个heapdump.phd文件(heap快照)，然后JVM就死掉了，当然，此时WAS也停止了响应。一般我们的做法是重启，最后是干脆AIX每天晚上定时重启。有时候一天还死多次。大家见附件的截图（all- GC.png）。这是我接手后，用IBM的分析工具得到的截图。对截图的分析，留给后面对应的部分吧。
服务器不稳定、宕机问题，拖延到最后，客户愤怒了，公司高层也害怕了，部门还专门成立了八人攻关组。当然了，我当时的压力也非常大，因为我是技术负责人，也就是实实在在干活、想主意的。
服务器诊断那段时间，从前到后，我们也是沿着一条线走下来，虽然最后发现很多路都走不通。现在就按这个思路，也就是时间先后一步步叙述吧。我想，大家如果也碰到类似应用服务器诊断，应该思路差不多。
术语说明：
IBM Websphere Application Server：WAS，WebSphere本身是一个平台，产品家族
OutOfMemoryError：OOM，内存泄漏，内存溢出
Gabage Collection：GC，自动垃圾回收
Content Management System：CMS，就是给新闻类门户网站编辑们用的系统
我们诊断大体上经历了以下几个阶段：
1、按Job调度线程池引起内存泄漏诊断：因为很多次OOM是发生在某个特定时候，譬如14：30、22：40左右。
2、按应用程序引起内存泄漏诊断：用JProfiler等工具探测：因为总是发生OOM。
3、分离WAS怀疑有OOM的应用：因为每个WAS应用太多，20来个，混一起没法定位。
4、用IBM官方heap、GC分析工具。以及和IBM技术支持联系。WAS、AIX参数优化。
5、隔离出WAS超级恶魔程序：一个CMS产品。
6、WAS、AIX参数优化、设置。
我们走到第5步时，才出现效果。计算一下，那时已经过去一个月了。服务器宕机、系统不稳定，在这个验收的时候，客户已经忍无可忍，以致后来的每一次行动都得胆战心惊得去做。
<strong>一、按Job调度线程池导致内存泄漏诊断</strong>
因为从我们WAS的日志(默认是native_stderr.log)来看，最近半年的宕机时间都有一个明显时间规律。见附件截图Job1-1.png。
我想，做过Java服务器性能调优的朋友，都知道在Web容器里面启线程池是个不太好的做法，因为Web容器本身有一个线程池，譬如Servlet线程池（Tomcat默认起25个），而自启的线程池很容易导致Servlet线程管理混乱，最终导致GC问题。我们的现象似乎和那很符合。如果我们沿着这个思路做下去，具体怎样实施呢？
我们的WAS上部署了20个左右的Web应用，譬如Lucene全文检索、B2B行业数据同步等，都是通过Quartz的Job调度做的，当然还有很多其它调度。当时，由我负责，通知相关负责人，将定时调度暂时去掉。观察了几天，后来发现问题依然存在，不过时间有点随机了。
不过，最后还是发现OOM不是由Job调度引起的。
也就是说，我们这个方案是失败的。而且，我们的很多想法都是臆测的，没有可靠的根据，也没有方向，再加上我是第一次处理这种问题，这导致后来查找问题的艰难。但是，仔细想想，我们又能拿什么做依据呢？出现OOM错误，我想大多数人想到的，除了JVM参数设置，就是内存泄漏。其实，OOM发生有很多种情况，在IBM、Sun、BEA等不同虚拟机上，因为GC机制不一样，所以原因一般都不同，容易定位难度也不一样。下文会谈到。
于是，我们干脆釜底抽薪分析问题吧：用JProfiler检测。
<strong>二、按应用程序导致内存泄漏诊断，JProfiler检测</strong>
如果遇到OOM问题，我想大家都会想到内存检测工具，现在最可靠的还是下面三种分析工具：Borland 的Optimizeit Suite，Quest的JProbe，ej-technologies的JProfiler。但面临三个问题：
1、三个都是商业产品，公司暂时没有买，必须自己下载，而且要找序列号。
2、工具必须支持AIX5.3＋JDK1.42＋WAS6.0，不是Windows平台。
3、工具必须在客户真实环境下部署，对客户的业务不能有冲击，也就是说部署测试工具前，必须做个大量测试，对工具非常熟练，遇到意外可以立即恢复现场。
Note:项目上线后，而不是测试或试运行阶段遇到此类问题，非常考验人；另外一个，就是性能和可伸缩性问题，很可能把整个项目给毁了。
当我决定要这么做后，就立即动手查阅这些工具的官方文档，用emule下载，最终都下载到了。试用后，最终选择了JProfiler4.03，比起其它工具，它界面美观、清晰、功能强大、集成度高(Heap,Memory,CPU,Thread都统一了)。另外，JProbe没有AIX版本，这也是放弃它的一个原因。
JVM的Profiler原理，都是通过JVM内置的的标准C语言Profiler 接口收集数据，然后通过Profiler工具的客户端展现。也就是说各厂商的Profiler工具，都有两个部分，一个部分是Profiler Agent，和JVM绑定，负责收集JVM内部数据，譬如方法调用次数、耗费时间等；另外一个部分就是Profiler front-end。通过Profiler工具的自定义local或remote协议传输到front-end，其实，我们最常用的JavaIDE的debug功能就是在此基础上的（JPDA）。（JProfiler的截图<a href="http://www.ej-technologies.com/products/jprofiler/screenshots.html" target="_blank"><a href="http://www.ej-technologies.com/products/jprofiler/screenshots.html">http://www.ej-technologies.com/products/jprofiler/screenshots.html</a></a>）。
下面是Sun官方文档：
JDK1.42及以前是JVM PI：<a href="http://java.sun.com/j2se/1.4.2/docs/guide/jvmpi/jvmpi.html" target="_blank"><a href="http://java.sun.com/j2se/1.4.2/docs/guide/jvmpi/jvmpi.html">http://java.sun.com/j2se/1.4.2/docs/guide/jvmpi/jvmpi.html</a></a>
JDK1.5是JVM TI：<a href="http://java.sun.com/j2se/1.5.0/docs/guide/jvmti/jvmti.html" target="_blank"><a href="http://java.sun.com/j2se/1.5.0/docs/guide/jvmti/jvmti.html">http://java.sun.com/j2se/1.5.0/docs/guide/jvmti/jvmti.html</a></a>
具体到JProfiler的配置上，专门针对JDK1.4和1.5的JVM配置差别很大。
我用的JProfiler是4.31版本，透露给大家一个万能序列号吧(这东西不太好找)，对各版本应该都支持。深入了解Java，这类工具是不可少的：
Name: License for You
Lincese Code: A-G667/#42616F-10kg1r134fq9m/#2217
为了保证真实环境的检测成功，我做了大量的试验，譬如：
1、Windows系列的本地、远程测试。
2、AIX的远程测试。
3、Tomcat5.0、WebLogic8.14、WebSphere6.02，以及上述两种方式的组合测试，排列组合，场景不下10个。
当时也参阅了大量JVM文档，JProfiler官方几百页英文文档，辅助的JProbe对照。而且也制造过内存泄漏造成的OOM场景。
当然，要是在几个月前，在客户那边部署的测试环境时，就进行测试该多好啊。
在公司内部，我用 JProfiler测试了我们当时部署的几个应用，没有发现内存泄漏，所以，我们最怀疑的是就是CMS系统。因为出问题的那个WAS上它占去了90％的负荷（我们有多台AIX、WAS服务器）。该CMS超级庞大，感觉著名的赛迪网就用它，当时该CMS厂商给我们部署都花了快一个月。所以再重新部署一套测试环境也挺困难。另外，CMS提供商不给lisence。现在测试，客户早就对我们恼火了，当然不怎么配合，这对我们工作的开展就有很大的挑战。
在大致可以确定万无一失的情况下，我们最终决定在客户的真实环境下测试。也就是让JProfiler的agent端直接在WAS的JVM里面启动（北京IDC），然后远程（大连）监控。
本来该模式在另外几个应用的测试都通过了（因为北京IDC那边好几台AIX服务器）。但一部署上，客户的一些编辑用CMS时就感觉超级慢，尽管我们用了JProfiler的最小负载模式。半个小时后，客户实在无法忍受，打电话过来，又把我们部长和经理训了一顿，还要写书面报告。我们被迫马山中止测试，恢复现场。
虽然JProfiler也支持客户那边的环境，但还是有bug，至少负载一高就有严重的性能问题，几乎导致系统挂起，这是我当时没有料到的。JProfiler一启动，WAS的启动时间就由原来的3分钟降到10分钟，而且系统响应明显变慢，我们具体的环境如下（排列组合恐怕不下20种）：
1、AIX5.3，Power PC64位（不是32位）
2、WebSphere6.0
3、IBM JVM1.42
4、Remote 模式
我后来仔细读了一下JProfiler的changeLog，发现对上面的环境支持不够也很正常，因为官方在最近的4.3.x版本下陆续有对IBM JVM和Websphere6.0的features和bug fix：<a href="http://www.ej-technologies.com/download/jprofiler/changelog.html" target="_blank"><a href="http://www.ej-technologies.com/download/jprofiler/changelog.html">http://www.ej-technologies.com/download/jprofiler/changelog.html</a></a>
进行到这一步，我忽然觉得无计可施了 ，此时已经过了三周。
上面的策略，我认为是很正统的处理方法。谁怪我们当初项目上线时没有进行充分的测试呢？其实，这类测试没做也正常，OOM这类问题谁都无法预测。
到这个时候，我想肯定有人会问我？你知道导致JVM的OOM有几种情况吗？在当时，我想到了以下五种：
1、JVM的heap最小、最大值没有设，或不合理。
2、JVM的maxPermSize没有设置（这个IBM的JVM没有，一设置JVM就起不来）。
对于Sun和BEA的JVM，以上两种参数设置，可以排除90％以上的非程序内存溢出导致的OOM。
3、程序内存泄漏
4、有的JVM，当在80%的CPU时间内，不能GC出2%的heap时，也发生OOM（IBM的JVM就是，但我没有验证）
5、JVM本身内存泄漏（JVM有bug不是不可能）
现在的难题是，如果是那个可怕的CMS程序本身有内存溢出，在产品环境下，我们怎么去验证？我们自己开发的10来个web应用，测试并不是很难，在公司测试都可以。但是，我现在最想解决的，就是CMS测试的问题。而且，在我们那种环境下，该CMS产品供应商并没有透露成功案例。
其实，最后发现，并不是内存泄漏造成的，因为我们的heap走势都很平稳。纳闷的是，有1000M的heap，每次在heap只被占用400来M时就发生OOM，没有任何预兆。大家猜猜，会是什么原因 ？这个问题我到后面相关章节再说吧。
既然我们所有的矛头都指向那个可怕的CMS系统，现在就是考虑隔离的问题。如果我们验证这个问题是CMS造成的，那么大部分责任就应该由CMS厂商承担 。
既然CMS我们不敢移（费劲，而且客户在正式用），那我就移我们开发的10来个web系统吧。
<strong>三、移出除CMS系统以外的所有应用
</strong>说起来容易啊，做呢？ 隔离（移动）工作由我负责，具体涉及到10来个相关负责人。
转移工作，必须处理好很多问题，就说几个印象最深的吧：
1、某些应用，如Blog和BBS，都涉及到文件、图片上传目录和产品本身的环境，如 JDBC连接池、Cache位置。
2、目标服务器本身的环境，WAS安装环境、网络等。
3、移植时的先后顺序、调度，各应用内部本身的约束关系。
4、移植后的测试。
当然，还有一个最严峻的问题，客户允许我们这么做吗？对它们目前运行的系统有多大影响？风险如何评估？
这个工作持续了一天，已经完成了80％的工作，到第二天，客户又恼火了：WAS又宕机了。
为什么？这确实是WAS的一个bug：WAS的后台随便一操作，heap就会突然上升几百M，导致JVM内存不够。不过WAS撑住的话，过半小时后就会降下来，我估计是WAS后台对用户操作状态、文件都缓存到Session里面。你们可以检查类似这样的一个文件夹：d:\IBM\WebSphere\AppServer\profiles\AppSrv01\wstemp，我不知道为什么WAS不主动去清除它，它偷偷的就上升到几个G，系统硬盘可能不久就后就会空间不足，WAS莫名迟缓、最后死掉。听过WAS6.0以前这个目录更夸张。大家见我附件的截图WAS_Console.png那个尖峰。
咋办？经理也已经不敢让我们继续铤而走险了。这个方案最终又以失败告终 。
不过，最后我们还是发现问题出在CMS上。我们以前把这个问题向CMS技术支持反映，有大量依据和现象，并且把相关日志都给它们。过了两天，他们最后竟然只回了一句话“从给我的两个日志来看，没有找到任何与XXX有关的东西….”。TMD！我真的很生气 ，它们的产品都折磨我们半年之久了。不过，看他们对IBM的WAS和JVM也不懂，我也就不想再说什么了。下面是我的邮件，公司机密部分都隐去了：
引用
附件是我们这段时间服务器宕机的日志。我们用IBM Pattern Modeling and Analysis Tool for Java Garbage Collector Version 1.3.2分析了一下虚拟机日志，没有发现是内存泄漏导致；用IBM HeapAnalyzer Version 1.4.4 分析heap文件，也没有发现很可疑的内存泄漏。
我想以前你们也这样做过，现在我们分析错误日志，发现有一个现象，在宕机时，总是找不到文件，我看就是Websphere或是AIX IO资源不够，不知道是什么导致的。但是，我们自己的应用，基本上没有什么IO，除了一次load几个配置文件。不过，我觉得你们WCM的IO操作挺多的，不知道你对日志有什么新的发现。
客观的说，这几个月来，宕机那台服务器，除了你们的XXX，就以论坛和blog为主，而且他们都是开源的。在频繁宕机的06年11月份，我们的论坛和blog还没有上线。现在我们不得不每天晚上11点定时重启，但这也不是长久之计。
现在，我们进行分离遇到很大阻力，原来想把你们的XXX单独分离出来，在当前的环境下，不是很现实，如安装、测试（负载、定时服务），所以现在分离我们自己的应用，但当前在产品环境下，客户方阻力也很大。
希望尽快能够得到你们的问题建议和方案。
文中说到了IBM的两个分析工具，这也是我们后来的救星：我们就是需要这种离线分析工具，因为实时检测已经证明不现实。但我始终对该分析出来的结果抱怀疑态度，直到我去深入IBM的JVM以及和IBM的技术支持交流……
柳暗花明啊 ，至少看到了一点希望，不过最后我们还是失望而返。
<strong>四、用IBM的HeapAnalyzer和GarbageCollector检测</strong>
找到这两个工具，已经是够费劲了，因为以前找的IBM HeapRoot工具，让我对这类工具很失望。而且，这两个工具，只有在IBM的Techinical Support网站能够搜索到，但很不容易，因为那两个工具，并不是象IBM的Websphere产品那样宣传，它只在IBM Techinical Support文章的某些角落里出现。要知道，Techinical Support是IBM很重要的收入来源，这类文档，他们并不会让你很轻易就拿到，比起BEA WLS的支持网站dev2dev差远了。
具体诊断细节我就不详述了。我认为，IBM的WAS或JVM出了性能和OOM问题，这两个工具是最有效的，而且是离线分析工具，比起那些实时Profiler工具，某些场合有绝对的优势：譬如我们目前的产品环境，你只能分析宕机后的日志，实时分析前面已经验证是不可行的。
从日志分析，我们最终得出结论，我们购买的CMS系统有严重的碎片（大对象）问题，而该问题是OOM的罪魁祸首，而且IBM工程师也得出了同一结论。不过，在起先我们得出这一结论一周后，我还始终不相信heap碎片会导致OOM，直到IBM工程师总是向我强调。
我想很多人也是不太相信，因为大多数人用的都是Sun的JVM，譬如Windows、Solaris上的hotspot。而且，Sun JVM出问题，如果是配置的问题，一般通过配置heap最大最小值，以及maxPermSize都可以解决。Heap碎片导致的OOM，只有BEA的 JRockit和IBM JVM上发生，不过JRockit有专门文档说明，而且很容易找到（就在jdk的文档里面）。
配置heap最小最大值，我想大多数人都有经验。对于Sun的JVM来说，一般可以设置heap最大最小值一致，也是推荐的做法。因为它的GC策略默认是复制、分代算法。也就是说，它会将heap分成不同的几个区，譬如Solaris JVM中最上面有两个大小相等的区。GC时刻，将一个区的存活对象复制到另外一个对等区，垃圾对象就算遗弃了。这样在heap里面，就不存在碎片问题。另外，根据Java对象的存活期不同，将之转移到不同的区（Tenured区），存活最长的在最底部（火车算法），这也就是分代模型。具体请参考官方文档：<a href="http://java.sun.com/docs/hotspot/gc1.4.2/" target="_blank"><a href="http://java.sun.com/docs/hotspot/gc1.4.2/">http://java.sun.com/docs/hotspot/gc1.4.2/</a></a>
对于maxPermSize（Permanent Generation），主要和那些加载到JVM里面的Java Class对象相关，它的空间不是在Java Heap里面分配。如果你当前的heap有1000M，permSize是200M，那么JVM至少占用1200M。
在这个空间内的对象的生存期和JVM是一样的，譬如JDK的核心类库，它们被System Classloader加载到JVM的Method Area（方法区）后，就不会被GC掉的，这些对象一般是Class对象，而不是普通的实例对象，也就是JVM的元数据。我们在用反射时经常用到它们。所以，对于现在象Spring、Hibernate这些框架经常通过反射创建实例，可能对maxPermSize要求就大了，缺省的64M很多时候是不够的，特别是对于应用服务器里的应用，象JSP就会产生和加载很多classes。不过，如果是它导致的OOM，一般会有类似 perm size提示。
但是，对于IBM的JVM，情况就完全不一样。它的默认GC策略并没有采取复制、分代。这个可以从GC日志分析出来。它不像Sun的JVM那样，有个单独的方法区，它的方法区就放在Java Heap里面。JVM规范里面并没有要求方法区的必须存放的位置，因为它只是一个JVM实现问题。
在IBM的JVM里面，这些对象一般分配在称为k-cluster和p-cluster里（cluster又是属于Heap），而后者一般是临时在heap里面申请。并且，这些cluster是不能GC，或是被移动重排的（Compact过程）。这就导致Java Heap里面就如同马蜂窝，但不同的蜂孔又不能合并，于是，当我们程序里面产生一个大对象，譬如2M的数组(数组必须分配在连续的内存区)时，就没有可分配空间了，于是就报告OOM。这些不能被移动的cluster就称为所谓的碎片。此时，JVM的Heap利用率可能不到50%。
当然，通过一定时期的GC日志，可以计算出cluster的合理大小（专门在Java Heap的底部），另外，还可以为这些大对象专门分配大对象区的（超过64k的对象）。
通过上面的理论介绍，我想大家一定知道了为什么IBM的JVM里面不推荐heap的最大最小值相同，因为这样碎片问题会非常严重：如果我们每次大对象申请内存时，heap都扩展5%，譬如50M，碎片问题很大程度上可以避开，程序性能也高些（寻找可用空隙和分配耗时，以及每次GC时间拉长）。
以上的具体阐述，请参考我在上文推荐的几个URL，另外再推荐三个宝贵的链接：
<a href="http://www-1.ibm.com/support/docview.wss?rs=180&amp;context=SSEQTP&amp;q1=fragmentation&amp;uid=swg21176363&amp;loc=en_US&amp;cs=utf-8&amp;lang=en" target="_blank"><a href="http://www-1.ibm.com/support/docview.wss?rs=180&amp;context=SSEQTP&amp;q1=fragmentation&amp;uid=swg21176363&amp;loc=en_US&amp;cs=utf-8&amp;lang=en">http://www-1.ibm.com/support/docview.wss?rs=180&amp;context=SSEQTP&amp;q1=fragmentation&amp;uid=swg21176363&amp;loc=en_US&amp;cs=utf-8&amp;lang=en</a></a>
<a href="http://www-900.ibm.com/cn/support/viewdoc/detail?DocId=2447476A10000" target="_blank"><a href="http://www-900.ibm.com/cn/support/viewdoc/detail?DocId=2447476A10000">http://www-900.ibm.com/cn/support/viewdoc/detail?DocId=2447476A10000</a></a>（IBM 技术支持告诉我的，太重要了！）
<a href="http://www-900.ibm.com/cn/support/viewdoc/detail?DocId=2847476B08000" target="_blank"><a href="http://www-900.ibm.com/cn/support/viewdoc/detail?DocId=2847476B08000">http://www-900.ibm.com/cn/support/viewdoc/detail?DocId=2847476B08000</a></a>
我想大家应该会问：我怎么能够肯定我的OOM问题是heap碎片造成的呢？下面的方法可以验证。
在OOM发生时，JVM会产生一个heapdump文件。然后用GarbageCollector分析出该OOM发生时刻，JVM去申请的空间，譬如约235k。此时，你再用HeapAnalyzer去分析此时的heap快照里面的gap size大小（空隙大小）和各自的可用数目。你会发现，大于235k的空隙个数为0。这就是碎片导致OOM的证据。
另外，有人会问：我怀疑我的OOM是因为程序内存泄漏造成的，怎么去验证？
你可以用HeapAnalyzer分析发生OOM时刻的heap快照，工具会罗列出哪些对象怀疑有内存泄漏，譬如Cache对象都非常大（但你可以确定它不是内存泄漏）。另外，分析这次宕机（从这次虚拟机启动到宕机这段时间）的heap走势，如果曲线明显是向上倾斜，也就是那种典型的内存泄漏图，就有可能是内存泄漏。当然，还必须结合heap快照。
内存持续上升在JVM开始一段时间很正常，因为JVM对第一次访问到的Class 对象，譬如一个典型的Web应用，就有jdk的class、Spring或Hibernate的class对象，它们都会被缓存下来 (ClassLoader原理)，一般均不会被GC。当大多数class对象缓存差不多（当然还可能有一些Singleton对象，不过不怎么占分量），JVM的Heap就平稳了，呈一水平波浪或锯齿线。
如果可以用JProfiler这类工具实时监控，就更容易确诊了。
经过一番周折，我们终于看到了一线希望了 。
在一定的准备后，我们决定对WAS进行性能调优了。WAS的调优参数，可以分为两个部分：JVM级别和WAS级别：
JVM：主要是GC和Heap。
WAS：Thread Pool，JDBC DataSource。
当然要调节，你需要明白你的目标是什么，调节依据是什么，怎么计算，绝对不是凭空想象的，譬如heap最小值1024M，日志证明，该参数非常不适合我们的环境。具体细节，留给后文吧。
战战兢兢地，中午12:00，我们给产品环境下的WAS调节参数、重启，同时优化了AIX的IO相关参数。
我试着设置了一下JVM的k-cluster和p-cluster。下午15:00左右，WAS挂了，AIX也挂了。这下麻烦可大了。我们都慌了，马山客户的老总就来电话了，一阵哗哗啦啦。实在无奈，让客户那边工作人员通知机房（服务器托管处）工作人员重启AIX。我也不得不强行更改刚才的参数，立即设为另外一个值。
其实，我把那个两个cluster值确实设置太大了，我把它们设置为推荐值的5倍，譬如p-cluster是65k×110%×5。另外一个愚蠢的设置就是把最小heap设置为2048M(AIX有4G内存)。
后来我恢复到约正常的值，也就是去掉那个cluster的5，另外分配了一个30%的大对象区（如果1000M的heap，就是700M＋300M）。
就这样，系统持续正常运行了三天，以前可是一天一down。当在三天后再次宕机时，我们都没有自信了 。不得不通过AIX的cron，继续每天深夜11点的WAS定时重启。
不过，那次宕机，包括以后的几次宕机，再也没有出现OOM错误了，但系统依然不稳定。虽然我可以说OOM问题解决了，但领导和客户需要的并不是这种结果。
其实，在这个时候，我们已经发现我们系统的四大问题：
1、WAS和JVM参数：OOM问题
2、AIX的IO和Paging Spacing不足：AIX日志后来显示错误
3、AIX的WAS分区空间不够：WAS的日志膨胀一周就把那个opt分区塞满了。
4、应用程序的JDBC连接池：我们20来个应用，一个20 connections，DB2数据库有时被撑死。
也就是说，我们最初在客户那儿部署时，用的默认值根本不行。而且，部署涉及多人，人员之间出现断层。如果我们只是按OOM，无疑是走入死胡同，必须全局考虑！
但是，项目组实力薄弱，公司范围内就没有对AIX精通的。不过项目组原来有一个搞银行系统，在AIX下开发，就他熟悉些。我当时对AIX也比较陌生，你们从Linux转到AIX，你就知道它有多别扭了。命令都自定一套（也许因为是Unix元老吧），那个shell也超级别扭，而且参考书特少。不是自诩，我两年前负责一个高负载的Linux服务器管理一年多，也是玩得很转的。
就这样，他负责AIX的相关问题，我负责WAS相关的。
但是，现实环境，已经不允许我们再试验下去了 。我们必须找到一条绝对可靠的对策！
这就是下文的CMS系统大迁移，服务器再次优化。
<strong>五、隔离CMS系统，服务器优化</strong>
从前面的介绍，大家应该记得，我们开始是固定CMS，分离其它应用，但遭遇失败。现在是反过来，干脆把CMS系统赶出WAS平台 。
说实话，项目经理做这个决定，我认为已经是鼓出很大勇气了 。
当时我们想在一个备用AIX机上安装CMS产品测试，但最后还是没有做成：
CMS这类文章发布系统很难安装，也不好测试，又没有liscence，而且还有一堆准备工作。绝对没有著名的openCMS安装那么简单，当然功能远远比它复杂。而且，我们当时也低估了后来的工作，总觉得问题好解决。
在很遥远的06年中期，CMS厂商在客户那边一台AIX的Tomcat上部署了一套CMS产品。但当时客户执意要求将其跑在WAS上，也就是现在的情况。最开始，客户还要求我们必须用WAS的集群(我们买的就是WAS的ND版)，无奈该CMS不支持。要是集群，又是死伤一遍。其实，现在想想，我们当时太被动，CMS这种东西，就供公司的几十个编辑用，一个普通Tomcat就完全够用。而且，把它和面向公网的Internet应用混在一起，完全没有必要。也许，被动是因为我的实力造成的。
我们决定背水一战时，已经做过周密的计划：某年某月某日晚上8:00……
CMS产品负责人现场切换
xx（我）负责WAS相关参数调整
yy负责AIX参数。
zz负责应用的测试
…..
总之，该行动涉及到客户方、产品提供商、公司高层、项目组。每个人都密切关注，不下20人。每个人都守在电脑前，随时听候调遣，当天晚上，我们都没有准备回家睡觉，大家齐心协力。
真没想到，整个式切换工作，一个小时就顺利完成 ！第二天，客户编辑打开浏览器，她们一定想不到昨晚大家准备经历一场厮杀….
系统持续平稳地运行了一周，然后是漫长的五一，我回湖北黄冈老家休息了八天。回来时，一切依旧。
当天晚上，我们这边主要做了两项工作：
1、JVM的Heap参数，共五个。
2、AIX的IO、Paging Space等共六个。
当然还有其他人的工作，譬如测试、监控。
还有一个非常重要的方面：JDBC连接池。我们原来是在每个Web应用里面独立设置，这样20来个应用就有几百个DB连接，一不小心DB就给撑死。现在统一交由WAS内置DataSource处理，总共连接不到30个。其实，我们项目开始部署时，就是这样做的，但当时WAS内置的DataSource对JTA(XA)支持有bug （这个和IBM技术支持确认过，但他们没有给予很好的解决方案），不过Datasource还是配好的。
但是这个工作已经属于WAS性能优化的主题了，而且优化值必须持续观察一段时间，通过专门的分析工具来计算。
优化本身，是一项很考验人的工作，我就简单说一下最实用方法吧，也许是专门针对IBM的产品。
1、清理归零WAS日志。然后启动WAS，生成日志（-verbose:gc默认是开的）
2、让WAS持续运行约两周，让JVM Heap占用曲线平稳一段时间即可（用IBM的Garbage Collector分析观察）。
3、在AIX的shell里，产生heapdump.phd文件，也就是heap快照。命令：kill -3 pid (pid是WAS的PID，通过ps –ef查看)，观察heap当时的碎片情况，是否需要单独分大对象区（一般不需要设置），特别是那个方法区Class对象大小（p-cluster参数）。
4、通过GC工具，观察GC平均时间、Heap实际占用情况。Note: GC是一个Stop The World过程，也就是说GC时系统对外不响应，多CPU也不例外。看你的应用实际需求了，GC持续时间和频率是矛盾的，另外还有性能考虑。一般Web应用，我想让GC持续时间（Pause time）调节到合理值就ok了，譬如0.2到0.4s。
5、根据3可以算出k-cluster值，它是工具推荐值的110%。
6、Heap的最小值是程序刚启动不久的占用值，譬如320M。切记：IBM JVM初始值太大非常不好。
7、Heap的最大值是系统平稳后的100/70。也就是说如果最大值是1000M，那么应该平稳时是700M，还有30%的空余。IBM的JVM默认情下的碎片问题，WAS控制台下操作Heap猛增这种bug，你不得不堤防。Heap最大值不设，AIX下的WAS肯定OOM。
当然啦，我没有考虑到大对象区的计算（虽然我们的应用设置了专门的大对象区），包括IBM JVM支持的分代GC、并行GC，Heap每次expand百分比等。那些情况我们一般不常用，譬如，你的AIX平台一般不是16CPU吧？
一口气写到现在，我忽然觉得该收尾了。下面就说说我对这类工作的整体看法吧。
1、尽量在项目测试和试运行的时候就进行压力、性能测试，当正式投入使用后，如果发现类似问题，代价非常大。躲过算你运气好，一般来说，可能你们系统没多少人用，也不是核心业务系统，譬如一般的电子政务。
2、千万不要低估了技术风险，用IBM的系列产品尤其要慎重，出问题一定不要忘了技术支持。而且，查资料时，建议用google English，因为象WebSphere这类问题，很少有中文资料。
3、程序部署环境建立时，就要考虑到日后的正式环境，譬如AIX的Paging Space、IO、分区大小，默认值往往是不行的，而且在产品环境下改这些值，往往非常难。
4、在项目开发初期，就考虑到日志的问题，因为它分散到每个方法内，必须慎重定义好debug、info、warn、error级别，不要随便忽视异常（catch里面不记录），到真正程序出问题时，它就是我们的最重要的依据之一。当然这主要是功能性问题诊断。另外对于高负载网站，日志文件往往非常大，各级别日志千万不要混在一起，否则找问题就很困难了。
5、怎么说呢，别死扣技术，以为什么都可以通过技术解决。你看我们最大的问题就是把CMS给移到Tomcat下。你要是问我，为什么CMS产品会导致系统这么多的问题，我也不知道，到那时候，我确实也不想深入。我只要知道，赶出你这个应用，我的系统就好控制多了。而且，那个CMS系统，在Tomcat下，就是跑得服服帖帖的，非常稳定。难度是可恶的WAS？不过那CMS，据IBM工程师，包括我们二次开发，都觉得够烂了，每个jsp页面都打开、关闭DB connection（7年前的jsp开发模式），还有那么严重的大对象问题。
好了，以上总结的几点可能也不充分、深入，但如果你仔细读我这篇文章，应该有自己的想法。毕竟，只有经过思考的东西，才会属于自己。
————————————————-
<strong>原文仅存的一点回复（google快照）</strong>
也许有人会说，我看完全文，发现你们遇到的问题还是很基础啊。现在想想，也确实如此。不过，当时确实没有方向。另外，一个人不太可能有这么全面的知识。其实，最难的，还是那个IBM JVM的heap碎片问题，关键是你想不到，网上又很难搜到资料。大家要是用它后，出现OOM问题，一定要前车之鉴啊！
newold 写道
我感觉WAS调优没那么难吧,你们应该在测试系统上做下压力测试,不应该在生产系统上这么折腾.解决这种问题,首先考虑把WAS升级到最新版,然后再考虑是不是程序问题.如果WAS是正版的,IBM应该会帮你们分析日志的,我觉得你解决问题的方式不大对，把事情搞复杂了
1、我接手这个活的时候，系统已经在生产环境几个月了，这是我无法选择的。当初准备切换到正式环境时，没有人对这个问题引起重视，特别是领导，而且我当时也不在该小组。再说，谁会怀疑那个大名鼎鼎的CMS产品，中国恐怕是top 1。
2、把WAS升级到最新版是我在接手这个活的时候已经做了（6.0.0.0到6.0.2.0），所以文中我没有提及。另外，在诊断过程中也准备升级一次（从6.0.2.0到6.0.2.17），但考虑生产环境，风险太大。不过，我当时确实也总怀疑是否是这个原因，仔细读了读官方的bugfix（估计有几千个）。
3、“IBM应该会帮你们分析日志的”，当然了。当我去向IBM技术支持咨询时，他们向我要日志。不过，他们和我对日志的分析结果是一样的，只是他们让我更肯定了某些东西。主要就是文中那几个截图中的工具。另外，就是SystemOut.log日志（看是否有线程挂起）。
不过，对于IBM的技术支持，有点让人失望的是，我们解决了OOM后，但我们的系统还是不稳定，再向他们咨询时，那个WAS技术支持告诉我，他只提供IBM的WAS相关技术支持，如果你们告诉我WebLogic AS下很正常，我无法给你提供帮助，我们对其它公司的类似产品不了解。另外，如果你们怀疑是我们的AIX产品有问题，请咨询我们的AIX技术支持（当前前提是我们的AIX还在服务期，对于那个WAS的售后服务，我们是用公司另外一个项目组的license，因为我们的已经过期了）。
也就是说，IBM无法给你提供全局的技术支持！
4、一开始，我们根本就没有方向，应用系统又多（两个WAS上共30多个应用）。你仔细读文章也会知道，我们的现象和推测往往都是矛盾的。
什么东西，都是解决了，经历过了，再回转头来说，好简单啊，当初我怎么没想到？就像中国股市，要是两年前我都能够预测了现在，我早就暴发了。
而且，直到现在，我都可以坦率得说，不把那个CMS移出WAS，无论我们怎么优化AIX、WAS和JVM，都很难解决问题！
分享到： <a href="&quot;分享到新浪微博&quot;"><img src="" alt=""></a> <a href="&quot;分享到腾讯微博&quot;"><img src="" alt=""></a></p>
<p><a href="http://zwchen.iteye.com/blog/552019" title="回母校，用iPhone拍的几张照片" target="_blank">回母校，用iPhone拍的几张照片</a> | <a href="http://zwchen.iteye.com/blog/551930" title="又半年，技术的探险(2009.7)" target="_blank">又半年，技术的探险(2009.7)</a></p>
<ul>
<li>2009-12-19 11:07</li>
<li>浏览 3762</li>
<li><a href="">评论(5)</a></li>
<li>分类:<a href="http://www.iteye.com/blogs/category/architecture" target="_blank">企业架构</a></li>
<li><a href="http://www.iteye.com/wiki/blog/551933" target="_blank">相关推荐</a></li>
</ul>
<h3 id="-">评论</h3>
<p><a href=""></a></p>
<p>5 楼 <a href="http://txyly998.iteye.com/" title="txyly998" target="_blank">txyly998</a> 2011-08-05  </p>
<p>呵呵 谢谢你，我google下吧。
我们的系统就是数据量太大才导致性能问题频发的，最大的局点有一千几百万用户、一千几百万订购关系等等。
4 楼 <a href="http://zwchen.iteye.com/" title="zwchen" target="_blank">zwchen</a> 2011-08-05  </p>
<p>txyly998 写道</p>
<p>现在就想问你一下，你说的按通用的JVM设置方式调整参数，这个有没有具体点的步骤呢？
google Tomcat的一般参数设置方法，或是选择WAS一般的调优参数。
像你们这种政务系统，一般是因为加个WAS，项目合同可以翻倍，和WAS无关。而且，你们的负载应该是超低的(员工用)。
对于非分布式应用（无RMI、EJB），WAS就是垃圾。
我隐约记得(好几年没关注了)，IBM的JVM的GC和sun的不一样，所以最大和最小的heap可能是设置不同的。</p>
<p>3 楼 <a href="http://txyly998.iteye.com/" title="txyly998" target="_blank">txyly998</a> 2011-08-04  </p>
<p>首先非常感谢你的回复！谢谢！
我们的这个系统在全国有13个局点在用，有些局点基本没怎么出现（在我接触这个1年多的时间内），有些局点则1个月出现一两次，项目组都没多少人懂这类的问题，可能也没有引起足够的重视，最近出现的局点越来越多，而我是在公司支持现网的，现网有问题直接联系我这边，所以想自己试着解决，目前感觉有点无从下手。
对于你说的两周重启一次，这个不行的，现场没事不能随便重启环境的，有特殊情况要重启环境必须要向客户申请。另外，出现问题后，watchdog会自动重启系统或者切换双机的。出现重启或者切换，现场的人就要我们分析原因的。
现在就想问你一下，你说的按通用的JVM设置方式调整参数，这个有没有具体点的步骤呢？
2 楼 <a href="http://zwchen.iteye.com/" title="zwchen" target="_blank">zwchen</a> 2011-08-04  </p>
<p>txyly998 写道</p>
<p>我们一个系统down掉了，生成了javacore和heapdump文件，有IBM Thread and Monitor Dump Analyzer for Java和IBM HeapAnalyzer工具，但是不知道怎么分析这俩文件，能否指教下呢？多谢！
操作系统AIX5.3
JDK 1.5
华为的uniportal平台（Tomcat和Jboss结合到一起的）
如果只是down一次，没有出现规律性的宕机，比如一周一次，暂时不用太考虑，因为你的数据积累不够。
你可以：
1、如果系统一个月宕一两次，你可以两周重启一下服务
2、按通用的JVM设置方式，调整参数
我不太建议直接去分析headdump等问题，它必须对各种JVM的GC有很深入的了解，我当时也是自学过一两个月，摸索着调成功的概率非常低。
如果你们的WAS还在技术支持范围内，咨询IBM北京。
自己去解决这种极其有难度的问题，从公司的角度是很不值的。</p>
<p>1 楼 <a href="http://txyly998.iteye.com/" title="txyly998" target="_blank">txyly998</a> 2011-08-02  </p>
<p>我们一个系统down掉了，生成了javacore和heapdump文件，有IBM Thread and Monitor Dump Analyzer for Java和IBM HeapAnalyzer工具，但是不知道怎么分析这俩文件，能否指教下呢？多谢！
操作系统AIX5.3
JDK 1.5
华为的uniportal平台（Tomcat和Jboss结合到一起的）</p>
<h3 id="-">发表评论</h3>
<p><a href="http://zwchen.iteye.com/login" target="_blank"><img src="" alt=""></a><a href="http://zwchen.iteye.com/login" target="_blank">您还没有登录,请您登录后再发表评论</a></p>
<p><a href="http://zwchen.iteye.com/" target="_blank"><img src="&quot;zwchen的博客: zwchen的博客&quot;" alt="zwchen的博客"></a></p>
<p>zwchen</p>
<ul>
<li>浏览: 411240 次</li>
<li>性别: <img src="&quot;男&quot;" alt="Icon_minigender_1"></li>
<li>来自: 成都</li>
<li><img src="" alt=""><h3 id="-http-zwchen-iteye-com-blog-user_visits-">最近访客 <a href="http://zwchen.iteye.com/blog/user_visits" target="_blank">更多访客&gt;&gt;</a></h3>
</li>
</ul>
<p><a href="http://dylinshi126.iteye.com/" target="_blank"><img src="&quot;dylinshi126的博客: &quot;" alt="dylinshi126的博客"></a></p>
<p><a href="http://dylinshi126.iteye.com/" title="dylinshi126" target="_blank">dylinshi126</a></p>
<p><a href="http://kglgmlldd.iteye.com/" target="_blank"><img src="&quot;kglgmlldd的博客: kglgmlldd&quot;" alt="kglgmlldd的博客"></a></p>
<p><a href="http://kglgmlldd.iteye.com/" title="kglgmlldd" target="_blank">kglgmlldd</a>
<a href="http://frfgzzq.iteye.com/" target="_blank"><img src="&quot;frfgzzq的博客: &quot;" alt="frfgzzq的博客"></a></p>
<p><a href="http://frfgzzq.iteye.com/" title="frfgzzq" target="_blank">frfgzzq</a></p>
<p><a href="http://sungang-1120.iteye.com/" target="_blank"><img src="&quot;sungang_1120的博客: 50&quot;" alt="sungang_1120的博客"></a></p>
<p><a href="http://sungang-1120.iteye.com/" title="sungang_1120" target="_blank">sungang_1120</a></p>
<h3 id="-">文章分类</h3>
<ul>
<li><a href="http://zwchen.iteye.com/" target="_blank">全部博客 (113)</a></li>
<li><a href="http://zwchen.iteye.com/category/9634" target="_blank">IT技术 (25)</a></li>
<li><a href="http://zwchen.iteye.com/category/107180" target="_blank">互联网和电子商务 (13)</a></li>
<li><a href="http://zwchen.iteye.com/category/24390" target="_blank">杂谈 (24)</a></li>
<li><a href="http://zwchen.iteye.com/category/39194" target="_blank">管理和商业 (23)</a></li>
<li><p><a href="http://zwchen.iteye.com/category/12717" target="_blank">我的生活 (28)</a></p>
<h3 id="-">社区版块</h3>
</li>
<li><p><a href="http://zwchen.iteye.com/blog/news" target="_blank">我的资讯</a> (0)</p>
</li>
<li><a href="http://zwchen.iteye.com/blog/post" target="_blank">我的论坛</a> (547)</li>
<li><a href="http://zwchen.iteye.com/blog/answered_problems" target="_blank">我的问答</a> (0)</li>
</ul>
<h3 id="-">存档分类</h3>
<ul>
<li><a href="http://zwchen.iteye.com/blog/monthblog/2013-07" target="_blank">2013-07</a> (1)</li>
<li><a href="http://zwchen.iteye.com/blog/monthblog/2012-11" target="_blank">2012-11</a> (1)</li>
<li><a href="http://zwchen.iteye.com/blog/monthblog/2012-10" target="_blank">2012-10</a> (1)</li>
<li><p><a href="http://zwchen.iteye.com/blog/monthblog_more" target="_blank">更多存档...</a></p>
<h3 id="-">评论排行榜</h3>
</li>
<li><p><a href="http://zwchen.iteye.com/blog/1912647" title="长江三峡游轮之旅(宜昌到重庆)" target="_blank">长江三峡游轮之旅(宜昌到重庆)</a></p>
</li>
<li><a href="http://zwchen.iteye.com/blog/1717111" title="四川燕子沟-雅加格-四姑娘山-巴郎山自驾游" target="_blank">四川燕子沟-雅加格-四姑娘山-巴郎山自驾 ...</a></li>
</ul>
<h3 id="-">最新评论</h3>
<ul>
<li><a href="http://yangfuchao418.iteye.com/" title="yangfuchao418" target="_blank">yangfuchao418</a>： zwchen 写道yangfuchao418 写道不错，只是那 ...
<a href="http://zwchen.iteye.com/blog/1912647#bc2320017" target="_blank">长江三峡游轮之旅(宜昌到重庆)</a></li>
<li><a href="http://zwchen.iteye.com/" title="zwchen" target="_blank">zwchen</a>： yangfuchao418 写道不错，只是那水怎么这么脏，总共 ...
<a href="http://zwchen.iteye.com/blog/1912647#bc2319980" target="_blank">长江三峡游轮之旅(宜昌到重庆)</a></li>
<li><a href="http://zwchen.iteye.com/" title="zwchen" target="_blank">zwchen</a>： yangfuchao418 写道不错，只是那水怎么这么脏，总共 ...
<a href="http://zwchen.iteye.com/blog/1912647#bc2319978" target="_blank">长江三峡游轮之旅(宜昌到重庆)</a></li>
<li><a href="http://yangfuchao418.iteye.com/" title="yangfuchao418" target="_blank">yangfuchao418</a>： 不错，只是那水怎么这么脏，总共花了多少银子？
<a href="http://zwchen.iteye.com/blog/1912647#bc2319921" target="_blank">长江三峡游轮之旅(宜昌到重庆)</a></li>
<li><a href="http://fqsheng.iteye.com/" title="shengfuqiang" target="_blank">shengfuqiang</a>： 每天读你的博客都有收获，都能给我带来不一样的心得。
<a href="http://zwchen.iteye.com/blog/1337350#bc2318900" target="_blank">我的2011</a>
声明：ITeye文章版权属于作者，受法律保护。没有作者书面许可不得转载。若作者同意转载，必须以超链接形式标明文章原始出处和作者。
© 2003-2012 ITeye.com. All rights reserved. [ 京ICP证110151号 京公网安备110105010620 ]
<img src="http://stat.iteye.com/?url=http%3A%2F%2Fzwchen.iteye.com%2Fblog%2F551933&amp;referrer=http%3A%2F%2Fzwchen.iteye.com%2Fcategory%2F9634&amp;user_id=" alt=""></li>
</ul>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li></span><span class="breadcrumb"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li><li><a href="/categories/Java&J2EE/JVM/">JVM</a></li></span></span> | <span class="tags">Tagged <a href="/tags/JVM/" class="label label-primary">JVM</a><a href="/tags/Java&J2EE/" class="label label-success">Java&J2EE</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:42"datetime="2014-03-07 09:54:42"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-JVM--IBMWebSphereApplicationServer诊断和调优07年写的-原Java/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JavaJ2EE-JVM--IBMWebSphereApplicationServer诊断和调优07年写的-原Java" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--通过Java-JMX得到fullGC次数？-高级语言虚拟机/">通过Java</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:42.000Z"> <a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--通过Java-JMX得到fullGC次数？-高级语言虚拟机/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="-java-jmx-full-gc-">通过Java/JMX得到full GC次数？ - 高级语言虚拟机</h1>
<p><a href="http://hllvm.group.iteye.com/login" title="登录" target="_blank">您还未登录 !</a> <a href="http://hllvm.group.iteye.com/login" target="_blank">登录</a> <a href="http://hllvm.group.iteye.com/signup" target="_blank">注册</a></p>
<p><a href="http://www.iteye.com/" target="_blank"><img src="&quot;ITeye-最棒的软件开发交流社区&quot;" alt="ITeye3.0"></a></p>
<p><a href=""></a></p>
<p><a href="http://www.iteye.com/groups" target="_blank">群组首页</a> → <a href="http://hllvm.group.iteye.com/groups/category/language" target="_blank">编程语言</a> → <a href="http://hllvm.group.iteye.com/" target="_blank">高级语言虚拟机</a> → <a href="http://hllvm.group.iteye.com/group/wiki" target="_blank">知识库</a> → <a href="http://hllvm.group.iteye.com/group/wiki?category_id=315" target="_blank">JVM实战</a> → <a href="">通过Java/JMX得到full GC次数？</a>
原创作者: <a href="http://www.javaeye.com/topic/790015" target="_blank">RednaxelaFX</a>   阅读:2261次   评论:1条   更新时间:2011-05-26    </p>
<p>今天有个同事问如何能通过<a href="http://java.sun.com/javase/technologies/core/mntr-mgmt/javamanagement/" target="_blank">JMX</a>获取到某个Java进程的full GC次数：
引用</p>
<p>hi,问个问题，怎们在java中获取到full gc的次数呢？
我现在用jmx的那个得到了gc次数，不过不能细化出来full gc的次数
Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>for (final GarbageCollectorMXBean garbageCollector  </li>
<li>: ManagementFactory.getGarbageCollectorMXBeans()) {  </li>
<li>gcCounts += garbageCollector.getCollectionCount();  </li>
<li><p>}<br>for (final GarbageCollectorMXBean garbageCollector : ManagementFactory.getGarbageCollectorMXBeans()) { gcCounts += garbageCollector.getCollectionCount(); }
你比如我现在是这样拿次数的
我回答说因为full GC概念只有在分代式GC的上下文中才存在，而JVM并不强制要求GC使用分代式实现，所以JMX提供的标准<a href="http://download-llnw.oracle.com/javase/6/docs/technotes/guides/management/mxbeans.html" target="_blank">MXBean</a> API里不提供“full GC次数”这样的方法也正常。
既然“full GC”本来就是非常平台相关的概念，那就hack一点，用平台相关的代码来解决问题好了。这些GC的MXBean都是有名字的，而主流的JVM的GC名字相对稳定，非要通过JMX得到full GC次数的话，用名字来判断一下就好了。
举个例子来看看。通过JDK 6自带的<a href="http://download-llnw.oracle.com/javase/6/docs/technotes/guides/management/jconsole.html" target="_blank">JConsole</a>工具来查看相关的MXBean的话，可以看到，
GC的MXBean在这个位置：
<img src="&quot;点击查看原始大小图片&quot;" alt="">
这个例子是用server模式启动JConsole的，使用的是ParallelScavenge GC，它的年老代对应的收集器在这里：
<img src="&quot;点击查看原始大小图片&quot;" alt="">
该收集器的总收集次数在此，这也就是full GC的次数：
<img src="&quot;点击查看原始大小图片&quot;" alt="">
于是只要知道我们用的JVM提供的GC MXBean的名字与分代的关系，就可以知道full GC的次数了。
Java代码写起来冗长，这帖就不用Java来写例子了，反正API是一样的，意思能表达清楚就OK。
用一个<a href="http://groovy.codehaus.org/" target="_blank">Groovy</a>脚本简单演示一下适用于Oracle (Sun) HotSpot与Oracle (BEA) JRockit的GC统计程序：
Groovy代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>import java.lang.management.ManagementFactory  </p>
</li>
<li></li>
<li>printGCStats = {  </li>
<li>def youngGenCollectorNames = [  </li>
<li>// Oracle (Sun) HotSpot  </li>
<li>// -XX:+UseSerialGC  </li>
<li>&#39;Copy&#39;,  </li>
<li>// -XX:+UseParNewGC  </li>
<li>&#39;ParNew&#39;,  </li>
<li>// -XX:+UseParallelGC  </li>
<li>&#39;PS Scavenge&#39;,  </li>
<li></li>
<li>// Oracle (BEA) JRockit  </li>
<li>// -XgcPrio:pausetime  </li>
<li>&#39;Garbage collection optimized for short pausetimes Young Collector&#39;,  </li>
<li>// -XgcPrio:throughput  </li>
<li>&#39;Garbage collection optimized for throughput Young Collector&#39;,  </li>
<li>// -XgcPrio:deterministic  </li>
<li>&#39;Garbage collection optimized for deterministic pausetimes Young Collector&#39;  </li>
<li>]  </li>
<li></li>
<li>def oldGenCollectorNames = [  </li>
<li>// Oracle (Sun) HotSpot  </li>
<li>// -XX:+UseSerialGC  </li>
<li>&#39;MarkSweepCompact&#39;,  </li>
<li>// -XX:+UseParallelGC and (-XX:+UseParallelOldGC or -XX:+UseParallelOldGCCompacting)  </li>
<li>&#39;PS MarkSweep&#39;,  </li>
<li>// -XX:+UseConcMarkSweepGC  </li>
<li>&#39;ConcurrentMarkSweep&#39;,  </li>
<li></li>
<li>// Oracle (BEA) JRockit  </li>
<li>// -XgcPrio:pausetime  </li>
<li>&#39;Garbage collection optimized for short pausetimes Old Collector&#39;,  </li>
<li>// -XgcPrio:throughput  </li>
<li>&#39;Garbage collection optimized for throughput Old Collector&#39;,  </li>
<li>// -XgcPrio:deterministic  </li>
<li>&#39;Garbage collection optimized for deterministic pausetimes Old Collector&#39;  </li>
<li>]  </li>
<li></li>
<li>R: {  </li>
<li>ManagementFactory.garbageCollectorMXBeans.each {  </li>
<li>def name  = it.name  </li>
<li>def count = it.collectionCount  </li>
<li>def gcType;  </li>
<li>switch (name) {  </li>
<li>case youngGenCollectorNames:  </li>
<li>gcType = &#39;Minor Collection&#39;  </li>
<li>break  </li>
<li>case oldGenCollectorNames:  </li>
<li>gcType = &#39;Major Collection&#39;  </li>
<li>break  </li>
<li>default:  </li>
<li>gcType = &#39;Unknown Collection Type&#39;  </li>
<li>break  </li>
<li>}  </li>
<li>println &quot;$count &lt;- $gcType: $name&quot;  </li>
<li>}  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li><p>printGCStats()<br>import java.lang.management.ManagementFactory printGCStats = { def youngGenCollectorNames = [ // Oracle (Sun) HotSpot // -XX:+UseSerialGC &#39;Copy&#39;, // -XX:+UseParNewGC &#39;ParNew&#39;, // -XX:+UseParallelGC &#39;PS Scavenge&#39;, // Oracle (BEA) JRockit // -XgcPrio:pausetime &#39;Garbage collection optimized for short pausetimes Young Collector&#39;, // -XgcPrio:throughput &#39;Garbage collection optimized for throughput Young Collector&#39;, // -XgcPrio:deterministic &#39;Garbage collection optimized for deterministic pausetimes Young Collector&#39; ] def oldGenCollectorNames = [ // Oracle (Sun) HotSpot // -XX:+UseSerialGC &#39;MarkSweepCompact&#39;, // -XX:+UseParallelGC and (-XX:+UseParallelOldGC or -XX:+UseParallelOldGCCompacting) &#39;PS MarkSweep&#39;, // -XX:+UseConcMarkSweepGC &#39;ConcurrentMarkSweep&#39;, // Oracle (BEA) JRockit // -XgcPrio:pausetime &#39;Garbage collection optimized for short pausetimes Old Collector&#39;, // -XgcPrio:throughput &#39;Garbage collection optimized for throughput Old Collector&#39;, // -XgcPrio:deterministic &#39;Garbage collection optimized for deterministic pausetimes Old Collector&#39; ] R: { ManagementFactory.garbageCollectorMXBeans.each { def name = it.name def count = it.collectionCount def gcType; switch (name) { case youngGenCollectorNames: gcType = &#39;Minor Collection&#39; break case oldGenCollectorNames: gcType = &#39;Major Collection&#39; break default: gcType = &#39;Unknown Collection Type&#39; break } println &quot;$count &lt;- $gcType: $name&quot; } } } printGCStats()
执行可以看到类似这样的输出：
Command prompt代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>5 &lt;- Minor Collection: Copy  </p>
</li>
<li><p>0 &lt;- Major Collection: MarkSweepCompact<br>5 &lt;- Minor Collection: Copy 0 &lt;- Major Collection: MarkSweepCompact
↑这是用client模式的HotSpot执行得到的；
Command prompt代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>0 &lt;- Minor Collection: Garbage collection optimized for throughput Young Collector  </p>
</li>
<li><p>0 &lt;- Major Collection: Garbage collection optimized for throughput Old Collector<br>0 &lt;- Minor Collection: Garbage collection optimized for throughput Young Collector 0 &lt;- Major Collection: Garbage collection optimized for throughput Old Collector
↑这是用JRockit R28在32位Windows上的默认模式得到的。
通过上述方法，要包装起来方便以后使用的话也很简单，例如下面Groovy程序：
Groovy代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>import java.lang.management.ManagementFactory  </p>
</li>
<li></li>
<li>class GCStats {  </li>
<li>static final List<String> YoungGenCollectorNames = [  </li>
<li>// Oracle (Sun) HotSpot  </li>
<li>// -XX:+UseSerialGC  </li>
<li>&#39;Copy&#39;,  </li>
<li>// -XX:+UseParNewGC  </li>
<li>&#39;ParNew&#39;,  </li>
<li>// -XX:+UseParallelGC  </li>
<li>&#39;PS Scavenge&#39;,  </li>
<li></li>
<li>// Oracle (BEA) JRockit  </li>
<li>// -XgcPrio:pausetime  </li>
<li>&#39;Garbage collection optimized for short pausetimes Young Collector&#39;,  </li>
<li>// -XgcPrio:throughput  </li>
<li>&#39;Garbage collection optimized for throughput Young Collector&#39;,  </li>
<li>// -XgcPrio:deterministic  </li>
<li>&#39;Garbage collection optimized for deterministic pausetimes Young Collector&#39;  </li>
<li>]  </li>
<li></li>
<li>static final List<String> OldGenCollectorNames = [  </li>
<li>// Oracle (Sun) HotSpot  </li>
<li>// -XX:+UseSerialGC  </li>
<li>&#39;MarkSweepCompact&#39;,  </li>
<li>// -XX:+UseParallelGC and (-XX:+UseParallelOldGC or -XX:+UseParallelOldGCCompacting)  </li>
<li>&#39;PS MarkSweep&#39;,  </li>
<li>// -XX:+UseConcMarkSweepGC  </li>
<li>&#39;ConcurrentMarkSweep&#39;,  </li>
<li></li>
<li>// Oracle (BEA) JRockit  </li>
<li>// -XgcPrio:pausetime  </li>
<li>&#39;Garbage collection optimized for short pausetimes Old Collector&#39;,  </li>
<li>// -XgcPrio:throughput  </li>
<li>&#39;Garbage collection optimized for throughput Old Collector&#39;,  </li>
<li>// -XgcPrio:deterministic  </li>
<li>&#39;Garbage collection optimized for deterministic pausetimes Old Collector&#39;  </li>
<li>]  </li>
<li></li>
<li>static int getYoungGCCount() {  </li>
<li>ManagementFactory.garbageCollectorMXBeans.inject(0) { youngGCCount, gc -&gt;  </li>
<li>if (YoungGenCollectorNames.contains(gc.name))  </li>
<li>youngGCCount + gc.collectionCount  </li>
<li>else  </li>
<li>youngGCCount  </li>
<li>}  </li>
<li>}  </li>
<li></li>
<li>static int getFullGCCount() {  </li>
<li>ManagementFactory.garbageCollectorMXBeans.inject(0) { fullGCCount, gc -&gt;  </li>
<li>if (OldGenCollectorNames.contains(gc.name))  </li>
<li>fullGCCount + gc.collectionCount  </li>
<li>else  </li>
<li>fullGCCount  </li>
<li>}  </li>
<li>}  </li>
<li><p>}<br>import java.lang.management.ManagementFactory class GCStats { static final List<String> YoungGenCollectorNames = [ // Oracle (Sun) HotSpot // -XX:+UseSerialGC &#39;Copy&#39;, // -XX:+UseParNewGC &#39;ParNew&#39;, // -XX:+UseParallelGC &#39;PS Scavenge&#39;, // Oracle (BEA) JRockit // -XgcPrio:pausetime &#39;Garbage collection optimized for short pausetimes Young Collector&#39;, // -XgcPrio:throughput &#39;Garbage collection optimized for throughput Young Collector&#39;, // -XgcPrio:deterministic &#39;Garbage collection optimized for deterministic pausetimes Young Collector&#39; ] static final List<String> OldGenCollectorNames = [ // Oracle (Sun) HotSpot // -XX:+UseSerialGC &#39;MarkSweepCompact&#39;, // -XX:+UseParallelGC and (-XX:+UseParallelOldGC or -XX:+UseParallelOldGCCompacting) &#39;PS MarkSweep&#39;, // -XX:+UseConcMarkSweepGC &#39;ConcurrentMarkSweep&#39;, // Oracle (BEA) JRockit // -XgcPrio:pausetime &#39;Garbage collection optimized for short pausetimes Old Collector&#39;, // -XgcPrio:throughput &#39;Garbage collection optimized for throughput Old Collector&#39;, // -XgcPrio:deterministic &#39;Garbage collection optimized for deterministic pausetimes Old Collector&#39; ] static int getYoungGCCount() { ManagementFactory.garbageCollectorMXBeans.inject(0) { youngGCCount, gc -&gt; if (YoungGenCollectorNames.contains(gc.name)) youngGCCount + gc.collectionCount else youngGCCount } } static int getFullGCCount() { ManagementFactory.garbageCollectorMXBeans.inject(0) { fullGCCount, gc -&gt; if (OldGenCollectorNames.contains(gc.name)) fullGCCount + gc.collectionCount else fullGCCount } } }
用的时候：
Groovysh代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>D:>\sdk\groovy-1.7.2\bin\groovysh  </p>
</li>
<li>Groovy Shell (1.7.2, JVM: 1.6.0_20)  </li>
<li>Type &#39;help&#39; or &#39;\h&#39; for help.  </li>
<li><hr>
</li>
<li>groovy:000&gt; GCStats.fullGCCount  </li>
<li>===&gt; 0  </li>
<li>groovy:000&gt; System.gc()  </li>
<li>===&gt; null  </li>
<li>groovy:000&gt; GCStats.fullGCCount  </li>
<li>===&gt; 1  </li>
<li>groovy:000&gt; System.gc()  </li>
<li>===&gt; null  </li>
<li>groovy:000&gt; System.gc()  </li>
<li>===&gt; null  </li>
<li>groovy:000&gt; GCStats.fullGCCount  </li>
<li>===&gt; 3  </li>
<li>groovy:000&gt; GCStats.youngGCCount  </li>
<li>===&gt; 9  </li>
<li>groovy:000&gt; GCStats.youngGCCount  </li>
<li>===&gt; 9  </li>
<li>groovy:000&gt; GCStats.youngGCCount  </li>
<li>===&gt; 9  </li>
<li>groovy:000&gt; System.gc()  </li>
<li>===&gt; null  </li>
<li>groovy:000&gt; GCStats.youngGCCount  </li>
<li>===&gt; 9  </li>
<li>groovy:000&gt; GCStats.fullGCCount  </li>
<li>===&gt; 4  </li>
<li>groovy:000&gt; quit<br>D:>\sdk\groovy-1.7.2\bin\groovysh Groovy Shell (1.7.2, JVM: 1.6.0_20) Type &#39;help&#39; or &#39;\h&#39; for help. -------------------------------------------------- groovy:000&gt; GCStats.fullGCCount ===&gt; 0 groovy:000&gt; System.gc() ===&gt; null groovy:000&gt; GCStats.fullGCCount ===&gt; 1 groovy:000&gt; System.gc() ===&gt; null groovy:000&gt; System.gc() ===&gt; null groovy:000&gt; GCStats.fullGCCount ===&gt; 3 groovy:000&gt; GCStats.youngGCCount ===&gt; 9 groovy:000&gt; GCStats.youngGCCount ===&gt; 9 groovy:000&gt; GCStats.youngGCCount ===&gt; 9 groovy:000&gt; System.gc() ===&gt; null groovy:000&gt; GCStats.youngGCCount ===&gt; 9 groovy:000&gt; GCStats.fullGCCount ===&gt; 4 groovy:000&gt; quit
这是在Sun JDK 6 update 20上跑的。顺带一提，如果这是跑在JRockit上的话，那full GC的次数就不会增加——因为JRockit里System.gc()默认是触发young GC的；请不要因为Sun HotSpot的默认行为而认为System.gc()总是会触发full GC的。
关于JMX的MXBean的使用，也可以参考下面两篇文档：
<a href="http://docs.codehaus.org/display/GROOVY/Groovy+and+JMX" target="_blank">Groovy and JMX</a>
<a href="http://www.engineyard.com/blog/2010/monitoring-the-jvm-heap-with-jruby/" target="_blank">Monitoring the JVM Heap with JRuby</a>
<a href="http://hllvm.group.iteye.com/group/wiki/3042-JVM-eclipse" title="如何更快的启动eclipse" target="_blank">如何更快的启动eclipse</a></li>
</ol>
<p>评论 共 1 条 请<a href="http://hllvm.group.iteye.com/login" target="_blank">登录</a>后发表评论 <a href=""></a></p>
<h3 id="1-xgj1988-http-xgj1988-iteye-com-xgj1988-2011-04-27-15-07">1 楼 <a href="http://xgj1988.iteye.com/" title="xgj1988" target="_blank">xgj1988</a> 2011-04-27 15:07</h3>
<p>SUN jdk   使用FULL GC 是如下的几种之一？
Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
<ol>
<li>static final List<String> OldGenCollectorNames = [     </li>
<li>// Oracle (Sun) HotSpot     </li>
<li>// -XX:+UseSerialGC     </li>
<li>&#39;MarkSweepCompact&#39;,     </li>
<li>// -XX:+UseParallelGC and (-XX:+UseParallelOldGC or -XX:+UseParallelOldGCCompacting)     </li>
<li>&#39;PS MarkSweep&#39;,     </li>
<li>// -XX:+UseConcMarkSweepGC     </li>
<li>&#39;ConcurrentMarkSweep&#39;,     </li>
<li></li>
<li><p>]<br>static final List<String> OldGenCollectorNames = [ // Oracle (Sun) HotSpot // -XX:+UseSerialGC &#39;MarkSweepCompact&#39;, // -XX:+UseParallelGC and (-XX:+UseParallelOldGC or -XX:+UseParallelOldGCCompacting) &#39;PS MarkSweep&#39;, // -XX:+UseConcMarkSweepGC &#39;ConcurrentMarkSweep&#39;, ]
这几个是young gc?
Java代码  <a href="&quot;收藏这段代码&quot;"><img src="" alt="收藏代码"><img src="" alt=""></a></p>
</li>
<li><p>&#39;Copy&#39;,     </p>
</li>
<li>// -XX:+UseParNewGC     </li>
<li>&#39;ParNew&#39;,     </li>
<li>// -XX:+UseParallelGC     </li>
<li>&#39;PS Scavenge&#39;,     </li>
<li>&#39;Copy&#39;, // -XX:+UseParNewGC &#39;ParNew&#39;, // -XX:+UseParallelGC &#39;PS Scavenge&#39;,
根据名字判断来获取full gc<img src="" alt=""><h3 id="-">发表评论</h3>
</li>
</ol>
<p><a href="http://hllvm.group.iteye.com/login" target="_blank"><img src="" alt=""> 您还没有登录,请您登录后再发表评论</a></p>
<p><a href="http://hllvm.group.iteye.com/group/wiki/new" target="_blank"><img src="" alt="New-page"></a></p>
<h3 id="-">文章信息</h3>
<p><a href="http://hllvm.group.iteye.com/group/wiki/" target="_blank">知识库: 高级语言虚拟机</a></p>
<ul>
<li>由<a href="http://kiral.iteye.com/" title="fantasy" target="_blank">fantasy</a>在2010-12-16创建</li>
<li><p>由<a href="http://kiral.iteye.com/" title="fantasy" target="_blank">fantasy</a>在2011-05-26更新</p>
<h3 id="-">相关新闻</h3>
</li>
<li><p><a href="http://hllvm.group.iteye.com/news/6318-java-se-6-update-14-early-access-version" target="_blank">Java SE 6 Update 14 Early Access 早期使用版本现已发布</a></p>
</li>
<li><a href="http://hllvm.group.iteye.com/news/4146-jdk-7-in-the-new-garbage-collection-mechanism" target="_blank">JDK 7 中新的垃圾收集机制</a></li>
<li><a href="http://hllvm.group.iteye.com/news/10069" target="_blank">Java 7的新功能和Java 1.5,1.6,1.7的性能测试比较</a></li>
</ul>
<h3 id="-">相关讨论</h3>
<ul>
<li><a href="http://hllvm.group.iteye.com/topic/894148" target="_blank">HotSpot VM 内存堆的两个Servivor区</a></li>
<li><a href="http://hllvm.group.iteye.com/topic/976522" target="_blank">java内存管理以及GC</a></li>
<li><a href="http://hllvm.group.iteye.com/topic/802638" target="_blank">JVM内存管理：深入垃圾收集器与内存分配策略</a></li>
<li><a href="http://hllvm.group.iteye.com/topic/212967" target="_blank">一次Java垃圾收集调优实战</a></li>
<li><p><a href="http://hllvm.group.iteye.com/topic/262541" target="_blank">JVM的GC-生命不能承受之重</a></p>
<h3 id="-">相关博客</h3>
</li>
<li><p><a href="http://rednaxelafx.iteye.com/blog/790015" target="_blank">通过Java/JMX得到full GC次数？</a></p>
</li>
<li><a href="http://millerhu.iteye.com/blog/890724" target="_blank">通过Java/JMX得到full GC次数？</a></li>
<li><a href="http://rednaxelafx.iteye.com/blog/790864" target="_blank">用Java获取full GC的次数？（2）</a></li>
<li><a href="http://tianshibaijia.iteye.com/blog/1343308" target="_blank">常用垃圾收集器在Mbean上的名称</a></li>
<li><a href="http://rednaxelafx.iteye.com/blog/1042471" target="_blank">答复: HotSpot VM 内存堆的两个Survivor区</a></li>
<li><a href="http://www.iteye.com/" target="_blank">首页</a></li>
<li><a href="http://www.iteye.com/news" target="_blank">资讯</a></li>
<li><a href="http://www.iteye.com/magazines" target="_blank">精华</a></li>
<li><a href="http://www.iteye.com/forums" target="_blank">论坛</a></li>
<li><a href="http://www.iteye.com/ask" target="_blank">问答</a></li>
<li><a href="http://www.iteye.com/blogs" target="_blank">博客</a></li>
<li><a href="http://www.iteye.com/blogs/subjects" target="_blank">专栏</a></li>
<li><a href="http://www.iteye.com/groups" target="_blank">群组</a></li>
<li><a href="http://job.iteye.com/iteye" target="_blank">招聘</a></li>
<li><a href="http://www.iteye.com/search" target="_blank">搜索</a></li>
<li><a href="http://hllvm.group.iteye.com/index/service" target="_blank">广告服务</a></li>
<li><a href="http://webmaster.iteye.com/" target="_blank">ITeye黑板报</a></li>
<li><a href="http://hllvm.group.iteye.com/index/contactus" target="_blank">联系我们</a></li>
<li><a href="http://hllvm.group.iteye.com/index/friend_links" target="_blank">友情链接</a></li>
</ul>
<p>© 2003-2012 ITeye.com. [ <a href="http://www.miibeian.gov.cn/" target="_blank">京ICP证110151号</a> 京公网安备110105010620 ]
百联优力(北京)投资有限公司 版权所有 <img src="http://stat.iteye.com/?url=http%3A%2F%2Fhllvm.group.iteye.com%2Fgroup%2Fwiki%2F2950-gc&amp;referrer=&amp;user_id=" alt=""></p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li></span><span class="breadcrumb"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li><li><a href="/categories/Java&J2EE/JVM/">JVM</a></li></span></span> | <span class="tags">Tagged <a href="/tags/JVM/" class="label label-primary">JVM</a><a href="/tags/Java&J2EE/" class="label label-success">Java&J2EE</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:42"datetime="2014-03-07 09:54:42"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-JVM--通过Java-JMX得到fullGC次数？-高级语言虚拟机/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JavaJ2EE-JVM--通过Java-JMX得到fullGC次数？-高级语言虚拟机" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--豆列：从表到里学习JVM实现/">豆列：从表到里学习JVM实现</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:42.000Z"> <a href="/2014/02/02/2014-02-02-JavaJ2EE-JVM--豆列：从表到里学习JVM实现/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="-jvm-">豆列：从表到里学习JVM实现</h1>
<p>刚写了个学习JVM用的豆列跟大家分享。
豆列地址：<a href="http://book.douban.com/doulist/2545443/" target="_blank"><a href="http://book.douban.com/doulist/2545443/">http://book.douban.com/doulist/2545443/</a></a>
下面把豆列的介绍贴过来。具体书单请到上面的豆列地址那边去看。
在社会化分工、软件行业细分专业化的趋势下，会真的参与到底层系统实现的人肯定是越来越少（比例上说）。真的会参与到JVM实现的人肯定是少数。
但如果您对JVM是如何实现的有兴趣、充满好奇，却苦于没有足够系统的知识去深入，那么这个豆列就是为您打好基础而准备的。
如果只想用用Java用用JVM，对深入到实现细节无甚兴趣的话，这个豆列就请不必参考了，免得浪费钱浪费时间精力，呵呵 :-)
本豆列的脉络是：</p>
<ol>
<li>JVM与Java语言规范
要了解JVM是如何实现的，首先必须要知道JVM到底是什么、不是什么，表面上应该提供怎样的功能。为此，JVM规范必读，而且应该时常放在手边参考。
而JVM的主要服务对象是Java编程语言。虽然JVM也可以支持众多其它语言，但JVM里的“J”仍然最重要，Java的语言特性影响了JVM的原始设计，所以Java语言规范也应该阅读。特别是，JVM关于线程和同步相关的规定都是交由Java语言规范的相关章节定义的。</li>
<li>虚拟机概论
这里选取《Virtual Machines: Versatile Platforms for Systems and Processes》，帮助您了解“虚拟机”一词到底指代什么，有什么不同类型，大概有哪些实现方法，等等。读完这本书有助获得一个清晰的大局观。</li>
<li>为Java程序员从用户的角度介绍JVM的使用经验的几本书
虽然这几本并没有深入到JVM实现的非常细节的角落，但对已经习惯用Java语言编程的程序员来说，有这么几本书带领自己从熟悉的领域进入不熟悉的领域总是件好事。
这几本书中，最深入JVM内部的是《Oracle JRockit: The Definitive Guide》；有丰富调优建议的是《Java Performance》；结合实现大概介绍JVM的抽象概念的是周志明的《深入理解Java虚拟机》。</li>
<li>虚拟机的入门级实现
先通过《Language Implementation Patterns》了解编程语言的一些入门级实现方式，把高级语言编译器与虚拟机两个概念联系起来。
然后通过《プログラミング言語を作る》了解非常简易的、用树遍历式以及字节码式解释器实现虚拟机大概是个怎么回事。虽然这本书没有实现JVM，但它介绍的Diksam与早期JVM的实现颇有相似之处，可参考。
接下来《深入嵌入式Java虚拟机》介绍了一种实际的JVM——KVM的实现细节。KVM是CLDC的参考实现（RI）里的JVM，结构简单，资源消耗小，适合入门阅读。
这部分最后是《The School of Niklaus Wirth》，里面有一章介绍了HotSpot Client Compiler (C1)的原始设计思路。这是个非常简单、但相对来说性能还不错的JIT编译器，可用于对JIT编译器的基本了解。这本书本身就很赞，不为学习虚拟机也可以一读。
需要注意的是从“简易的JVM实现”到“高性能、复杂的JVM实现”跨度非常大；前者的许多部分的实现方式与后者相当不同。先从简易的实现开始入手主要是为了对JVM里大概都有些什么组件有所了解。但如果目标是了解高性能JVM的实现，那就必须在GC、编译原理方面打下更好的基础，重新洗一次脑。</li>
<li>C++基础书
下面要开始逐渐深入JVM的内部实现，如果没有良好的C或（与？）C++基础会比较吃力。虽然也有几乎完全用Java语言实现的高性能JVM，例如Maxine VM与Jikes RVM，但它们都是研究性质的；商用JVM实现仍然是C与C++的天下。
这里我先推荐C++之父自己写的那本书来入门。虽然BS巨巨后来还出过本新书，而近来也渐渐开始有介绍C++11的入门书，但实际上现在多数JVM实现用的还是C99或非常古老的C++（连C++03都不一定用到了），所以用这本老书应该就够了。
然后通过《深度探索C++对象模型》来学习C++对象模型的常见实现方式。这对后面理解Java对象模型的实现很有帮助。</li>
<li>GC与编译原理的入门书
GC书总共就那么几本，倒也没啥可挑的。《The Garbage Collection Handbook》是绝对必读。
编译原理的书就稍微尴尬些。现有的编译原理书大都针对静态编译器、针对像C或C++那样的偏静态、偏native的语言。我还没读到过什么编译原理书是专门介绍JIT编译器或者说动态编译器的。静态与动态编译器会有些取舍上、实现策略上的差异，不过还好其核心的原理都是一样的，所以还是可以推荐几本书。龙书用来最初入门，鲸书用来补充一些优化相关的知识，EAC第二版用来学习编译器一种比较良好的逻辑组织方式，最后学一下针对现代机器的优化。</li>
<li>介绍计算机体系结构的书
实际JVM实现里，如果有JIT编译器或者动态编译器那它们的编译目标多半是底层机器的机器码。这就涉及到计算机体系结构了。
如果您只对Java语言和抽象的JVM有一定了解，那可以用《计算机组成及汇编语言原理》来入门。这本书比较奇葩，用JVM的字节码指令集来当作真实机器介绍体系结构的概念。我并不太喜欢这本书，但感觉它对有Java背景的初学者来说应该有点用。要注意的是千万别只读这本书来入门，请结合下面要介绍的一本书来重新洗一次脑。
如果对C或C++已经有所了解，那《深入理解计算机系统》（CSAPP）是计算机体系结构入门的最适合的书了。</li>
<li>进一步阅读
到此为止各种抽象概念应该都了解得差不多了。那么要在真实的机器上实现高性能JVM，就必须要对真实机器的指令集细节有所了解。x86/x86-64、SPARC、ARM、MIPS，要在哪个平台上做高性能实现就要学习哪个平台的指令集及指令级别优化技巧。这里就不具体推荐书了。
操作系统层面的知识同样重要。像是说JVM要实现线程、内存分配啥的，都可能要跟系统调用或CRT对系统调用的包装打交道。这部分也需要另外找书来读。我回头再考虑下要不要加几本道这个豆列里来。
另外，从80年代开始高级语言虚拟机的实现技术有了突飞猛进的发展，但却没有专门的书对这个领域做综述和导读。多数有用的资料其实还是在论文里。光靠读书是远远不够用的，论文这块也请关注。<h1 id="-http-rednaxelafx-iteye-com-blog-362738-http-rednaxelafx-iteye-com-blog-362738-">顺便广告一下：我的博客里关于虚拟机的文章也推荐给大家参考：<a href="http://rednaxelafx.iteye.com/blog/362738" target="_blank"><a href="http://rednaxelafx.iteye.com/blog/362738">http://rednaxelafx.iteye.com/blog/362738</a></a></h1>
这个豆列没有漏掉 <a href="http://book.douban.com/subject/1788390/" target="_blank">《Inside the Java Virtual Machine, Second Edition》</a> ，中文版<a href="http://book.douban.com/subject/1138768/" target="_blank">《深入Java虚拟机(原书第2版)》</a>，只是我现在已经不再推荐它。这本书刚出版的时候确实引起了一番学习Java虚拟机的热潮，但其部分内容从现在的角度看已经过时，特别是涉及JVM实现的部分。像火车算法什么的现在已经没有JVM实现使用。不过话说回来，了解了解这些过时的信息也没什么不好，前提是能自己分辨清楚哪些信息是适用于现在的JVM的，而哪些已经成为了历史。</li>
</ol>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li></span><span class="breadcrumb"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li><li><a href="/categories/Java&J2EE/JVM/">JVM</a></li></span></span> | <span class="tags">Tagged <a href="/tags/JVM/" class="label label-primary">JVM</a><a href="/tags/Java&J2EE/" class="label label-success">Java&J2EE</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:42"datetime="2014-03-07 09:54:42"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-JVM--豆列：从表到里学习JVM实现/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JavaJ2EE-JVM--豆列：从表到里学习JVM实现" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JavaJ2EE-report--DynamicReportsGettingstarted/">DynamicReports(Getting started)</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:42.000Z"> <a href="/2014/02/02/2014-02-02-JavaJ2EE-report--DynamicReportsGettingstarted/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="dynamicreports-getting-started-">DynamicReports(Getting started)</h1>
<h2 id="getting-started">Getting started</h2>
<p><strong>Table of contents</strong></p>
<ol>
<li><a href="http://www.dynamicreports.org/getting-started#overview" target="_blank">Overview</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#simplereport" target="_blank">Simple report</a></li>
</ol>
<ul>
<li><a href="http://www.dynamicreports.org/getting-started#step1" target="_blank">Step 1 : Start</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step2" target="_blank">Step 2 : Styles</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step3" target="_blank">Step 3 : Additional columns</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step4" target="_blank">Step 4 : Group</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step5" target="_blank">Step 5 : Subtotals</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step6" target="_blank">Step 6 : Charts</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step7" target="_blank">Step 7 : Column grid &amp; Containers</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step8" target="_blank">Step 8 : Hide subtotal</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step9" target="_blank">Step 9 : Title</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step10" target="_blank">Step 10 : Currency data type</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step11" target="_blank">Step 11 : Detail row highlighters</a></li>
<li><a href="http://www.dynamicreports.org/getting-started#step12" target="_blank">Step 12 : Conditional styles</a></li>
</ul>
<p><a href=""></a></p>
<h3 id="overview">Overview</h3>
<p>Creating a report with <strong>DynamicReports</strong> is very easy, take a look at the example below
01</p>
<p>import</p>
<p>static</p>
<p>net.sf.dynamicreports.report.builder.DynamicReports./*;</p>
<p>02</p>
<p>public</p>
<p>class</p>
<p>Report {
03</p>
<p>04</p>
<p>private</p>
<p>void</p>
<p>build() {
05</p>
<p>try</p>
<p>{</p>
<p>06</p>
<p>report()</p>
<p>//create new report design
07</p>
<p>.columns(...)</p>
<p>//adds columns</p>
<p>08</p>
<p>.groupBy(...)</p>
<p>//adds groups
09</p>
<p>.subtotalsAtSummary(...)</p>
<p>//adds subtotals</p>
<p>10</p>
<p>...
11</p>
<p>//set datasource</p>
<p>12</p>
<p>.setDataSource(...)
13</p>
<p>//export report</p>
<p>14</p>
<p>.toPdf(...)</p>
<p>//export report to pdf
15</p>
<p>.toXls(...)</p>
<p>//export report to excel</p>
<p>16</p>
<p>...
17</p>
<p>//other outputs</p>
<p>18</p>
<p>.toJasperPrint()</p>
<p>//creates jasperprint object
19</p>
<p>.show()</p>
<p>//shows report</p>
<p>20</p>
<p>.print()</p>
<p>//prints report
21</p>
<p>...</p>
<p>22</p>
<p>}</p>
<p>catch</p>
<p>(DRException e) {
23</p>
<p>e.printStackTrace(); </p>
<p>24</p>
<p>}
25</p>
<p>} </p>
<p>26</p>
<p>... 
27</p>
<p>}</p>
<p>See <a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/ReportBuilder.html" target="_blank">ReportBuilder</a> class for all available features and <a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/jasper/builder/JasperReportBuilder.html" target="_blank">JasperReportBuilder</a> class for all available exports and outputs</p>
<p><a href=""></a></p>
<h3 id="simple-report">Simple report</h3>
<p>Please note that this is a tutorial example and that this tutorial doesn&#39;t describe all features!</p>
<p>You will learn in this section how to create a simple report step by step.
First we need to create an empty report desing, configure it and set a datasource. Afterwards the report will be ready to export into any format.
It&#39;s important to remember the <a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/DynamicReports.html" target="_blank">DynamicReports</a> class, through which you will have available most of features. The class provides methods for building a particular piece of a report.
Let&#39;s start!</p>
<p><a href=""></a></p>
<h3 id="step-1-start">Step 1 : Start</h3>
<p>First define columns through <a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/column/ColumnBuilders.html" target="_blank">DynamicReports.col</a>.column(title, field name, datatype) (the field name must match with the name of a field contained in the datasource) and pass them into the report as follows:
1</p>
<p>.columns(</p>
<p>//add columns</p>
<p>2</p>
<p>//             title,     field name     data type
3</p>
<p>col.column(</p>
<p>&quot;Item&quot;</p>
<p>,      </p>
<p>&quot;item&quot;</p>
<p>,      type.stringType()),</p>
<p>4</p>
<p>col.column(</p>
<p>&quot;Quantity&quot;</p>
<p>,  </p>
<p>&quot;quantity&quot;</p>
<p>,  type.integerType()),
5</p>
<p>col.column(</p>
<p>&quot;Unit price&quot;</p>
<p>,</p>
<p>&quot;unitprice&quot;</p>
<p>, type.bigDecimalType()))</p>
<p>now define some text at the title and number of pages at the page footer as follows:</p>
<p>1</p>
<p>.title(cmp.text(</p>
<p>&quot;Getting started&quot;</p>
<p>))</p>
<p>//shows report title</p>
<p>2</p>
<p>.pageFooter(cmp.pageXofY())</p>
<p>//shows number of page at page footer</p>
<p><a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/component/ComponentBuilders.html" target="_blank">DynamicReports.cmp</a>.text(some text) - creates a component that shows a text
<a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/component/ComponentBuilders.html" target="_blank">DynamicReports.cmp</a>.pageXofY() - creates a component that shows page X of Y
Methods <strong>title(...)</strong> and <strong>pageFooter(...)</strong> allows to customize a particular report band by adding components to it</p>
<p><a href="http://www.dynamicreports.org/examples/simplereport_step01.png" title="SimpleReport_Step01" target="_blank"><img src="" alt="SimpleReport_Step01"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step01.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step01.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step01" title="SimpleReport_Step01" target="_blank">SimpleReport_Step01</a></p>
<p><a href=""></a></p>
<h3 id="step-2-styles">Step 2 : Styles</h3>
<p>Each style can have a parent style from which it will inherit its properties. Empty style can be created by <a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/style/StyleBuilders.html" target="_blank">DynamicReports.stl</a>.style()
01</p>
<p>StyleBuilder boldStyle         = stl.style().bold(); </p>
<p>02</p>
<p>StyleBuilder boldCenteredStyle = stl.style(boldStyle)
03</p>
<p>.setHorizontalAlignment(HorizontalAlignment.CENTER);</p>
<p>04</p>
<p>StyleBuilder columnTitleStyle  = stl.style(boldCenteredStyle)
05</p>
<p>.setBorder(stl.pen1Point())</p>
<p>06</p>
<p>.setBackgroundColor(Color.LIGHT_GRAY);
07</p>
<p>report()</p>
<p>08</p>
<p>.setColumnTitleStyle(columnTitleStyle) 
09</p>
<p>.highlightDetailEvenRows() </p>
<p>10</p>
<p>.title(cmp.text(</p>
<p>&quot;Getting started&quot;</p>
<p>).setStyle(boldCenteredStyle))
11</p>
<p>.pageFooter(cmp.pageXofY().setStyle(boldCenteredStyle)) <a href="http://www.dynamicreports.org/examples/simplereport_step02.png" title="SimpleReport_Step02" target="_blank"><img src="" alt="SimpleReport_Step02"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step02.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step02.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step02" title="SimpleReport_Step02" target="_blank">SimpleReport_Step02</a></p>
<p><a href=""></a></p>
<h3 id="step-3-additional-columns">Step 3 : Additional columns</h3>
<p>You can very easy multiply, divide, add or subtract column of numbers by another column of numbers or by a number value
1</p>
<p>//price = unitPrice /* quantity </p>
<p>2</p>
<p>TextColumnBuilder<BigDecimal> priceColumn = unitPriceColumn.multiply(quantityColumn)
3</p>
<p>.setTitle(</p>
<p>&quot;Price&quot;</p>
<p>);</p>
<p>Adding percentage of any column of numbers is simple <a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/column/ColumnBuilders.html" target="_blank">DynamicReports.col</a>.percentageColumn(title, column)</p>
<p>1</p>
<p>PercentageColumnBuilder pricePercColumn = col.percentageColumn(</p>
<p>&quot;Price %&quot;</p>
<p>, priceColumn);</p>
<p><a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/column/ColumnBuilders.html" target="_blank">DynamicReports.col</a>.reportRowNumberColumn(title) creates a column that shows row number</p>
<p>1</p>
<p>TextColumnBuilder<Integer> rowNumberColumn =</p>
<p>2</p>
<p>col.reportRowNumberColumn(</p>
<p>&quot;No.&quot;</p>
<p>) 
3</p>
<p>//sets the fixed width of a column, width = 2 /* character width </p>
<p>4</p>
<p>.setFixedColumns(</p>
<p>2</p>
<p>) 
5</p>
<p>.setHorizontalAlignment(HorizontalAlignment.CENTER);  <a href="http://www.dynamicreports.org/examples/simplereport_step03.png" title="SimpleReport_Step03" target="_blank"><img src="" alt="SimpleReport_Step03"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step03.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step03.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step03" title="SimpleReport_Step03" target="_blank">SimpleReport_Step03</a></p>
<p><a href=""></a></p>
<h3 id="step-4-group">Step 4 : Group</h3>
<p>We continue by adding a group as shown below
1</p>
<p>.groupBy(itemColumn) <a href="http://www.dynamicreports.org/examples/simplereport_step04.png" title="SimpleReport_Step04" target="_blank"><img src="" alt="SimpleReport_Step04"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step04.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step04.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step04" title="SimpleReport_Step04" target="_blank">SimpleReport_Step04</a></p>
<p><a href=""></a></p>
<h3 id="step-5-subtotals">Step 5 : Subtotals</h3>
<p>Now we can try to sum a column of numbers. Subtotal of sum is created through <a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/subtotal/SubtotalBuilders.html" target="_blank">DynamicReports.sbt</a>.sum(column)
1</p>
<p>.subtotalsAtSummary( </p>
<p>2</p>
<p>sbt.sum(unitPriceColumn), sbt.sum(priceColumn)) 
3</p>
<p>.subtotalsAtFirstGroupFooter( </p>
<p>4</p>
<p>sbt.sum(unitPriceColumn), sbt.sum(priceColumn)) </p>
<p>Method <strong>subtotalsAtSummary(...)</strong> allows to add subtotals to the summary band
Method <strong>subtotalsAtFirstGroupFooter(...)</strong> will find first defined group and add subtotals to the group footer band</p>
<p><a href="http://www.dynamicreports.org/examples/simplereport_step05.png" title="SimpleReport_Step05" target="_blank"><img src="" alt="SimpleReport_Step05"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step05.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step05.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step05" title="SimpleReport_Step05" target="_blank">SimpleReport_Step05</a></p>
<p><a href=""></a></p>
<h3 id="step-6-charts">Step 6 : Charts</h3>
<p><a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/chart/ChartBuilders.html" target="_blank">DynamicReports.cht</a> provide methods for building charts. Category and series are required.
01</p>
<p>Bar3DChartBuilder itemChart = cht.bar3DChart()</p>
<p>02</p>
<p>.setTitle(</p>
<p>&quot;&lt;a href=&quot;</p>
<p>http:</p>
<p>//www.dynamicreports.org/examples/sales&quot; title=&quot;Sales&quot;&gt;Sales</a> by item&quot;)
03</p>
<p>.setCategory(itemColumn)</p>
<p>04</p>
<p>.addSerie(
05</p>
<p>cht.serie(unitPriceColumn), cht.serie(priceColumn));</p>
<p>06</p>
<p>Bar3DChartBuilder itemChart2 = cht.bar3DChart()
07</p>
<p>.setTitle(</p>
<p>&quot;&lt;a href=&quot;</p>
<p>http:</p>
<p>//www.dynamicreports.org/examples/sales&quot; title=&quot;Sales&quot;&gt;Sales</a> by item&quot;)</p>
<p>08</p>
<p>.setCategory(itemColumn)
09</p>
<p>.setUseSeriesAsCategory(</p>
<p>true</p>
<p>)</p>
<p>10</p>
<p>.addSerie(
11</p>
<p>cht.serie(unitPriceColumn), cht.serie(priceColumn));</p>
<p>Chart is a component and can be placed into any report band.</p>
<p>1</p>
<p>.summary(itemChart, itemChart2) <a href="http://www.dynamicreports.org/examples/simplereport_step06.png" title="SimpleReport_Step06" target="_blank"><img src="" alt="SimpleReport_Step06"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step06.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step06.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step06" title="SimpleReport_Step06" target="_blank">SimpleReport_Step06</a></p>
<p><a href=""></a></p>
<h3 id="step-7-column-grid-containers">Step 7 : Column grid &amp; Containers</h3>
<p>Components inserted into the bands are arranged vertically, each component is below the previously added component. To arrange components horizontally it is needed to wrap these components with a horizontal container. Container is a component as well and therefore it can be added to any of the report bands.
1</p>
<p>.summary( </p>
<p>2</p>
<p>cmp.horizontalList(itemChart, itemChart2))</p>
<p>Columns layout can be modified by a column grid. The layout is applied to the columns title, details and subtotals.</p>
<p>1</p>
<p>.columnGrid( </p>
<p>2</p>
<p>rowNumberColumn, quantityColumn, unitPriceColumn,
3</p>
<p>grid.verticalColumnGridList(priceColumn, pricePercColumn)) <a href="http://www.dynamicreports.org/examples/simplereport_step07.png" title="SimpleReport_Step07" target="_blank"><img src="" alt="SimpleReport_Step07"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step07.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step07.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step07" title="SimpleReport_Step07" target="_blank">SimpleReport_Step07</a></p>
<p><a href=""></a></p>
<h3 id="step-8-hide-subtotal">Step 8 : Hide subtotal</h3>
<p>Subtotal for the group notebook is unnecessary because contains only one row.
We need to change the group declaration and set the boolean expression condition on which depends whether subtotal is printed.
<a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/expression/ExpressionBuilders.html" target="_blank">DynamicReports.exp</a>.printWhenGroupHasMoreThanOneRow(itemGroup) creates a boolean condition which returns true when itemGroup has more than one row.
1</p>
<p>ColumnGroupBuilder itemGroup = grp.group(itemColumn); </p>
<p>2</p>
<p>itemGroup.setPrintSubtotalsWhenExpression(
3</p>
<p>exp.printWhenGroupHasMoreThanOneRow(itemGroup));</p>
<p>1</p>
<p>.groupBy(itemGroup)
<a href="http://www.dynamicreports.org/examples/simplereport_step08.png" title="SimpleReport_Step08" target="_blank"><img src="" alt="SimpleReport_Step08"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step08.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step08.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step08" title="SimpleReport_Step08" target="_blank">SimpleReport_Step08</a></p>
<p><a href=""></a></p>
<h3 id="step-9-title">Step 9 : Title</h3>
<p>First define a title style.
1</p>
<p>StyleBuilder titleStyle = stl.style(boldCenteredStyle)</p>
<p>2</p>
<p>.setVerticalAlignment(VerticalAlignment.MIDDLE)
3</p>
<p>.setFontSize(</p>
<p>15</p>
<p>);</p>
<p><a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/component/ComponentBuilders.html" target="_blank">DynamicReports.cmp</a>.image() creates an image component
<a href="http://apidocs.dynamicreports.org/net/sf/dynamicreports/report/builder/component/ComponentBuilders.html" target="_blank">DynamicReports.cmp</a>.filler() creates an empty component</p>
<p>1</p>
<p>.title(</p>
<p>//shows report title</p>
<p>2</p>
<p>cmp.horizontalList()
3</p>
<p>.add(</p>
<p>4</p>
<p>cmp.image(getClass().getResourceAsStream(</p>
<p>&quot;../images/dynamicreports.png&quot;</p>
<p>)).setFixedDimension(</p>
<p>80</p>
<p>,</p>
<p>80</p>
<p>),
5</p>
<p>cmp.text(</p>
<p>&quot;DynamicReports&quot;</p>
<p>).setStyle(titleStyle).setHorizontalAlignment(HorizontalAlignment.LEFT),</p>
<p>6</p>
<p>cmp.text(</p>
<p>&quot;Getting started&quot;</p>
<p>).setStyle(titleStyle).setHorizontalAlignment(HorizontalAlignment.RIGHT))
7</p>
<p>.newRow()</p>
<p>8</p>
<p>.add(cmp.filler().setStyle(stl.style().setTopBorder(stl.pen2Point())).setFixedHeight(</p>
<p>10</p>
<p>)))</p>
<p>The defined filler creates an additional blank space between the title and the column header.
Setting top border of a filler draws the line at the bottom of the title.
Horizontal list, as previously mentioned, arranges components horizontally in one row but by calling the method row() a new horizontal list is created which is located at the bottom of the previous horizontal list.</p>
<p><a href="http://www.dynamicreports.org/examples/simplereport_step09.png" title="SimpleReport_Step09" target="_blank"><img src="" alt="SimpleReport_Step09"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step09.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step09.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step09" title="SimpleReport_Step09" target="_blank">SimpleReport_Step09</a></p>
<p><a href=""></a></p>
<h3 id="step-10-currency-data-type">Step 10 : Currency data type</h3>
<p>Unit price and price column are currency types.
Showing currency is possible by setting pattern to both columns (via method setPattern()), but the best practice is to create a custom data type and apply it to the columns. The custom data type then can be used in other reports.
01</p>
<p>CurrencyType currencyType =</p>
<p>new</p>
<p>CurrencyType();</p>
<p>02</p>
<p>TextColumnBuilder<BigDecimal> unitPriceColumn = col.column(</p>
<p>&quot;Unit price&quot;</p>
<p>,</p>
<p>&quot;unitprice&quot;</p>
<p>, currencyType);
03</p>
<p>//price = unitPrice /* quantity</p>
<p>04</p>
<p>TextColumnBuilder<BigDecimal> priceColumn     = unitPriceColumn.multiply(quantityColumn).setTitle(</p>
<p>&quot;Price&quot;</p>
<p>)
05</p>
<p>.setDataType(currencyType);</p>
<p>06</p>
<p>private</p>
<p>class</p>
<p>CurrencyType</p>
<p>extends</p>
<p>BigDecimalType {
07</p>
<p>private</p>
<p>static</p>
<p>final</p>
<p>long</p>
<p>serialVersionUID = 1L;</p>
<p>08</p>
<p>09</p>
<p>@Override</p>
<p>10</p>
<p>public</p>
<p>String getPattern() {
11</p>
<p>return</p>
<p>&quot;$ /#,/#/#/#.00&quot;</p>
<p>;</p>
<p>12</p>
<p>}
13</p>
<p>} <a href="http://www.dynamicreports.org/examples/simplereport_step10.png" title="SimpleReport_Step10" target="_blank"><img src="" alt="SimpleReport_Step10"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step10.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step10.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step10" title="SimpleReport_Step10" target="_blank">SimpleReport_Step10</a></p>
<p><a href=""></a></p>
<h3 id="step-11-detail-row-highlighters">Step 11 : Detail row highlighters</h3>
<p>1</p>
<p>ConditionalStyleBuilder condition1 = stl.conditionalStyle(cnd.greater(priceColumn,</p>
<p>150</p>
<p>))</p>
<p>2</p>
<p>.setBackgroundColor(</p>
<p>new</p>
<p>Color(</p>
<p>210</p>
<p>,</p>
<p>255</p>
<p>,</p>
<p>210</p>
<p>));
3</p>
<p>ConditionalStyleBuilder condition2 = stl.conditionalStyle(cnd.smaller(priceColumn,</p>
<p>30</p>
<p>))</p>
<p>4</p>
<p>.setBackgroundColor(</p>
<p>new</p>
<p>Color(</p>
<p>255</p>
<p>,</p>
<p>210</p>
<p>,</p>
<p>210</p>
<p>));</p>
<p>1</p>
<p>.detailRowHighlighters(</p>
<p>2</p>
<p>condition1, condition2)</p>
<p>Condition1 is applied only if price is greater than 150 and sets background color of a row to green.
Condition2 is applied only if price is smaller than 30 and sets background color of a row to red.
<a href="http://www.dynamicreports.org/examples/simplereport_step11.png" title="SimpleReport_Step11" target="_blank"><img src="" alt="SimpleReport_Step11"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step11.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step11.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step11" title="SimpleReport_Step11" target="_blank">SimpleReport_Step11</a></p>
<p><a href=""></a></p>
<h3 id="step-12-conditional-styles">Step 12 : Conditional styles</h3>
<p>1</p>
<p>ConditionalStyleBuilder condition3 = stl.conditionalStyle(cnd.greater(priceColumn,</p>
<p>200</p>
<p>))</p>
<p>2</p>
<p>.setBackgroundColor(</p>
<p>new</p>
<p>Color(</p>
<p>0</p>
<p>,</p>
<p>190</p>
<p>,</p>
<p>0</p>
<p>))
3</p>
<p>.bold();</p>
<p>4</p>
<p>ConditionalStyleBuilder condition4 = stl.conditionalStyle(cnd.smaller(priceColumn,</p>
<p>20</p>
<p>))
5</p>
<p>.setBackgroundColor(</p>
<p>new</p>
<p>Color(</p>
<p>190</p>
<p>,</p>
<p>0</p>
<p>,</p>
<p>0</p>
<p>))</p>
<p>6</p>
<p>.bold();
7</p>
<p>StyleBuilder priceStyle = stl.style()</p>
<p>8</p>
<p>.conditionalStyles(
9</p>
<p>condition3, condition4);</p>
<p>1</p>
<p>priceColumn = unitPriceColumn.multiply(quantityColumn).setTitle(</p>
<p>&quot;Price&quot;</p>
<p>)</p>
<p>2</p>
<p>.setDataType(currencyType)
3</p>
<p>.setStyle(priceStyle);</p>
<p>Condition3 is applied only if price is greater than 200 and sets background color of a price to green.
Condition4 is applied only if price is smaller than 20 and sets background color of a price to red.
<a href="http://www.dynamicreports.org/examples/simplereport_step12.png" title="SimpleReport_Step12" target="_blank"><img src="" alt="SimpleReport_Step12"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step12.pdf" title="pdf preview" target="_blank"><img src="" alt="pdf"></a><a href="http://www.dynamicreports.org/examples/simplereport_step12.png" target="_blank"><img src="" alt="preview"></a> <a href="http://www.dynamicreports.org/examples/simplereport_step12" title="SimpleReport_Step12" target="_blank">SimpleReport_Step1</a></p>
<p>来源： <a href="[http://www.dynamicreports.org/getting-started](http://www.dynamicreports.org/getting-started)">[http://www.dynamicreports.org/getting-started](http://www.dynamicreports.org/getting-started)</a></p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li></span><span class="breadcrumb"><li><a href="/categories/Java&J2EE/">Java&J2EE</a></li><li><a href="/categories/Java&J2EE/report/">report</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Java&J2EE/" class="label label-primary">Java&J2EE</a><a href="/tags/report/" class="label label-success">report</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:42"datetime="2014-03-07 09:54:42"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JavaJ2EE-report--DynamicReportsGettingstarted/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JavaJ2EE-report--DynamicReportsGettingstarted" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>





<ul id="pagination" class="pagination pagination-lg">
  <li><a class="extend prev" href="/page/48/">&laquo;</a></li><li><a class="page-number" href="/">1</a></li><li><a class="page-number" href="/page/2/">2</a></li><li><span class="space">&hellip;</span></li><li><a class="page-number" href="/page/46/">46</a></li><li><a class="page-number" href="/page/47/">47</a></li><li><a class="page-number" href="/page/48/">48</a></li><li class="active"><li><span class="page-number current">49</span></li><li><a class="page-number" href="/page/50/">50</a></li><li><a class="page-number" href="/page/51/">51</a></li><li><a class="page-number" href="/page/52/">52</a></li><li><span class="space">&hellip;</span></li></li><li><a class="page-number" href="/page/161/">161</a></li><li><a class="page-number" href="/page/162/">162</a></li><li><a class="extend next" href="/page/50/">&raquo;</a></li>
  <div class="clearfix"></div>
</ul></div><!--wapper-->
       </div><!-- ID main-col END -->
       <aside id="sidebar" class="alignright col-sx-6 col-sm-4 col-md-3 col-lg-3">
<div id="widget_search" class="widget panel panel-primary">
    <form action="//google.com/search" method="get" accept-charset="utf-8">
  <div class="input-group">
    <input class="form-control" id="searchbox" type="search" name="q" results="0" placeholder="search">
    <span class="input-group-btn">
      <button class="btn btn-default" type="submit">Go!</button>
    </span>
    <input type="hidden" name="q" value="site:itsolife.com">
  </div>
</form>
</div>

<div id="widget_category" class="widget panel panel-primary">
  <div class="panel-heading">category</div>  <div data-src='category' class='ajax_widgets'>正在加载...</div>
</div>

<div id="widget_recent_posts" class="widget panel panel-primary">
  <div class="panel-heading">recent posts</div>  <div data-src='recent_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_tagcloud" class="widget panel panel-primary">
  <div class="panel-heading">tagcloud</div>  <div data-src='tagcloud' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_latest_update_posts" class="widget panel panel-primary">
  <div class="panel-heading">最近更新</div>  <div data-src='latest_update_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_recent_comments" class="widget panel panel-primary">
  <div class="panel-heading">recent comments</div>  

<div class="list-group-item ds-recent-comments" data-num-items="6" data-show-avatars="1" data-show-time="1" data-show-title="1" data-show-admin="1" data-excerpt-length="50"></div>



</div>

</aside>
       <div class="clearfix"></div>
     </div><!-- row END -->
  </div>
  <footer id="footer" class="container">
  <div class="panel panel-info">
  <section id='footer_widget'></section>  <div class="panel-footer">
  <div id="site-info">
    <span class='author'>
  
  &copy; 2014 RobinChia
  
    &nbsp;&nbsp;</span>
  
  <span id='analytics-51la'></span><span id='analytics-google'>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-48559895-1']);
  _gaq.push(['_trackPageview']);
  _js2load.push({src:('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'});
</script></span><span id='analytics-cnzz'>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_5774006'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s17.cnzz.com/stat.php%3Fid%3D5774006%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</span><span id='analytics-baidu'>
<script>
var _hmt = _hmt || [];
_js2load.push({src:"//hm.baidu.com/hm.js?1442f50724afc42380b51f097c43082c"});
</script>
</span>  </div>
  <div id="copyright">Site powered by <a href='http://zespia.tw/hexo/'><strong>hexo</strong></a>  update time: <em>2014-04-07 18:24:57</em></span></div>
</div>
<div class="clearfix"></div>


  </div>
  </footer>
  
        <script src="http://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>        
        <script src="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>        
                
        <script src="http://cdn.bootcss.com/prettify/r298/prettify.min.js"></script>    <script type="text/javascript">
   var lang=["bsh", "c", "cc", "cpp", "cs", "csh", "cyc", "cv", "htm", "html",
    "java", "js", "m", "mxml", "perl", "pl", "pm", "py", "rb", "sh",
    "xhtml", "xml", "xsl"];
   var pretty_base='';
   $('script').each(function(){
	var c = $(this).attr('src');
	if (!c)
	    return;
	if (c.match(/(\/)?prettify(\.min)?\.js/i))
	{
	    var index = c.lastIndexOf('/');
	    if (index != -1)
		pretty_base = c.substr(0,index + 1);
	    return false;
	}
   })
   $('pre code').each(function(){
	var c = $(this).attr('class')
	if (!c)
	    return;
	c = c.match(/\s?(lang\-\w+)/i);
	if (c && lang.indexOf(c[1]) == -1)
	{
	    lang.push(c[1]);
	    $.getScript(pretty_base + c[1] + '.min.js');
	}
   })

    $(window).load(function(){
       $("pre").addClass("prettyprint");
       prettyPrint();
    })
</script>    
            <script type="text/javascript">
var duoshuoQuery = {short_name:"robinchia"};
_js2load.push({src:'http://static.duoshuo.com/embed.js',charset:'UTF-8'});
</script>
    
            <!--wumii_relatedItems-->
    
        <script src="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>    <script type="text/javascript">
(function($){
  $('.entry').each(function(i){
    $(this).find('img').each(function(){
      var alt = this.alt;

      if (alt){
        $(this).before('<span class="caption">' + alt + '</span>');
      }

      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="fancybox' + i + '" />');
    });
  });

  $('.fancybox').fancybox();
})(jQuery);
</script>    
        <script src="http://cdn.bootcss.com/mathjax/2.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>
    
<script type="text/javascript">
$('.ajax_widgets').each(function(){var src=$(this).attr('data-src');if(src)$(this).load('/widgets/'+src+'.html');});
$.each(_js2load,function(index,obj){loadjs(obj.src,obj.charset)});
</script>

<div id="scroll2top">
<img src="/scroll2top/arrow.png"/>
</div>
<script src="/scroll2top/scroll2top.min.js"></script>
<div id="winterland">
  <canvas></canvas>
</div>
<script src="/js/winterland.min.js"></script>

  </body>
</html>
