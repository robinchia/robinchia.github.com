
<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>The 26 Page | It so life</title>
<meta name="author" content="RobinChia">

<meta name="description" content="It so life">


<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta property="og:site_name" content="It so life"/>

<!--[if IE]><style>.testIE.IE{display:inline;}</style><![endif]-->
<!--[if lte IE 7]><link rel="stylesheet" href="/css/ie7.css" type="text/css"><![endif]-->
<!--[if (lt IE 9)&(gt IE 7)]><style>.testIE.IE8{display:inline;}</style><![endif]-->
<!--[if gt IE 8]><style>.testIE.IE9{display:inline;}</style><![endif]-->

<link href="/favicon.png" rel="icon">
<link rel="alternate" href="/atom.xml" title="It so life Feed" type="application/atom+xml">

<link rel="stylesheet" href="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/font-awesome/4.0.3/css/font-awesome.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/prettify/r298/prettify.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" type="text/css">
<link rel="stylesheet" href="/css/style.css" type="text/css">
<!--[if lt IE 9]>
   <style>article,aside,dialog,footer,header,section,footer,nav,figure,menu{display:block}</style>
   <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
   <script src="http://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
<link href="http://cdn.staticfile.org/respond.js/1.4.2/respond-proxy.html" id="respond-proxy" rel="respond-proxy" />
<link href="/js/respond.proxy.gif" id="respond-redirect" rel="respond-redirect" />
<script src="/js/respond.proxy.js"></script>
   <script src="http://cdn.bootcss.com/selectivizr/1.0.2/selectivizr-min.js"></script>
<![endif]-->
<script type="text/javascript">
function loadjs(c,d){var a=document.createElement("script");a.async=!0;a.type="text/javascript";a.src=c;a.charset=d||"gbk";(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(a)};
var _protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
var _js2load = [];
</script>

</head>
<body>
      <header id="header" class="container"><nav id="main-nav" class="navbar navbar-default navbar-fixed-top " role="navigation">
  <div class="container">
    <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/">It so life</a>
    </div>
    <div  class="collapse navbar-collapse">
      <ul  class="nav navbar-nav">
  
        <li><a href="/" title="Home">Home</a></li>      
        <li><a href="/about/" title="About">About</a></li>      
        <li><a href="/archives/" title="Archives">Archives</a></li>      
      <li class='dropdown'>
        <a class='dropdown-toggle' data-toggle='dropdown' href='#'>website<b class='caret'></b></a>
        <ul class='dropdown-menu pure-menu-selected'>
    
          <li><a href="//groups.google.com/forum/#!forum/pongba" title="TopLanguage">TopLanguage</a></li>    
          <li><a href="//itpub.net/" title="ITPub">ITPub</a></li>    
          <li><a href="//blog.jobbole.com/" title="Bole">Bole</a></li>    
          <li><a href="//nosql-database.org/" title="nosql">nosql</a></li>    
          <li><a href="//gitimmersion.googol.im/" title="Git">Git</a></li>    
        </ul>
      </li>
    
      </ul>
      <ul class="nav navbar-nav navbar-right">
      
        <li><a href="/atom.xml">RSS</a></li>
      
      
        <li><a href="https://twitter.com/robinchia">twitter</a></li>
      
      
      
      
        <li><a href="https://github.com/robinchia">github</a></li>
      
      </ul>
    </div>
  </div>
</nav>
<div class="clearfix"></div>
</header>
  <div id='content' class="container">
     <div class="page-header-wrapper">
      <!--[if lt IE 9]><div class="alert alert-warning alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>提示:</strong>您的浏览器版本太低了,建议升级到 <strong><a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" title="IE9">IE9</a></strong> 以上,本站使用<a href="https://www.google.com/intl/zh-CN/chrome/">Chrome浏览器</a>可以获得最好的显示效果.</div><![endif]-->
      <div class="page-header"><h1 align="center"><big>It so life</big> </h1>
        <h5 align="center"><big>love as life</big></h5>
      </div>
     </div>
     <div class="row">
       <div id="main-col" class="alignleft col-sx-12 col-sm-8 col-md-9 col-lg-9">
      <section id='header_widget'></section>
          <div id="wrapper"><article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-服务器-haproxy--HAProxy几个重要的结构体/">HAProxy几个重要的结构体</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:44.000Z"> <a href="/2014/02/02/2014-02-02-服务器-haproxy--HAProxy几个重要的结构体/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="haproxy-">HAProxy几个重要的结构体</h1>
<h1 id="-haproxy-http-tech-uc-cn-p-1738-"><a href="http://tech.uc.cn/?p=1738" target="_blank">HAProxy几个重要的结构体</a></h1>
<p>上一篇文章《<a href="http://tech.uc.cn/?p=1523" target="_blank">HAProxy的event_accept函数源码分析</a>》（以下简称上文）理顺了HAProxy接收客户端连接的主要流程，遗留下相关的基础设施和数据结构没有深入分析，这一篇先介绍几个重要的结构体。</p>
<p>另外要说明的是，本系列文章对HAProxy的分析都基于目前的稳定版本HAProxy 1.4，而目前的开发版本HAProxy 1.5和1.4相比，重构力度比较大，不少函数名称和结构体都发生变化，但是关键流程还是基本一致的，请各位读者留意。</p>
<h1 id="1-session">1. session</h1>
<p>上文讲的其实就是HAProxy怎样在客户端和服务端之间建立一个完整的链路，相关信息都保存到一个session结构体中。原本的session结构体有80行，可以说非常冗长。和上文思路一样，本着不追求旁枝末节，以较小的代价描述HAProxy原理的原则，我把它进行简化，去掉了HTTP处理相关的成员和一些实现额外功能的成员，只把必不可少的成员列出来：</p>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12
13 struct session {</p>
<pre><code>struct list list;         //* position in global sessions list /*/
struct task /*task;        //* the task associated with this session /*/

int conn_retries;         //* number of connect retries left /*/
int flags;                //* some flags describing the session /*/

struct buffer /*req;       //* request buffer /*/
struct buffer /*rep;       //* response buffer /*/

struct stream_interface si[2];     //* client and server stream interfaces /*/
struct sockaddr_storage cli_addr;  //* the client address /*/

struct sockaddr_in srv_addr;       //* the address to connect to /*/
struct server /*srv;       //* the server the session will be running or has been running on /*/

struct server /*prev_srv;  //* the server the was running on, after a redispatch, otherwise NULL /*/
</code></pre><p>};</p>
<p>其中，task、req、rep和si在上文已经有所提及，下面也会有进一步解释；conn_retries、flags、cli_addr和srv_addr甚至不用看注释就明白其意义；srv和prev_srv也很明显，一个指向将要执行或正在执行的后端服务器结构体，一个指向上一次曾经执行的后端服务器结构体。</p>
<p>list也是一个结构体，包含n和p两个指向struct list类型的指针，详见mini-clist.h。它在这里的作用是把各个session结构体串起来，形成 一个双向链表，如下图所示。这是包括HAProxy和Linux内核广泛使用的一种数据结构。我认为用在这里倒不是很必要，不过仍然是一种值得学习的技巧。</p>
<p><a href="http://tech.uc.cn/wp-content/uploads/2013/07/haproxy_sessions.png" target="_blank"><img src="" alt="haproxy_sessions"></a></p>
<p>值得注意的是，这种链表是嵌入到各个结构体中使用，p和n两个指针成员各自指向前、后节点节点的list成员，而非前、后节点本身。</p>
<h1 id="2-task">2. task</h1>
<p>task结构体的主要成员如下：</p>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8 struct task {</p>
<pre><code>struct eb32_node wq;  //* ebtree node used to hold the task in the wait queue /*/
struct eb32_node rq;  //* ebtree node used to hold the task in the run queue /*/

int state;            //* task state : bit field of TASK_/* /*/
int expire;           //* next expiration date for this task, in ticks /*/

struct task /* (/*process)(struct task /*t);  //* the function which processes the task /*/
void /*context;        //* the task&#39;s context /*/
</code></pre><p>};</p>
<p>其中，state和expire都是顾名思义；process是函数指针，根据task的类型会执行不同的处理函数，以后的文章再叙述；context指向与task关联的结构体，在event_accept函数中，context指向的就是session。</p>
<p>重点讲一下wq和rq，它们是两个使用32位键的ebtree节点（以下简称ebnode），分别代表该task与等待队列和运行队列的关系。在第一篇文章《<a href="http://tech.uc.cn/?p=1031" target="_blank">HAProxy的独门武器：ebtree</a>》中，因为没有具体例子印证，有一个关于ebnode的特点没有交代：一个ebnode在ebtree中，当且仅当该ebnode的leaf_p不为空。这一点可以从ebnode的插入、删除操作中推导得出。</p>
<p>因此，判断一个task是否在运行队列中就是：</p>
<p>1</p>
<p>2
3</p>
<p>4 static inline int task_in_rq(struct task /*t)</p>
<p>{
    return t-&gt;rq.node.leaf_p != NULL;</p>
<p>}</p>
<p>同样，判断一个task是否在等待队列中就是：</p>
<p>1</p>
<p>2
3</p>
<p>4 static inline int task_in_wq(struct task /*t)</p>
<p>{
    return t-&gt;wq.node.leaf_p != NULL;</p>
<p>}</p>
<p>从运行队列中删除一个task：</p>
<p>1</p>
<p>2
3</p>
<p>4
5 static inline struct task /<em>__task_unlink_rq(struct task /</em>t)</p>
<p>{
    eb32_delete(&amp;t-&gt;rq);</p>
<pre><code>return t;
</code></pre><p>}</p>
<p>从等待队列中删除一个task，这里有个优化，last_timer指向最后一个入队列的task（稍后再介绍）：</p>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7 static inline struct task /<em>__task_unlink_wq(struct task /</em>t)</p>
<p>{
    eb32_delete(&amp;t-&gt;wq);</p>
<pre><code>if (last_timer == &amp;t-&gt;wq)
    last_timer = NULL;

return t;
</code></pre><p>}</p>
<p>添加task到运行队列，也就是唤醒该task，上文的event_accept函数，最终也是会执行到这里：</p>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8 extern struct task /<em>__task_wakeup(struct task /</em>t)</p>
<p>{
    t-&gt;rq.key = ++rqueue_ticks;</p>
<pre><code>// clear state flags at the same time
t-&gt;state &amp;= ~TASK_WOKEN_ANY;

eb32_insert(&amp;rqueue, &amp;t-&gt;rq);
return t;
</code></pre><p>}</p>
<p>添加task到等待队列，也就是让该task排队，乍看上去有点复杂，其实核心部分就只有两三句，关于last_timer的都是一些优化工作，使得HAProxy更快地找到插入的地方：</p>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12
13</p>
<p>14
15</p>
<p>16
17</p>
<p>18
19</p>
<p>20
21</p>
<p>22
23</p>
<p>24 extern void __task_queue(struct task /*task)</p>
<p>{
    if (likely(task_in_wq(task)))</p>
<pre><code>    __task_unlink_wq(task);


//* the task is not in the queue now /*/
task-&gt;wq.key = task-&gt;expire;


if (likely(last_timer &amp;&amp;

       last_timer-&gt;node.bit &lt; 0 &amp;&amp;
       last_timer-&gt;key == task-&gt;wq.key &amp;&amp;

       last_timer-&gt;node.node_p)) {
    eb_insert_dup(&amp;last_timer-&gt;node, &amp;task-&gt;wq.node);

    if (task-&gt;wq.node.bit &lt; last_timer-&gt;node.bit)
        last_timer = &amp;task-&gt;wq;

    return;
}

eb32_insert(&amp;timers, &amp;task-&gt;wq);


//* Make sure we don&#39;t assign the last_timer to a node-less entry /*/
if (task-&gt;wq.node.node_p &amp;&amp; (!last_timer || (task-&gt;wq.node.bit &lt; last_timer-&gt;node.bit)))

    last_timer = &amp;task-&gt;wq;
return;
</code></pre><p>}</p>
<p>由此可以看出，ebtree函数库在使用上，只负责ebnode的组织，并不负责对ebnode的分配和释放，否则wq和rq就是两个ebnode类型的指针，而不是两个ebnode。这样做是有道理的，利用以上ebnode的特点，一个task可以先后多次挂载到相应的以ebtree为具体设施的队列中，减少了内存分配和释放次数。</p>
<h1 id="3-stream-interface">3. stream interface</h1>
<p>stream interface结构体的主要成员如下：</p>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12
13</p>
<p>14
15</p>
<p>16
17</p>
<p>18
19</p>
<p>20
21 struct stream_interface {</p>
<pre><code>unsigned int state;       //* SI_ST/* /*/
unsigned int prev_state;  //* SI_ST/*, copy of previous state /*/

void /*owner;              //* generally a (struct task/*) /*/
int fd;                   //* file descriptor for a stream driver when known /*/

unsigned int flags;
unsigned int exp;         //* wake up time for connect, queue, turn-around, ... /*/

void (/*update)(struct stream_interface /*);     //* I/O update function /*/
void (/*shutr)(struct stream_interface /*);      //* shutr function /*/

void (/*shutw)(struct stream_interface /*);      //* shutw function /*/
void (/*chk_rcv)(struct stream_interface /*);    //* chk_rcv function /*/

void (/*chk_snd)(struct stream_interface /*);    //* chk_snd function /*/
int (/*connect)(struct stream_interface /*, struct proxy /*, struct server /*,

   struct sockaddr /*, struct sockaddr /*);      //* connect function if any /*/
void (/*iohandler)(struct stream_interface /*);  //* internal I/O handler when embedded /*/

struct buffer /*ib, /*ob;   //* input and output buffers /*/
unsigned int err_type;    //* first error detected, one of SI_ET_/* /*/

void /*err_loc;            //* commonly the server, NULL when SI_ET_NONE /*/
void /*private;            //* may be used by any function above /*/

unsigned int st0, st1;    //* may be used by any function above /*/
</code></pre><p>};</p>
<p>大部分成员可以从注释中了解其用途，值得注意的是几个函数指针。大致上，它们可以指向两组函数：默认一组是以stream<em>sock</em>开头，用于在socket与缓冲区之间传输数据，转发处理业务流；另一组是以stream<em>int</em>开头，负责拦截、统计和响应客户端的监控请求，因为HAProxy的业务请求与监控请求是发送到同一个端口，通过URI来区分的，而监控请求显然是不能转发到后端服务器的，所以必须在获得各计数器数据后返回客户端。</p>
<p>以下简述一下stream<em>sock</em>开头的那一组函数的作用。这一组函数在上文的event_accept函数中初始化。
update指向的函数（stream_sock_data_finish）用于更新stream interface的fd的读写状态和相关标志位。
shutr和shutw指向的函数（stream_sock_shutr和stream_sock_shutw）分别用于关闭stream interface上的读和写。
chk_rcv指向的函数（stream_sock_chk_rcv）由消费者调用，用于通知生产者：缓冲区可能有空间了。
chk_snd指向的函数（stream_sock_chk_snd）由生产者调用，用于通知消费者：缓冲区可能有数据了。
当si是客户端stream interface时，connect为空，因为客户端连接显然已经建立。
当si是服务端stream interface时，connect指向HAProxy与服务端建立连接的那个函数（tcpv4_connect_server），而它会在backend.c的connect_server执行时被调用。
iohandler总是为空。</p>
<p>stream<em>int</em>开头的那一组函数在stream_interface.c的stream_int_register_handler函数中初始化，而该函数只有在监控分支才会执行。最明显区别是这一组会设置iohandler，而且调用时会重新唤醒所属的task，调用后马上返回，不再向下处理，如下所示：</p>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12
13</p>
<p>14
15</p>
<p>16
17</p>
<p>18
19 struct task /<em>process_session(struct task /</em>t)</p>
<p>{
    ...</p>
<pre><code>//* Call the second stream interface&#39;s I/O handler if it&#39;s embedded.
 /* Note that this one may wake the task up again.

 /*/
if (s-&gt;req-&gt;cons-&gt;iohandler) {

    s-&gt;req-&gt;cons-&gt;iohandler(s-&gt;req-&gt;cons);
    if (task_in_rq(t)) {

        //* If we woke up, we don&#39;t want to requeue the
         /* task to the wait queue, but rather requeue

         /* it into the runqueue ASAP.
         /*/

        t-&gt;expire = TICK_ETERNITY;
        return t;

    }
}

...
</code></pre><p>}</p>
<h1 id="4-buffer">4. buffer</h1>
<p>完整的buffer结构体如下：</p>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12
13</p>
<p>14
15</p>
<p>16
17</p>
<p>18
19</p>
<p>20
21</p>
<p>22
23 struct buffer {</p>
<pre><code>unsigned int flags;             //* BF_/* /*/
int rex;                        //* expiration date for a read, in ticks /*/

int wex;                        //* expiration date for a write or connect, in ticks /*/
int rto;                        //* read timeout, in ticks /*/

int wto;                        //* write timeout, in ticks /*/
int cto;                        //* connect timeout, in ticks /*/

unsigned int l;                 //* data length /*/
char /*r, /*w, /*lr;               //* read ptr, write ptr, last read /*/

unsigned int size;              //* buffer size in bytes /*/
unsigned int send_max;          //* number of bytes the sender can consume om this buffer, &lt;= l /*/

unsigned int to_forward;        //* number of bytes to forward after send_max without a wake-up /*/
unsigned int analysers;         //* bit field indicating what to do on the buffer /*/

int analyse_exp;                //* expiration date for current analysers (if set) /*/
void (/*hijacker)(struct session /*, struct buffer /*); //* alternative content producer /*/

unsigned char xfer_large;       //* number of consecutive large xfers /*/
unsigned char xfer_small;       //* number of consecutive small xfers /*/

unsigned long long total;       //* total data read /*/
struct stream_interface /*prod;  //* producer attached to this buffer /*/

struct stream_interface /*cons;  //* consumer attached to this buffer /*/
struct pipe /*pipe;              //* non-NULL only when data present /*/

char data[0];                   //* &lt;size&gt; bytes /*/
</code></pre><p>};</p>
<p>可以看到，HAProxy的buffer结构体也由许多成员组成，常规buffer该有的一个都不少，例如size、data、l、r、w、lr等等，除此之外，还有具有HAProxy特有的生产者、消费者stream interface指针（prod和cons），还有众多表示读写过期时间、超时时间的成员，还有指示具体请求响应解析过程的标志位（analysers），还有回调函数hijacker（不过看起来没有使用），还有表示该buffer最多能向其消费者发送多少字节的send_max，还有在HTTP chunked格式转发时才有意义的to_forward，还有连续满负荷传输数据和连续低负荷传输数据的计数器（xfer_large和xfer_small），以触发判断是否使用splice系统调用。面对把这么多功能揽于一身的buffer，看你晕不晕！</p>
<p>下面只挑一些具有通用借鉴意义的成员提及一下。</p>
<p>最后的那个成员data[0]是一个“零长度数组”，不懂的google一下就知道了，很简单，不多说。</p>
<h1 id="5-pipe">5. pipe</h1>
<p>buffer的倒数第二个成员pipe指针，指向的是这么一个链表结构：</p>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6 struct pipe {</p>
<pre><code>int data;   //* number of bytes present in the pipe  /*/
int prod;   //* FD the producer must write to ; -1 if none /*/

int cons;   //* FD the consumer must read from ; -1 if none /*/
struct pipe /*next;
</code></pre><p>};</p>
<p>因为splice系统调用要求输入和输出至少必须有一个描述符是管道符，所以，HAProxy准备了一对管道符（prod和cons）。当使用splice读数据时，HAProxy从源socket描述符（对于请求，就是连接客户端与HAProxy的socket描述符，对于响应，则是连接服务端与HAProxy的socket 描述符；下面的目的socket描述符刚好相反）splice到管道符prod；当使用splice写数据时，HAProxy从管道符cons splice到目的socket描述符。详见stream_socket.c的stream_sock_splice_in函数和stream_sock_write_loop函数：</p>
<p>1</p>
<p>2
3</p>
<p>4
5</p>
<p>6
7</p>
<p>8
9</p>
<p>10
11</p>
<p>12
13</p>
<p>14
15 static int stream_sock_splice_in(struct buffer /<em>b, struct stream_interface /</em>si)</p>
<p>{
    ...</p>
<pre><code>ret = splice(fd, NULL, b-&gt;pipe-&gt;prod, NULL, max,
        SPLICE_F_MOVE|SPLICE_F_NONBLOCK);

...
</code></pre><p>}</p>
<p>static int stream_sock_write_loop(struct stream_interface /<em>si, struct buffer /</em>b)</p>
<p>{
    ...</p>
<pre><code>ret = splice(b-&gt;pipe-&gt;cons, NULL, si-&gt;fd, NULL, b-&gt;pipe-&gt;data,
        SPLICE_F_MOVE|SPLICE_F_NONBLOCK);

...
</code></pre><p>}</p>
<p>这样一来，每个buffer就要创建一对管道符，从上文和上面的分析可知，每个session就有两个buffer，而每个session的生命周期是从客户端连接建立到客户端连接释放（这里之前没有提到，以后可能会讲一下），所以，如果并发量很大，这是一个巨大的消耗。为此，HAProxy用管道池来解决这一问题，就像内存池的使用那样，需要有一个next指针把pipe结构体串起来。具体流程是，读取数据之前，调用get_pipe函数获取一对管道符，全部数据写完之后（由data指示数据是否写完），调用put_pipe函数进行释放，这样管道只会在异步等待写的时候被占用，大大减少使用量，从而减少系统开销。详见上面两个函数的代码。</p>
<h1 id="6-">6. 小结</h1>
<p>五个我认为比较重要的结构体就介绍到这里。当然，HAProxy还有许多结构体，例如proxy、server、listener等等，不过，这些结构体，要么比较容易看懂，要么网上已经有比较齐全的资料，要么可以陆续在后面的文章中单独说明。而session、task、stream interface、buffer和pipe这五个结构体，连同第一篇介绍的ebtree，向我们展现了HAProxy作为一个高性能代理服务器的底层数据组织和一些重要的处理细节。</p>
<h3 id="-">您可能感兴趣的文章</h3>
<ul>
<li><a href="http://tech.uc.cn/?p=1523" target="_blank">HAProxy的event_accept函数源码分析</a></li>
<li><a href="http://tech.uc.cn/?p=1031" target="_blank">HAProxy的独门武器：ebtree</a></li>
<li><a href="http://tech.uc.cn/?p=965" target="_blank">Nginx使用ETag功能的分析</a></li>
</ul>
<p>来源： <a href="[http://tech.uc.cn/?p=1738](http://tech.uc.cn/?p=1738)">[http://tech.uc.cn/?p=1738](http://tech.uc.cn/?p=1738)</a></p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/服务器/">服务器</a></li></span><span class="breadcrumb"><li><a href="/categories/服务器/">服务器</a></li><li><a href="/categories/服务器/haproxy/">haproxy</a></li></span></span> | <span class="tags">Tagged <a href="/tags/haproxy/" class="label label-primary">haproxy</a><a href="/tags/服务器/" class="label label-success">服务器</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:45"datetime="2014-03-07 09:54:45"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-服务器-haproxy--HAProxy几个重要的结构体/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-服务器-haproxy--HAProxy几个重要的结构体" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-服务器-haproxy--haproxy解决多主机session共享问题的三种方法/">haproxy 解决 多主机session共享问题 的三种方法</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:44.000Z"> <a href="/2014/02/02/2014-02-02-服务器-haproxy--haproxy解决多主机session共享问题的三种方法/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="haproxy-session-">haproxy 解决 多主机session共享问题 的三种方法</h1>
<p>haproxy 解决 多主机session共享问题 的三种方法</p>
<p>1 session知识储备
2 haproxy三种方法保持客户端session一致
3 实验环境及结构
4 安装配置及管理
5 本实验中使用到相同的index.php代码
6 联系方法及扩展阅读
感谢 不就是要我命 QQ 47034839 提供测试主机 
1 session知识储备
Session是由应用服务器维持的一个服务器端的存储空间，用户在连接服务器时，会由服务器生成一个唯一的SessionID,用该SessionID 为标识符来存取服务器端的Session存储空间。
而SessionID这一数据则是保存到客户端，用Cookie保存的，用户提交页面时，会将这一 SessionID提交到服务器端，来存取Session数据。
服务器也通过URL重写的方式来传递SessionID的值，因此不是完全依赖Cookie。如果客户端Cookie禁用，则服务器可以自动通过重写URL的方式来保存Session的值，并且这个过程对程序员透明。
php.ini 里几个session相关值的 其它的值请参考《PHP与Mysql5程序设计》
session.use_cookies = 1  /#表示 服务端和客户端交互session是通过cookie的方式 默认值
session.name = 9ai9     /#默认值是PHPSESSID 我这里改成9ai9是为了和默认值区别
session.cache_limiter = nocache /#此设置确保对每个请求，在可能提供缓存的版本前，先请求发送到最初的服务器。这个值联系到下文中 cookie识别中的相关参数
2 haproxy三种方法保持客户端session一致
  2.1 用户IP 识别 </p>
<p>haroxy 将用户IP经过hash计算后 指定到固定的真实服务器上（类似于nginx 的IP hash 指令）
配置指令        balance source
实例访问<a href="http://sourceip.9ai9.net:8080/" target="_blank"><a href="http://sourceip.9ai9.net:8080">http://sourceip.9ai9.net:8080</a></a>
  2.2 cookie 识别<br>haproxy 将WEB服务端发送给客户端的cookie中插入(或添加加前缀)haproxy定义的后端的服务器COOKIE ID。
配置指令例举  cookie  SESSION_COOKIE  insert indirect nocache
<a href="http://cookie.9ai9.net:8080/" target="_blank"><a href="http://cookie.9ai9.net:8080">http://cookie.9ai9.net:8080</a></a>
用firebug可以观察到用户的请求头的cookie里 有类似&quot; Cookie 9ai9=0bc588656ca05ecf7588c65f9be214f5; SESSION_COOKIE=12&quot; SESSION_COOKIE=12就是haproxy添加的内容
  2.3 session 识别<br>haproxy 将后端服务器产生的session和后端服务器标识存在haproxy中的一张表里。客户端请求时先查询这张表。
配置指令例举 appsession 9ai9 len 64 timeout 5h request-learn 
注意 9ai9 这个值替换成 你的php.ini 里session.name的值。
实例访问 <a href="http://appsession.9ai9.net:8080/" target="_blank"><a href="http://appsession.9ai9.net:8080">http://appsession.9ai9.net:8080</a></a>
  2.4 只做简单轮询对比 
实例访问 <a href="http://nosession.9ai9.net:8080/" target="_blank"><a href="http://nosession.9ai9.net:8080">http://nosession.9ai9.net:8080</a></a>
3 实验环境及结构
CentOS 5.3 64
haproxy  113.106.185.245
WEB1 REALsrv_70  184.82.239.70
WEB2  REALsrv_120 220.162.237.120<br>4 安装配置及管理
useradd -M -s /sbin/nologin haproxy
wget <a href="http://haproxy.1wt.eu/download/1.4/src/haproxy-1.4.13.tar.gz" target="_blank"><a href="http://haproxy.1wt.eu/download/1.4/src/haproxy-1.4.13.tar.gz">http://haproxy.1wt.eu/download/1.4/src/haproxy-1.4.13.tar.gz</a></a>
tar zxvf haproxy-1.4.13.tar.gz 
cd haproxy-1.4.13
make TARGET=linux26 PREFIX=/usr/local/haproxy install
mkdir /usr/local/haproxy/conf
vim /usr/local/haproxy/conf/haproxy.cfg</p>
<ol>
<li>global</li>
<li>log     127.0.0.1 local0 info </li>
<li>maxconn 4096</li>
<li>user    haproxy</li>
<li>group   haproxy</li>
<li>daemon</li>
<li>nbproc  1</li>
<li>pidfile /var/run/haproxy.pid</li>
<li>defaults</li>
<li>mode    http</li>
<li>maxconn         2000</li>
<li>contimeout      5000</li>
<li>clitimeout      30000</li>
<li>srvtimeout      30000</li>
<li>option          httplog</li>
<li>option          redispatch</li>
<li>option          abortonclose</li>
<li>retries         3</li>
<li>listen admin_stats</li>
<li>bind 113.106.185.245:443</li>
<li>mode http</li>
<li>log 127.0.0.1 local0 err</li>
<li>stats   uri     /qhappy_stats</li>
<li>stats   realm   9ai9.net\ Qhappy</li>
<li>stats   auth    qhappy:qhappy</li>
<li>stats   refresh   5s </li>
<li>listen site_status</li>
<li>bind 113.106.185.245:445</li>
<li>mode http</li>
<li>log  127.0.0.1 local0 err</li>
<li>monitor-uri     /site_status</li>
<li>frontend  WEB_SITE</li>
<li>bind    0.0.0.0:8080</li>
<li>mode    http</li>
<li>log     global</li>
<li>option  httplog</li>
<li>option  httpclose</li>
<li>option  forwardfor</li>
<li>acl     COOKIE          hdr_reg(host)   -i ^(cookie.9ai9.net)</li>
<li>acl     SOURCE          hdr_reg(host)   -i ^(sourceip.9ai9.net)</li>
<li>acl     APPSESSION      hdr_reg(host)   -i ^(appsession.9ai9.net)</li>
<li>acl     NOSESSION       hdr_reg(host)   -i ^(nosession.9ai9.net)</li>
<li>use_backend COOKIE_srv          if COOKIE</li>
<li>use_backend SOURCE_srv          if SOURCE</li>
<li>use_backend APPSESSION_srv      if APPSESSION</li>
<li>use_backend NOSESSION_srv       if NOSESSION</li>
<li>/#        default_backend ai_server</li>
<li>backend COOKIE_srv</li>
<li>mode    http</li>
<li>cookie  SESSION_COOKIE  insert indirect nocache</li>
<li>server REALsrv_70       184.82.239.70:80 cookie 11 check inter 1500 rise 3 fall 3 weight 1</li>
<li>server REALsrv_120      220.162.237.120:80 cookie 12 check inter 1500 rise 3 fall 3 weight 1</li>
<li>backend SOURCE_srv</li>
<li>mode    http</li>
<li>balance source</li>
<li>server REALsrv_70       184.82.239.70:80 cookie 11 check inter 1500 rise 3 fall 3 weight 1</li>
<li>server REALsrv_120      220.162.237.120:80 cookie 12 check inter 1500 rise 3 fall 3 weight 1</li>
<li>backend APPSESSION_srv</li>
<li>mode    http</li>
<li>appsession 9ai9 len 64 timeout 5h request-learn</li>
<li>server REALsrv_70       184.82.239.70:80 cookie 11 check inter 1500 rise 3 fall 3 weight 1</li>
<li>server REALsrv_120      220.162.237.120:80 cookie 12 check inter 1500 rise 3 fall 3 weight 1
1.</li>
<li>backend NOSESSION_srv</li>
<li>mode    http</li>
<li>balance roundrobin</li>
<li>server REALsrv_70       184.82.239.70:80 cookie 11 check inter 1500 rise 3 fall 3 weight 1</li>
<li>server REALsrv_120      220.162.237.120:80 cookie 12 check inter 1500 rise 3 fall 3 weight 1</li>
<li>backend ai_server</li>
<li>mode    http</li>
<li>balance roundrobin</li>
<li>cookie  SERVERID</li>
<li>server REALsrv_70 184.82.239.70:80 cookie 2 check inter 1500 rise 3 fall 3 weight 1</li>
<li>server REALsrv_120 220.162.237.120:80 cookie 1 check inter 1500 rise 3 fall 3 weight 1
<em>复制代码</em>
haproxy 启动重启等管理脚本
cd /etc/init.d/
wget <a href="http://www.9ai9.net/download/shell/haproxy" target="_blank"><a href="http://www.9ai9.net/download/shell/haproxy">http://www.9ai9.net/download/shell/haproxy</a></a>
chmod 755 haproxy
chkconfig --add haproxy
使用方法 你懂的
/etc/init.d/haproxy {start|stop|status|checkconfig|restart|try-restart|reload|force-reload}
5 本实验中使用到相同的index.php代码 如下</li>
<li>&lt;?php</li>
<li>session_start();</li>
<li>$_SESSION[&#39;time&#39;] =date(&quot;Y:m:d:H:s&quot;,time());</li>
<li>echo &quot;本次访问时间&quot;.&quot;<font color=red>&quot;.$_SESSION[&#39;time&#39;].&quot;</font>&quot;.&quot;<br>&quot;;</li>
<li>echo &quot;访问的服务器地址是&quot;.&quot;<font color=red>&quot;.$_SERVER[&#39;SERVER_ADDR&#39;].&quot;</font>&quot;.&quot;<br>&quot;;</li>
<li>echo &quot;访问的服务器域名是&quot;.&quot;<font color=red>&quot;.$_SERVER[&#39;SERVER_NAME&#39;].&quot;</font>&quot;.&quot;<br>&quot;;</li>
<li>echo &quot;SESSIONNAME是&quot;.&quot;<font color=red>&quot;.session_name().&quot;</font>&quot;.&quot;<br>&quot;;</li>
<li>echo &quot;SESSIONID是&quot;.&quot;<font color=red>&quot;.session_id().&quot;</font>&quot;.&quot;<br>&quot;;</li>
<li>?&gt;
<em>复制代码</em>6 联系方法及扩展阅读
笔者 水煮鱼@溢  微博 <a href="http://t.qq.com/cllxy1234" target="_blank"><a href="http://t.qq.com/cllxy1234">http://t.qq.com/cllxy1234</a></a> 欢迎收听
haproxy 官网 <a href="http://haproxy.1wt.eu/download/1.4/doc/configuration.txt" target="_blank"><a href="http://haproxy.1wt.eu/download/1.4/doc/configuration.txt">http://haproxy.1wt.eu/download/1.4/doc/configuration.txt</a></a>
董旗宇  <a href="http://www.9ai9.net/download/art/HAProxy" target="_blank"><a href="http://www.9ai9.net/download/art/HAProxy">http://www.9ai9.net/download/art/HAProxy</a></a>配置使用说明.pdf<br>刘天斯  <a href="http://blog.liuts.com/post/223/" target="_blank"><a href="http://blog.liuts.com/post/223/">http://blog.liuts.com/post/223/</a></a>
linuxtone <a href="http://bbs.linuxtone.org/thread-73-1-1.html" target="_blank"><a href="http://bbs.linuxtone.org/thread-73-1-1.html">http://bbs.linuxtone.org/thread-73-1-1.html</a></a></li>
</ol>
<p>来源： <a href="[http://bbs.linuxtone.org/thread-9526-1-1.html](http://bbs.linuxtone.org/thread-9526-1-1.html)">[http://bbs.linuxtone.org/thread-9526-1-1.html](http://bbs.linuxtone.org/thread-9526-1-1.html)</a></p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/服务器/">服务器</a></li></span><span class="breadcrumb"><li><a href="/categories/服务器/">服务器</a></li><li><a href="/categories/服务器/haproxy/">haproxy</a></li></span></span> | <span class="tags">Tagged <a href="/tags/haproxy/" class="label label-primary">haproxy</a><a href="/tags/服务器/" class="label label-success">服务器</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:44"datetime="2014-03-07 09:54:44"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-服务器-haproxy--haproxy解决多主机session共享问题的三种方法/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-服务器-haproxy--haproxy解决多主机session共享问题的三种方法" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-服务器-Squid--一张图讲清楚高可用、高性能、可扩展的WEB系统架构_移动Labs/">一张图讲清楚高可用、高性能、可扩展的WEB系统架构_移动Labs</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:44.000Z"> <a href="/2014/02/02/2014-02-02-服务器-Squid--一张图讲清楚高可用、高性能、可扩展的WEB系统架构_移动Labs/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="-web-_-labs">一张图讲清楚高可用、高性能、可扩展的WEB系统架构_移动Labs</h1>
<p>体验更多Labs的内容请先登录！
如果您还未注册，现在<a href="http://labs.chinamobile.com/members/register.php" target="_blank">马上注册</a>吧！</p>
<p>关 闭</p>
<p><a href="&quot;设为首页&quot;">设为首页</a></p>
<p>|
<a href="http://labs.chinamobile.com/invite/index.php?action=invite&amp;from=site" title="邀请" target="_blank">邀请</a></p>
<p>|
<a href="http://labs.chinamobile.com/foot/connect.php" title="提提建议" target="_blank">提提建议</a></p>
<p>|
<a href="http://labs.chinamobile.com/m" title="手机版" target="_blank">手机版</a></p>
<p>|</p>
<p>language<img src="" alt=""></p>
<ul>
<li>中文</li>
<li>English</li>
<li>日本語</li>
<li>Español
全站 轻博客 圈子 帖子 报告 视频</li>
</ul>
<p><a href="http://labs.chinamobile.com/mblog/466/189076#" target="_blank">搜 索</a></p>
<p><a href="http://labs.chinamobile.com/mblog/466/189076#" target="_blank">登录</a> | <a href="http://labs.chinamobile.com/members/register.php" target="_blank">注册</a>
<img src="" alt=""></p>
<p><a href="http://labs.chinamobile.com/groups" title="圈子话题" target="_blank">圈子话题:</a></p>
<p><a href="http://labs.chinamobile.com/groups/10318" title="资料" target="_blank">资料</a><a href="http://labs.chinamobile.com/groups/10404" title="热点" target="_blank">热点</a><a href="http://labs.chinamobile.com/groups/11075" title="安卓" target="_blank">安卓</a><a href="http://labs.chinamobile.com/cloud/groups" title="大云圈" target="_blank">大云圈</a><a href="http://labs.chinamobile.com/groups/60?quan" title="LTE圈" target="_blank">LTE圈</a><a href="http://labs.chinamobile.com/groups/11279" title="开发者圈" target="_blank">开发者圈</a></p>
<p><a href="http://labs.chinamobile.com/mblog" title="博客聚焦" target="_blank">博 客聚焦:</a></p>
<p><a href="http://labs.chinamobile.com/mblog/newest" title="最新博文" target="_blank">最 新博文</a><a href="http://labs.chinamobile.com/channel/4296492192" title="嘉年华名博" target="_blank">嘉年华名博</a><a href="http://labs.chinamobile.com/channel/4296489734" title="行业名博" target="_blank">行业名博</a><a href="http://labs.chinamobile.com/mblog/mobile" title="移动人博客" target="_blank">移动人博客</a>
<a href="http://labs.chinamobile.com/channel/4296491837" title="子门户" target="_blank">子 门 户:</a></p>
<p><a href="http://labs.chinamobile.com/lte/" title="LTE" target="_blank">LTE</a><a href="http://labs.chinamobile.com/price" title="资费" target="_blank">资费</a><a href="http://labs.chinamobile.com/cloud" title="云计算" target="_blank">云计算</a><a href="http://labs.chinamobile.com/ims" title="IMS" target="_blank">IMS</a><a href="http://labs.chinamobile.com/iot" title="物联网" target="_blank">物联网</a><a href="http://labs.chinamobile.com/mpay" title="手机支付" target="_blank">手机支付</a><a href="http://labs.chinamobile.com/channel/bae" title="BAE" target="_blank">BAE</a></p>
<p><a href="http://labs.chinamobile.com/zhaopin/shehui/" title="研究院社会招聘" target="_blank">研究院社 会招聘</a><a href="http://labs.chinamobile.com/cmui/" title="移动用户体验​专区" target="_blank">移动用户体验​专区</a></p>
<p><a href="http://labs.chinamobile.com/events/" title="Labs活动" target="_blank">Labs活动:</a></p>
<p><a href="http://labs.chinamobile.com/mblog/858835" title="IMIC大会创新访谈" target="_blank">IMIC大会创新访谈</a>
<a href="http://labs.chinamobile.com/channel/2" title="行业热点" target="_blank">行业热点:</a></p>
<p><a href="http://labs.chinamobile.com/channel/4296489244" title="资讯" target="_blank">资讯</a><a href="http://labs.chinamobile.com/channel/10" title="运营商" target="_blank">运营 商</a><a href="http://labs.chinamobile.com/channel/14" title="互联网" target="_blank">互联网</a><a href="http://labs.chinamobile.com/channel/4295993286" title="政策" target="_blank">政策</a>
<a href="http://labs.chinamobile.com/" target="_blank"><img src="" alt=""></a></p>
<p><a href="http://labs.chinamobile.com/rss" target="_blank">RSS</a></p>
<p><a href="http://labs.chinamobile.com/mblog/466/189076#" target="_blank"><img src="" alt=""></a></p>
<p>体验更多Labs的内容请先登录！
如果您还未注册，现在<a href="http://labs.chinamobile.com/members/register.php" target="_blank">马上注册</a>吧！</p>
<p>关 闭</p>
<p>*</p>
<ul>
<li>[首页</li>
</ul>
<p><img src="http://labs.chinamobile.com/" alt="]()
"></p>
<ul>
<li><a href="http://labs.chinamobile.com/channel/2" target="_blank">推荐频道</a></li>
<li><a href="http://labs.chinamobile.com/channel/4294968272" target="_blank">媒体扫描</a></li>
<li><a href="http://labs.chinamobile.com/channel/4296492196" target="_blank">科技名人扫描</a></li>
<li><a href="http://labs.chinamobile.com/channel/4295990173" target="_blank">移动互联网</a></li>
<li><a href="http://labs.chinamobile.com/channel/4296002773" target="_blank">手机操作系统</a></li>
<li><a href="http://labs.chinamobile.com/channel/4295988725" target="_blank">创新终端</a></li>
<li><a href="http://labs.chinamobile.com/channel/4296010806" target="_blank">LBS</a></li>
<li><a href="http://labs.chinamobile.com/channel/4295988878" target="_blank">市场营销</a></li>
<li><a href="http://labs.chinamobile.com/channel/4296492036" target="_blank">供应链</a></li>
<li>[轻博客</li>
</ul>
<p><img src="http://labs.chinamobile.com/mblog" alt="]()
"></p>
<ul>
<li><a href="http://labs.chinamobile.com/mblog" target="_blank">轻博客首页</a></li>
<li><a href="http://labs.chinamobile.com/mblog/466/189076#" target="_blank">我的轻博客</a></li>
<li>[圈子</li>
</ul>
<p><img src="http://labs.chinamobile.com/groups" alt="]()
"></p>
<ul>
<li><a href="http://labs.chinamobile.com/groups" target="_blank">圈子首页</a></li>
<li><a href="http://labs.chinamobile.com/mblog/466/189076#" target="_blank">我的圈子</a></li>
<li>[秀场</li>
</ul>
<p><img src="" alt="]()
"></p>
<ul>
<li><a href="http://labs.chinamobile.com/lte/" target="_blank">LTE</a></li>
<li><a href="http://labs.chinamobile.com/ophone" target="_blank">OPhone</a></li>
<li><a href="http://labs.chinamobile.com/cloud" target="_blank">云计算SDN</a></li>
<li><a href="http://labs.chinamobile.com/channel/openplatform" target="_blank">开放平台</a></li>
<li><a href="http://labs.chinamobile.com/bae" target="_blank">BAE</a></li>
<li><a href="http://labs.chinamobile.com/UBA" target="_blank">用户调研系统</a></li>
<li><a href="http://labs.chinamobile.com/UBA" target="_blank">用户行为分析系统</a></li>
<li>[报告</li>
</ul>
<p><img src="http://labs.chinamobile.com/report" alt="]()
"></p>
<ul>
<li><a href="http://labs.chinamobile.com/report/reportType/&amp;cateid=84" target="_blank">网络/技术</a></li>
<li><a href="http://labs.chinamobile.com/report/reportType/?cateid=85" target="_blank">市场</a></li>
<li><a href="http://labs.chinamobile.com/report/reportType/?cateid=86" target="_blank">终端</a></li>
<li><a href="http://labs.chinamobile.com/report/reportType/?cateid=87" target="_blank">产品</a></li>
<li><a href="http://labs.chinamobile.com/report/reportType/?cateid=88" target="_blank">设计</a></li>
<li><a href="http://labs.chinamobile.com/report/reportType/?cateid=89" target="_blank">业务</a></li>
<li><a href="http://labs.chinamobile.com/weike" target="_blank">威客</a></li>
<li><a href="http://labs.chinamobile.com/focus/" target="_blank">专题</a></li>
<li><a href="http://labs.chinamobile.com/innobase" target="_blank">创新数据库</a></li>
<li>[研究院讲坛</li>
</ul>
<p><img src="http://labs.chinamobile.com/forum/" alt="]()
"></p>
<ul>
<li><a href="http://labs.chinamobile.com/forum/" target="_blank">无限论坛</a>
*</li>
<li>[关于研究院</li>
</ul>
<p><img src="http://labs.chinamobile.com/cmri" alt="]()
"></p>
<ul>
<li><a href="http://labs.chinamobile.com/cmri/" target="_blank">移动研究院介绍</a></li>
<li><a href="http://labs.chinamobile.com/conference" target="_blank">研究院重大会议</a></li>
<li><a href="http://labs.chinamobile.com/cmri/job.php" target="_blank">研究院招聘信息</a></li>
<li><a href="http://labs.chinamobile.com/cmcclab" target="_blank">研究院实验室</a></li>
<li><a href="http://labs.chinamobile.com/mblog/466/189076#" target="_blank">----部所介绍----</a></li>
<li><a href="http://labs.chinamobile.com/ca" target="_blank">综合部</a></li>
<li><a href="http://labs.chinamobile.com/bd" target="_blank">业务拓展部</a></li>
<li><a href="http://labs.chinamobile.com/br" target="_blank">业务研究所</a></li>
<li><a href="http://labs.chinamobile.com/usrc" target="_blank">美国研究所</a></li>
<li><a href="http://labs.chinamobile.com/imsa" target="_blank">物联网研究院</a></li>
<li><a href="http://labs.chinamobile.com/wt" target="_blank">无线技术研究所</a></li>
<li><a href="http://labs.chinamobile.com/nt" target="_blank">网络技术研究所</a></li>
<li><a href="http://labs.chinamobile.com/imr" target="_blank">产业市场研究所</a></li>
<li><a href="http://labs.chinamobile.com/bst" target="_blank">业务支撑研究所</a></li>
<li><a href="http://labs.chinamobile.com/test_tech" target="_blank">测试技术研究所</a></li>
<li><a href="http://labs.chinamobile.com/terminal_tech" target="_blank">终端技术研究所</a>
*
<a href='http://ads.etentec.com/www/delivery/ck.php?n=a8b65ceb&amp;cb=2138466348' target='_blank'><img src='http://ads.etentec.com/www/delivery/avw.php?zoneid=4&amp;cb=2138466348&amp;n=a8b65ceb' border='0' alt='' /></a></li>
</ul>
<p><a href="http://labs.chinamobile.com/mblog" target="_blank">轻博客首页</a> <a href="http://labs.chinamobile.com/mblog/hotcomment" target="_blank">热门评论</a> <a href="http://labs.chinamobile.com/mblog/hotforward" target="_blank">热门转发</a> <a href="http://labs.chinamobile.com/mblog/hottopic" target="_blank">热门话题</a> <a href="http://labs.chinamobile.com/mblog/all_bloger" target="_blank">全部博主</a></p>
<p>轻博客用户</p>
<pre><code># 一张图讲清楚高可用、高性能、可扩展的WEB系统架构
</code></pre><p>标签： <a href="http://labs.chinamobile.com/mblog/k?sr=1&amp;sf=4&amp;kw=80647" target="_blank">高可用、高性能、可扩展、系统架构、数据库</a></p>
<p>2012-11-27 18:43</p>
<p>前言：最近在与广东互联网基地一起进行无线城市集中平台的建设，在系统设计、架构调优上做了很多的探索，也在系统集成测试和性能调优中遭遇了很多的烦恼，心里有一些所得所悟，希望与大家共同学习探讨。</p>
<p>WEB系统最容易出现性能故障的点在哪里？ 有很多人对此不知其然，或知其然而不知其所以然。</p>
<p>下面这张图，是在一个大型的WEB系统设计中，经典的架构设计和分层模式。</p>
<p><img src="" alt=""></p>
<p>1） 前端负载均衡： 有钱的用硬件四层交换（想当年雅虎中国2000台服务器，只用了四台Alteon就搞定了），没钱的用软件负载均衡（LVS、Nginx）</p>
<p>2） 多级缓存：首先要充分利用浏览器的缓存能力，也就是Cookie，然后要在服务端利用页面缓存机制，前些年大家喜欢用Squid，现在Varnish更流行起来了，有一个牛逼的故事是挪威的最大的在线报纸 Verdens Gang(vg.no) 使用 3 台 Varnish 代替了原来的 12 台 Squid，性能比以前更好，这是 Varnish 最成功的应用案例。 最后一个缓存点是在数据库前方设置，让那些经常需要被查询，但是实时性要求不那么高的数据缓存起来，避免对数据库的频繁查询。三级缓存可以有效的提升整个系统的性能。</p>
<p>3）应用服务器层面：先考虑一下你的静态页面与动态页面的占比，然后考虑一下如何尽量实现动态页面静态化，把静态的部署到Apache上，动态的部署到Tomcat上吧。如果你是一个像Flicker那样的图片共享网站，必须考虑设置单独的图片服务器，这是淘宝血泪史告诉我们的真理。</p>
<p>4）现在要考虑数据库的选型问题了：采用关系型数据库还是非关系型数据库完全取决于你的业务场景，如果你要实现实时要求高，数据一致性要求高的场景，关系型数据库；如果你要实现海量数据的查询和高并发，非关系型数据库（考虑Facebook一张表有一亿用户，如果用关系型数据库查询。磁盘IO也快撑不住了，而非关系型数据库则完全没有这个问题）；</p>
<p>5）数据库性能问题之外务必考虑清楚数据库的并发性能：通常会采用生产数据库与查询数据库分离的方式，也就是著名的MySQL的单主多从服务方式。为了实现高可用性HA，有的网站比如淘宝网，在Master之间也会实现集群部署。</p>
<p>6）数据库集群和库表散列: 上面提到的数据库集群由于在架构,成本,扩张性方面都会受到所采用DB类型的限制,于是我们需要从应用程序的角度来考虑改善系统架构,库表散列是常用并且最有效的解决方案，在应用程序中将数据库进行分离,不同的模块对应不同的数据库或者表,再按照一定的策略对某个页面或者功能进行更小的数据库散列,比如用户表,按照用户 ID 进行表散列,这样就能够低成本的提升系统的性能并.且有很好的扩展性，sohu 的论坛就是采用了这样的架构.</p>
<p>权限：公开   来自：labs</p>
<p><a href="http://labs.chinamobile.com/mblog/466_188550" target="_blank"><strong>&lt;&lt;</strong>上一篇 一张图讲清楚Native APP、WEB ...</a> <a href="http://labs.chinamobile.com/mblog/466_189532" target="_blank">微信蚕食运营商？看国外运营商... 下一篇 <strong>&gt;&gt;</strong></a>
阅读全文：3423 | 转发(0) | 评论(0)</p>
<p>分享到： <a href="&quot;分享到新浪微博&quot;">新浪微博</a> <a href="&quot;分享到搜狐微博&quot;">搜狐微博</a> <a href="&quot;分享到抽屉&quot;">抽屉</a> <a href="http://labs.chinamobile.com/mblog/466/189076#" target="_blank">飞信</a></p>
<p><a href=""></a></p>
<p><img src="" alt="">
  <a href="">全部</a></p>
<p>暂无评论</p>
<p><img src="" alt="">
Labs推荐给你的相关资讯</p>
<p>博文</p>
<ul>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=4537172f51f9d1d9eddfdc15c2l0ZWlkPTEkJGlkZWFsaWQ9MjAkJHVybD1odHRwOi8vbGFil5GRkcajWX1vYmlsZS5jb20vbWJsb2cvODU4ODM1XzE5NDY0OCQuayYlbWlkPWJhNTE0MGVjZTNiZGM1Mjc4ZjllMWUyNzJhMWI0YTU1XzEkJG1faWQ9JCRfc3JjPSQkX2NtPSQkX3A9JCRkcz02OSQkdXVpZD14M21lY3phMHFxdHR2a3Q0NDRrczU4bWFlb2U0bmMycSQkdWlkPSQkY2lkPTIkJGNvZGU9MTM2Njc5MTA3NTE5NTIxOSQk809ea771c311ed63a28c03027d37420f17268f00" target="_blank"><img src="" alt=""></a><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=4537172f51f9d1d9eddfdc15c2l0ZWlkPTEkJGlkZWFsaWQ9MjAkJHVybD1odHRwOi8vbGFil5GRkcajWX1vYmlsZS5jb20vbWJsb2cvODU4ODM1XzE5NDY0OCQuayYlbWlkPWJhNTE0MGVjZTNiZGM1Mjc4ZjllMWUyNzJhMWI0YTU1XzEkJG1faWQ9JCRfc3JjPSQkX2NtPSQkX3A9JCRkcz02OSQkdXVpZD14M21lY3phMHFxdHR2a3Q0NDRrczU4bWFlb2U0bmMycSQkdWlkPSQkY2lkPTIkJGNvZGU9MTM2Njc5MTA3NTE5NTIxOSQk809ea771c311ed63a28c03027d37420f17268f00" target="_blank">王鹏：云计算落地的真正瓶颈在于核心技术的定型_移动Labs</a></li>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=de3ec1716260a10250fb72dcc2l0ZWlkPTEkJGlkZWFsaWQ9MjAkJHVybD1odHRwOi8vbGFilc5QaCGkRY1vYmlsZS5jb20vbWJsb2cvMzg4MDU5XzE5NzcxNWjuaXylbWlkPTdiZDE3N2ViMjMwYzIxNGZjYjY4OTU3Zjk0ZGYyNjI3XzEkJG1faWQ9JCRfc3JjPSQkX2NtPSQkX3A9JCRkcz02OSQkdXVpZD14M21lY3phMHFxdHR2a3Q0NDRrczU4bWFlb2U0bmMycSQkdWlkPSQkY2lkPTIkJGNvZGU9MTM2Njc5MTA3NTE5NTIxOSQk27cec7c8671a96021d186bca3c281439106495df" target="_blank">4G乱局个人浅见_移动Labs</a></li>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=494dd030c91e83f263ab6776c2l0ZWlkPTEkJGlkZWFsaWQ9MjAkJHVybD1odHRwOi8vbGFiaWGyRa5ukQ1vYmlsZS5jb20vbWJsb2cvODU4ODM1XzE5NTY4OjSYlXclbWlkPWZhNjg4MmUxMjVhZDM2YTc5OWFiZDU2MTFhZThjNTQ1XzEkJG1faWQ9JCRfc3JjPSQkX2NtPSQkX3A9JCRkcz02OSQkdXVpZD14M21lY3phMHFxdHR2a3Q0NDRrczU4bWFlb2U0bmMycSQkdWlkPSQkY2lkPTIkJGNvZGU9MTM2Njc5MTA3NTE5NTIxOSQkd82e782c1e501fbfe3ff09daa52ba3349ce1f310" target="_blank">冯宇彦：2013年企业级云应用会滋润哪片土地？_移动Labs</a></li>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=af4df49cf6621cedbf0e47abc2l0ZWlkPTEkJGlkZWFsaWQ9MjAkJHVybD1odHRwOi8vbGFij5ilaGakcX1vYmlsZS5jb20vbWJsb2cvODU4ODM1XzE4MjcxNyYRQWulbWlkPTIxYTY1NTIyN2M3MzEzOWZiM2Y2YzRmZjczZjBmOTdhXzEkJG1faWQ9JCRfc3JjPSQkX2NtPSQkX3A9JCRkcz02OSQkdXVpZD14M21lY3phMHFxdHR2a3Q0NDRrczU4bWFlb2U0bmMycSQkdWlkPSQkY2lkPTIkJGNvZGU9MTM2Njc5MTA3NTE5NTIxOSQkbeadf4be4ffd0fbef12ab93f1f6b1839a24397a3" target="_blank">罗海云：海外取经 TD-LTE发展或可借鉴美运营商经验_移动Labs</a></li>
</ul>
<p>新闻</p>
<ul>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=53ee2c34038f3427b19ac214c2l0ZWlkPTEkJGlkZWFsaWQ9MTkkJHVybD1odHRwOi8vbGFi52BalYlMGj1vYmlsZS5jb20vbmV3cy85MDQ4MSQkaXRlbWlkPuyWNTc2ZWFmNmRiMTdjZDIxNjRkN2Q2NWNjOTA4MWVmXzEkJG1faWQ9JCRfc3JjPSQkX2NtPSQkX3A9JCRkcz02OCQkdXVpZD14M21lY3phMHFxdHR2a3Q0NDRrczU4bWFlb2U0bmMycSQkdWlkPSQkY2lkPTEkJGNvZGU9MTM2Njc5MTA3NTE3OTgyNiQk37b2971db6f9844752c3e943127ce4f62b05077e" target="_blank">巨头争食移动OS切糕：iOS和Android双霸主难超越<em>新闻</em>移动Labs</a></li>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=770d32c122a7c1b9417e4e00c2l0ZWlkPTEkJGlkZWFsaWQ9MTkkJHVybD1odHRwOi8vbGFiTYTjlGyYWu1vYmlsZS5jb20vbmV3cy85MTM4MSQkaXRlbWlkPchaON50YWM4ZDZlNWEyNjJiNGZmMDdjNjI0YzhlZTAwXzEkJG1faWQ9JCRfc3JjPSQkX2NtPSQkX3A9JCRkcz02OCQkdXVpZD14M21lY3phMHFxdHR2a3Q0NDRrczU4bWFlb2U0bmMycSQkdWlkPSQkY2lkPTEkJGNvZGU9MTM2Njc5MTA3NTE3OTgyNiQk59f8567f2046f8307df8051eaafab68ce799fff2" target="_blank">通信互联网产业2012年第四季度财报解读<em>新闻</em>移动Labs</a></li>
<li><p><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=b03501b1c354afcc6ae43589c2l0ZWlkPTEkJGlkZWFsaWQ9MTkkJHVybD1odHRwOi8vbGFilXGllYjuWc1vYmlsZS5jb20vbmV3cy9waG9uZS85MTYzNSQkaaR5bWykPTBmY2UxY2EzNGRiNjIyZTg5Y2EzMTM5ZGI3MjYwN2Y0XzEkJG1faWQ9JCRfc3JjPSQkX2NtPSQkX3A9JCRkcz02OCQkdXVpZD14M21lY3phMHFxdHR2a3Q0NDRrczU4bWFlb2U0bmMycSQkdWlkPSQkY2lkPTEkJGNvZGU9MTM2Njc5MTA3NTE3OTgyNiQk2e4c272f6795a94de905a500cf12132e6af0b11b" target="_blank">无LTE功能的廉价iPhone 6将于6月发布<em>新闻</em>移动Labs</a>
报告</p>
</li>
<li><p><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=9db6bb086ee69cede58eafc2c2l0ZWlkPTEkJGlkZWFsaWQ9MjIkJHVybD1odHRwOi8vbGFi9yZjal5IWW1vYmlsZS5jb20vcmVwb3J0LzkxNDY3JCRpdGVtaGQucTY3YTBiNzIwNjZiMmM2ZWQ4MmY1MTViNzMxYTgyMDBfMSQkbV9pZD0kJF9zcmM9JCRfY209JCRfcD0kJGRzPTcxJCR1dWlkPXgzbWVjemEwcXF0dHZrdDQ0NGtzNThtYWVvZTRuYzJxJCR1aWQ9JCRjaWQ9NiQkY29kZT0xMzY2NzkxMDc1MTgzMzkxJCQ%3D2174375e0d82b060fe711799e8d860ca72dfa02d" target="_blank"><img src="" alt=""></a><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=9db6bb086ee69cede58eafc2c2l0ZWlkPTEkJGlkZWFsaWQ9MjIkJHVybD1odHRwOi8vbGFi9yZjal5IWW1vYmlsZS5jb20vcmVwb3J0LzkxNDY3JCRpdGVtaGQucTY3YTBiNzIwNjZiMmM2ZWQ4MmY1MTViNzMxYTgyMDBfMSQkbV9pZD0kJF9zcmM9JCRfY209JCRfcD0kJGRzPTcxJCR1dWlkPXgzbWVjemEwcXF0dHZrdDQ0NGtzNThtYWVvZTRuYzJxJCR1aWQ9JCRjaWQ9NiQkY29kZT0xMzY2NzkxMDc1MTgzMzkxJCQ%3D2174375e0d82b060fe711799e8d860ca72dfa02d" target="_blank">2012年中国手机安全市场年度报告<em>报告</em>移动Labs</a></p>
</li>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=7af2ab52063d495d223abebcc2l0ZWlkPTEkJGlkZWFsaWQ9MjIkJHVybD1odHRwOi8vbGFic5GIQal2Yu1vYmlsZS5jb20vcmVwb3J0LzkxNjg0JCRpdGVtaW9yWjNwZDUwNzZmYjBhZTAzNDUyYjUyM2ZkMGI1Y2VkZDFfMSQkbV9pZD0kJF9zcmM9JCRfY209JCRfcD0kJGRzPTcxJCR1dWlkPXgzbWVjemEwcXF0dHZrdDQ0NGtzNThtYWVvZTRuYzJxJCR1aWQ9JCRjaWQ9NiQkY29kZT0xMzY2NzkxMDc1MTgzMzkxJCQ%3Da70e1570bed1f5c8406414859ca31cf757ee7b85" target="_blank">2012中国手机游戏市场年度报告<em>报告</em>移动Labs</a></li>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=4e863c5be6336c14c4141d2bc2l0ZWlkPTEkJGlkZWFsaWQ9MjIkJHVybD1odHRwOi8vbGFiT5yYuGaZW91vYmlsZS5jb20vcmVwb3J0Lzg2MDM2JCRpdGVtajcWlQkwOTM1M2FhMWQ0ZGUyMTg4ZTdkY2MwNTRiNTNjYTlfMSQkbV9pZD0kJF9zcmM9JCRfY209JCRfcD0kJGRzPTcxJCR1dWlkPXgzbWVjemEwcXF0dHZrdDQ0NGtzNThtYWVvZTRuYzJxJCR1aWQ9JCRjaWQ9NiQkY29kZT0xMzY2NzkxMDc1MTgzMzkxJCQ%3Dcd8ef2219130bf5c682ef108e280ed7eada09686" target="_blank">中国移动九大基地介绍<em>报告</em>移动Labs</a></li>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=ba257e7600dc9ad0022581e7c2l0ZWlkPTEkJGlkZWFsaWQ9MjIkJHVybD1odHRwOi8vbGFijyGYaclGuF1vYmlsZS5jb20vcmVwb3J0LzgxODU5JCRpdGVta9W5OWQhMGIzOTQzZWEwNDRmNDE1ZDQ4M2M3ZjJiNjJkYmFfMSQkbV9pZD0kJF9zcmM9JCRfY209JCRfcD0kJGRzPTcxJCR1dWlkPXgzbWVjemEwcXF0dHZrdDQ0NGtzNThtYWVvZTRuYzJxJCR1aWQ9JCRjaWQ9NiQkY29kZT0xMzY2NzkxMDc1MTgzMzkxJCQ%3D3804aec72f7073536fe3c13d13ca55772f2e1fb1" target="_blank">物联网行业深度研究报告<em>报告</em>移动Labs</a></li>
</ul>
<p>帖子</p>
<ul>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=c3ff478dd3f558adc03a086dc2l0ZWlkPTEkJGlkZWFsaWQ9MjEkJHVybD1odHRwOi8vbGFilyYjaQGuWX1vYmlsZS5jb20vZ3JvdXBzLzEwOTM0XzI5MjcwM5CcaRklbWlkPWVmODliODAzMjE2MWY4NWEzMjkwZGE0Yjk0ODUzODMyXzEkJG1faWQ9JCRfc3JjPSQkX2NtPSQkX3A9JCRkcz03MCQkdXVpZD14M21lY3phMHFxdHR2a3Q0NDRrczU4bWFlb2U0bmMycSQkdWlkPSQkY2lkPTE1JCRjb2RlPTEzNjY3OTEwNzUxNDU1NzMkJA%3D%3D2dcb59541bc53a8c6a19ece52aed9e38b08eb9bd" target="_blank"><img src="" alt=""></a><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=c3ff478dd3f558adc03a086dc2l0ZWlkPTEkJGlkZWFsaWQ9MjEkJHVybD1odHRwOi8vbGFilyYjaQGuWX1vYmlsZS5jb20vZ3JvdXBzLzEwOTM0XzI5MjcwM5CcaRklbWlkPWVmODliODAzMjE2MWY4NWEzMjkwZGE0Yjk0ODUzODMyXzEkJG1faWQ9JCRfc3JjPSQkX2NtPSQkX3A9JCRkcz03MCQkdXVpZD14M21lY3phMHFxdHR2a3Q0NDRrczU4bWFlb2U0bmMycSQkdWlkPSQkY2lkPTE1JCRjb2RlPTEzNjY3OTEwNzUxNDU1NzMkJA%3D%3D2dcb59541bc53a8c6a19ece52aed9e38b08eb9bd" target="_blank">QQ爱情个性签名,不错的文字<em>花言草语</em>圈子_移动Labs</a></li>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=156e04a511f7e211eacabb78c2l0ZWlkPTEkJGlkZWFsaWQ9MjEkJHVybD1odHRwOi8vbGFicp5jCYGlVW1vYmlsZS5jb20vZ3JvdXBzLzEwNDA0XzIzNDEyJGuadRytaWQ9ODMzZWQ1N2I0YzgzOTMzMWRlYTAxN2Q1Y2U0NTc3YThfMSQkbV9pZD0kJF9zcmM9JCRfY209JCRfcD0kJGRzPTcwJCR1dWlkPXgzbWVjemEwcXF0dHZrdDQ0NGtzNThtYWVvZTRuYzJxJCR1aWQ9JCRjaWQ9MTUkJGNvZGU9MTM2Njc5MTA3NTE0NTU3MyQk7e295494b13a0af6bc937977b846fa7578c2c162" target="_blank">groups_移动Labs</a></li>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=212ee8104a73e10e55ed5602c2l0ZWlkPTEkJGlkZWFsaWQ9MjEkJHVybD1odHRwOi8vbGFiljGauQ5kYy1vYmlsZS5jb20vZ3JvdXBzLzExMzA3XzI5Mjc1MCWXacRlbWlkPTcyN2U0MDAyMjk4YTlhODZjOTY0Yjk1Yjg1ZDZiMTZmXzEkJG1faWQ9JCRfc3JjPSQkX2NtPSQkX3A9JCRkcz03MCQkdXVpZD14M21lY3phMHFxdHR2a3Q0NDRrczU4bWFlb2U0bmMycSQkdWlkPSQkY2lkPTE1JCRjb2RlPTEzNjY3OTEwNzUxNDU1NzMkJA%3D%3D45e8a42cf8e956174f0b370d64649b2d911cce34" target="_blank">你知道最初安卓吉祥物的样子吗?<em>精彩互联网</em>圈子_移动Labs</a></li>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=f6450529d099dd4be0072d61c2l0ZWlkPTEkJGlkZWFsaWQ9MjEkJHVybD1odHRwOi8vbGFiYXkSucQl5j1vYmlsZS5jb20vZ3JvdXBzLzEwNjIxXzI5MjY4NWaaGyRlbWlkPTVkOWQ1MjRiNTUxMWUxZTg5ZGI5MDRkY2JlNmI5MDg0XzEkJG1faWQ9JCRfc3JjPSQkX2NtPSQkX3A9JCRkcz03MCQkdXVpZD14M21lY3phMHFxdHR2a3Q0NDRrczU4bWFlb2U0bmMycSQkdWlkPSQkY2lkPTE1JCRjb2RlPTEzNjY3OTEwNzUxNDU1NzMkJA%3D%3Dabeb8c1e329464fc943c0a3445c581bc723e3b6a" target="_blank">iPhone被偷找回方法大集合<em>移动苹果派</em>圈子_移动Labs</a></li>
</ul>
<p>看过此博文的还看过</p>
<ul>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=1e74a612f7d72481e1a894dfc2l0ZWlkPTEkJGlkZWFsaWQ9MjMkJHVybD1odHRwOi8vbGFiNzyjmlWu5a1vYmlsZS5jb20vbmV3cy85MTczNyQkaXRlbWlkPgRYWGc0MThmMGZkMTI5YTU1MTRiODIzZTc5YmViNWUzXzEkJG1faWQ9JCRfc3JjPSQkX2NtPSQkX3A9JCRkcz00MSQkdXVpZD14M21lY3phMHFxdHR2a3Q0NDRrczU4bWFlb2U0bmMycSQkdWlkPSQkY2lkPTEkJGNvZGU9MTM2Njc5MTA3NTEyNDQzNSQk842efd61cc1949c9484f5ba8df0a655fc8792bb6" target="_blank">【Labs专题】中国移动2012年度财报解读<em>新闻</em>移动Labs</a></li>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=2085249eaa495a72603d8920c2l0ZWlkPTEkJGlkZWFsaWQ9MjMkJHVybD1odHRwOi8vbGFiuGyW0YlWjl1vYmlsZS5jb20vbWJsb2cvNzUzOV8xOTcwMzAkJcZa5G1pZD00ZDg1ZTVlM2ExNGI2YzcxYmI1ODI2MWFjNTFkMDQwNV8xJCRtX2lkPSQkX3NyYz0kJF9jbT0kJF9wPSQkZHM9NDEkJHV1aWQ9eDNtZWN6YTBxcXR0dmt0NDQ0a3M1OG1hZW9lNG5jMnEkJHVpZD0kJGNpZD0yJCRjb2RlPTEzNjY3OTEwNzUxMjQ0MzUkJA%3D%3Dbe1640a9ba384323aa386022b30bb91a0a6c17ea" target="_blank">流量爆发，中国移动战略转型已见成效_移动Labs</a></li>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=72c8eb94e8dcd4e8129e0e51c2l0ZWlkPTEkJGlkZWFsaWQ9MjMkJHVybD1odHRwOi8vbGFiI5WQyGYT9Z1vYmlsZS5jb20vcmVwb3J0LzkxNDY3JCRpdGVtaWaulcj3YTBiNzIwNjZiMmM2ZWQ4MmY1MTViNzMxYTgyMDBfMSQkbV9pZD0kJF9zcmM9JCRfY209JCRfcD0kJGRzPTQxJCR1dWlkPXgzbWVjemEwcXF0dHZrdDQ0NGtzNThtYWVvZTRuYzJxJCR1aWQ9JCRjaWQ9NiQkY29kZT0xMzY2NzkxMDc1MTI0NDM1JCQ%3D8ade6b20abc168fd60f06c857f3c66dfbc42c983" target="_blank">2012年中国手机安全市场年度报告<em>报告</em>移动Labs</a></li>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=cd9dc175acae9477db3b5b51c2l0ZWlkPTEkJGlkZWFsaWQ9MjMkJHVybD1odHRwOi8vbGFiYCjaGydGuc1vYmlsZS5jb20vbWJsb2cvMTE0NzVfMTk2NDIxJRlpW5VtaWQ9YWNiZWM0YjVhMzFlZjEwYTZkNDc0NDk4N2Y4NGUwNTZfMSQkbV9pZD0kJF9zcmM9JCRfY209JCRfcD0kJGRzPTQxJCR1dWlkPXgzbWVjemEwcXF0dHZrdDQ0NGtzNThtYWVvZTRuYzJxJCR1aWQ9JCRjaWQ9MiQkY29kZT0xMzY2NzkxMDc1MTI0NDM1JCQ%3D181d2c0ff478439a7e93badc50a415802d476c7b" target="_blank">全球4G资费的几个特点（语音篇）_移动Labs</a></li>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=7d96f309964dd76c22b821f0c2l0ZWlkPTEkJGlkZWFsaWQ9MjMkJHVybD1odHRwOi8vbGFiGNWYjI9yQl1vYmlsZS5jb20vcmVwb3J0LzkxNjg0JCRpdGVtaWcau25wZDUwNzZmYjBhZTAzNDUyYjUyM2ZkMGI1Y2VkZDFfMSQkbV9pZD0kJF9zcmM9JCRfY209JCRfcD0kJGRzPTQxJCR1dWlkPXgzbWVjemEwcXF0dHZrdDQ0NGtzNThtYWVvZTRuYzJxJCR1aWQ9JCRjaWQ9NiQkY29kZT0xMzY2NzkxMDc1MTI0NDM1JCQ%3D65bfeb5174eb6a2ca1e6f9578178374491f975b2" target="_blank">2012中国手机游戏市场年度报告<em>报告</em>移动Labs</a></li>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=31427ec5350597f723e79b96c2l0ZWlkPTEkJGlkZWFsaWQ9MjMkJHVybD1odHRwOi8vbGFiG5cpadCWYG1vYmlsZS5jb20vbWJsb2cvMzIxMzlfMTk2OTIwJyjuRVltaWQ9Mjc2NDMxNzgyMDAyOTI2ZjRmNDI2NDkzOTgzZmNmY2VfMSQkbV9pZD0kJF9zcmM9JCRfY209JCRfcD0kJGRzPTQxJCR1dWlkPXgzbWVjemEwcXF0dHZrdDQ0NGtzNThtYWVvZTRuYzJxJCR1aWQ9JCRjaWQ9MiQkY29kZT0xMzY2NzkxMDc1MTI0NDM1JCQ%3D8103c427c465b5998f3aaaaed3c3e1a7e5b3a232" target="_blank">希望和挑战——中国移动2012年年报点评_移动Labs</a></li>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=3ba4546762e6544119ed1b1ec2l0ZWlkPTEkJGlkZWFsaWQ9MjMkJHVybD1odHRwOi8vbGFiyclj1uW5Ya1vYmlsZS5jb20vbWJsb2cvNzUzOV8xOTY5MjIkJG0GWZlpZD01ZjdkMmJkY2Y4ZDc3Nzk4YmVjYjA5Mzk3OWVmMDM0Ml8xJCRtX2lkPSQkX3NyYz0kJF9jbT0kJF9wPSQkZHM9NDEkJHV1aWQ9eDNtZWN6YTBxcXR0dmt0NDQ0a3M1OG1hZW9lNG5jMnEkJHVpZD0kJGNpZD0yJCRjb2RlPTEzNjY3OTEwNzUxMjQ0MzUkJA%3D%3D75d575bca2fb005dc24232c02f5ffb59b7f1cbbd" target="_blank">TD-LTE试商用开闸在望，中移动前景乐观_移动Labs</a></li>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=8af41e6c2db811b6976f1196c2l0ZWlkPTEkJGlkZWFsaWQ9MjMkJHVybD1odHRwOi8vbGFilGaWyYku5R1vYmlsZS5jb20vbWJsb2cvMzg4MDU5XzE5NjkyNycjaXQlbWlkPTJiOWE3MzdlZGQ0NmYyNjZlYWZhMjc0ZmZmNWM2OGRlXzEkJG1faWQ9JCRfc3JjPSQkX2NtPSQkX3A9JCRkcz00MSQkdXVpZD14M21lY3phMHFxdHR2a3Q0NDRrczU4bWFlb2U0bmMycSQkdWlkPSQkY2lkPTIkJGNvZGU9MTM2Njc5MTA3NTEyNDQzNSQkd248aeaa60f18c6bbe13da06a4b87631953826c8" target="_blank">知者不惑，仁者不忧，勇者不惧——中国移动2012年度业绩报告解读_移动Labs</a></li>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=d530e1acfe84fca26b7b75ccc2l0ZWlkPTEkJGlkZWFsaWQ9MjMkJHVybD1odHRwOi8vbGFilW5jauGlXW1vYmlsZS5jb20vbmV3cy9waG9uZS85MTYzNSQkabylYcRkPTBmY2UxY2EzNGRiNjIyZTg5Y2EzMTM5ZGI3MjYwN2Y0XzEkJG1faWQ9JCRfc3JjPSQkX2NtPSQkX3A9JCRkcz00MSQkdXVpZD14M21lY3phMHFxdHR2a3Q0NDRrczU4bWFlb2U0bmMycSQkdWlkPSQkY2lkPTEkJGNvZGU9MTM2Njc5MTA3NTEyNDQzNSQk91a43ec3c598d63266ab2e0266ef1f5d2e1d45e1" target="_blank">无LTE功能的廉价iPhone 6将于6月发布<em>新闻</em>移动Labs</a></li>
<li><a href="http://analytics.labs.chinamobile.com/recom/rcv.php?url=4d3e465ce036046704afd023c2l0ZWlkPTEkJGlkZWFsaWQ9MjMkJHVybD1odHRwOi8vbGFiulpGGV5YyW1vYmlsZS5jb20vbWJsb2cvMTE0NzVfMTk3MTc0JCRjcdataWQ9Njg4ODc1NTQyMzJjYzg4NDI4MTZkZjg4NzZlODQzOTBfMSQkbV9pZD0kJF9zcmM9JCRfY209JCRfcD0kJGRzPTQxJCR1dWlkPXgzbWVjemEwcXF0dHZrdDQ0NGtzNThtYWVvZTRuYzJxJCR1aWQ9JCRjaWQ9MiQkY29kZT0xMzY2NzkxMDc1MTI0NDM1JCQ%3D23cd0ec7a7feb55b9a2a5a2cee30f8418705a084" target="_blank">资费评估方法整理（一）_移动Labs</a> <a href="http://labs.chinamobile.com/community/u/466" target="_blank"><img src="" alt=""></a></li>
</ul>
<p><strong><a href="http://labs.chinamobile.com/mblog/pub/466" target="_blank">王磊建</a></strong></p>
<p>地区：宣武区西便门内大街53号甲
公司：中国移动研究院业务研究所</p>
<p>行业：
<a href="http://labs.chinamobile.com/members/info_427" target="_blank">详细个人资料&gt;&gt;</a></p>
<p><a href="http://labs.chinamobile.com/mblog/466/feed" target="_blank">RSS</a></p>
<p><a href="http://labs.chinamobile.com/mblog/concern/466" target="_blank">关注</a>
<a href="http://labs.chinamobile.com/mblog/concern/466" target="_blank">19</a> <a href="http://labs.chinamobile.com/mblog/fans/466" target="_blank">粉丝</a>
<a href="http://labs.chinamobile.com/mblog/fans/466" target="_blank">18</a> <a href="http://labs.chinamobile.com/mblog/466" target="_blank">博文</a>
<a href="http://labs.chinamobile.com/mblog/466" target="_blank">12</a>
总访问量：32574</p>
<p><strong>他的标签</strong></p>
<p><a href="http://labs.chinamobile.com/mblog/k?sr=1&amp;sf=4&amp;kw=1739" target="_blank">SaaS</a> <a href="http://labs.chinamobile.com/mblog/k?sr=1&amp;sf=4&amp;kw=30615" target="_blank">html5</a> <a href="http://labs.chinamobile.com/mblog/k?sr=1&amp;sf=4&amp;kw=500" target="_blank">web</a> <a href="http://labs.chinamobile.com/mblog/k?sr=1&amp;sf=4&amp;kw=2934" target="_blank">app</a> <a href="http://labs.chinamobile.com/mblog/k?sr=1&amp;sf=4&amp;kw=79980" target="_blank">APP、PhoneGAP</a> <a href="http://labs.chinamobile.com/mblog/k?sr=1&amp;sf=4&amp;kw=31913" target="_blank">native</a> <a href="http://labs.chinamobile.com/mblog/k?sr=1&amp;sf=4&amp;kw=80551" target="_blank">APP、WEB</a> <a href="http://labs.chinamobile.com/mblog/k?sr=1&amp;sf=4&amp;kw=80552" target="_blank">APP、Hybrid</a> <a href="http://labs.chinamobile.com/mblog/k?sr=1&amp;sf=4&amp;kw=80553" target="_blank">APP、HTML5</a> <a href="http://labs.chinamobile.com/mblog/k?sr=1&amp;sf=4&amp;kw=80647" target="_blank">高可用、高性能、可扩展、系统架构、数据库</a> <a href="http://labs.chinamobile.com/mblog/k?sr=1&amp;sf=4&amp;kw=76415" target="_blank">OTT</a> <a href="http://labs.chinamobile.com/mblog/k?sr=1&amp;sf=4&amp;kw=6986" target="_blank">数字证书</a> <a href="http://labs.chinamobile.com/mblog/k?sr=1&amp;sf=4&amp;kw=81142" target="_blank">非对称性加密</a> <a href="http://labs.chinamobile.com/mblog/k?sr=1&amp;sf=4&amp;kw=81141" target="_blank">对称性加密</a> <a href="http://labs.chinamobile.com/mblog/k?sr=1&amp;sf=4&amp;kw=27184" target="_blank">数字签名</a> <a href="http://labs.chinamobile.com/mblog/k?sr=1&amp;sf=4&amp;kw=81699" target="_blank">join指令</a> <a href="http://labs.chinamobile.com/mblog/k?sr=1&amp;sf=4&amp;kw=81698" target="_blank">Join操作</a> <a href="http://labs.chinamobile.com/mblog/k?sr=1&amp;sf=4&amp;kw=81697" target="_blank">关系型数据库</a> <a href="http://labs.chinamobile.com/mblog/k?sr=1&amp;sf=4&amp;kw=81696" target="_blank">Join子句</a> <a href="http://labs.chinamobile.com/mblog/k?sr=1&amp;sf=4&amp;kw=14400" target="_blank">MySQL</a>
<strong>他关注的</strong><a href="http://labs.chinamobile.com/mblog/concern/466" target="_blank">更多&gt;&gt;</a></p>
<p><img src="" alt=""></p>
<p><a href="http://labs.chinamobile.com/mblog/47" target="_blank">黄晓庆</a>
<a href="">+加关注</a></p>
<p><img src="" alt=""></p>
<p><a href="http://labs.chinamobile.com/mblog/49" target="_blank">颜红燕</a>
<a href="">+加关注</a>
<img src="" alt=""></p>
<p><a href="http://labs.chinamobile.com/mblog/74" target="_blank">魏一平</a>
<a href="">+加关注</a></p>
<p><img src="" alt=""></p>
<p><a href="http://labs.chinamobile.com/mblog/75" target="_blank">王晓云</a>
<a href="">+加关注</a>
<img src="" alt=""></p>
<p><a href="http://labs.chinamobile.com/mblog/76" target="_blank">杨志强</a>
<a href="">+加关注</a></p>
<p><img src="" alt=""></p>
<p><a href="http://labs.chinamobile.com/mblog/81" target="_blank">霍曦</a>
<a href="">+加关注</a>
<img src="" alt=""></p>
<p><a href="http://labs.chinamobile.com/mblog/85" target="_blank">刘险峰</a>
<a href="">+加关注</a></p>
<p><img src="" alt=""></p>
<p><a href="http://labs.chinamobile.com/mblog/89" target="_blank">孙少陵</a>
<a href="">+加关注</a>
<img src="" alt=""></p>
<p><a href="http://labs.chinamobile.com/mblog/106" target="_blank">cindyhuang</a>
<a href="">+加关注</a></p>
<p><strong>关注他的</strong><a href="http://labs.chinamobile.com/mblog/fans/466" target="_blank">更多&gt;&gt;</a></p>
<p><img src="" alt=""></p>
<p><a href="http://labs.chinamobile.com/mblog/196" target="_blank">物联网实验室</a>
<a href="">+加关注</a></p>
<p><img src="" alt=""></p>
<p><a href="http://labs.chinamobile.com/mblog/58978" target="_blank">yewendong</a>
<a href="">+加关注</a>
<img src="" alt=""></p>
<p><a href="http://labs.chinamobile.com/mblog/105998" target="_blank">tiecheng19780504</a>
<a href="">+加关注</a></p>
<p><img src="" alt=""></p>
<p><a href="http://labs.chinamobile.com/mblog/164602" target="_blank">天凡</a>
<a href="">+加关注</a>
<img src="" alt=""></p>
<p><a href="http://labs.chinamobile.com/mblog/406410" target="_blank">二两迷糊</a>
<a href="">+加关注</a></p>
<p><img src="" alt=""></p>
<p><a href="http://labs.chinamobile.com/mblog/399330" target="_blank">我ok</a>
<a href="">+加关注</a>
<img src="" alt=""></p>
<p><a href="http://labs.chinamobile.com/mblog/704122" target="_blank">爱哦优</a>
<a href="">+加关注</a></p>
<p><img src="" alt=""></p>
<p><a href="http://labs.chinamobile.com/mblog/900087" target="_blank">人在移动</a>
<a href="">+加关注</a>
<img src="" alt=""></p>
<p><a href="http://labs.chinamobile.com/mblog/982874" target="_blank">国柱</a>
<a href="">+加关注</a></p>
<ul>
<li><a href="http://labs.chinamobile.com/foot/pronouncement.php" target="_blank">法律声明</a></li>
<li>|</li>
<li><a href="http://labs.chinamobile.com/foot/connect.php" target="_blank">联系我们</a></li>
<li>|</li>
<li><a href="http://labs.chinamobile.com/foot/help.php" target="_blank">帮助中心</a></li>
<li>|</li>
<li><a href="http://labs.chinamobile.com/foot/about_us.php" target="_blank">关于我们</a></li>
<li>|</li>
<li><a href="http://labs.chinamobile.com/foot/map.php" target="_blank">网站地图</a></li>
<li>|</li>
<li><a href="http://labs.chinamobile.com/foot/web_jobs.php" target="_blank">网站招聘</a>
<a href="http://www.miibeian.gov.cn/" target="_blank">京ICP备05002571号</a>|中国移动通信研究院版权所有 <a href="http://www.hd315.gov.cn/beian/view.asp?bianhao=010202001071900001" target="_blank"><img src="" alt=""></a></li>
</ul>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/服务器/">服务器</a></li></span><span class="breadcrumb"><li><a href="/categories/服务器/">服务器</a></li><li><a href="/categories/服务器/Squid/">Squid</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Squid/" class="label label-primary">Squid</a><a href="/tags/服务器/" class="label label-success">服务器</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:44"datetime="2014-03-07 09:54:44"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-服务器-Squid--一张图讲清楚高可用、高性能、可扩展的WEB系统架构_移动Labs/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-服务器-Squid--一张图讲清楚高可用、高性能、可扩展的WEB系统架构_移动Labs" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-服务器-haproxy--HAProxy的独门武器：ebtree/">HAProxy的独门武器：ebtree</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:44.000Z"> <a href="/2014/02/02/2014-02-02-服务器-haproxy--HAProxy的独门武器：ebtree/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="haproxy-ebtree">HAProxy的独门武器：ebtree</h1>
<h1 id="1-haproxy-ebtree-">1. HAProxy和ebtree简介</h1>
<p>HAProxy是法国人Willy Tarreau个人开发的一个开源软件，目标是应对客户端10000以上的同时连接，为后端应用服务器、数据库服务器提供高性能的负载均衡服务。
在底层数据结构方面，旧版本HAProxy曾经使用过红黑树，用于任务调度、负载均衡等方面。但是Willy Tarreau认为，在事件响应非常频繁的情况下，任务插入、删除的频率非常高，这时候使用红黑树存在性能瓶颈，尤其不能接受红黑树删除节点的时间复杂度为O(log n)。因此，他发明了一种新的数据结构，叫做<strong>弹性二叉树（elastic binary tree）</strong>，简称ebtree。
目前新版本的HAProxy（本文编写时最新版本为1.4.23）已使用ebtree，而除了HAProxy之外，还没有其它著名的开源软件使用ebtree。可以这么说，HAProxy最有特色的地方就是ebtree，ebtree名符其实是HAProxy的独门武器。
ebtree是不平衡的二叉搜索树（BST），而红黑树、AVL树等都是平衡的BST。传统的BST最怕的就是退化成线性搜索，因此，红黑树等BST插入、删除时都需要对树进行平衡化，而平衡化是一个从叶子节点开始，向根节点方向递归向上的过程，时间复杂度是O(log n)。
有鉴于此，ebtree为了实现删除节点时O(1)的时间复杂度，必然放弃保持树的平衡，为了拒绝由此而来的副作用——退化成线性搜索（或者更准确地说，退化成不受限制的线性搜索），不可避免地引入了一些新的成员和新的思路，且待我慢慢道来。</p>
<h1 id="2-ebtree-">2. ebtree节点的组成</h1>
<p>一个ebtree的节点（以下简称ebnode）分为node部分和leaf部分（Willy Tarreau是这样描述的，但我觉得称为树干部分和叶子部分更合适一些，以下就按我的理解来叙述）。<strong>树干</strong>负责关联其它ebnode，由父指针（node_p）和分支（Willy Tarreau称之为root，包括左分支L和右分支R），以及一个控制树的高度的特殊成员（bit）组成，<strong>叶子</strong>负责携带数据（data，一般是数据的键值，所以下文都称为key），另外包含一个指向上层的指针（leaf_p）。
一棵ebtree只有一个根节点（root），包含两个左右分支的指针（L、R）。所有的ebnode总是挂在根节点的左分支下面，根节点的右分支总是为空。在ebtree的遍历过程中，判断当前节点是否根节点就是判断其右指针是否为空。</p>
<p><a href="http://tech.uc.cn/wp-content/uploads/2013/05/Ebnode.png" target="_blank"><img src="" alt="Ebnode"></a></p>
<p>-</p>
<h1 id="3-">3. 各个指针的附加属性</h1>
<p>在32位平台中，一个指针占用4个字节，例如，地址值0xaabbcc00的下一个地址值是0xaabbcc04，再下一个是0xaabbcc08，也就是说，指针的值的最后两个比特不能表示一个合法地址。因此，Willy Tarreau充分利用这一点，来保存上述几个指针的特殊属性。这是一个很重要的优化，每个ebnode可以节省几个成员，整个ebtree就节省大量存储空间。
1）L和R既可以指向其它ebnode的树干，也可以指向其它ebnode的叶子，还可以指向自己的叶子。在ebtree的遍历过程中，对树干和叶子有不同的处理逻辑，L和R有必要知道自己所指向的是树干还是叶子。
2）可以知道node_p和leaf_p究竟挂在其它ebnode的左分支下面，还是挂在其右分支下面。
3）根节点右分支不挂任何树干和叶子，可以把它也利用上，指示该ebtree是否允许重复键值。
熟悉红黑树的读者都知道，红黑树也有同样的优化方法，表示红黑树节点颜色的属性并不占用内存空间。</p>
<h1 id="4-bit-">4. bit的定义</h1>
<p>引入bit就是为了<strong>限制树的高度</strong>，避免极端不平衡。在一棵不允许重复键值的ebtree中，key是32位的情况下，bit的取值范围是从0到31，此时，它的定义是：<strong>子树所有的键中，第一个不同的二进制位的位置</strong>。允许重复键值的ebtree稍后再详细介绍。
例如，下图的右下角子树中只有两个键，左边叶子节点的键值为300，右边叶子节点的键值为400，300的二进制是100101100，400的二进制是110010000，从右边数起第7位起（注意，程序员都是从0开始数数的），300和400左边的位都相同，所以，bit等于7。</p>
<p><a href="http://tech.uc.cn/wp-content/uploads/2013/05/bit.png" target="_blank"><img src="" alt="bit"></a></p>
<p>这时候，读者可能会问，这样定义bit为什么能够限制树的高度呢？不用着急，马上隆重介绍bit的两个重要意义！</p>
<h1 id="5-bit-">5. bit的第一个重要意义</h1>
<p>这里只讨论键值大于等于零的情况，事实上，ebtree可以支持键值为负数，不过，我还没有仔细研究过这种情况，应该是对符号位进行某些转换处理。
bit的第一个重要意义：<strong>同一个ebnode中的bit和key，联合决定该ebnode属下的子树内，所有key的取值范围</strong>。
先看下图挂在根节点下面，key = 300的那个ebnode，bit = 8，300的二进制为100101100，从右边数起第8位是最高位那个1，参考bit的定义，也就是说，该子树所有的键，第8位左边都是0，所以，它们的取值范围是从0到511（二进制111111111）。
再看最下面那个ebnode，bit = 5，250的二进制为11111010，从右边数起第5位是第三个1，再对照bit的定义，该子树的键，第5位左边都是11，所以，它们的取值范围是从192（二进制11000000）到255（二进制11111111）。
同理，最右边那个ebnode，bit = 7，key = 400，取值范围是256-511。</p>
<p><a href="http://tech.uc.cn/wp-content/uploads/2013/05/bit1.png" target="_blank"><img src="" alt="bit1"></a></p>
<h1 id="6-bit-">6. bit的第二个重要意义和查找过程</h1>
<p>bit的第二个重要意义：<strong>如果要查找的数据x在该子树的取值范围内，bit可以指示其可能会在左分支下面还是右分支下面</strong>。
ebtree的具体查找过程是，遍历到某个ebnode时，如果key = x，返回查找结果；如果x已经超出bit规定的取值范围，返回查找失败；否则，取x的第bit位，如果bit = 0，那么从该ebnode的左分支查找，反之，从右分支查找；如果已到达叶子还是没有匹配，返回查找失败。
还是上一节那个图，假如要找的键x = 249，二进制为11111001，从根节点左分支开始查找，bit = 8，右边数起第8位为0，于是从它的左分支继续查找，bit = 5，249右边数起第5位为1，于是从它的右分支继续查找，此时已到达叶子，且250 != 249，本次查找失败。
假如要找的键x = 300，因为就在查找路径的节点上，直接返回结果。
假如要找的键x = 600，已经超出该子树中bit规定的取值范围，返回查找失败。</p>
<h1 id="7-">7. 插入不可重复的键值</h1>
<p>首先，要介绍的是空树的情况。由前面的叙述可以得知，一棵ebtree为空树当且仅当它的根节点的左分支为空。所以，此时插入的ebnode就直接挂在根节点的左分支下面，由于新插入的ebnode不存在左右分支，也没有父节点（上层ebnode），显然也不需要bit来控制树的高度，因此，该ebnode的树干都没有使用。</p>
<p><a href="http://tech.uc.cn/wp-content/uploads/2013/05/insert0.png" target="_blank"><img src="" alt="insert0"></a></p>
<p>其次，介绍ebtree只有一个ebnode时，再插入一个ebnode的情况。此时，新的ebnode必定插入在根节点与旧的ebnode之间，如果新的键值大于原来的键值，旧的ebnode挂在新的ebnode的左分支下面，新的ebnode的叶子挂在自己的右分支下面，再计算bit；反之，则左右相反，再计算bit。
下图的例子，是已有key = 200，再插入key = 300的情形。读者可以根据上面的描述画出已有key = 200，再插入key = 100的情形。</p>
<p><a href="http://tech.uc.cn/wp-content/uploads/2013/05/insert1.png" target="_blank"><img src="" alt="insert1"></a></p>
<p>然后，就可以介绍在ebtree中插入新的ebnode的<strong>五种基本情形</strong>。在这里，都以上图为初始状态。任何具有更多ebnode的情形，都可以通过对ebtree的遍历，递推到其中一种情形。</p>
<p>1) <strong>新的键值可以插入子树中，而且小于子树中的最小键值。</strong></p>
<p>假如新插入ebnode的key为100，根据bit的第二个重要意义，100应该在该子树的左分支下面，而且，100小于200，于是，该ebnode插入在原图的左分支上，自己的左分支指向自己的叶子，自己的右分支指向原来子树的左分支。如下图所示。</p>
<p><a href="http://tech.uc.cn/wp-content/uploads/2013/05/insert2_1.png" target="_blank"><img src="" alt="insert2_1"></a></p>
<p>键值范围[0, 200)都属于这种情形。</p>
<p>2) <strong>新的键值可以插入子树中，该键值在确定要插入的两个ebnode的键值之间，且应该在该子树的左分支下面。</strong></p>
<p>假如新插入ebnode的key为225，根据bit的第二个重要意义，225应该在该子树的左分支下面，而且，225大于200，于是，该ebnode插入在原图的左分支上，自己的左分支指向原来子树的左分支，自己的右分支指向自己的叶子。如下图所示。</p>
<p><a href="http://tech.uc.cn/wp-content/uploads/2013/05/insert2_2.png" target="_blank"><img src="" alt="insert2_2"></a></p>
<p>键值范围(200, 255]都属于这种情形。</p>
<p>3) <strong>新的键值可以插入子树中，该键值在确定要插入的两个ebnode的键值之间，且应该在该子树的右分支下面。</strong></p>
<p>假如新插入ebnode的key为275，根据bit的第二个重要意义，275应该在该子树的右分支下面，而且，275小于300，于是，该ebnode插入在原图的右分支上，自己的左分支指向自己的叶子，自己的右分支指向原来子树的右分支。如下图所示。</p>
<p><a href="http://tech.uc.cn/wp-content/uploads/2013/05/insert2_3.png" target="_blank"><img src="" alt="insert2_3"></a></p>
<p>键值范围(255, 300)都属于这种情形。</p>
<p>4) <strong>新的键值可以插入子树中，而且大于子树中的最大键值。</strong></p>
<p>假如新插入ebnode的key为400，根据bit的第二个重要意义，400应该在该子树的右分支下面，而且，400大于300，于是，该ebnode插入在原图的右分支上，自己的左分支指向原来子树的右分支，自己的右分支指向自己的叶子。如下图所示。</p>
<p><a href="http://tech.uc.cn/wp-content/uploads/2013/05/insert2_4.png" target="_blank"><img src="" alt="insert2_4"></a></p>
<p>键值范围(300, 511]都属于这种情形。</p>
<p>5) <strong>新的键值不可以插入子树中。</strong></p>
<p>假如新插入ebnode的key为600，根据bit的第一个重要意义，600不可插入到子树中，于是，该ebnode插入在原图的子树之上，自己的左分支指向原来的子树，自己的右分支指向自己的叶子。如下图所示。</p>
<p><a href="http://tech.uc.cn/wp-content/uploads/2013/05/insert2_5.png" target="_blank"><img src="" alt="insert2_5"></a></p>
<p>键值范围(511, +∞)都属于这种情形。</p>
<h1 id="8-bit-">8. bit的第三个重要意义和插入重复的键值</h1>
<p>ebtree是专门为任务调度而生的，同样的优先级，必须保证能够按照任务触发的次序来进行访问。所以，ebtree支持存储重复的键值，这一点并不是所有的BST都支持，可以说是ebtree的优点。而且，解决键值冲突不会退化成链表。
bit的第三个重要意义：<strong>bit为负值表示该子树下所有的键都是重复的，而且，该值表示重复子树的层次</strong>。当然，必须要在根节点右指针允许的情况下。
插入第一个重复键值，例如300（ebnode底纹为点点），可以参考上一节的第二种和第四种基本情形，不同的是，bit为-1。</p>
<p><a href="http://tech.uc.cn/wp-content/uploads/2013/05/insert_dup1.png" target="_blank"><img src="" alt="insert_dup1"></a></p>
<p>如果再插入一个重复键值300（ebnode底纹为方格），应该在重复键值子树上插入，而且是向上生长。</p>
<p><a href="http://tech.uc.cn/wp-content/uploads/2013/05/insert_dup2.png" target="_blank"><img src="" alt="insert_dup2"></a></p>
<p>上图已经有四个ebnode，信息量较大，为了后续叙述方便，把它简化，去掉几个指针域，保留bit和key，得到下图。</p>
<p><a href="http://tech.uc.cn/wp-content/uploads/2013/05/insert_dup2s.png" target="_blank"><img src="" alt="insert_dup2s"></a></p>
<p>再插入一个300（ebnode底纹为斜方格），得到下面的ebtree。</p>
<p><a href="http://tech.uc.cn/wp-content/uploads/2013/05/insert_dup3s.png" target="_blank"><img src="" alt="insert_dup3s"></a></p>
<p>再插入两个300（ebnode底纹分别为左斜线和右斜线），得到下面的ebtree。</p>
<p><a href="http://tech.uc.cn/wp-content/uploads/2013/05/insert_dup5s.png" target="_blank"><img src="" alt="insert_dup5s"></a></p>
<p>读者可以思考一下，如果再来一个、两个、三个300，应该在哪里插入？如果插入不同于300的其它键值，应该在哪里插入？
从上面几张图，大家可以看到，一个ebnode的树干和叶子会随着树的增长而拉长到不同的层次上，好像很有弹性的样子，这就是弹性二叉树名字的由来。</p>
<h1 id="9-">9. 删除节点</h1>
<p>删除一个ebnode，概括起来比较简单，就是把要删除的叶子和该叶子的父亲（树干部分）删除，然后把兄弟挂到祖父下面。因为不需要对树进行平衡化，不需要访问其它ebnode，效率很高。
具体操作，分为两种情况：
1）被删除的叶子直连自己的树干，可直接删除该ebnode，然后对它的兄弟重新指派原来的祖父为父亲。
2）被删除的叶子不是直连自己的树干，以该叶子的父亲（其它ebnode的树干）替换该ebnode的树干，然后删除该ebnode，再把它的兄弟重新指派原来的祖父为父亲。</p>
<h1 id="10-">10. 总结</h1>
<p>没有最好的数据结构，只有最合适的数据结构。ebtree有它的优点：
1）支持存储重复的键值，而且，在此情况下，也不会退化成线性操作。
2）删除节点时，不需要对树进行平衡化。
3）插入键值时，很可能不需要深入到树的叶子，当然，很多BST都这样。
4）查询键值时，可以预知子树的取值范围，从而可以选择访问还是不访问该子树。
缺点也很明显：
1）逻辑比较复杂，熟悉的人不多（希望读者看完本文之后都有茅塞顿开的感觉）。
2）ebnode占用空间比较多，如果把bit也算一个指针，相当于花了5个指针才携带1个数据。
3）键值严重依赖于可以进行位运算的数据类型。
总而言之，ebtree适合有高频率插入、删除操作（例如50万次/秒）的使用场合，不适合查询较多、插入、删除较少的场合，非常不适合用于缓存。</p>
<h1 id="11-">11. 参考资料</h1>
<ul>
<li><a href="http://1wt.eu/articles/ebtree/" target="_blank"><a href="http://1wt.eu/articles/ebtree/">http://1wt.eu/articles/ebtree/</a></a></li>
<li>Willy Tarreau个人网站对ebtree的介绍，不过存在不少误导的地方</li>
<li><a href="http://blog.nklike.com/%E5%BC%80%E6%BA%90%E8%BD%AF%E4%BB%B6/ebtree%E4%BB%8B%E7%BB%8D/" target="_blank"><a href="http://blog.nklike.com/开源软件/ebtree介绍/">http://blog.nklike.com/开源软件/ebtree介绍/</a></a></li>
<li>淘宝空见对上文的翻译，也有不够准确的地方</li>
<li><a href="http://wenku.it168.com/d_000555847.shtml" target="_blank"><a href="http://wenku.it168.com/d_000555847.shtml">http://wenku.it168.com/d_000555847.shtml</a></a></li>
<li><p>对ebtree的描述错误比较多</p>
<h3 id="-">您可能感兴趣的文章</h3>
</li>
<li><p><a href="http://tech.uc.cn/?p=696" target="_blank">使用搜索技术实现URL智能匹配</a></p>
</li>
<li><a href="http://tech.uc.cn/?p=1738" target="_blank">HAProxy几个重要的结构体</a></li>
<li><a href="http://tech.uc.cn/?p=300" target="_blank">Nginx的http配置结构体的组织结构</a></li>
</ul>
<p>来源： <a href="[http://tech.uc.cn/?p=1031](http://tech.uc.cn/?p=1031)">[http://tech.uc.cn/?p=1031](http://tech.uc.cn/?p=1031)</a></p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/服务器/">服务器</a></li></span><span class="breadcrumb"><li><a href="/categories/服务器/">服务器</a></li><li><a href="/categories/服务器/haproxy/">haproxy</a></li></span></span> | <span class="tags">Tagged <a href="/tags/haproxy/" class="label label-primary">haproxy</a><a href="/tags/服务器/" class="label label-success">服务器</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:44"datetime="2014-03-07 09:54:44"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-服务器-haproxy--HAProxy的独门武器：ebtree/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-服务器-haproxy--HAProxy的独门武器：ebtree" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-服务器-Squid--代理服务器Squid使用详解-51CTOCOM/">代理服务器Squid 使用详解 </a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:44.000Z"> <a href="/2014/02/02/2014-02-02-服务器-Squid--代理服务器Squid使用详解-51CTOCOM/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="-squid-51cto-com">代理服务器Squid 使用详解 - 51CTO.COM</h1>
<h3 id="-">分享到</h3>
<ul>
<li><a href="http://network.51cto.com/art/200601/18507.htm#" target="_blank">一键分享</a></li>
<li><a href="http://network.51cto.com/art/200601/18507.htm#" target="_blank">QQ空间</a></li>
<li><a href="http://network.51cto.com/art/200601/18507.htm#" target="_blank">新浪微博</a></li>
<li><a href="http://network.51cto.com/art/200601/18507.htm#" target="_blank">百度搜藏</a></li>
<li><a href="http://network.51cto.com/art/200601/18507.htm#" target="_blank">人人网</a></li>
<li><a href="http://network.51cto.com/art/200601/18507.htm#" target="_blank">腾讯微博</a></li>
<li><a href="http://network.51cto.com/art/200601/18507.htm#" target="_blank">百度相册</a></li>
<li><a href="http://network.51cto.com/art/200601/18507.htm#" target="_blank">开心网</a></li>
<li><a href="http://network.51cto.com/art/200601/18507.htm#" target="_blank">腾讯朋友</a></li>
<li><a href="http://network.51cto.com/art/200601/18507.htm#" target="_blank">百度贴吧</a></li>
<li><a href="http://network.51cto.com/art/200601/18507.htm#" target="_blank">豆瓣网</a></li>
<li><a href="http://network.51cto.com/art/200601/18507.htm#" target="_blank">搜狐微博</a></li>
<li><a href="http://network.51cto.com/art/200601/18507.htm#" target="_blank">百度新首页</a></li>
<li><a href="http://network.51cto.com/art/200601/18507.htm#" target="_blank">QQ好友</a></li>
<li><a href="http://network.51cto.com/art/200601/18507.htm#" target="_blank">和讯微博</a></li>
<li><a href="http://network.51cto.com/art/200601/18507.htm#" target="_blank">更多...</a></li>
</ul>
<p><a href="http://network.51cto.com/art/200601/18507.htm#" target="_blank">百度分享</a></p>
<p><a href="http://www.51cto.com/" target="_blank">首页</a><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/top_bg_xian.gif" alt=""><a href="http://www.51cto.com/col/35/" target="_blank">技术频道<img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/nav_ico1.gif" alt=""></a><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/top_bg_xian.gif" alt=""><a href="http://www.51cto.com/" target="_blank">51CTO旗下网站<img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/nav_ico1.gif" alt=""></a><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/top_bg_xian.gif" alt=""><a href="http://www.51cto.com/about/map.htm" target="_blank">地图</a> <a href="http://www.51cto.com/about/rss.html" target="_blank"><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/143749870.gif" alt=""></a></p>
<p><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/top_shequ.gif" alt="">社区：<a href="http://bbs.51cto.com/" target="_blank">论坛</a><a href="http://blog.51cto.com/" target="_blank">博客</a><a href="http://down.51cto.com/" target="_blank">下载</a><a href="http://book.51cto.com/" target="_blank">读书</a><a href="">更多<img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/nav_ico1.gif" alt=""></a></p>
<p><a href="http://home.51cto.com/index.php?s=/Home/index" target="_blank"><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/dia.gif" alt="" title="今天领无忧币了吗？"></a><a href="http://home.51cto.com/?reback=http%253A%252F%252Fnetwork.51cto.com%252Fart%252F200601%252F18507.htm" target="_blank">登录</a><a href="http://ucenter.51cto.com/reg_01.php?reback=http%253A%252F%252Fnetwork.51cto.com%252Fart%252F200601%252F18507.htm" target="_blank">注册</a></p>
<ul>
<li><a href="http://network.51cto.com/" target="_blank">网络</a></li>
<li><a href="http://netsecurity.51cto.com/" target="_blank">安全</a></li>
<li><a href="http://developer.51cto.com/" target="_blank">开发</a></li>
<li><a href="http://database.51cto.com/" target="_blank">数据库</a></li>
<li><a href="http://server.51cto.com/" target="_blank">服务器</a></li>
<li><a href="http://os.51cto.com/" target="_blank">系统</a></li>
<li><a href="http://virtual.51cto.com/" target="_blank">虚拟化</a></li>
<li><a href="http://cloud.51cto.com/" target="_blank">云计算</a></li>
<li><a href="http://developer.51cto.com/embed/" target="_blank">嵌入式</a></li>
<li><p><a href="http://mobile.51cto.com/" target="_blank">移动开发</a></p>
</li>
<li><p><a href="http://www.51cto.com/" title="中国领先的IT技术网站" target="_blank">51CTO.COM</a></p>
</li>
<li><a href="http://www.cioage.com/" title="中国首个专门服务于CIO的专业网站" target="_blank">CIOage.com</a></li>
<li><a href="http://www.watchstor.com/" title="领先的中文存储网络媒体" target="_blank">WatchStor.com</a></li>
<li><a href="http://www.hc3i.cn/" title="中国首家专注于数字医疗及医疗信息化的专业网站" target="_blank">HC3i.cn</a></li>
<li><a href="http://www.linkphone.cn/" title="移动互联网生活门户" target="_blank">灵客风LinkPhone</a></li>
<li><a href="http://home.51cto.com/" target="_blank">家园</a></li>
<li><a href="http://t.51cto.com/" target="_blank">微博</a></li>
<li><a href="http://blog.51cto.com/" target="_blank">博客</a></li>
<li><a href="http://bbs.51cto.com/" target="_blank">论坛</a></li>
<li><a href="http://down.51cto.com/" target="_blank">下载</a></li>
<li><a href="http://selftest.51cto.com/" target="_blank">自测</a></li>
<li><a href="http://doctor.51cto.com/" target="_blank">门诊</a></li>
<li><a href="http://blog.51cto.com/newsletter/" target="_blank">周刊</a></li>
<li><a href="http://book.51cto.com/" target="_blank">读书</a></li>
<li><a href="http://g.51cto.com/" target="_blank">技术圈</a></li>
<li><a href="http://zhidao.51cto.com/" target="_blank">知道</a></li>
</ul>
<p><em>
</em>
<em>
</em>
<img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/zuwang_logo.gif" alt=""></p>
<p><a href="http://network.51cto.com/" target="_blank">首页</a> | <a href="http://network.51cto.com/col/786/" target="_blank">思科</a> | <a href="http://network.51cto.com/router/" target="_blank">路由</a> | <a href="http://network.51cto.com/switch" target="_blank">交换</a> | <a href="http://network.51cto.com/wlan" target="_blank">无线</a> | <a href="http://network.51cto.com/col/888/" target="_blank">ADSL</a> | <a href="http://network.51cto.com/col/946/" target="_blank">VPN</a> | <a href="http://network.51cto.com/col/1022/" target="_blank">网管</a> | <a href="http://network.51cto.com/col/493/" target="_blank">布线</a> | <a href="http://network.51cto.com/col/513/" target="_blank">接入</a> | <a href="http://publish.51cto.com/list/481/" target="_blank">全部文章</a>
<a href="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/search.gif"></a></p>
<p>您所在的位置：<a href="http://network.51cto.com/" target="_blank">网络频道</a> &gt; <strong>代理服务器Squid 使用详解</strong></p>
<h1 id="-squid-">代理服务器Squid 使用详解</h1>
<p>2006-01-17 13:55 nsfocus <a href="http://network.51cto.com/art/200601/18507.htm#commment" target="_blank">我要评论(0)</a> 字号：<a href="">T</a> | <a href="">T</a></p>
<p><a href="&quot;一键收藏，随时查看，分享好友！&quot;"><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/Fav.gif" alt="一键收藏，随时查看，分享好友！"></a></p>
<p>做为眼下最流行的操作系统，Linux已经越来越受到世人的关注。虽然目前Linux的软件还不是很丰富，替代WINDOWS作为普通PC机操作系统还为时过早，但是在服务器领域，Linux的稳定性，可操作性决不输于任何操作系统，并且也有优秀的软件支持</p>
<p>AD： <a href="http://wot.51cto.com/bigdata2013/buyticket.html" target="_blank">2013大数据全球技术峰会低价抢票中</a></p>
<p>做为眼下最流行的操作系统，Linux已经越来越受到世人的关注。虽然目前Linux的软件还不是很丰富，替代WINDOWS作为普通PC机操作系统还为时过早，但是在服务器领域，Linux的稳定性，可操作性决不输于任何操作系统，并且也有优秀的软件支持 。Squid就是其中之一。Linux加Squid的组合做为代理服务器，性能远远超过WINNT加MSPROXY2.0（个人观点），为几百人的小型局域网代理绰绰有余。下面，我就详细的介绍Squid的安装及使用技巧，希望大家能够喜欢上它。
1.Squid简介</p>
<p>Squid是一个缓存internet数据的一个软件，它接收用户的下载申请，并自动处理所下载的数据。也就是说，当一个用户象要下载一个主页时，它向Squid发出一个申请，要Squid替它下载，然后Squid连接所申请网站并请求该主页，接着把该主页传给用户同时保留一个备份，当别的用户申请同样的页面时，Squid把保存的备份立即传给用户，使用户觉得速度相当快。目前，Squid 可以代理HTTP, FTP, GOPHER, SSL 和 WAIS 协议，暂不能代理POP, NNTP等协议。不过，已经有人开始修改Squid，相信不久的将来，Squid能够代理这些协议。</p>
<p>Squid能够缓存任何数据吗？不是的。象缓存信用卡帐号、可以远方执行的scripts、经常变换的主页等是不合适的也是不安全的。Squid可以自动的进行处理，你也可以根据自己的需要设置Squid，使之过滤掉你不想要的东西。
Squid可以工作在很多的操作系统中，如AIX, Digital Unix, FreeBSD, HP-UX, Irix, Linux, NetBSD, Nextstep, SCO, Solaris，OS/2等，也有不少人在其他操作系统中重新编译过Squid。
Squid对硬件的要求是内存一定要大，不应小于128M，硬盘转速越快越好，最好使用服务器专用SCSI硬盘，处理器要求不高，400MH以上既可。</p>
<ol>
<li>Squid的编译和运行
其实现在的Linux发行套件中基本都有已经编译好的Squid，你所作的就是安装它既可。如果你手头没有现成的编译好的Squid或想使用最新的版本，去ftp:squid.nlanr.net下载一份，自己编译。
Squid的编译是非常简单的，因为它基本上是自己配置自己。最容易出现的问题是你的系统上没有合适的编译器，这可以通过安装相应的编译器解决。如果出现其他问题，你可以问一下有经验的用户或到相应的邮件列表寻找帮助。
编译Squid之前，最好建一个专门运行Squid的用户和组。我就在自己的服务器上建了一个名为squid的用户和组，用户目录设为/usr/local/squid。然后su为用户squid并从squid.nlanr.net下载Squid的源文件到目录 /usr/local/squid/src中，用如下命令进行解压：
％tar xzf squid-2.0.RELEASE-src.tar.gz
％cd /usr/local/squid/src/ squid-/<em>./</em>.RELEASE /
％./configure
%make
％make install</li>
</ol>
<p>第一个命令在目录/usr/local/squid/src中产生一个新的子目录/squid-/<em>./</em>.RELEASE/。命令./configure会自动查询你的系统配置情况以及你系统中使用的头文件。不加参数的./configure会把Squid安装在目录/usr/local/squid中，如果你想使用其他目录，用如下命令./configure --prefix=/some/other/directory，这会把Squid安装在目录/some/other/directory中。make命令编译Squid，make install命令安装Squid。
不出意外的话，目录/usr/local/squid中会出现如下目录：</p>
<p>/bin
/cache
/etc
/logs/
/src （自己创建的）</p>
<p>目录/bin中含有Squid可执行程序，包括Squid本身，ftpget等。
目录/cache包含Squid缓存的数据，其中包含象/00/ /01/ /02/ 以及/03/这样的目录，这些目录中还有子目录，因为目录多了比在一个目录成千上万的文件中寻找一个文件更容易，速度更快。
目录/etc中包含Squid的唯一的配置文件squid.conf。
目录/logs中包含Squid的日志。</p>
<ol>
<li>squid.conf文件的配置
在安装Squid后，在目录/usr/local/squid /etc中会自动产生一个样本squid.conf文件，文件中对每一个选项都有详细的说明，用户可以通过修改该文件以满足不同的需要。
总的来说，有如下几个重要选项：
http_port:设定Squid监听的端口，你最好设一个比较好记的端口号，以便在进行客户机配置时容易记住。我的机器上端口号设的是8080。缺省为3128。
cache_mem：设定Squid占用的物理内存，根据我的经验，cache_mem的大小不应超过你的服务器物理内存的三分之一，否则将会影响机器的总体性能。
maximum_object_size：设定Squid可以接收的最大对象的大小。Squid缺省值为4M，我自己入认为太大，你可以根据自己的需要进行设定。
cache_dir：设定缓存的位置、大小。一般看起来形式如下“cache_dir /usr/local/squid/cache 100 16 256”。 /usr/local/squid/cache代表缓存的位置；100代表缓存最大为100M；16和256代表一级和二级目录数。
cache_effective_user：设定使用缓存的有效用户。缺省为用户nobody，如果你的系统中没有用户nobody，最好建一个或以非root用户运行Squid。
下面我给出一个最简单的squid.conf文件：</li>
</ol>
<p>/#squid.conf - a very basic config file for squid
/#Turn logging to it&#39;s lowest level
debug_options ALL,1
/#defines a group (or Access Control List)
that includes all IP addresses
acl all src 0.0.0.0/0.0.0.0
/#define RAM used
cache_mem 32M
/#defines the cache size
cache_dir /usr/local/squid/cache 100 16 256
/#allow all sites to use connect to us via HTTP
http_access allow all
/#allow all sites to use us as a sibling
icp_access allow all
/#test the following sites to check that we are connected
dns_testnames internic.net usc.edu
cs.colorado.edu mit.edu yale.edu
/#run as the squid user
cache_effective_user squid squid</p>
<p>这个配置文件允许所有人使用Squid，创建了100M缓存，使用32M内存，在缺省位置&quot;/usr/local/squid/cache&quot;缓存数据，所有缓存数据以组squid和用户squid身份保存，端口为3128。虽然这个配置很不安全，但是它已经能使用了。</p>
<ol>
<li>运行Squid
首先以root身份登陆。运行如下命令：
％/usr/local/squid/bin/squid ？z
该命令会产生Squid所有的缓存目录。
如果你想前台执行Squid,接着执行命令：
％/usr/local/squid/bin/squid -NCd1
该命令正式启动Squid。如果一切正常，你会看到一行输出
Ready to serve requests.
如果想后台运行Squid，把它做为一个精灵进程，执行命令：
％/usr/local/squid/bin/squid
观察Squid是否运行使用命令：
% squid -k check
输出会告诉你Squid的当前状态。
好了，文章先写到这里，其实这里介绍的都是最基本的东西，Squid有好多高级的功能，如做WEB服务器的高速缓存，做二级代理服务器，做为防火墙，以及怎样设定过滤规则等，这里就不详述了，如果有机会再奉献给大家。(责任编辑：<a href="mailto:chenliang.liu@gmail.com">liucl</a>)</li>
</ol>
<ul>
<li><a href=""><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/bq1.jpg" alt=""></a></li>
</ul>
<p><a href="">给力</a>
(47票)</p>
<ul>
<li><a href=""><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/bq2.jpg" alt=""></a></li>
</ul>
<p><a href="">动心</a>
(42票)</p>
<ul>
<li><a href=""><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/bq3.jpg" alt=""></a></li>
</ul>
<p><a href="">废话</a>
(49票)</p>
<ul>
<li><a href=""><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/bq4.jpg" alt=""></a></li>
</ul>
<p><a href="">专业</a>
(42票)</p>
<ul>
<li><a href=""><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/bq5.jpg" alt=""></a></li>
</ul>
<p><a href="">标题党</a>
(40票)</p>
<ul>
<li><a href=""><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/bq6.jpg" alt=""></a></li>
</ul>
<p><a href="">路过</a>
(42票)</p>
<p>原文：<a href=""><strong>代理服务器Squid 使用详解</strong></a> <a href="http://network.51cto.com/" target="_blank">返回网络频道首页</a></p>
<p>分享到：</p>
<p><a href="http://network.51cto.com/art/200601/18507.htm#" title="分享到QQ空间" target="_blank"></a> <a href="http://network.51cto.com/art/200601/18507.htm#" title="分享到新浪微博"></a> <a href="http://network.51cto.com/art/200601/18507.htm#" title="分享到腾讯微博" target="_blank"></a> <a href="http://network.51cto.com/art/200601/18507.htm#" title="分享到人人网"></a> <a href="http://network.51cto.com/art/200601/18507.htm#" title="分享到网易微博" target="_blank"></a>  <a href="http://network.51cto.com/art/200601/18507.htm#" title="累计分享1次">1</a></p>
<p><a href="">收藏</a>|<a href="">打印</a>|<a href="&quot;分享本资源给好友&quot;">复制</a></p>
<p>关于<a href="http://www.51cto.com/php/search.php?keyword=%B4%FA%C0%ED%B7%FE%CE%F1%C6%F7Squid" target="_blank">代理服务器Squid</a>的更多文章</p>
<p><a href="http://network.51cto.com/art/200907/136542.htm" title="谁来统领企业无线网络-最新802.11n无线路由综合评测" target="_blank"><strong>谁来统领企业无线网络-最新802.11n无线路由综合评测</strong></a> <a href="http://network.51cto.com/art/200907/136542.htm" title="谁来统领企业无线网络-最新802.11n无线路由综合评测" target="_blank"><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/133548583.jpg" alt="谁来统领企业无线网络-最新802.11n无线路由综合评测"></a></p>
<p>从802.11n诞生以来，一直就没有正式案发布，现在市面上的802.11n<a href="http://network.51cto.com/art/200907/136542.htm" title="谁来统领企业无线网络-最新802.11n无线路由综合评测" target="_blank">[详细]</a></p>
<h3 id="-top5-">网友评论<em>TOP5</em></h3>
<p><a href="http://www.51cto.com/php/feedbackt.php?id=18507" target="_blank">查看所有评论（0）</a></p>
<p><a href=""></a> 提交评论 通行证： 密码：   <a href="http://ucenter.51cto.com/reg_01.php">注册通行证</a>
验证码：<img src="" alt="">点击图片可刷新验证码请点击后输入验证码匿名发表</p>
<h3 id="-">栏目热门</h3>
<p><a href="http://network.51cto.com/click/481" target="_blank">更多&gt;&gt;</a></p>
<ul>
<li><a href="http://network.51cto.com/art/201202/314707.htm" title="IT宴席开局 网友热议海底捞远程视频聚餐" target="_blank">IT宴席开局 网友热议海底捞远程视频聚餐</a></li>
<li><a href="http://network.51cto.com/art/201201/311658.htm" title="12306订票网烧钱数千万 太极、网宿参建龟速网" target="_blank">12306订票网烧钱数千万 太极、网宿参建龟速</a></li>
<li><a href="http://network.51cto.com/art/201201/312810.htm" title="2012春节长假IT系统运维支招之管理篇" target="_blank">2012春节长假IT系统运维支招之管理篇</a></li>
<li><a href="http://network.51cto.com/art/201202/317743.htm" title="千兆Wi-Fi——高速无线不是梦" target="_blank">千兆Wi-Fi——高速无线不是梦</a></li>
<li><a href="http://network.51cto.com/art/201201/311217.htm" title="CISCO路由器启动流程图" target="_blank">CISCO路由器启动流程图</a></li>
</ul>
<h3 id="-">同期最新</h3>
<p><a href="http://network.51cto.com/col/481" target="_blank">更多&gt;&gt;</a></p>
<ul>
<li><a href="http://network.51cto.com/art/200601/18504.htm" title="万物求源 原理解析网络代理" target="_blank">万物求源 原理解析网络代理</a></li>
<li><a href="http://network.51cto.com/art/200601/18494.htm" title="多重功能 且看网络代理" target="_blank">多重功能 且看网络代理</a></li>
<li><a href="http://network.51cto.com/art/200601/18490.htm" title="畅游其间 网络代理" target="_blank">畅游其间 网络代理</a></li>
<li><a href="http://network.51cto.com/art/200601/18486.htm" title="代理服务器软件SuperProxy" target="_blank">代理服务器软件SuperProxy</a></li>
<li><a href="http://network.51cto.com/art/200601/18249.htm" title="局域网资源共享故障分析与解决" target="_blank">局域网资源共享故障分析与解决</a></li>
</ul>
<h3 id="-http-network-51cto-com-"><a href="http://network.51cto.com/" target="_blank">网络频道</a></h3>
<p>频道导航</p>
<ul>
<li>热门</li>
</ul>
<p><a href="http://network.51cto.com/router/" target="_blank">路由技术</a>|<a href="http://network.51cto.com/switch/" target="_blank">交换网络</a>|<a href="http://network.51cto.com/wlan/" target="_blank">无线网络</a></p>
<ul>
<li>技术</li>
</ul>
<p><a href="http://network.51cto.com/cabling/" target="_blank">布线技术</a>|<a href="http://network.51cto.com/col/1022/" target="_blank">运维技术</a>|<a href="http://network.51cto.com/access/" target="_blank">接入技术</a></p>
<ul>
<li>专题</li>
</ul>
<p><a href="http://network.51cto.com/speclist/481/" target="_blank">专题汇总</a>|<a href="http://network.51cto.com/art/201101/242851.htm" target="_blank">网管软件</a>|<a href="http://network.51cto.com/art/201011/235584.htm" target="_blank">网络控速</a></p>
<h3 id="-">热点推荐</h3>
<ul>
<li><a href="http://mobile.51cto.com/mobile-182392.htm" target="_blank"><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/153546162.jpg" alt=""></a></li>
</ul>
<p><a href="http://mobile.51cto.com/mobile-182392.htm" target="_blank">Android开发应用详解</a></p>
<ul>
<li><a href="http://developer.51cto.com/art/201106/266369.htm" target="_blank"><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/133620622.jpg" alt=""></a></li>
</ul>
<p><a href="http://developer.51cto.com/art/201106/266369.htm" target="_blank">那些性感的让人尖叫的程序员</a></p>
<ul>
<li><a href="http://developer.51cto.com/art/200907/133407.htm" target="_blank"><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/134217922.jpg" alt=""></a></li>
</ul>
<p><a href="http://developer.51cto.com/art/200907/133407.htm" target="_blank">HTML5 下一代Web开发标准详解</a></p>
<ul>
<li><a href="http://developer.51cto.com/art/201104/257581.htm" target="_blank"><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/123123954.jpg" alt=""></a></li>
</ul>
<p><a href="http://developer.51cto.com/art/201104/257581.htm" target="_blank">高性能WEB开发应用指南</a></p>
<ul>
<li><a href="http://os.51cto.com/art/200706/49181.htm" target="_blank"><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/195816929.jpg" alt=""></a></li>
</ul>
<p><a href="http://os.51cto.com/art/200706/49181.htm" target="_blank">Ubuntu开源技术交流频道</a></p>
<p><strong>热门标签：</strong> <a href="http://os.51cto.com/windows/" target="_blank">windows频道</a><a href="http://mobile.51cto.com/" target="_blank">移动开发</a><a href="http://cloud.51cto.com/" target="_blank">云计算</a><a href="http://mobile.51cto.com/mobile/objc/" target="_blank">objective-c</a><a href="http://network.51cto.com/art/200909/151122.htm" target="_blank">tp-link路由器设置图解</a><a href="http://developer.51cto.com/art/200907/133407.htm" target="_blank">html5</a></p>
<p><a href="http://wot.51cto.com/bigdata2013/buyticket.html" target="_blank"><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/wKioJlEjPKXh0JE0AABEhq3s9JY868.jpg" alt=""></a></p>
<ul>
<li><em>专题</em> <a href="http://network.51cto.com/network/cisco/201212" target="_blank">思科网联天下 共启智慧未来</a></li>
<li><a href="http://network.51cto.com/network/cisco/201212" target="_blank"><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/wKioOVFBO1ryB-WmAAAfx2V-oPA593.jpg" alt=""></a> 思科联所未连，与您共启未来！一起来探索万物互联...</li>
</ul>
<ol>
<li><a href="http://netsecurity.51cto.com/secu/RSA2013/" target="_blank">2013 RSA大会：掌控数据 保护世界</a></li>
<li><a href="http://network.51cto.com/art/201301/378017.htm" target="_blank">思科UCS助力医疗数据库部署优化</a></li>
</ol>
<h3 id="-">文章排行</h3>
<p><a href="">本月</a><a href="">本周</a><a href="">24小时</a></p>
<ul>
<li><a href="http://network.51cto.com/art/200912/171496.htm" title="宽带路由器设置图解七步骤" target="_blank">宽带路由器设置图解七步骤</a></li>
<li><a href="http://network.51cto.com/art/200909/151122.htm" title="详解TP-Link路由器设置（图解）" target="_blank">详解TP-Link路由器设置（图解）</a></li>
<li><a href="http://network.51cto.com/art/201108/287705.htm" title="192.168.1.1打不开或进不去怎么办？" target="_blank">192.168.1.1打不开或进不去怎么办？</a></li>
<li><a href="http://network.51cto.com/art/201109/290308.htm" title="宽带路由器设置：192.168.0.1" target="_blank">宽带路由器设置：192.168.0.1</a></li>
<li><a href="http://network.51cto.com/art/201109/289287.htm" title="为什么路由器设置地址192.168.1.1打不" target="_blank">为什么路由器设置地址192.168.1.1打不</a></li>
<li><a href="http://network.51cto.com/art/201109/290947.htm" title="tenda无线路由器设置图解" target="_blank">tenda无线路由器设置图解</a></li>
<li><a href="http://network.51cto.com/art/200806/78880.htm" title="无线路由器的桥接和覆盖图文教程" target="_blank">无线路由器的桥接和覆盖图文教程</a></li>
<li><a href="http://network.51cto.com/art/201109/291036.htm" title="TP-Link无线路由器设置和密码破解" target="_blank">TP-Link无线路由器设置和密码破解</a></li>
<li><a href="http://network.51cto.com/art/200908/144482.htm" title="无线“蹭网卡”热卖 任意密码5分钟破解" target="_blank">无线“蹭网卡”热卖 任意密码5分钟破解</a></li>
<li><a href="http://network.51cto.com/art/201109/289392.htm" title="教你找回无线路由器密码的方法" target="_blank">教你找回无线路由器密码的方法</a></li>
<li><a href="http://network.51cto.com/art/201304/389875.htm" title="F5 Networks:让应用和网络完美融合 轻" target="_blank">F5 Networks:让应用和网络完美融合 轻</a></li>
<li><a href="http://network.51cto.com/art/201304/390081.htm" title="路由器频繁死机是怎么回事?" target="_blank">路由器频繁死机是怎么回事?</a></li>
<li><a href="http://network.51cto.com/art/201304/390055.htm" title="数据中心交换机何时才能有中国“芯”" target="_blank">数据中心交换机何时才能有中国“芯”</a></li>
<li><a href="http://network.51cto.com/art/201304/390097.htm" title="阿朗SDN战略：聚焦网络与应用融合 注重" target="_blank">阿朗SDN战略：聚焦网络与应用融合 注重</a></li>
<li><a href="http://network.51cto.com/art/201304/390183.htm" title="极速WIFI时代 华硕PCE-AC66首款千兆网" target="_blank">极速WIFI时代 华硕PCE-AC66首款千兆网</a></li>
<li><a href="http://network.51cto.com/art/201304/390060.htm" title="改进WAN安全架构的两种选择" target="_blank">改进WAN安全架构的两种选择</a></li>
<li><a href="http://network.51cto.com/art/201304/390414.htm" title="突破传统网络格局 革新思想加速推进SDN" target="_blank">突破传统网络格局 革新思想加速推进SDN</a></li>
<li><a href="http://network.51cto.com/art/201304/390067.htm" title="连上交换机后部分电脑无法上网?" target="_blank">连上交换机后部分电脑无法上网?</a></li>
<li><a href="http://network.51cto.com/art/201304/389911.htm" title="三网融合缓慢 部门利益争夺仍是根本原" target="_blank">三网融合缓慢 部门利益争夺仍是根本原</a></li>
<li><p><a href="http://network.51cto.com/art/201304/390009.htm" title="VIP企业专线 MSTP刚性管道凸显大神通" target="_blank">VIP企业专线 MSTP刚性管道凸显大神通</a></p>
</li>
<li><p><a href="http://network.51cto.com/art/201304/387782.htm" title="了解光纤上网的实质是什么" target="_blank">了解光纤上网的实质是什么</a></p>
</li>
<li><a href="http://network.51cto.com/art/201304/387581.htm" title="面粉比面包贵频频发生 宽带中国需要真" target="_blank">面粉比面包贵频频发生 宽带中国需要真</a></li>
<li><a href="http://network.51cto.com/art/201304/387608.htm" title="虚拟化该成为网络面向应用的第一步" target="_blank">虚拟化该成为网络面向应用的第一步</a></li>
<li><a href="http://network.51cto.com/art/201304/387365.htm" title="网吧路由器qos设置的操作步骤" target="_blank">网吧路由器qos设置的操作步骤</a></li>
<li><a href="http://network.51cto.com/art/201303/386815.htm" title="迎合网络时代脚步 探索SDN全新发展机遇" target="_blank">迎合网络时代脚步 探索SDN全新发展机遇</a></li>
<li><a href="http://network.51cto.com/art/201304/387370.htm" title="路由器qos设置包括哪些内容" target="_blank">路由器qos设置包括哪些内容</a></li>
<li><a href="http://network.51cto.com/art/201304/387494.htm" title="解析中国移动互联网未来的发展趋势" target="_blank">解析中国移动互联网未来的发展趋势</a></li>
<li><a href="http://network.51cto.com/art/201304/389875.htm" title="F5 Networks:让应用和网络完美融合 轻" target="_blank">F5 Networks:让应用和网络完美融合 轻</a></li>
<li><a href="http://network.51cto.com/art/201303/386554.htm" title="三种应用性能监控工具对比" target="_blank">三种应用性能监控工具对比</a></li>
<li><a href="http://network.51cto.com/art/201303/386767.htm" title="有关三层交换机的四个特性" target="_blank">有关三层交换机的四个特性</a></li>
</ul>
<h3 id="-">热点专题</h3>
<p><a href="http://network.51cto.com/speclist/481" target="_blank">更多&gt;&gt;</a></p>
<ul>
<li><a href="http://network.51cto.com/art/201101/242851.htm" title="网管软件聚宝盆" target="_blank"><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/140824724.jpg" alt="网管软件聚宝盆"></a></li>
</ul>
<h3 id="-http-network-51cto-com-art-201101-242851-htm-"><a href="http://network.51cto.com/art/201101/242851.htm" title="网管软件聚宝盆" target="_blank">网管软件聚宝盆</a></h3>
<p>网络管理的定义非常广泛，随着互联网的不断发展，对网</p>
<ul>
<li><a href="http://network.51cto.com/art/201101/241997.htm" title="给力呀！负载均衡" target="_blank"><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/180328253.jpg" alt="给力呀！负载均衡"></a></li>
</ul>
<h3 id="-http-network-51cto-com-art-201101-241997-htm-"><a href="http://network.51cto.com/art/201101/241997.htm" title="给力呀！负载均衡" target="_blank">给力呀！负载均衡</a></h3>
<p>互联网的发展快得无法言喻，随之而来的各种应用更是层</p>
<ul>
<li><a href="http://network.51cto.com/art/201012/237093.htm" title="2010年中国十大布线品牌" target="_blank"><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/160830764.jpg" alt="2010年中国十大布线品牌"></a></li>
</ul>
<h3 id="-2010-http-network-51cto-com-art-201012-237093-htm-2010-"><a href="http://network.51cto.com/art/201012/237093.htm" title="2010年中国十大布线品牌" target="_blank">2010年中国十大布线品</a></h3>
<p>中国工程建设标准化协会信息通信专业委员会综合布线工</p>
<h3 id="-">热点标签</h3>
<p><a href="http://network.51cto.com/art/201011/235584.htm" title="局域网网速" target="_blank">局域网网速</a> <a href="http://network.51cto.com/art/200703/41485.htm" title="IPv6" target="_blank">IPv6</a> <a href="http://network.51cto.com/art/201101/241997.htm" title="负载均衡" target="_blank">负载均衡</a> <a href="http://network.51cto.com/cisco/uc/" title="思科" target="_blank">思科</a> <a href="http://network.51cto.com/art/200508/1688.htm" title="交换机典型配置" target="_blank">交换机典型配置</a> <a href="http://network.51cto.com/art/200511/11865.htm" title="VPN技术" target="_blank">VPN技术</a> <a href="http://network.51cto.com/art/200512/13240.htm" title="路由器设置" target="_blank">路由器设置</a> <a href="http://network.51cto.com/art/200512/13840.htm" title="家庭无线局域网" target="_blank">家庭无线局域网</a> <a href="http://network.51cto.com/art/200511/12105.htm" title="路由故障" target="_blank">路由故障</a> <a href="http://network.51cto.com/art/201101/242851.htm" title="网管软件" target="_blank">网管软件</a> <a href="http://network.51cto.com/network/sangfor/optimization/" title="广域网优化" target="_blank">广域网优化</a> <a href="http://network.51cto.com/network/adslr/facemeeting/" title="视频会议" target="_blank">视频会议</a> <a href="http://network.51cto.com/network/move/" title="MOVE无线" target="_blank">MOVE无线</a> <a href="http://network.51cto.com/network/cteam/ccb2010/" title="十大布线品牌" target="_blank">十大布线品牌</a> <a href="http://network.51cto.com/art/200912/169486.htm" title="十大布线品牌" target="_blank">tenda无线路由器设置</a></p>
<ul>
<li><a href="http://news.51cto.com/col/1323/" target="_blank"><strong>点击这里查看样刊</strong></a></li>
<li><p><a href="http://home.51cto.com/index.php?s=/Subscribe" target="_blank"><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/dingy.gif" alt=""></a></p>
<h3 id="-">全站热点</h3>
</li>
<li><p><a href="http://os.51cto.com/art/201201/312873.htm" title="《Linux运维趋势》第16期" target="_blank"><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/133258109.png" alt=""></a></p>
</li>
</ul>
<p><a href="http://os.51cto.com/art/201201/312873.htm" title="《Linux运维趋势》第16期" target="_blank">《Linux运维趋势》第16期</a></p>
<ul>
<li><a href="http://developer.51cto.com/art/201202/314276.htm" title="Java路线图：甲骨文的两年计划" target="_blank"><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/101803336.jpg" alt=""></a></li>
</ul>
<p><a href="http://developer.51cto.com/art/201202/314276.htm" title="Java路线图：甲骨文的两年计划" target="_blank">Java路线图：甲骨文的两年计划</a></p>
<ul>
<li><a href="http://virtual.51cto.com/art/201111/300033.htm" title="VMware不止虚拟化 云计算全方案齐亮相" target="_blank">VMware不止虚拟化 云计算全方案齐亮</a></li>
<li><a href="http://server.51cto.com/News-300011.htm" title="Citrix Synergy 2011独家报道：协作、云、移动" target="_blank">Citrix Synergy 2011独家报道：协作</a></li>
<li><a href="http://book.51cto.com/art/201111/300006.htm" title="SNS营销--网商成功之道" target="_blank">SNS营销--网商成功之道</a></li>
<li><a href="http://book.51cto.com/art/201110/299915.htm" title="海底捞你学不会" target="_blank">海底捞你学不会</a></li>
<li><a href="http://book.51cto.com/art/201110/299819.htm" title="编程匠艺--编写卓越的代码" target="_blank">编程匠艺--编写卓越的代码</a></li>
</ul>
<h3 id="-">读书</h3>
<p><a href="http://book.51cto.com/art/200801/63496.htm" title="软件架构设计" target="_blank"><img src="http://./代理服务器Squid 使用详解 - 51CTO.COM_files/174609703.gif" alt=""></a></p>
<h3 id="-http-book-51cto-com-art-200801-63496-htm-"><a href="http://book.51cto.com/art/200801/63496.htm" target="_blank">软件架构设计</a></h3>
<p>本书紧紧围绕“软件架构设计”这一主题，立足实践解析了软件架构的概念，阐述了切实可行的软件架构设计方法，提供了可操作性极强</p>
<ul>
<li><a href="http://book.51cto.com/art/200709/57047.htm" title="鸟哥的Linux私房菜 基础学习篇（第二版）" target="_blank">鸟哥的Linux私房菜 基础学习篇（第二版）</a></li>
<li><a href="http://book.51cto.com/art/200711/57494.htm" title="Groovy入门经典" target="_blank">Groovy入门经典</a></li>
<li><a href="http://book.51cto.com/art/200710/57701.htm" title="PHP程序开发范例宝典" target="_blank">PHP程序开发范例宝典</a></li>
<li><a href="http://book.51cto.com/art/200710/57877.htm" title="SQL Server 2005中文版精粹" target="_blank">SQL Server 2005中文版精粹</a></li>
</ul>
<h3 id="-">博文推荐</h3>
<p><a href="http://blog.51cto.com/" target="_blank">更多&gt;&gt;</a></p>
<ul>
<li><a href="http://tkato.blog.51cto.com/1119634/262700/" title="IT服务中的人员外包与管理服务外包" target="_blank">IT服务中的人员外包与管理服务外包</a></li>
<li><a href="http://windwing75.blog.51cto.com/191437/262693/" title="知识改变命运？" target="_blank">知识改变命运？</a></li>
<li><a href="http://miracle.blog.51cto.com/255044/262656/" title="别乎略安身立命的基础本领" target="_blank">别乎略安身立命的基础本领</a></li>
<li><a href="http://davyyew.blog.51cto.com/1084625/262648/" title="[职业发展]中国本科生的6大软肋，彰显就业意识不强" target="_blank">[职业发展]中国本科生的6大软肋，彰</a></li>
</ul>
<h3 id="-">最新热帖</h3>
<p><a href="http://bbs.51cto.com/hotthreads.php" target="_blank">更多&gt;&gt;</a></p>
<ul>
<li><a href="http://bbs.51cto.com/thread-471418-1.html" title="大量的H3C方案Visio图标1" target="_blank">大量的H3C方案Visio图标1</a></li>
<li><a href="http://bbs.51cto.com/thread-471418-1.html" title="大量的H3C方案Visio图标1" target="_blank">大量的H3C方案Visio图标1</a></li>
<li><a href="http://bbs.51cto.com/thread-471418-1.html" title="大量的H3C方案Visio图标1" target="_blank">大量的H3C方案Visio图标1</a></li>
<li><a href="http://bbs.51cto.com/thread-426679-1.html" title="BE IT规划资料" target="_blank">BE IT规划资料</a></li>
<li><a href="http://bbs.51cto.com/thread-422145-1.html" title="联想集团内部管理系统（非常好的实用文档）" target="_blank">联想集团内部管理系统（非常好的实用</a><h3 id="51cto-">51CTO旗下网站</h3>
</li>
</ul>
<p><a href="http://www.51cto.com/" target="_blank">领先的IT技术网站 51CTO</a> <a href="http://www.watchstor.com/" target="_blank">领先的中文存储媒体 WatchStor</a> <a href="http://www.cioage.com/" target="_blank">中国首个CIO网站 CIOage</a> <a href="http://www.hc3i.cn/" target="_blank">中国首家数字医疗网站 HC3i</a> <a href="http://www.linkphone.cn/" target="_blank">移动互联网生活门户 灵客风LinkPhone</a></p>
<p>Copyright©2005-2013 <a href="http://www.51cto.com/" target="_blank">51CTO.COM</a> 版权所有 未经许可 请勿转载
0</p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/服务器/">服务器</a></li></span><span class="breadcrumb"><li><a href="/categories/服务器/">服务器</a></li><li><a href="/categories/服务器/Squid/">Squid</a></li></span></span> | <span class="tags">Tagged <a href="/tags/Squid/" class="label label-primary">Squid</a><a href="/tags/服务器/" class="label label-success">服务器</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:44"datetime="2014-03-07 09:54:44"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-服务器-Squid--代理服务器Squid使用详解-51CTOCOM/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-服务器-Squid--代理服务器Squid使用详解-51CTOCOM" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>





<ul id="pagination" class="pagination pagination-lg">
  <li><a class="extend prev" href="/page/25/">&laquo;</a></li><li><a class="page-number" href="/">1</a></li><li><a class="page-number" href="/page/2/">2</a></li><li><span class="space">&hellip;</span></li><li><a class="page-number" href="/page/23/">23</a></li><li><a class="page-number" href="/page/24/">24</a></li><li><a class="page-number" href="/page/25/">25</a></li><li class="active"><li><span class="page-number current">26</span></li><li><a class="page-number" href="/page/27/">27</a></li><li><a class="page-number" href="/page/28/">28</a></li><li><a class="page-number" href="/page/29/">29</a></li><li><span class="space">&hellip;</span></li></li><li><a class="page-number" href="/page/164/">164</a></li><li><a class="page-number" href="/page/165/">165</a></li><li><a class="extend next" href="/page/27/">&raquo;</a></li>
  <div class="clearfix"></div>
</ul></div><!--wapper-->
       </div><!-- ID main-col END -->
       <aside id="sidebar" class="alignright col-sx-6 col-sm-4 col-md-3 col-lg-3">
<div id="widget_search" class="widget panel panel-primary">
    <form action="//google.com/search" method="get" accept-charset="utf-8">
  <div class="input-group">
    <input class="form-control" id="searchbox" type="search" name="q" results="0" placeholder="search">
    <span class="input-group-btn">
      <button class="btn btn-default" type="submit">Go!</button>
    </span>
    <input type="hidden" name="q" value="site:itsolife.com">
  </div>
</form>
</div>

<div id="widget_category" class="widget panel panel-primary">
  <div class="panel-heading">category</div>  <div data-src='category' class='ajax_widgets'>正在加载...</div>
</div>

<div id="widget_recent_posts" class="widget panel panel-primary">
  <div class="panel-heading">recent posts</div>  <div data-src='recent_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_tagcloud" class="widget panel panel-primary">
  <div class="panel-heading">tagcloud</div>  <div data-src='tagcloud' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_latest_update_posts" class="widget panel panel-primary">
  <div class="panel-heading">最近更新</div>  <div data-src='latest_update_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_recent_comments" class="widget panel panel-primary">
  <div class="panel-heading">recent comments</div>  

<div class="list-group-item ds-recent-comments" data-num-items="6" data-show-avatars="1" data-show-time="1" data-show-title="1" data-show-admin="1" data-excerpt-length="50"></div>



</div>

</aside>
       <div class="clearfix"></div>
     </div><!-- row END -->
  </div>
  <footer id="footer" class="container">
  <div class="panel panel-info">
  <section id='footer_widget'></section>  <div class="panel-footer">
  <div id="site-info">
    <span class='author'>
  
  &copy; 2014 RobinChia
  
    &nbsp;&nbsp;</span>
  
  <span id='analytics-51la'></span><span id='analytics-google'>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-48559895-1']);
  _gaq.push(['_trackPageview']);
  _js2load.push({src:('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'});
</script></span><span id='analytics-cnzz'>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_5774006'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s17.cnzz.com/stat.php%3Fid%3D5774006%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</span><span id='analytics-baidu'>
<script>
var _hmt = _hmt || [];
_js2load.push({src:"//hm.baidu.com/hm.js?1442f50724afc42380b51f097c43082c"});
</script>
</span>  </div>
  <div id="copyright">Blog powered by <a href='http://zespia.tw/hexo/'><strong>hexo</strong></a> Theme <strong><a href='https://github.com/chenall/hexo-theme-chenall'>chenall</a></strong>(Some change in it)<span class="pull-right"> 更新时间: <em>2014-03-15 16:01:36</em></span></div>
</div>
<div class="clearfix"></div>


  </div>
  </footer>
  
        <script src="http://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>        
        <script src="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>        
                
        <script src="http://cdn.bootcss.com/prettify/r298/prettify.min.js"></script>    <script type="text/javascript">
   var lang=["bsh", "c", "cc", "cpp", "cs", "csh", "cyc", "cv", "htm", "html",
    "java", "js", "m", "mxml", "perl", "pl", "pm", "py", "rb", "sh",
    "xhtml", "xml", "xsl"];
   var pretty_base='';
   $('script').each(function(){
	var c = $(this).attr('src');
	if (!c)
	    return;
	if (c.match(/(\/)?prettify(\.min)?\.js/i))
	{
	    var index = c.lastIndexOf('/');
	    if (index != -1)
		pretty_base = c.substr(0,index + 1);
	    return false;
	}
   })
   $('pre code').each(function(){
	var c = $(this).attr('class')
	if (!c)
	    return;
	c = c.match(/\s?(lang\-\w+)/i);
	if (c && lang.indexOf(c[1]) == -1)
	{
	    lang.push(c[1]);
	    $.getScript(pretty_base + c[1] + '.min.js');
	}
   })

    $(window).load(function(){
       $("pre").addClass("prettyprint");
       prettyPrint();
    })
</script>    
            <script type="text/javascript">
var duoshuoQuery = {short_name:"robinchia"};
_js2load.push({src:'http://static.duoshuo.com/embed.js',charset:'UTF-8'});
</script>
    
            <!--wumii_relatedItems-->
    
        <script src="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>    <script type="text/javascript">
(function($){
  $('.entry').each(function(i){
    $(this).find('img').each(function(){
      var alt = this.alt;

      if (alt){
        $(this).before('<span class="caption">' + alt + '</span>');
      }

      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="fancybox' + i + '" />');
    });
  });

  $('.fancybox').fancybox();
})(jQuery);
</script>    
        <script src="http://cdn.bootcss.com/mathjax/2.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>
    
<script type="text/javascript">
$('.ajax_widgets').each(function(){var src=$(this).attr('data-src');if(src)$(this).load('/widgets/'+src+'.html');});
$.each(_js2load,function(index,obj){loadjs(obj.src,obj.charset)});
</script>

<div id="scroll2top">
<img src="/scroll2top/arrow.png"/>
</div>
<script src="/scroll2top/scroll2top.min.js"></script>
<div id="winterland">
  <canvas></canvas>
</div>
<script src="/js/winterland.min.js"></script>

  </body>
</html>
