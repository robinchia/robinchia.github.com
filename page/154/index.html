
<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>The 154 Page | It so life</title>
<meta name="author" content="RobinChia">

<meta name="description" content="It so life">


<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta property="og:site_name" content="It so life"/>

<!--[if IE]><style>.testIE.IE{display:inline;}</style><![endif]-->
<!--[if lte IE 7]><link rel="stylesheet" href="/css/ie7.css" type="text/css"><![endif]-->
<!--[if (lt IE 9)&(gt IE 7)]><style>.testIE.IE8{display:inline;}</style><![endif]-->
<!--[if gt IE 8]><style>.testIE.IE9{display:inline;}</style><![endif]-->

<link href="/favicon.png" rel="icon">
<link rel="alternate" href="/atom.xml" title="It so life Feed" type="application/atom+xml">

<link rel="stylesheet" href="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/font-awesome/4.0.3/css/font-awesome.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/prettify/r298/prettify.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" type="text/css">
<link rel="stylesheet" href="/css/style.css" type="text/css">
<!--[if lt IE 9]>
   <style>article,aside,dialog,footer,header,section,footer,nav,figure,menu{display:block}</style>
   <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
   <script src="http://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
<link href="http://cdn.staticfile.org/respond.js/1.4.2/respond-proxy.html" id="respond-proxy" rel="respond-proxy" />
<link href="/js/respond.proxy.gif" id="respond-redirect" rel="respond-redirect" />
<script src="/js/respond.proxy.js"></script>
   <script src="http://cdn.bootcss.com/selectivizr/1.0.2/selectivizr-min.js"></script>
<![endif]-->
<script type="text/javascript">
function loadjs(c,d){var a=document.createElement("script");a.async=!0;a.type="text/javascript";a.src=c;a.charset=d||"gbk";(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(a)};
var _protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
var _js2load = [];
</script>

</head>
<body>
      <header id="header" class="container"><nav id="main-nav" class="navbar navbar-default navbar-fixed-top " role="navigation">
  <div class="container">
    <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/">It so life</a>
    </div>
    <div  class="collapse navbar-collapse">
      <ul  class="nav navbar-nav">
  
        <li><a href="/" title="Home">Home</a></li>      
        <li><a href="/about/" title="About">About</a></li>      
        <li><a href="/archives/" title="Archives">Archives</a></li>      
      <li class='dropdown'>
        <a class='dropdown-toggle' data-toggle='dropdown' href='#'>website<b class='caret'></b></a>
        <ul class='dropdown-menu pure-menu-selected'>
    
          <li><a href="//groups.google.com/forum/#!forum/pongba" title="TopLanguage">TopLanguage</a></li>    
          <li><a href="//itpub.net/" title="ITPub">ITPub</a></li>    
          <li><a href="//blog.jobbole.com/" title="Bole">Bole</a></li>    
          <li><a href="//nosql-database.org/" title="nosql">nosql</a></li>    
          <li><a href="//gitimmersion.googol.im/" title="Git">Git</a></li>    
        </ul>
      </li>
    
      </ul>
      <ul class="nav navbar-nav navbar-right">
      
        <li><a href="/atom.xml">RSS</a></li>
      
      
        <li><a href="https://twitter.com/robinchia">twitter</a></li>
      
      
      
      
        <li><a href="https://github.com/robinchia">github</a></li>
      
      </ul>
    </div>
  </div>
</nav>
<div class="clearfix"></div>
</header>
  <div id='content' class="container">
     <div class="page-header-wrapper">
      <!--[if lt IE 9]><div class="alert alert-warning alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>提示:</strong>您的浏览器版本太低了,建议升级到 <strong><a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" title="IE9">IE9</a></strong> 以上,本站使用<a href="https://www.google.com/intl/zh-CN/chrome/">Chrome浏览器</a>可以获得最好的显示效果.</div><![endif]-->
      <div class="page-header"><h1 align="center"><big>It so life</big> </h1>
        <h5 align="center"><big>love as life</big></h5>
      </div>
     </div>
     <div class="row">
       <div id="main-col" class="alignleft col-sx-12 col-sm-8 col-md-9 col-lg-9">
      <section id='header_widget'></section>
          <div id="wrapper"><article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JS用法--一个javascriptvoid0引发的异常-Tech-JavaEye论坛/">一个javascriptvoid(0)引发的异常 </a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:28.000Z"> <a href="/2014/02/02/2014-02-02-JS用法--一个javascriptvoid0引发的异常-Tech-JavaEye论坛/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="-javascriptvoid-0-tech-javaeye-">一个javascriptvoid(0)引发的异常 - Tech - JavaEye论坛</h1>
<p><a href="http://www.javaeye.com/login" title="登录" target="_blank">您还未登录 !</a> <a href="http://www.javaeye.com/all" target="_blank">我的应用</a> <a href="http://www.javaeye.com/login" target="_blank">登录</a> <a href="http://www.javaeye.com/signup" target="_blank">注册</a></p>
<p><a href="http://www.javaeye.com/" target="_blank"><img src="&quot;JavaEye-最棒的软件开发交流社区&quot;" alt="JavaEye-最棒的软件开发交流社区"></a></p>
<p><img src="" alt=""></p>
<p><a href="http://www.javaeye.com/forums" target="_blank">论坛首页</a> → <a href="http://www.javaeye.com/forums/board/Tech" target="_blank">综合技术版</a> →</p>
<h1 id="-javascript-void-0-">一个javascript:void(0)引发的异常</h1>
<p><a href="http://www.javaeye.com/forums/board/Tech" target="_blank">全部</a> <a href="http://www.javaeye.com/forums/tag/Database" target="_blank">Database</a> <a href="http://www.javaeye.com/forums/tag/Haskell" target="_blank">Haskell</a> <a href="http://www.javaeye.com/forums/tag/Erlang" target="_blank">Erlang</a> <a href="http://www.javaeye.com/forums/tag/FP" target="_blank">FP</a> <a href="http://www.javaeye.com/forums/tag/Linux" target="_blank">Linux</a> <a href="http://www.javaeye.com/forums/tag/algorithm" target="_blank">数据结构和算法</a>
浏览 567 次 锁定老贴子 <a href="http://www.javaeye.com/topic/290261" target="_blank">主题：一个javascript:void(0)引发的异常</a></p>
<p>精华帖 (0) :: 良好帖 (0) :: 新手帖 (0) :: 隐藏帖 (0) 作者 正文 * classicbride</p>
<ul>
<li>等级: 初级会员</li>
<li><a href="http://classicbride.javaeye.com/" target="_blank"><img src="&quot;classicbride的博客: classicbride&quot;" alt="classicbride的博客"></a></li>
<li>文章: 41</li>
<li>积分: 30</li>
<li>来自: 北京</li>
<li><img src="" alt="">
发表时间：2008-12-10</li>
</ul>
<p>相关文章: <a href="http://www.javaeye.com/topic/290261#" title="关闭" target="_blank"> </a></p>
<ul>
<li><a href="http://www.javaeye.com/topic/214030" title="Broken pipe　/  socket write error异常" target="_blank">Broken pipe　/ socket write error异常</a></li>
<li><a href="http://www.javaeye.com/topic/31800" title="ClientAbortException原因探究" target="_blank">ClientAbortException原因探究</a></li>
<li><a href="http://www.javaeye.com/topic/10392" title="确实冤枉好同志了" target="_blank">确实冤枉好同志了</a>
推荐圈子: <a href="http://jsfgroup.group.javaeye.com/" target="_blank">JSF</a>
<a href="http://www.javaeye.com/wiki/topic/290261" target="_blank">更多相关推荐</a>  当用户登陆时，需要用户输入验证码，在服务器端生成一张内存图像，写入response流中...
当用户点击“看不清楚，换成图片”时，利用javascript重新请求服务器端，生成新的图像... 到了这里万事大吉一切正常，在firefox下，IE7下都没有问题，但是在IE6下问题来了，无法刷新验证码，后台报错：
ClientAbortException:  java.net.SocketException: Connection reset by peer: socket write error
at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:319)
at org.apache.catalina.connector.OutputBuffer.flush(OutputBuffer.java:288)
at org.apache.catalina.connector.CoyoteOutputStream.flush(CoyoteOutputStream.java:98)
at javax.imageio.stream.FileCacheImageOutputStream.flushBefore(FileCacheImageOutputStream.java:212)
at javax.imageio.stream.ImageInputStreamImpl.flush(ImageInputStreamImpl.java:801)
at com.sun.imageio.plugins.jpeg.JPEGImageWriter.write(JPEGImageWriter.java:1002)
google半天，说法很多，有说是因为服务器端数据没有写完时，客户端就停止了引发的... 但一直找不到问题的根本原因，继续google，终于找到原因，首先看看偶的代码
<img id="codeImage" src="validateCode.action" border="0" /> <a id="getValidateCode" href="javascript:void(0);">重新获得验证码</a>
function flashValidateCode(){ var randomStr = random(); $(&quot;/#codeImage&quot;).get(0).src = &quot;validateCode.action?randomStr=&quot; + randomStr; } function random(){ return Math.round(Math.random() /* 10000); }
当用户有点击重新获取验证码时，我监听一个onclick事件，请求服务器生成新的图像，而我又写了href=&quot;javascript:void(0);&quot;
对了，问题就出在javascript:void(0)，<a></a>本身是一个超链接，它一个接受到了void(0)，就认为请求处理完毕了，垃圾IE6就停止了对服务器端的响应，就造成了上述的问题，所以将代码改成：
<img id="codeImage" src="validateCode.action" border="0" /> <a id="getValidateCode" href="/#">重新获得验证码</a>
就o了~ 吼吼~ 这个小问题折磨我很久，日~！！ 
声明：JavaEye文章版权属于作者，受法律保护。没有作者书面许可不得转载。</li>
</ul>
<p>推荐链接</p>
<ul>
<li><a href="http://www.javaeye.com/clicks/111" target="_blank"><img src="&quot;taobao，赢在淘宝&quot;" alt="taobao，赢在淘宝"></a> <a href="http://www.javaeye.com/topic/290261#" target="_blank">返回顶楼</a> <a href="http://classicbride.javaeye.com/" title="浏览作者的博客" target="_blank"> </a> <a href="http://classicbride.javaeye.com/blog/profile" title="浏览作者资料" target="_blank"> </a> <a href="http://app.javaeye.com/messages/new?message%5Breceiver_name%5D=classicbride" title="发送站内短信" target="_blank"> </a> <a href="http://classicbride.javaeye.com/blog/guest_book" title="给作者留言" target="_blank"> </a> 最后修改：2008-12-10</li>
</ul>
<p><a href="http://www.javaeye.com/forums" target="_blank">论坛首页</a> → <a href="http://www.javaeye.com/forums/board/Tech" target="_blank">综合技术版</a>
跳转论坛:Java编程和Java企业应用 Web前端技术：AJAX和RIA 移动编程和手机应用开发 C/C++编程 Ruby编程 Python编程 PHP编程 Flash编程 Microsoft .Net 综合技术 软件开发和项目管理 行业应用 入门讨论 招聘求职 海阔天空</p>
<ul>
<li><a href="http://www.javaeye.com/" target="_blank">首页</a></li>
<li><a href="http://www.javaeye.com/news" target="_blank">新闻</a></li>
<li><a href="http://www.javaeye.com/forums" target="_blank">论坛</a></li>
<li><a href="http://www.javaeye.com/ask" target="_blank">问答</a></li>
<li><a href="http://www.javaeye.com/wiki" target="_blank">知识库</a></li>
<li><a href="http://www.javaeye.com/blogs" target="_blank">博客</a></li>
<li><a href="http://www.javaeye.com/groups" target="_blank">圈子</a></li>
<li><a href="http://www.javaeye.com/hunters" target="_blank">猎头</a></li>
<li><a href="http://www.javaeye.com/job" target="_blank">招聘</a></li>
<li><a href="http://www.javaeye.com/index/service" target="_blank">服务</a></li>
<li><a href="http://www.javaeye.com/google_search" target="_blank">搜索</a></li>
<li><a href="http://java.javaeye.com/" target="_blank">Java</a></li>
<li><a href="http://webapp.javaeye.com/" target="_blank">Web</a></li>
<li><a href="http://ruby.javaeye.com/" target="_blank">Ruby</a></li>
<li><a href="http://python.javaeye.com/" target="_blank">Python</a></li>
<li><a href="http://agile.javaeye.com/" target="_blank">敏捷</a></li>
<li><a href="http://mysql.javaeye.com/" target="_blank">MySQL</a></li>
<li><a href="http://primeton.javaeye.com/" target="_blank">普元</a></li>
<li><a href="http://dorado.javaeye.com/" target="_blank">Dorado</a></li>
<li><a href="http://kingdee.javaeye.com/" target="_blank">金蝶中间件</a></li>
<li><a href="http://book.javaeye.com/" target="_blank">图书</a></li>
<li><a href="http://www.javaeye.com/index/service" target="_blank">广告服务</a></li>
<li><a href="http://webmaster.javaeye.com/" target="_blank">JavaEye黑板报</a></li>
<li><a href="http://www.javaeye.com/index/aboutus" target="_blank">关于我们</a></li>
<li><a href="http://www.javaeye.com/index/contactus" target="_blank">联系我们</a></li>
<li><a href="http://www.javaeye.com/index/friend_links" target="_blank">友情链接</a></li>
</ul>
<p>© 2003-2009 JavaEye.com. All rights reserved. [ 沪ICP备05023328号 ]</p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/JS用法/">JS用法</a></li></span></span> | <span class="tags">Tagged <a href="/tags/JS用法/" class="label label-primary">JS用法</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:28"datetime="2014-03-07 09:54:28"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JS用法--一个javascriptvoid0引发的异常-Tech-JavaEye论坛/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JS用法--一个javascriptvoid0引发的异常-Tech-JavaEye论坛" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-架构师-架构--知名网站的技术实现/">知名网站的技术实现</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:28.000Z"> <a href="/2014/02/02/2014-02-02-架构师-架构--知名网站的技术实现/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="-">知名网站的技术实现</h1>
<h1 id="-bluedavy-blog-https-blog-bluedavy-com-"><a href="https://blog.bluedavy.com/" target="_blank">BlueDavy之技术blog</a></h1>
<p>{互联网，OSGi，Java, High Scalability, High Performance,HA}</p>
<ul>
<li><a href="https://blog.bluedavy.com/" target="_blank">Home</a></li>
<li><a href="https://blog.bluedavy.com/?page_id=2" target="_blank">About</a></li>
<li><a href="https://blog.bluedavy.com/?page_id=81" target="_blank">Photos</a></li>
</ul>
<h2 id="-https-blog-bluedavy-com-p-396-"><a href="https://blog.bluedavy.com/?p=396" title="知名网站的技术实现" target="_blank">知名网站的技术实现</a></h2>
<p>Jun 14</p>
<p><a href="http://bluedavy.com/" title="Visit bluedavy’s website" target="_blank">bluedavy</a><a href="https://blog.bluedavy.com/?cat=6" title="View all posts in 互联网" target="_blank">互联网</a> <a href="https://blog.bluedavy.com/?tag=%e4%bd%8e%e6%88%90%e6%9c%ac" target="_blank">低成本</a>, <a href="https://blog.bluedavy.com/?tag=%e5%8f%af%e4%bc%b8%e7%bc%a9%e6%80%a7" target="_blank">可伸缩性</a>, <a href="https://blog.bluedavy.com/?tag=%e5%8f%af%e7%94%a8%e6%80%a7" target="_blank">可用性</a>, <a href="https://blog.bluedavy.com/?tag=%e6%80%a7%e8%83%bd" target="_blank">性能</a> <a href="&quot;Comment on 知名网站的技术实现&quot;">No Comments</a>
在上一篇《<a href="http://blog.bluedavy.com/?p=389" title="知名网站的技术发展历程" target="_blank">知名网站的技术发展历程</a>》中，介绍了一些知名网站在发展的过程中技术的演变，在这篇文章中则会根据这些网站的发展经验，来总结通常网站是如何来应对可伸缩性、可用性、高性能以及低成本这四方面的挑战的。</p>
<p>在上一篇文章中，介绍了一些Alexa排名较前的网站的技术发展历程，在这篇文章中，将结合提及到的网站的技术发展历程，来总结下网站在可伸缩性、可用性、高性能以及低成本四点上通常采用的技术。
对于一个网站而言，最重要的是要支撑住不断增长的访问量和数据量，如果能做到简单的增加机器即可支撑，那自然是最好的，但这就要求技术上必须付出一定的努力，这也是网站都追求的可伸缩性（Scalability），而在做到可伸缩性后，不断增加的机器也带来了成本的上升，因此发展到了一定规模后，成本也会成为关注的重点。
除了可伸缩性外，可用性对于各网站而言也非常重要，一个经常不能使用的网站必被用户抛弃，这也是为什么各网站都很强调全年的可用性。
除了上面这三点外，还有另外一点影响也很明显，就是性能，美国的一个对网站访问速度的调查数据：1/4的用户因为一个网站载入的时间超过4秒而放弃这个网站，50%的手机用户会放弃一个超过10秒还没载入完成的网站，其中的3/5用户将不再光顾这个网站，而Google对其数据分析后，发现搜索结果只要慢1/4秒，一天的搜索量就要减少800万。</p>
<p>可伸缩
可伸缩分为垂直伸缩和水平伸缩，垂直伸缩为通过升级机器的硬件来解决问题，水平伸缩为通过增加机器来解决问题，不同网站在可伸缩上采用了不同的策略，例如Google完全依赖水平伸缩来解决问题，而其他网站多数是先依赖垂直伸缩来解决数据存储的问题。
垂直伸缩要求的是软件上要能在硬件升级的情况下，发挥出硬件的能力，例如可配置的并行数、内存等，硬件的发展速度非常迅猛，网站的机器的配置自然也是每年都在升级，因此其实我们的软件时刻都在被检验是否能垂直伸缩。
水平伸缩主要要解决的是如何做到仅通过增加机器就解决问题，主要又分成了应用层和存储层两个层次来解决。
在应用层要做到水平伸缩，通常采用的策略是Share Nothing/Stateless，状态信息放入客户端或存储层（例如用户的Session信息放入Cookie，或放入服务器端的缓存系统），应用系统做到了无状态，那么在访问量上涨后只需要增加机器即可，在应用系统由单台增加到多台组成Cluster时，这时就会有负载均衡的引入，可能是硬件的也可能是软件的。
在应用层的结构演变上，我们会发现，随着网站的不断发展，以上提到的各家网站在应用层上最后形成的结构几乎都完全一样，均为前端Web系统Cluster + Services Cluster，前端Web系统和Services到了一定的阶段后通常又会按照一定的规则来进行拆分，如按业务领域等，可见SOA其实在大网站中是落地了的，而不像企业领域中宣传的那么虚。
在存储层要做到水平伸缩，难度就比应用层大多了，从前面各家网站的发展历程也可看出，很多时候都在解决存储层的问题，而且可以看出，很多网站由于业务发展的压力较大，一开始都会选择采用垂直伸缩的方式来解决存储层的问题。
存储层主要是Cache、文件和数据三种类型。
Cache可以看到基本上各家网站都采用了Memcache来保证伸缩性，在规模大了，也会碰到一些问题，具体可以看看facebook所做的改造，现在也有些网站开始采用redis了，但redis本身不具备可伸缩性，需要自行进行改造。
文件的存储可以看到各家网站都采用了分布式文件系统来保证伸缩性，思路多数都源于GFS，但由于存储的文件的大小不同、对响应时间和吞吐量的要求不同，各家网站可能都各自实现。
数据的存储上可以看到各家网站基本都采用了分库分表的策略，分库分表后由于很多关系型数据库的特性（例如自增ID、join、事务等）都难以再使用了，对应用的设计会带来一些挑战，不过最大难点还是在于需要根据业务来考虑如何分是合适的，在最近几年也有一些网站开始采用NoSQL来更好的做到数据存储的可伸缩性。
存储层为了做到可伸缩性，通常采用的方案是单点写（是指在某个粒度的单点，例如对HBase而言，是单行数据一定是在同一台机器上进行写操作），但读可能是多点，读多点的话主要要考虑不一致的问题，无论读是单点还是多点，数据都会在软件层面做到写多份，策略主要有同步写多份、投票写多份、异步复制最终一致等（例如HDFS、Cassandra、Zookeeper），采用自动分裂的方法来实现数据量增长时的自动伸缩，采用一致性hash或根据某种规则的自动balance策略等来实现机器增减时的相应处理，同时也需要有感知机器增减的方法（例如采用zookeeper）。
从上面可以看到存储层上要做到可伸缩，技术上的难点很多，这也是为什么大规模的网站都不在数据库上做复杂的运算，而只是把其当做一种存储来使用，例如存储过程这种就更是基本不会出现了，以降低数据库的压力。
除了应用层和存储层需要做到可伸缩外，硬件层面的可伸缩在设计系统时也是需要考虑的，例如硬件负载设备只能支撑到一定的流量，同样也需要考虑如何让其能够可伸缩。
除了尽可能做到系统可伸缩外，减少对系统的压力也是缓解系统的可伸缩面临挑战的方法，例如批量提交、最终一致、youtube提到的“欺骗”、适当的正确性等策略。
可伸缩性是网站从小到大要经历的第一关挑战，而且随着网站的不断发展，还要不断的做技术改造才能保证网站在每个不同的阶段（例如同机房阶段、同城多机房阶段、异地多机房阶段）都具备优秀的可伸缩性，不过幸运的是不同阶段的可伸缩性方案都已经比较成熟。</p>
<p>可用性
可伸缩性保证了网站在不断增长的访问量和数据量的情况下生存下来，这也一定程度保证了网站的可用性，但除了这点外，要保障系统的可用性，还得付出很多的努力。
在设计高可用性的系统时，避免单点是其中最重要的一点，通常采用主备和集群的方法来避免单点，例如负载均衡设备、MySQL等通常采用主备的方式，在BigTable里采取了一种比较特殊的方法来避免Tablet Server的单点：通过Chubby来感知Tablet Server的健康状况，如发现Tablet Server挂掉了，则由Master将此Tablet Server负责的Tablet迁移到其他的Tablet Servers上。
除了避免单点外，降低耦合也是设计高可用性系统时应考虑的重点，通常可以采取异步化来降低耦合，将非关键逻辑和关键逻辑隔离开，例如在淘宝上买一件商品，确认购买了后，需要旺旺通知卖家，如果旺旺通知卖家这个过程是同步通知的话，对于系统来说无疑增加了一个风险点，因此可以将旺旺通知卖家的步骤变为异步的方式来做，这种场景的异步通常又采用消息中间件来实现；还有另外一种场景也经常采用异步化的方式来降低耦合，例如打开天猫的商品详情时，都会有相关商品的推荐，如果这个推荐系统出问题的话，就会导致商品详情也看不到了，因此这里也可以采用异步化来加载推荐系统，在这种场景中通常采用Ajax带超时的方式来实现。
各网站在总结多年的可用性系统设计的经验时，有一个设计原则被所有网站列入：保持简单，简单的方案意味着容易掌控，而复杂的方案一方面意味着实现难度大，另一方面意味着出现问题时很难排查。
可控性也是各网站强调的重点，可控性就意味着一切的代码都在掌握下，并且最好是每个使用到的部分都有专业的人士（对可用性要求越高，在这点上要求也就越高），这样才能清楚在出现问题的时候是哪个地方造成的，并且可以自行排查和解决，如不可控，则意味着一旦出现问题，就得依赖第三方来排查，那这个时间就非常不可控了，这也是网站不采用商用软件的重要原因。</p>
<p>编写高质量软件是保障系统高可用性的重要一环（可控性也是编写高质量软件的基础），但软件几乎不可能做到0 bug，各网站在总结自己保障高可用的经验中提到了一些策略用于保障系统的高可用，这些策略主要包括：监控/报警、容错、自我保护、隔离、和降级，需要做到高可用的软件在交付时都应具备这些特性。
监控/报警是软件自身能够保障高可用的重要策略，就像是汽车的仪表盘一样，可以告诉你油还剩多少，速度是多少，胎压是否正常等重要信息，对于软件而言，同样需要让外部可以获取到其运行的状况，例如Google的软件都会提供一个html的页面供使用者或开发人员访问（用过Hadoop的人也会发现这个特征），在这个页面上可通过key/value的方式来获取系统的一些运行指标，对外RPC的系统Google会采集所有的正常请求、错误请求以及其消耗时间的分布状况（&gt;0.05s的，&gt;0.1s等），除了监控系统的运行状况外，也需要提供一些方式以便外部能简单判断系统运行是否正常，例如curl某页面等，对于不正常的现象要进行即时的报警，以尽可能做到在故障尚未影响到用户时进行解决。
软件会依赖很多外部的因素，例如机房、硬件、数据库、服务等，而所有依赖的部分都是有可能出现故障的（要坚信这点，互联网的特色是所有小概率事件都会发生），在设计软件时需要考虑当依赖方出问题时，如何能保障软件本身的可用性，因此一定要做一些容错的处理，例如对于机房故障，各网站通常都会租用或建设多机房来避免；又例如Google采用IDE硬盘来存储文件，不做Raid，于是采用了复制三份的策略来避免硬盘故障导致数据丢失。
软件通常会接受外部的输入，而有些时候输入条件的不符合预期可能会导致软件的故障，在我们的系统中曾经出现的一个故障案例：某系统对外提供了批量查询的功能，结果有一次客户端提交了一个查找10000个用户的批量查询，导致系统由于内存不够出现了故障，因此在设计软件时需要保障处理自己能力范围的请求，对于超出能力的请求可以考虑直接抛错，还有一种常见的是后端处理变慢导致雪崩效应的故障，这种在软件上通常会采用超时、限流等方式来避免，对于这些可能出现的故障在设计软件时都应考虑采取一些保护的措施来保护自身的可用性。
软件通常提供了多种功能，这些功能会有重要的和不重要的，如果由于不重要的功能异常导致重要的功能出现问题，显然是不合算的，因此在设计软件时需要充分的考虑异常的隔离，不互相影响，例如在Google的系统设计中会采用Prioritized Request等策略。
降级即为James Hamilton的那篇著名的《On Designing and Deploying Internet-Scale Services》论文中提到的Graceful Degradation，降级通常采用的方法是在故障将要出现或出现后，通过关闭系统的一些功能来降低故障产生的影响，例如网站上有些操作可能是特别耗资源的，而这些资源的消耗又可能会导致影响到核心功能，一旦出现影响时，就可以通过关闭这些功能保障核心功能的可用，降级通常用于临时的绕开故障，故障的原因则事后排查。</p>
<p>交付具备高可用特征的软件是开发人员的重要职责，而对于一个网站而言，软件不是一次性交付的，也不是好几年才升级一次的，而是频繁交付的，因此对软件本身的维护也是保障高可用的重要环节。
通常，系统的不可用是变更造成的，如何降低变更对系统可用性造成的影响，是各网站都关注的重点，Google在发布时通常采取“滚木移石”的方法、Facebook则通常采用Dark launch的方法，以降低变更带来的影响。
人工来操作系统的变更是故障产生的隐患，因此各网站基本都会推荐多种工具来实现系统变更的自动化，例如采用puppet来实现自动化的部署。
除了发布这个重要环节外，处理故障也是维护的重要工作，系统总是会有出现故障的时候的，出现故障时如何快速的处理来降低对可用性的影响也成为了网站一直关注的重点，前文已经说到可控性对解决故障的帮助，除了可控外，各网站也会研究一些其他的方法，Facebook就采用了FBAR来自动处理部分故障，这显然可以一定程度降低故障产生的影响。</p>
<p>性能
在前文中提到的可控性同样也是保证性能的重点，只有明确的知道调用的每个API，依赖的环境（包括软硬件）的细节原理，才能编写出高性能的软件。
从系统结构上来看，我们可以看到各大网站在发展到今天的时候，为了保障高性能都采用了类似的方法，首先是前端Web系统这块，都采用了可编译为机器码的方式，例如即使是Facebook采用php，其仍然研发了一个可自动转化为C++代码的产品来提升运行效率。
设计系统时应考虑将没有前后依赖的逻辑并行化处理，，或者将大的请求进行拆分，例如在Google上进行搜索，Google会进行分词，然后并行的进行索引的查询，从而提高响应速度。
基本上各大网站都极度依赖Cache，这原因很明显，内存的访问速度远快于磁盘，依赖Cache的场景中最需要做到的是数据一致性的合理保障，一个典型的场景是数据更新时保障Cache一致性的策略，Cache的更新和数据的更新如果要做成一个事务显然有不小的难度，此时网站常采用一个简单策略来保障，就是先失效Cache，再更新数据，等到下次系统去访问此数据时，才更新到内存。
除了Cache外，可以看到各大网站都采用了CDN，CDN可以让静态文件更加的靠近用户，以便用户快速获取，而除了让静态文件更靠近用户外，多IDC的建设除了提升可用性外，还可实现让动态数据更靠近用户，当然，这个在技术上的实现难度会比CDN高很多。
除了结构上的这几点外，技术创新是提升系统性能的重要方法，例如Google提高TCP的初始拥塞窗口值等，而要做到技术创新，显然可控性就是基础了。</p>
<p>成本
随着网站规模的不断扩大，系统的运行和维护成本将会成为公司中支出的重要部分，例如有数据表明腾讯每年的支出中，支付给运营商的费用是其中占比排第二的部分（2010年为208亿），因此网站规模越大，成本控制就越重要（潜台词是网站规模在不是很大的时候，也许支撑业务快速发展更重要），例如Google在设计系统时price/performance是重要的考量指标，有些网站也会采用x元/每千次page views来计算成本。
性能优化有些是需要增加成本的（例如cache、CDN），而有些性能优化是可以降低成本（例如Google对Index结构的优化）的，因此通常性能优化也是降低成本的一种方法，网站规模大了后的规模效应可以让有些性能优化带来的成本降低非常的明显。
硬件的不断升级，而软件系统层面上又更多的是靠cluster来支撑，因此通常很难完全消耗硬件资源，虚拟化就成为一种不错的降低成本的方法，虚拟化具备了很好的隔离机制，避免了应用的互相影响，因此落地的难度不大。
除了依靠虚拟化来降低成本的方法外，Google则采用了自行实现的一种Shared Environment的方法来降低成本，Shared Environment可根据不同类型的资源消耗，动态组合（例如分时）部署到同一台机器上，充分的发挥机器的资源。
在前文中也讲到，网站主要是靠可伸缩存活下来，随着规模的扩大，必然会有大量的机器， Google有上百万台的机器，Facebook有几十万台机器，在这么大规模的情况下，自行根据应用特征设计机器，会带来很大的成本下降，因此Google、Facebook都自行设计机器以及自行设计DataCenter，从PUE上就可以看到Google/Facebook自行设计DataCenter带来的成本降低是非常可观的。</p>
<p>以上四点挑战会由于网站业务的不同、人员知识结构的不同、做事风格的不同以及所处的阶段不同而采用不同的方法去解决，每个阶段都有自己适用的解决方案，例如Google在成立之初业务为搜索，相对而言搜索市场的竞争主要是技术，功能次之，而facebook/eBay等网站的竞争压力主要在业务功能上，因此在成立之初的时候必然会有不同的侧重点，所以也不用想着一开始就去把网站做成Google/Facebook等现在的结构，选择适合自己网站的就是好的，很多开发人员在加入规模较大的网站后，会觉得系统结构已经稳定了，没有发展的空间，但从上面各网站的发展历程来看，可以看出网站对技术的要求是不断在演变的，通过观察大网站的发展历程，对自己结合公司的业务背景、知识结构等来判断其下一步的发展，是会有很大的帮助的，并且也可以借此储备一些技术，以把握技术演变时的机会，获得更大的成长，如果是加入规模尚小的网站，技术储备做的好的话，就有机会亲身经历网站从小到大的演变了，因此都有机会，就看个人如何把握。
围绕这四个方向的发展，通常网站在发展到一定规模后会演变成类似如下的结构：
<img src="&quot;网站的常见结构&quot;" alt="">
除了在可伸缩性、可用性、性能以及成本这四点的技术挑战外，网站还面临了其他很多方面的挑战，例如海量数据的分析和挖掘、网站安全、业务发展的灵活性支撑、人员增长后庞大的软件管理等等，因此构建一个支撑大访问量、长期发展、低成本运行的网站是需要有坚实的技术作为支撑的。</p>
<p><a href="https://blog.bluedavy.com/?p=389" target="_blank">知名网站的技术发展历程</a> <a href="https://blog.bluedavy.com/?p=409" target="_blank">一个Java应用频繁抛异常导致cpu us诡异现象的案例</a></p>
<h3 id="leave-a-reply">Leave a Reply</h3>
<p><a href="">Cancel</a></p>
<p>Name (required)</p>
<p>Mail (required)</p>
<p>Website</p>
<p><img src="https://blog.bluedavy.com/wp-content/plugins/si-captcha-for-wordpress/captcha/securimage_show.php?si_form_id=com&amp;prefix=aERM6a3KH91Fl40W" alt="CAPTCHA Image" title="CAPTCHA Image"></p>
<p><a href="&quot;Refresh Image&quot;"><img src="" alt="Refresh Image"></a></p>
<p>CAPTCHA Code /*</p>
<p><style type='text/css'>/#submit {display:none;}</style><br /> <input name="submit" type="submit" id="submit-alt" tabindex="6" value="Submit Comment" /></p>
<p>July 2013 M T W T F S S <a href="https://blog.bluedavy.com/?m=201303" title="View posts for March 2013" target="_blank">« Mar</a>     1234567 891011121314 15161718192021 22232425262728 293031  </p>
<h3 id="categories">Categories</h3>
<ul>
<li><a href="https://blog.bluedavy.com/?cat=63" title="View all posts filed under Java" target="_blank">Java</a> (10)</li>
<li><a href="https://blog.bluedavy.com/?cat=13" title="View all posts filed under jvm" target="_blank">jvm</a> (19)</li>
<li><a href="https://blog.bluedavy.com/?cat=56" title="View all posts filed under NoSQL" target="_blank">NoSQL</a> (7)</li>
<li><a href="https://blog.bluedavy.com/?cat=4" title="View all posts filed under SOA" target="_blank">SOA</a> (1)</li>
<li><a href="https://blog.bluedavy.com/?cat=11" title="关于《分布式Java应用：基础与实践》书部分章节的公开、书内容的纠错以及补充完善。" target="_blank">书:分布式Java应用</a> (5)</li>
<li><a href="https://blog.bluedavy.com/?cat=6" title="View all posts filed under 互联网" target="_blank">互联网</a> (5)</li>
<li><a href="https://blog.bluedavy.com/?cat=46" title="View all posts filed under 产品总结" target="_blank">产品总结</a> (1)</li>
<li><a href="https://blog.bluedavy.com/?cat=18" title="View all posts filed under 优化案例" target="_blank">优化案例</a> (1)</li>
<li><a href="https://blog.bluedavy.com/?cat=12" title="View all posts filed under 圆桌交流" target="_blank">圆桌交流</a> (2)</li>
<li><a href="https://blog.bluedavy.com/?cat=8" title="View all posts filed under 容量规划" target="_blank">容量规划</a> (2)</li>
<li><a href="https://blog.bluedavy.com/?cat=97" title="View all posts filed under 迁户口" target="_blank">迁户口</a> (1)</li>
<li><a href="https://blog.bluedavy.com/?cat=52" title="View all posts filed under 高可用" target="_blank">高可用</a> (1)</li>
<li><a href="https://blog.bluedavy.com/?cat=3" title="View all posts filed under 高并发" target="_blank">高并发</a> (3)</li>
<li><p><a href="https://blog.bluedavy.com/?cat=1" title="关于性能优化方面的一些东西。" target="_blank">高性能</a> (2)</p>
<h3 id="recent-comments">Recent Comments</h3>
</li>
<li><p><a href="http://code1.riaos.com/?p=5030138" target="_blank">JVM调优 | code1（code1.riaos.com）</a> on <a href="https://blog.bluedavy.com/?p=70&amp;cpage=1#comment-16520" target="_blank">说说MaxTenuringThreshold这个参数</a></p>
</li>
<li><a href="http://architecture1.riaos.com/?p=3063358" target="_blank">JVM调优 | architecture（riaos.com）</a> on <a href="https://blog.bluedavy.com/?p=70&amp;cpage=1#comment-16519" target="_blank">说说MaxTenuringThreshold这个参数</a></li>
<li><a href="http://bluedavy.com/" target="_blank">bluedavy</a> on <a href="https://blog.bluedavy.com/?p=409&amp;cpage=1#comment-16462" target="_blank">一个Java应用频繁抛异常导致cpu us诡异现象的案例</a></li>
<li>xiaobo on <a href="https://blog.bluedavy.com/?p=409&amp;cpage=1#comment-16460" target="_blank">一个Java应用频繁抛异常导致cpu us诡异现象的案例</a></li>
<li><a href="http://bluedavy.com/" target="_blank">bluedavy</a> on <a href="https://blog.bluedavy.com/?p=409&amp;cpage=1#comment-16459" target="_blank">一个Java应用频繁抛异常导致cpu us诡异现象的案例</a></li>
</ul>
<h3 id="tags">Tags</h3>
<p><a href="https://blog.bluedavy.com/?tag=btrace" title="2 topics" target="_blank">btrace</a> <a href="https://blog.bluedavy.com/?tag=c1" title="1 topic" target="_blank">c1</a> <a href="https://blog.bluedavy.com/?tag=c2" title="1 topic" target="_blank">c2</a> <a href="https://blog.bluedavy.com/?tag=deflater" title="1 topic" target="_blank">Deflater</a> <a href="https://blog.bluedavy.com/?tag=facebook" title="2 topics" target="_blank">facebook</a> <a href="https://blog.bluedavy.com/?tag=gc" title="4 topics" target="_blank">gc</a> <a href="https://blog.bluedavy.com/?tag=gc-tuning" title="2 topics" target="_blank">gc tuning</a> <a href="https://blog.bluedavy.com/?tag=grizzly" title="2 topics" target="_blank">Grizzly</a> <a href="https://blog.bluedavy.com/?tag=hbase" title="6 topics" target="_blank">HBase</a> <a href="https://blog.bluedavy.com/?tag=hotspot" title="1 topic" target="_blank">hotspot</a> <a href="https://blog.bluedavy.com/?tag=inflater" title="1 topic" target="_blank">Inflater</a> <a href="https://blog.bluedavy.com/?tag=interpreter" title="1 topic" target="_blank">interpreter</a> <a href="https://blog.bluedavy.com/?tag=javac" title="1 topic" target="_blank">javac</a> <a href="https://blog.bluedavy.com/?tag=java-code-generation" title="1 topic" target="_blank">java code generation</a> <a href="https://blog.bluedavy.com/?tag=javaone" title="4 topics" target="_blank">JavaOne</a> <a href="https://blog.bluedavy.com/?tag=javaone-general-technical-session" title="1 topic" target="_blank">javaone general technical session</a> <a href="https://blog.bluedavy.com/?tag=java%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c" title="1 topic" target="_blank">java代码执行</a> <a href="https://blog.bluedavy.com/?tag=java-%e5%b9%b6%e5%8f%91" title="1 topic" target="_blank">Java 并发</a> <a href="https://blog.bluedavy.com/?tag=jit" title="1 topic" target="_blank">jit</a> <a href="https://blog.bluedavy.com/?tag=jvm" title="12 topics" target="_blank">jvm</a> <a href="https://blog.bluedavy.com/?tag=memory-management" title="1 topic" target="_blank">memory management</a> <a href="https://blog.bluedavy.com/?tag=native-memory-leak" title="1 topic" target="_blank">Native Memory Leak</a> <a href="https://blog.bluedavy.com/?tag=nosql" title="2 topics" target="_blank">NoSQL</a> <a href="https://blog.bluedavy.com/?tag=oom" title="1 topic" target="_blank">oom</a> <a href="https://blog.bluedavy.com/?tag=oracle-keynote" title="1 topic" target="_blank">oracle keynote</a> <a href="https://blog.bluedavy.com/?tag=pessimism-policy" title="1 topic" target="_blank">pessimism policy</a> <a href="https://blog.bluedavy.com/?tag=references" title="1 topic" target="_blank">references</a> <a href="https://blog.bluedavy.com/?tag=rpc" title="2 topics" target="_blank">RPC</a> <a href="https://blog.bluedavy.com/?tag=serial-gc" title="1 topic" target="_blank">serial gc</a> <a href="https://blog.bluedavy.com/?tag=soa" title="2 topics" target="_blank">SOA</a> <a href="https://blog.bluedavy.com/?tag=sun-jdk" title="1 topic" target="_blank">sun jdk</a> <a href="https://blog.bluedavy.com/?tag=sun-jdk-oom" title="1 topic" target="_blank">sun jdk oom</a> <a href="https://blog.bluedavy.com/?tag=web%e5%ae%b9%e9%87%8f%e8%a7%84%e5%88%92%e7%9a%84%e8%89%ba%e6%9c%af" title="1 topic" target="_blank">Web容量规划的艺术</a> <a href="https://blog.bluedavy.com/?tag=yuanzhuo" title="1 topic" target="_blank">yuanzhuo</a> <a href="https://blog.bluedavy.com/?tag=%e4%b9%a6" title="1 topic" target="_blank">书:分布式Java应用</a> <a href="https://blog.bluedavy.com/?tag=%e4%b9%a6%e8%af%84" title="1 topic" target="_blank">书评</a> <a href="https://blog.bluedavy.com/?tag=%e4%ba%92%e8%81%94%e7%bd%91%e6%8a%80%e6%9c%af" title="1 topic" target="_blank">互联网技术</a> <a href="https://blog.bluedavy.com/?tag=%e4%ba%a4%e6%b5%81" title="1 topic" target="_blank">交流</a> <a href="https://blog.bluedavy.com/?tag=%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86" title="1 topic" target="_blank">内存管理</a> <a href="https://blog.bluedavy.com/?tag=%e5%88%86%e5%b8%83%e5%bc%8fjava%e5%ba%94%e7%94%a8" title="2 topics" target="_blank">分布式Java应用</a> <a href="https://blog.bluedavy.com/?tag=%e5%9c%86%e6%a1%8c%e4%ba%a4%e6%b5%81" title="1 topic" target="_blank">圆桌交流</a> <a href="https://blog.bluedavy.com/?tag=%e5%ae%b9%e9%87%8f%e8%a7%84%e5%88%92" title="2 topics" target="_blank">容量规划</a> <a href="https://blog.bluedavy.com/?tag=%e6%82%b2%e8%a7%82%e7%ad%96%e7%95%a5" title="3 topics" target="_blank">悲观策略</a> <a href="https://blog.bluedavy.com/?tag=%e6%9c%8d%e5%8a%a1%e6%a1%86%e6%9e%b6" title="1 topic" target="_blank">服务框架</a> <a href="https://blog.bluedavy.com/?tag=%e7%a1%85%e8%b0%b7%e5%85%ac%e5%8f%b8" title="1 topic" target="_blank">硅谷公司</a></p>
<h3 id="-">订阅</h3>
<h3 id="-">推荐书籍</h3>
<h3 id="my-book">My Book</h3>
<p><a href="http://book.douban.com/subject/4848587/" title="分布式Java应用：基础与实践" target="_blank"><img src="" alt=""></a> <a href="http://book.douban.com/subject/3843896/" title="OSGi原理与最佳实践" target="_blank"><img src="" alt=""></a>
© <a href="https://blog.bluedavy.com/" target="_blank">BlueDavy之技术blog</a> 2013</p>
<p><a href="http://icondock.com/" target="_blank">Icons</a> &amp; <a href="http://www.ndesign-studio.com/wp-themes" target="_blank">Wordpress Theme</a> by <a href="http://www.ndesign-studio.com/" target="_blank">N.Design</a></p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/架构师/">架构师</a></li></span><span class="breadcrumb"><li><a href="/categories/架构师/">架构师</a></li><li><a href="/categories/架构师/架构/">架构</a></li></span></span> | <span class="tags">Tagged <a href="/tags/架构/" class="label label-primary">架构</a><a href="/tags/架构师/" class="label label-success">架构师</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:28"datetime="2014-03-07 09:54:28"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-架构师-架构--知名网站的技术实现/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-架构师-架构--知名网站的技术实现" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JS用法--javascript常用小技巧/">javascript常用小技巧</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:28.000Z"> <a href="/2014/02/02/2014-02-02-JS用法--javascript常用小技巧/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="javascript-">javascript常用小技巧</h1>
<p><a href="http://www.javaeye.com/" target="_blank">首页</a> <a href="http://www.javaeye.com/news" target="_blank">新闻</a> <a href="http://www.javaeye.com/forums" target="_blank">论坛</a> <a href="http://www.javaeye.com/blogs" target="_blank">博客</a> <a href="http://www.javaeye.com/job" target="_blank">招聘</a> <a href="http://hainanhaian.javaeye.com/blog/260844#" target="_blank">更多 ▼</a></p>
<p><a href="http://www.javaeye.com/ask" target="_blank">问答</a> <a href="http://www.javaeye.com/wiki" target="_blank">知识库</a> <a href="http://www.javaeye.com/groups" target="_blank">圈子</a> <a href="http://www.javaeye.com/google_search" target="_blank">搜索</a></p>
<p><a href="http://jywv.javaeye.com/" title="查看我的博客首页" target="_blank">欢迎jywv</a> <a href="http://app.javaeye.com/messages" title="发送站内短信" target="_blank">收件箱</a> <a href="http://app.javaeye.com/" title="我的应用首页" target="_blank">我的应用</a></p>
<p><a href="http://app.javaeye.com/feed" title="我订阅的好友动态消息" target="_blank">我的订阅</a> <a href="http://app.javaeye.com/feed/my" title="我参与的话题更新的消息" target="_blank">我的参与</a> <a href="http://app.javaeye.com/chat" title="用闲聊发表简短的话题" target="_blank">我的闲聊</a> <a href="http://app.javaeye.com/mygroup" title="我加入的圈子最新话题" target="_blank">我的圈子</a> <a href="http://app.javaeye.com/links" title="我收藏的网络资源链接" target="_blank">我的收藏</a> <a href="http://app.javaeye.com/myresume" title="我的个人简历" target="_blank">我的简历</a>
<a href="http://jywv.javaeye.com/admin" title="管理我的博客" target="_blank">我的博客</a> <a href="http://app.javaeye.com/profile" title="修改我的个人设置" target="_blank">设置</a> <a href="http://hainanhaian.javaeye.com/logout" target="_blank">退出</a></p>
<h1 id="-http-hainanhaian-javaeye-com-"><a href="http://hainanhaian.javaeye.com/" target="_blank">新空气</a></h1>
<p>永久域名 <a href="http://hainanhaian.javaeye.com/" target="_blank"><a href="http://hainanhaian.javaeye.com/">http://hainanhaian.javaeye.com/</a></a></p>
<p><a href="http://hainanhaian.javaeye.com/blog/266896" title="Servlet上传文件打水印生成缩略图" target="_blank">Servlet上传文件打水印生成缩略图</a> | <a href="http://hainanhaian.javaeye.com/blog/256008" title="java,jsp获取网页源码内容的三种代码方法" target="_blank">java,jsp获取网页源码内容的三种代码方法</a></p>
<p>2008-11-01</p>
<h3 id="-javascript-http-hainanhaian-javaeye-com-blog-260844-"><a href="http://hainanhaian.javaeye.com/blog/260844" target="_blank">javascript常用小技巧</a></h3>
<p>avascript小技巧
事件源对象
event.srcElement.tagName
event.srcElement.type
捕获释放
event.srcElement.setCapture();
event.srcElement.releaseCapture();
事件按键
event.keyCode
event.shiftKey
event.altKey
event.ctrlKey
事件返回值
event.returnValue
鼠标位置
event.x
event.y
窗体活动元素
document.activeElement
绑定事件
document.captureEvents(Event.KEYDOWN);
访问窗体元素
document.all(&quot;txt&quot;).focus();
document.all(&quot;txt&quot;).select();
窗体命令
document.execCommand
窗体COOKIE
document.cookie
菜单事件
document.oncontextmenu
创建元素
document.createElement(&quot;SPAN&quot;);
根据鼠标获得元素：
document.elementFromPoint(event.x,event.y).tagName==&quot;TD
document.elementFromPoint(event.x,event.y).appendChild(ms)
窗体图片
document.images[索引]
窗体事件绑定
document.onmousedown=scrollwindow;
元素
document.窗体.elements[索引]
对象绑定事件
document.all.xxx.detachEvent(&#39;onclick&#39;,a);
插件数目
navigator.plugins
取变量类型
typeof($js_libpath) == &quot;undefined&quot;
下拉框
下拉框.options[索引]
下拉框.options.length
查找对象
document.getElementsByName(&quot;r1&quot;);
document.getElementById(id);
定时
timer=setInterval(&#39;scrollwindow()&#39;,delay);
clearInterval(timer);
UNCODE编码
escape() ,unescape
父对象
obj.parentElement(dhtml)
obj.parentNode(dom)
交换表的行
TableID.moveRow(2,1)
替换CSS
document.all.csss.href = &quot;a.css&quot;;
并排显示
display:inline
隐藏焦点
hidefocus=true
根据宽度换行
style=&quot;word-break:break-all&quot;
自动刷新</p>
<p><meta HTTP-EQUIV="refresh" CONTENT="8;URL=http://c98.yeah.net">
简单邮件
<a href="mailto:aaa@bbb.com?subject=ccc&body=xxxyyy">
快速转到位置
obj.scrollIntoView(true)
锚
<a name="first">
<a href="/#first">anchors</a>
网页传递参数
location.search();
可编辑
obj.contenteditable=true
执行菜单命令
obj.execCommand
双字节字符
/[^\x00-\xff]/
汉字
/[\u4e00-\u9fa5]/
让英文字符串超出表格宽度自动换行
word-wrap: break-word; word-break: break-all;
透明背景
&lt;爱生活,爱猫扑 src=&quot;1.htm&quot; width=300 height=180 allowtransparency&gt;&lt;/爱生活,爱猫扑&gt;
获得style内容
obj.style.cssText
HTML标签
document.documentElement.innerHTML
第一个style标签
document.styleSheets[0]
style标签里的第一个样式
document.styleSheets[0].rules[0]
防止点击空链接时，页面往往重置到页首端。
<a href="javascript :function()">word</a>
上一网页源
asp:
request.servervariables(&quot;HTTP_REFERER&quot;)
javascript :
document.referrer
释放内存
CollectGarbage();
禁止右键
document.oncontextmenu = function() { return false;}
禁止保存</p>
<p><noscript>&lt;爱生活,爱猫扑 src=&quot;/*.htm&quot;&gt;&lt;/爱生活,爱猫扑&gt;</noscript>
禁止选取&lt;body oncontextmenu=&quot;return false&quot; ondragstart=&quot;return false&quot;
onselectstart =&quot;return false&quot; onselect=&quot;document.selection.empty()&quot;
oncopy=&quot;document.selection.empty()&quot; onbeforecopy=&quot;return
false&quot;onmouseup=&quot;document.selection.empty()&gt;
禁止粘贴</p>
<p><input type=text onpaste="return false">
地址栏图标</p>
<p><link rel="Shortcut Icon" href="favicon.ico">
favicon.ico 名字最好不变16/*16的16色,放虚拟目录根目录下
收藏栏图标</p>
<p><link rel="Bookmark" href="favicon.ico">
查看源码</p>
<p><input type=button value=查看网页源代码 onclick="window.location = 'view-source:'+
'http://www.csdn.net/'">
关闭输入法</p>
<p><input style="ime-mode:disabled">
自动全选</p>
<p><input type=text name=text1 value="123" onfocus="this.select()">
ENTER键可以让光标移到下一个输入框</p>
<p><input onkeydown="if(event.keyCode==13)event.keyCode=9">
文本框的默认值</p>
<p><input type=text value="123" onfocus="alert(this.defaultValue)">
title换行
obj.title = &quot;123 sdfs &quot;
获得时间所代表的微秒
var n1 = new Date(&quot;2004-10-10&quot;.replace(/-/g, &quot;\/&quot;)).getTime()
窗口是否关闭
win.closed
checkbox扁平</p>
<p><input type=checkbox style="position: absolute; clip:rect(5px 15px 15px
5px)"><br>
获取选中内容
document.selection.createRange().duplicate().text
自动完成功能</p>
<p><input type=text autocomplete=on>打开该功能</p>
<p><input type=text autocomplete=off>关闭该功能<br>窗口最大化</p>
<p><body onload="window.resizeTo(window.screen.width -
4,window.screen.height-50);window.moveTo(-4,-4)">
无关闭按钮IE
window.open(&quot;aa.htm&quot;, &quot;meizz&quot;, &quot;fullscreen=7&quot;);
统一编码/解码
alert(decodeURIComponent(encodeURIComponent(&quot;<a href="http://你好.com?as=" target="_blank">http://你好.com?as=</a> hehe&quot;)))
encodeURIComponent对&quot;:&quot;、&quot;/&quot;、&quot;;&quot; 和 &quot;?&quot;也编码
表格行指示</p>
<p><tr onmouseover="this.bgColor='/#f0f0f0'" onmouseout="this.bgColor='/#ffffff'">
//各种尺寸
s += &quot;\r\n网页可见区域宽：&quot;+ document.body.clientWidth;<br>s += &quot;\r\n网页可见区域高：&quot;+ document.body.clientHeight;<br>s += &quot;\r\n网页可见区域高：&quot;+ document.body.offsetWeight +&quot; (包括边线的宽)&quot;;<br>s += &quot;\r\n网页可见区域高：&quot;+ document.body.offsetHeight +&quot; (包括边线的宽)&quot;;<br>s += &quot;\r\n网页正文全文宽：&quot;+ document.body.scrollWidth;<br>s += &quot;\r\n网页正文全文高：&quot;+ document.body.scrollHeight;<br>s += &quot;\r\n网页被卷去的高：&quot;+ document.body.scrollTop;<br>s += &quot;\r\n网页被卷去的左：&quot;+ document.body.scrollLeft;<br>s += &quot;\r\n网页正文部分上：&quot;+ window.screenTop;<br>s += &quot;\r\n网页正文部分左：&quot;+ window.screenLeft;<br>s += &quot;\r\n屏幕分辨率的高：&quot;+ window.screen.height;<br>s += &quot;\r\n屏幕分辨率的宽：&quot;+ window.screen.width;<br>s += &quot;\r\n屏幕可用工作区高度：&quot;+ window.screen.availHeight;<br>s += &quot;\r\n屏幕可用工作区宽度：&quot;+ window.screen.availWidth;<br>//过滤数字</p>
<p><input type=text onkeypress="return
event.keyCode>=48&&event.keyCode<=57||(this.value.indexOf('.')<0?event.keyCode==46:false)"
onpaste="return !clipboardData.getData('text').match(/\D/)" ondragenter="return
false">
//特殊用途</p>
<p><input type=button value=导入收藏夹
onclick="window.external.ImportExportFavorites(true,'http://localhost');"></p>
<p><input type=button value=导出收藏夹
onclick="window.external.ImportExportFavorites(false,'http://localhost');"></p>
<p><input type=button value=整理收藏夹
onclick="window.external.ShowBrowserUI('OrganizeFavorites', null)"></p>
<p><input type=button value=语言设置  
onclick="window.external.ShowBrowserUI('LanguageDialog', null)"></p>
<p><input type=button value=加入收藏夹
onclick="window.external.AddFavorite('http://www.google.com/', 'google')"></p>
<p><input type=button value=加入到频道
onclick="window.external.addChannel('http://www.google.com/')"></p>
<p><input type=button value=加入到频道
onclick="window.external.showBrowserUI('PrivacySettings',null)">
//不缓存</p>
<p><META HTTP-EQUIV="pragma" CONTENT="no-cache"></p>
<p><META HTTP-EQUIV="Cache-Control" CONTENT="no-cache, must-revalidate"></p>
<p><META HTTP-EQUIV="expires" CONTENT="0">
//正则匹配
匹配中文字符的正则表达式： [\u4e00-\u9fa5]
匹配双字节字符(包括汉字在内)：[^\x00-\xff]
匹配空行的正则表达式：\n[\s| ]/<em>\r
匹配HTML标记的正则表达式：/&lt;(./</em>)&gt;./<em>&lt;\/\1&gt;|&lt;(./</em>) \/&gt;/
匹配首尾空格的正则表达式：(^\s/<em>)|(\s/</em>$)（像vbscript那样的trim函数）
匹配Email地址的正则表达式：\w+([-+.]\w+)/<em>@\w+([-.]\w+)/</em>.\w+([-.]\w+)/<em>
匹配网址URL的正则表达式：<a href="http://([\w-]+\.)+[\w-]+(/[\w-" target="_blank">http://([\w-]+\.)+[\w-]+(/[\w-</a> ./?%&amp;=]/</em>)?
以下是例子：
利用正则表达式限制网页表单里的文本框输入内容：
用正则表达式限制只能输入中文：onkeyup=&quot;value=value.replace(/[^\u4E00-\u9FA5]/g,&#39;&#39;)&quot;
onbeforepaste=&quot;clipboardData.setData(&#39;text&#39;,clipboardData.getData(&#39;text&#39;).replace(/[^\u4E00-\u9FA5]/g,&#39;&#39;))&quot;
1.用正则表达式限制只能输入全角字符： onkeyup=&quot;value=value.replace(/[^\uFF00-\uFFFF]/g,&#39;&#39;)&quot;
onbeforepaste=&quot;clipboardData.setData(&#39;text&#39;,clipboardData.getData(&#39;text&#39;).replace(/[^\uFF00-\uFFFF]/g,&#39;&#39;))&quot;
2.用正则表达式限制只能输入数字：onkeyup=&quot;value=value.replace(/[^\d]/g,&#39;&#39;)
&quot;onbeforepaste=&quot;clipboardData.setData(&#39;text&#39;,clipboardData.getData(&#39;text&#39;).replace(/[^\d]/g,&#39;&#39;))&quot;
3.用正则表达式限制只能输入数字和英文：onkeyup=&quot;value=value.replace(/[\W]/g,&#39;&#39;)
&quot;onbeforepaste=&quot;clipboardData.setData(&#39;text&#39;,clipboardData.getData(&#39;text&#39;).replace(/[^\d]/g,&#39;&#39;))&quot;
//消除图像工具栏</p>
<p><IMG SRC="mypicture.jpg" HEIGHT="100px" WIDTH="100px" GALLERYIMG="false">
or</p>
<p><head></p>
<p><meta http-equiv="imagetoolbar" content="no">
</head>
//无提示关闭
function Close()
{
var ua=navigator.userAgent
var ie=navigator.appName==&quot;Microsoft Internet Explorer&quot;?true:false
if(ie)
{
    var IEversion=parseFloat(ua.substring(ua.indexOf(&quot;MSIE
&quot;)+5,ua.indexOf(&quot;;&quot;,ua.indexOf(&quot;MSIE &quot;))))
if(IEversion&lt; 5.5)
{
  var str = &#39;<object id=noTipClose
classid="clsid:ADB880A6-D8FF-11CF-9377-00AA003B7A11">&#39;
    str += &#39;<param name="Command" value="Close"></object>&#39;;
    document.body.insertAdjacentHTML(&quot;beforeEnd&quot;, str);
    document.all.noTipClose.Click();
}
    else
{
    window.opener =null;
    window.close();
    }
  }
else
{
window.close()
  }
}
//取得控件得绝对位置(1)</p>
<p><script language="javascript">
function getoffset(e)
{
var t=e.offsetTop;
var l=e.offsetLeft;
while(e=e.offsetParent)
{
t+=e.offsetTop;
l+=e.offsetLeft;
}
var rec = new Array(1);
rec[0] = t;
rec[1] = l;
return rec
}
</script>
//获得控件的绝对位置(2)
oRect = obj.getBoundingClientRect();
oRect.left
oRect.
//最小化,最大化,关闭</p>
<p><object id=min classid="clsid:ADB880A6-D8FF-11CF-9377-00AA003B7A11"></p>
<p><param name="Command" value="Minimize"></object></p>
<p><object id=max classid="clsid:ADB880A6-D8FF-11CF-9377-00AA003B7A11"></p>
<p><param name="Command" value="Maximize"></object></p>
<p><OBJECT id=close classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11"></p>
<p><PARAM NAME="Command" value="Close"></OBJECT></p>
<p><input type=button value=最小化 onclick=min.Click()></p>
<p><input type=button value=最大化 onclick=max.Click()></p>
<p><input type=button value=关闭 onclick=close.Click()>
//光标停在文字最后</p>
<p><script language="javascript">
function cc()
{
var e = event.srcElement;
var r =e.createTextRange();
r.moveStart(&#39;character&#39;,e.value.length);
r.collapse(true);
r.select();
}
</script></p>
<p><input type=text name=text1 value="123" onfocus="cc()">
//页面进入和退出的特效
进入页面<meta http-equiv="Page-Enter" content="revealTrans(duration=x,
transition=y)">
推出页面<meta http-equiv="Page-Exit" content="revealTrans(duration=x,
transition=y)">
这个是页面被载入和调出时的一些特效。duration表示特效的持续时间，以秒为单位。transition表示使
用哪种特效，取值为1-23:
0 矩形缩小
1 矩形扩大
2 圆形缩小
3 圆形扩大
4 下到上刷新
5 上到下刷新
6 左到右刷新
7 右到左刷新
8 竖百叶窗
9 横百叶窗
10 错位横百叶窗
11 错位竖百叶窗
12 点扩散
13 左右到中间刷新
14 中间到左右刷新
15 中间到上下
16 上下到中间
17 右下到左上
18 右上到左下
19 左上到右下
20 左下到右上
21 横条
22 竖条
23
//网页是否被检索</p>
<p><meta name="ROBOTS" content="属性值">
其中属性值有以下一些:
属性值为&quot;all&quot;: 文件将被检索，且页上链接可被查询；
属性值为&quot;none&quot;: 文件不被检索，而且不查询页上的链接；
属性值为&quot;index&quot;: 文件将被检索；
属性值为&quot;follow&quot;: 查询页上的链接；
属性值为&quot;noindex&quot;: 文件不检索，但可被查询链接；
属性值为&quot;nofollow&quot;:
//打印分页</p>
<p><p style="page-break-after:always">page1</p>  </p>
<p><p style="page-break-after:always">page2</p><br>//设置打印</p>
<p>&lt;object id=&quot;factory&quot; style=&quot;display:none&quot; viewastext
classid=&quot;clsid:1663ed61-23eb-11d2-b92f-008048fdd814&quot;
codebase=&quot;<a href="http://www.meadroid.com/scriptx/ScriptX.cab/#Version=5,60,0,360" target="_blank">http://www.meadroid.com/scriptx/ScriptX.cab/#Version=5,60,0,360</a>&quot;</p>
<blockquote>
<p></object></p>
<p><input type=button value=页面设置 onclick="factory.printing.PageSetup()"></p>
<p><input type=button value=打印预览 onclick="factory.printing.Preview()"></p>
<p><script language=javascript>
function window.onload()
{
  // -- advanced features
  factory.printing.SetMarginMeasure(2) // measure margins in inches
  factory.printing.SetPageRange(false, 1, 3) // need pages from 1 to 3
  factory.printing.printer = &quot;HP DeskJet 870C&quot;
  factory.printing.copies = 2
  factory.printing.collate = true
  factory.printing.paperSize = &quot;A4&quot;
  factory.printing.paperSource = &quot;Manual feed&quot;
  // -- basic features
  factory.printing.header = &quot;居左显示&amp;b居中显示&amp;b居右显示页码，第&amp;p页/共&amp;P页&quot;
  factory.printing.footer = &quot;（自定义页脚）&quot;
  factory.printing.portrait = false
  factory.printing.leftMargin = 0.75
  factory.printing.topMargin = 1.5
  factory.printing.rightMargin = 0.75
  factory.printing.bottomMargin = 1.5
}
function Print(frame) {
factory.printing.Print(true, frame) // print with prompt
}
</script></p>
<p><input type=button value="打印本页" onclick="factory.printing.Print(false)"></p>
<p><input type=button value="页面设置" onclick="factory.printing.PageSetup()"></p>
<p><input type=button value="打印预览" onclick="factory.printing.Preview()"><br>
<a href="http://www.meadroid.com/scriptx/docs/printdoc.htm?static"
target=_blank>具体使用手册，更多信息，点这里</a>
//自带的打印预览
WebBrowser.ExecWB(1,1) 打开
Web.ExecWB(2,1) 关闭现在所有的IE窗口，并打开一个新窗口
Web.ExecWB(4,1) 保存网页
Web.ExecWB(6,1) 打印
Web.ExecWB(7,1) 打印预览
Web.ExecWB(8,1) 打印页面设置
Web.ExecWB(10,1) 查看页面属性
Web.ExecWB(15,1) 好像是撤销，有待确认
Web.ExecWB(17,1) 全选
Web.ExecWB(22,1) 刷新
Web.ExecWB(45,1) 关闭窗体无提示</p>
<p><style media=print>
.Noprint{display:none;}<!--用本样式在打印时隐藏非打印项目-->
.PageNext{page-break-after: always;}<!--控制分页-->
</style></p>
<p><object id="WebBrowser" width=0 height=0
classid="CLSID:8856F961-340A-11D0-A96B-00C04FD705A2"><br></object>  </p>
<p><center class="Noprint" ></p>
<p><input type=button value=打印 onclick=document.all.WebBrowser.ExecWB(6,1)></p>
<p><input type=button value=直接打印 onclick=document.all.WebBrowser.ExecWB(6,6)></p>
<p><input type=button value=页面设置 onclick=document.all.WebBrowser.ExecWB(8,1)>
</p></p>
<p><p> <input type=button value=打印预览 onclick=document.all.WebBrowser.ExecWB(7,1)>
</center>
//去掉打印时的页眉页脚</p>
<p><script language="JavaScript"><br>var HKEY_Root,HKEY_Path,HKEY_Key;
HKEY_Root=&quot;HKEY_CURRENT_USER&quot;;
HKEY_Path=&quot;\Software\Microsoft\Internet Explorer\PageSetup\&quot;;
//设置网页打印的页眉页脚为空
function PageSetup_Null()
{
try
{
      var Wsh=new ActiveXObject(&quot;WScript.Shell&quot;);
HKEY_Key=&quot;header&quot;;
Wsh.RegWrite(HKEY_Root+HKEY_Path+HKEY_Key,&quot;&quot;);
HKEY_Key=&quot;footer&quot;;
Wsh.RegWrite(HKEY_Root+HKEY_Path+HKEY_Key,&quot;&quot;);
}
catch(e){}
}
//设置网页打印的页眉页脚为默认值
function PageSetup_Default()
{<br>try
{
var Wsh=new ActiveXObject(&quot;WScript.Shell&quot;);
HKEY_Key=&quot;header&quot;;
Wsh.RegWrite(HKEY_Root+HKEY_Path+HKEY_Key,&quot;&amp;w&amp;b页码,&amp;p/&amp;P&quot;);
HKEY_Key=&quot;footer&quot;;
Wsh.RegWrite(HKEY_Root+HKEY_Path+HKEY_Key,&quot;&amp;u&amp;b&amp;d&quot;);
}
catch(e){}
}
</script></p>
<p><input type="button" value="清空页码" onclick=PageSetup_Null()></p>
<p><input type="button" value="恢复页码" onclick=PageSetup_Default()>
//浏览器验证
function checkBrowser()
{
  this.ver=navigator.appVersion
  this.dom=document.getElementById?1:0
  this.ie6=(this.ver.indexOf(&quot;MSIE 6&quot;)&gt;-1 &amp;&amp; this.dom)?1:0;
  this.ie5=(this.ver.indexOf(&quot;MSIE 5&quot;)&gt;-1 &amp;&amp; this.dom)?1:0;
  this.ie4=(document.all &amp;&amp; !this.dom)?1:0;
  this.ns5=(this.dom &amp;&amp; parseInt(this.ver) &gt;= 5) ?1:0;
  this.ns4=(document.layers &amp;&amp; !this.dom)?1:0;
  this.mac=(this.ver.indexOf(&#39;Mac&#39;) &gt; -1) ?1:0;
  this.ope=(navigator.userAgent.indexOf(&#39;Opera&#39;)&gt;-1);
  this.ie=(this.ie6 || this.ie5 || this.ie4)
  this.ns=(this.ns4 || this.ns5)
  this.bw=(this.ie6 || this.ie5 || this.ie4 || this.ns5 || this.ns4 || this.mac
|| this.ope)
  this.nbw=(!this.bw)
  return this;
}
//计算内容宽和高</p>
<p><SCRIPT language="javascript"><br>function test(obj)<br>{<br>    var range = obj.createTextRange();<br>    alert(&quot;内容区宽度: &quot; + range.boundingWidth  </p>
<pre><code>                            + &quot;px\r\n内容区高度: &quot; +
</code></pre><p>range.boundingHeight + &quot;px&quot;);  </p>
</blockquote>
<p>}<br></SCRIPT>  </p>
<p><BODY>  </p>
<p><Textarea id="txt" height="150">sdf</textarea><INPUT type="button"
value="计算内容宽度" onClick="test(txt)"><br></BODY>
//无模式的提示框
function modelessAlert(Msg)
{</p>
<p>window.showModelessDialog(&quot;javascript :alert(\&quot;&quot;+escape(Msg)+&quot;\&quot;);window.close();&quot;,&quot;&quot;,&quot;status:no;resizable:no;help:no;dialogHeight:height:30px;dialogHeight:40px;&quot;);
}
//屏蔽按键</p>
<p><html></p>
<p><head></p>
<p><meta http-equiv="Content-Type" content="text/html; charset=gb2312"></p>
<p><noscript><meta http-equiv="refresh"
content="0;url=about:noscript"></noscript></p>
<p><title>屏蔽鼠标右键、Ctrl+N、Shift+F10、Alt+F4、F11、F5刷新、退格键</title>
</head></p>
<p><body></p>
<p><script language="Javascript">&lt;!--
//屏蔽鼠标右键、Ctrl+N、Shift+F10、F11、F5刷新、退格键
//Author: meizz(梅花雨) 2002-6-18
function document.oncontextmenu(){event.returnValue=false;}//屏蔽鼠标右键
function window.onhelp(){return false} //屏蔽F1帮助
function document.onkeydown()
{
if ((window.event.altKey)&amp;&amp;
    ((window.event.keyCode==37)||   //屏蔽 Alt+ 方向键 ←
    (window.event.keyCode==39)))   //屏蔽 Alt+ 方向键 →
{
  alert(&quot;不准你使用ALT+方向键前进或后退网页！&quot;);
  event.returnValue=false;
}
  //<em> 注：这还不是真正地屏蔽 Alt+ 方向键，
  因为 Alt+ 方向键弹出警告框时，按住 Alt 键不放，
  用鼠标点掉警告框，这种屏蔽方法就失效了。以后若
  有哪位高手有真正屏蔽 Alt 键的方法，请告知。/</em>/
if ((event.keyCode==8) ||           //屏蔽退格删除键
    (event.keyCode==116)||           //屏蔽 F5 刷新键
    (event.ctrlKey &amp;&amp; event.keyCode==82)){ //Ctrl + R
  event.keyCode=0;
  event.returnValue=false;
  }
if (event.keyCode==122){event.keyCode=0;event.returnValue=false;} //屏蔽F11
if (event.ctrlKey &amp;&amp; event.keyCode==78) event.returnValue=false;   //屏蔽 Ctrl+n
if (event.shiftKey &amp;&amp; event.keyCode==121)event.returnValue=false; //屏蔽
shift+F10
if (window.event.srcElement.tagName == &quot;A&quot; &amp;&amp; window.event.shiftKey)
    window.event.returnValue = false;         //屏蔽 shift 加鼠标左键新开一网页
if ((window.event.altKey)&amp;&amp;(window.event.keyCode==115))         //屏蔽Alt+F4
{</p>
<p>window.showModelessDialog(&quot;about:blank&quot;,&quot;&quot;,&quot;dialogWidth:1px;dialogheight:1px&quot;);
    return false;
}
}
</script>
屏蔽鼠标右键、Ctrl+N、Shift+F10、Alt+F4、F11、F5刷新、退格键
</body>
</html>
//屏蔽打印</p>
<p><style>
@media print{
/* {display:none}
}
</style>
//移动的图层，拖动
1.<span style='position:absolute;width:200;height:200;background:red'
onmousedown=MouseDown(this) onmousemove=MouseMove()
onmouseup=MouseUp()>meizz</span></p>
<p><script language=javascript>
var Obj;
function MouseDown(obj)
{
Obj=obj;
Obj.setCapture();
Obj.l=event.x-Obj.style.pixelLeft;
Obj.t=event.y-Obj.style.pixelTop;
}
function MouseMove()
{
if(Obj!=null)
{
  Obj.style.left = event.x-Obj.l;
  Obj.style.top = event.y-Obj.t;
}
}
function MouseUp()
{
if(Obj!=null)
{
  Obj.releaseCapture();
  Obj=null;
}
}
</script>
2.</p>
<p><div id="myDiv" src="logo.gif" ondrag="doDrag();"
onmouseover="this.style.cursor='hand'"
style="position:absolute;left=100;top=100;" onmousedown="doMouseDown();">
<a href="/#" onclick="return false"><h1>wlecome</h1></a>
</div></p>
<p><script language="JavaScript" type="text/javascript">
var orgMouseX;
var orgMouseY;
var orgObjX;
var orgObjY;
function doDrag()
{
var myObject=document.all.myDiv;
var x=event.clientX;
var y=event.clientY;
myObject.style.left=x-(orgMouseX-orgObjX);
myObject.style.top=y-(orgMouseY-orgObjY);
}
function doMouseDown()
{
orgMouseX=event.clientX;
orgMouseY=event.clientY;
orgObjX=parseInt(document.all.myDiv.style.left);
orgObjY=parseInt(document.all.myDiv.style.top);
}
</script>
//文档状态改变
&lt;爱生活,爱猫扑 src=&quot;a.html&quot; id=&quot;f&quot; name=&quot;f&quot; scrolling=&quot;no&quot; frameborder=0 marginwidth=0
marginheight=0&gt;&lt;/爱生活,爱猫扑&gt;</p>
<p><script>
var doc=window.frames[&quot;f&quot;].document;
function s(){
if (doc.readyState==&quot;complete&quot;){
document.all.f.style.height=doc.body.scrollHeight
document.all.f.style.width=doc.body.scrollWidth
}
}
doc.onreadystatechange=s
</script>
//刷新后不变的文本框</p>
<p><HTML></p>
<p><HEAD></p>
<p><META NAME="save" CONTENT="history"></p>
<p><STYLE>
  .sHistory {behavior:url(/#default/#savehistory);}
</STYLE>
</HEAD></p>
<p><BODY></p>
<p><INPUT class=sHistory type=text id=oPersistInput>
</BODY>
</HTML>
//访问剪贴板
(1)拖拽访问
event.dataTransfer.setData(&quot;URL&quot;, oImage.src);
sImageURL = event.dataTransfer.getData(&quot;URL&quot;)
(2)普通访问
window.clipboardData.setData(&quot;Text&quot;,oSource.innerText);
window.clipboardData.getData(&quot;Text&quot;);
//操作COOKIE
function SetCookie(sName, sValue)
{
document.cookie = sName + &quot;=&quot; + escape(sValue) + &quot;; &quot;;
}
function GetCookie(sName)
{
var aCookie = document.cookie.split(&quot;; &quot;);
for (var i=0; i &lt; aCookie.length; i++)
{</p>
<p>var aCrumb = aCookie.split(&quot;=&quot;);
if (sName == aCrumb[0])
return unescape(aCrumb[1]);
}
}
function DelCookie(sName)
{
document.cookie = sName + &quot;=&quot; + escape(sValue) + &quot;; expires=Fri, 31 Dec 1999
23:59:59 GMT;&quot;;
}
//setTimeout增加参数</p>
<p><script>
var _st = window.setTimeout;
window.setTimeout = function(fRef, mDelay) {
if(typeof fRef == &#39;function&#39;){
var argu = Array.prototype.slice.call(arguments,2);
var f = (function(){ fRef.apply(null, argu); });
return _st(f, mDelay);
}
return _st(fRef,mDelay);
}
function test(x){
alert(x);
}
window.setTimeout(test,1000,&#39;fason&#39;);
</script>
//自定义的apply,call
Function.prototype.apply = function (obj, argu) {
if (obj) obj.constructor.prototype._caller = this;
var argus = new Array();
for (var i=0;i&lt;argu.length;i++)
argus = &quot;argu[&quot; + i + &quot;]&quot;;
var r;
eval(&quot;r = &quot; + (obj ? (&quot;obj._caller(&quot; + argus.join(&quot;,&quot;) + &quot;);&quot;) : (&quot;this(&quot; +
argus.join(&quot;,&quot;) + &quot;);&quot;)));
return r;
};
Function.prototype.call = function (obj) {
var argu = new Array();
for (var i=1;i&lt;arguments.length;i++)
argu[i-1] = arguments;
return this.apply(obj, argu);
};<br>//下载文件
function DownURL(strRemoteURL,strLocalURL)
{
try
{
var xmlHTTP=new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);
xmlHTTP.open(&quot;Get&quot;,strRemoteURL,false);
xmlHTTP.send();
var adodbStream=new ActiveXObject(&quot;ADODB.Stream&quot;);
adodbStream.Type=1;//1=adTypeBinary
adodbStream.Open();
adodbStream.write(xmlHTTP.responseBody);
adodbStream.SaveToFile(strLocalURL,2);
adodbStream.Close();
adodbStream=null;
xmlHTTP=null;</p>
<p>}
catch(e)
{
window.confirm(&quot;下载URL出错!&quot;);
}
//window.confirm(&quot;下载完成.&quot;);
}
//检验连接是否有效
function getXML(URL)
{
var xmlhttp = new ActiveXObject(&quot;microsoft.xmlhttp&quot;);
xmlhttp.Open(&quot;GET&quot;,URL, false);
try
{
xmlhttp.Send();
}
catch(e){}
finally
{
var result = xmlhttp.responseText;
if(result)
{
  if(xmlhttp.Status==200)
  {
  return(true);
  }
  else
  {
  return(false);
  }
}
else
{
  return(false);
}
}
}
//POST代替FORM</p>
<p><SCRIPT language="VBScript">
Function URLEncoding(vstrIn)
  strReturn = &quot;&quot;
  For i = 1 To Len(vstrIn)
    ThisChr = Mid(vStrIn,i,1)
    If Abs(Asc(ThisChr)) &lt; &amp;HFF Then
        strReturn = strReturn &amp; ThisChr
    Else
        innerCode = Asc(ThisChr)
        If innerCode &lt; 0 Then
          innerCode = innerCode + &amp;H10000
        End If
        Hight8 = (innerCode And &amp;HFF00)\ &amp;HFF
        Low8 = innerCode And &amp;HFF
        strReturn = strReturn &amp; &quot;%&quot; &amp; Hex(Hight8) &amp; &quot;%&quot; &amp; Hex(Low8)
    End If
  Next
  URLEncoding = strReturn
End Function
Function bytes2BSTR(vIn)
  strReturn = &quot;&quot;
  For i = 1 To LenB(vIn)
    ThisCharCode = AscB(MidB(vIn,i,1))
    If ThisCharCode &lt; &amp;H80 Then
        strReturn = strReturn &amp; Chr(ThisCharCode)
    Else
        NextCharCode = AscB(MidB(vIn,i+1,1))
        strReturn = strReturn &amp; Chr(CLng(ThisCharCode) /* &amp;H100 +
CInt(NextCharCode))
        i = i + 1
    End If
  Next
  bytes2BSTR = strReturn
End Function
dim strA,oReq
strA = URLEncoding(&quot;submit1=Submit&amp;text1=中文&quot;)
set oReq = CreateObject(&quot;MSXML2.XMLHTTP&quot;)
oReq.open &quot;POST&quot;,&quot;<a href="http://ServerName/VDir/TstResult.asp&quot;,false" target="_blank">http://ServerName/VDir/TstResult.asp&quot;,false</a>
oReq.setRequestHeader &quot;Content-Length&quot;,Len(strA)
oReq.setRequestHeader &quot;CONTENT-TYPE&quot;,&quot;application/x-www-form-urlencoded&quot;
oReq.send strA
msgbox bytes2BSTR(oReq.responseBody)
</SCRIPT>
//readyState是xmlhttp返回数据的进度，0=载入中,1=未初始化,2=已载入,3=运行中,4=完成
//组件是否安装
isComponentInstalled(&quot;{6B053A4B-A7EC-4D3D-4567-B8FF8A1A5739}&quot;, &quot;componentID&quot;))
//检查网页是否存在
function CheckURL(URL)
{
var xmlhttp = new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);
xmlhttp.Open(&quot;GET&quot;,URL, false);
try
{
  xmlhttp.Send();
  var result = xmlhttp.status;
}
catch(e) {return(false); }
if(result==200)
{
  return true;
}
xmlhttp = null;
return false;
}
//连接数据库</p>
<p><script language="javascript">
//用 JavaScript 写服务器端连接数据库的代码示例
var conn = new ActiveXObject(&quot;ADODB.Connection&quot;);
conn.Open(&quot;Provider=SQLOLEDB.1; Data Source=localhost; User ID=sa; &quot;
  +&quot;Password=; Initial Catalog=pubs&quot;);
var rs = new ActiveXObject(&quot;ADODB.Recordset&quot;);
var sql=&quot;select /* from authors&quot;;
rs.open(sql, conn);
shtml = &quot;<table width='100%' border=1>&quot;;
shtml +=&quot;<tr
bgcolor='/#f4f4f4'><td>au_id</td><td>au_lname</td><td>au_fname</td><td>phone</td><td>address</td><td>
city</td><td>state</td><td>zip</td></tr>&quot;;
while(!rs.EOF)
{
shtml += &quot;<tr><td>&quot; + rs(&quot;au_id&quot;) + &quot;</td><td>&quot; + rs(&quot;au_lname&quot;) + &quot;</td><td>&quot;</p>
<ul>
<li>rs(&quot;au_fname&quot;) + &quot;</td><td>&quot; + rs(&quot;phone&quot;) + &quot;</td><td>&quot; + rs(&quot;address&quot;) +
&quot;</td><td>&quot; + rs(&quot;city&quot;) + &quot;</td><td>&quot; + rs(&quot;state&quot;) + &quot;</td><td>&quot; + rs(&quot;zip&quot;) +
&quot;</td></tr>&quot;;
rs.moveNext;
}
shtml += &quot;</table>&quot;;
document.write(shtml);
rs.close();
rs = null;
conn.close();
conn = null;
</script>
//使用数据岛
<html>
<body>
srno：<input type=text datasrc=/#xmldate DataFLD=srno size="76"><BR>
times：<input type=text datasrc=/#xmldate DataFLD=times size="76"><BR>
<input id="first" TYPE=button value="<<　第一条记录"
onclick="xmldate.recordset.moveFirst()">
<input id="prev" TYPE=button value="<上一条记录"
onclick="xmldate.recordset.movePrevious()"><br><input id="next" TYPE=button value="下一条记录>"
onclick="xmldate.recordset.moveNext()"><br><input id="last" TYPE=button value="最后一条记录>>"
onclick="xmldate.recordset.moveLast()"><br><input id="Add" TYPE=button value="添加新记录" onclick="xmldate.recordset.addNew()">
<XML ID="xmldate">
<infolist>
<info ><srno>20041025-01</srno><times>null</times></info>
<info ><srno>20041101-09</srno><times>2004年10月1日2点22分0秒</times></info>
</infolist>
</XML>
</body>
</html>
//获得参数
<body>
<a href="javascript :location.href=location.href + '?a=1&b=2'">search</a>
<script language="JavaScript">
<!--
var a = location.search.substr(1);
if(a.length>0)
{
var re = /([^&]/*?)\=([^&]/*)/g
var s = a.match(re);
for(var i= 0;i<s.length;i++)
{
alert(s);
alert(s.split("=")[1]);
}
}
//-->
</script>
</body>
//可编辑SELECT
<input type=text name=re_name
style="width:100px;height:21px;font-size:10pt;"><span
style="width:18px;border:0px solid red;"><select name="r00"
style="margin-left:-100px;width:118px; background-color:/#FFEEEE;"
onChange="document.all.re_name.value=this.value;"><pre><code>    &lt;option value=&quot;1&quot;&gt;11111111&lt;option&gt;
    &lt;option value=&quot;2&quot;&gt;222222&lt;/option&gt;
    &lt;option value=&quot;3&quot;&gt;333333&lt;/option&gt;
  &lt;/select&gt;
  &lt;/span&gt;
</code></pre>//设置光标位置
function getCaret(textbox)
{
var control = document.activeElement;
textbox.focus();
var rang = document.selection.createRange();
rang.setEndPoint(&quot;StartToStart&quot;,textbox.createTextRange())
control.focus();
return rang.text.length;
}
function setCaret(textbox,pos)
{
try
{
var r =textbox.createTextRange();
r.moveStart(&#39;character&#39;,pos);
r.collapse(true);
r.select();
}
catch(e)
{}
}
function selectLength(textbox,start,len)
{
try
{
var r =textbox.createTextRange();
r.moveEnd(&#39;character&#39;,len-(textbox.value.length-start));
r.moveStart(&#39;character&#39;,start);</li>
</ul>
<p>r.select();
}
catch(e)
{//alert(e.description)}
}
function insertAtCaret(textbox,text)
{
textbox.focus();
document.selection.createRange().text = text;
}
//页内查找
function findInPage(str)
{
var txt, i, found,n = 0;
if (str == &quot;&quot;)
{
return false;
}
txt = document.body.createTextRange();
for (i = 0; i &lt;= n &amp;&amp; (found = txt.findText(str)) != false; i++)
{
txt.moveStart(&quot;character&quot;, 1);
txt.moveEnd(&quot;textedit&quot;);
}
if (found)
{
txt.moveStart(&quot;character&quot;, -1);
txt.findText(str);
txt.select();
txt.scrollIntoView();
n++;<br>}
else
{
if (n &gt; 0)
{
  n = 0;
  findInPage(str);
}
else
{
  alert(str + &quot;...         您要找的文字不存在。\n \n请试着输入页面中的关键字再次查找！&quot;);
}
}
return false;
}
//书
<a href="http://www.itpub.net/attachment.php?s=&amp;postid=1894598" target="_blank">http://www.itpub.net/attachment.php?s=&amp;postid=1894598</a>
<a href="http://www.wrclub.net/down/listdown.aspx?id=1341" target="_blank">http://www.wrclub.net/down/listdown.aspx?id=1341</a>
//操作EXECL</p>
<p><script language="javascript">
function jStartExcel() {
var xls = new ActiveXObject ( &quot;Excel.Application&quot; );
xls.visible = true;
var newBook = xls.Workbooks.Add;
newBook.Worksheets.Add;
newBook.Worksheets(1).Activate;
xls.ActiveWorkBook.ActiveSheet.PageSetup.Orientation = 2;
xls.ActiveWorkBook.ActiveSheet.PageSetup.PaperSize = 5;
newBook.Worksheets(1).Columns(&quot;A&quot;).columnwidth=50;
newBook.Worksheets(1).Columns(&quot;A&quot;).WrapText = true;
newBook.Worksheets(1).Columns(&quot;B&quot;).columnwidth=50;
newBook.Worksheets(1).Columns(&quot;B&quot;).WrapText = true;
newBook.Worksheets(1).Range(&quot;A1:B1000&quot;).NumberFormat = &quot;0&quot;;
newBook.Worksheets(1).Range(&quot;A1:B1000&quot;).HorizontalAlignment = -4131;
newBook.Worksheets(1).Cells(1,1).Interior.ColorIndex=&quot;15&quot;;
newBook.Worksheets(1).Cells(1,1).value=&quot;First Column, First Cell&quot;;
newBook.Worksheets(1).Cells(2,1).value=&quot;First Column, Second Cell&quot;;
newBook.Worksheets(1).Cells(1,2).value=&quot;Second Column, First Cell&quot;;
newBook.Worksheets(1).Cells(2,2).value=&quot;Second Column, Second Cell&quot;;
newBook.Worksheets(1).Name=&quot;My First WorkSheet&quot;;
}
</script>
//自定义提示条
<a href="/#" title="这是提示">tip</a></p>
<p><script Language="JavaScript">
///<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>默认设置定义./</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>
tPopWait=50;//停留tWait豪秒后显示提示。
tPopShow=5000;//显示tShow豪秒后关闭提示
showPopStep=20;
popOpacity=99;
///<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>内部变量定义/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>/<em>/</em>
sPop=null;
curShow=null;
tFadeOut=null;
tFadeIn=null;
tFadeWaiting=null;
document.write(&quot;<style type='text/css'id='defaultPopStyle'>&quot;);
document.write(&quot;.cPopText { background-color: /#F8F8F5;color:/#000000; border:
1px /#000000 solid;font-color: font-size: 12px; padding-right: 4px; padding-left:
4px; height: 20px; padding-top: 2px; padding-bottom: 2px; filter:
Alpha(Opacity=0)}&quot;);
document.write(&quot;</style>&quot;);
document.write(&quot;<div id='dypopLayer' style='position:absolute;z-index:1000;'
class='cPopText'></div>&quot;);
function showPopupText(){
var o=event.srcElement;
MouseX=event.x;
MouseY=event.y;
if(o.alt!=null &amp;&amp; o.alt!=&quot;&quot;){o.dypop=o.alt;o.alt=&quot;&quot;};
    if(o.title!=null &amp;&amp; o.title!=&quot;&quot;){o.dypop=o.title;o.title=&quot;&quot;};
if(o.dypop!=sPop) {
sPop=o.dypop;
clearTimeout(curShow);
clearTimeout(tFadeOut);
clearTimeout(tFadeIn);
clearTimeout(tFadeWaiting);
if(sPop==null || sPop==&quot;&quot;) {
dypopLayer.innerHTML=&quot;&quot;;
dypopLayer.style.filter=&quot;Alpha()&quot;;
dypopLayer.filters.Alpha.opacity=0;
}
else {
if(o.dyclass!=null) popStyle=o.dyclass
else popStyle=&quot;cPopText&quot;;
curShow=setTimeout(&quot;showIt()&quot;,tPopWait);
}
}
}
function showIt(){
dypopLayer.className=popStyle;
dypopLayer.innerHTML=sPop;
popWidth=dypopLayer.clientWidth;
popHeight=dypopLayer.clientHeight;
if(MouseX+12+popWidth&gt;document.body.clientWidth) popLeftAdjust=-popWidth-24
else popLeftAdjust=0;
if(MouseY+12+popHeight&gt;document.body.clientHeight) popTopAdjust=-popHeight-24
else popTopAdjust=0;
dypopLayer.style.left=MouseX+12+document.body.scrollLeft+popLeftAdjust;
dypopLayer.style.top=MouseY+12+document.body.scrollTop+popTopAdjust;
dypopLayer.style.filter=&quot;Alpha(Opacity=0)&quot;;
fadeOut();
}
function fadeOut(){
if(dypopLayer.filters.Alpha.opacity<popOpacity) {
dypopLayer.filters.Alpha.opacity+=showPopStep;
tFadeOut=setTimeout("fadeOut()",1);
}
else {
dypopLayer.filters.Alpha.opacity=popOpacity;
tFadeWaiting=setTimeout("fadeIn()",tPopShow);
}
}
function fadeIn(){
if(dypopLayer.filters.Alpha.opacity>0) {
dypopLayer.filters.Alpha.opacity-=1;
tFadeIn=setTimeout(&quot;fadeIn()&quot;,1);
}
}
document.onmouseover=showPopupText;
</script>
//插入文字
document.onclick =function(){
var oSource = window.event.srcElement;
if(oSource.tagName!=&quot;DIV&quot;)
return false;
var sel = document.selection;
if (sel!=null) {
var rng = sel.createRange();
if (rng!=null)
rng.pasteHTML(&quot;<font color=red>插入文字</font>&quot;);
}
}
//netscapte下操作xml
doc = new ActiveXObject(&quot;Msxml2.DOMDocument&quot;);
doc = new ActiveXObject(&quot;Microsoft.XMLDOM&quot;)
-&gt;&gt;
doc = (new DOMParser()).parseFromString(sXML,&#39;text/xml&#39;)
//判断键值</p>
<p><html></p>
<p><meta http-equiv="Content-Type" content="text/html; charset=gb2312"></p>
<p><head></p>
<p><script language="javascript">
var ie =navigator.appName==&quot;Microsoft Internet Explorer&quot;?true:false;</p>
<p>function keyDown(e)
{
if(!ie)
{
var nkey=e.which;
var iekey=&#39;现在是ns浏览器&#39;;
var realkey=String.fromCharCode(e.which);
}
if(ie)
{
var iekey=event.keyCode;
var nkey=&#39;现在是ie浏览器&#39;;
var realkey=String.fromCharCode(event.keyCode);
if(event.keyCode==32){realkey=&#39;\&#39; 空格\&#39;&#39;}
if(event.keyCode==13){realkey=&#39;\&#39; 回车\&#39;&#39;}
if(event.keyCode==27){realkey=&#39;\&#39; Esc\&#39;&#39;}
if(event.keyCode==16){realkey=&#39;\&#39; Shift\&#39;&#39;}
if(event.keyCode==17){realkey=&#39;\&#39; Ctrl\&#39;&#39;}
if(event.keyCode==18){realkey=&#39;\&#39; Alt\&#39;&#39;}
}
alert(&#39;ns浏览器中键值:&#39;+nkey+&#39;\n&#39;+&#39;ie浏览器中键值:&#39;+iekey+&#39;\n&#39;+&#39;实际键为&#39;+realkey);
}
document.onkeydown = keyDown;
</script>
</head></p>
<p><body>
//Javascript Document.</p>
<p><hr></p>
<p><center></p>
<p><h3>请按任意一个键。。。。</h3>
</center>
</body>
</html>
//禁止FSO
1.注销组件
regsvr32 /u scrrun.dll
2.修改PROGID
HKEY_CLASSES_ROOT\Scripting.FileSystemObject
Scripting.FileSystemObject
3.对于使用object的用户，修改HKEY_CLASSES_ROOT\Scripting.
//省略号</p>
<p><DIV STYLE="width: 120px; height: 50px; border: 1px solid blue;
        overflow: hidden; text-overflow:ellipsis"></p>
<p><NOBR>就是比如有一行文字，很长，表格内一行显示不下.</NOBR>
</DIV>
//检测media play版本</p>
<p><IE:clientCaps ID="oClientCaps" style="{behavior:url(/#default/#clientcaps)}" /></p>
<p><SCRIPT>
var flash=&quot;&quot;;
  WMPVersion=
oClientCaps.getComponentVersion(&quot;{22D6F312-B0F6-11D0-94AB-0080C74C7E95}&quot;,&quot;ComponentID&quot;);
  if (WMPVersion != &quot;&quot;) {
  flash = &quot;&quot;;
  var version = WMPVersion.split(&quot;,&quot;);
  var i;
  for (i = 0; i &lt; version.length; i++) {
    if (i != 0)
  flash += &quot;.&quot;;
    flash += version;
  }
  document.write(&quot;您的Windows Media Player 版本是:&quot;+flash+&quot;<p>&quot;);
}
</SCRIPT>
//图象按比例</p>
<p><script language="JavaScript">
<!--
//图片按比例缩放
var flag=false;
function DrawImage(ImgD){
var image=new Image();
var iwidth = 80; //定义允许图片宽度
var iheight = 80; //定义允许图片高度
image.src=ImgD.src;
if(image.width>0 && image.height>0){
flag=true;
if(image.width/image.height>= iwidth/iheight){
if(image.width>iwidth){  
ImgD.width=iwidth;
ImgD.height=(image.height/*iwidth)/image.width;
}else{
ImgD.width=image.width;  
ImgD.height=image.height;
}
ImgD.alt=image.width+"×"+image.height;
}
else{
if(image.height>iheight){  
ImgD.height=iheight;
ImgD.width=(image.width/*iheight)/image.height;  
}else{
ImgD.width=image.width;  
ImgD.height=image.height;
}
ImgD.alt=image.width+"×"+image.height;
}
}
}
//-->
</script>
<img src=".." onload = "DrawImage(this)">
//细线SELECT
<span style="border:1px solid /#000000; position:absolute; overflow:hidden;" ></p>
<p><select style="margin:-2px;"></p>
<p><option>1111</option></p>
<p><option>11111111111111</option></p>
<p><option>111111111</option>
</select></span>
//Import
function Import() {
for( var i=0; i&lt;arguments.length; i++ ) {
var file = arguments;
if ( file.match(/.js$/i))
  document.write(&#39;<script type=\"text/javascript\" src=\"' + file + '\"></sc' +
'ript>&#39;);
else
  document.write(&#39;<style type=\"text/css\">@import \&quot;&#39; + file + &#39;\&quot;
;</style>&#39;);
}
};
//js枚举
function getComputerName()
{
var objWMIService = GetObject(&quot;Winmgmts:root\cimv2&quot;);
for(e = new Enumerator(objWMIService) ; !e.atEnd() ; e.moveNext())
{
  var getComputer = e.item();
  return getComputer.Name;
}
}
//条件编译</p>
<p><script language=javascript>
//<em>@cc_on @/</em>/
//<em>@if (@_win32 &amp;&amp; @_jscript_version&gt;5)
function window.confirm(str)
{
  execScript(&quot;n = msgbox(&#39;&quot;+ str +&quot;&#39;, 257)&quot;, &quot;vbscript&quot;);
  return(n == 1);
}
@end @/</em>/
</script>
//取得innerText</p>
<p><SCRIPT LANGUAGE="JavaScript">
&lt;!--
var xmlDoc = new ActiveXObject(&quot;Msxml2.DOMDocument.4.0&quot;);
var currNode;
xmlDoc.async = false;
xmlDoc.async = false;
xmlDoc.loadXML(&quot;<TABLENAME>     你好你阿三   爱猫扑.爱生活   司法等四<br></TABLENAME>&quot;);
currNode = xmlDoc.documentElement;</p>
<p>var s = currNode.xml;
var r = /\&lt;([^>\s]/<em>?)[^>]/</em>?>([^\&lt;]/*?)\&lt;\/\1>/
var b = s.replace(r,&quot;$2&quot;);
alert(b);
//--&gt;
</SCRIPT>
//mergeAttributes 复制所有读/写标签属性到指定元素。</p>
<p><SCRIPT>
function fnMerge(){
oSource.children[1].mergeAttributes(oSource.children[0]);
}
</SCRIPT></p>
<p><SPAN ID=oSource></p>
<p><DIV
ID="oDiv"
ATTRIBUTE1="true"
ATTRIBUTE2="true"
onclick="alert('click');"
onmouseover="this.style.color='/#0000FF';"
onmouseout="this.style.color='/#000000';"
>
This is a sample <B>DIV</B> element.
</DIV></p>
<p><DIV ID="oDiv2">
This is another sample <B>DIV</B> element.
</DIV>
</SPAN></p>
<INPUT
TYPE="button"
VALUE="Merge Attributes"
onclick="fnMerge()"
>

<ul>
<li>16:38</li>
<li>浏览 (76)</li>
<li><a href="http://hainanhaian.javaeye.com/blog/260844#comments" target="_blank">评论</a> (0)</li>
<li>分类: <a href="http://hainanhaian.javaeye.com/category/42379" target="_blank">web</a></li>
<li><a href="http://app.javaeye.com/links?user_favorite%5Btitle%5D=javascript%E5%B8%B8%E7%94%A8%E5%B0%8F%E6%8A%80%E5%B7%A7&amp;user_favorite%5Burl%5D=http%3A%2F%2Fhainanhaian.javaeye.com%2Fblog%2F260844" target="_blank">收藏</a></li>
<li><a href="http://www.javaeye.com/wiki/topic/260844" target="_blank">相关推荐</a><h3 id="-">评论</h3>
</li>
</ul>
<p><a href=""></a></p>
<h3 id="-">发表评论</h3>
<p>(快捷键 Alt+S / Ctrl+Enter)</p>
<p><a href="http://hainanhaian.javaeye.com/" target="_blank"><img src="&quot;hainanhaian的博客: 新空气&quot;" alt="hainanhaian的博客"></a></p>
<p>hainanhaian</p>
<ul>
<li>浏览: 6481 次</li>
<li>性别: <img src="&quot;男&quot;" alt="Icon_minigender_1"></li>
<li>来自: 南京</li>
<li><img src="" alt=""></li>
<li><a href="http://hainanhaian.javaeye.com/blog/profile" target="_blank">详细资料</a> <a href="http://hainanhaian.javaeye.com/blog/guest_book" target="_blank">留言簿</a></li>
<li><a href="http://app.javaeye.com/messages/new?message%5Breceiver_name%5D=hainanhaian" title="发送站内短信" target="_blank">发短消息</a> <a href="http://app.javaeye.com/feed?subscription%5Bsubscribed_user_name%5D=hainanhaian" target="_blank">订阅</a></li>
</ul>
<h3 id="-">搜索本博客</h3>
<h3 id="-http-hainanhaian-javaeye-com-blog-user_visits-">最近访客 <a href="http://hainanhaian.javaeye.com/blog/user_visits" target="_blank">&gt;&gt;更多访客</a></h3>
<p><a href="http://jywv.javaeye.com/" target="_blank"><img src="&quot;jywv的博客: jywv&quot;" alt="jywv的博客"></a></p>
<p><a href="http://jywv.javaeye.com/" target="_blank">jywv</a></p>
<p><a href="http://shjavaer.javaeye.com/" target="_blank"><img src="&quot;shjavaer的博客: &quot;" alt="shjavaer的博客"></a></p>
<p><a href="http://shjavaer.javaeye.com/" target="_blank">shjavaer</a>
<a href="http://angus---yeah-net.javaeye.com/" target="_blank"><img src="&quot;那份安静的博客: &quot;" alt="那份安静的博客"></a></p>
<p><a href="http://angus---yeah-net.javaeye.com/" target="_blank">那份安静</a></p>
<p><a href="http://migrator.javaeye.com/" target="_blank"><img src="&quot;Migrator的博客: &quot;" alt="Migrator的博客"></a></p>
<p><a href="http://migrator.javaeye.com/" target="_blank">Migrator</a></p>
<h3 id="-">博客分类</h3>
<ul>
<li><a href="http://hainanhaian.javaeye.com/" target="_blank">全部博客 (19)</a></li>
<li><a href="http://hainanhaian.javaeye.com/category/42202" target="_blank">java (8)</a></li>
<li><a href="http://hainanhaian.javaeye.com/category/42318" target="_blank">E (4)</a></li>
<li><a href="http://hainanhaian.javaeye.com/category/42379" target="_blank">web (5)</a></li>
<li><p><a href="http://hainanhaian.javaeye.com/category/42440" target="_blank">arithmetic (1)</a></p>
<h3 id="-">其他分类</h3>
</li>
<li><p><a href="http://hainanhaian.javaeye.com/blog/favorite" target="_blank">我的收藏</a> (42)</p>
</li>
<li><a href="http://hainanhaian.javaeye.com/blog/forum" target="_blank">我的论坛帖子</a> (10)</li>
<li><a href="http://hainanhaian.javaeye.com/blog/article" target="_blank">我的精华良好贴</a> (0)</li>
</ul>
<h3 id="-">最近加入圈子</h3>
<ul>
<li><a href="http://css.group.javaeye.com/" target="_blank">CSS探讨</a></li>
<li><a href="http://english.group.javaeye.com/" target="_blank">英语学习</a></li>
<li><p><a href="http://wfp.group.javaeye.com/" target="_blank">函数式编程の道</a></p>
<h3 id="-">链接</h3>
</li>
<li><p><a href="http://www.newairbbs.cn/" target="_blank">新空气bbs</a></p>
</li>
</ul>
<h3 id="-">存档</h3>
<ul>
<li><a href="http://hainanhaian.javaeye.com/blog/monthblog/2009-01" target="_blank">2009-01</a> (1)</li>
<li><a href="http://hainanhaian.javaeye.com/blog/monthblog/2008-11" target="_blank">2008-11</a> (3)</li>
<li><a href="http://hainanhaian.javaeye.com/blog/monthblog/2008-10" target="_blank">2008-10</a> (11)</li>
<li><p><a href="http://hainanhaian.javaeye.com/blog/monthblog_more" target="_blank">更多存档...</a></p>
<h3 id="-">最新评论</h3>
</li>
<li><p><a href="http://hainanhaian.javaeye.com/blog/248515#comments" title="Javascript中最常用的55个经典技巧" target="_blank">Javascript中最常用的55个 ...</a>
经典可以谈得上，但是建议“常用”换成“鲜为人知”、“实用”
-- by <a href="http://walkman.javaeye.com/" target="_blank">walkman</a></p>
</li>
<li><a href="http://hainanhaian.javaeye.com/blog/248219#comments" title="程序员谈如何掌握计算机专业英语" target="_blank">程序员谈如何掌握计算机专 ...</a>
dayang2001911 写道我现在正在读《design patterns》深 ...
-- by <a href="http://hainanhaian.javaeye.com/" target="_blank">hainanhaian</a></li>
<li><a href="http://hainanhaian.javaeye.com/blog/248219#comments" title="程序员谈如何掌握计算机专业英语" target="_blank">程序员谈如何掌握计算机专 ...</a>
我现在正在读《design patterns》深入浅出版的，影印版，英语通俗易懂， ...
-- by <a href="http://dayang2001911.javaeye.com/" target="_blank">dayang2001911</a></li>
</ul>
<h3 id="-">评论排行榜</h3>
<ul>
<li><a href="http://hainanhaian.javaeye.com/blog/256008" title="java,jsp获取网页源码内容的三种代码方法" target="_blank">java,jsp获取网页源码内容的三种代码方法</a></li>
<li><a href="http://hainanhaian.javaeye.com/blog/318576" title="ANT十五大最佳实践" target="_blank">ANT十五大最佳实践</a></li>
<li><a href="http://hainanhaian.javaeye.com/blog/266896" title="Servlet上传文件打水印生成缩略图" target="_blank">Servlet上传文件打水印生成缩略图</a></li>
<li><a href="http://hainanhaian.javaeye.com/blog/274092" title="JAVA 如何创建\删除\修改\复制目录及文件" target="_blank">JAVA 如何创建\删除\修改\复制目录及文 ...</a></li>
<li><a href="http://hainanhaian.javaeye.com/blog/260844" title="javascript常用小技巧" target="_blank">javascript常用小技巧</a></li>
<li><a href="http://hainanhaian.javaeye.com/rss" target="_blank"><img src="" alt="Rss"></a></li>
<li><a href="http://fusion.google.com/add?feedurl=http://hainanhaian.javaeye.com/rss" target="_blank"><img src="" alt="Rss_google"></a></li>
<li><a href="http://www.zhuaxia.com/add_channel.php?url=http://hainanhaian.javaeye.com/rss" target="_blank"><img src="" alt="Rss_zhuaxia"></a></li>
<li><a href="http://www.xianguo.com/subscribe.php?url=http://hainanhaian.javaeye.com/rss" target="_blank"><img src="" alt="Rss_xianguo"></a></li>
<li><a href="http://www.google.com/search?hl=zh-CN&amp;q=RSS" target="_blank">[什么是RSS?]</a>
声明：JavaEye文章版权属于作者，受法律保护。没有作者书面许可不得转载。若作者同意转载，必须以超链接形式标明文章原始出处和作者。
© 2003-2009 JavaEye.com. All rights reserved. 上海炯耐计算机软件有限公司 [ 沪ICP备05023328号 ]
<a href="http://hainanhaian.javaeye.com/blog/260844#" target="_blank">说点啥吧 <img src="" alt="Chat"></a></li>
</ul>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/JS用法/">JS用法</a></li></span></span> | <span class="tags">Tagged <a href="/tags/JS用法/" class="label label-primary">JS用法</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:28"datetime="2014-03-07 09:54:28"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JS用法--javascript常用小技巧/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JS用法--javascript常用小技巧" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-JS用法--JSURL传中文参数引发的乱码问题_javascript技巧_脚本之家/">JS URL传中文参数引发的乱码问题_javascript技巧_脚本之家</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:28.000Z"> <a href="/2014/02/02/2014-02-02-JS用法--JSURL传中文参数引发的乱码问题_javascript技巧_脚本之家/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="js-url-_javascript-_-">JS URL传中文参数引发的乱码问题<em>javascript技巧</em>脚本之家</h1>
<p>脚 本 之 家 www.jb51.net</p>
<ul>
<li><a href="http://www.jb51.net/codes/index.html" target="_blank">源码下载</a></li>
<li><a href="http://www.jb51.net/softs/index.html" target="_blank">软件下载</a></li>
<li><a href="http://www.jb51.net/s.htm" target="_blank">服务器常用软件</a></li>
<li><a href="http://www.jb51.net/new/new_1.htm" target="_blank">最近更新</a></li>
<li><a href="">繁体中文</a></li>
</ul>
<p><a href="http://www.jb51.net/" title="脚本之家" target="_blank"><img src="" alt="脚本之家"></a></p>
<ul>
<li><a href="http://www.jb51.net/" target="_blank">首页</a></li>
<li><a href="http://www.jb51.net/web/index.html" title="网页制作" target="_blank">网页制作</a></li>
<li><a href="http://www.jb51.net/list/index_96.htm" title="脚本专栏" target="_blank">脚本专栏</a></li>
<li><a href="http://www.jb51.net/list/index_1.htm" title="网络编程" target="_blank">网络编程</a></li>
<li><a href="http://www.jb51.net/list/index_104.htm" title="数据库" target="_blank">数据库</a></li>
<li><a href="http://www.jb51.net/jiaoben/index.html" title="脚本下载" target="_blank">脚本下载</a></li>
<li><a href="http://www.jb51.net/cms/index.html" title="cms使用教程" target="_blank">程序教学</a></li>
<li><a href="http://www.jb51.net/books/index.html" title="电子书籍" target="_blank">电子书籍</a></li>
<li><a href="http://www.jb51.net/pingmian/index.html" title="平面设计" target="_blank">平面设计</a></li>
<li><a href="http://www.jb51.net/media/index.html" title="媒体动画" target="_blank">媒体动画</a></li>
<li><a href="http://www.jb51.net/moban/index.html" title="模板下载" target="_blank">模板下载</a></li>
<li><a href="http://www.jb51.net/os/index.html" title="操作系统" target="_blank">操作系统</a></li>
<li><p><a href="http://www.jb51.net/yunying/index.html" title="网站运营" target="_blank">网站运营</a></p>
</li>
<li><p><a href="http://www.cnkuai.cn/GetSpace.htm" title="主机租用,服务器租用,主机托管,服务器托管" target="_blank"><strong>主机租用</strong></a></p>
</li>
<li><a href="http://www.cnkuai.cn/domain.htm" title="域名查询,域名注册,域名申请,域名" target="_blank"><strong>域名查询</strong></a></li>
<li><a href="http://www.jb51.net/list/list_61_1.htm" title="基础知识" target="_blank">基础知识</a></li>
<li><a href="http://www.jb51.net/list/list_23_1.htm" title="javascript类库" target="_blank">javascript类库</a></li>
<li><a href="http://www.jb51.net/list/list_22_1.htm" title="表单特效" target="_blank">表单特效</a></li>
<li><a href="http://www.jb51.net/list/list_18_1.htm" title="广告代码" target="_blank">广告代码</a></li>
<li><a href="http://www.jb51.net/list/list_43_1.htm" title="网页特效" target="_blank">网页特效</a></li>
<li><a href="http://www.jb51.net/list/list_26_1.htm" title="黑客性质" target="_blank">黑客性质</a></li>
<li><a href="http://www.jb51.net/list/list_222_1.htm" title="javascript技巧" target="_blank">javascript技巧</a>
页面导航： <a href="http://www.jb51.net/index.htm" target="_blank">首页</a> → <a href="http://www.jb51.net/list/index_1.htm" title="网络编程" target="_blank">网络编程</a> → <a href="http://www.jb51.net/list/list_3_1.htm" title="JavaScript" target="_blank">JavaScript</a> → <a href="http://www.jb51.net/list/list_222_1.htm" title="javascript技巧" target="_blank">javascript技巧</a> → 正文内容 url中文参数 乱码</li>
</ul>
<h1 id="js-url-">JS URL传中文参数引发的乱码问题</h1>
<p>发布：dxy 字体：[<a href="">增加</a> <a href="">减小</a>] 类型：转载</p>
<p>今天的项目中碰到了一个乱码问题，从JS里传URL到服务器，URL中有中文参数，服务器里读出的中文参数来的全是“？”，查了网上JS编码相关资料得以解决。
解决方法如下：
1、在JS里对中文参数进行两次转码
复制代码 代码如下:</p>
<p>var login_name = document.getElementById(&quot;loginname&quot;).value;
login_name = encodeURI(login_name);
login_name = encodeURI(login_name);
2、在服务器端对参数进行解码
复制代码 代码如下:</p>
<p>String loginName = ParamUtil.getString(request, &quot;login_name&quot;);
loginName = java.net.URLDecoder.decode(loginName,&quot;UTF-8&quot;);
在使用url进行参数传递时，经常会传递一些中文名的参数或URL地址，在后台处理时会发生转换错误。在有些传递页面使用GB2312，而在接收页面使用UTF8，这样接收到的参数就可能会与原来发生不一致。使用服务器端的urlEncode函数编码的URL，与使用客户端javascript的encodeURI函数编码的URL，结果就不一样。
javaScript中的编码方法：
escape() 方法：
采用ISO Latin字符集对指定的字符串进行编码。所有的空格符、标点符号、特殊字符以及其他非ASCII字符都将被转化成%xx格式的字符编码（xx等于该字符在字符集表里面的编码的16进制数字）。比如，空格符对应的编码是%20。unescape方法与此相反。不会被此方法编码的字符： @ /<em> / +
英文解释：MSDN JScript Reference: The escape method returns a string value (in Unicode format) that contains the contents of [the argument]. All spaces, punctuation, accented characters, and any other non-ASCII characters are replaced with %xx encoding, where xx is equivalent to the hexadecimal number representing the character. For example, a space is returned as &quot;%20.&quot;
Edge Core Javascript Guide: The escape and unescape functions let you encode and decode strings. The escape function returns the hexadecimal encoding of an argument in the ISO Latin character set. The unescape function returns the ASCII string for the specified hexadecimal encoding value.
encodeURI() 方法：把URI字符串采用UTF-8编码格式转化成escape格式的字符串。不会被此方法编码的字符：! @ /# $&amp; /</em> ( ) = : / ; ? + &#39;
英文解释：MSDN JScript Reference: The encodeURI method returns an encoded URI. If you pass the result to decodeURI, the original string is returned. The encodeURI method does not encode the following characters: &quot;:&quot;, &quot;/&quot;, &quot;;&quot;, and &quot;?&quot;. Use encodeURIComponent to encode these characters. Edge Core Javascript Guide: Encodes a Uniform Resource Identifier (URI) by replacing each instance of certain characters by one, two, or three escape sequences representing the UTF-8 encoding of the character
encodeURIComponent() 方法：把URI字符串采用UTF-8编码格式转化成escape格式的字符串。与encodeURI()相比，这个方法将对更多的字符进行编码，比如 / 等字符。所以如果字符串里面包含了URI的几个部分的话，不能用这个方法来进行编码，否则 / 字符被编码之后URL将显示错误。不会被此方法编码的字符：! /* ( )
英文解释：MSDN JScript Reference: The encodeURIComponent method returns an encoded URI. If you pass the result to decodeURIComponent, the original string is returned. Because the encodeURIComponent method encodes all characters, be careful if the string represents a path such as /folder1/folder2/default.html. The slash characters will be encoded and will not be valid if sent as a request to a web server. Use the encodeURI method if the string contains more than a single URI component. Mozilla Developer Core Javascript Guide： Encodes a Uniform Resource Identifier (URI) component by replacing each instance of certain characters by one, two, or three escape sequences representing the UTF-8 encoding of the character.
因此，对于中文字符串来说，如果不希望把字符串编码格式转化成UTF-8格式的（比如原页面和目标页面的charset是一致的时候），只需要使用escape。如果你的页面是GB2312或者其他的编码，而接受参数的页面是UTF-8编码的，就要采用encodeURI或者encodeURIComponent。
另外，encodeURI/encodeURIComponent是在javascript1.5之后引进的，escape则在javascript1.0版本就有。
英文注释：The escape() method does not encode the + character which is interpreted as a space on the server side as well as generated by forms with spaces in their fields. Due to this shortcoming, you should avoid use of escape() whenever possible. The best alternative is usually encodeURIComponent().Use of the encodeURI() method is a bit more specialized than escape() in that it encodes for URIs [REF] as opposed to the querystring, which is part of a URL. Use this method when you need to encode a string to be used for any resource that uses URIs and needs certain characters to remain un-encoded. Note that this method does not encode the &#39; character, as it is a valid character within URIs.Lastly, the encodeURIComponent() method should be used in most cases when encoding a single component of a URI. This method will encode certain chars that would normally be recognized as special chars for URIs so that many components may be included. Note that this method does not encode the &#39; character, as it is a valid character within URIs.</p>
<p><strong>Tags：</strong><a href="http://img.jb51.net/tag/url/1.htm" title="搜索关于url的文章" target="_blank">url</a> <a href="http://img.jb51.net/tag/ÖÐÎÄ²ÎÊý/1.htm" title="搜索关于中文参数的文章" target="_blank">中文参数</a> <a href="http://img.jb51.net/tag/ÂÒÂë/1.htm" title="搜索关于乱码的文章" target="_blank">乱码</a>
<a href="&quot;复制本文链接发给你QQ/MSN上的好友&quot;">复制链接发给好友</a><a href="">收藏本文</a><a href="">打印本文</a><a href="">关闭本文</a><a href="http://www.jb51.net/index.htm" target="_blank">返回首页</a></p>
<p>上一篇：<a href="http://www.jb51.net/article/19845.htm" title="FF IE兼容性的修改小结" target="_blank">FF IE兼容性的修改小结</a></p>
<p>下一篇：<a href="http://www.jb51.net/article/21463.htm" target="_blank">Javascript 中介者模式实例</a></p>
<h2 id="-">同类文章</h2>
<ul>
<li><a href="http://www.jb51.net/article/19448.htm" title="Javascript 学习笔记 错误处理" target="_blank">Javascript 学习笔记 错误处理</a></li>
<li><a href="http://www.jb51.net/article/21210.htm" title="IE与firefox下Dhtml的一些区别小结" target="_blank">IE与firefox下Dhtml的一些区别小结</a></li>
<li><a href="http://www.jb51.net/article/4908.htm" title="js变量作用域及可访问性的探讨" target="_blank">js变量作用域及可访问性的探讨</a></li>
<li><a href="http://www.jb51.net/article/17662.htm" title="javascript 表格排序和表头浮动效果(扩展SortTable)" target="_blank">javascript 表格排序和表头浮动效果(扩展SortTab</a></li>
<li><a href="http://www.jb51.net/article/18465.htm" title="javascript 冒号 使用说明" target="_blank">javascript 冒号 使用说明</a></li>
<li><a href="http://www.jb51.net/article/15353.htm" title="效率高的Javscript字符串替换函数的benchmark" target="_blank">效率高的Javscript字符串替换函数的benchmark</a></li>
<li><a href="http://www.jb51.net/article/18398.htm" title="Javascript 获取字符串字节数的多种方法" target="_blank">Javascript 获取字符串字节数的多种方法</a></li>
<li><a href="http://www.jb51.net/article/20450.htm" title="简单的加密css地址防止别人下载你的CSS文件的方法" target="_blank">简单的加密css地址防止别人下载你的CSS文件的方法</a></li>
<li><a href="http://www.jb51.net/article/14972.htm" title="教你如何解密js/vbs/vbscript加密的编码异处理小结" target="_blank">教你如何解密js/vbs/vbscript加密的编码异处理小</a></li>
<li><a href="http://www.jb51.net/article/10638.htm" title="服务器安全设置的几个注册表设置" target="_blank">服务器安全设置的几个注册表设置</a></li>
<li><a href="http://www.jb51.net/article/16706.htm" title="js 深拷贝函数" target="_blank">js 深拷贝函数</a></li>
<li><a href="http://www.jb51.net/article/15676.htm" title="js实现右下角窗口弹出窗口效果" target="_blank">js实现右下角窗口弹出窗口效果</a></li>
<li><a href="http://www.jb51.net/article/13086.htm" title="JS的递增/递减运算符和带操作的赋值运算符的等价式" target="_blank">JS的递增/递减运算符和带操作的赋值运算符的等价</a></li>
<li><a href="http://www.jb51.net/article/587.htm" title="如何用JS取得网址中的文件名" target="_blank">如何用JS取得网址中的文件名</a></li>
<li><a href="http://www.jb51.net/article/21326.htm" title="javascript 支持页码格式的分页类" target="_blank">javascript 支持页码格式的分页类</a></li>
<li><a href="http://www.jb51.net/article/14733.htm" title="javascript模仿msgbox提示效果代码" target="_blank">javascript模仿msgbox提示效果代码</a></li>
</ul>
<h2 id="-">文章评论</h2>
<p>共有 <em>**</em>位脚本之家网友发表了评论<a href="http://img.jb51.net/comment.asp?id=19850" target="_blank">我来说两句</a></p>
<h3 id="-">最 近 更 新</h3>
<ul>
<li><a href="http://www.jb51.net/article/13345.htm" title="javascript 点击整页变灰的效果（可做退出效果）。" target="_blank">javascript 点击整页变灰的效果（可做退出</a></li>
<li><a href="http://www.jb51.net/article/4870.htm" title="使两个iframe的高度与内容自适应,且相等" target="_blank">使两个iframe的高度与内容自适应,且相等</a></li>
<li><a href="http://www.jb51.net/article/17070.htm" title="javascript 自动转到命名锚记" target="_blank">javascript 自动转到命名锚记</a></li>
<li><a href="http://www.jb51.net/article/20880.htm" title="Javascript 定时器调用传递参数的方法" target="_blank">Javascript 定时器调用传递参数的方法</a></li>
<li><a href="http://www.jb51.net/article/592.htm" title="无间断滚动marquee的详细用法解析" target="_blank">无间断滚动marquee的详细用法解析</a></li>
<li><a href="http://www.jb51.net/article/6605.htm" title="Js之软键盘实现(js源码)" target="_blank">Js之软键盘实现(js源码)</a></li>
<li><a href="http://www.jb51.net/article/2835.htm" title="document.createRange实例" target="_blank">document.createRange实例</a></li>
<li><a href="http://www.jb51.net/article/18800.htm" title="javascript 连连看代码出炉" target="_blank">javascript 连连看代码出炉</a></li>
<li><a href="http://www.jb51.net/article/14718.htm" title="JavaScript容错例外处理" target="_blank">JavaScript容错例外处理</a></li>
<li><p><a href="http://www.jb51.net/article/14274.htm" title="js实现双击单元格变成文本输入框效果代码" target="_blank">js实现双击单元格变成文本输入框效果代码</a></p>
<h3 id="-">热 点 排 行</h3>
</li>
<li><p><a href="http://www.jb51.net/article/16884.htm" title="清除网页历史记录，屏蔽后退按钮!" target="_blank">清除网页历史记录，屏蔽后退按钮</a></p>
</li>
<li><a href="http://www.jb51.net/article/14397.htm" title="js刷新页面方法大全" target="_blank">js刷新页面方法大全</a></li>
<li><a href="http://www.jb51.net/article/425.htm" title="Div+CSS+JS树型菜单，可刷新" target="_blank">Div+CSS+JS树型菜单，可刷新</a></li>
<li><a href="http://www.jb51.net/article/9705.htm" title="eval(function(p,a,c,k,e,d)系列解密javascript程序" target="_blank">eval(function(p,a,c,k,e,d)系列</a></li>
<li><a href="http://www.jb51.net/article/13051.htm" title="JavaScript 节点操作 以及DOMDocument属性和方法" target="_blank">JavaScript 节点操作 以及DOMDoc</a></li>
<li><a href="http://www.jb51.net/article/7508.htm" title="JavaScript实现Sleep函数的代码" target="_blank">JavaScript实现Sleep函数的代码</a></li>
<li><a href="http://www.jb51.net/article/583.htm" title="javascript小技巧  超强推荐" target="_blank">javascript小技巧 超强推荐</a></li>
<li><a href="http://www.jb51.net/article/14178.htm" title="JavaScript修改css样式style" target="_blank">JavaScript修改css样式style</a></li>
<li><a href="http://www.jb51.net/article/1335.htm" title="在线游戏大家来找茬II" target="_blank">在线游戏大家来找茬II</a></li>
<li><a href="http://www.jb51.net/article/9386.htm" title="身份证号码前六位所代表的省,市,区, 以及地区编码下载" target="_blank">身份证号码前六位所代表的省,市,</a></li>
</ul>
<p><a href="http://www.jb51.net/about.htm" target="_blank">关于本站</a> - <a href="http://www.jb51.net/support.htm" target="_blank">广告合作</a> - <a href="http://www.jb51.net/linkus.htm" target="_blank">联系我们</a> - <a href="http://www.jb51.net/sm.htm" target="_blank">免责声明</a> - <a href="http://www.jb51.net/sitemap.htm" target="_blank">网站地图</a> - <a href="http://www.jb51.net/do/plus/guestbook/index.php" target="_blank">意见反馈</a> - <a href="http://www.jb51.net/article/19850.htm#top" target="_blank">返回顶部</a></p>
<p>欢迎转载我们的原创作品，转载请注明出处。<a href="http://www.miibeian.gov.cn/" target="_blank">苏ICP备06043639号</a>
Copyright © 2006-2010 www.jb51.net online services. All rights reserved. .
QQ群1:14624678 QQ群2:36345889或业务QQ:461478385</p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/JS用法/">JS用法</a></li></span></span> | <span class="tags">Tagged <a href="/tags/JS用法/" class="label label-primary">JS用法</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:28"datetime="2014-03-07 09:54:28"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-JS用法--JSURL传中文参数引发的乱码问题_javascript技巧_脚本之家/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-JS用法--JSURL传中文参数引发的乱码问题_javascript技巧_脚本之家" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>



  <article>
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left"></i>
      <h1 class="title"><a href="/2014/02/02/2014-02-02-架构师-架构--淘宝图片服务的学习/">淘宝图片服务的学习</a></h1>
      
        <span>Posted on<time datetime="2014-02-02T01:54:28.000Z"> <a href="/2014/02/02/2014-02-02-架构师-架构--淘宝图片服务的学习/">feb. 2 2014</a></time></span>      
    </header>
    
    
    <div class="entry">
      
        <h1 id="-">淘宝图片服务的学习</h1>
<p>原文出处： <a href="http://www.biaodianfu.com/taobao-tfs.html" target="_blank">标点符</a></p>
<p><strong>一、淘宝网的困境</strong></p>
<p>对于淘宝网这样的大型电子商务网站，对于图片服务的要求特别的高。而且对于卖家来说，图片远胜于文字描述，因此卖家也格外看重图片的显示质量、访问速度等问题。根据淘宝网的流量分析，整个淘宝网流量中，图片的访问流量会占到90%以上，而主站的网页则占到不到10%。同时大量的图片需要根据不同的应用位置，生成不同大小规格的缩略图。考虑到多种不同的应用场景以及改版的可能性，一张原图有可能需要生成20多个不同尺寸规格的缩略图。</p>
<p>淘宝整体图片存储系统容量1800TB（1.8PB），已经占用空间990TB（约1PB）。保存的图片文件数量达到286亿多个，这些图片文件包括根据原图生成的缩略图。平均图片大小是17.45K；8K以下图片占图片数总量的61%，占存储容量的11%。对于如此大规模的小文件存储与读取需要频繁的寻道和换道，在大量高并发访问量的情况下，非常容易造成读取延迟。</p>
<p>2007年之前淘宝采用NetApp公司的文件存储系统。至2006年， NetApp公司最高端的产品也不能满足淘宝存储的要求。首先是商用的存储系统没有对小文件存储和读取的环境进行有针对性的优化;其次，文件数量大，网络存储设备无法支撑;另外，整个系统所连接的服务器也越来越多，网络连接数已经到达了网络存储设备的极限。此外，商用存储系统扩容成本高，10T的存储容量需要几百万，而且存在单点故障，容灾和安全性无法得到很好的保证。</p>
<p><strong>二、淘宝网自主开发的目的</strong></p>
<ol>
<li>商用软件很难满足大规模系统的应用需求，无论存储还是CDN还是负载均衡，因为在厂商实验室端，很难实现如此大的数据规模测试。</li>
<li>研发过程中，将开源和自主开发相结合，会有更好的可控性，系统出问题了，完全可以从底层解决问题，系统扩展性也更高。</li>
<li>在一定规模效应基础上，研发的投入都是值得的。当规模超过交叉点后自主研发才能收到较好的经济效果。实际上淘宝网的规模已经远远超过了交叉点。</li>
<li>自主研发的系统可在软件和硬件多个层次不断的优化。</li>
</ol>
<p><strong>三、淘宝TFS的介绍</strong></p>
<p><strong>1、 TFS 1.0版本</strong></p>
<p><em>**</em>从2006年开始，淘宝网决定自己开发一套针对海量小文件存储难题的文件系统，用于解决自身图片存储的难题。到2007年6月，TFS(淘宝文件系统，Taobao File System)正式上线运营。在生产环境中应用的集群规模达到了200台PC Server(146G/*6 SAS 15K Raid5)，文件数量达到上亿级别;系统部署存储容量: 140 TB;实际使用存储容量: 50 TB;单台支持随机IOPS 200+，流量3MBps。<a href="http://cdn2.jobbole.com/2013/07/tfs-1.jpg" title="tfs-1" target="_blank"><img src="&quot;tfs-1&quot;" alt=""></a></p>
<p>图为淘宝集群文件系统TFS 1.0第一版的逻辑架构：集群由一对Name Server和多台Data Server构成，Name Server的两台服务器互为双机，就是集群文件系统中管理节点的概念。</p>
<ul>
<li>每个Data Server运行在一台普通的Linux主机上</li>
<li>以block文件的形式存放数据文件(一般64M一个block)</li>
<li>block存多份保证数据安全</li>
<li>利用ext3文件系统存放数据文件</li>
<li>磁盘raid5做数据冗余</li>
<li>文件名内置元数据信息，用户自己保存TFS文件名与实际文件的对照关系–使得元数据量特别小。</li>
</ul>
<p>TFS最大的特点就是将一部分元数据隐藏到图片的保存文件名上，大大简化了元数据，消除了管理节点对整体系统性能的制约，这一理念和目前业界流行的“对象存储”较为类似。传统的集群系统里面元数据只有1份，通常由管理节点来管理，因而很容易成为瓶颈。而对于淘宝网的用户来说，图片文件究竟用什么名字来保存实际上用户并不关心，因此TFS在设计规划上考虑在图片的保存文件名上暗藏了一些元数据信息，例如图片的大小、时间、访问频次等等信息，包括所在的逻辑块号。而在元数据上，实际上保存的信息很少，因此元数据结构非常简单。仅仅只需要一个fileID，能够准确定位文件在什么地方。由于大量的文件信息都隐藏在文件名中，整个系统完全抛弃了传统的目录树结构，因为目录树开销最大。拿掉后，整个集群的高可扩展性极大提高。</p>
<p><strong>2、 TFS 1.3版本</strong></p>
<p>到2009年6月，TFS 1.3版本上线，集群规模大大扩展，部署到淘宝的图片生产系统上，整个系统已经从原有200台PC服务器扩增至440台PC Server(300G/<em>12 SAS 15K RPM) + 30台PC Server (600G/</em>12 SAS 15K RPM)。支持文件数量也扩容至百亿级别;系统部署存储容量：1800TB(1.8PB);当前实际存储容量：995TB;单台Data Server支持随机IOPS 900+，流量15MB+;目前Name Server运行的物理内存是217MB(服务器使用千兆网卡)。</p>
<p><a href="http://cdn2.jobbole.com/2013/07/tfs-2.jpg" title="tfs-2" target="_blank"><img src="&quot;tfs-2&quot;" alt=""></a></p>
<p>图为TFS1.3版本的逻辑结构图，在TFS1.3版本中，淘宝网的软件工作组重点改善了心跳和同步的性能，最新版本的心跳和同步在几秒钟之内就可完成切换，同时进行了一些新的优化：包括元数据存内存上，清理磁盘空间，性能上也做了优化，包括：</p>
<ul>
<li>完全扁平化的数据组织结构，抛弃了传统文件系统的目录结构。</li>
<li>在块设备基础上建立自有的文件系统，减少EXT3等文件系统数据碎片带来的性能损耗</li>
<li>单进程管理单块磁盘的方式，摒除RAID5机制</li>
<li>带有HA机制的中央控制节点，在安全稳定和性能复杂度之间取得平衡。</li>
<li>尽量缩减元数据大小，将元数据全部加载入内存，提升访问速度。</li>
<li>跨机架和IDC的负载均衡和冗余安全策略。</li>
<li>完全平滑扩容。</li>
</ul>
<p>TFS主要的性能参数不是IO吞吐量，而是单台PCServer提供随机读写IOPS。由于硬件型号不同，很难给出一个参考值来说明性能。但基本上可以达到单块磁盘随机IOPS理论最大值的60%左右，整机的输出随盘数增加而线性增加。</p>
<p><strong>3、 TFS 2.0版本</strong></p>
<p>TFS 2.0（下面简称<a href="http://code.taobao.org/p/tfs/src/" target="_blank">TFS</a>，目前已经开源）是一个高可扩展、高可用、高性能、面向互联网服务的分布式文件系统，主要针对海量的非结构化数据，它构筑在普通的Linux机器集群上，可为外部提供高可靠和高并发的存储访问。TFS为淘宝提供海量小文件存储，通常文件大小不超过1M，满足了淘宝对小文件存储的需求，被广泛地应用在淘宝各项应用中。它采用了HA架构和平滑扩容，保证了整个文件系统的可用性和扩展性。同时扁平化的数据组织结构，可将文件名映射到文件的物理地址，简化了文件的访问流程，一定程度上为TFS提供了良好的读写性能。</p>
<p><a href="http://cdn2.jobbole.com/2013/07/tfs-3-1.jpg" title="tfs-3-1" target="_blank"><img src="&quot;tfs-3-1&quot;" alt=""></a></p>
<p> 一个TFS集群由两个!NameServer节点（一主一备）和多个!DataServer节点组成。这些服务程序都是作为一个用户级的程序运行在普通Linux机器上的。在TFS中，将大量的小文件(实际数据文件)合并成为一个大文件，这个大文件称为块(Block), 每个Block拥有在集群内唯一的编号(Block Id), Block Id在!NameServer在创建Block的时候分配, !NameServer维护block与!DataServer的关系。Block中的实际数据都存储在!DataServer上。而一台!DataServer服务器一般会有多个独立!DataServer进程存在，每个进程负责管理一个挂载点，这个挂载点一般是一个独立磁盘上的文件目录，以降低单个磁盘损坏带来的影响。正常情况下，一个块会在!DataServer上存在，主!NameServer负责Block的创建，删除，复制，均衡，整理， !NameServer不负责实际数据的读写，实际数据的读写由!DataServer完成。</p>
<ul>
<li>!NameServer主要功能是: 管理维护Block和!DataServer相关信息,包括!DataServer加入，退出, 心跳信息, block和!DataServer的对应关系建立，解除。</li>
<li>!DataServer主要功能是: 负责实际数据的存储和读写。</li>
</ul>
<p>同时为了考虑容灾，!NameServer采用了HA结构，即两台机器互为热备，同时运行，一台为主，一台为备，主机绑定到对外vip，提供服务；当主机器宕机后，迅速将vip绑定至备份!NameServer，将其切换为主机，对外提供服务。图中的HeartAgent就完成了此功能。</p>
<p>TFS的块大小可以通过配置项来决定，通常使用的块大小为64M。TFS的设计目标是海量小文件的存储，所以每个块中会存储许多不同的小文件。!DataServer进程会给Block中的每个文件分配一个ID(File ID，该ID在每个Block中唯一)，并将每个文件在Block中的信息存放在和Block对应的Index文件中。这个Index文件一般都会全部load在内存，除非出现!DataServer服务器内存和集群中所存放文件平均大小不匹配的情况。</p>
<p>另外，还可以部署一个对等的TFS集群，作为当前集群的辅集群。辅集群不提供来自应用的写入，只接受来自主集群的写入。当前主集群的每个数据变更操作都会重放至辅集群。辅集群也可以提供对外的读，并且在主集群出现故障的时候，可以接管主集群的工作。</p>
<p><strong>平滑扩容</strong></p>
<p>原有TFS集群运行一定时间后，集群容量不足，此时需要对TFS集群扩容。由于DataServer与NameServer之间使用心跳机制通信，如果系统扩容，只需要将相应数量的新!DataServer服务器部署好应用程序后启动即可。这些!DataServer服务器会向!NameServer进行心跳汇报。!NameServer会根据!DataServer容量的比率和!DataServer的负载决定新数据写往哪台!DataServer的服务器。根据写入策略，容量较小，负载较轻的服务器新数据写入的概率会比较高。同时，在集群负载比较轻的时候，!NameServer会对!DataServer上的Block进行均衡，使所有!DataServer的容量尽早达到均衡。</p>
<p>进行均衡计划时，首先计算每台机器应拥有的blocks平均数量，然后将机器划分为两堆，一堆是超过平均数量的，作为移动源；一类是低于平均数量的，作为移动目的。</p>
<p>移动目的的选择：首先一个block的移动的源和目的，应该保持在同一网段内，也就是要与另外的block不同网段；另外，在作为目的的一定机器内，优先选择同机器的源到目的之间移动，也就是同台!DataServer服务器中的不同!DataServer进程。
当有服务器故障或者下线退出时（单个集群内的不同网段机器不能同时退出），不影响TFS的服务。此时!NameServer会检测到备份数减少的Block，对这些Block重新进行数据复制。</p>
<p>在创建复制计划时，一次要复制多个block, 每个block的复制源和目的都要尽可能的不同，并且保证每个block在不同的子网段内。因此采用轮换选择(roundrobin)算法，并结合加权平均。</p>
<p>由于DataServer之间的通信是主要发生在数据写入转发的时候和数据复制的时候，集群扩容基本没有影响。假设一个Block为64M，数量级为1PB。那么NameServer上会有 1 /<em> 1024 /</em> 1024 /* 1024 / 64 = 16.7M个block。假设每个Block的元数据大小为0.1K，则占用内存不到2G。</p>
<p><strong>存储机制</strong></p>
<p>在TFS中，将大量的小文件(实际用户文件)合并成为一个大文件，这个大文件称为块(Block)。TFS以Block的方式组织文件的存储。每一个Block在整个集群内拥有唯一的编号，这个编号是由NameServer进行分配的，而DataServer上实际存储了该Block。在!NameServer节点中存储了所有的Block的信息，一个Block存储于多个!DataServer中以保证数据的冗余。对于数据读写请求，均先由!NameServer选择合适的!DataServer节点返回给客户端，再在对应的!DataServer节点上进行数据操作。!NameServer需要维护Block信息列表，以及Block与!DataServer之间的映射关系，其存储的元数据结构如下：</p>
<p><a href="http://cdn2.jobbole.com/2013/07/20130724154417.jpg" title="20130724154417" target="_blank"><img src="&quot;20130724154417&quot;" alt=""></a></p>
<p>在!DataServer节点上，在挂载目录上会有很多物理块，物理块以文件的形式存在磁盘上，并在!DataServer部署前预先分配，以保证后续的访问速度和减少碎片产生。为了满足这个特性，!DataServer现一般在EXT4文件系统上运行。物理块分为主块和扩展块，一般主块的大小会远大于扩展块，使用扩展块是为了满足文件更新操作时文件大小的变化。每个Block在文件系统上以“主块+扩展块”的方式存储。每一个Block可能对应于多个物理块，其中包括一个主块，多个扩展块。</p>
<p>在DataServer端，每个Block可能会有多个实际的物理文件组成：一个主Physical Block文件，N个扩展Physical Block文件和一个与该Block对应的索引文件。Block中的每个小文件会用一个block内唯一的fileid来标识。!DataServer会在启动的时候把自身所拥有的Block和对应的Index加载进来。</p>
<p><strong>容错机制</strong></p>
<p><strong>集群容错。</strong>TFS可以配置主辅集群，一般主辅集群会存放在两个不同的机房。主集群提供所有功能，辅集群只提供读。主集群会把所有操作重放到辅集群。这样既提供了负载均衡，又可以在主集群机房出现异常的情况不会中断服务或者丢失数据。</p>
<p><strong>!NameServer容错。</strong>Namserver主要管理了!DataServer和Block之间的关系。如每个!DataServer拥有哪些Block，每个Block存放在哪些!DataServer上等。同时，!NameServer采用了HA结构，一主一备，主NameServer上的操作会重放至备NameServer。如果主NameServer出现问题，可以实时切换到备NameServer。另外!NameServer和!DataServer之间也会有定时的heartbeat，!DataServer会把自己拥有的Block发送给!NameServer。!NameServer会根据这些信息重建!DataServer和Block的关系。</p>
<p><strong>!DataServer容错。</strong>TFS采用Block存储多份的方式来实现!DataServer的容错。每一个Block会在TFS中存在多份，一般为3份，并且分布在不同网段的不同!DataServer上。对于每一个写入请求，必须在所有的Block写入成功才算成功。当出现磁盘损坏!DataServer宕机的时候，TFS启动复制流程，把备份数未达到最小备份数的Block尽快复制到其他DataServer上去。 TFS对每一个文件会记录校验crc，当客户端发现crc和文件内容不匹配时，会自动切换到一个好的block上读取。此后客户端将会实现自动修复单个文件损坏的情况。</p>
<p><strong>并发机制</strong></p>
<p>对于同一个文件来说，多个用户可以并发读。现有TFS并不支持并发写一个文件。一个文件只会有一个用户在写。这在TFS的设计里面对应着是一个block同时只能有一个写或者更新操作。</p>
<p><strong>TFS文件名的结构</strong></p>
<p>TFS的文件名由块号和文件号通过某种对应关系组成，最大长度为18字节。文件名固定以T开始，第二字节为该集群的编号(可以在配置项中指定，取值范围 1~9)。余下的字节由Block ID和File ID通过一定的编码方式得到。文件名由客户端程序进行编码和解码，它映射方式如下图：</p>
<p><a href="http://cdn2.jobbole.com/2013/07/tfs-3-3.jpg" title="tfs-3-3" target="_blank"><img src="&quot;tfs-3-3&quot;" alt=""></a></p>
<p>TFS客户程序在读文件的时候通过将文件名转换为BlockID和FileID信息，然后可以在!NameServer取得该块所在!DataServer信息（如果客户端有该Block与!DataServere的缓存，则直接从缓存中取），然后与!DataServer进行读取操作。</p>
<p><strong>四、图片服务器部署与缓存</strong></p>
<p>下图为淘宝网整体系统的拓扑图结构。整个系统就像一个庞大的服务器一样，有处理单元、缓存单元和存储单元。前面已经详细介绍过了后台的TFS集群文件存储系统，在TFS前端，还部署着200多台图片文件服务器，用Apatch实现，用于生成缩略图的运算。</p>
<p>根据淘宝网的缩略图生成规则，缩略图都是实时生成的。这样做的好处有两点：一是为了避免后端图片服务器上存储的图片数量过多，大大节约后台存储空间的需求，淘宝网计算，采用实时生成缩略图的模式比提前全部生成好缩略图的模式节约90%的存储空间，也就是说，存储空间只需要后一种模式的10%;二是，缩略图可根据需要实时生成出来，更为灵活。</p>
<p><a href="http://cdn2.jobbole.com/2013/07/tfs-4-4.jpg" title="tfs-4-4" target="_blank"><img src="&quot;tfs-4-4&quot;" alt=""></a></p>
<p>淘宝网图片存储与处理系统全局拓扑，图片服务器前端还有一级和二级缓存服务器，尽量让图片在缓存中命中，最大程度的避免图片热点，实际上后端到达TFS的流量已经非常离散和平均。</p>
<p>图片文件服务器的前端则是一级缓存和二级缓存，前面还有全局负载均衡的设置，解决图片的访问热点问题。图片的访问热点一定存在，重要的是，让图片尽量在缓存中命中。目前淘宝网在各个运营商的中心点设有二级缓存，整体系统中心店设有一级缓存，加上全局负载均衡，传递到后端TFS的流量就已经非常均衡和分散了，对前端的响应性能也大大提高。</p>
<p>根据淘宝的缓存策略，大部分图片都尽量在缓存中命中，如果缓存中无法命中，则会在本地服务器上查找是否存有原图，并根据原图生成缩略图，如果都没有命中，则会考虑去后台TFS集群文件存储系统上调取，因此，最终反馈到TFS集群文件存储系统上的流量已经被大大优化了。</p>
<p>淘宝网将图片处理与缓存编写成基于Nginx的模块（<a href="https://github.com/alibaba/nginx-tfs" target="_blank">Nginx-tfs</a>），淘宝认为Nginx是目前性能最高的HTTP服务器(用户空间)，代码清晰，模块化非常好。淘宝使用GraphicsMagick进行图片处理，采用了面向小对象的缓存文件系统，前端有LVS+Haproxy将原图和其所有缩略图请求都调度到同一台Image Server。</p>
<p>文件定位上，内存用hash算法做索引，最多一次读盘。写盘方式则采用Append方式写，并采用了淘汰策略FIFO，主要考虑降低硬盘的写操作，没有必要进一步提高Cache命中率，因为Image Server和TFS在同一个数据中心，读盘效率还是非常高的。
<img src="&quot;3 votes, average: 5.00 out of 5&quot;" alt="3 votes, average: 5.00 out of 5"><img src="&quot;3 votes, average: 5.00 out of 5&quot;" alt="3 votes, average: 5.00 out of 5"><img src="&quot;3 votes, average: 5.00 out of 5&quot;" alt="3 votes, average: 5.00 out of 5"><img src="&quot;3 votes, average: 5.00 out of 5&quot;" alt="3 votes, average: 5.00 out of 5"><img src="&quot;3 votes, average: 5.00 out of 5&quot;" alt="3 votes, average: 5.00 out of 5"> (<strong>*3</strong> 个评分，平均: <strong>5.00*</strong>)</p>
<p><img src="&quot;Loading ...&quot;" alt="Loading ..."> Loading ...</p>

      
    </div>
    
    
      
    
    
        <footer id="post-meta">
        <span class="categories">Posted in<span class="breadcrumb fa fa-folder"><li><a href="/categories/架构师/">架构师</a></li></span><span class="breadcrumb"><li><a href="/categories/架构师/">架构师</a></li><li><a href="/categories/架构师/架构/">架构</a></li></span></span> | <span class="tags">Tagged <a href="/tags/架构/" class="label label-primary">架构</a><a href="/tags/架构师/" class="label label-success">架构师</a></span> | <span class="time">recent updated:<time title="2014-03-07 09:54:29"datetime="2014-03-07 09:54:29"> mar. 7 2014</time></span> | <span class="comment-link">
<a href="http://itsolife.com/2014/02/02/2014-02-02-架构师-架构--淘宝图片服务的学习/#comments" class="ds-thread-count comment-link" data-thread-key="2014-02-02-架构师-架构--淘宝图片服务的学习" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>





<ul id="pagination" class="pagination pagination-lg">
  <li><a class="extend prev" href="/page/153/">&laquo;</a></li><li><a class="page-number" href="/">1</a></li><li><a class="page-number" href="/page/2/">2</a></li><li><span class="space">&hellip;</span></li><li><a class="page-number" href="/page/151/">151</a></li><li><a class="page-number" href="/page/152/">152</a></li><li><a class="page-number" href="/page/153/">153</a></li><li class="active"><li><span class="page-number current">154</span></li><li><a class="page-number" href="/page/155/">155</a></li><li><a class="page-number" href="/page/156/">156</a></li><li><a class="page-number" href="/page/157/">157</a></li><li><span class="space">&hellip;</span></li></li><li><a class="page-number" href="/page/164/">164</a></li><li><a class="page-number" href="/page/165/">165</a></li><li><a class="extend next" href="/page/155/">&raquo;</a></li>
  <div class="clearfix"></div>
</ul></div><!--wapper-->
       </div><!-- ID main-col END -->
       <aside id="sidebar" class="alignright col-sx-6 col-sm-4 col-md-3 col-lg-3">
<div id="widget_search" class="widget panel panel-primary">
    <form action="//google.com/search" method="get" accept-charset="utf-8">
  <div class="input-group">
    <input class="form-control" id="searchbox" type="search" name="q" results="0" placeholder="search">
    <span class="input-group-btn">
      <button class="btn btn-default" type="submit">Go!</button>
    </span>
    <input type="hidden" name="q" value="site:itsolife.com">
  </div>
</form>
</div>

<div id="widget_category" class="widget panel panel-primary">
  <div class="panel-heading">category</div>  <div data-src='category' class='ajax_widgets'>正在加载...</div>
</div>

<div id="widget_recent_posts" class="widget panel panel-primary">
  <div class="panel-heading">recent posts</div>  <div data-src='recent_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_tagcloud" class="widget panel panel-primary">
  <div class="panel-heading">tagcloud</div>  <div data-src='tagcloud' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_latest_update_posts" class="widget panel panel-primary">
  <div class="panel-heading">最近更新</div>  <div data-src='latest_update_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_recent_comments" class="widget panel panel-primary">
  <div class="panel-heading">recent comments</div>  

<div class="list-group-item ds-recent-comments" data-num-items="6" data-show-avatars="1" data-show-time="1" data-show-title="1" data-show-admin="1" data-excerpt-length="50"></div>



</div>

</aside>
       <div class="clearfix"></div>
     </div><!-- row END -->
  </div>
  <footer id="footer" class="container">
  <div class="panel panel-info">
  <section id='footer_widget'></section>  <div class="panel-footer">
  <div id="site-info">
    <span class='author'>
  
  &copy; 2014 RobinChia
  
    &nbsp;&nbsp;</span>
  
  <span id='analytics-51la'></span><span id='analytics-google'>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-48559895-1']);
  _gaq.push(['_trackPageview']);
  _js2load.push({src:('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'});
</script></span><span id='analytics-cnzz'>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_5774006'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s17.cnzz.com/stat.php%3Fid%3D5774006%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</span><span id='analytics-baidu'>
<script>
var _hmt = _hmt || [];
_js2load.push({src:"//hm.baidu.com/hm.js?1442f50724afc42380b51f097c43082c"});
</script>
</span>  </div>
  <div id="copyright">Blog powered by <a href='http://zespia.tw/hexo/'><strong>hexo</strong></a> Theme <strong><a href='https://github.com/chenall/hexo-theme-chenall'>chenall</a></strong>(Some change in it)<span class="pull-right"> 更新时间: <em>2014-03-15 13:06:28</em></span></div>
</div>
<div class="clearfix"></div>


  </div>
  </footer>
  
        <script src="http://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>        
        <script src="http://cdn.staticfile.org/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>        
                
        <script src="http://cdn.bootcss.com/prettify/r298/prettify.min.js"></script>    <script type="text/javascript">
   var lang=["bsh", "c", "cc", "cpp", "cs", "csh", "cyc", "cv", "htm", "html",
    "java", "js", "m", "mxml", "perl", "pl", "pm", "py", "rb", "sh",
    "xhtml", "xml", "xsl"];
   var pretty_base='';
   $('script').each(function(){
	var c = $(this).attr('src');
	if (!c)
	    return;
	if (c.match(/(\/)?prettify(\.min)?\.js/i))
	{
	    var index = c.lastIndexOf('/');
	    if (index != -1)
		pretty_base = c.substr(0,index + 1);
	    return false;
	}
   })
   $('pre code').each(function(){
	var c = $(this).attr('class')
	if (!c)
	    return;
	c = c.match(/\s?(lang\-\w+)/i);
	if (c && lang.indexOf(c[1]) == -1)
	{
	    lang.push(c[1]);
	    $.getScript(pretty_base + c[1] + '.min.js');
	}
   })

    $(window).load(function(){
       $("pre").addClass("prettyprint");
       prettyPrint();
    })
</script>    
            <script type="text/javascript">
var duoshuoQuery = {short_name:"robinchia"};
_js2load.push({src:'http://static.duoshuo.com/embed.js',charset:'UTF-8'});
</script>
    
            <!--wumii_relatedItems-->
    
        <script src="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>    <script type="text/javascript">
(function($){
  $('.entry').each(function(i){
    $(this).find('img').each(function(){
      var alt = this.alt;

      if (alt){
        $(this).before('<span class="caption">' + alt + '</span>');
      }

      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="fancybox' + i + '" />');
    });
  });

  $('.fancybox').fancybox();
})(jQuery);
</script>    
        <script src="http://cdn.bootcss.com/mathjax/2.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>
    
<script type="text/javascript">
$('.ajax_widgets').each(function(){var src=$(this).attr('data-src');if(src)$(this).load('/widgets/'+src+'.html');});
$.each(_js2load,function(index,obj){loadjs(obj.src,obj.charset)});
</script>

<div id="scroll2top">
<img src="/scroll2top/arrow.png"/>
</div>
<script src="/scroll2top/scroll2top.min.js"></script>
<div id="winterland">
  <canvas></canvas>
</div>
<script src="/js/winterland.min.js"></script>

  </body>
</html>
